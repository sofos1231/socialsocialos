<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, viewport-fit=cover"
    />
    <title>SocialGym Dev Dashboard</title>
    <style>
      :root {
        --bg: #0b1020;
        --panel: rgba(255, 255, 255, 0.06);
        --panel2: rgba(255, 255, 255, 0.08);
        --text: rgba(255, 255, 255, 0.92);
        --muted: rgba(255, 255, 255, 0.65);
        --line: rgba(255, 255, 255, 0.12);
        --ok: #2ee59d;
        --warn: #ffd166;
        --bad: #ff5c7a;
        --btn: rgba(255, 255, 255, 0.1);
        --btn2: rgba(255, 255, 255, 0.16);
        --shadow: 0 10px 30px rgba(0, 0, 0, 0.25);

        /* controls */
        --controlBg: rgba(255, 255, 255, 0.07);
        --controlBgHover: rgba(255, 255, 255, 0.09);
        --controlBorder: rgba(255, 255, 255, 0.12);
        --controlFocus: rgba(77, 97, 255, 0.32);

        /* dropdown menu (options list) */
        --optionBg: #0f1733;
        --optionBgHover: #16204a;
        --optionBgSelected: #24306a;
        --optionText: rgba(255, 255, 255, 0.93);
        --optionTextMuted: rgba(255, 255, 255, 0.6);
      }

      * {
        box-sizing: border-box;
      }
      body {
        margin: 0;
        font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto,
          Helvetica, Arial;
        background: radial-gradient(
            1100px 900px at 20% 10%,
            rgba(77, 97, 255, 0.25),
            transparent 65%
          ),
          radial-gradient(
            900px 700px at 80% 0%,
            rgba(46, 229, 157, 0.18),
            transparent 60%
          ),
          radial-gradient(
            900px 700px at 70% 90%,
            rgba(255, 92, 122, 0.14),
            transparent 60%
          ),
          var(--bg);
        color: var(--text);

        /* IMPORTANT: make native form controls prefer dark UI where supported */
        color-scheme: dark;
      }
      .wrap {
        max-width: 1320px;
        margin: 22px auto;
        padding: 0 18px 24px;
      }
      header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
        margin-bottom: 14px;
      }
      .title {
        display: flex;
        flex-direction: column;
        gap: 4px;
      }
      .title h1 {
        font-size: 18px;
        margin: 0;
        letter-spacing: 0.3px;
      }
      .title p {
        margin: 0;
        font-size: 12px;
        color: var(--muted);
      }

      .row {
        display: grid;
        grid-template-columns: 400px 1fr;
        gap: 14px;
      }

      /* v2 Layout */
      .v2-main-layout {
        display: grid;
        grid-template-columns: 1fr 350px;
        gap: 14px;
        margin-top: 14px;
      }

      .v2-mode-switcher {
        display: flex;
        gap: 8px;
        padding: 8px;
        background: var(--panel);
        border-radius: 12px;
        margin-bottom: 14px;
      }

      .v2-mode-btn {
        flex: 1;
        padding: 10px 16px;
        border: 1px solid var(--line);
        background: var(--btn);
        color: var(--text);
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
        font-size: 13px;
        transition: all 0.2s;
      }

      .v2-mode-btn:hover {
        background: var(--btn2);
      }

      .v2-mode-btn.active {
        background: rgba(77, 97, 255, 0.2);
        border-color: rgba(77, 97, 255, 0.45);
        color: rgba(77, 97, 255, 1);
      }

      .v2-canvas {
        min-height: 600px;
        background: var(--panel);
        border: 1px solid var(--line);
        border-radius: 16px;
        padding: 20px;
        position: relative;
      }

      .v2-inspector {
        background: var(--panel);
        border: 1px solid var(--line);
        border-radius: 16px;
        padding: 16px;
        max-height: calc(100vh - 200px);
        overflow-y: auto;
      }

      /* Engine Map Nodes */
      .engine-map-container {
        position: relative;
        width: 100%;
        height: 100%;
        min-height: 600px;
      }

      .engine-node {
        position: absolute;
        width: 140px;
        height: 100px;
        background: var(--panel2);
        border: 2px solid var(--line);
        border-radius: 12px;
        padding: 12px;
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        gap: 6px;
      }

      .engine-node:hover {
        border-color: rgba(77, 97, 255, 0.6);
        box-shadow: 0 4px 12px rgba(77, 97, 255, 0.2);
        transform: translateY(-2px);
      }

      .engine-node.active {
        border-color: rgba(77, 97, 255, 0.8);
        background: rgba(77, 97, 255, 0.1);
      }

      .engine-node-title {
        font-weight: 700;
        font-size: 13px;
        text-align: center;
        color: var(--text);
      }

      .engine-node-icon {
        font-size: 24px;
        opacity: 0.8;
      }

      .engine-edge {
        position: absolute;
        pointer-events: none;
        stroke: var(--line);
        stroke-width: 2;
        fill: none;
      }

      /* Practice Hub */
      .practice-hub-container {
        display: flex;
        flex-direction: column;
        gap: 24px;
      }

      .category-row {
        display: flex;
        flex-direction: column;
        gap: 12px;
      }

      .category-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 12px 16px;
        background: var(--panel2);
        border-radius: 12px;
        border: 1px solid var(--line);
      }

      .category-title {
        font-weight: 700;
        font-size: 16px;
        color: var(--text);
      }

      .category-actions {
        display: flex;
        gap: 8px;
      }

      .missions-row {
        display: flex;
        gap: 12px;
        overflow-x: auto;
        padding: 8px 0;
        scrollbar-width: thin;
      }

      .mission-card {
        min-width: 200px;
        width: 200px;
        background: var(--panel2);
        border: 1px solid var(--line);
        border-radius: 12px;
        padding: 12px;
        cursor: grab;
        transition: all 0.2s;
        display: flex;
        flex-direction: column;
        gap: 8px;
      }
      .mission-card:active {
        cursor: grabbing;
      }
      .missions-row.drag-over {
        background-color: var(--controlFocus);
      }

      .mission-card:hover {
        border-color: rgba(77, 97, 255, 0.6);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
      }

      .mission-card-code {
        font-size: 11px;
        color: var(--muted);
        font-family: monospace;
      }

      .mission-card-title {
        font-weight: 700;
        font-size: 14px;
        color: var(--text);
      }

      .mission-card-subtitle {
        font-size: 12px;
        color: var(--muted);
      }

      /* Modal */
      .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.7);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 10000;
      }

      .modal-overlay.active {
        display: flex;
      }

      .modal {
        background: var(--bg);
        border: 1px solid var(--line);
        border-radius: 16px;
        padding: 24px;
        max-width: 800px;
        max-height: 90vh;
        overflow-y: auto;
        width: 90%;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
      }

      .modal-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 20px;
        padding-bottom: 16px;
        border-bottom: 1px solid var(--line);
      }

      .modal-title {
        font-weight: 800;
        font-size: 18px;
        color: var(--text);
      }

      .modal-close {
        background: none;
        border: none;
        color: var(--muted);
        font-size: 24px;
        cursor: pointer;
        padding: 0;
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 8px;
      }

      .modal-close:hover {
        background: var(--btn);
        color: var(--text);
      }

      .field-required {
        border-color: rgba(255, 92, 122, 0.5) !important;
      }

      .field-required:focus {
        border-color: rgba(255, 92, 122, 0.8) !important;
        box-shadow: 0 0 0 3px rgba(255, 92, 122, 0.2) !important;
      }

      .field-pulse {
        animation: pulse 1s ease-in-out infinite;
      }

      @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.6; }
      }

      .toast {
        position: fixed;
        top: 20px;
        right: 20px;
        background: var(--panel2);
        border: 1px solid var(--line);
        border-radius: 12px;
        padding: 16px 20px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        z-index: 10001;
        max-width: 400px;
        display: none;
      }

      .toast.show {
        display: block;
        animation: slideIn 0.3s ease-out;
      }

      .toast.error {
        border-color: rgba(255, 92, 122, 0.5);
        background: rgba(255, 92, 122, 0.1);
        color: rgba(255, 92, 122, 0.95);
      }

      .toast.success {
        border-color: rgba(46, 229, 157, 0.5);
        background: rgba(46, 229, 157, 0.1);
        color: rgba(46, 229, 157, 0.95);
      }

      @keyframes slideIn {
        from {
          transform: translateX(400px);
          opacity: 0;
        }
        to {
          transform: translateX(0);
          opacity: 1;
        }
      }

      .panel {
        background: var(--panel);
        border: 1px solid var(--line);
        border-radius: 16px;
        box-shadow: var(--shadow);
        overflow: hidden;
      }

      .panelHead {
        padding: 12px 12px;
        border-bottom: 1px solid var(--line);
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        align-items: center;
        justify-content: space-between;
      }
      .panelHead .left,
      .panelHead .right {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
        align-items: center;
      }

      .btn {
        appearance: none;
        border: 1px solid var(--line);
        background: var(--btn);
        color: var(--text);
        padding: 8px 10px;
        border-radius: 12px;
        cursor: pointer;
        font-weight: 600;
        font-size: 12px;
      }
      .btn:hover {
        background: var(--btn2);
      }
      .btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      .chip {
        font-size: 12px;
        padding: 6px 10px;
        border-radius: 999px;
        border: 1px solid var(--line);
        background: rgba(255, 255, 255, 0.06);
        color: var(--muted);
      }
      .chip.ok {
        color: rgba(46, 229, 157, 0.95);
        border-color: rgba(46, 229, 157, 0.25);
        background: rgba(46, 229, 157, 0.08);
      }
      .chip.bad {
        color: rgba(255, 92, 122, 0.95);
        border-color: rgba(255, 92, 122, 0.25);
        background: rgba(255, 92, 122, 0.08);
      }
      .chip.warn {
        color: rgba(255, 209, 102, 0.95);
        border-color: rgba(255, 209, 102, 0.25);
        background: rgba(255, 209, 102, 0.08);
      }

      .body {
        padding: 12px;
      }

      .field {
        display: flex;
        flex-direction: column;
        gap: 6px;
        margin-bottom: 10px;
      }
      label {
        font-size: 12px;
        color: var(--muted);
      }

      input,
      select,
      textarea {
        background: var(--controlBg);
        border: 1px solid var(--controlBorder);
        border-radius: 12px;
        color: var(--text);
        padding: 10px 10px;
        outline: none;
        font-size: 13px;
      }

      input:hover,
      select:hover,
      textarea:hover {
        background: var(--controlBgHover);
      }

      input:focus,
      select:focus,
      textarea:focus {
        border-color: rgba(77, 97, 255, 0.45);
        box-shadow: 0 0 0 3px rgba(77, 97, 255, 0.14);
      }

      /* IMPORTANT: force readable dropdown menus (options list) */
      select {
        color-scheme: dark;
      }
      select option,
      select optgroup {
        background-color: var(--optionBg);
        color: var(--optionText);
      }
      select option:checked {
        background-color: var(--optionBgSelected);
        color: var(--optionText);
      }
      select option[disabled] {
        color: var(--optionTextMuted);
      }

      textarea {
        min-height: 280px;
        line-height: 1.35;
        resize: vertical;
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas,
          "Liberation Mono", "Courier New", monospace;
      }

      .split {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
      }
      .split3 {
        display: grid;
        grid-template-columns: 1fr 1fr 1fr;
        gap: 10px;
      }

      .listWrap {
        padding: 10px 12px 12px;
      }
      .search {
        display: flex;
        gap: 8px;
        align-items: center;
        margin-bottom: 10px;
      }
      .list {
        max-height: 640px;
        overflow: auto;
        padding-right: 6px;
      }
      .item {
        border: 1px solid var(--line);
        background: rgba(255, 255, 255, 0.06);
        border-radius: 14px;
        padding: 10px;
        cursor: pointer;
        margin-bottom: 8px;
        display: flex;
        flex-direction: column;
        gap: 6px;
      }
      .item:hover {
        background: rgba(255, 255, 255, 0.085);
      }
      .item.active {
        border-color: rgba(77, 97, 255, 0.45);
        box-shadow: 0 0 0 3px rgba(77, 97, 255, 0.12);
      }
      .itemTitle {
        font-weight: 800;
        font-size: 13px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 8px;
      }
      .itemMeta {
        font-size: 12px;
        color: var(--muted);
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
        align-items: center;
      }

      .footerLog {
        margin-top: 14px;
      }
      .logArea {
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas,
          "Liberation Mono", "Courier New", monospace;
        font-size: 12px;
        white-space: pre-wrap;
        word-break: break-word;
        padding: 12px;
        background: rgba(0, 0, 0, 0.28);
        border-top: 1px solid var(--line);
        max-height: 220px;
        overflow: auto;
      }

      .mini {
        font-size: 12px;
        color: var(--muted);
      }

      .dangerBox {
        border: 1px solid rgba(255, 92, 122, 0.25);
        background: rgba(255, 92, 122, 0.08);
        border-radius: 14px;
        padding: 10px 12px;
        color: rgba(255, 92, 122, 0.95);
        font-size: 12px;
        display: none;
      }

      .okBox {
        border: 1px solid rgba(46, 229, 157, 0.25);
        background: rgba(46, 229, 157, 0.08);
        border-radius: 14px;
        padding: 10px 12px;
        color: rgba(46, 229, 157, 0.95);
        font-size: 12px;
        display: none;
      }

      @media (max-width: 980px) {
        .row {
          grid-template-columns: 1fr;
        }
        .list {
          max-height: 380px;
        }
      }
    </style>
  </head>

  <body>
    <div class="wrap">
      <header>
        <div class="title">
          <h1>SocialGym — Dev Dashboard</h1>
          <p>
            Minimal mission editor: essential fields + one AI Contract JSON blob.
            (Single-file HTML with inline JS)
          </p>
        </div>

        <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
          <span id="apiStatusChip" class="chip warn">API: unknown</span>
          <span id="metaStatusChip" class="chip">Meta: not loaded</span>
          <span id="missionsStatusChip" class="chip">Missions: not loaded</span>
        </div>
      </header>

      <div class="panel" style="margin-bottom: 14px;">
        <div class="panelHead">
          <div class="left">
            <button id="pingApiBtn" type="button" class="btn">Ping API</button>
            <button id="loadMetaBtn" type="button" class="btn">Load Meta</button>
            <button id="loadMissionsBtn" type="button" class="btn">Load Missions</button>
            <button id="loadEverythingBtn" type="button" class="btn">Load Everything</button>
          </div>
          <div class="right" style="flex: 1; justify-content: flex-end;">
            <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
              <span class="mini">API base:</span>
              <input
                id="apiBaseInput"
                style="width: 280px;"
                placeholder="e.g. http://localhost:3000"
              />
              <span class="mini">JWT:</span>
              <input
                id="jwtInput"
                style="width: 420px;"
                placeholder="paste Bearer token (without 'Bearer ')"
              />
              <button id="saveSettingsBtn" type="button" class="btn">Save</button>
              <div style="margin-top: 8px; padding: 8px; border: 1px solid var(--line); border-radius: 4px; background: var(--bg2);">
                <div class="mini" style="margin-bottom: 4px;">Login → Get JWT:</div>
                <div style="display: flex; gap: 4px; align-items: center;">
                  <input
                    id="loginEmailInput"
                    type="email"
                    placeholder="Email"
                    style="width: 200px; padding: 4px;"
                  />
                  <input
                    id="loginPasswordInput"
                    type="password"
                    placeholder="Password"
                    style="width: 150px; padding: 4px;"
                  />
                  <button id="loginBtn" type="button" class="btn" style="padding: 4px 12px;">Login</button>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="body">
          <div id="okBox" class="okBox"></div>
          <div id="errorBox" class="dangerBox"></div>
          <div class="mini">
            Notes:
            <ul>
              <li>Difficulty enum must match DB: <b>EASY / MEDIUM / HARD / ELITE</b></li>
              <li><b>AI Styles</b> are loaded from DB (AiStyle table). Select “(default)” to not override.</li>
              <li>AI Contract is parsed as JSON object and sent as <code>aiContract</code></li>
              <li>All failures are shown below; nothing is silent.</li>
            </ul>
          </div>
        </div>
      </div>

      <!-- v2 Mode Switcher -->
      <div class="v2-mode-switcher">
        <button id="v2ModeEngineMap" class="v2-mode-btn active">Engine Map</button>
        <button id="v2ModePracticeHub" class="v2-mode-btn">Practice Hub</button>
        <div style="flex: 1;"></div>
        <div style="display: flex; gap: 8px; align-items: center;">
          <span class="mini">Config Slots:</span>
          <select id="configSlotSelect" style="width: 120px; padding: 6px 8px;">
            <option value="">(None)</option>
            <option value="1">Slot 1</option>
            <option value="2">Slot 2</option>
            <option value="3">Slot 3</option>
            <option value="4">Slot 4</option>
            <option value="5">Slot 5</option>
          </select>
          <button id="saveConfigSlotBtn" class="btn" style="font-size: 11px;">Save Slot</button>
          <button id="loadConfigSlotBtn" class="btn" style="font-size: 11px;">Load Slot</button>
        </div>
      </div>

      <!-- v2 Main Layout -->
      <div class="v2-main-layout" id="v2MainLayout" style="display: none;">
        <!-- Left Canvas -->
        <div class="v2-canvas" id="v2Canvas">
          <!-- Engine Map or Practice Hub content will be rendered here -->
        </div>

        <!-- Right Inspector -->
        <div class="v2-inspector" id="v2Inspector">
          <div style="color: var(--muted); font-size: 12px; text-align: center; padding: 40px 20px;">
            Select a node, mission, or category to view details
          </div>
        </div>
      </div>

      <!-- Legacy Layout (hidden by default, can be toggled for migration) -->
      <div class="row" id="legacyLayout">
        <!-- LEFT: MISSIONS LIST -->
        <div class="panel">
          <div class="panelHead">
            <div class="left">
              <button id="newMissionBtn" class="btn">New</button>
              <button id="duplicateMissionBtn" class="btn" disabled>Duplicate</button>
              <button id="deleteMissionBtn" class="btn" disabled>Delete</button>
            </div>
            <div class="right">
              <span id="selectedChip" class="chip">Selected: none</span>
            </div>
          </div>

          <div class="listWrap">
            <div class="search">
              <input
                id="searchInput"
                style="flex: 1;"
                placeholder="Search missions by name/code..."
              />
              <button id="clearSearchBtn" class="btn">Clear</button>
            </div>
            <div id="missionsList" class="list"></div>
          </div>
        </div>

        <!-- RIGHT: EDITOR -->
        <div class="panel">
          <div class="panelHead">
            <div class="left">
              <button id="saveMissionBtn" class="btn">Save Mission</button>
              <button id="clearFormBtn" class="btn">Clear Form</button>
            </div>
            <div class="right">
              <span id="contractValidityChip" class="chip warn">AI Contract: unknown</span>
              <span id="previewChip" class="chip">Preview: —</span>
            </div>
          </div>

          <div class="body">
            <div class="field">
              <label>Mission Title</label>
              <input id="missionTitleInput" placeholder="e.g. 'Open with playful confidence'" />
            </div>

            <div class="field">
              <label>Description</label>
              <textarea id="missionDescriptionInput" placeholder="Mission description" rows="3"></textarea>
            </div>

            <div class="split3">
              <div class="field">
                <label>Difficulty</label>
                <select id="difficultySelect">
                  <option value="EASY">EASY</option>
                  <option value="MEDIUM">MEDIUM</option>
                  <option value="HARD">HARD</option>
                  <option value="ELITE">ELITE</option>
                </select>
              </div>

              <div class="field">
                <label>Category</label>
                <select id="categorySelect">
                  <option value="">(load meta)</option>
                </select>
              </div>

              <div class="field">
                <label>Persona</label>
                <select id="personaSelect">
                  <option value="">(load meta)</option>
                </select>
              </div>
            </div>

            <div class="split3">
              <div class="field">
                <label>Goal Type</label>
                <select id="missionGoalTypeSelect">
                  <option value="">(select)</option>
                  <option value="OPENING">OPENING</option>
                  <option value="FLIRTING">FLIRTING</option>
                  <option value="RECOVERY">RECOVERY</option>
                  <option value="BOUNDARY">BOUNDARY</option>
                  <option value="LOGISTICS">LOGISTICS</option>
                  <option value="SOCIAL">SOCIAL</option>
                </select>
              </div>

              <div class="field">
                <label>Active</label>
                <select id="activeSelect">
                  <option value="true">true</option>
                  <option value="false">false</option>
                </select>
              </div>

              <div class="field">
                <label>Code (optional)</label>
                <input id="codeInput" placeholder="optional short code / slug" />
              </div>
            </div>

            <div class="split3">
              <div class="field">
                <label>Time Limit (seconds)</label>
                <input type="number" id="missionTimeLimitInput" placeholder="e.g. 30" min="0" />
              </div>

              <div class="field">
                <label>Max Messages</label>
                <input type="number" id="missionMaxMessagesInput" placeholder="e.g. 10" min="1" />
              </div>

              <div class="field">
                <label>Word Limit (optional)</label>
                <input type="number" id="missionWordLimitInput" placeholder="e.g. 50" min="1" />
              </div>
            </div>

            <div class="split3">
              <div class="field">
                <label>Lane Index</label>
                <input type="number" id="laneIndexInput" placeholder="e.g. 0" min="0" />
              </div>

              <div class="field">
                <label>Order Index</label>
                <input type="number" id="orderIndexInput" placeholder="e.g. 0" min="0" />
              </div>

              <div class="field">
                <label>AI Style (optional)</label>
                <select id="aiStyleSelect">
                  <option value="">(default / none)</option>
                  <option value="__meta__" disabled>— load meta to see styles —</option>
                </select>
              </div>
            </div>

            <!-- Phase 3: Builder Integration -->
            <div class="field" style="margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--line);">
              <label style="font-weight: 700; margin-bottom: 8px;">Config Builder (Phase 3)</label>
              <div style="display: flex; flex-direction: column; gap: 12px;">
                <div class="field">
                  <label>Builder Type</label>
                  <select id="builderTypeSelect">
                    <option value="">(select builder)</option>
                    <option value="OPENERS">Openers Builder</option>
                    <option value="FLIRTING">Flirting Builder</option>
                  </select>
                </div>

                <div id="builderParamsSection" style="display: none;">
                  <div class="split2">
                    <div class="field">
                      <label>User Title</label>
                      <input id="builderUserTitleInput" placeholder="Mission title" />
                    </div>
                    <div class="field">
                      <label>User Description</label>
                      <input id="builderUserDescriptionInput" placeholder="Mission description" />
                    </div>
                  </div>

                  <div class="split3">
                    <div class="field">
                      <label>Difficulty Level</label>
                      <select id="builderDifficultySelect">
                        <option value="EASY">EASY</option>
                        <option value="NORMAL">NORMAL</option>
                        <option value="HARD">HARD</option>
                      </select>
                    </div>
                    <div class="field">
                      <label>AI Style Key</label>
                      <input id="builderAiStyleKeyInput" placeholder="e.g. NEUTRAL" />
                    </div>
                    <div class="field" id="builderObjectiveKindField" style="display: none;">
                      <label>Objective Kind (Openers only)</label>
                      <select id="builderObjectiveKindSelect">
                        <option value="PRACTICE_OPENING">PRACTICE_OPENING</option>
                        <option value="GET_NUMBER">GET_NUMBER</option>
                        <option value="GET_INSTAGRAM">GET_INSTAGRAM</option>
                        <option value="GET_DATE_AGREEMENT">GET_DATE_AGREEMENT</option>
                      </select>
                    </div>
                  </div>

                  <div class="split3">
                    <div class="field">
                      <label>Max Messages</label>
                      <input type="number" id="builderMaxMessagesInput" placeholder="e.g. 10" min="1" />
                    </div>
                    <div class="field">
                      <label>Time Limit (seconds)</label>
                      <input type="number" id="builderTimeLimitSecInput" placeholder="e.g. 30" min="0" />
                    </div>
                    <div class="field">
                      <label>Word Limit (optional)</label>
                      <input type="number" id="builderWordLimitInput" placeholder="e.g. 50" min="1" />
                    </div>
                  </div>

                  <div style="display: flex; gap: 8px; flex-wrap: wrap; margin-top: 8px;">
                    <button id="generateConfigBtn" class="btn brand">Generate Config</button>
                    <button id="validateConfigBtn" class="btn">Validate Config</button>
                  </div>
                </div>
              </div>
            </div>

            <!-- Dynamics (Structured) -->
            <div class="field" style="margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--line);">
              <label style="font-weight: 700; margin-bottom: 8px;">Dynamics (Structured)</label>
              <div style="display: flex; flex-direction: column; gap: 12px;">
                <div class="split3">
                  <div class="field">
                    <label>Mode</label>
                    <select id="missionDynamicsModeSelect">
                      <option value="CHAT">CHAT</option>
                      <option value="REAL_LIFE">REAL_LIFE</option>
                    </select>
                  </div>
                  <div class="field">
                    <label>Location Tag</label>
                    <input id="missionDynamicsLocationTagInput" placeholder="e.g. APP_CHAT" />
                  </div>
                  <div class="field">
                    <label>Default Entry Route</label>
                    <select id="missionDynamicsDefaultEntryRouteSelect">
                      <option value="TEXT_CHAT">TEXT_CHAT</option>
                      <option value="VOICE_SIM">VOICE_SIM</option>
                    </select>
                  </div>
                </div>
                <div class="field">
                  <label style="display: flex; align-items: center; gap: 8px;">
                    <input type="checkbox" id="missionDynamicsHasPerMessageTimerCheckbox" />
                    <span>Has Per-Message Timer</span>
                  </label>
                </div>
                <div style="display: flex; flex-direction: column; gap: 12px; margin-top: 8px;">
                  <label style="font-weight: 600;">Dynamics Profile</label>
                  <div class="field">
                    <label>Select Dynamics Profile</label>
                    <select id="missionDynamicsProfileSelect" style="width: 100%;">
                      <option value="">(Loading...)</option>
                    </select>
                    <div style="font-size: 11px; color: var(--muted); margin-top: 4px;" id="missionDynamicsProfileDescription"></div>
                  </div>
                  <div class="field">
                    <label style="display: flex; align-items: center; gap: 8px;">
                      <input type="checkbox" id="missionDynamicsOverrideToggle" />
                      <span>Override dynamics values</span>
                    </label>
                    <div style="font-size: 11px; color: var(--muted); margin-top: 4px;">
                      When enabled, you can customize individual dynamics values below. When disabled, values from the selected profile are used.
                    </div>
                  </div>
                  <div id="missionDynamicsSlidersContainer" style="display: none;">
                    <label style="font-weight: 600; margin-top: 8px;">Dynamics Tuning (0-100)</label>
                    <div class="field">
                      <label>Pace</label>
                      <input type="range" id="missionDynPace" min="0" max="100" value="50" style="width: 100%;" />
                      <div style="display: flex; justify-content: space-between; font-size: 11px; color: var(--muted);">
                        <span>0</span>
                        <span id="missionDynPaceVal">50</span>
                        <span>100</span>
                      </div>
                    </div>
                    <div class="field">
                      <label>Emoji Density</label>
                      <input type="range" id="missionDynEmojiDensity" min="0" max="100" value="50" style="width: 100%;" />
                      <div style="display: flex; justify-content: space-between; font-size: 11px; color: var(--muted);">
                        <span>0</span>
                        <span id="missionDynEmojiDensityVal">50</span>
                        <span>100</span>
                      </div>
                    </div>
                    <div class="field">
                      <label>Flirtiveness</label>
                      <input type="range" id="missionDynFlirtiveness" min="0" max="100" value="50" style="width: 100%;" />
                      <div style="display: flex; justify-content: space-between; font-size: 11px; color: var(--muted);">
                        <span>0</span>
                        <span id="missionDynFlirtivenessVal">50</span>
                        <span>100</span>
                      </div>
                    </div>
                    <div class="field">
                      <label>Hostility</label>
                      <input type="range" id="missionDynHostility" min="0" max="100" value="50" style="width: 100%;" />
                      <div style="display: flex; justify-content: space-between; font-size: 11px; color: var(--muted);">
                        <span>0</span>
                        <span id="missionDynHostilityVal">50</span>
                        <span>100</span>
                      </div>
                    </div>
                    <div class="field">
                      <label>Dryness</label>
                      <input type="range" id="missionDynDryness" min="0" max="100" value="50" style="width: 100%;" />
                      <div style="display: flex; justify-content: space-between; font-size: 11px; color: var(--muted);">
                        <span>0</span>
                        <span id="missionDynDrynessVal">50</span>
                        <span>100</span>
                      </div>
                    </div>
                    <div class="field">
                      <label>Vulnerability</label>
                      <input type="range" id="missionDynVulnerability" min="0" max="100" value="50" style="width: 100%;" />
                      <div style="display: flex; justify-content: space-between; font-size: 11px; color: var(--muted);">
                        <span>0</span>
                        <span id="missionDynVulnerabilityVal">50</span>
                        <span>100</span>
                      </div>
                    </div>
                    <div class="field">
                      <label>Escalation Speed</label>
                      <input type="range" id="missionDynEscalationSpeed" min="0" max="100" value="50" style="width: 100%;" />
                      <div style="display: flex; justify-content: space-between; font-size: 11px; color: var(--muted);">
                        <span>0</span>
                        <span id="missionDynEscalationSpeedVal">50</span>
                        <span>100</span>
                      </div>
                    </div>
                    <div class="field">
                      <label>Randomness</label>
                      <input type="range" id="missionDynRandomness" min="0" max="100" value="50" style="width: 100%;" />
                      <div style="display: flex; justify-content: space-between; font-size: 11px; color: var(--muted);">
                        <span>0</span>
                        <span id="missionDynRandomnessVal">50</span>
                        <span>100</span>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="field">
                  <label style="font-weight: 600;">Gate Requirements</label>
                  <div class="field">
                    <label>Select Gate Pack</label>
                    <select id="missionGateRequirementPackSelect" style="width: 100%;">
                      <option value="">(Auto - based on objective + difficulty)</option>
                    </select>
                    <div style="font-size: 11px; color: var(--muted); margin-top: 4px;" id="missionGateRequirementPackDescription"></div>
                  </div>
                  <!-- Backward compatibility: keep checkbox hidden but functional for old missions -->
                  <input type="checkbox" id="missionEnableGateSequenceCheckbox" style="display: none;" />
                </div>
                <div style="display: flex; gap: 8px; margin-top: 8px;">
                  <button id="missionDynSyncFromJsonBtn" class="btn" style="font-size: 11px;">Sync from JSON</button>
                  <button id="missionDynWriteToJsonBtn" class="btn" style="font-size: 11px;">Write to JSON</button>
                </div>
              </div>
            </div>

            <div class="field">
              <label>AI Contract JSON (single blob)</label>
              <textarea
                id="aiContractJsonTextarea"
                placeholder='{"version":1,"dynamics":{"mode":"CHAT","locationTag":"APP_CHAT","hasPerMessageTimer":false,"defaultEntryRoute":"TEXT_CHAT"},"objective":{"kind":"PRACTICE_OPENING","userTitle":"Mission Title","userDescription":"Mission description"},"difficulty":{"level":"EASY"},"style":{"aiStyleKey":"NEUTRAL"},"statePolicy":{"maxMessages":10,"maxStrikes":3,"allowTimerExtension":false,"successScoreThreshold":60,"failScoreThreshold":40,"enableGateSequence":false,"enableMoodCollapse":false,"enableObjectiveAutoSuccess":false,"allowedEndReasons":["SUCCESS_OBJECTIVE","FAIL_OBJECTIVE"]}}'
              ></textarea>

              <div style="display:flex; gap:8px; flex-wrap:wrap;">
                <button id="validateAiContractBtn" class="btn">Validate JSON</button>
                <button id="formatAiContractBtn" class="btn">Format JSON</button>
                <button id="pasteSampleBtn" class="btn">Paste Sample Contract</button>
              </div>

              <div id="contractErrorBox" class="dangerBox" style="margin-top:10px;"></div>
            </div>

            <!-- Mission Validation Errors -->
            <div id="missionValidationErrors" style="margin-top: 12px; padding: 12px; background: rgba(255, 92, 122, 0.1); border: 1px solid var(--bad); border-radius: 6px; display: none;">
              <div style="font-weight: 700; color: var(--bad); margin-bottom: 8px;">Validation Errors:</div>
              <ul id="missionValidationErrorsList" style="margin: 0; padding-left: 20px; color: var(--bad); font-size: 12px;"></ul>
            </div>

            <!-- Practice Hub Designer: Mission Attraction Fields -->
            <div class="field" style="margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--line);">
              <label style="font-weight: 700; margin-bottom: 8px;">Attraction Routing</label>
              <div style="display: flex; flex-direction: column; gap: 8px;">
                <label style="display: flex; align-items: center; gap: 8px;">
                  <input type="checkbox" id="missionIsAttractionSensitiveCheckbox" />
                  <span>Attraction-Sensitive Mission</span>
                </label>
                <div id="missionTargetGenderField" style="display: none;">
                  <label>Target Romantic Gender</label>
                  <select id="missionTargetRomanticGenderSelect">
                    <option value="">(select)</option>
                    <option value="FEMALE">FEMALE</option>
                    <option value="MALE">MALE</option>
                    <option value="OTHER">OTHER</option>
                    <option value="UNKNOWN">UNKNOWN</option>
                  </select>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Step 7: Mission Monitor / Deep Insights Section -->
      <div id="missionMonitorSection" class="panel" style="margin-top: 14px; display: none;">
        <div class="panelHead">
          <div class="left">
            <h2 style="margin: 0; font-size: 16px; font-weight: 800;">Mission Monitor</h2>
            <span class="mini" style="margin-left: 12px;">Step 7.1-7.6: Mission Stats, Config View, Mood Timeline, Message Log</span>
          </div>
          <div class="right">
            <button id="loadMissionStatsBtn" class="btn">Refresh Stats</button>
            <button id="loadMissionTimelineBtn" class="btn">Load Timeline</button>
            <button id="loadMissionMessagesBtn" class="btn">Load Messages</button>
          </div>
        </div>
        <div class="body">
          <div id="missionMonitorEmpty" style="text-align: center; padding: 40px; color: var(--muted);">
            Select a mission to view details, stats, and analytics.
          </div>
          <div id="missionMonitorContent" style="display: none;">
            <!-- Mission Config View (7.2) -->
            <div style="margin-bottom: 24px; padding-bottom: 16px; border-bottom: 1px solid var(--line);">
              <h3 style="font-size: 14px; font-weight: 700; margin-bottom: 12px;">Mission Config (7.2)</h3>
              <div id="missionConfigView" style="font-size: 12px; color: var(--muted);">
                <div id="missionConfigEmpty" style="color: var(--muted);">No config data available.</div>
                <div id="missionConfigDetails" style="display: none;">
                  <div class="split" style="margin-bottom: 8px;">
                    <div><strong>Objective:</strong> <span id="configObjective"></span></div>
                    <div><strong>Difficulty:</strong> <span id="configDifficulty"></span></div>
                  </div>
                  <div class="split" style="margin-bottom: 8px;">
                    <div><strong>AI Style:</strong> <span id="configAiStyle"></span></div>
                    <div><strong>Runtime Profile:</strong> <span id="configRuntimeProfile"></span></div>
                  </div>
                  <div style="margin-top: 8px;">
                    <strong>Gate Config:</strong> <span id="configGateConfig"></span>
                  </div>
                  <div style="margin-top: 8px;">
                    <button id="viewRawConfigBtn" class="btn" style="font-size: 11px;">View Raw JSON</button>
                  </div>
                </div>
              </div>
            </div>

            <!-- Mission Stats Summary (7.3) -->
            <div style="margin-bottom: 24px; padding-bottom: 16px; border-bottom: 1px solid var(--line);">
              <h3 style="font-size: 14px; font-weight: 700; margin-bottom: 12px;">Stats Summary (7.3)</h3>
              <div style="margin-bottom: 8px;">
                <label style="font-size: 11px; color: var(--muted);">Time Window:</label>
                <select id="statsTimeWindow" style="margin-left: 8px; background: var(--controlBg); border: 1px solid var(--controlBorder); border-radius: 6px; padding: 4px 8px; color: var(--text);">
                  <option value="7">Last 7 days</option>
                  <option value="30">Last 30 days</option>
                  <option value="all">All time</option>
                </select>
              </div>
              <div id="missionStatsView" style="font-size: 12px;">
                <div id="missionStatsEmpty" style="color: var(--muted);">No session data available yet.</div>
                <div id="missionStatsDetails" style="display: none;">
                  <div class="split" style="margin-bottom: 8px;">
                    <div><strong>Sessions:</strong> <span id="statsSessionCount">0</span></div>
                    <div><strong>Success Rate:</strong> <span id="statsSuccessRate">0%</span></div>
                  </div>
                  <div class="split" style="margin-bottom: 8px;">
                    <div><strong>Avg Messages:</strong> <span id="statsAvgMessages">0</span></div>
                    <div><strong>Avg Duration:</strong> <span id="statsAvgDuration">0s</span></div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Mood Timeline Visualization (7.4) -->
            <div style="margin-bottom: 24px; padding-bottom: 16px; border-bottom: 1px solid var(--line);">
              <h3 style="font-size: 14px; font-weight: 700; margin-bottom: 12px;">Mood Timeline (7.4)</h3>
              <div id="moodTimelineView">
                <div id="moodTimelineEmpty" style="color: var(--muted);">No mood timeline data available.</div>
                <div id="moodTimelineChart" style="display: none; min-height: 200px;">
                  <canvas id="moodTimelineCanvas" style="max-width: 100%;"></canvas>
                </div>
              </div>
            </div>

            <!-- Per-Message Log (7.5) -->
            <div>
              <h3 style="font-size: 14px; font-weight: 700; margin-bottom: 12px;">Per-Message Log (7.5)</h3>
              <div style="margin-bottom: 8px;">
                <label style="font-size: 11px; color: var(--muted);">Session:</label>
                <select id="messageLogSessionSelect" style="margin-left: 8px; background: var(--controlBg); border: 1px solid var(--controlBorder); border-radius: 6px; padding: 4px 8px; color: var(--text);">
                  <option value="">Select a session...</option>
                </select>
              </div>
              <div id="messageLogView" style="max-height: 400px; overflow-y: auto;">
                <div id="messageLogEmpty" style="color: var(--muted);">Select a session to view messages.</div>
                <div id="messageLogTable" style="display: none;">
                  <table style="width: 100%; border-collapse: collapse; font-size: 11px;">
                    <thead>
                      <tr style="border-bottom: 1px solid var(--line);">
                        <th style="text-align: left; padding: 8px;">Turn</th>
                        <th style="text-align: left; padding: 8px;">Role</th>
                        <th style="text-align: left; padding: 8px;">Content</th>
                        <th style="text-align: left; padding: 8px;">Score</th>
                        <th style="text-align: left; padding: 8px;">Rarity</th>
                        <th style="text-align: left; padding: 8px;">Mood Δ</th>
                        <th style="text-align: left; padding: 8px;">Gates</th>
                      </tr>
                    </thead>
                    <tbody id="messageLogTableBody">
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Practice Hub Designer Section -->
      <div class="panel" style="margin-top: 14px;">
        <div class="panelHead">
          <div class="left">
            <h2 style="margin: 0; font-size: 16px; font-weight: 800;">Practice Hub Designer</h2>
          </div>
          <div class="right">
            <button id="loadCategoriesBtn" class="btn">Load Categories</button>
            <button id="addCategoryBtn" class="btn">Add Category</button>
            <button id="reorderCategoriesBtn" class="btn">Reorder Categories</button>
          </div>
        </div>
        <div class="body">
          <div id="categoriesGrid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 12px; margin-top: 12px;">
            <!-- Categories will be rendered here -->
          </div>
        </div>
      </div>

      <!-- Category Editor Modal -->
      <div id="categoryModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 1000; overflow: auto; padding: 20px;">
        <div class="panel" style="max-width: 600px; margin: 20px auto;">
          <div class="panelHead">
            <div class="left">
              <h3 style="margin: 0;">Category Editor</h3>
            </div>
            <div class="right">
              <button id="closeCategoryModalBtn" class="btn">Close</button>
            </div>
          </div>
          <div class="body">
            <div class="field">
              <label>Category Label</label>
              <input id="categoryLabelInput" placeholder="e.g. 'Openers'" />
            </div>
            <div class="field">
              <label>Description</label>
              <textarea id="categoryDescriptionInput" style="min-height: 80px;" placeholder="Optional description"></textarea>
            </div>
            <div class="field">
              <label>Code (read-only)</label>
              <input id="categoryCodeInput" readonly style="background: rgba(255,255,255,0.05);" />
            </div>
            <div class="field">
              <label>Attraction Path</label>
              <select id="categoryAttractionPathSelect">
                <option value="UNISEX">Unisex</option>
                <option value="FEMALE_PATH">Approach Women</option>
                <option value="MALE_PATH">Approach Men</option>
              </select>
            </div>
            <div class="field" id="categoryDynamicLabelField" style="display: none;">
              <label>Dynamic Label Template</label>
              <input id="categoryDynamicLabelInput" placeholder="e.g. 'Approach {{targetPlural}}'" />
            </div>
            <div class="split">
              <div class="field">
                <label>Display Order</label>
                <input type="number" id="categoryDisplayOrderInput" value="0" min="0" />
              </div>
              <div class="field">
                <label>Icon URL (optional)</label>
                <input id="categoryIconUrlInput" placeholder="https://..." />
              </div>
            </div>
            <div class="field">
              <label>
                <input type="checkbox" id="categoryActiveCheckbox" checked />
                Active
              </label>
            </div>
            <div id="categoryErrorBox" class="dangerBox" style="margin-top: 10px;"></div>
            <div style="margin-top: 16px; display: flex; gap: 8px;">
              <button id="saveCategoryBtn" class="btn">Save Category</button>
              <button id="deleteCategoryBtn" class="btn" style="background: var(--bad);">Delete Category</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Missions View Modal -->
      <div id="missionsViewModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 1000; overflow: auto; padding: 20px;">
        <div class="panel" style="max-width: 900px; margin: 20px auto;">
          <div class="panelHead">
            <div class="left">
              <h3 id="missionsViewTitle" style="margin: 0;">Missions in Category</h3>
            </div>
            <div class="right">
              <button id="closeMissionsViewBtn" class="btn">Close</button>
            </div>
          </div>
          <div class="body">
            <div id="missionsViewTable" style="overflow-x: auto;">
              <table style="width: 100%; border-collapse: collapse;">
                <thead>
                  <tr style="border-bottom: 1px solid var(--line);">
                    <th style="text-align: left; padding: 8px;">Title</th>
                    <th style="text-align: left; padding: 8px;">Code</th>
                    <th style="text-align: left; padding: 8px;">Difficulty</th>
                    <th style="text-align: left; padding: 8px;">Attraction</th>
                    <th style="text-align: left; padding: 8px;">Target</th>
                    <th style="text-align: left; padding: 8px;">Active</th>
                    <th style="text-align: left; padding: 8px;">Actions</th>
                  </tr>
                </thead>
                <tbody id="missionsViewTableBody">
                  <!-- Missions will be rendered here -->
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      </div>
      <!-- End Legacy Layout -->

      <!-- Mission Builder Modal -->
      <div id="missionBuilderModal" class="modal-overlay">
        <div class="modal">
          <div class="modal-header">
            <div class="modal-title" id="missionBuilderTitle">Mission Builder</div>
            <button class="modal-close" id="missionBuilderClose">&times;</button>
          </div>
          <div class="body" id="missionBuilderContent">
            <!-- Content will be populated by JavaScript -->
          </div>
        </div>
      </div>

      <!-- Toast Container -->
      <div id="toastContainer" class="toast"></div>

      <!-- v2 Reusable Editor Modal -->
      <div id="v2EditorModal" class="modal-overlay" style="display: none;">
        <div class="modal">
          <div class="modal-header">
            <div class="modal-title" id="v2EditorModalTitle">Editor</div>
            <button class="modal-close" id="v2EditorModalClose">&times;</button>
          </div>
          <div class="body" id="v2EditorModalContent">
            <!-- Content will be populated by JavaScript -->
          </div>
          <div class="modal-footer" id="v2EditorModalFooter" style="display: none; margin-top: 20px; padding-top: 16px; border-top: 1px solid var(--line); display: flex; gap: 12px; justify-content: flex-end;">
            <button class="btn" id="v2EditorModalCancel">Cancel</button>
            <button class="btn" id="v2EditorModalSave" style="background: var(--ok);">Save</button>
          </div>
        </div>
      </div>

      <!-- Engine Config Section (Step 7.2) -->
      <div class="panel" style="margin-top: 14px;">
        <div class="panelHead">
          <div class="left">
            <h2 style="margin: 0; font-size: 16px; font-weight: 800;">Engine Config</h2>
            <span class="mini" style="margin-left: 12px;">Step 5-6 Knobs: Scoring, Dynamics, Gates, Mood, Hooks, Insights</span>
          </div>
          <div class="right">
            <button id="engineConfigLoadBtn" class="btn">Load Config</button>
            <button id="engineConfigSaveBtn" class="btn">Save Config</button>
          </div>
        </div>

        <!-- Tabs -->
        <div style="display: flex; gap: 8px; padding: 12px; border-bottom: 1px solid var(--line); flex-wrap: wrap;">
          <button class="engineConfigTab" data-tab="scoring" style="padding: 6px 12px; background: var(--btn); border: 1px solid var(--line); border-radius: 6px; color: var(--text); cursor: pointer;">Scoring & Traits</button>
          <button class="engineConfigTab" data-tab="dynamics" style="padding: 6px 12px; background: var(--btn); border: 1px solid var(--line); border-radius: 6px; color: var(--text); cursor: pointer;">Dynamics Profiles</button>
          <button class="engineConfigTab" data-tab="gates" style="padding: 6px 12px; background: var(--btn); border: 1px solid var(--line); border-radius: 6px; color: var(--text); cursor: pointer;">Gates & Objectives</button>
          <button class="engineConfigTab" data-tab="hooks" style="padding: 6px 12px; background: var(--btn); border: 1px solid var(--line); border-radius: 6px; color: var(--text); cursor: pointer;">Hooks & Triggers</button>
          <button class="engineConfigTab" data-tab="mood" style="padding: 6px 12px; background: var(--btn); border: 1px solid var(--line); border-radius: 6px; color: var(--text); cursor: pointer;">Mood & State Policy</button>
          <button class="engineConfigTab" data-tab="insights" style="padding: 6px 12px; background: var(--btn); border: 1px solid var(--line); border-radius: 6px; color: var(--text); cursor: pointer;">Insights Catalog</button>
          <button class="engineConfigTab" data-tab="attachments" style="padding: 6px 12px; background: var(--btn); border: 1px solid var(--line); border-radius: 6px; color: var(--text); cursor: pointer;">Mission Attachments</button>
          <button class="engineConfigTab" data-tab="monitoring" style="padding: 6px 12px; background: var(--btn); border: 1px solid var(--line); border-radius: 6px; color: var(--text); cursor: pointer;">Monitoring</button>
          <button class="engineConfigTab" data-tab="microFeedback" style="padding: 6px 12px; background: var(--btn); border: 1px solid var(--line); border-radius: 6px; color: var(--text); cursor: pointer;">Micro Feedback</button>
          <button class="engineConfigTab" data-tab="microDynamics" style="padding: 6px 12px; background: var(--btn); border: 1px solid var(--line); border-radius: 6px; color: var(--text); cursor: pointer;">Micro Dynamics</button>
          <button class="engineConfigTab" data-tab="persona" style="padding: 6px 12px; background: var(--btn); border: 1px solid var(--line); border-radius: 6px; color: var(--text); cursor: pointer;">Persona Drift</button>
        </div>

        <!-- Tab Content -->
        <div class="body" style="padding: 16px;">
          <!-- Scoring & Traits Tab -->
          <div id="engineConfigTabScoring" class="engineConfigTabContent" style="display: none;">
            <div class="row" style="grid-template-columns: 300px 1fr;">
              <div class="panel" style="background: var(--panel);">
                <div class="panelHead">
                  <div class="left">
                    <span class="mini">Scoring Profiles</span>
                  </div>
                  <div class="right">
                    <button id="engineConfigAddScoringProfileBtn" class="btn" style="font-size: 11px;">Add</button>
                  </div>
                </div>
                <div class="listWrap">
                  <div id="engineConfigScoringProfilesList" class="list"></div>
                </div>
              </div>
              <div class="panel" style="background: var(--panel);">
                <div class="panelHead">
                  <div class="left">
                    <span class="mini">Profile Editor</span>
                  </div>
                </div>
                <div class="body">
                  <div id="engineConfigScoringProfileEditor" style="display: none;">
                    <div class="field">
                      <label>Code</label>
                      <input id="engineConfigScoringCode" readonly style="background: rgba(255,255,255,0.05);" />
                    </div>
                    <div class="field">
                      <label>Name</label>
                      <input id="engineConfigScoringName" />
                    </div>
                    <div class="field">
                      <label>Description</label>
                      <textarea id="engineConfigScoringDescription" style="min-height: 60px;"></textarea>
                    </div>
                    <div class="field">
                      <label>
                        <input type="checkbox" id="engineConfigScoringActive" /> Active
                      </label>
                    </div>

                    <div style="margin-top: 20px; padding-top: 16px; border-top: 1px solid var(--line);">
                      <label style="font-weight: 700;">Trait Weights (should sum to ~1.0)</label>
                      <div class="split3" style="margin-top: 8px;">
                        <div class="field">
                          <label>Confidence</label>
                          <input type="number" id="engineConfigScoringWeightConfidence" step="0.01" min="0" max="1" />
                        </div>
                        <div class="field">
                          <label>Clarity</label>
                          <input type="number" id="engineConfigScoringWeightClarity" step="0.01" min="0" max="1" />
                        </div>
                        <div class="field">
                          <label>Humor</label>
                          <input type="number" id="engineConfigScoringWeightHumor" step="0.01" min="0" max="1" />
                        </div>
                        <div class="field">
                          <label>Tension Control</label>
                          <input type="number" id="engineConfigScoringWeightTensionControl" step="0.01" min="0" max="1" />
                        </div>
                        <div class="field">
                          <label>Emotional Warmth</label>
                          <input type="number" id="engineConfigScoringWeightEmotionalWarmth" step="0.01" min="0" max="1" />
                        </div>
                        <div class="field">
                          <label>Dominance</label>
                          <input type="number" id="engineConfigScoringWeightDominance" step="0.01" min="0" max="1" />
                        </div>
                      </div>
                      <button id="engineConfigScoringNormalizeWeightsBtn" class="btn" style="margin-top: 8px;">Normalize to 1.0</button>
                      <div id="engineConfigScoringWeightsSum" style="margin-top: 8px; font-size: 12px; color: var(--muted);"></div>
                    </div>

                    <div style="margin-top: 20px; padding-top: 16px; border-top: 1px solid var(--line);">
                      <label style="font-weight: 700;">Length Thresholds</label>
                      <div class="split3" style="margin-top: 8px;">
                        <div class="field">
                          <label>Empty (0)</label>
                          <input type="number" id="engineConfigScoringLengthEmpty" min="0" max="100" />
                        </div>
                        <div class="field">
                          <label>Very Short (&lt;5)</label>
                          <input type="number" id="engineConfigScoringLengthVeryShort" min="0" max="100" />
                        </div>
                        <div class="field">
                          <label>Short (&lt;15)</label>
                          <input type="number" id="engineConfigScoringLengthShort" min="0" max="100" />
                        </div>
                        <div class="field">
                          <label>Medium (&lt;40)</label>
                          <input type="number" id="engineConfigScoringLengthMedium" min="0" max="100" />
                        </div>
                        <div class="field">
                          <label>Long (&lt;80)</label>
                          <input type="number" id="engineConfigScoringLengthLong" min="0" max="100" />
                        </div>
                        <div class="field">
                          <label>Very Long (≥80)</label>
                          <input type="number" id="engineConfigScoringLengthVeryLong" min="0" max="100" />
                        </div>
                      </div>
                    </div>

                    <div style="margin-top: 20px; padding-top: 16px; border-top: 1px solid var(--line);">
                      <label style="font-weight: 700;">Punctuation Bonuses</label>
                      <div class="split" style="margin-top: 8px;">
                        <div class="field">
                          <label>Question Per Mark</label>
                          <input type="number" id="engineConfigScoringPunctQuestionPerMark" min="0" max="10" />
                        </div>
                        <div class="field">
                          <label>Question Max</label>
                          <input type="number" id="engineConfigScoringPunctQuestionMax" min="0" max="20" />
                        </div>
                        <div class="field">
                          <label>Exclamation Per Mark</label>
                          <input type="number" id="engineConfigScoringPunctExclamationPerMark" min="0" max="10" />
                        </div>
                        <div class="field">
                          <label>Exclamation Max</label>
                          <input type="number" id="engineConfigScoringPunctExclamationMax" min="0" max="20" />
                        </div>
                      </div>
                    </div>

                    <div style="margin-top: 20px; padding-top: 16px; border-top: 1px solid var(--line);">
                      <label style="font-weight: 700;">Position Bonuses</label>
                      <div style="display: flex; gap: 8px; margin-top: 8px;">
                        <div class="field" style="flex: 1;">
                          <label>Index 0</label>
                          <input type="number" id="engineConfigScoringPosition0" min="0" max="10" />
                        </div>
                        <div class="field" style="flex: 1;">
                          <label>Index 1</label>
                          <input type="number" id="engineConfigScoringPosition1" min="0" max="10" />
                        </div>
                        <div class="field" style="flex: 1;">
                          <label>Index 2</label>
                          <input type="number" id="engineConfigScoringPosition2" min="0" max="10" />
                        </div>
                        <div class="field" style="flex: 1;">
                          <label>Index 3+</label>
                          <input type="number" id="engineConfigScoringPosition3" min="0" max="10" />
                        </div>
                      </div>
                    </div>

                    <div style="margin-top: 20px; padding-top: 16px; border-top: 1px solid var(--line);">
                      <label style="font-weight: 700;">Rarity Thresholds</label>
                      <div class="split3" style="margin-top: 8px;">
                        <div class="field">
                          <label>S+</label>
                          <input type="number" id="engineConfigScoringRaritySPlus" min="0" max="100" />
                        </div>
                        <div class="field">
                          <label>S</label>
                          <input type="number" id="engineConfigScoringRarityS" min="0" max="100" />
                        </div>
                        <div class="field">
                          <label>A</label>
                          <input type="number" id="engineConfigScoringRarityA" min="0" max="100" />
                        </div>
                        <div class="field">
                          <label>B</label>
                          <input type="number" id="engineConfigScoringRarityB" min="0" max="100" />
                        </div>
                      </div>
                    </div>

                    <div style="margin-top: 20px; padding-top: 16px; border-top: 1px solid var(--line);">
                      <label style="font-weight: 700;">XP Multipliers</label>
                      <div class="split3" style="margin-top: 8px;">
                        <div class="field">
                          <label>S+</label>
                          <input type="number" id="engineConfigScoringXpSPlus" step="0.1" min="0" max="3" />
                        </div>
                        <div class="field">
                          <label>S</label>
                          <input type="number" id="engineConfigScoringXpS" step="0.1" min="0" max="3" />
                        </div>
                        <div class="field">
                          <label>A</label>
                          <input type="number" id="engineConfigScoringXpA" step="0.1" min="0" max="3" />
                        </div>
                        <div class="field">
                          <label>B</label>
                          <input type="number" id="engineConfigScoringXpB" step="0.1" min="0" max="3" />
                        </div>
                        <div class="field">
                          <label>C</label>
                          <input type="number" id="engineConfigScoringXpC" step="0.1" min="0" max="3" />
                        </div>
                      </div>
                    </div>

                    <div style="margin-top: 20px; padding-top: 16px; border-top: 1px solid var(--line);">
                      <label style="font-weight: 700;">Coins Multipliers</label>
                      <div class="split3" style="margin-top: 8px;">
                        <div class="field">
                          <label>S+</label>
                          <input type="number" id="engineConfigScoringCoinsSPlus" step="0.1" min="0" max="3" />
                        </div>
                        <div class="field">
                          <label>S</label>
                          <input type="number" id="engineConfigScoringCoinsS" step="0.1" min="0" max="3" />
                        </div>
                        <div class="field">
                          <label>A</label>
                          <input type="number" id="engineConfigScoringCoinsA" step="0.1" min="0" max="3" />
                        </div>
                        <div class="field">
                          <label>B</label>
                          <input type="number" id="engineConfigScoringCoinsB" step="0.1" min="0" max="3" />
                        </div>
                        <div class="field">
                          <label>C</label>
                          <input type="number" id="engineConfigScoringCoinsC" step="0.1" min="0" max="3" />
                        </div>
                      </div>
                    </div>

                    <div style="margin-top: 20px; padding-top: 16px; border-top: 1px solid var(--line);">
                      <label style="font-weight: 700;">Trait Adjustments</label>
                      <div id="engineConfigScoringTraitAdjustmentsList" style="margin-top: 8px;"></div>
                      <button id="engineConfigScoringAddTraitAdjustmentBtn" class="btn" style="margin-top: 8px; font-size: 11px;">Add Adjustment</button>
                    </div>

                    <div style="margin-top: 20px; padding-top: 16px; border-top: 1px solid var(--line);">
                      <label style="font-weight: 700;">Filler Words</label>
                      <div id="engineConfigScoringFillerWords" style="margin-top: 8px; display: flex; flex-wrap: wrap; gap: 6px; padding: 8px; background: var(--controlBg); border-radius: 6px; min-height: 40px;"></div>
                      <input type="text" id="engineConfigScoringFillerWordInput" placeholder="Add filler word..." style="margin-top: 8px; width: 100%;" />
                    </div>

                    <div style="margin-top: 20px; padding-top: 16px; border-top: 1px solid var(--line);">
                      <label style="font-weight: 700;">Trait EMA Alpha</label>
                      <div class="field" style="margin-top: 8px;">
                        <input type="number" id="engineConfigScoringTraitEmaAlpha" step="0.01" min="0" max="1" />
                      </div>
                    </div>

                    <div style="margin-top: 20px; padding-top: 16px; border-top: 1px solid var(--line);">
                      <label style="font-weight: 700;">Flags</label>
                      <div style="margin-top: 8px; display: flex; gap: 16px;">
                        <label><input type="checkbox" id="engineConfigScoringStrictMode" /> Strict Mode</label>
                        <label><input type="checkbox" id="engineConfigScoringSoftCoachingMode" /> Soft Coaching Mode</label>
                      </div>
                    </div>

                    <div style="margin-top: 20px; padding-top: 16px; border-top: 1px solid var(--line);">
                      <label style="font-weight: 700;">Micro Feedback Messages</label>
                      <div style="margin-top: 8px;">
                        <div class="field" style="margin-bottom: 12px;">
                          <label>Very Short Message (&lt;5 chars)</label>
                          <textarea id="engineConfigMicroFeedbackVeryShort" style="min-height: 50px;"></textarea>
                        </div>
                        <div class="field" style="margin-bottom: 12px;">
                          <label>Default Message (fallback)</label>
                          <textarea id="engineConfigMicroFeedbackDefault" style="min-height: 50px;"></textarea>
                        </div>
                        <div style="margin-top: 16px;">
                          <label style="font-weight: 600; margin-bottom: 8px; display: block;">Feedback Bands</label>
                          <div id="engineConfigMicroFeedbackBandsList" style="margin-top: 8px;"></div>
                          <button id="engineConfigMicroFeedbackAddBandBtn" class="btn" style="margin-top: 8px; font-size: 11px;">Add Band</button>
                        </div>
                      </div>
                    </div>
                  </div>
                  <div id="engineConfigScoringProfileEditorEmpty" style="text-align: center; padding: 40px; color: var(--muted);">
                    Select a scoring profile to edit
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Dynamics Profiles Tab -->
          <div id="engineConfigTabDynamics" class="engineConfigTabContent" style="display: none;">
            <div class="row" style="grid-template-columns: 300px 1fr;">
              <div class="panel" style="background: var(--panel);">
                <div class="panelHead">
                  <div class="left">
                    <span class="mini">Dynamics Profiles</span>
                  </div>
                  <div class="right">
                    <button id="engineConfigAddDynamicsProfileBtn" class="btn" style="font-size: 11px;">Add</button>
                  </div>
                </div>
                <div class="listWrap">
                  <div id="engineConfigDynamicsProfilesList" class="list"></div>
                </div>
              </div>
              <div class="panel" style="background: var(--panel);">
                <div class="panelHead">
                  <div class="left">
                    <span class="mini">Profile Editor</span>
                  </div>
                </div>
                <div class="body">
                  <div id="engineConfigDynamicsProfileEditor" style="display: none;">
                    <div class="field">
                      <label>Code</label>
                      <input id="engineConfigDynamicsCode" />
                    </div>
                    <div class="field">
                      <label>Name</label>
                      <input id="engineConfigDynamicsName" />
                    </div>
                    <div class="field">
                      <label>Description</label>
                      <textarea id="engineConfigDynamicsDescription" style="min-height: 60px;"></textarea>
                    </div>
                    <div class="field">
                      <label>
                        <input type="checkbox" id="engineConfigDynamicsActive" /> Active
                      </label>
                    </div>

                    <div style="margin-top: 20px; padding-top: 16px; border-top: 1px solid var(--line);">
                      <label style="font-weight: 700;">Dynamics (0-100)</label>
                      <div style="margin-top: 12px; display: flex; flex-direction: column; gap: 12px;">
                        <div>
                          <label>Pace</label>
                          <input type="range" id="engineConfigDynamicsPace" min="0" max="100" value="50" style="width: 100%;" />
                          <div style="display: flex; justify-content: space-between; font-size: 11px; color: var(--muted);">
                            <span>Slow</span>
                            <span id="engineConfigDynamicsPaceValue">50</span>
                            <span>Fast</span>
                          </div>
                        </div>
                        <div>
                          <label>Emoji Density</label>
                          <input type="range" id="engineConfigDynamicsEmojiDensity" min="0" max="100" value="30" style="width: 100%;" />
                          <div style="display: flex; justify-content: space-between; font-size: 11px; color: var(--muted);">
                            <span>None</span>
                            <span id="engineConfigDynamicsEmojiDensityValue">30</span>
                            <span>Heavy</span>
                          </div>
                        </div>
                        <div>
                          <label>Flirtiveness</label>
                          <input type="range" id="engineConfigDynamicsFlirtiveness" min="0" max="100" value="40" style="width: 100%;" />
                          <div style="display: flex; justify-content: space-between; font-size: 11px; color: var(--muted);">
                            <span>Platonic</span>
                            <span id="engineConfigDynamicsFlirtivenessValue">40</span>
                            <span>Very Flirty</span>
                          </div>
                        </div>
                        <div>
                          <label>Hostility</label>
                          <input type="range" id="engineConfigDynamicsHostility" min="0" max="100" value="10" style="width: 100%;" />
                          <div style="display: flex; justify-content: space-between; font-size: 11px; color: var(--muted);">
                            <span>Friendly</span>
                            <span id="engineConfigDynamicsHostilityValue">10</span>
                            <span>Hostile</span>
                          </div>
                        </div>
                        <div>
                          <label>Dryness</label>
                          <input type="range" id="engineConfigDynamicsDryness" min="0" max="100" value="40" style="width: 100%;" />
                          <div style="display: flex; justify-content: space-between; font-size: 11px; color: var(--muted);">
                            <span>Warm</span>
                            <span id="engineConfigDynamicsDrynessValue">40</span>
                            <span>Dry/Sarcastic</span>
                          </div>
                        </div>
                        <div>
                          <label>Vulnerability</label>
                          <input type="range" id="engineConfigDynamicsVulnerability" min="0" max="100" value="50" style="width: 100%;" />
                          <div style="display: flex; justify-content: space-between; font-size: 11px; color: var(--muted);">
                            <span>Guarded</span>
                            <span id="engineConfigDynamicsVulnerabilityValue">50</span>
                            <span>Open</span>
                          </div>
                        </div>
                        <div>
                          <label>Escalation Speed</label>
                          <input type="range" id="engineConfigDynamicsEscalationSpeed" min="0" max="100" value="50" style="width: 100%;" />
                          <div style="display: flex; justify-content: space-between; font-size: 11px; color: var(--muted);">
                            <span>Slow</span>
                            <span id="engineConfigDynamicsEscalationSpeedValue">50</span>
                            <span>Fast</span>
                          </div>
                        </div>
                        <div>
                          <label>Randomness</label>
                          <input type="range" id="engineConfigDynamicsRandomness" min="0" max="100" value="25" style="width: 100%;" />
                          <div style="display: flex; justify-content: space-between; font-size: 11px; color: var(--muted);">
                            <span>Predictable</span>
                            <span id="engineConfigDynamicsRandomnessValue">25</span>
                            <span>Chaotic</span>
                          </div>
                        </div>
                      </div>
                      <div id="engineConfigDynamicsPreview" style="margin-top: 16px; padding: 12px; background: var(--panel2); border-radius: 6px; font-size: 12px; color: var(--muted);">
                        Preview: This profile is...
                      </div>
                    </div>
                  </div>
                  <div id="engineConfigDynamicsProfileEditorEmpty" style="text-align: center; padding: 40px; color: var(--muted);">
                    Select a dynamics profile to edit
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Gates & Objectives Tab -->
          <div id="engineConfigTabGates" class="engineConfigTabContent" style="display: none;">
            <div class="panel" style="background: var(--panel);">
              <div class="panelHead">
                <div class="left">
                  <span class="mini">Gate Configurations</span>
                </div>
                <div class="right">
                  <button id="engineConfigAddGateBtn" class="btn" style="font-size: 11px;">Add Gate</button>
                </div>
              </div>
              <div class="body">
                <table style="width: 100%; border-collapse: collapse;">
                  <thead>
                    <tr style="border-bottom: 1px solid var(--line);">
                      <th style="padding: 8px; text-align: left;">Key</th>
                      <th style="padding: 8px; text-align: left;">Description</th>
                      <th style="padding: 8px; text-align: left;">Thresholds</th>
                      <th style="padding: 8px; text-align: left;">Active</th>
                      <th style="padding: 8px; text-align: left;">Actions</th>
                    </tr>
                  </thead>
                  <tbody id="engineConfigGatesTableBody"></tbody>
                </table>
                <div id="engineConfigGateEditor" style="display: none; margin-top: 20px; padding-top: 16px; border-top: 1px solid var(--line);">
                  <div class="field">
                    <label>Gate Key</label>
                    <input id="engineConfigGateKey" />
                  </div>
                  <div class="field">
                    <label>Description</label>
                    <textarea id="engineConfigGateDescription" style="min-height: 60px;"></textarea>
                  </div>
                  <div class="field">
                    <label><input type="checkbox" id="engineConfigGateActive" /> Active</label>
                  </div>
                  <div class="split3" style="margin-top: 12px;">
                    <div class="field">
                      <label>Min Messages</label>
                      <input type="number" id="engineConfigGateMinMessages" min="0" />
                    </div>
                    <div class="field">
                      <label>Success Threshold</label>
                      <input type="number" id="engineConfigGateSuccessThreshold" min="0" max="100" />
                    </div>
                    <div class="field">
                      <label>Fail Floor</label>
                      <input type="number" id="engineConfigGateFailFloor" min="0" max="100" />
                    </div>
                  </div>
                  <button id="engineConfigGateSaveBtn" class="btn" style="margin-top: 12px;">Save Gate</button>
                </div>
              </div>
            </div>
          </div>

          <!-- Hooks & Triggers Tab -->
          <div id="engineConfigTabHooks" class="engineConfigTabContent" style="display: none;">
            <div class="panel" style="background: var(--panel); margin-bottom: 14px;">
              <div class="panelHead">
                <div class="left">
                  <span class="mini">Hook Catalog</span>
                </div>
                <div class="right">
                  <button id="engineConfigLoadHooksBtn" class="btn" style="font-size: 11px;">Load Hooks</button>
                  <button id="engineConfigAddHookBtn" class="btn" style="font-size: 11px;">Add Hook</button>
                </div>
              </div>
              <div class="body">
                <table style="width: 100%; border-collapse: collapse;">
                  <thead>
                    <tr style="border-bottom: 1px solid var(--line);">
                      <th style="padding: 8px; text-align: left;">Name</th>
                      <th style="padding: 8px; text-align: left;">Type</th>
                      <th style="padding: 8px; text-align: left;">Priority</th>
                      <th style="padding: 8px; text-align: left;">Enabled</th>
                      <th style="padding: 8px; text-align: left;">Tags</th>
                      <th style="padding: 8px; text-align: left;">Actions</th>
                    </tr>
                  </thead>
                  <tbody id="engineConfigHooksTableBody"></tbody>
                </table>
                <div id="engineConfigHookEditor" style="display: none; margin-top: 20px; padding-top: 16px; border-top: 1px solid var(--line);">
                  <div class="field">
                    <label>Name</label>
                    <input id="engineConfigHookName" />
                  </div>
                  <div class="split">
                    <div class="field">
                      <label>Type</label>
                      <select id="engineConfigHookType">
                        <option value="POSITIVE">POSITIVE</option>
                        <option value="NEGATIVE">NEGATIVE</option>
                        <option value="NEUTRAL">NEUTRAL</option>
                      </select>
                    </div>
                    <div class="field">
                      <label>Priority (1-100)</label>
                      <input type="number" id="engineConfigHookPriority" min="1" max="100" />
                    </div>
                  </div>
                  <div class="field">
                    <label>Text Template</label>
                    <textarea id="engineConfigHookTextTemplate" style="min-height: 100px;"></textarea>
                  </div>
                  <div class="field">
                    <label>Conditions (JSON)</label>
                    <textarea id="engineConfigHookConditionsJson" style="min-height: 150px; font-family: monospace;"></textarea>
                  </div>
                  <div class="field">
                    <label>Category</label>
                    <input id="engineConfigHookCategory" />
                  </div>
                  <div class="field">
                    <label>Tags (comma-separated)</label>
                    <input id="engineConfigHookTags" placeholder="tag1, tag2, tag3" />
                  </div>
                  <div class="field">
                    <label><input type="checkbox" id="engineConfigHookEnabled" checked /> Enabled</label>
                  </div>
                  <button id="engineConfigHookSaveBtn" class="btn" style="margin-top: 12px;">Save Hook</button>
                </div>
              </div>
            </div>
            <div class="panel" style="background: var(--panel);">
              <div class="panelHead">
                <div class="left">
                  <span class="mini">Triggers Monitor (Last 7 Days)</span>
                </div>
                <div class="right">
                  <button id="engineConfigRefreshTriggersBtn" class="btn" style="font-size: 11px;">Refresh</button>
                </div>
              </div>
              <div class="body">
                <table style="width: 100%; border-collapse: collapse;">
                  <thead>
                    <tr style="border-bottom: 1px solid var(--line);">
                      <th style="padding: 8px; text-align: left;">Hook Name</th>
                      <th style="padding: 8px; text-align: left;">Type</th>
                      <th style="padding: 8px; text-align: left;">Trigger Count</th>
                    </tr>
                  </thead>
                  <tbody id="engineConfigTriggersTableBody"></tbody>
                </table>
              </div>
            </div>
          </div>

          <!-- Mood & State Policy Tab -->
          <div id="engineConfigTabMood" class="engineConfigTabContent" style="display: none;">
            <div class="panel" style="background: var(--panel);">
              <div class="panelHead">
                <div class="left">
                  <span class="mini">Mood & State Policy Configuration</span>
                </div>
              </div>
              <div class="body">
                <div style="margin-bottom: 24px;">
                  <label style="font-weight: 700;">Mood EMA Alpha</label>
                  <div class="field" style="margin-top: 8px;">
                    <input type="number" id="engineConfigMoodEmaAlpha" step="0.01" min="0" max="1" />
                  </div>
                </div>

                <div style="margin-bottom: 24px; padding-top: 16px; border-top: 1px solid var(--line);">
                  <label style="font-weight: 700;">Mood State Classification Thresholds</label>
                  <div style="margin-top: 12px; display: flex; flex-direction: column; gap: 16px;">
                    <div>
                      <label>FLOW State</label>
                      <div class="split3" style="margin-top: 4px;">
                        <div class="field">
                          <label>Min Score</label>
                          <input type="number" id="engineConfigMoodFlowMinScore" min="0" max="100" />
                        </div>
                        <div class="field">
                          <label>Min Flow</label>
                          <input type="number" id="engineConfigMoodFlowMinFlow" min="0" max="100" />
                        </div>
                        <div class="field">
                          <label>Max Tension</label>
                          <input type="number" id="engineConfigMoodFlowMaxTension" min="0" max="100" />
                        </div>
                      </div>
                    </div>
                    <div>
                      <label>TENSE State</label>
                      <div class="split3" style="margin-top: 4px;">
                        <div class="field">
                          <label>Min Tension</label>
                          <input type="number" id="engineConfigMoodTenseMinTension" min="0" max="100" />
                        </div>
                        <div class="field">
                          <label>Or: Max Score</label>
                          <input type="number" id="engineConfigMoodTenseOrMaxScore" min="0" max="100" />
                        </div>
                        <div class="field">
                          <label>Or: Min Tension (if low score)</label>
                          <input type="number" id="engineConfigMoodTenseOrMinTension" min="0" max="100" />
                        </div>
                      </div>
                    </div>
                    <div>
                      <label>WARM State</label>
                      <div class="split3" style="margin-top: 4px;">
                        <div class="field">
                          <label>Min Score</label>
                          <input type="number" id="engineConfigMoodWarmMinScore" min="0" max="100" />
                        </div>
                        <div class="field">
                          <label>Max Score</label>
                          <input type="number" id="engineConfigMoodWarmMaxScore" min="0" max="100" />
                        </div>
                        <div class="field">
                          <label>Min Warmth</label>
                          <input type="number" id="engineConfigMoodWarmMinWarmth" min="0" max="100" />
                        </div>
                      </div>
                    </div>
                    <div>
                      <label>COLD State</label>
                      <div class="split" style="margin-top: 4px;">
                        <div class="field">
                          <label>Max Score</label>
                          <input type="number" id="engineConfigMoodColdMaxScore" min="0" max="100" />
                        </div>
                        <div class="field">
                          <label>Max Warmth</label>
                          <input type="number" id="engineConfigMoodColdMaxWarmth" min="0" max="100" />
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

                <div style="margin-bottom: 24px; padding-top: 16px; border-top: 1px solid var(--line);">
                  <label style="font-weight: 700;">Mood Bands</label>
                  <div id="engineConfigMoodBandsList" style="margin-top: 8px;"></div>
                  <button id="engineConfigMoodAddBandBtn" class="btn" style="margin-top: 8px; font-size: 11px;">Add Band</button>
                </div>

                <div style="margin-bottom: 24px; padding-top: 16px; border-top: 1px solid var(--line);">
                  <label style="font-weight: 700;">State Policy</label>
                  <div style="margin-top: 12px; display: flex; flex-direction: column; gap: 8px;">
                    <div class="field">
                      <label>Min Messages For Verdict</label>
                      <input type="number" id="engineConfigStatePolicyMinMessages" min="0" />
                    </div>
                    <div class="field">
                      <label><input type="checkbox" id="engineConfigStatePolicyFailOnThreeCritical" /> Fail On Three Critical Messages</label>
                    </div>
                    <div class="field">
                      <label><input type="checkbox" id="engineConfigStatePolicyAllowRecovery" checked /> Allow Recovery After Fail Gate</label>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Insights Catalog Tab -->
          <div id="engineConfigTabInsights" class="engineConfigTabContent" style="display: none;">
            <div style="display: flex; gap: 8px; margin-bottom: 12px;">
              <button class="btn" data-insights-subtab="insights" style="padding: 6px 12px; background: var(--btn); border: 1px solid var(--line); border-radius: 6px; color: var(--text); cursor: pointer;">Insights</button>
              <button class="btn" data-insights-subtab="openings" style="padding: 6px 12px; background: var(--btn); border: 1px solid var(--line); border-radius: 6px; color: var(--text); cursor: pointer;">Opening Templates</button>
            </div>
            
            <!-- Insights Sub-tab -->
            <div id="engineConfigInsightsSubtabInsights" class="engineConfigInsightsSubtab">
              <div class="panel" style="background: var(--panel);">
                <div class="panelHead">
                  <div class="left">
                    <span class="mini">Insights Catalog</span>
                  </div>
                  <div class="right">
                    <select id="engineConfigInsightsKindFilter" style="background: var(--controlBg); border: 1px solid var(--controlBorder); border-radius: 6px; padding: 4px 8px; color: var(--text);">
                      <option value="">All Kinds</option>
                      <option value="GATE_FAIL">GATE_FAIL</option>
                      <option value="POSITIVE_HOOK">POSITIVE_HOOK</option>
                      <option value="NEGATIVE_PATTERN">NEGATIVE_PATTERN</option>
                      <option value="GENERAL_TIP">GENERAL_TIP</option>
                      <option value="MOOD">MOOD</option>
                      <option value="SYNERGY">SYNERGY</option>
                      <option value="ANALYZER_PARAGRAPH">ANALYZER_PARAGRAPH</option>
                    </select>
                    <button id="engineConfigLoadInsightsBtn" class="btn" style="font-size: 11px; margin-left: 8px;">Load Insights</button>
                    <button id="engineConfigAddCustomInsightBtn" class="btn" style="font-size: 11px; margin-left: 8px;">Add Custom Insight</button>
                  </div>
                </div>
                <div class="body">
                  <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                      <tr style="border-bottom: 1px solid var(--line);">
                        <th style="padding: 8px; text-align: left;">ID</th>
                        <th style="padding: 8px; text-align: left;">Kind</th>
                        <th style="padding: 8px; text-align: left;">Title</th>
                        <th style="padding: 8px; text-align: left;">Category</th>
                        <th style="padding: 8px; text-align: left;">Requires</th>
                        <th style="padding: 8px; text-align: left;">Source</th>
                        <th style="padding: 8px; text-align: left;">Actions</th>
                      </tr>
                    </thead>
                    <tbody id="engineConfigInsightsTableBody"></tbody>
                  </table>
                  <div id="engineConfigInsightDetail" style="display: none; margin-top: 20px; padding-top: 16px; border-top: 1px solid var(--line);">
                    <div class="field">
                      <label>Title</label>
                      <input id="engineConfigInsightTitle" readonly style="background: rgba(255,255,255,0.05);" />
                    </div>
                    <div class="field">
                      <label>Body</label>
                      <textarea id="engineConfigInsightBody" readonly style="min-height: 100px; background: rgba(255,255,255,0.05);"></textarea>
                    </div>
                    <div class="field">
                      <label>Requires (Gate/Hook/Pattern Key)</label>
                      <input id="engineConfigInsightRequires" readonly style="background: rgba(255,255,255,0.05);" />
                    </div>
                  </div>
                  <div id="engineConfigCustomInsightEditor" style="display: none; margin-top: 20px; padding-top: 16px; border-top: 1px solid var(--line);">
                    <div class="field">
                      <label>Key (Unique)</label>
                      <input id="engineConfigCustomInsightKey" />
                    </div>
                    <div class="field">
                      <label>Kind</label>
                      <select id="engineConfigCustomInsightKind">
                        <option value="GATE_FAIL">GATE_FAIL</option>
                        <option value="POSITIVE_HOOK">POSITIVE_HOOK</option>
                        <option value="NEGATIVE_PATTERN">NEGATIVE_PATTERN</option>
                        <option value="GENERAL_TIP">GENERAL_TIP</option>
                        <option value="MOOD">MOOD</option>
                        <option value="SYNERGY">SYNERGY</option>
                        <option value="ANALYZER_PARAGRAPH">ANALYZER_PARAGRAPH</option>
                      </select>
                    </div>
                    <div class="field">
                      <label>Title</label>
                      <input id="engineConfigCustomInsightTitle" />
                    </div>
                    <div class="field">
                      <label>Body</label>
                      <textarea id="engineConfigCustomInsightBody" style="min-height: 100px;"></textarea>
                    </div>
                    <div class="field">
                      <label>Category</label>
                      <input id="engineConfigCustomInsightCategory" placeholder="general" />
                    </div>
                    <div class="field">
                      <label>Tags (comma-separated)</label>
                      <input id="engineConfigCustomInsightTags" placeholder="tag1, tag2" />
                    </div>
                    <div class="field">
                      <label>Weight (1-100)</label>
                      <input type="number" id="engineConfigCustomInsightWeight" min="1" max="100" value="50" />
                    </div>
                    <div class="field">
                      <label>Cooldown Missions</label>
                      <input type="number" id="engineConfigCustomInsightCooldown" min="0" value="3" />
                    </div>
                    <div class="field">
                      <label>Requires (JSON, e.g., {"gateKey": "GATE_MIN_MESSAGES"})</label>
                      <textarea id="engineConfigCustomInsightRequires" style="min-height: 80px; font-family: monospace;" placeholder='{"gateKey": "GATE_MIN_MESSAGES"}'></textarea>
                    </div>
                    <button id="engineConfigCustomInsightSaveBtn" class="btn" style="margin-top: 12px;">Create Custom Insight</button>
                    <button id="engineConfigCustomInsightCancelBtn" class="btn" style="margin-top: 12px; margin-left: 8px;">Cancel</button>
                  </div>
                </div>
              </div>
            </div>

            <!-- Opening Templates Sub-tab -->
            <div id="engineConfigInsightsSubtabOpenings" class="engineConfigInsightsSubtab" style="display: none;">
              <div class="panel" style="background: var(--panel);">
                <div class="panelHead">
                  <div class="left">
                    <span class="mini">Opening Templates (Read-Only)</span>
                  </div>
                  <div class="right">
                    <button id="engineConfigLoadOpeningsBtn" class="btn" style="font-size: 11px;">Load Templates</button>
                  </div>
                </div>
                <div class="body">
                  <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                      <tr style="border-bottom: 1px solid var(--line);">
                        <th style="padding: 8px; text-align: left;">Key</th>
                        <th style="padding: 8px; text-align: left;">Name</th>
                        <th style="padding: 8px; text-align: left;">Description</th>
                        <th style="padding: 8px; text-align: left;">Template</th>
                        <th style="padding: 8px; text-align: left;">Compatible Styles</th>
                        <th style="padding: 8px; text-align: left;">Actions</th>
                      </tr>
                    </thead>
                    <tbody id="engineConfigOpeningsTableBody"></tbody>
                  </table>
                  <div id="engineConfigOpeningDetail" style="display: none; margin-top: 20px; padding-top: 16px; border-top: 1px solid var(--line);">
                    <div class="field">
                      <label>Name</label>
                      <input id="engineConfigOpeningName" readonly style="background: rgba(255,255,255,0.05);" />
                    </div>
                    <div class="field">
                      <label>Description</label>
                      <textarea id="engineConfigOpeningDescription" readonly style="min-height: 60px; background: rgba(255,255,255,0.05);"></textarea>
                    </div>
                    <div class="field">
                      <label>Template</label>
                      <textarea id="engineConfigOpeningTemplate" readonly style="min-height: 80px; background: rgba(255,255,255,0.05); font-family: monospace;"></textarea>
                    </div>
                    <div class="field">
                      <label>Variables</label>
                      <input id="engineConfigOpeningVariables" readonly style="background: rgba(255,255,255,0.05);" />
                    </div>
                    <div class="field">
                      <label>Compatible Styles</label>
                      <input id="engineConfigOpeningCompatibleStyles" readonly style="background: rgba(255,255,255,0.05);" />
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Mission Attachments Tab -->
          <div id="engineConfigTabAttachments" class="engineConfigTabContent" style="display: none;">
            <div class="row" style="grid-template-columns: 400px 1fr;">
              <div class="panel" style="background: var(--panel);">
                <div class="panelHead">
                  <div class="left">
                    <span class="mini">Missions</span>
                  </div>
                  <div class="right">
                    <button id="engineConfigLoadAttachmentsBtn" class="btn" style="font-size: 11px;">Load</button>
                  </div>
                </div>
                <div class="listWrap">
                  <div style="margin-bottom: 8px;">
                    <select id="engineConfigAttachmentsCategoryFilter" style="width: 100%; background: var(--controlBg); border: 1px solid var(--controlBorder); border-radius: 6px; padding: 4px 8px; color: var(--text); margin-bottom: 8px;">
                      <option value="">All Categories</option>
                    </select>
                    <input type="text" id="engineConfigAttachmentsSearchInput" placeholder="Search missions..." style="width: 100%; background: var(--controlBg); border: 1px solid var(--controlBorder); border-radius: 6px; padding: 4px 8px; color: var(--text);" />
                  </div>
                  <div id="engineConfigAttachmentsMissionsList" class="list" style="max-height: 500px;"></div>
                </div>
              </div>
              <div class="panel" style="background: var(--panel);">
                <div class="panelHead">
                  <div class="left">
                    <span class="mini">Profile Attachments</span>
                  </div>
                </div>
                <div class="body">
                  <div id="engineConfigAttachmentsEditor" style="display: none;">
                    <div class="field">
                      <label>Mission</label>
                      <input id="engineConfigAttachmentsMissionLabel" readonly style="background: rgba(255,255,255,0.05);" />
                    </div>
                    <div class="field">
                      <label>Code</label>
                      <input id="engineConfigAttachmentsMissionCode" readonly style="background: rgba(255,255,255,0.05);" />
                    </div>
                    <div class="field">
                      <label>Category</label>
                      <input id="engineConfigAttachmentsMissionCategory" readonly style="background: rgba(255,255,255,0.05);" />
                    </div>
                    <div style="margin-top: 20px; padding-top: 16px; border-top: 1px solid var(--line);">
                      <div class="field">
                        <label>Scoring Profile</label>
                        <select id="engineConfigAttachmentsScoringProfile">
                          <option value="">(Inherit global default)</option>
                        </select>
                      </div>
                      <div class="field">
                        <label>Dynamics Profile</label>
                        <select id="engineConfigAttachmentsDynamicsProfile">
                          <option value="">(Inherit mission's own dynamics)</option>
                        </select>
                      </div>
                      <div style="margin-top: 16px; display: flex; gap: 8px;">
                        <button id="engineConfigAttachmentsSaveBtn" class="btn">Save</button>
                        <button id="engineConfigAttachmentsResetBtn" class="btn">Reset</button>
                      </div>
                    </div>
                  </div>
                  <div id="engineConfigAttachmentsEditorEmpty" style="text-align: center; padding: 40px; color: var(--muted);">
                    Select a mission to edit attachments
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Monitoring Tab -->
          <div id="engineConfigTabMonitoring" class="engineConfigTabContent" style="display: none;">
            <div class="panel" style="background: var(--panel);">
              <div class="panelHead">
                <div class="left">
                  <span class="mini">Monitoring & Stats</span>
                </div>
                <div class="right">
                  <button id="engineConfigRefreshMonitoringBtn" class="btn" style="font-size: 11px;">Refresh</button>
                </div>
              </div>
              <div class="body">
                <div style="margin-bottom: 24px;">
                  <label style="font-weight: 700;">Hook Trigger Stats (Last 7 Days)</label>
                  <div id="engineConfigMonitoringHooksStats" style="margin-top: 12px;"></div>
                </div>
                <div style="margin-bottom: 24px; padding-top: 16px; border-top: 1px solid var(--line);">
                  <label style="font-weight: 700;">Gate Outcome Stats</label>
                  <div id="engineConfigMonitoringGatesStats" style="margin-top: 12px; color: var(--muted); font-size: 12px;">
                    (Gate outcome stats coming soon)
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Micro Feedback Tab -->
          <div id="engineConfigTabMicroFeedback" class="engineConfigTabContent" style="display: none;">
            <div class="panel" style="background: var(--panel);">
              <div class="panelHead">
                <div class="left">
                  <span class="mini">Micro Feedback Configuration</span>
                </div>
              </div>
              <div class="body">
                <div class="field" style="margin-bottom: 16px;">
                  <label>Very Short Message (&lt;5 chars)</label>
                  <textarea id="engineConfigMicroFeedbackVeryShortMsg" style="min-height: 60px;"></textarea>
                </div>
                <div class="field" style="margin-bottom: 16px;">
                  <label>Default Message (fallback)</label>
                  <textarea id="engineConfigMicroFeedbackDefaultMsg" style="min-height: 60px;"></textarea>
                </div>
                <div style="margin-top: 20px; padding-top: 16px; border-top: 1px solid var(--line);">
                  <label style="font-weight: 700;">Feedback Bands</label>
                  <div id="engineConfigMicroFeedbackBandsList" style="margin-top: 12px;"></div>
                          <button id="engineConfigMicroFeedbackAddBandBtn2" class="btn" style="margin-top: 12px; font-size: 11px;">Add Band</button>
                </div>
              </div>
            </div>
          </div>

          <!-- Micro Dynamics Tab -->
          <div id="engineConfigTabMicroDynamics" class="engineConfigTabContent" style="display: none;">
            <div class="panel" style="background: var(--panel);">
              <div class="panelHead">
                <div class="left">
                  <span class="mini">Micro Dynamics Configuration</span>
                </div>
              </div>
              <div class="body">
                <div style="margin-bottom: 24px;">
                  <label style="font-weight: 700;">Risk Index</label>
                  <div class="split3" style="margin-top: 8px;">
                    <div class="field">
                      <label>Base Risk (Min)</label>
                      <input type="number" id="engineConfigMicroDynamicsRiskBaseMin" min="0" max="100" />
                    </div>
                    <div class="field">
                      <label>Base Risk (Max)</label>
                      <input type="number" id="engineConfigMicroDynamicsRiskBaseMax" min="0" max="100" />
                    </div>
                    <div class="field">
                      <label>Tension Penalty Threshold</label>
                      <input type="number" id="engineConfigMicroDynamicsRiskTensionThreshold" step="0.01" min="0" max="1" />
                    </div>
                    <div class="field">
                      <label>Tension Max Penalty</label>
                      <input type="number" id="engineConfigMicroDynamicsRiskTensionMaxPenalty" min="0" max="100" />
                    </div>
                    <div class="field">
                      <label>Difficulty: HARD</label>
                      <input type="number" id="engineConfigMicroDynamicsRiskDifficultyHard" min="-100" max="100" />
                    </div>
                    <div class="field">
                      <label>Difficulty: MEDIUM</label>
                      <input type="number" id="engineConfigMicroDynamicsRiskDifficultyMedium" min="-100" max="100" />
                    </div>
                    <div class="field">
                      <label>Progress: Early</label>
                      <input type="number" id="engineConfigMicroDynamicsRiskProgressEarly" min="-100" max="100" />
                    </div>
                    <div class="field">
                      <label>Progress: Late</label>
                      <input type="number" id="engineConfigMicroDynamicsRiskProgressLate" min="-100" max="100" />
                    </div>
                  </div>
                </div>
                <div style="margin-bottom: 24px; padding-top: 16px; border-top: 1px solid var(--line);">
                  <label style="font-weight: 700;">Momentum Index</label>
                  <div class="split3" style="margin-top: 8px;">
                    <div class="field">
                      <label>Score Delta Multiplier</label>
                      <input type="number" id="engineConfigMicroDynamicsMomentumScoreDelta" step="0.1" min="0" max="10" />
                    </div>
                    <div class="field">
                      <label>Gate Progress Multiplier</label>
                      <input type="number" id="engineConfigMicroDynamicsMomentumGateProgress" step="0.1" min="0" max="10" />
                    </div>
                    <div class="field">
                      <label>Mood Bonus: Positive</label>
                      <input type="number" id="engineConfigMicroDynamicsMomentumMoodPositive" min="-100" max="100" />
                    </div>
                    <div class="field">
                      <label>Mood Bonus: Negative</label>
                      <input type="number" id="engineConfigMicroDynamicsMomentumMoodNegative" min="-100" max="100" />
                    </div>
                    <div class="field">
                      <label>Trend Multiplier</label>
                      <input type="number" id="engineConfigMicroDynamicsMomentumTrend" step="0.1" min="0" max="10" />
                    </div>
                  </div>
                </div>
                <div style="margin-bottom: 24px; padding-top: 16px; border-top: 1px solid var(--line);">
                  <label style="font-weight: 700;">Flow Index</label>
                  <div class="field" style="margin-top: 8px;">
                    <label>Variance to Flow Multiplier</label>
                    <input type="number" id="engineConfigMicroDynamicsFlowVariance" step="0.1" min="0" max="10" />
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Persona Drift Tab -->
          <div id="engineConfigTabPersona" class="engineConfigTabContent" style="display: none;">
            <div class="panel" style="background: var(--panel);">
              <div class="panelHead">
                <div class="left">
                  <span class="mini">Persona Drift Configuration</span>
                </div>
              </div>
              <div class="body">
                <div style="margin-bottom: 24px;">
                  <label style="font-weight: 700;">Drift Penalties</label>
                  <div class="split3" style="margin-top: 8px;">
                    <div class="field">
                      <label>Style Mood Conflict</label>
                      <input type="number" id="engineConfigPersonaDriftStyleMoodConflict" min="-100" max="0" />
                    </div>
                    <div class="field">
                      <label>Style Mood Conflict (Minor)</label>
                      <input type="number" id="engineConfigPersonaDriftStyleMoodConflictMinor" min="-100" max="0" />
                    </div>
                    <div class="field">
                      <label>Dynamics Mood Conflict</label>
                      <input type="number" id="engineConfigPersonaDriftDynamicsMoodConflict" min="-100" max="0" />
                    </div>
                    <div class="field">
                      <label>Vulnerability Mood Conflict</label>
                      <input type="number" id="engineConfigPersonaDriftVulnerabilityMoodConflict" min="-100" max="0" />
                    </div>
                    <div class="field">
                      <label>Score Style Conflict</label>
                      <input type="number" id="engineConfigPersonaDriftScoreStyleConflict" min="-100" max="0" />
                    </div>
                    <div class="field">
                      <label>Negative Flags Conflict</label>
                      <input type="number" id="engineConfigPersonaDriftNegativeFlagsConflict" min="-100" max="0" />
                    </div>
                  </div>
                </div>
                <div style="margin-bottom: 24px; padding-top: 16px; border-top: 1px solid var(--line);">
                  <label style="font-weight: 700;">Modifier Event Thresholds</label>
                  <div class="split3" style="margin-top: 8px;">
                    <div class="field">
                      <label>Tension Spike Threshold</label>
                      <input type="number" id="engineConfigPersonaModifierTensionSpike" step="0.01" min="0" max="1" />
                    </div>
                    <div class="field">
                      <label>Mood Drop: Low</label>
                      <input type="number" id="engineConfigPersonaModifierMoodDropLow" step="0.01" min="0" max="1" />
                    </div>
                    <div class="field">
                      <label>Mood Drop: High</label>
                      <input type="number" id="engineConfigPersonaModifierMoodDropHigh" step="0.01" min="0" max="1" />
                    </div>
                    <div class="field">
                      <label>Score Collapse Threshold</label>
                      <input type="number" id="engineConfigPersonaModifierScoreCollapse" min="0" max="100" />
                    </div>
                    <div class="field">
                      <label>Score Collapse Divisor</label>
                      <input type="number" id="engineConfigPersonaModifierScoreCollapseDivisor" min="1" max="100" />
                    </div>
                    <div class="field">
                      <label>Negative Flags Threshold</label>
                      <input type="number" id="engineConfigPersonaModifierNegativeFlags" min="0" max="10" />
                    </div>
                    <div class="field">
                      <label>Negative Flags Divisor</label>
                      <input type="number" id="engineConfigPersonaModifierNegativeFlagsDivisor" min="1" max="10" />
                    </div>
                  </div>
                </div>
                <div style="margin-bottom: 24px; padding-top: 16px; border-top: 1px solid var(--line);">
                  <label style="font-weight: 700;">Modifier Effects</label>
                  <div class="split3" style="margin-top: 8px;">
                    <div class="field">
                      <label>Reduce Risk Amount</label>
                      <input type="number" id="engineConfigPersonaModifierEffectReduceRisk" min="-100" max="0" />
                    </div>
                    <div class="field">
                      <label>Lower Warmth Amount</label>
                      <input type="number" id="engineConfigPersonaModifierEffectLowerWarmth" min="-100" max="0" />
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- AI Styles Admin Section -->
      <div class="panel" style="margin-top: 14px;">
        <div class="panelHead">
          <div class="left">
            <h2 style="margin: 0; font-size: 16px; font-weight: 800;">AI Styles Admin</h2>
            <span class="mini" style="margin-left: 12px;">Manage AI Styles</span>
          </div>
          <div class="right">
            <button id="aiStylesLoadBtn" class="btn">Load Styles</button>
            <button id="aiStylesAddBtn" class="btn">Add Style</button>
          </div>
        </div>
        <div class="body" style="padding: 16px;">
          <table style="width: 100%; border-collapse: collapse;">
            <thead>
              <tr style="border-bottom: 1px solid var(--line);">
                <th style="padding: 8px; text-align: left;">Key</th>
                <th style="padding: 8px; text-align: left;">Name</th>
                <th style="padding: 8px; text-align: left;">Active</th>
                <th style="padding: 8px; text-align: left;">Actions</th>
              </tr>
            </thead>
            <tbody id="aiStylesTableBody"></tbody>
          </table>
          <div id="aiStylesEditor" style="display: none; margin-top: 20px; padding-top: 16px; border-top: 1px solid var(--line);">
            <div class="field">
              <label>Key</label>
              <input id="aiStylesEditorKey" />
            </div>
            <div class="field">
              <label>Name</label>
              <input id="aiStylesEditorName" />
            </div>
            <div class="field">
              <label>Description</label>
              <textarea id="aiStylesEditorDescription" style="min-height: 60px;"></textarea>
            </div>
            <div class="field">
              <label>Style Prompt</label>
              <textarea id="aiStylesEditorStylePrompt" style="min-height: 100px;"></textarea>
            </div>
            <div class="field">
              <label>Forbidden Behavior</label>
              <textarea id="aiStylesEditorForbiddenBehavior" style="min-height: 60px;"></textarea>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
              <div class="field">
                <label>Max Chars</label>
                <input type="number" id="aiStylesEditorMaxChars" min="0" max="10000" />
              </div>
              <div class="field">
                <label>Max Lines</label>
                <input type="number" id="aiStylesEditorMaxLines" min="0" max="100" />
              </div>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
              <div class="field">
                <label>Question Rate (0-100)</label>
                <input type="number" id="aiStylesEditorQuestionRate" min="0" max="100" />
              </div>
              <div class="field">
                <label>Emoji Rate (0-100)</label>
                <input type="number" id="aiStylesEditorEmojiRate" min="0" max="100" />
              </div>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
              <div class="field">
                <label>Initiative (0-100)</label>
                <input type="number" id="aiStylesEditorInitiative" min="0" max="100" />
              </div>
              <div class="field">
                <label>Warmth (0-100)</label>
                <input type="number" id="aiStylesEditorWarmth" min="0" max="100" />
              </div>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
              <div class="field">
                <label>Judgment (0-100)</label>
                <input type="number" id="aiStylesEditorJudgment" min="0" max="100" />
              </div>
              <div class="field">
                <label>Flirt Tension (0-100)</label>
                <input type="number" id="aiStylesEditorFlirtTension" min="0" max="100" />
              </div>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
              <div class="field">
                <label>Formality (0-100)</label>
                <input type="number" id="aiStylesEditorFormality" min="0" max="100" />
              </div>
              <div class="field">
                <label>Temperature (0-2, optional)</label>
                <input type="number" id="aiStylesEditorTemperature" min="0" max="2" step="0.1" />
              </div>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
              <div class="field">
                <label>Top P (0-1, optional)</label>
                <input type="number" id="aiStylesEditorTopP" min="0" max="1" step="0.01" />
              </div>
              <div class="field">
                <label>Few Shot Examples (JSON, optional)</label>
                <textarea id="aiStylesEditorFewShotExamples" style="min-height: 80px; font-family: monospace;" placeholder='{"example1": "..."}'></textarea>
              </div>
            </div>
            <div class="field">
              <label><input type="checkbox" id="aiStylesEditorActive" checked /> Active</label>
            </div>
            <div style="margin-top: 16px; display: flex; gap: 8px;">
              <button id="aiStylesSaveBtn" class="btn">Save</button>
              <button id="aiStylesCancelBtn" class="btn">Cancel</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Personas Admin Section -->
      <div class="panel" style="margin-top: 14px;">
        <div class="panelHead">
          <div class="left">
            <h2 style="margin: 0; font-size: 16px; font-weight: 800;">Personas Admin</h2>
            <span class="mini" style="margin-left: 12px;">Manage Personas</span>
          </div>
          <div class="right">
            <button id="personasLoadBtn" class="btn">Load Personas</button>
            <button id="personasAddBtn" class="btn">Add Persona</button>
          </div>
        </div>
        <div class="body" style="padding: 16px;">
          <table style="width: 100%; border-collapse: collapse;">
            <thead>
              <tr style="border-bottom: 1px solid var(--line);">
                <th style="padding: 8px; text-align: left;">Code</th>
                <th style="padding: 8px; text-align: left;">Name</th>
                <th style="padding: 8px; text-align: left;">Active</th>
                <th style="padding: 8px; text-align: left;">Actions</th>
              </tr>
            </thead>
            <tbody id="personasTableBody"></tbody>
          </table>
          <div id="personasEditor" style="display: none; margin-top: 20px; padding-top: 16px; border-top: 1px solid var(--line);">
            <div class="field">
              <label>Code</label>
              <input id="personasEditorCode" />
            </div>
            <div class="field">
              <label>Name</label>
              <input id="personasEditorName" />
            </div>
            <div class="field">
              <label>Description</label>
              <textarea id="personasEditorDescription" style="min-height: 60px;"></textarea>
            </div>
            <div class="field">
              <label>Avatar URL</label>
              <input id="personasEditorAvatarUrl" />
            </div>
            <div class="field">
              <label><input type="checkbox" id="personasEditorActive" checked /> Active</label>
            </div>
            <div style="margin-top: 16px; display: flex; gap: 8px;">
              <button id="personasSaveBtn" class="btn">Save</button>
              <button id="personasCancelBtn" class="btn">Cancel</button>
            </div>
          </div>
        </div>
      </div>

      <div class="panel footerLog">
        <div class="panelHead">
          <div class="left">
            <span class="mini">Log</span>
            <button id="clearLogBtn" class="btn">Clear Log</button>
          </div>
          <div class="right">
            <span class="mini"
              >Tip: open DevTools Console too — but this log makes sure you'll
              see errors even if JS breaks.</span
            >
          </div>
        </div>
        <div id="logArea" class="logArea"></div>
      </div>
    </div>

    <script>
      (function () {
        // Ultra-early breadcrumb: proves script executes
        console.log("[DevDashboard] SCRIPT_LOADED", { href: location.href, origin: location.origin });
        
        // ---------------------------
        // v2 State
        // ---------------------------
        const v2State = {
          currentMode: 'engine-map', // 'engine-map' | 'practice-hub'
          selectedNode: null,
          selectedMission: null,
          selectedCategory: null,
          engineConfig: null,
          categories: [],
          missions: [],
          personas: [],
          aiStyles: [],
        };

        // ---------------------------
        // Config & state (single script, single ui object)
        // ---------------------------
        const STORAGE_KEYS = {
          apiBase: "sg_dev_api_base",
          jwt: "sg_dev_jwt",
        };

        const state = {
          metaLoaded: false,
          missionsLoaded: false,
          categories: [],
          personas: [],
          aiStyles: [],
          missions: [],
          selectedMissionId: null,

          // Backend DTO expects aiStyleKey (never aiStyleId)
          aiStyleSendField: "aiStyleKey",
          aiStyleTouched: false,
        };

        // Boot guard: prevent double-boot
        let booted = false;

        const ui = {
          // Header controls
          pingApiBtn: document.getElementById("pingApiBtn"),
          loadMetaBtn: document.getElementById("loadMetaBtn"),
          loadMissionsBtn: document.getElementById("loadMissionsBtn"),
          loadEverythingBtn: document.getElementById("loadEverythingBtn"),
          apiBaseInput: document.getElementById("apiBaseInput"),
          jwtInput: document.getElementById("jwtInput"),
          saveSettingsBtn: document.getElementById("saveSettingsBtn"),
          
          // Login elements
          loginEmailInput: document.getElementById("loginEmailInput"),
          loginPasswordInput: document.getElementById("loginPasswordInput"),

          // Status chips
          apiStatusChip: document.getElementById("apiStatusChip"),
          metaStatusChip: document.getElementById("metaStatusChip"),
          missionsStatusChip: document.getElementById("missionsStatusChip"),

          // Alerts
          errorBox: document.getElementById("errorBox"),
          okBox: document.getElementById("okBox"),

          // List
          missionsList: document.getElementById("missionsList"),
          searchInput: document.getElementById("searchInput"),
          clearSearchBtn: document.getElementById("clearSearchBtn"),
          newMissionBtn: document.getElementById("newMissionBtn"),
          duplicateMissionBtn: document.getElementById("duplicateMissionBtn"),
          deleteMissionBtn: document.getElementById("deleteMissionBtn"),
          selectedChip: document.getElementById("selectedChip"),

          // Editor fields
          saveMissionBtn: document.getElementById("saveMissionBtn"),
          clearFormBtn: document.getElementById("clearFormBtn"),
          missionTitleInput: document.getElementById("missionTitleInput"),
          missionDescriptionInput: document.getElementById("missionDescriptionInput"),
          difficultySelect: document.getElementById("difficultySelect"),
          missionGoalTypeSelect: document.getElementById("missionGoalTypeSelect"),
          categorySelect: document.getElementById("categorySelect"),
          personaSelect: document.getElementById("personaSelect"),
          activeSelect: document.getElementById("activeSelect"),
          codeInput: document.getElementById("codeInput"),
          missionTimeLimitInput: document.getElementById("missionTimeLimitInput"),
          missionMaxMessagesInput: document.getElementById("missionMaxMessagesInput"),
          missionWordLimitInput: document.getElementById("missionWordLimitInput"),
          laneIndexInput: document.getElementById("laneIndexInput"),
          orderIndexInput: document.getElementById("orderIndexInput"),
          aiStyleSelect: document.getElementById("aiStyleSelect"),

          // Contract
          aiContractJsonTextarea: document.getElementById("aiContractJsonTextarea"),
          validateAiContractBtn: document.getElementById("validateAiContractBtn"),
          formatAiContractBtn: document.getElementById("formatAiContractBtn"),
          pasteSampleBtn: document.getElementById("pasteSampleBtn"),
          contractErrorBox: document.getElementById("contractErrorBox"),

          // Phase 3: Builder UI
          builderTypeSelect: document.getElementById("builderTypeSelect"),
          builderParamsSection: document.getElementById("builderParamsSection"),
          builderUserTitleInput: document.getElementById("builderUserTitleInput"),
          builderUserDescriptionInput: document.getElementById("builderUserDescriptionInput"),
          builderDifficultySelect: document.getElementById("builderDifficultySelect"),
          builderAiStyleKeyInput: document.getElementById("builderAiStyleKeyInput"),
          builderObjectiveKindField: document.getElementById("builderObjectiveKindField"),
          builderObjectiveKindSelect: document.getElementById("builderObjectiveKindSelect"),
          builderMaxMessagesInput: document.getElementById("builderMaxMessagesInput"),
          builderTimeLimitSecInput: document.getElementById("builderTimeLimitSecInput"),
          builderWordLimitInput: document.getElementById("builderWordLimitInput"),
          generateConfigBtn: document.getElementById("generateConfigBtn"),
          validateConfigBtn: document.getElementById("validateConfigBtn"),

          contractValidityChip: document.getElementById("contractValidityChip"),
          previewChip: document.getElementById("previewChip"),

          // Validation errors
          missionValidationErrors: document.getElementById("missionValidationErrors"),
          missionValidationErrorsList: document.getElementById("missionValidationErrorsList"),

          // Log
          logArea: document.getElementById("logArea"),
          clearLogBtn: document.getElementById("clearLogBtn"),
        };

        // ---------------------------
        // Utilities
        // ---------------------------
        function now() {
          const d = new Date();
          return d.toISOString().replace("T", " ").slice(0, 19);
        }

        function log(msg, obj) {
          const line =
            `[${now()}] ${msg}` + (obj ? `\n${safeStringify(obj)}` : "");
          // Always log to console
          console.log("[DevDashboard]", msg, obj || "");
          // Log to UI if available
          if (ui.logArea) {
            try {
              ui.logArea.textContent = (line + "\n\n" + ui.logArea.textContent).trim();
            } catch (e) {
              console.error("Failed to write to log area:", e);
            }
          }
        }
        
        // Early verification log (after log function is defined)
        log("[DevDashboard] SCRIPT_LOADED");

        function showError(msg) {
          console.error("[DevDashboard ERROR]", msg);
          log("ERROR: " + msg);
          if (ui.errorBox) {
            ui.errorBox.style.display = "block";
            ui.errorBox.textContent = msg;
          }
        }

        function clearError() {
          if (ui.errorBox) {
            ui.errorBox.style.display = "none";
            ui.errorBox.textContent = "";
          }
        }

        function showOk(msg) {
          console.log("[DevDashboard OK]", msg);
          log("OK: " + msg);
          if (ui.okBox) {
            ui.okBox.style.display = "block";
            ui.okBox.textContent = msg;
            setTimeout(() => {
              if (ui.okBox) ui.okBox.style.display = "none";
            }, 2500);
          }
        }

        function setChip(el, text, kind) {
          if (!el) {
            console.warn("setChip called with null element:", text);
            return;
          }
          el.textContent = text;
          el.classList.remove("ok", "warn", "bad");
          if (kind) el.classList.add(kind);
        }

        function safeStringify(obj) {
          try {
            return JSON.stringify(obj, null, 2);
          } catch {
            return String(obj);
          }
        }

        function getApiBase() {
          const raw = (ui.apiBaseInput.value || "").trim();
          return raw ? raw.replace(/\/+$/, "") : "";
        }

        function getJwt() {
          return (ui.jwtInput.value || "").trim();
        }

        // Wave 1.4: Robust URL builder - prevents /v1/v1 in all cases
        function buildUrl(path) {
          const base = getApiBase() || "";
          const prefix = "/v1";
          
          // Normalize path to start with /
          if (!path.startsWith("/")) path = "/" + path;
          
          // Normalize base - remove trailing /v1 if present
          let normalizedBase = base;
          if (normalizedBase.endsWith("/v1")) {
            normalizedBase = normalizedBase.slice(0, -3);
          }
          // Remove trailing slash from base
          if (normalizedBase.endsWith("/")) {
            normalizedBase = normalizedBase.slice(0, -1);
          }
          
          // If path already starts with /v1, use it as-is
          if (path.startsWith(prefix)) {
            return normalizedBase + path;
          }
          
          // Otherwise, prepend /v1
          return normalizedBase + prefix + path;
        }

        // Wave 1.2: Endpoint tracking
        window.__endpointsUsedRaw = new Set();
        window.__endpointsUsedBuilt = new Set();
        
        window.__printEndpoints = function() {
          log("=== ENDPOINT TRACKING ===");
          log("Raw paths (as passed to apiFetch):");
          Array.from(window.__endpointsUsedRaw).sort().forEach(path => {
            log(`  ${path}`);
          });
          log("Built URLs (after buildUrl):");
          Array.from(window.__endpointsUsedBuilt).sort().forEach(url => {
            log(`  ${url}`);
          });
          log("=== ENDPOINT TRACKING END ===");
        };

        async function apiFetch(path, options = {}) {
          clearError();
          const url = buildUrl(path);
          
          // Step 1: Enforce JWT for all admin endpoints
          const pathname = new URL(url, window.location.origin).pathname;
          if (pathname.startsWith('/v1/admin/')) {
            requireJWT(); // Throws if JWT missing
          }
          
          // Wave 1.2: Track endpoints
          window.__endpointsUsedRaw.add(path);
          window.__endpointsUsedBuilt.add(url);
          
          const headers = Object.assign(
            { "Content-Type": "application/json" },
            options.headers || {}
          );

          const jwt = getJwt();
          if (jwt) headers["Authorization"] = `Bearer ${jwt}`;

          log(`FETCH ${options.method || "GET"} ${url}`);

          let res;
          try {
            res = await fetch(url, { ...options, headers });
          } catch (e) {
            showError(`Network error calling ${url}: ${formatErrorForDisplay(e)}`);
            throw e;
          }

          const text = await res.text();
          let json = null;
          if (text) {
            try {
              json = JSON.parse(text);
            } catch {
              // leave as raw text
            }
          }

          if (!res.ok) {
            const msg = `HTTP ${res.status} ${res.statusText} from ${url}\n${text || ""}`;
            // Wave 1: Log error to dashboard log
            log(`FETCH FAILED: ${options.method || "GET"} ${url} - ${res.status} ${res.statusText}`);
            if (text && text.length < 500) {
              log(`Response body: ${text}`);
            }
            // Patch A: Always show visible UI error for HTTP failures
            const errorMsg = res.status === 401 
              ? "Token expired or invalid. Please login again."
              : json?.message || text || `HTTP ${res.status} ${res.statusText}`;
            showError(errorMsg);
            if (res.status === 401) {
              // Clear JWT on 401
              const jwtInput = document.getElementById("jwtInput");
              if (jwtInput) jwtInput.value = "";
            }
            const error = new Error(msg);
            // Attach parsed JSON if available for structured error handling
            if (json) {
              error.responseJson = json;
            } else if (text) {
              error.responseText = text;
            }
            throw error;
          }

          log(`FETCH OK: ${options.method || "GET"} ${url} - ${res.status}`);
          return json ?? text;
        }

        // Wave 1.2: Button Contract Helpers with Registry and Binding Markers
        const buttonRegistry = new Map(); // Track wired buttons: id -> label
        window.__boundButtons = new Map(); // Track bound buttons: id -> {id, label, ok}
        
        function bindBtn(id, handler, label) {
          const btn = typeof id === 'string' ? document.getElementById(id) : id;
          const btnId = typeof id === 'string' ? id : (btn ? (btn.id || `unnamed-${Date.now()}`) : id);
          const btnLabel = label || btnId;
          
          if (!btn) {
            log(`WARNING: Button not found: ${btnLabel}`);
            window.__boundButtons.set(btnId, { id: btnId, label: btnLabel, ok: false });
            return;
          }
          
          log(`[DevDashboard] BIND ${btnId}`);
          // Wave 1.2: Mark element as bound
          btn.dataset.bound = "1";
          buttonRegistry.set(btnId, btnLabel);
          window.__boundButtons.set(btnId, { id: btnId, label: btnLabel, ok: true });
          
          btn.addEventListener("click", async () => {
            log(`CLICK: ${btnLabel}`);
            try {
              await handler();
            } catch (e) {
              const errorMsg = e?.message || String(e);
              log(`CLICK FAILED: ${btnLabel}: ${errorMsg}`);
              showError(`CLICK FAILED: ${btnLabel}: ${errorMsg}`);
            }
          });
        }
        
        // Wave 1.3: Required-list Button Audit Function (Truthful & Stable)
        window.__auditButtons = function() {
          log("=== BUTTON AUDIT START (Required List) ===");
          
          // Critical button IDs to audit (stable, no Date.now IDs)
          const criticalButtons = [
            "engineConfigLoadAttachmentsBtn",
            "engineConfigMicroFeedbackAddBandBtn",
            "engineConfigMicroFeedbackAddBandBtn2",
            "engineConfigLoadInsightsBtn",
            "engineConfigLoadOpeningsBtn",
            "aiStylesLoadBtn",
            "personasLoadBtn",
          ];
          
          const missingElements = [];
          const unbound = [];
          let okCount = 0;
          
          criticalButtons.forEach(btnId => {
            const btn = document.getElementById(btnId);
            if (!btn) {
              missingElements.push(btnId);
              log(`MISSING ELEMENT: ${btnId}`);
            } else {
              // Wave 1.3: Consider button OK if ANY of:
              // 1. dataset.bound === "1"
              // 2. has onclick attribute
              // 3. registered in window.__boundButtons
              const isBound = btn.dataset.bound === "1";
              const hasOnclick = btn.onclick !== null || btn.getAttribute("onclick");
              const isRegistered = window.__boundButtons && window.__boundButtons.has(btnId) && window.__boundButtons.get(btnId).ok;
              
              if (isBound || hasOnclick || isRegistered) {
                okCount++;
                log(`OK: ${btnId}`);
              } else {
                unbound.push(btnId);
                log(`UNBOUND: ${btnId} (no dataset.bound, no onclick, not registered)`);
              }
            }
          });
          
          const total = criticalButtons.length;
          log(`=== BUTTON AUDIT END: ${okCount}/${total} OK, ${missingElements.length} missing, ${unbound.length} unbound ===`);
          return { missingElements, unbound, okCount, total };
        };

        function requireJWT() {
          const jwt = getJwt();
          if (!jwt || jwt.trim() === '') {
            showError("JWT token is required. Please enter a JWT token in the settings.");
            throw new Error("JWT token required");
          }
          return jwt;
        }

        function normalizeMeta(resp) {
          const root = resp && typeof resp === "object" ? resp : {};
          const data = root.data && typeof root.data === "object" ? root.data : root;

          const categories =
            data.categories ||
            data.missionCategories ||
            data.categoryList ||
            [];
          const personas = data.personas || data.aiPersonas || data.personaList || [];

          // Optional: meta may include ai styles too
          const aiStyles = data.aiStyles || data.styles || data.aiStyleList || [];

          return {
            categories: Array.isArray(categories) ? categories : [],
            personas: Array.isArray(personas) ? personas : [],
            aiStyles: Array.isArray(aiStyles) ? aiStyles : [],
          };
        }

        function normalizeAiStyles(resp) {
          const root = resp && typeof resp === "object" ? resp : {};
          const data = root.data && typeof root.data === "object" ? root.data : root;

          const list =
            data.aiStyles ||
            data.styles ||
            data.items ||
            (Array.isArray(data) ? data : null) ||
            (Array.isArray(root) ? root : null) ||
            [];
          const arr = Array.isArray(list) ? list : [];

          // normalize shapes
          return arr
            .map((s) => {
              if (!s) return null;
              if (typeof s === "string") {
                return { id: null, key: s, name: s, isActive: true };
              }
              const id = s.id ?? null;
              const key = s.key ?? s.code ?? s.slug ?? s.name ?? null;
              const name = s.name ?? s.title ?? key ?? "(unnamed)";
              const isActive = s.isActive ?? s.active ?? true;
              return { id, key, name, isActive };
            })
            .filter(Boolean);
        }

        function normalizeMissions(resp) {
          const root = resp && typeof resp === "object" ? resp : {};
          const data = root.data && typeof root.data === "object" ? root.data : root;

          const list =
            data.missions ||
            data.items ||
            (Array.isArray(data) ? data : null) ||
            [];
          return Array.isArray(list) ? list : [];
        }

        // ---------------------------
        // AI Contract helpers
        // ---------------------------
        function getAiContractJsonOrNull() {
          const raw = (ui.aiContractJsonTextarea.value || "").trim();
          if (!raw) return null;

          try {
            const obj = JSON.parse(raw);
            if (!obj || typeof obj !== "object") {
              return { ok: false, error: "AI Contract must be a JSON object (not array/string)." };
            }
            return { ok: true, value: obj };
          } catch (e) {
            return { ok: false, error: "Invalid JSON: " + (e?.message || e) };
          }
        }

        function setAiContractTextarea(contract) {
          if (!contract) {
            ui.aiContractJsonTextarea.value = "";
            updateContractValidity();
            return;
          }
          try {
            const obj =
              typeof contract === "string" ? JSON.parse(contract) : contract;
            
            // If wrapped format { missionConfigV1: {...} }, extract the inner config
            // Otherwise, assume it's already raw MissionConfigV1
            const configToDisplay = obj.missionConfigV1 || obj;
            
            ui.aiContractJsonTextarea.value = JSON.stringify(configToDisplay, null, 2);
          } catch {
            ui.aiContractJsonTextarea.value =
              typeof contract === "string" ? contract : safeStringify(contract);
          }
          updateContractValidity();
        }

        function validateAiContractJson() {
          const parsed = getAiContractJsonOrNull();
          ui.contractErrorBox.style.display = "none";
          ui.contractErrorBox.textContent = "";

          if (!parsed) {
            setChip(ui.contractValidityChip, "AI Contract: empty", "warn");
            showError("AI Contract is empty.");
            return false;
          }

          if (!parsed.ok) {
            setChip(ui.contractValidityChip, "AI Contract: invalid", "bad");
            ui.contractErrorBox.style.display = "block";
            ui.contractErrorBox.textContent = parsed.error;
            return false;
          }

          setChip(ui.contractValidityChip, "AI Contract: valid", "ok");
          return true;
        }

        function formatAiContractJson() {
          const parsed = getAiContractJsonOrNull();
          if (!parsed || !parsed.ok) {
            validateAiContractJson();
            return;
          }
          ui.aiContractJsonTextarea.value = JSON.stringify(parsed.value, null, 2);
          setChip(ui.contractValidityChip, "AI Contract: valid", "ok");
          ui.contractErrorBox.style.display = "none";
          ui.contractErrorBox.textContent = "";
        }

        function updateContractValidity() {
          const raw = (ui.aiContractJsonTextarea.value || "").trim();
          if (!raw) {
            setChip(ui.contractValidityChip, "AI Contract: empty", "warn");
            return;
          }
          const parsed = getAiContractJsonOrNull();
          if (parsed && parsed.ok) setChip(ui.contractValidityChip, "AI Contract: valid", "ok");
          else setChip(ui.contractValidityChip, "AI Contract: invalid", "bad");
        }

        function pasteSampleContract() {
          const sample = {
            version: "ai-contract/v1",
            language: "en",
            personaStyle: {
              name: "Rotem",
              oneLine: "Sharp, playful, warm when impressed. Not easy to win.",
              voice: { tone: ["playful", "sharp"], pace: "short_messages", emoji: "rare" },
              context: { setting: "Instagram DM", relationship: "strangers" }
            },
            systemPrompt: "Stay in character. Never mention rules. Keep replies natural and brief.",
            requiredMoves: [
              "Ask 1 good question every 2-4 messages",
              "Confidence without begging",
              "Light playful tease at least once",
              "Propose a next step by the end"
            ],
            bannedMoves: [
              "Sexual content or explicit talk",
              "Needy validation seeking",
              "Long paragraphs (>3 lines)",
              "Overcomplimenting / pedestalizing"
            ],
            successCriteria: {
              definition: "She stays engaged and agrees to continue or hints availability.",
              mustHaveSignals: [
                "She asks at least 1 follow-up question OR gives a warm response",
                "You suggest a clear next step"
              ]
            },
            gradingHints: {
              scoreScale: "0-100",
              hardFailIf: ["Sexual content", "Begging / chasing"]
            }
          };
          ui.aiContractJsonTextarea.value = JSON.stringify(sample, null, 2);
          updateContractValidity();
          showOk("Sample contract pasted.");
        }

        // ---------------------------
        // AiStyles helpers
        // ---------------------------
        function findStyleById(id) {
          return (state.aiStyles || []).find((s) => s && s.id === id) || null;
        }

        function findStyleByKey(key) {
          if (!key) return null;
          const kk = String(key).trim().toUpperCase();
          return (state.aiStyles || []).find((s) => String(s.key || "").trim().toUpperCase() === kk) || null;
        }

        function getSelectedStyle() {
          const val = ui.aiStyleSelect.value || "";
          if (!val) return null;
          // options use style.key as value
          return findStyleByKey(val);
        }

        function getMissionStyleKey(m) {
          if (!m) return "";
          // possible shapes
          if (typeof m.aiStyle === "string") return m.aiStyle;
          if (m.aiStyleKey) return m.aiStyleKey;
          if (m.aiStyle && typeof m.aiStyle === "object") return m.aiStyle.key || m.aiStyle.name || "";
          if (m.aiStyleId) {
            const s = findStyleById(m.aiStyleId);
            return s?.key || "";
          }
          return "";
        }

        function getMissionStyleId(m) {
          if (!m) return "";
          if (m.aiStyleId) return m.aiStyleId;
          if (m.aiStyle && typeof m.aiStyle === "object" && m.aiStyle.id) return m.aiStyle.id;
          // if backend returns a string key, map to id if possible
          const key = getMissionStyleKey(m);
          const s = findStyleByKey(key);
          return s?.id || "";
        }

        function detectAiStyleSendFieldFromMissions(missions) {
          for (const m of missions || []) {
            if (!m) continue;
            if (m.aiStyleId) return "aiStyleId";
            if (m.aiStyle && typeof m.aiStyle === "object" && m.aiStyle.id) return "aiStyleId";
            if (m.aiStyleKey) return "aiStyleKey";
            if (typeof m.aiStyle === "string") return "aiStyle";
          }
          return null;
        }

        // ---------------------------
        // Mission form helpers
        // ---------------------------
        function clearMissionForm() {
          state.selectedMissionId = null;
          state.aiStyleTouched = false;
          ui.missionTitleInput.value = "";
          ui.missionDescriptionInput.value = "";
          ui.difficultySelect.value = "EASY";
          ui.missionGoalTypeSelect.value = "";
          ui.categorySelect.value = "";
          ui.personaSelect.value = "";
          ui.activeSelect.value = "true";
          ui.codeInput.value = "";
          ui.missionTimeLimitInput.value = "";
          ui.missionMaxMessagesInput.value = "";
          ui.missionWordLimitInput.value = "";
          ui.laneIndexInput.value = "";
          ui.orderIndexInput.value = "";
          ui.aiStyleSelect.value = "";
          setAiContractTextarea(null);
          
          // Clear validation errors
          if (ui.missionValidationErrors) {
            ui.missionValidationErrors.style.display = "none";
            if (ui.missionValidationErrorsList) {
              ui.missionValidationErrorsList.innerHTML = "";
            }
          }
          
          // Practice Hub Designer: Clear attraction fields
          hubUI.missionIsAttractionSensitiveCheckbox.checked = false;
          hubUI.missionTargetRomanticGenderSelect.value = "";
          hubUI.missionTargetGenderField.style.display = "none";
          
          // Step 7: Hide mission monitor
          const monitorSection = document.getElementById("missionMonitorSection");
          if (monitorSection) {
            monitorSection.style.display = "none";
          }

          updateSelectionUI();
          updateMissionPreview();
          log("Form cleared.");
        }

        function getMissionFormValues() {
          const name = (ui.missionTitleInput.value || "").trim();
          const description = (ui.missionDescriptionInput.value || "").trim() || null;
          const difficulty = ui.difficultySelect.value;
          const goalType = ui.missionGoalTypeSelect.value || null;
          const categoryId = ui.categorySelect.value || null;
          const personaId = ui.personaSelect.value || null;
          const active = ui.activeSelect.value === "true";
          const code = (ui.codeInput.value || "").trim() || null;
          
          // Phase 2: Parse numeric fields with proper validation (empty → null, invalid → block save)
          // Helper: Parse numeric field with validation
          const parseNumericField = (inputValue, fieldName, minValue, allowNull) => {
            const val = (inputValue || "").trim();
            if (!val) {
              return { ok: true, value: null };
            }
            const num = parseInt(val, 10);
            if (!Number.isFinite(num)) {
              return { ok: false, error: `${fieldName} must be a valid number` };
            }
            if (num < minValue) {
              return { ok: false, error: `${fieldName} must be >= ${minValue}` };
            }
            return { ok: true, value: num };
          };

          const timeLimitSecResult = parseNumericField(ui.missionTimeLimitInput.value, "Time Limit", 0, true);
          const maxMessagesResult = parseNumericField(ui.missionMaxMessagesInput.value, "Max Messages", 1, true);
          const wordLimitResult = parseNumericField(ui.missionWordLimitInput.value, "Word Limit", 1, true);
          const laneIndexResult = parseNumericField(ui.laneIndexInput.value, "Lane Index", 0, true);
          const orderIndexResult = parseNumericField(ui.orderIndexInput.value, "Order Index", 0, true);

          // Block save if any numeric field is invalid
          const numericErrors = [
            timeLimitSecResult,
            maxMessagesResult,
            wordLimitResult,
            laneIndexResult,
            orderIndexResult
          ].filter(r => !r.ok);

          if (numericErrors.length > 0) {
            const errorMessages = numericErrors.map(r => r.error).join("; ");
            showError(`Invalid numeric fields: ${errorMessages}`);
            return { ok: false, error: errorMessages };
          }

          const timeLimitSec = timeLimitSecResult.value;
          const maxMessages = maxMessagesResult.value;
          const wordLimit = wordLimitResult.value;
          const laneIndex = laneIndexResult.value;
          const orderIndex = orderIndexResult.value;

          if (!name) return { ok: false, error: "Mission title is required." };
          if (!categoryId) return { ok: false, error: "Category is required (Load Meta first)." };
          if (!personaId) return { ok: false, error: "Persona is required (Load Meta first)." };

          // Practice Hub Designer: Attraction fields
          const isAttractionSensitive = document.getElementById("missionIsAttractionSensitiveCheckbox").checked;
          const targetRomanticGender = document.getElementById("missionTargetRomanticGenderSelect").value || undefined;

          const isUpdate = !!state.selectedMissionId;
          const parsed = getAiContractJsonOrNull();

          // For updates: if textarea is empty, don't include aiContract at all
          if (isUpdate && (!parsed || !parsed.ok || !parsed.value)) {
            // Empty textarea on update = don't touch aiContract
            // Phase 2: Always include numeric fields (even when null) to enable clearing
            const payload = {
              name,
              description,
              difficulty,
              goalType,
              categoryId,
              personaId,
              active,
              ...(code ? { code } : {}),
              timeLimitSec: timeLimitSec,
              maxMessages: maxMessages,
              wordLimit: wordLimit,
              laneIndex: laneIndex,
              orderIndex: orderIndex,
            };

            // AI Style (optional) — NEVER send aiStyleId, only aiStyleKey
            const sel = getSelectedStyle();
            if (sel && sel.key) {
              payload.aiStyleKey = String(sel.key).trim().toUpperCase();
            } else if (state.aiStyleTouched) {
              payload.aiStyleKey = ""; // explicit clear on update
            }

            return { ok: true, value: payload };
          }

          // For create: require AI contract
          if (!isUpdate && (!parsed || !parsed.ok)) {
            return { ok: false, error: parsed?.error || "AI Contract JSON is required for new missions." };
          }

          // Normalize aiContract: wrap raw MissionConfigV1 or use already-wrapped format
          let aiContractValue = null;
          if (parsed && parsed.ok && parsed.value) {
            const value = parsed.value;

            // Check if it's already wrapped { missionConfigV1: {...} }
            if (value.missionConfigV1 && typeof value.missionConfigV1 === 'object') {
              // Already wrapped, use as-is
              aiContractValue = value;
            } else if (value.version === 1 && value.dynamics && value.objective) {
              // Raw MissionConfigV1 (has version:1 and required fields), wrap it
              aiContractValue = { missionConfigV1: value };
            } else {
              // Legacy format detected (e.g., version:"ai-contract/v1")
              return {
                ok: false,
                error: "Legacy AI contract format detected. Please use MissionConfigV1 format (version: 1, with dynamics/objective/difficulty/style/statePolicy)."
              };
            }
          }

          // Minimal sync: Override MissionConfigV1 fields from template fields if parent objects exist
          // Support both wrapped and raw formats
          const cfg = aiContractValue?.missionConfigV1 ?? aiContractValue;
          
          if (cfg && typeof cfg === 'object') {
            // Title sync: objective.userTitle
            if (cfg.objective && typeof cfg.objective === 'object') {
              cfg.objective.userTitle = name;
            }
            
            // Goal type sync: objective.kind
            if (cfg.objective && typeof cfg.objective === 'object' && goalType) {
              cfg.objective.kind = goalType;
            }
            
            // Difficulty level sync: difficulty.level
            if (cfg.difficulty && typeof cfg.difficulty === 'object') {
              cfg.difficulty.level = difficulty;
            }
            
            // Max messages sync: statePolicy.maxMessages
            if (cfg.statePolicy && typeof cfg.statePolicy === 'object' && maxMessages !== null) {
              cfg.statePolicy.maxMessages = maxMessages;
            }
            
            // Timer seconds sync: statePolicy.timerSecondsPerMessage
            if (cfg.statePolicy && typeof cfg.statePolicy === 'object' && timeLimitSec !== null) {
              cfg.statePolicy.timerSecondsPerMessage = timeLimitSec;
            }
            
            // Dynamics Profile code (only write if selected, otherwise omit)
            const dynamicsProfileSelect = document.getElementById("missionDynamicsProfileSelect");
            if (dynamicsProfileSelect) {
              if (dynamicsProfileSelect.value) {
                cfg.dynamicsProfileCode = dynamicsProfileSelect.value;
              } else {
                // Omit field if not selected (don't write null)
                delete cfg.dynamicsProfileCode;
              }
            }

            // Dynamics sync: structured UI fields
            if (!cfg.dynamics) cfg.dynamics = {};
            
            const modeSelect = document.getElementById("missionDynamicsModeSelect");
            if (modeSelect) cfg.dynamics.mode = modeSelect.value || "CHAT";
            
            const locationInput = document.getElementById("missionDynamicsLocationTagInput");
            if (locationInput) cfg.dynamics.locationTag = (locationInput.value.trim() || "DEFAULT");
            
            const timerCheckbox = document.getElementById("missionDynamicsHasPerMessageTimerCheckbox");
            if (timerCheckbox) cfg.dynamics.hasPerMessageTimer = timerCheckbox.checked;
            
            const entryRouteSelect = document.getElementById("missionDynamicsDefaultEntryRouteSelect");
            if (entryRouteSelect) cfg.dynamics.defaultEntryRoute = entryRouteSelect.value || "TEXT_CHAT";
            
            // Dynamics override: only write slider values if override toggle is enabled
            const overrideToggle = document.getElementById("missionDynamicsOverrideToggle");
            if (overrideToggle && overrideToggle.checked) {
              // Sliders: parse and clamp to 0-100
              const getSliderValue = (id) => {
                const slider = document.getElementById(id);
                if (!slider) return null;
                const val = parseInt(slider.value || "50", 10);
                return Math.max(0, Math.min(100, Math.round(val)));
              };
              
              const paceVal = getSliderValue("missionDynPace");
              if (paceVal !== null) cfg.dynamics.pace = paceVal;
              
              const emojiVal = getSliderValue("missionDynEmojiDensity");
              if (emojiVal !== null) cfg.dynamics.emojiDensity = emojiVal;
              
              const flirtVal = getSliderValue("missionDynFlirtiveness");
              if (flirtVal !== null) cfg.dynamics.flirtiveness = flirtVal;
              
              const hostilityVal = getSliderValue("missionDynHostility");
              if (hostilityVal !== null) cfg.dynamics.hostility = hostilityVal;
              
              const drynessVal = getSliderValue("missionDynDryness");
              if (drynessVal !== null) cfg.dynamics.dryness = drynessVal;
              
              const vulnerabilityVal = getSliderValue("missionDynVulnerability");
              if (vulnerabilityVal !== null) cfg.dynamics.vulnerability = vulnerabilityVal;
              
              const escalationVal = getSliderValue("missionDynEscalationSpeed");
              if (escalationVal !== null) cfg.dynamics.escalationSpeed = escalationVal;
              
              const randomnessVal = getSliderValue("missionDynRandomness");
              if (randomnessVal !== null) cfg.dynamics.randomness = randomnessVal;
            } else {
              // Override disabled: clear dynamics values (profile will be used)
              cfg.dynamics.pace = null;
              cfg.dynamics.emojiDensity = null;
              cfg.dynamics.flirtiveness = null;
              cfg.dynamics.hostility = null;
              cfg.dynamics.dryness = null;
              cfg.dynamics.vulnerability = null;
              cfg.dynamics.escalationSpeed = null;
              cfg.dynamics.randomness = null;
            }
            
            // Gate Requirement Template code (only write if selected, otherwise omit)
            const gatePackSelect = document.getElementById("missionGateRequirementPackSelect");
            if (gatePackSelect) {
              if (gatePackSelect.value) {
                cfg.gateRequirementTemplateCode = gatePackSelect.value;
              } else {
                // Omit field if not selected (don't write null)
                delete cfg.gateRequirementTemplateCode;
              }
            }

            // State policy: enableGateSequence (backward compatibility - keep for old missions)
            if (!cfg.statePolicy) cfg.statePolicy = {};
            const gateCheckbox = document.getElementById("missionEnableGateSequenceCheckbox");
            if (gateCheckbox) {
              // If gate pack is selected, enable gate sequence automatically
              if (gatePackSelect && gatePackSelect.value) {
                cfg.statePolicy.enableGateSequence = true;
              } else {
                cfg.statePolicy.enableGateSequence = gateCheckbox.checked;
              }
            }
          }

          // Phase 2: Always include numeric fields (even when null) to enable clearing
          const payload = {
            name,
            description,
            difficulty,
            goalType,
            categoryId,
            personaId,
            active,
            ...(code ? { code } : {}),
            timeLimitSec: timeLimitSec,
            maxMessages: maxMessages,
            wordLimit: wordLimit,
            laneIndex: laneIndex,
            orderIndex: orderIndex,
            ...(aiContractValue ? { aiContract: aiContractValue } : {}),
            ...(isAttractionSensitive !== undefined ? { isAttractionSensitive } : {}),
            ...(targetRomanticGender ? { targetRomanticGender } : {}),
          };

          // AI Style (optional) — NEVER send aiStyleId, only aiStyleKey
          // If style selected: send uppercase key
          // Else if updating AND user touched dropdown: send empty string to clear
          // Else: omit field entirely
          const sel = getSelectedStyle();
          if (sel && sel.key) {
            payload.aiStyleKey = String(sel.key).trim().toUpperCase();
          } else if (state.selectedMissionId && state.aiStyleTouched) {
            payload.aiStyleKey = ""; // explicit clear on update
          }
          // Otherwise: no aiStyle field in payload

          return { ok: true, value: payload };
        }

        // ---------------------------
        // Practice Hub Designer: Category Management
        // ---------------------------
        const hubState = {
          categories: [],
          selectedCategoryId: null,
          viewingCategoryId: null, // Step 7.9: Track which category we're viewing missions for
        };

        const hubUI = {
          categoriesGrid: document.getElementById("categoriesGrid"),
          loadCategoriesBtn: document.getElementById("loadCategoriesBtn"),
          addCategoryBtn: document.getElementById("addCategoryBtn"),
          reorderCategoriesBtn: document.getElementById("reorderCategoriesBtn"),
          categoryModal: document.getElementById("categoryModal"),
          closeCategoryModalBtn: document.getElementById("closeCategoryModalBtn"),
          saveCategoryBtn: document.getElementById("saveCategoryBtn"),
          deleteCategoryBtn: document.getElementById("deleteCategoryBtn"),
          categoryLabelInput: document.getElementById("categoryLabelInput"),
          categoryDescriptionInput: document.getElementById("categoryDescriptionInput"),
          categoryCodeInput: document.getElementById("categoryCodeInput"),
          categoryAttractionPathSelect: document.getElementById("categoryAttractionPathSelect"),
          categoryDynamicLabelInput: document.getElementById("categoryDynamicLabelInput"),
          categoryDynamicLabelField: document.getElementById("categoryDynamicLabelField"),
          categoryDisplayOrderInput: document.getElementById("categoryDisplayOrderInput"),
          categoryIconUrlInput: document.getElementById("categoryIconUrlInput"),
          categoryActiveCheckbox: document.getElementById("categoryActiveCheckbox"),
          categoryErrorBox: document.getElementById("categoryErrorBox"),
          missionsViewModal: document.getElementById("missionsViewModal"),
          closeMissionsViewBtn: document.getElementById("closeMissionsViewBtn"),
          missionsViewTitle: document.getElementById("missionsViewTitle"),
          missionsViewTableBody: document.getElementById("missionsViewTableBody"),
          missionIsAttractionSensitiveCheckbox: document.getElementById("missionIsAttractionSensitiveCheckbox"),
          missionTargetRomanticGenderSelect: document.getElementById("missionTargetRomanticGenderSelect"),
          missionTargetGenderField: document.getElementById("missionTargetGenderField"),
        };

        function renderCategoriesGrid() {
          hubUI.categoriesGrid.innerHTML = "";
          for (const cat of hubState.categories) {
            const tile = document.createElement("div");
            tile.className = "item";
            tile.style.cursor = "pointer";
            
            const badgeClass = cat.attractionPath === "FEMALE_PATH" ? "bad" : 
                              cat.attractionPath === "MALE_PATH" ? "ok" : "";
            const badgeText = cat.attractionPath === "FEMALE_PATH" ? "Approach Women" :
                             cat.attractionPath === "MALE_PATH" ? "Approach Men" : "Unisex";
            
            tile.innerHTML = `
              <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                <div>
                  <div style="font-weight: 800; font-size: 14px; margin-bottom: 4px;">${escapeHtml(cat.label || cat.code)}</div>
                  <span class="chip ${badgeClass}" style="padding: 4px 8px; font-size: 11px;">${badgeText}</span>
                  ${cat.active ? '<span class="chip ok" style="padding: 4px 8px; font-size: 11px; margin-left: 4px;">Active</span>' : 
                    '<span class="chip warn" style="padding: 4px 8px; font-size: 11px; margin-left: 4px;">Inactive</span>'}
                </div>
                <div style="font-size: 11px; color: var(--muted);">Order: ${cat.displayOrder || 0}</div>
              </div>
              <div style="font-size: 12px; color: var(--muted); margin-bottom: 8px;">
                ${cat.description || "(no description)"}
              </div>
              <div style="display: flex; gap: 6px;">
                <button class="btn" style="flex: 1; padding: 6px;" onclick="hubEditCategory('${cat.id}')">Edit</button>
                <button class="btn" style="flex: 1; padding: 6px;" onclick="hubViewMissions('${cat.id}')">View Missions</button>
              </div>
            `;
            hubUI.categoriesGrid.appendChild(tile);
          }
        }

        async function loadCategories() {
          try {
            const resp = await apiFetch("/v1/admin/missions/meta", { method: "GET" });
            hubState.categories = resp.categories || [];
            renderCategoriesGrid();
            showOk(`Loaded ${hubState.categories.length} categories.`);
          } catch (e) {
            showError("Failed to load categories: " + formatErrorForDisplay(e));
          }
        }

        function hubEditCategory(id) {
          const cat = hubState.categories.find(c => c.id === id);
          if (!cat) {
            showError("Category not found");
            return;
          }
          hubState.selectedCategoryId = id;
          hubUI.categoryLabelInput.value = cat.label || "";
          hubUI.categoryDescriptionInput.value = cat.description || "";
          hubUI.categoryCodeInput.value = cat.code || "";
          hubUI.categoryAttractionPathSelect.value = cat.attractionPath || "UNISEX";
          hubUI.categoryDynamicLabelInput.value = cat.dynamicLabelTemplate || "";
          hubUI.categoryDisplayOrderInput.value = cat.displayOrder || 0;
          hubUI.categoryIconUrlInput.value = cat.iconUrl || "";
          hubUI.categoryActiveCheckbox.checked = cat.active !== false;
          hubUI.categoryDynamicLabelField.style.display = 
            (cat.attractionPath === "FEMALE_PATH" || cat.attractionPath === "MALE_PATH") ? "block" : "none";
          hubUI.categoryModal.style.display = "block";
        }

        function hubAddCategory() {
          hubState.selectedCategoryId = null;
          hubUI.categoryLabelInput.value = "";
          hubUI.categoryDescriptionInput.value = "";
          hubUI.categoryCodeInput.value = "";
          hubUI.categoryAttractionPathSelect.value = "UNISEX";
          hubUI.categoryDynamicLabelInput.value = "";
          hubUI.categoryDisplayOrderInput.value = 0;
          hubUI.categoryIconUrlInput.value = "";
          hubUI.categoryActiveCheckbox.checked = true;
          hubUI.categoryDynamicLabelField.style.display = "none";
          hubUI.categoryModal.style.display = "block";
        }

        hubUI.categoryAttractionPathSelect.addEventListener("change", () => {
          const path = hubUI.categoryAttractionPathSelect.value;
          hubUI.categoryDynamicLabelField.style.display = 
            (path === "FEMALE_PATH" || path === "MALE_PATH") ? "block" : "none";
          if ((path === "FEMALE_PATH" || path === "MALE_PATH") && !hubUI.categoryDynamicLabelInput.value) {
            hubUI.categoryDynamicLabelInput.value = "Approach {{targetPlural}}";
          }
        });

        async function saveCategory() {
          const label = hubUI.categoryLabelInput.value.trim();
          if (!label) {
            hubUI.categoryErrorBox.style.display = "block";
            hubUI.categoryErrorBox.textContent = "Label is required";
            return;
          }

          const payload = {
            label,
            description: hubUI.categoryDescriptionInput.value.trim() || undefined,
            code: hubUI.categoryCodeInput.value.trim() || undefined,
            attractionPath: hubUI.categoryAttractionPathSelect.value,
            dynamicLabelTemplate: hubUI.categoryDynamicLabelInput.value.trim() || undefined,
            displayOrder: parseInt(hubUI.categoryDisplayOrderInput.value) || 0,
            iconUrl: hubUI.categoryIconUrlInput.value.trim() || undefined,
            active: hubUI.categoryActiveCheckbox.checked,
          };
          
          // Step 7.10: Attraction target enforcement - warn if disabling the only male/female category
          if (!payload.active && hubState.selectedCategoryId) {
            const existingCat = hubState.categories.find(c => c.id === hubState.selectedCategoryId);
            if (existingCat && (existingCat.attractionPath === "FEMALE_PATH" || existingCat.attractionPath === "MALE_PATH")) {
              const otherCategories = hubState.categories.filter(c => 
                c.id !== hubState.selectedCategoryId && 
                c.attractionPath === existingCat.attractionPath &&
                c.active !== false
              );
              
              if (otherCategories.length === 0) {
                const pathName = existingCat.attractionPath === "FEMALE_PATH" ? "female-attracted" : "male-attracted";
                const ok = confirm(
                  `WARNING: This is the only active ${pathName} category.\n\n` +
                  `Disabling it may break attraction-based routing.\n\n` +
                  `Are you sure you want to disable it?`
                );
                if (!ok) {
                  hubUI.categoryActiveCheckbox.checked = true;
                  return;
                }
              }
            }
          }

          try {
            hubUI.categoryErrorBox.style.display = "none";
            if (hubState.selectedCategoryId) {
              await apiFetch(`/v1/admin/missions/categories/${hubState.selectedCategoryId}`, {
                method: "PUT",
                body: JSON.stringify(payload),
              });
              showOk("Category updated.");
            } else {
              await apiFetch("/v1/admin/missions/categories", {
                method: "POST",
                body: JSON.stringify(payload),
              });
              showOk("Category created.");
            }
            hubUI.categoryModal.style.display = "none";
            await loadCategories();
          } catch (e) {
            hubUI.categoryErrorBox.style.display = "block";
            hubUI.categoryErrorBox.textContent = e?.message || "Failed to save category";
          }
        }

        async function deleteCategory() {
          if (!hubState.selectedCategoryId) return;
          
          const cat = hubState.categories.find(c => c.id === hubState.selectedCategoryId);
          if (!cat) return;
          
          // Step 7.10: Attraction target enforcement - check if this is the only male/female category
          if (cat.attractionPath === "FEMALE_PATH" || cat.attractionPath === "MALE_PATH") {
            const otherCategories = hubState.categories.filter(c => 
              c.id !== hubState.selectedCategoryId && 
              c.attractionPath === cat.attractionPath &&
              c.active !== false
            );
            
            if (otherCategories.length === 0) {
              const pathName = cat.attractionPath === "FEMALE_PATH" ? "female-attracted" : "male-attracted";
              const ok = confirm(
                `WARNING: This is the only active ${pathName} category.\n\n` +
                `Deleting it may break attraction-based routing.\n\n` +
                `Are you sure you want to delete it?`
              );
              if (!ok) return;
            }
          }
          
          const ok = confirm("Delete category permanently?");
          if (!ok) return;
          
          try {
            await apiFetch(`/v1/admin/missions/categories/${hubState.selectedCategoryId}`, {
              method: "DELETE",
            });
            showOk("Category deleted.");
            hubUI.categoryModal.style.display = "none";
            await loadCategories();
          } catch (e) {
            showError("Failed to delete category: " + formatErrorForDisplay(e));
          }
        }

        async function hubViewMissions(categoryId) {
          const cat = hubState.categories.find(c => c.id === categoryId);
          if (!cat) return;
          hubState.viewingCategoryId = categoryId;
          hubUI.missionsViewTitle.textContent = `Missions in "${cat.label}"`;
          try {
            const missions = await apiFetch("/v1/admin/missions", { method: "GET" });
            const categoryMissions = (missions || []).filter(m => m.categoryId === categoryId);
            const allMissions = (missions || []).filter(m => !m.categoryId || m.categoryId !== categoryId);
            
            hubUI.missionsViewTableBody.innerHTML = "";
            for (const m of categoryMissions) {
              const row = document.createElement("tr");
              const isInconsistent = 
                (cat.attractionPath === "FEMALE_PATH" && (m.isAttractionSensitive !== true || m.targetRomanticGender !== "FEMALE")) ||
                (cat.attractionPath === "MALE_PATH" && (m.isAttractionSensitive !== true || m.targetRomanticGender !== "MALE"));
              row.style.borderBottom = "1px solid var(--line)";
              if (isInconsistent) {
                row.style.borderLeft = "3px solid var(--bad)";
                row.style.backgroundColor = "rgba(255, 92, 122, 0.1)";
              }
              row.innerHTML = `
                <td style="padding: 8px;">${escapeHtml(m.title || m.name || "")}</td>
                <td style="padding: 8px; font-size: 11px; color: var(--muted);">${escapeHtml(m.code || "")}</td>
                <td style="padding: 8px;">${escapeHtml(m.difficulty || "")}</td>
                <td style="padding: 8px;">${m.isAttractionSensitive ? "Yes" : "No"}</td>
                <td style="padding: 8px;">${escapeHtml(m.targetRomanticGender || "—")}</td>
                <td style="padding: 8px;">${m.active ? "Active" : "Inactive"}</td>
                <td style="padding: 8px;">
                  <button class="btn" style="padding: 4px 8px; font-size: 11px; margin-right: 4px;" onclick="selectMission('${m.id}'); hubUI.missionsViewModal.style.display='none';">Edit</button>
                  <button class="btn" style="padding: 4px 8px; font-size: 11px; background: var(--bad);" onclick="removeMissionFromCategory('${m.id}', '${categoryId}')">Remove</button>
                </td>
              `;
              hubUI.missionsViewTableBody.appendChild(row);
            }
            
            // Step 7.9: Add "Add Mission" section
            if (allMissions.length > 0) {
              const addSection = document.createElement("tr");
              addSection.style.borderTop = "2px solid var(--line)";
              addSection.style.backgroundColor = "rgba(255, 255, 255, 0.03)";
              addSection.innerHTML = `
                <td colspan="7" style="padding: 12px;">
                  <div style="display: flex; align-items: center; gap: 8px;">
                    <label style="font-size: 11px; color: var(--muted);">Add Mission:</label>
                    <select id="addMissionToCategorySelect" style="flex: 1; background: var(--controlBg); border: 1px solid var(--controlBorder); border-radius: 6px; padding: 4px 8px; color: var(--text);">
                      <option value="">Select a mission...</option>
                      ${allMissions.map(m => `<option value="${m.id}">${escapeHtml(m.title || m.name || m.code || "")}</option>`).join("")}
                    </select>
                    <button class="btn" style="padding: 4px 8px; font-size: 11px;" onclick="addMissionToCategory('${categoryId}')">Add</button>
                  </div>
                </td>
              `;
              hubUI.missionsViewTableBody.appendChild(addSection);
            }
            
            hubUI.missionsViewModal.style.display = "block";
          } catch (e) {
            showError("Failed to load missions: " + formatErrorForDisplay(e));
          }
        }
        
        // Step 7.9: Add mission to category
        async function addMissionToCategory(categoryId) {
          const select = document.getElementById("addMissionToCategorySelect");
          const missionId = select.value;
          
          if (!missionId) {
            showError("Please select a mission to add");
            return;
          }
          
          try {
            const mission = (state.missions || []).find(m => m.id === missionId);
            if (!mission) {
              showError("Mission not found");
              return;
            }
            
            // Update mission's categoryId
            await apiFetch(`/v1/admin/missions/${missionId}`, {
              method: "PUT",
              body: JSON.stringify({
                categoryId: categoryId,
              }),
            });
            
            showOk("Mission added to category.");
            await loadMissions(); // Reload missions
            hubViewMissions(categoryId); // Refresh the view
          } catch (e) {
            showError("Failed to add mission to category: " + (e?.message || e));
          }
        }
        
        // Step 7.9: Remove mission from category
        async function removeMissionFromCategory(missionId, categoryId) {
          const ok = confirm("Remove this mission from the category? (Mission will be unassigned)");
          if (!ok) return;
          
          try {
            // Set categoryId to null to remove from category
            await apiFetch(`/v1/admin/missions/${missionId}`, {
              method: "PUT",
              body: JSON.stringify({
                categoryId: null,
              }),
            });
            
            showOk("Mission removed from category.");
            await loadMissions(); // Reload missions
            hubViewMissions(categoryId); // Refresh the view
          } catch (e) {
              showError("Failed to remove mission from category: " + formatErrorForDisplay(e));
          }
        }
        
        // Make functions global for onclick handlers
        window.addMissionToCategory = addMissionToCategory;
        window.removeMissionFromCategory = removeMissionFromCategory;

        // Make functions global for onclick handlers
        window.hubEditCategory = hubEditCategory;
        window.hubViewMissions = hubViewMissions;
        window.hubUI = hubUI;

        // Wire Practice Hub Designer events
        hubUI.loadCategoriesBtn.addEventListener("click", loadCategories);
        hubUI.addCategoryBtn.addEventListener("click", hubAddCategory);
        hubUI.closeCategoryModalBtn.addEventListener("click", () => {
          hubUI.categoryModal.style.display = "none";
        });
        hubUI.saveCategoryBtn.addEventListener("click", saveCategory);
        hubUI.deleteCategoryBtn.addEventListener("click", deleteCategory);
        hubUI.closeMissionsViewBtn.addEventListener("click", () => {
          hubUI.missionsViewModal.style.display = "none";
        });

        // Mission editor: Attraction fields
        hubUI.missionIsAttractionSensitiveCheckbox.addEventListener("change", () => {
          hubUI.missionTargetGenderField.style.display = 
            hubUI.missionIsAttractionSensitiveCheckbox.checked ? "block" : "none";
        });

        function updateSelectionUI() {
          const sid = state.selectedMissionId;
          ui.selectedChip.textContent = sid ? `Selected: ${sid}` : "Selected: none";
          ui.duplicateMissionBtn.disabled = !sid;
          ui.deleteMissionBtn.disabled = !sid;

          // highlight list items
          const items = ui.missionsList.querySelectorAll(".item");
          items.forEach((el) => {
            const id = el.getAttribute("data-id");
            el.classList.toggle("active", !!sid && id === sid);
          });
        }

        function updateMissionPreview() {
          const name = (ui.missionTitleInput.value || "").trim() || "—";
          const difficulty = ui.difficultySelect.value || "—";
          const active = ui.activeSelect.value === "true" ? "active" : "inactive";

          const sel = getSelectedStyle();
          const styleLabel = sel ? (sel.key || sel.name || "style") : "default";

          const contractParsed = getAiContractJsonOrNull();
          const contractOk = contractParsed && contractParsed.ok;

          ui.previewChip.textContent = `${difficulty} • ${styleLabel} • ${active} • ${name}`;

          if (!ui.aiContractJsonTextarea.value.trim()) {
            setChip(ui.contractValidityChip, "AI Contract: empty", "warn");
            return;
          }
          setChip(
            ui.contractValidityChip,
            contractOk ? "AI Contract: valid" : "AI Contract: invalid",
            contractOk ? "ok" : "bad"
          );
        }

        function mapIdToName(list, id, keys = ["name", "title", "label"]) {
          const item = (list || []).find((x) => x?.id === id);
          if (!item) return id;
          for (const k of keys) if (item[k]) return item[k];
          return id;
        }

        // ---------------------------
        // Rendering
        // ---------------------------
        function renderAiStyleSelect() {
          ui.aiStyleSelect.innerHTML = `<option value="">(default / none)</option>`;

          const styles = (state.aiStyles || []).filter((s) => s && (s.isActive !== false));
          if (!styles.length) {
            ui.aiStyleSelect.insertAdjacentHTML(
              "beforeend",
              `<option value="__none__" disabled>(no styles found)</option>`
            );
            return;
          }

          for (const s of styles) {
            // Use key as value (backend expects aiStyleKey, not aiStyleId)
            const value = s.key || "";
            if (!value) continue; // skip styles without key
            const label = `${s.key || s.name || value} — ${s.name || ""}`.trim().replace(/\s+—\s*$/, "");
            ui.aiStyleSelect.insertAdjacentHTML(
              "beforeend",
              `<option value="${escapeHtmlAttr(value)}">${escapeHtml(label)}</option>`
            );
          }
        }

        function renderMetaSelects() {
          // categories
          ui.categorySelect.innerHTML = `<option value="">(select)</option>`;
          for (const c of state.categories) {
            const label = c.name || c.title || c.label || c.code || c.id;
            ui.categorySelect.insertAdjacentHTML(
              "beforeend",
              `<option value="${escapeHtmlAttr(c.id)}">${escapeHtml(label)}</option>`
            );
          }

          // personas
          ui.personaSelect.innerHTML = `<option value="">(select)</option>`;
          for (const p of state.personas) {
            const label = p.name || p.title || p.code || p.id;
            ui.personaSelect.insertAdjacentHTML(
              "beforeend",
              `<option value="${escapeHtmlAttr(p.id)}">${escapeHtml(label)}</option>`
            );
          }

          // styles
          renderAiStyleSelect();
        }

        function renderMissionsList() {
          const q = (ui.searchInput.value || "").trim().toLowerCase();
          const missions = (state.missions || []).filter((m) => {
            if (!q) return true;
            const styleKey = getMissionStyleKey(m) || "";
            const hay = `${m.name || ""} ${m.code || ""} ${styleKey}`.toLowerCase();
            return hay.includes(q);
          });

          ui.missionsList.innerHTML = "";
          for (const m of missions) {
            const id = m.id || "";
            const title = m.name || m.title || "(untitled)";
            const diff = m.difficulty || "—";
            const active = m.active ? "active" : "inactive";
            const styleKey = getMissionStyleKey(m);
            const catName = m.categoryId ? mapIdToName(state.categories, m.categoryId) : (m.category?.label || "—");
            const personaName = m.personaId ? mapIdToName(state.personas, m.personaId) : (m.persona?.name || "—");
            
            // Step 7.1: Add attractionTarget display
            let attractionTarget = "both";
            if (m.isAttractionSensitive) {
              if (m.targetRomanticGender === "FEMALE") attractionTarget = "female";
              else if (m.targetRomanticGender === "MALE") attractionTarget = "male";
              else attractionTarget = "both";
            }
            
            // Step 7.1: Format dates
            const createdAt = m.createdAt ? new Date(m.createdAt).toLocaleDateString() : "—";
            const updatedAt = m.updatedAt ? new Date(m.updatedAt).toLocaleDateString() : "—";

            const chipClass = m.active ? "ok" : "warn";
            const item = document.createElement("div");
            item.className = "item";
            item.setAttribute("data-id", id);
            item.innerHTML = `
              <div class="itemTitle">
                <span>${escapeHtml(title)}</span>
                <span class="chip ${chipClass}" style="padding:4px 10px">${escapeHtml(active)}</span>
              </div>
              <div class="itemMeta" style="display: flex; flex-wrap: wrap; gap: 6px; align-items: center; font-size: 11px;">
                <span class="chip" style="padding:4px 10px">${escapeHtml(diff)}</span>
                ${styleKey ? `<span class="chip" style="padding:4px 10px">${escapeHtml(styleKey)}</span>` : ""}
                <span style="color: var(--muted);">Cat: ${escapeHtml(catName)}</span>
                <span style="color: var(--muted);">•</span>
                <span style="color: var(--muted);">Persona: ${escapeHtml(personaName)}</span>
                <span style="color: var(--muted);">•</span>
                <span style="color: var(--muted);">Target: ${escapeHtml(attractionTarget)}</span>
                ${m.code ? `<span style="color: var(--muted);">•</span><span style="color: var(--muted);">${escapeHtml(m.code)}</span>` : ""}
                <span style="color: var(--muted); margin-left: auto;">Updated: ${escapeHtml(updatedAt)}</span>
              </div>
            `;
            item.addEventListener("click", () => selectMission(id));
            ui.missionsList.appendChild(item);
          }

          updateSelectionUI();
        }

        function escapeHtml(str) {
          return String(str)
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#039;");
        }

        function escapeHtmlAttr(str) {
          return escapeHtml(str).replace(/"/g, "&quot;");
        }

        // ---------------------------
        // Core actions
        // ---------------------------
        async function pingApi() {
          setChip(ui.apiStatusChip, "API: pinging...", "warn");
          const tries = [
            "/health",
            "/v1/admin/missions/meta",
            "/mqs/health",
            "/",
          ];

          for (const t of tries) {
            try {
              await apiFetch(t, { method: "GET" });
              setChip(ui.apiStatusChip, "API: OK", "ok");
              showOk(`API reachable via ${t}`);
              return true;
            } catch (e) {
              // continue
            }
          }

          setChip(ui.apiStatusChip, "API: FAIL", "bad");
          return false;
        }

        async function loadAiStylesFallback() {
          // If meta didn't include styles, try dedicated endpoints.
          const candidates = [
            "/v1/admin/ai-styles",
            "/v1/admin/ai-styles/list",
            "/v1/admin/styles",
            "/ai-styles",
          ];

          for (const path of candidates) {
            try {
              const resp = await apiFetch(path, { method: "GET" });
              const list = normalizeAiStyles(resp);
              if (list.length) {
                state.aiStyles = list;
                log(`Loaded aiStyles from ${path}`, { count: list.length });
                return true;
              }
            } catch {
              // keep trying
            }
          }

          log("aiStyles fallback: no endpoint returned styles. (OK if your meta includes them)");
          return false;
        }

        async function loadMeta() {
          setChip(ui.metaStatusChip, "Meta: loading...", "warn");

          const resp = await apiFetch("/v1/admin/missions/meta", { method: "GET" });
          const meta = normalizeMeta(resp);

          state.categories = meta.categories;
          state.personas = meta.personas;

          // styles from meta (optional) or fallback
          const stylesFromMeta = normalizeAiStyles({ data: { aiStyles: meta.aiStyles } });
          if (stylesFromMeta.length) {
            state.aiStyles = stylesFromMeta;
            log("Loaded aiStyles from meta", { count: stylesFromMeta.length });
          } else {
            await loadAiStylesFallback();
          }

          state.metaLoaded = true;

          renderMetaSelects();

          const extras = state.aiStyles.length ? `, ${state.aiStyles.length} styles` : "";
          setChip(
            ui.metaStatusChip,
            `Meta: ${state.categories.length} cats, ${state.personas.length} personas${extras}`,
            "ok"
          );
          showOk("Meta loaded.");
          updateMissionPreview();
        }

        async function loadMissions() {
          setChip(ui.missionsStatusChip, "Missions: loading...", "warn");

          let resp = null;
          try {
            resp = await apiFetch("/v1/admin/missions", { method: "GET" });
          } catch {
            resp = await apiFetch("/v1/admin/missions/list", { method: "GET" });
          }

          state.missions = normalizeMissions(resp);
          state.missionsLoaded = true;

          renderMissionsList();
          setChip(ui.missionsStatusChip, `Missions: ${state.missions.length}`, "ok");
          showOk("Missions loaded.");
        }

        // ---------------------------
        // Load Everything orchestrator
        // ---------------------------
        async function callOrFetch(label, fn, path) {
          try {
            if (fn && typeof fn === "function") {
              log(`LOAD ${label} via function`);
              const res = await fn();
              window.__loaded = window.__loaded || {};
              window.__loaded[label] = res ?? window.__loaded[label] ?? true;
              return res;
            }
            log(`LOAD ${label} via apiFetch ${path}`);
            const res = await apiFetch(path);
            window.__loaded = window.__loaded || {};
            window.__loaded[label] = res;
            return res;
          } catch (e) {
            log(`LOAD FAILED ${label}: ${e?.message || e}`);
            throw e;
          }
        }

        async function loadEverything() {
          const btn = document.getElementById("loadEverythingBtn");
          if (btn) btn.disabled = true;

          try {
            clearError();
            log("=== LOAD EVERYTHING START ===");

            // Auth check / foundation: engine-config first
            const engineConfigRes = await callOrFetch("engine-config", typeof loadEngineConfig === "function" ? loadEngineConfig : null, "/v1/admin/engine-config");
            if (engineConfigRes) {
              v2State.engineConfig = engineConfigRes.config || engineConfigRes;
            }

            // Load and sync to v2State
            const metaRes = await callOrFetch("missions-meta", typeof loadMeta === "function" ? loadMeta : null, "/v1/admin/missions/meta");
            if (metaRes && metaRes.categories) v2State.categories = metaRes.categories;
            if (metaRes && metaRes.personas) v2State.personas = metaRes.personas;
            if (metaRes && metaRes.aiStyles) v2State.aiStyles = metaRes.aiStyles;
            
            const categoriesRes = await callOrFetch("categories", typeof loadCategories === "function" ? loadCategories : null, "/v1/admin/missions/categories");
            if (Array.isArray(categoriesRes)) v2State.categories = categoriesRes;
            
            const missionsRes = await callOrFetch("missions", typeof loadMissions === "function" ? loadMissions : null, "/v1/admin/missions");
            if (Array.isArray(missionsRes)) v2State.missions = missionsRes;
            
            const personasRes = await callOrFetch("personas", typeof loadPersonasAdmin === "function" ? loadPersonasAdmin : null, "/v1/admin/personas");
            if (Array.isArray(personasRes)) v2State.personas = personasRes;
            
            const aiStylesRes = await callOrFetch("ai-styles", typeof loadAiStylesAdmin === "function" ? loadAiStylesAdmin : null, "/v1/admin/ai-styles");
            if (Array.isArray(aiStylesRes)) v2State.aiStyles = aiStylesRes;
            
            // Refresh current mode view
            if (v2State.currentMode === "engine-map") {
              renderEngineMap();
            } else if (v2State.currentMode === "practice-hub") {
              renderPracticeHub();
            }
            await callOrFetch("hooks", typeof loadHooks === "function" ? loadHooks : null, "/v1/admin/hooks");
            await callOrFetch("hook-trigger-stats", typeof loadTriggerStats === "function" ? loadTriggerStats : null, "/v1/admin/hooks/triggers/stats?days=7");
            await callOrFetch("insights-catalog", null, "/v1/admin/insights/catalog");
            await callOrFetch("micro-feedback", null, "/v1/admin/prompts/micro-feedback");
            await callOrFetch("openings", typeof loadOpenings === "function" ? loadOpenings : null, "/v1/admin/prompts/openings");
            await callOrFetch("mission-attachments", typeof loadMissionAttachments === "function" ? loadMissionAttachments : null, "/v1/admin/missions/attachments");

            showOk("Load Everything complete.");
            log("=== LOAD EVERYTHING DONE ===");
          } catch (e) {
            // apiFetch already shows UI error; we just ensure we log
            log(`=== LOAD EVERYTHING ABORTED: ${e?.message || e} ===`);
          } finally {
            if (btn) btn.disabled = false;
          }
        }

        function selectMission(id) {
          const m = (state.missions || []).find((x) => x.id === id);
          if (!m) {
            showError("Mission not found: " + id);
            return;
          }
          state.selectedMissionId = id;

          ui.missionTitleInput.value = m.name || "";
          ui.missionDescriptionInput.value = m.description || "";
          ui.difficultySelect.value = m.difficulty || "EASY";
          ui.missionGoalTypeSelect.value = m.goalType || "";
          ui.categorySelect.value = m.categoryId || "";
          ui.personaSelect.value = m.personaId || "";
          ui.activeSelect.value = String(!!m.active);
          ui.codeInput.value = m.code || "";
          ui.missionTimeLimitInput.value = m.timeLimitSec ?? "";
          ui.missionMaxMessagesInput.value = m.maxMessages ?? "";
          ui.missionWordLimitInput.value = m.wordLimit ?? "";
          ui.laneIndexInput.value = m.laneIndex ?? "";
          ui.orderIndexInput.value = m.orderIndex ?? "";

          // AI Style: find by key and set dropdown value to key
          const styleKey = getMissionStyleKey(m);
          if (styleKey) {
            const style = findStyleByKey(styleKey);
            if (style && style.key) {
              ui.aiStyleSelect.value = style.key;
            } else {
              ui.aiStyleSelect.value = "";
            }
          } else {
            ui.aiStyleSelect.value = "";
          }
          state.aiStyleTouched = false;

          setAiContractTextarea(m.aiContract);
          
          // Hydrate structured dynamics fields from aiContract
          try {
            const contractJson = ui.aiContractJsonTextarea.value.trim();
            if (contractJson) {
              const parsed = JSON.parse(contractJson);
              const config = parsed.missionConfigV1 || parsed;
              
              // Dynamics Profile selector
              const dynamicsProfileSelect = document.getElementById("missionDynamicsProfileSelect");
              if (dynamicsProfileSelect) {
                const profileCode = config.dynamicsProfileCode || "";
                dynamicsProfileSelect.value = profileCode || "";
                onDynamicsProfileChange();
              }

              // Dynamics override toggle - check if dynamics values exist (means override was used)
              const overrideToggle = document.getElementById("missionDynamicsOverrideToggle");
              const hasDynamicsOverrides = config.dynamics && (
                config.dynamics.pace !== null && config.dynamics.pace !== undefined ||
                config.dynamics.emojiDensity !== null && config.dynamics.emojiDensity !== undefined ||
                config.dynamics.flirtiveness !== null && config.dynamics.flirtiveness !== undefined ||
                config.dynamics.hostility !== null && config.dynamics.hostility !== undefined ||
                config.dynamics.dryness !== null && config.dynamics.dryness !== undefined ||
                config.dynamics.vulnerability !== null && config.dynamics.vulnerability !== undefined ||
                config.dynamics.escalationSpeed !== null && config.dynamics.escalationSpeed !== undefined ||
                config.dynamics.randomness !== null && config.dynamics.randomness !== undefined
              );
              if (overrideToggle) {
                overrideToggle.checked = hasDynamicsOverrides;
                onDynamicsOverrideToggle();
              }
              
              if (config.dynamics) {
                const dyn = config.dynamics;
                const modeSelect = document.getElementById("missionDynamicsModeSelect");
                if (modeSelect) modeSelect.value = dyn.mode || "CHAT";
                
                const locationInput = document.getElementById("missionDynamicsLocationTagInput");
                if (locationInput) locationInput.value = dyn.locationTag || "DEFAULT";
                
                const timerCheckbox = document.getElementById("missionDynamicsHasPerMessageTimerCheckbox");
                if (timerCheckbox) timerCheckbox.checked = dyn.hasPerMessageTimer === true;
                
                const entryRouteSelect = document.getElementById("missionDynamicsDefaultEntryRouteSelect");
                if (entryRouteSelect) entryRouteSelect.value = dyn.defaultEntryRoute || "TEXT_CHAT";
                
                // Sliders with clamping (only if override is enabled)
                if (hasDynamicsOverrides) {
                  const setSlider = (id, valId, value) => {
                    const slider = document.getElementById(id);
                    const valSpan = document.getElementById(valId);
                    if (slider && valSpan) {
                      const clamped = Math.max(0, Math.min(100, Math.round(value || 50)));
                      slider.value = clamped;
                      valSpan.textContent = clamped;
                    }
                  };
                  
                  setSlider("missionDynPace", "missionDynPaceVal", dyn.pace);
                  setSlider("missionDynEmojiDensity", "missionDynEmojiDensityVal", dyn.emojiDensity);
                  setSlider("missionDynFlirtiveness", "missionDynFlirtivenessVal", dyn.flirtiveness);
                  setSlider("missionDynHostility", "missionDynHostilityVal", dyn.hostility);
                  setSlider("missionDynDryness", "missionDynDrynessVal", dyn.dryness);
                  setSlider("missionDynVulnerability", "missionDynVulnerabilityVal", dyn.vulnerability);
                  setSlider("missionDynEscalationSpeed", "missionDynEscalationSpeedVal", dyn.escalationSpeed);
                  setSlider("missionDynRandomness", "missionDynRandomnessVal", dyn.randomness);
                }
              }
              
              // Gate Requirement Pack selector
              const gatePackSelect = document.getElementById("missionGateRequirementPackSelect");
              if (gatePackSelect) {
                const gatePackCode = config.gateRequirementTemplateCode || "";
                gatePackSelect.value = gatePackCode || "";
                onGatePackChange();
              }

              // Backward compatibility: if enableGateSequence exists, set it (but new UI uses gate pack)
              if (config.statePolicy) {
                const gateCheckbox = document.getElementById("missionEnableGateSequenceCheckbox");
                if (gateCheckbox) gateCheckbox.checked = config.statePolicy.enableGateSequence === true;
              }
            }
          } catch (e) {
            showError("Invalid AI Contract JSON. Can't hydrate Dynamics.");
          }
          
          // Practice Hub Designer: Load attraction fields
          if (hubUI && hubUI.missionIsAttractionSensitiveCheckbox) {
            hubUI.missionIsAttractionSensitiveCheckbox.checked = m.isAttractionSensitive === true;
            hubUI.missionTargetRomanticGenderSelect.value = m.targetRomanticGender || "";
            hubUI.missionTargetGenderField.style.display = 
              hubUI.missionIsAttractionSensitiveCheckbox.checked ? "block" : "none";
          }
          
          updateSelectionUI();
          updateMissionPreview();
          showOk("Mission loaded into editor.");
          
          // Step 7: Show mission monitor and load data
          showMissionMonitor(m);
        }

        function syncMissionDynamicsFromJson() {
          try {
            const contractJson = ui.aiContractJsonTextarea.value.trim();
            if (!contractJson) {
              showError("AI Contract JSON is empty.");
              return;
            }
            const parsed = JSON.parse(contractJson);
            const config = parsed.missionConfigV1 || parsed;
            
            if (config.dynamics) {
              const dyn = config.dynamics;
              const modeSelect = document.getElementById("missionDynamicsModeSelect");
              if (modeSelect) modeSelect.value = dyn.mode || "CHAT";
              
              const locationInput = document.getElementById("missionDynamicsLocationTagInput");
              if (locationInput) locationInput.value = dyn.locationTag || "DEFAULT";
              
              const timerCheckbox = document.getElementById("missionDynamicsHasPerMessageTimerCheckbox");
              if (timerCheckbox) timerCheckbox.checked = dyn.hasPerMessageTimer === true;
              
              const entryRouteSelect = document.getElementById("missionDynamicsDefaultEntryRouteSelect");
              if (entryRouteSelect) entryRouteSelect.value = dyn.defaultEntryRoute || "TEXT_CHAT";
              
              // Sliders with clamping
              const setSlider = (id, valId, value) => {
                const slider = document.getElementById(id);
                const valSpan = document.getElementById(valId);
                if (slider && valSpan) {
                  const clamped = Math.max(0, Math.min(100, Math.round(value || 50)));
                  slider.value = clamped;
                  valSpan.textContent = clamped;
                }
              };
              
              setSlider("missionDynPace", "missionDynPaceVal", dyn.pace);
              setSlider("missionDynEmojiDensity", "missionDynEmojiDensityVal", dyn.emojiDensity);
              setSlider("missionDynFlirtiveness", "missionDynFlirtivenessVal", dyn.flirtiveness);
              setSlider("missionDynHostility", "missionDynHostilityVal", dyn.hostility);
              setSlider("missionDynDryness", "missionDynDrynessVal", dyn.dryness);
              setSlider("missionDynVulnerability", "missionDynVulnerabilityVal", dyn.vulnerability);
              setSlider("missionDynEscalationSpeed", "missionDynEscalationSpeedVal", dyn.escalationSpeed);
              setSlider("missionDynRandomness", "missionDynRandomnessVal", dyn.randomness);
            }
            
            if (config.statePolicy) {
              const gateCheckbox = document.getElementById("missionEnableGateSequenceCheckbox");
              if (gateCheckbox) gateCheckbox.checked = config.statePolicy.enableGateSequence === true;
            }
            
            showOk("Dynamics synced from JSON.");
          } catch (e) {
            showError("Invalid JSON in AI Contract. Cannot sync dynamics: " + formatErrorForDisplay(e));
          }
        }

        function writeMissionDynamicsToJson() {
          try {
            const contractJson = ui.aiContractJsonTextarea.value.trim();
            if (!contractJson) {
              showError("AI Contract JSON is empty. Cannot write dynamics.");
              return;
            }
            const parsed = JSON.parse(contractJson);
            const cfg = parsed.missionConfigV1 || parsed;
            
            if (!cfg || typeof cfg !== 'object') {
              showError("Invalid AI Contract structure.");
              return;
            }
            
            // Ensure dynamics and statePolicy exist
            if (!cfg.dynamics) cfg.dynamics = {};
            if (!cfg.statePolicy) cfg.statePolicy = {};
            
            // Read from structured UI
            const modeSelect = document.getElementById("missionDynamicsModeSelect");
            if (modeSelect) cfg.dynamics.mode = modeSelect.value || "CHAT";
            
            const locationInput = document.getElementById("missionDynamicsLocationTagInput");
            if (locationInput) cfg.dynamics.locationTag = (locationInput.value.trim() || "DEFAULT");
            
            const timerCheckbox = document.getElementById("missionDynamicsHasPerMessageTimerCheckbox");
            if (timerCheckbox) cfg.dynamics.hasPerMessageTimer = timerCheckbox.checked;
            
            const entryRouteSelect = document.getElementById("missionDynamicsDefaultEntryRouteSelect");
            if (entryRouteSelect) cfg.dynamics.defaultEntryRoute = entryRouteSelect.value || "TEXT_CHAT";
            
            // Sliders: parse and clamp to 0-100
            const getSliderValue = (id) => {
              const slider = document.getElementById(id);
              if (!slider) return null;
              const val = parseInt(slider.value || "50", 10);
              return Math.max(0, Math.min(100, Math.round(val)));
            };
            
            const paceVal = getSliderValue("missionDynPace");
            if (paceVal !== null) cfg.dynamics.pace = paceVal;
            
            const emojiVal = getSliderValue("missionDynEmojiDensity");
            if (emojiVal !== null) cfg.dynamics.emojiDensity = emojiVal;
            
            const flirtVal = getSliderValue("missionDynFlirtiveness");
            if (flirtVal !== null) cfg.dynamics.flirtiveness = flirtVal;
            
            const hostilityVal = getSliderValue("missionDynHostility");
            if (hostilityVal !== null) cfg.dynamics.hostility = hostilityVal;
            
            const drynessVal = getSliderValue("missionDynDryness");
            if (drynessVal !== null) cfg.dynamics.dryness = drynessVal;
            
            const vulnerabilityVal = getSliderValue("missionDynVulnerability");
            if (vulnerabilityVal !== null) cfg.dynamics.vulnerability = vulnerabilityVal;
            
            const escalationVal = getSliderValue("missionDynEscalationSpeed");
            if (escalationVal !== null) cfg.dynamics.escalationSpeed = escalationVal;
            
            const randomnessVal = getSliderValue("missionDynRandomness");
            if (randomnessVal !== null) cfg.dynamics.randomness = randomnessVal;
            
            // State policy: enableGateSequence
            const gateCheckbox = document.getElementById("missionEnableGateSequenceCheckbox");
            if (gateCheckbox) cfg.statePolicy.enableGateSequence = gateCheckbox.checked;
            
            // Write back to textarea (preserve wrapped format if it was wrapped)
            if (parsed.missionConfigV1) {
              ui.aiContractJsonTextarea.value = JSON.stringify(parsed, null, 2);
            } else {
              ui.aiContractJsonTextarea.value = JSON.stringify(cfg, null, 2);
            }
            
            updateContractValidity();
            showOk("Dynamics written to JSON.");
          } catch (e) {
            showError("Error writing dynamics to JSON: " + formatErrorForDisplay(e));
          }
        }
        
        // Step 7: Mission Monitor functions
        function showMissionMonitor(mission) {
          const monitorSection = document.getElementById("missionMonitorSection");
          const monitorEmpty = document.getElementById("missionMonitorEmpty");
          const monitorContent = document.getElementById("missionMonitorContent");
          
          if (!mission || !mission.id) {
            monitorSection.style.display = "none";
            return;
          }
          
          monitorSection.style.display = "block";
          monitorEmpty.style.display = "none";
          monitorContent.style.display = "block";
          
          // Load mission config view (7.2)
          loadMissionConfigView(mission);
          
          // Load mission stats (7.3)
          loadMissionStats(mission.id);
          
          // Load mood timelines (7.4)
          loadMissionMoodTimelines(mission.id);
          
          // Load sessions for message log (7.5)
          loadMissionSessions(mission.id);
        }
        
        async function loadMissionConfigView(mission) {
          const configEmpty = document.getElementById("missionConfigEmpty");
          const configDetails = document.getElementById("missionConfigDetails");
          
          try {
            const aiContract = mission.aiContract || {};
            const config = aiContract.missionConfigV1 || {};
            
            if (!config.version) {
              configEmpty.style.display = "block";
              configDetails.style.display = "none";
              return;
            }
            
            configEmpty.style.display = "none";
            configDetails.style.display = "block";
            
            // Objective
            const objective = config.objective || {};
            document.getElementById("configObjective").textContent = 
              `${objective.kind || "—"} - ${objective.userTitle || "—"}`;
            
            // Difficulty
            const difficulty = config.difficulty || {};
            document.getElementById("configDifficulty").textContent = 
              `${difficulty.level || "—"}${difficulty.strictness !== undefined ? ` (strictness: ${difficulty.strictness})` : ""}`;
            
            // AI Style
            const style = config.style || {};
            document.getElementById("configAiStyle").textContent = style.aiStyleKey || "—";
            
            // Runtime Profile
            const runtimeProfile = config.aiRuntimeProfile || {};
            document.getElementById("configRuntimeProfile").textContent = 
              runtimeProfile.model ? `${runtimeProfile.model} (temp: ${runtimeProfile.temperature || "—"})` : "—";
            
            // Gate Config
            const statePolicy = config.statePolicy || {};
            document.getElementById("configGateConfig").textContent = 
              `Max messages: ${statePolicy.maxMessages || "—"}, ` +
              `Success threshold: ${statePolicy.successScoreThreshold || "—"}, ` +
              `Fail threshold: ${statePolicy.failScoreThreshold || "—"}, ` +
              `Gate sequence: ${statePolicy.enableGateSequence ? "enabled" : "disabled"}`;
            
            // Wire up raw JSON viewer
            document.getElementById("viewRawConfigBtn").onclick = () => {
              const jsonStr = JSON.stringify(config, null, 2);
              alert(jsonStr);
            };
          } catch (e) {
            configEmpty.style.display = "block";
            configDetails.style.display = "none";
            console.error("Error loading mission config:", e);
          }
        }
        
        async function loadMissionStats(missionId) {
          const statsEmpty = document.getElementById("missionStatsEmpty");
          const statsDetails = document.getElementById("missionStatsDetails");
          const timeWindow = document.getElementById("statsTimeWindow").value;
          
          try {
            const url = `/v1/admin/missions/${missionId}/stats${timeWindow ? `?timeWindow=${timeWindow}` : ""}`;
            const res = await apiFetch(url, { method: "GET" });
            
            if (!res || res.sessionCount === 0) {
              statsEmpty.style.display = "block";
              statsDetails.style.display = "none";
              return;
            }
            
            statsEmpty.style.display = "none";
            statsDetails.style.display = "block";
            
            document.getElementById("statsSessionCount").textContent = res.sessionCount || 0;
            document.getElementById("statsSuccessRate").textContent = `${res.successRate || 0}%`;
            document.getElementById("statsAvgMessages").textContent = res.avgMessages || 0;
            document.getElementById("statsAvgDuration").textContent = `${res.avgDurationSeconds || 0}s`;
          } catch (e) {
            statsEmpty.style.display = "block";
            statsDetails.style.display = "none";
            console.error("Error loading mission stats:", e);
          }
        }
        
        async function loadMissionMoodTimelines(missionId) {
          const timelineEmpty = document.getElementById("moodTimelineEmpty");
          const timelineChart = document.getElementById("moodTimelineChart");
          
          try {
            const res = await apiFetch(`/v1/admin/missions/${missionId}/mood-timelines?limit=1`, { method: "GET" });
            
            if (!res || !Array.isArray(res) || res.length === 0) {
              timelineEmpty.style.display = "block";
              timelineChart.style.display = "none";
              return;
            }
            
            const timeline = res[0];
            const timelineData = timeline.timelineJson;
            
            if (!timelineData || !timelineData.snapshots || timelineData.snapshots.length === 0) {
              timelineEmpty.style.display = "block";
              timelineChart.style.display = "none";
              return;
            }
            
            timelineEmpty.style.display = "none";
            timelineChart.style.display = "block";
            
            // Simple text-based timeline visualization (no Chart.js dependency)
            renderSimpleMoodTimeline(timelineData);
          } catch (e) {
            timelineEmpty.style.display = "block";
            timelineChart.style.display = "none";
            console.error("Error loading mood timeline:", e);
          }
        }
        
        function renderSimpleMoodTimeline(timelineData) {
          const canvas = document.getElementById("moodTimelineCanvas");
          const ctx = canvas.getContext("2d");
          const snapshots = timelineData.snapshots || [];
          
          if (snapshots.length === 0) return;
          
          // Set canvas size
          canvas.width = 800;
          canvas.height = 200;
          
          // Clear canvas
          ctx.clearRect(0, 0, canvas.width, canvas.height);
          
          // Draw axes
          ctx.strokeStyle = "rgba(255, 255, 255, 0.3)";
          ctx.lineWidth = 1;
          ctx.beginPath();
          ctx.moveTo(40, 20);
          ctx.lineTo(40, canvas.height - 20);
          ctx.lineTo(canvas.width - 20, canvas.height - 20);
          ctx.stroke();
          
          // Draw mood line
          ctx.strokeStyle = "rgba(77, 97, 255, 0.8)";
          ctx.lineWidth = 2;
          ctx.beginPath();
          
          const stepX = (canvas.width - 60) / Math.max(snapshots.length - 1, 1);
          const maxMood = 100;
          
          snapshots.forEach((snap, i) => {
            const x = 40 + i * stepX;
            const y = canvas.height - 20 - (snap.moodPercent || 0) * (canvas.height - 40) / maxMood;
            
            if (i === 0) {
              ctx.moveTo(x, y);
            } else {
              ctx.lineTo(x, y);
            }
            
            // Draw point
            ctx.fillStyle = "rgba(77, 97, 255, 1)";
            ctx.beginPath();
            ctx.arc(x, y, 3, 0, 2 * Math.PI);
            ctx.fill();
          });
          
          ctx.stroke();
          
          // Draw labels
          ctx.fillStyle = "rgba(255, 255, 255, 0.7)";
          ctx.font = "11px sans-serif";
          ctx.textAlign = "center";
          snapshots.forEach((snap, i) => {
            const x = 40 + i * stepX;
            ctx.fillText(`T${snap.turnIndex || i}`, x, canvas.height - 5);
          });
          
          // Y-axis labels
          ctx.textAlign = "right";
          for (let i = 0; i <= 100; i += 25) {
            const y = canvas.height - 20 - i * (canvas.height - 40) / maxMood;
            ctx.fillText(i.toString(), 35, y + 4);
          }
        }
        
        async function loadMissionSessions(missionId) {
          const sessionSelect = document.getElementById("messageLogSessionSelect");
          
          try {
            const res = await apiFetch(`/v1/admin/missions/${missionId}/sessions?limit=10`, { method: "GET" });
            
            sessionSelect.innerHTML = '<option value="">Select a session...</option>';
            
            if (res && Array.isArray(res) && res.length > 0) {
              res.forEach(session => {
                const option = document.createElement("option");
                option.value = session.id;
                const date = new Date(session.createdAt).toLocaleString();
                const score = session.score || 0;
                const status = session.isSuccess ? "✓" : "✗";
                option.textContent = `${date} - Score: ${score} ${status}`;
                sessionSelect.appendChild(option);
              });
            }
          } catch (e) {
            console.error("Error loading sessions:", e);
          }
        }
        
        async function loadSessionMessages(sessionId) {
          const logEmpty = document.getElementById("messageLogEmpty");
          const logTable = document.getElementById("messageLogTable");
          const logTableBody = document.getElementById("messageLogTableBody");
          
          if (!sessionId) {
            logEmpty.style.display = "block";
            logTable.style.display = "none";
            return;
          }
          
          try {
            const res = await apiFetch(`/v1/admin/missions/sessions/${sessionId}/messages`, { method: "GET" });
            
            if (!res || !res.messages || res.messages.length === 0) {
              logEmpty.style.display = "block";
              logTable.style.display = "none";
              return;
            }
            
            logEmpty.style.display = "none";
            logTable.style.display = "block";
            logTableBody.innerHTML = "";
            
            const gateOutcomes = res.gateOutcomes || [];
            const moodTimeline = res.moodTimeline;
            
            res.messages.forEach((msg, idx) => {
              const row = document.createElement("tr");
              row.style.borderBottom = "1px solid var(--line)";
              
              // Find gate outcomes for this message
              const gates = gateOutcomes.filter(g => g.messageIndex === msg.turnIndex);
              const gatesText = gates.length > 0 
                ? gates.map(g => `${g.gateKey} (${g.passed ? "✓" : "✗"})`).join(", ")
                : "—";
              
              // Calculate mood delta (if available)
              let moodDelta = "—";
              if (moodTimeline && moodTimeline.snapshots && moodTimeline.snapshots.length > idx) {
                const current = moodTimeline.snapshots[idx];
                const previous = idx > 0 ? moodTimeline.snapshots[idx - 1] : null;
                if (previous) {
                  const delta = (current.moodPercent || 0) - (previous.moodPercent || 0);
                  moodDelta = delta > 0 ? `+${delta.toFixed(0)}` : delta.toFixed(0);
                }
              }
              
              const rarityColor = 
                msg.rarity === "S+" ? "var(--ok)" :
                msg.rarity === "S" ? "rgba(46, 229, 157, 0.8)" :
                msg.rarity === "A" ? "rgba(255, 209, 102, 0.8)" :
                msg.rarity === "B" ? "rgba(255, 255, 255, 0.6)" :
                "var(--muted)";
              
              row.innerHTML = `
                <td style="padding: 8px; font-size: 11px; color: var(--muted);">${msg.turnIndex || idx}</td>
                <td style="padding: 8px; font-size: 11px; color: var(--muted);">${escapeHtml(msg.role || "—")}</td>
                <td style="padding: 8px; max-width: 300px; word-wrap: break-word;">${escapeHtml((msg.content || "").substring(0, 100))}${(msg.content || "").length > 100 ? "..." : ""}</td>
                <td style="padding: 8px; font-size: 11px;">${msg.score !== null && msg.score !== undefined ? msg.score : "—"}</td>
                <td style="padding: 8px; font-size: 11px; color: ${rarityColor};">${escapeHtml(msg.rarity || "—")}</td>
                <td style="padding: 8px; font-size: 11px; color: var(--muted);">${moodDelta}</td>
                <td style="padding: 8px; font-size: 11px; color: var(--muted);">${escapeHtml(gatesText)}</td>
              `;
              logTableBody.appendChild(row);
            });
          } catch (e) {
            logEmpty.style.display = "block";
            logTable.style.display = "none";
            console.error("Error loading session messages:", e);
          }
        }

        function duplicateMission() {
          const sid = state.selectedMissionId;
          if (!sid) return;
          const m = (state.missions || []).find((x) => x.id === sid);
          if (!m) return;

          state.selectedMissionId = null; // create NEW on save
          ui.missionTitleInput.value = (m.name || "Mission") + " (copy)";
          ui.difficultySelect.value = m.difficulty || "EASY";
          ui.categorySelect.value = m.categoryId || "";
          ui.personaSelect.value = m.personaId || "";
          ui.activeSelect.value = String(!!m.active);
          ui.codeInput.value = ""; // cleared intentionally

          // Use key-based selection (not ID)
          const styleKey = getMissionStyleKey(m);
          if (styleKey) {
            const style = findStyleByKey(styleKey);
            ui.aiStyleSelect.value = (style && style.key) ? style.key : "";
          } else {
            ui.aiStyleSelect.value = "";
          }
          state.aiStyleTouched = false;

          setAiContractTextarea(m.aiContract);
          
          // Hydrate structured dynamics fields from aiContract (same as selectMission)
          try {
            const contractJson = ui.aiContractJsonTextarea.value.trim();
            if (contractJson) {
              const parsed = JSON.parse(contractJson);
              const config = parsed.missionConfigV1 || parsed;
              
              // Dynamics Profile selector
              const dynamicsProfileSelect = document.getElementById("missionDynamicsProfileSelect");
              if (dynamicsProfileSelect) {
                const profileCode = config.dynamicsProfileCode || "";
                dynamicsProfileSelect.value = profileCode || "";
                onDynamicsProfileChange();
              }

              // Dynamics override toggle
              const overrideToggle = document.getElementById("missionDynamicsOverrideToggle");
              const hasDynamicsOverrides = config.dynamics && (
                config.dynamics.pace !== null && config.dynamics.pace !== undefined ||
                config.dynamics.emojiDensity !== null && config.dynamics.emojiDensity !== undefined ||
                config.dynamics.flirtiveness !== null && config.dynamics.flirtiveness !== undefined ||
                config.dynamics.hostility !== null && config.dynamics.hostility !== undefined ||
                config.dynamics.dryness !== null && config.dynamics.dryness !== undefined ||
                config.dynamics.vulnerability !== null && config.dynamics.vulnerability !== undefined ||
                config.dynamics.escalationSpeed !== null && config.dynamics.escalationSpeed !== undefined ||
                config.dynamics.randomness !== null && config.dynamics.randomness !== undefined
              );
              if (overrideToggle) {
                overrideToggle.checked = hasDynamicsOverrides;
                onDynamicsOverrideToggle();
              }
              
              if (config.dynamics) {
                const dyn = config.dynamics;
                const modeSelect = document.getElementById("missionDynamicsModeSelect");
                if (modeSelect) modeSelect.value = dyn.mode || "CHAT";
                
                const locationInput = document.getElementById("missionDynamicsLocationTagInput");
                if (locationInput) locationInput.value = dyn.locationTag || "DEFAULT";
                
                const timerCheckbox = document.getElementById("missionDynamicsHasPerMessageTimerCheckbox");
                if (timerCheckbox) timerCheckbox.checked = dyn.hasPerMessageTimer === true;
                
                const entryRouteSelect = document.getElementById("missionDynamicsDefaultEntryRouteSelect");
                if (entryRouteSelect) entryRouteSelect.value = dyn.defaultEntryRoute || "TEXT_CHAT";
                
                // Sliders with clamping (only if override is enabled)
                if (hasDynamicsOverrides) {
                  const setSlider = (id, valId, value) => {
                    const slider = document.getElementById(id);
                    const valSpan = document.getElementById(valId);
                    if (slider && valSpan) {
                      const clamped = Math.max(0, Math.min(100, Math.round(value || 50)));
                      slider.value = clamped;
                      valSpan.textContent = clamped;
                    }
                  };
                  
                  setSlider("missionDynPace", "missionDynPaceVal", dyn.pace);
                  setSlider("missionDynEmojiDensity", "missionDynEmojiDensityVal", dyn.emojiDensity);
                  setSlider("missionDynFlirtiveness", "missionDynFlirtivenessVal", dyn.flirtiveness);
                  setSlider("missionDynHostility", "missionDynHostilityVal", dyn.hostility);
                  setSlider("missionDynDryness", "missionDynDrynessVal", dyn.dryness);
                  setSlider("missionDynVulnerability", "missionDynVulnerabilityVal", dyn.vulnerability);
                  setSlider("missionDynEscalationSpeed", "missionDynEscalationSpeedVal", dyn.escalationSpeed);
                  setSlider("missionDynRandomness", "missionDynRandomnessVal", dyn.randomness);
                }
              }
              
              // Gate Requirement Pack selector
              const gatePackSelect = document.getElementById("missionGateRequirementPackSelect");
              if (gatePackSelect) {
                const gatePackCode = config.gateRequirementTemplateCode || "";
                gatePackSelect.value = gatePackCode || "";
                onGatePackChange();
              }

              // Backward compatibility
              if (config.statePolicy) {
                const gateCheckbox = document.getElementById("missionEnableGateSequenceCheckbox");
                if (gateCheckbox) gateCheckbox.checked = config.statePolicy.enableGateSequence === true;
              }
            }
          } catch (e) {
            // Silent fail on duplicate - JSON might be invalid, but don't block duplication
          }
          
          // Practice Hub Designer: Copy attraction fields
          if (hubUI && hubUI.missionIsAttractionSensitiveCheckbox) {
            hubUI.missionIsAttractionSensitiveCheckbox.checked = m.isAttractionSensitive === true;
            hubUI.missionTargetRomanticGenderSelect.value = m.targetRomanticGender || "";
            hubUI.missionTargetGenderField.style.display = 
              hubUI.missionIsAttractionSensitiveCheckbox.checked ? "block" : "none";
          }

          updateSelectionUI();
          updateMissionPreview();
          showOk("Duplicated into a NEW unsaved mission (code cleared).");
        }

        async function deleteMission() {
          const sid = state.selectedMissionId;
          if (!sid) return;

          const ok = confirm("Delete mission permanently?\n\n" + sid);
          if (!ok) return;

          await apiFetch(`/v1/admin/missions/${sid}`, { method: "DELETE" });
          showOk("Mission deleted.");

          await loadMissions();
          clearMissionForm();
        }

        async function saveMission() {
          const v = getMissionFormValues();
          if (!v.ok) {
            showError(v.error);
            return;
          }

          const payload = v.value;
          const sid = state.selectedMissionId;

          // Clear validation errors before save
          if (ui.missionValidationErrors) {
            ui.missionValidationErrors.style.display = "none";
            if (ui.missionValidationErrorsList) {
              ui.missionValidationErrorsList.innerHTML = "";
            }
          }
          clearError();

          try {
            if (sid) {
              await apiFetch(`/v1/admin/missions/${sid}`, {
                method: "PUT",
                body: JSON.stringify(payload),
              });
              showOk("Mission updated.");
            } else {
              await apiFetch(`/v1/admin/missions`, {
                method: "POST",
                body: JSON.stringify(payload),
              });
              showOk("Mission created.");
            }

            state.aiStyleTouched = false;
            await loadMissions();

            const best = (state.missions || []).find(
              (m) => m.name === payload.name && (payload.code ? m.code === payload.code : true)
            );
            if (best?.id) selectMission(best.id);
            else clearMissionForm();
          } catch (error) {
            // Try to parse structured validation errors
            let errorBody = null;
            
            // Check if error has responseJson attached (from apiFetch)
            if (error.responseJson && typeof error.responseJson === 'object') {
              errorBody = error.responseJson;
            } else {
              // Fallback: try to extract JSON from error message
              try {
                const errorText = error?.message || String(error);
                const jsonMatch = errorText.match(/\{[\s\S]*\}/);
                if (jsonMatch) {
                  errorBody = JSON.parse(jsonMatch[0]);
                }
              } catch (parseError) {
                // If parsing fails, fall back to generic error
              }
            }

            // Check if this is a structured validation error
            if (errorBody && 
                (errorBody.code === 'MISSION_TEMPLATE_INVALID_CONFIG' || errorBody.code === 'VALIDATION') &&
                Array.isArray(errorBody.details) && errorBody.details.length > 0) {
              
              // Show summary in main error box
              const errorCount = errorBody.details.length;
              showError(`Mission validation failed: ${errorCount} error${errorCount > 1 ? 's' : ''} in MissionConfigV1. See details below.`);
              
              // Populate structured error list
              if (ui.missionValidationErrors && ui.missionValidationErrorsList) {
                ui.missionValidationErrors.style.display = "block";
                ui.missionValidationErrorsList.innerHTML = "";
                
                errorBody.details.forEach((detail) => {
                  if (detail.path && detail.message) {
                    // Shorten path by removing leading "aiContract." if present
                    let displayPath = detail.path;
                    if (displayPath.startsWith('aiContract.')) {
                      displayPath = displayPath.substring('aiContract.'.length);
                    }
                    
                    const li = document.createElement("li");
                    li.textContent = `${displayPath}: ${detail.message}`;
                    ui.missionValidationErrorsList.appendChild(li);
                  }
                });
              }
            } else {
              // Fall back to generic error display
              showError(formatErrorForDisplay(error));
            }
          }
        }

        // ---------------------------
        // Phase 3: Builder UI Functions
        // ---------------------------
        function populateBuilderDefaults() {
          // Populate builder inputs from mission form fields
          if (ui.missionTitleInput && ui.builderUserTitleInput) {
            ui.builderUserTitleInput.value = ui.missionTitleInput.value || "";
          }
          if (ui.missionDescriptionInput && ui.builderUserDescriptionInput) {
            ui.builderUserDescriptionInput.value = ui.missionDescriptionInput.value || "";
          }
          if (ui.difficultySelect && ui.builderDifficultySelect) {
            ui.builderDifficultySelect.value = ui.difficultySelect.value || "EASY";
          }
          if (ui.aiStyleSelect && ui.builderAiStyleKeyInput) {
            const selectedStyle = getSelectedStyle();
            if (selectedStyle && selectedStyle.key) {
              ui.builderAiStyleKeyInput.value = String(selectedStyle.key).trim().toUpperCase();
            } else {
              ui.builderAiStyleKeyInput.value = "";
            }
          }
          if (ui.missionMaxMessagesInput && ui.builderMaxMessagesInput) {
            ui.builderMaxMessagesInput.value = ui.missionMaxMessagesInput.value || "";
          }
          if (ui.missionTimeLimitInput && ui.builderTimeLimitSecInput) {
            ui.builderTimeLimitSecInput.value = ui.missionTimeLimitInput.value || "";
          }
          if (ui.missionWordLimitInput && ui.builderWordLimitInput) {
            ui.builderWordLimitInput.value = ui.missionWordLimitInput.value || "";
          }
        }

        async function handleGenerateConfig() {
          const builderType = ui.builderTypeSelect.value;
          if (!builderType) {
            showError("Please select a builder type first.");
            return;
          }

          // Collect params
          const params = {
            difficultyLevel: ui.builderDifficultySelect.value || "EASY",
            aiStyleKey: (ui.builderAiStyleKeyInput.value || "").trim().toUpperCase(),
            maxMessages: parseInt(ui.builderMaxMessagesInput.value || "10", 10),
            timeLimitSec: parseInt(ui.builderTimeLimitSecInput.value || "0", 10),
            wordLimit: ui.builderWordLimitInput.value ? parseInt(ui.builderWordLimitInput.value, 10) : null,
            userTitle: (ui.builderUserTitleInput.value || "").trim(),
            userDescription: (ui.builderUserDescriptionInput.value || "").trim(),
          };

          // Add objectiveKind for OPENERS
          if (builderType === "OPENERS" && ui.builderObjectiveKindSelect) {
            params.objectiveKind = ui.builderObjectiveKindSelect.value || "PRACTICE_OPENING";
          }

          // Clear validation errors
          if (ui.missionValidationErrors) {
            ui.missionValidationErrors.style.display = "none";
            if (ui.missionValidationErrorsList) {
              ui.missionValidationErrorsList.innerHTML = "";
            }
          }
          clearError();

          try {
            const response = await apiFetch("/v1/admin/missions/generate-config", {
              method: "POST",
              body: JSON.stringify({
                builderType: builderType,
                params: params,
              }),
            });

            if (response.ok && response.generatedAiContract) {
              // Inject generated config into textarea as wrapped contract
              const wrappedContract = response.generatedAiContract;
              ui.aiContractJsonTextarea.value = JSON.stringify(wrappedContract, null, 2);
              updateContractValidity();
              showOk("Config generated and injected into textarea. You can edit it manually if needed.");
            } else {
              showError("Unexpected response from generate-config endpoint.");
            }
          } catch (error) {
            // Handle structured errors
            let errorBody = null;
            if (error.responseJson && typeof error.responseJson === 'object') {
              errorBody = error.responseJson;
            } else {
              try {
                const errorText = error?.message || String(error);
                const jsonMatch = errorText.match(/\{[\s\S]*\}/);
                if (jsonMatch) {
                  errorBody = JSON.parse(jsonMatch[0]);
                }
              } catch (parseError) {
                // Fall back to generic error
              }
            }

            if (errorBody && 
                (errorBody.code === 'VALIDATION' || errorBody.code === 'MISSION_TEMPLATE_INVALID_CONFIG') &&
                Array.isArray(errorBody.details) && errorBody.details.length > 0) {
              const errorCount = errorBody.details.length;
              showError(`Config generation failed: ${errorCount} error${errorCount > 1 ? 's' : ''}. See details below.`);
              
              if (ui.missionValidationErrors && ui.missionValidationErrorsList) {
                ui.missionValidationErrors.style.display = "block";
                ui.missionValidationErrorsList.innerHTML = "";
                
                errorBody.details.forEach((detail) => {
                  if (detail.path && detail.message) {
                    const li = document.createElement("li");
                    li.textContent = `${detail.path}: ${detail.message}`;
                    ui.missionValidationErrorsList.appendChild(li);
                  }
                });
              }
            } else {
              showError(formatErrorForDisplay(error));
            }
          }
        }

        async function handleValidateConfig() {
          // Get current textarea content
          const textareaContent = (ui.aiContractJsonTextarea.value || "").trim();
          if (!textareaContent) {
            showError("Textarea is empty. Please paste or generate a config first.");
            return;
          }

          // Parse JSON
          let aiContract;
          try {
            const parsed = JSON.parse(textareaContent);
            // If it's raw MissionConfigV1, wrap it
            if (parsed.version === 1 && parsed.dynamics && parsed.objective) {
              aiContract = { missionConfigV1: parsed };
            } else if (parsed.missionConfigV1) {
              aiContract = parsed;
            } else {
              aiContract = parsed;
            }
          } catch (e) {
            showError("Invalid JSON in textarea: " + formatErrorForDisplay(e));
            return;
          }

          // Clear validation errors
          if (ui.missionValidationErrors) {
            ui.missionValidationErrors.style.display = "none";
            if (ui.missionValidationErrorsList) {
              ui.missionValidationErrorsList.innerHTML = "";
            }
          }
          clearError();

          try {
            const response = await apiFetch("/v1/admin/missions/validate-config", {
              method: "POST",
              body: JSON.stringify({
                aiContract: aiContract,
              }),
            });

            if (response.ok && response.normalizedAiContract) {
              // Show success and optionally replace with normalized version
              showOk("Config is valid! Normalized version available.");
              // Optionally replace textarea with normalized wrapped config
              ui.aiContractJsonTextarea.value = JSON.stringify(response.normalizedAiContract, null, 2);
              updateContractValidity();
            } else {
              showError("Unexpected response from validate-config endpoint.");
            }
          } catch (error) {
            // Handle structured errors
            let errorBody = null;
            if (error.responseJson && typeof error.responseJson === 'object') {
              errorBody = error.responseJson;
            } else {
              try {
                const errorText = error?.message || String(error);
                const jsonMatch = errorText.match(/\{[\s\S]*\}/);
                if (jsonMatch) {
                  errorBody = JSON.parse(jsonMatch[0]);
                }
              } catch (parseError) {
                // Fall back to generic error
              }
            }

            if (errorBody && 
                (errorBody.code === 'VALIDATION' || errorBody.code === 'MISSION_TEMPLATE_INVALID_CONFIG') &&
                Array.isArray(errorBody.details) && errorBody.details.length > 0) {
              const errorCount = errorBody.details.length;
              showError(`Config validation failed: ${errorCount} error${errorCount > 1 ? 's' : ''}. See details below.`);
              
              if (ui.missionValidationErrors && ui.missionValidationErrorsList) {
                ui.missionValidationErrors.style.display = "block";
                ui.missionValidationErrorsList.innerHTML = "";
                
                errorBody.details.forEach((detail) => {
                  if (detail.path && detail.message) {
                    let displayPath = detail.path;
                    if (displayPath.startsWith('aiContract.')) {
                      displayPath = displayPath.substring('aiContract.'.length);
                    }
                    const li = document.createElement("li");
                    li.textContent = `${displayPath}: ${detail.message}`;
                    ui.missionValidationErrorsList.appendChild(li);
                  }
                });
              }
            } else {
              showError(formatErrorForDisplay(error));
            }
          }
        }

        // ---------------------------
        // Settings
        // ---------------------------
        function loadSettings() {
          const apiBase = localStorage.getItem(STORAGE_KEYS.apiBase) || "";
          const jwt = localStorage.getItem(STORAGE_KEYS.jwt) || "";
          ui.apiBaseInput.value = apiBase;
          ui.jwtInput.value = jwt;
        }

        function saveSettings() {
          localStorage.setItem(STORAGE_KEYS.apiBase, getApiBase());
          localStorage.setItem(STORAGE_KEYS.jwt, getJwt());
          showOk("Settings saved.");
        }

        // Step 1: Login function to get JWT (bypasses JWT requirement)
        async function handleLogin() {
          const emailInput = document.getElementById("loginEmailInput");
          const passwordInput = document.getElementById("loginPasswordInput");
          
          if (!emailInput || !passwordInput) {
            showError("Login form elements not found");
            return;
          }
          if (!(emailInput instanceof HTMLInputElement) || !(passwordInput instanceof HTMLInputElement)) {
            showError("Login form elements are not input elements");
            return;
          }
          
          const email = emailInput.value.trim();
          const password = passwordInput.value;
          
          if (!email || !password) {
            showError("Email and password are required");
            return;
          }
          
          try {
            // Login endpoint doesn't require JWT, so use direct fetch
            const url = buildUrl("/v1/auth/login");
            const response = await fetch(url, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ email, password }),
            });
            
            const text = await response.text();
            let json = null;
            if (text) {
              try {
                json = JSON.parse(text);
              } catch {
                // leave as raw text
              }
            }
            
            if (!response.ok) {
              const error = new Error(`HTTP ${response.status} ${response.statusText}`);
              if (json) {
                error.responseJson = json;
              } else if (text) {
                error.responseText = text;
              }
              throw error;
            }
            
            if (json && json.accessToken) {
              const jwtInput = document.getElementById("jwtInput");
              if (jwtInput && jwtInput instanceof HTMLInputElement) {
                jwtInput.value = json.accessToken;
                localStorage.setItem(STORAGE_KEYS.jwt, json.accessToken);
                showOk("Login successful! JWT token saved.");
                log("JWT token obtained and saved from login");
                // Clear password field
                passwordInput.value = "";
              } else {
                showError("JWT input field not found");
              }
            } else {
              showError("Login response missing accessToken");
            }
          } catch (e) {
            showError("Login failed: " + formatErrorForDisplay(e));
          }
        }

        // ---------------------------
        // Click binding helper (with instrumentation)
        // ---------------------------
        function bindClick(el, name, fn) {
          if (!el) {
            log("WARN: cannot bind " + name);
            return;
          }
          el.addEventListener("click", (e) => {
            e.preventDefault?.();
            log("CLICK: " + name);
            fn(e);
          });
        }

        // ---------------------------
        // Event wiring (single place)
        // ---------------------------
        // ---------------------------
        // v2 Mode Switching & Rendering
        // ---------------------------
        function initV2ModeSwitcher() {
          const engineMapBtn = document.getElementById("v2ModeEngineMap");
          const practiceHubBtn = document.getElementById("v2ModePracticeHub");
          const mainLayout = document.getElementById("v2MainLayout");
          const legacyLayout = document.getElementById("legacyLayout");

          if (!engineMapBtn || !practiceHubBtn) return;

          function switchMode(mode) {
            v2State.currentMode = mode;
            
            // Update button states
            engineMapBtn.classList.toggle("active", mode === "engine-map");
            practiceHubBtn.classList.toggle("active", mode === "practice-hub");
            
            // Show/hide layouts - v2 is active when mode is one of the two valid modes
            const isV2Mode = mode === "engine-map" || mode === "practice-hub";
            if (mainLayout) mainLayout.style.display = isV2Mode ? "grid" : "none";
            if (legacyLayout) legacyLayout.style.display = isV2Mode ? "none" : "grid";
            
            // Render appropriate canvas
            if (mode === "engine-map") {
              renderEngineMap();
            } else if (mode === "practice-hub") {
              renderPracticeHub();
            }
          }

          engineMapBtn.addEventListener("click", () => switchMode("engine-map"));
          practiceHubBtn.addEventListener("click", () => switchMode("practice-hub"));
          
          // Start with engine-map mode
          switchMode("engine-map");
        }

        function renderEngineMap() {
          const canvas = document.getElementById("v2Canvas");
          if (!canvas) return;

          canvas.innerHTML = `
            <div class="engine-map-container">
              <svg style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none;">
                <!-- Edges connecting nodes -->
                <line x1="90" y1="80" x2="240" y2="80" stroke="rgba(255, 255, 255, 0.3)" stroke-width="2" />
                <line x1="240" y1="80" x2="190" y2="180" stroke="rgba(255, 255, 255, 0.3)" stroke-width="2" />
                <line x1="190" y1="180" x2="90" y2="330" stroke="rgba(255, 255, 255, 0.3)" stroke-width="2" />
                <line x1="90" y1="330" x2="240" y2="330" stroke="rgba(255, 255, 255, 0.3)" stroke-width="2" />
                <line x1="240" y1="330" x2="190" y2="480" stroke="rgba(255, 255, 255, 0.3)" stroke-width="2" />
              </svg>
              <div class="engine-node" data-node="mission-begin" style="top: 50px; left: 50px;">
                <div class="engine-node-icon">🚀</div>
                <div class="engine-node-title">Mission Begin</div>
              </div>
              <div class="engine-node" data-node="ai-engine-layers" style="top: 50px; left: 250px;">
                <div class="engine-node-icon">⚙️</div>
                <div class="engine-node-title">AI Engine Layers</div>
              </div>
              <div class="engine-node" data-node="micro-feedback" style="top: 200px; left: 150px;">
                <div class="engine-node-icon">💬</div>
                <div class="engine-node-title">Micro Feedback</div>
              </div>
              <div class="engine-node" data-node="mission-end" style="top: 350px; left: 50px;">
                <div class="engine-node-icon">🏁</div>
                <div class="engine-node-title">Mission End</div>
              </div>
              <div class="engine-node" data-node="mission-review" style="top: 350px; left: 250px;">
                <div class="engine-node-icon">📊</div>
                <div class="engine-node-title">Mission Review</div>
              </div>
              <div class="engine-node" data-node="stats-updates" style="top: 500px; left: 150px;">
                <div class="engine-node-icon">📈</div>
                <div class="engine-node-title">Stats Updates</div>
              </div>
            </div>
          `;

          // Wire node clicks
          canvas.querySelectorAll(".engine-node").forEach(node => {
            node.addEventListener("click", (e) => {
              const nodeId = e.currentTarget.getAttribute("data-node");
              selectEngineNode(nodeId);
            });
          });
        }

        function renderPracticeHub() {
          const canvas = document.getElementById("v2Canvas");
          if (!canvas) return;

          if (v2State.categories.length === 0) {
            canvas.innerHTML = `
              <div style="text-align: center; padding: 60px 20px; color: var(--muted);">
                <div style="font-size: 48px; margin-bottom: 16px;">📚</div>
                <div style="font-size: 16px; margin-bottom: 8px;">No categories loaded</div>
                <div style="font-size: 12px;">Click "Load Everything" to load categories and missions</div>
              </div>
            `;
            return;
          }

          let html = '<div class="practice-hub-container">';
          
          v2State.categories.forEach(category => {
            const categoryMissions = v2State.missions.filter(m => m.categoryId === category.id);
            html += `
              <div class="category-row">
                <div class="category-header">
                  <div class="category-title">${escapeHtml(category.label || category.name || "Unnamed")}</div>
                  <div class="category-actions">
                    <button class="btn" onclick="editCategory('${category.id}')" title="Edit Category">✏️</button>
                    <button class="btn" onclick="createMissionInCategory('${category.id}')" title="Create Mission">+</button>
                  </div>
                </div>
                <div class="missions-row" data-category-id="${category.id}" ondrop="v2HandleDrop(event)" ondragover="v2HandleDragOver(event)" ondragleave="v2HandleDragLeave(event)">
                  ${categoryMissions.map((mission, idx) => `
                    <div class="mission-card" 
                         draggable="true" 
                         data-mission-id="${mission.id}" 
                         data-category-id="${category.id}"
                         data-order-index="${idx}"
                         ondragstart="v2HandleDragStart(event, '${mission.id}', '${category.id}')"
                         ondragend="v2HandleDragEnd(event)"
                         onclick="selectMissionForEdit('${mission.id}')">
                      <div class="mission-card-code">${escapeHtml(mission.code || mission.id)}</div>
                      <div class="mission-card-title">${escapeHtml(mission.title || mission.name || "Unnamed")}</div>
                      <div class="mission-card-subtitle">${escapeHtml(mission.description || "")}</div>
                    </div>
                  `).join("")}
                </div>
              </div>
            `;
          });
          
          html += '</div>';
          canvas.innerHTML = html;
        }

        function selectEngineNode(nodeId) {
          v2State.selectedNode = nodeId;
          
          // Update visual state
          document.querySelectorAll(".engine-node").forEach(node => {
            node.classList.toggle("active", node.getAttribute("data-node") === nodeId);
          });
          
          // Update inspector
          renderInspectorForNode(nodeId);
        }

        function renderInspectorForNode(nodeId) {
          const inspector = document.getElementById("v2Inspector");
          if (!inspector) return;

          const nodeConfig = {
            "mission-begin": { title: "Mission Begin", editor: "personasEditor", type: "personas" },
            "ai-engine-layers": { title: "AI Engine Layers", editor: "engineConfigEditor", type: "engine-config" },
            "micro-feedback": { title: "Micro Feedback", editor: "microFeedbackEditor", type: "micro-feedback" },
            "mission-end": { title: "Mission End", editor: "hooksEditor", type: "hooks" },
            "mission-review": { title: "Mission Review", editor: "hooksEditor", type: "hooks" },
            "stats-updates": { title: "Stats Updates", editor: "hooksEditor", type: "hooks" },
          };

          const config = nodeConfig[nodeId];
          if (!config) {
            inspector.innerHTML = '<div style="color: var(--muted);">Unknown node</div>';
            return;
          }

          let editorButton = '';
          if (config.type === 'personas') {
            editorButton = '<button class="btn" onclick="openPersonasEditor()" style="width: 100%; margin-bottom: 8px;">Personas</button><button class="btn" onclick="openAiStylesEditor()" style="width: 100%;">AI Styles</button>';
          } else if (config.type === 'hooks') {
            editorButton = '<button class="btn" onclick="openHooksEditor()" style="width: 100%;">Hooks</button>';
          } else if (config.type === 'engine-config') {
            editorButton = '<button class="btn" onclick="openScoringProfilesEditor()" style="width: 100%; margin-bottom: 8px;">Scoring Profiles</button><button class="btn" onclick="openDynamicsProfilesEditor()" style="width: 100%; margin-bottom: 8px;">Dynamics Profiles</button><button class="btn" onclick="openGateSetsEditor()" style="width: 100%; margin-bottom: 8px;">Gate Sets</button><button class="btn" onclick="openObjectivesEditor()" style="width: 100%;">Objectives</button>';
          } else if (config.type === 'micro-feedback') {
            editorButton = '<button class="btn" onclick="openMicroFeedbackEditor()" style="width: 100%;">Micro Feedback</button>';
          } else {
            editorButton = `<button class="btn" onclick="openNodeEditor('${nodeId}')" style="width: 100%;">Open Editor</button>`;
          }

          inspector.innerHTML = `
            <div style="margin-bottom: 16px;">
              <div style="font-weight: 700; font-size: 16px; margin-bottom: 8px;">${config.title}</div>
              ${editorButton}
            </div>
            <div style="color: var(--muted); font-size: 12px;">
              Click a button to configure this node
            </div>
          `;
        }

        function openNodeEditor(nodeId) {
          // Route to appropriate editor based on node type
          if (nodeId === "ai-engine-layers") {
            // AI Engine Layers node - show engine config editors
            openScoringProfilesEditor();
          } else if (nodeId === "mission-begin") {
            // Mission Begin - could open seed selector, but for now show Personas
            openPersonasEditor();
          } else if (nodeId === "micro-feedback") {
            // Micro Feedback - show micro feedback editor
            openMicroFeedbackEditor();
          } else if (nodeId === "mission-review") {
            // Mission Review - show Hooks editor (insights/hooks)
            openHooksEditor();
          } else {
            // Default: try to open based on node name
            if (nodeId.includes("persona") || nodeId.includes("ai")) {
              openPersonasEditor();
            } else if (nodeId.includes("hook") || nodeId.includes("trigger")) {
              openHooksEditor();
            } else {
              showToast("Editor for " + nodeId + " - Coming soon", "info");
            }
          }
        }

        function selectMissionForEdit(missionId) {
          // Ensure we're in v2 mode and legacy UI is hidden
          if (v2State.currentMode !== "practice-hub" && v2State.currentMode !== "engine-map") {
            v2State.currentMode = "practice-hub";
            const mainLayout = document.getElementById("v2MainLayout");
            const legacyLayout = document.getElementById("legacyLayout");
            if (mainLayout) mainLayout.style.display = "grid";
            if (legacyLayout) legacyLayout.style.display = "none";
          }
          v2State.selectedMission = missionId;
          openMissionBuilderModal(missionId);
        }

        function createMissionInCategory(categoryId) {
          // Ensure we're in v2 mode and legacy UI is hidden
          if (v2State.currentMode !== "practice-hub" && v2State.currentMode !== "engine-map") {
            v2State.currentMode = "practice-hub";
            const mainLayout = document.getElementById("v2MainLayout");
            const legacyLayout = document.getElementById("legacyLayout");
            if (mainLayout) mainLayout.style.display = "grid";
            if (legacyLayout) legacyLayout.style.display = "none";
          }
          v2State.selectedCategory = categoryId;
          openMissionBuilderModal(null, categoryId);
        }

        async function openMissionBuilderModal(missionId, categoryId) {
          const modal = document.getElementById("missionBuilderModal");
          const content = document.getElementById("missionBuilderContent");
          const title = document.getElementById("missionBuilderTitle");
          
          if (!modal || !content) return;

          const isEdit = !!missionId;
          title.textContent = isEdit ? "Edit Mission" : "Create Mission";
          
          // Load mission data if editing
          let missionData = null;
          if (isEdit) {
            try {
              const mission = v2State.missions.find(m => m.id === missionId);
              if (mission) missionData = mission;
            } catch (e) {
              log(`Failed to load mission: ${e?.message || e}`);
            }
          }

          // Get category defaults if categoryId provided
          let categoryDefaults = null;
          if (categoryId) {
            const category = v2State.categories.find(c => c.id === categoryId);
            if (category) {
              // TODO: Load category defaults from category config
              categoryDefaults = {
                dynamicsProfileCode: category.dynamicsProfileCode || null,
                scoringProfileCode: category.scoringProfileCode || null,
                microFeedbackProfileCode: category.microFeedbackProfileCode || null,
                insightPackCode: category.insightPackCode || null,
              };
            }
          }

          // Render Mission Builder form
          content.innerHTML = `
            <form id="missionBuilderForm" onsubmit="return false;">
              <!-- Mission Meta (Required) -->
              <div style="margin-bottom: 24px; padding-bottom: 20px; border-bottom: 1px solid var(--line);">
                <div style="font-weight: 700; font-size: 14px; margin-bottom: 16px; color: var(--text);">Mission Meta (Required)</div>
                <div class="field">
                  <label>Code <span style="color: var(--bad);">*</span></label>
                  <input type="text" id="mbCode" value="${missionData?.code || ""}" placeholder="e.g. OPENERS_CONFIDENT_L1" required />
                </div>
                <div class="field">
                  <label>Title <span style="color: var(--bad);">*</span></label>
                  <input type="text" id="mbTitle" value="${missionData?.title || missionData?.name || ""}" placeholder="Mission title" required />
                </div>
                <div class="field">
                  <label>Description</label>
                  <textarea id="mbDescription" rows="2" placeholder="Mission description">${missionData?.description || ""}</textarea>
                </div>
                <div class="split3">
                  <div class="field">
                    <label>Category <span style="color: var(--bad);">*</span></label>
                    <select id="mbCategory" required>
                      <option value="">Select category...</option>
                      ${v2State.categories.map(cat => `
                        <option value="${cat.id}" ${(categoryId === cat.id || missionData?.categoryId === cat.id) ? "selected" : ""}>
                          ${escapeHtml(cat.label || cat.name || cat.code)}
                        </option>
                      `).join("")}
                    </select>
                  </div>
                  <div class="field">
                    <label>Active</label>
                    <select id="mbActive">
                      <option value="true" ${missionData?.active !== false ? "selected" : ""}>Active</option>
                      <option value="false" ${missionData?.active === false ? "selected" : ""}>Inactive</option>
                    </select>
                  </div>
                  <div class="field">
                    <label>Difficulty</label>
                    <select id="mbDifficulty">
                      <option value="EASY" ${missionData?.difficulty === "EASY" ? "selected" : ""}>EASY</option>
                      <option value="MEDIUM" ${missionData?.difficulty === "MEDIUM" ? "selected" : ""}>MEDIUM</option>
                      <option value="HARD" ${missionData?.difficulty === "HARD" ? "selected" : ""}>HARD</option>
                      <option value="ELITE" ${missionData?.difficulty === "ELITE" ? "selected" : ""}>ELITE</option>
                    </select>
                  </div>
                </div>
              </div>

              <!-- Openings (Required) -->
              <div style="margin-bottom: 24px; padding-bottom: 20px; border-bottom: 1px solid var(--line);">
                <div style="font-weight: 700; font-size: 14px; margin-bottom: 16px; color: var(--text);">Openings (Required)</div>
                <div class="field">
                  <label>Opening Template <span style="color: var(--bad);">*</span></label>
                  <select id="mbOpeningTemplate" required>
                    <option value="">Select opening template...</option>
                    <!-- Will be populated from /v1/admin/prompts/openings -->
                  </select>
                </div>
                <div id="mbOpeningsList" style="margin-top: 12px;">
                  <!-- Opening strings will be listed here -->
                </div>
                <button type="button" class="btn" onclick="addOpeningString()" style="margin-top: 8px;">+ Add Opening String</button>
              </div>

              <!-- Limits & Runtime (Required) -->
              <div style="margin-bottom: 24px; padding-bottom: 20px; border-bottom: 1px solid var(--line);">
                <div style="font-weight: 700; font-size: 14px; margin-bottom: 16px; color: var(--text);">Limits & Runtime (Required)</div>
                <div class="split3">
                  <div class="field">
                    <label>Time Limit (seconds) <span style="color: var(--bad);">*</span></label>
                    <input type="number" id="mbTimeLimit" value="${missionData?.timeLimitSec || 30}" min="0" required />
                  </div>
                  <div class="field">
                    <label>Max Messages <span style="color: var(--bad);">*</span></label>
                    <input type="number" id="mbMaxMessages" value="${missionData?.maxMessages || ""}" min="1" required />
                  </div>
                  <div class="field">
                    <label>Word Limit</label>
                    <input type="number" id="mbWordLimit" value="${missionData?.wordLimit || ""}" min="1" />
                  </div>
                </div>
              </div>

              <!-- Picks (Required) -->
              <div style="margin-bottom: 24px; padding-bottom: 20px; border-bottom: 1px solid var(--line);">
                <div style="font-weight: 700; font-size: 14px; margin-bottom: 16px; color: var(--text);">Required Picks</div>
                <div class="split3">
                  <div class="field">
                    <label>Persona <span style="color: var(--bad);">*</span></label>
                    <select id="mbPersona" required>
                      <option value="">Select persona...</option>
                      ${v2State.personas.map(p => `
                        <option value="${p.id}" ${missionData?.personaId === p.id ? "selected" : ""}>
                          ${escapeHtml(p.name || p.code)}
                        </option>
                      `).join("")}
                    </select>
                  </div>
                  <div class="field">
                    <label>AI Style <span style="color: var(--bad);">*</span></label>
                    <select id="mbAiStyle" required>
                      <option value="">Select AI style...</option>
                      ${v2State.aiStyles.map(s => `
                        <option value="${s.id}" ${missionData?.aiStyleId === s.id ? "selected" : ""}>
                          ${escapeHtml(s.name || s.key)}
                        </option>
                      `).join("")}
                    </select>
                  </div>
                  <div class="field">
                    <label>Objective <span style="color: var(--bad);">*</span></label>
                    <select id="mbObjective" required>
                      <option value="">Select objective...</option>
                      <!-- Will be populated from EngineConfig gateRequirementTemplates -->
                    </select>
                  </div>
                </div>
                <div class="field" style="margin-top: 12px;">
                  <label>Gate Set <span style="color: var(--bad);">*</span></label>
                  <select id="mbGateSet" required>
                    <option value="">Select gate set...</option>
                    <!-- Will be populated from EngineConfig gates -->
                  </select>
                </div>
              </div>

              <!-- Locked (Category Defaults) -->
              ${categoryDefaults ? `
                <div style="margin-bottom: 24px; padding-bottom: 20px; border-bottom: 1px solid var(--line);">
                  <div style="font-weight: 700; font-size: 14px; margin-bottom: 16px; color: var(--muted);">Category Defaults (Locked)</div>
                  <div style="color: var(--muted); font-size: 12px; padding: 12px; background: var(--panel); border-radius: 8px;">
                    <div>Dynamics: ${categoryDefaults.dynamicsProfileCode || "Default"}</div>
                    <div>Scoring: ${categoryDefaults.scoringProfileCode || "Default"}</div>
                    <div>Micro Feedback: ${categoryDefaults.microFeedbackProfileCode || "Default"}</div>
                    <div>Insight Pack: ${categoryDefaults.insightPackCode || "Default"}</div>
                  </div>
                </div>
              ` : ""}

              <!-- Validation Errors -->
              <div id="mbValidationErrors" style="display: none; margin-bottom: 20px; padding: 12px; background: rgba(255, 92, 122, 0.1); border: 1px solid rgba(255, 92, 122, 0.3); border-radius: 8px; color: rgba(255, 92, 122, 0.95);">
                <div style="font-weight: 700; margin-bottom: 8px;">Validation Errors:</div>
                <ul id="mbValidationErrorsList" style="margin: 0; padding-left: 20px;"></ul>
              </div>

              <!-- Actions -->
              <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 24px;">
                <button type="button" class="btn" onclick="closeMissionBuilderModal()">Cancel</button>
                <button type="button" class="btn" onclick="validateMissionBuilder()" style="background: var(--warn);">Validate</button>
                <button type="submit" class="btn" style="background: var(--ok);">${isEdit ? "Save" : "Create"}</button>
              </div>
            </form>
          `;

          // Populate openings, objectives, gate sets from EngineConfig
          populateMissionBuilderSelectors();
          
          // Wire form submit
          const form = document.getElementById("missionBuilderForm");
          if (form) {
            form.addEventListener("submit", async (e) => {
              e.preventDefault();
              await saveMissionFromBuilder(missionId);
            });
          }
          
          modal.classList.add("active");
        }

        function populateMissionBuilderSelectors() {
          // Populate openings
          if (v2State.engineConfig && typeof loadOpenings === "function") {
            loadOpenings().then(() => {
              const openings = engineConfigState.openings || [];
              const select = document.getElementById("mbOpeningTemplate");
              if (select) {
                openings.forEach(op => {
                  const option = document.createElement("option");
                  option.value = op.key || op.id;
                  option.textContent = op.name || op.key;
                  select.appendChild(option);
                });
              }
            });
          }

          // Populate objectives from EngineConfig
          if (v2State.engineConfig && v2State.engineConfig.gateRequirementTemplates) {
            const select = document.getElementById("mbObjective");
            if (select) {
              v2State.engineConfig.gateRequirementTemplates.forEach(obj => {
                const option = document.createElement("option");
                option.value = obj.code;
                option.textContent = `${obj.name} (${obj.code})`;
                select.appendChild(option);
              });
            }
          }

          // Populate gate sets from EngineConfig
          if (v2State.engineConfig && v2State.engineConfig.gates) {
            const select = document.getElementById("mbGateSet");
            if (select) {
              v2State.engineConfig.gates.forEach(gate => {
                const option = document.createElement("option");
                option.value = gate.key;
                option.textContent = `${gate.description || gate.key}`;
                select.appendChild(option);
              });
            }
          }
        }

        function addOpeningString() {
          const container = document.getElementById("mbOpeningsList");
          if (!container) return;
          
          const div = document.createElement("div");
          div.className = "field";
          div.style.marginTop = "8px";
          div.innerHTML = `
            <input type="text" placeholder="Opening string" class="mb-opening-string" />
            <button type="button" class="btn" onclick="this.parentElement.remove()" style="margin-top: 4px; padding: 4px 8px; font-size: 11px;">Remove</button>
          `;
          container.appendChild(div);
        }

        async function validateMissionBuilder() {
          const errors = [];
          const requiredFields = [
            { id: "mbCode", name: "Code" },
            { id: "mbTitle", name: "Title" },
            { id: "mbCategory", name: "Category" },
            { id: "mbTimeLimit", name: "Time Limit" },
            { id: "mbMaxMessages", name: "Max Messages" },
            { id: "mbPersona", name: "Persona" },
            { id: "mbAiStyle", name: "AI Style" },
            { id: "mbObjective", name: "Objective" },
            { id: "mbGateSet", name: "Gate Set" },
          ];

          // Clear previous validation
          requiredFields.forEach(field => {
            const el = document.getElementById(field.id);
            if (el) {
              el.classList.remove("field-required", "field-pulse");
            }
          });

          // Check required fields
          requiredFields.forEach(field => {
            const el = document.getElementById(field.id);
            if (!el || !el.value || el.value.trim() === "") {
              errors.push(`${field.name} is required`);
              if (el) {
                el.classList.add("field-required", "field-pulse");
              }
            }
          });

          // Show errors
          const errorDiv = document.getElementById("mbValidationErrors");
          const errorList = document.getElementById("mbValidationErrorsList");
          if (errors.length > 0) {
            if (errorDiv) errorDiv.style.display = "block";
            if (errorList) {
              errorList.innerHTML = errors.map(e => `<li>${escapeHtml(e)}</li>`).join("");
            }
            showToast("Please fill in all required fields", "error");
          } else {
            if (errorDiv) errorDiv.style.display = "none";
            showToast("All required fields are filled", "success");
          }
        }

        async function saveMissionFromBuilder(missionId) {
          // Validate first
          await validateMissionBuilder();
          const errorDiv = document.getElementById("mbValidationErrors");
          if (errorDiv && errorDiv.style.display !== "none") {
            return; // Don't save if validation errors exist
          }

          // Collect form values
          const formData = {
            code: document.getElementById("mbCode")?.value,
            title: document.getElementById("mbTitle")?.value,
            description: document.getElementById("mbDescription")?.value || null,
            categoryId: document.getElementById("mbCategory")?.value,
            active: document.getElementById("mbActive")?.value === "true",
            difficulty: document.getElementById("mbDifficulty")?.value,
            timeLimitSec: parseInt(document.getElementById("mbTimeLimit")?.value || "30"),
            maxMessages: parseInt(document.getElementById("mbMaxMessages")?.value || "10"),
            wordLimit: document.getElementById("mbWordLimit")?.value ? parseInt(document.getElementById("mbWordLimit").value) : null,
            personaId: document.getElementById("mbPersona")?.value,
            aiStyleId: document.getElementById("mbAiStyle")?.value,
          };

          // Build aiContract from form data
          const objectiveCode = document.getElementById("mbObjective")?.value;
          const gateSetKey = document.getElementById("mbGateSet")?.value;
          
          // Get category defaults if available
          const categoryId = formData.categoryId;
          const category = v2State.categories.find(c => c.id === categoryId);
          const categoryDefaults = category ? {
            dynamicsProfileCode: category.dynamicsProfileCode || null,
            scoringProfileCode: category.scoringProfileCode || null,
            microFeedbackProfileCode: category.microFeedbackProfileCode || null,
            insightPackCode: category.insightPackCode || null,
          } : null;

          // Look up AI Style key from aiStyleId
          const aiStyle = v2State.aiStyles.find(s => s.id === formData.aiStyleId);
          const aiStyleKey = aiStyle?.key || null;

          // Build MissionConfigV1 using builder pattern (simplified)
          // Full implementation would use /v1/admin/missions/generate-config endpoint
          const missionConfigV1 = {
            version: 1,
            dynamics: {
              mode: "CHAT",
              locationTag: "APP_CHAT",
              hasPerMessageTimer: formData.timeLimitSec > 0,
              defaultEntryRoute: "TEXT_CHAT",
            },
            objective: {
              kind: "PRACTICE_OPENING", // Default, should come from objective selection
              userTitle: formData.title,
              userDescription: formData.description || "",
            },
            difficulty: {
              level: formData.difficulty || "EASY",
              recommendedMaxMessages: formData.maxMessages || null,
              recommendedSuccessScore: null,
              recommendedFailScore: null,
            },
            style: {
              aiStyleKey: aiStyleKey,
            },
            statePolicy: {
              maxMessages: formData.maxMessages || 10,
              minMessagesBeforeEnd: 1,
              maxStrikes: 3,
              timerSecondsPerMessage: formData.timeLimitSec || 30,
              allowTimerExtension: true,
              successScoreThreshold: 70,
              failScoreThreshold: 40,
              enableGateSequence: true,
              enableMoodCollapse: true,
              enableObjectiveAutoSuccess: false,
              allowedEndReasons: ["SUCCESS", "FAIL", "ABANDON", "TIMEOUT"],
            },
            gateRequirementTemplateCode: objectiveCode || null,
            scoringProfileCode: categoryDefaults?.scoringProfileCode || null,
            dynamicsProfileCode: categoryDefaults?.dynamicsProfileCode || null,
          };

          // Build openings if provided
          const openingTemplateKey = document.getElementById("mbOpeningTemplate")?.value;
          const openingStrings = Array.from(document.querySelectorAll(".mb-opening-string"))
            .map(el => {
              const input = el;
              return input instanceof HTMLInputElement ? input.value : "";
            })
            .filter(v => v.trim());
          
          if (openingTemplateKey || openingStrings.length > 0) {
            missionConfigV1.openings = {
              style: null,
              energy: 50,
              curiosity: 50,
              personaInitMood: null,
            };
          }

          formData.aiContract = {
            missionConfigV1: missionConfigV1,
          };

          try {
            if (missionId) {
              // Update existing
              await apiFetch(`/v1/admin/missions/${missionId}`, {
                method: "PUT",
                body: JSON.stringify(formData),
              });
              showToast("Mission updated successfully", "success");
            } else {
              // Create new
              await apiFetch("/v1/admin/missions", {
                method: "POST",
                body: JSON.stringify(formData),
              });
              showToast("Mission created successfully", "success");
            }
            
            // Reload missions and refresh Practice Hub
            await loadMissions();
            if (v2State.currentMode === "practice-hub") {
              renderPracticeHub();
            }
            
            closeMissionBuilderModal();
          } catch (e) {
            showToast("Failed to save mission: " + (e?.message || e), "error");
          }
        }

        window.addOpeningString = addOpeningString;
        window.validateMissionBuilder = validateMissionBuilder;

        // ---------------------------
        // Config Slots Functions
        // ---------------------------
        async function loadConfigSlots() {
          try {
            const res = await apiFetch("/v1/admin/config-slots", { method: "GET" });
            const slots = res.slots || [];
            
            const select = document.getElementById("configSlotSelect");
            if (select) {
              // Clear existing options except first
              select.innerHTML = '<option value="">(None)</option>';
              
              // Add numbered slots (1-5)
              for (let i = 1; i <= 5; i++) {
                const slot = slots.find(s => s.slotNumber === i);
                const option = document.createElement("option");
                option.value = i.toString();
                option.textContent = slot ? `Slot ${i}: ${slot.name}` : `Slot ${i} (empty)`;
                select.appendChild(option);
              }
              
              // Add named slots
              slots.filter(s => !s.slotNumber).forEach(slot => {
                const option = document.createElement("option");
                option.value = slot.id;
                option.textContent = slot.name;
                select.appendChild(option);
              });
            }
            
            v2State.configSlots = slots;
          } catch (e) {
            const errorMsg = e?.message || e?.toString() || "Unknown error";
            if (errorMsg.includes("table") || errorMsg.includes("migration") || errorMsg.includes("NOT_FOUND")) {
              // Silently fail on load - don't show toast, just log
              log(`Config slots not available (table missing?): ${errorMsg}`);
            } else {
              log(`Failed to load config slots: ${errorMsg}`);
            }
            // Don't break UI - just leave dropdown empty
            const select = document.getElementById("configSlotSelect");
            if (select && select.innerHTML === '<option value="">(None)</option>') {
              // Already has default, don't change it
            }
          }
        }

        async function saveConfigSlot() {
          const select = document.getElementById("configSlotSelect");
          const slotNumber = select?.value ? parseInt(select.value, 10) : null;
          const slotId = select?.value && isNaN(parseInt(select.value, 10)) ? select.value : null;
          
          if (!slotNumber && !slotId) {
            const name = prompt("Enter slot name:");
            if (!name) return;
            
            try {
              // Create new slot
              const snapshot = await createConfigSnapshot();
              await apiFetch("/v1/admin/config-slots", {
                method: "POST",
                body: JSON.stringify({
                  name: name,
                  slotNumber: null,
                  ...snapshot,
                }),
              });
              showToast("Config slot saved", "success");
              await loadConfigSlots();
            } catch (e) {
              const errorMsg = e?.message || e?.toString() || "Unknown error";
              if (errorMsg.includes("table") || errorMsg.includes("migration") || errorMsg.includes("NOT_FOUND")) {
                showToast("Config slots table not found. Please run migration: npx prisma migrate dev", "error");
              } else {
                showToast("Failed to save slot: " + errorMsg, "error");
              }
              log(`Config slot save error: ${errorMsg}`);
            }
          } else {
            // Update existing slot
            const name = prompt("Enter slot name:", slotId ? v2State.configSlots?.find(s => s.id === slotId)?.name : `Slot ${slotNumber}`);
            if (!name) return;
            
            try {
              const snapshot = await createConfigSnapshot();
              const targetId = slotId || (await apiFetch(`/v1/admin/config-slots/by-number/${slotNumber}`, { method: "GET" })).slot.id;
              
              await apiFetch(`/v1/admin/config-slots/${targetId}`, {
                method: "PUT",
                body: JSON.stringify({
                  name: name,
                  slotNumber: slotNumber,
                  ...snapshot,
                }),
              });
              showToast("Config slot updated", "success");
              await loadConfigSlots();
            } catch (e) {
              const errorMsg = e?.message || e?.toString() || "Unknown error";
              if (errorMsg.includes("table") || errorMsg.includes("migration") || errorMsg.includes("NOT_FOUND")) {
                showToast("Config slots table not found. Please run migration: npx prisma migrate dev", "error");
              } else {
                showToast("Failed to update slot: " + errorMsg, "error");
              }
              log(`Config slot update error: ${errorMsg}`);
            }
          }
        }

        async function loadConfigSlot() {
          const select = document.getElementById("configSlotSelect");
          if (!select || !select.value) {
            showToast("Please select a slot to load", "error");
            return;
          }

          try {
            let slot;
            if (isNaN(parseInt(select.value, 10))) {
              // Load by ID
              const res = await apiFetch(`/v1/admin/config-slots/${select.value}`, { method: "GET" });
              slot = res.slot;
            } else {
              // Load by number
              const res = await apiFetch(`/v1/admin/config-slots/by-number/${select.value}`, { method: "GET" });
              if (!res.ok) {
                showToast("Slot not found", "error");
                return;
              }
              slot = res.slot;
            }

            if (!slot) {
              showToast("Slot not found", "error");
              return;
            }

            // Restore engine config
            if (slot.engineConfigJson) {
              await apiFetch("/v1/admin/engine-config", {
                method: "PUT",
                body: JSON.stringify({ config: slot.engineConfigJson }),
              });
              v2State.engineConfig = slot.engineConfigJson;
            }

            // Restore categories (would need category update endpoints)
            if (slot.categoriesJson) {
              log("Categories snapshot loaded (restore not yet implemented)");
            }

            // Restore missions (would need mission update endpoints)
            if (slot.missionsJson) {
              log("Missions snapshot loaded (restore not yet implemented)");
            }

            // Reload everything to sync state
            await loadEverything();
            
            // Refresh current view
            if (v2State.currentMode === "engine-map") {
              renderEngineMap();
            } else if (v2State.currentMode === "practice-hub") {
              renderPracticeHub();
            }

            showToast("Config slot loaded", "success");
          } catch (e) {
            const errorMsg = e?.message || e?.toString() || "Unknown error";
            if (errorMsg.includes("table") || errorMsg.includes("migration") || errorMsg.includes("NOT_FOUND")) {
              showToast("Config slots table not found. Please run migration: npx prisma migrate dev", "error");
            } else {
              showToast("Failed to load slot: " + errorMsg, "error");
            }
            log(`Config slot load error: ${errorMsg}`);
          }
        }

        async function createConfigSnapshot() {
          // Get current engine config
          let engineConfig = v2State.engineConfig;
          if (!engineConfig) {
            try {
              const res = await apiFetch("/v1/admin/engine-config", { method: "GET" });
              engineConfig = res.config || res;
              v2State.engineConfig = engineConfig;
            } catch (e) {
              log(`Failed to load engine config for snapshot: ${e?.message || e}`);
            }
          }

          // Get current categories
          let categories = v2State.categories;
          if (!categories || categories.length === 0) {
            try {
              const res = await apiFetch("/v1/admin/missions/categories", { method: "GET" });
              categories = Array.isArray(res) ? res : [];
              v2State.categories = categories;
            } catch (e) {
              log(`Failed to load categories for snapshot: ${e?.message || e}`);
            }
          }

          // Get current missions
          let missions = v2State.missions;
          if (!missions || missions.length === 0) {
            try {
              const res = await apiFetch("/v1/admin/missions", { method: "GET" });
              missions = Array.isArray(res) ? res : [];
              v2State.missions = missions;
            } catch (e) {
              log(`Failed to load missions for snapshot: ${e?.message || e}`);
            }
          }

          return {
            engineConfigJson: engineConfig || {},
            categoriesJson: categories || [],
            missionsJson: missions || [],
            defaultSeedKey: null, // TODO: Get from UI
          };
        }

        function closeMissionBuilderModal() {
          const modal = document.getElementById("missionBuilderModal");
          if (modal) modal.classList.remove("active");
          
          // Refresh current view after closing modal
          if (v2State.currentMode === "engine-map") {
            renderEngineMap();
          } else if (v2State.currentMode === "practice-hub") {
            renderPracticeHub();
          }
        }

        function showToast(message, type = "info") {
          const toast = document.getElementById("toastContainer");
          if (!toast) return;
          
          toast.textContent = message;
          toast.className = `toast ${type} show`;
          
          setTimeout(() => {
            toast.classList.remove("show");
          }, 3000);
        }

        // ---------------------------
        // v2 Reusable Modal Framework
        // ---------------------------
        let v2ModalState = {
          onSave: null,
          onCancel: null,
        };

        function openV2Modal({ title, bodyHtml, onSave, onCancel }) {
          const modal = document.getElementById("v2EditorModal");
          const modalTitle = document.getElementById("v2EditorModalTitle");
          const modalContent = document.getElementById("v2EditorModalContent");
          const modalFooter = document.getElementById("v2EditorModalFooter");
          const modalSaveBtn = document.getElementById("v2EditorModalSave");
          const modalCancelBtn = document.getElementById("v2EditorModalCancel");
          
          if (!modal || !modalTitle || !modalContent || !modalFooter || !modalSaveBtn || !modalCancelBtn) {
            showToast("Modal elements not found", "error");
            return;
          }

          v2ModalState.onSave = onSave;
          v2ModalState.onCancel = onCancel;

          modalTitle.textContent = title || "Editor";
          modalContent.innerHTML = bodyHtml || "";
          
          // Show/hide Save button based on onSave
          if (onSave) {
            modalFooter.style.display = "flex";
            modalSaveBtn.style.display = "block";
          } else {
            modalFooter.style.display = "none";
            modalSaveBtn.style.display = "none";
          }
          
          modal.style.display = "flex";
        }

        function closeV2Modal() {
          const modal = document.getElementById("v2EditorModal");
          if (modal) {
            modal.style.display = "none";
          }
          v2ModalState.onSave = null;
          v2ModalState.onCancel = null;
        }

        // Wire modal close handlers on DOMContentLoaded
        if (document.readyState === "loading") {
          document.addEventListener("DOMContentLoaded", () => {
            const modalClose = document.getElementById("v2EditorModalClose");
            const modalOverlay = document.getElementById("v2EditorModal");
            
            if (modalClose) {
              modalClose.addEventListener("click", () => {
                if (v2ModalState.onCancel) {
                  v2ModalState.onCancel();
                }
                closeV2Modal();
              });
            }

            if (modalOverlay) {
              modalOverlay.addEventListener("click", (e) => {
                if (e.target === modalOverlay) {
                  if (v2ModalState.onCancel) {
                    v2ModalState.onCancel();
                  }
                  closeV2Modal();
                }
              });
            }
          });
        } else {
          // DOM already loaded, wire immediately
          const modalClose = document.getElementById("v2EditorModalClose");
          const modalOverlay = document.getElementById("v2EditorModal");
          
          if (modalClose) {
            modalClose.addEventListener("click", () => {
              if (v2ModalState.onCancel) {
                v2ModalState.onCancel();
              }
              closeV2Modal();
            });
          }

          if (modalOverlay) {
            modalOverlay.addEventListener("click", (e) => {
              if (e.target === modalOverlay) {
                if (v2ModalState.onCancel) {
                  v2ModalState.onCancel();
                }
                closeV2Modal();
              }
            });
          }
        }

        // Wire modal footer buttons
        function wireV2ModalButtons() {
          const modalSaveBtn = document.getElementById("v2EditorModalSave");
          const modalCancelBtn = document.getElementById("v2EditorModalCancel");
          
          if (modalSaveBtn) {
            modalSaveBtn.addEventListener("click", async () => {
              if (v2ModalState.onSave) {
                try {
                  await v2ModalState.onSave();
                } catch (e) {
                  showToast("Save failed: " + (e?.message || e), "error");
                }
              }
            });
          }
          
          if (modalCancelBtn) {
            modalCancelBtn.addEventListener("click", () => {
              if (v2ModalState.onCancel) {
                v2ModalState.onCancel();
              }
              closeV2Modal();
            });
          }
        }

        // Wire buttons on DOM ready
        if (document.readyState === "loading") {
          document.addEventListener("DOMContentLoaded", wireV2ModalButtons);
        } else {
          wireV2ModalButtons();
        }

        // ESC key handler (reuse existing pattern)
        document.addEventListener("keydown", (e) => {
          if (e.key === "Escape") {
            const modal = document.getElementById("v2EditorModal");
            if (modal && modal.style.display !== "none") {
              if (v2ModalState.onCancel) {
                v2ModalState.onCancel();
              }
              closeV2Modal();
            }
          }
        });

        // ---------------------------
        // Engine Map Node Editors
        // ---------------------------

        // Personas Editor
        async function openPersonasEditor() {
          try {
            const personas = await apiFetch("/v1/admin/personas", { method: "GET" });
            const personasList = Array.isArray(personas) ? personas : [];

            let html = `
              <div style="margin-bottom: 20px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                  <div style="font-weight: 700; font-size: 16px;">Personas</div>
                  <button class="btn" onclick="v2CreatePersona()" style="background: var(--ok);">+ Create</button>
                </div>
                <div style="margin-bottom: 12px;">
                  <input type="text" id="personasSearch" placeholder="Search personas..." style="width: 100%; padding: 8px; background: var(--controlBg); border: 1px solid var(--controlBorder); border-radius: 6px; color: var(--text);" oninput="v2FilterPersonas()" />
                </div>
                <div id="personasList" style="max-height: 400px; overflow-y: auto;">
                  ${personasList.map(p => `
                    <div class="field" style="padding: 12px; background: var(--panel); border-radius: 8px; margin-bottom: 8px; border: 1px solid var(--line);" data-persona-id="${p.id}">
                      <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                        <div>
                          <div style="font-weight: 700; font-size: 14px;">${escapeHtml(p.name || p.code)}</div>
                          <div style="font-size: 12px; color: var(--muted);">${escapeHtml(p.code)}</div>
                          ${p.description ? `<div style="font-size: 12px; color: var(--muted); margin-top: 4px;">${escapeHtml(p.description)}</div>` : ''}
                        </div>
                        <div style="display: flex; gap: 4px;">
                          <button class="btn" onclick="v2EditPersona('${p.id}')" style="padding: 4px 8px; font-size: 11px;">Edit</button>
                          <button class="btn" onclick="v2DeletePersona('${p.id}')" style="padding: 4px 8px; font-size: 11px; background: var(--bad);">Delete</button>
                        </div>
                      </div>
                      <div style="font-size: 11px; color: var(--muted);">
                        Active: ${p.active ? '✓' : '✗'} | Difficulty: ${p.difficulty || 'N/A'}
                      </div>
                    </div>
                  `).join('')}
                </div>
              </div>
            `;

            openV2Modal({
              title: "Personas Editor",
              bodyHtml: html,
              onSave: null,
              onCancel: closeV2Modal,
            });

            window.__v2Personas = personasList;
          } catch (e) {
            showToast("Failed to load personas: " + (e?.message || e), "error");
          }
        }

        function v2FilterPersonas() {
          const search = document.getElementById("personasSearch")?.value.toLowerCase() || "";
          const items = document.querySelectorAll('[data-persona-id]');
          items.forEach(item => {
            const text = item.textContent.toLowerCase();
            item.style.display = text.includes(search) ? "block" : "none";
          });
        }

        function v2CreatePersona() {
          let html = `
            <form id="personaForm" onsubmit="return false;">
              <div class="field">
                <label>Code <span style="color: var(--bad);">*</span></label>
                <input type="text" id="personaCode" required placeholder="PERSONA_CODE" />
              </div>
              <div class="field">
                <label>Name <span style="color: var(--bad);">*</span></label>
                <input type="text" id="personaName" required placeholder="Persona Name" />
              </div>
              <div class="field">
                <label>Description</label>
                <textarea id="personaDescription" rows="2" placeholder="Persona description"></textarea>
              </div>
              <div class="field">
                <label>Short Label</label>
                <input type="text" id="personaShortLabel" placeholder="Short label" />
              </div>
              <div class="field">
                <label>Avatar URL</label>
                <input type="text" id="personaAvatarUrl" placeholder="https://..." />
              </div>
              <div class="field">
                <label>Difficulty</label>
                <input type="number" id="personaDifficulty" min="1" max="10" placeholder="1-10" />
              </div>
              <div class="field">
                <label>Active</label>
                <select id="personaActive">
                  <option value="true">Active</option>
                  <option value="false">Inactive</option>
                </select>
              </div>
            </form>
          `;

          openV2Modal({
            title: "Create Persona",
            bodyHtml: html,
            onSave: async () => {
              const code = document.getElementById("personaCode")?.value;
              const name = document.getElementById("personaName")?.value;
              if (!code || !name) {
                showToast("Code and Name are required", "error");
                return;
              }

              try {
                await apiFetch("/v1/admin/personas", {
                  method: "POST",
                  body: JSON.stringify({
                    code: code,
                    name: name,
                    description: document.getElementById("personaDescription")?.value || null,
                    shortLabel: document.getElementById("personaShortLabel")?.value || null,
                    avatarUrl: document.getElementById("personaAvatarUrl")?.value || null,
                    difficulty: document.getElementById("personaDifficulty")?.value ? parseInt(document.getElementById("personaDifficulty").value) : null,
                    active: document.getElementById("personaActive")?.value === "true",
                  }),
                });

                showToast("Persona created successfully", "success");
                closeV2Modal();
                await openPersonasEditor();
                if (v2State.personas) {
                  const updated = await apiFetch("/v1/admin/personas", { method: "GET" });
                  if (Array.isArray(updated)) v2State.personas = updated;
                }
              } catch (e) {
                showToast("Failed to create persona: " + (e?.message || e), "error");
                throw e; // Re-throw so modal doesn't close on error
              }
            },
            onCancel: closeV2Modal,
          });
        }

        function v2EditPersona(id) {
          const persona = window.__v2Personas?.find(p => p.id === id);
          if (!persona) {
            showToast("Persona not found", "error");
            return;
          }

          let html = `
            <form id="personaForm" onsubmit="return false;">
              <div class="field">
                <label>Code <span style="color: var(--bad);">*</span></label>
                <input type="text" id="personaCode" value="${escapeHtml(persona.code || "")}" required />
              </div>
              <div class="field">
                <label>Name <span style="color: var(--bad);">*</span></label>
                <input type="text" id="personaName" value="${escapeHtml(persona.name || "")}" required />
              </div>
              <div class="field">
                <label>Description</label>
                <textarea id="personaDescription" rows="2">${escapeHtml(persona.description || "")}</textarea>
              </div>
              <div class="field">
                <label>Short Label</label>
                <input type="text" id="personaShortLabel" value="${escapeHtml(persona.shortLabel || "")}" />
              </div>
              <div class="field">
                <label>Avatar URL</label>
                <input type="text" id="personaAvatarUrl" value="${escapeHtml(persona.avatarUrl || "")}" />
              </div>
              <div class="field">
                <label>Difficulty</label>
                <input type="number" id="personaDifficulty" value="${persona.difficulty || ""}" min="1" max="10" />
              </div>
              <div class="field">
                <label>Active</label>
                <select id="personaActive">
                  <option value="true" ${persona.active !== false ? "selected" : ""}>Active</option>
                  <option value="false" ${persona.active === false ? "selected" : ""}>Inactive</option>
                </select>
              </div>
            </form>
          `;

          openV2Modal({
            title: "Edit Persona",
            bodyHtml: html,
            onSave: async () => {
              const code = document.getElementById("personaCode")?.value;
              const name = document.getElementById("personaName")?.value;
              if (!code || !name) {
                showToast("Code and Name are required", "error");
                return;
              }

              try {
                await apiFetch(`/v1/admin/personas/${id}`, {
                  method: "PUT",
                  body: JSON.stringify({
                    code: code,
                    name: name,
                    description: document.getElementById("personaDescription")?.value || null,
                    shortLabel: document.getElementById("personaShortLabel")?.value || null,
                    avatarUrl: document.getElementById("personaAvatarUrl")?.value || null,
                    difficulty: document.getElementById("personaDifficulty")?.value ? parseInt(document.getElementById("personaDifficulty").value) : null,
                    active: document.getElementById("personaActive")?.value === "true",
                  }),
                });

                showToast("Persona updated successfully", "success");
                closeV2Modal();
                await openPersonasEditor();
                if (v2State.personas) {
                  const updated = await apiFetch("/v1/admin/personas", { method: "GET" });
                  if (Array.isArray(updated)) v2State.personas = updated;
                }
              } catch (e) {
                showToast("Failed to update persona: " + (e?.message || e), "error");
                throw e; // Re-throw so modal doesn't close on error
              }
            },
            onCancel: closeV2Modal,
          });
        }

        async function v2DeletePersona(id) {
          if (!confirm("Are you sure you want to delete this persona?")) return;

          try {
            await apiFetch(`/v1/admin/personas/${id}`, { method: "DELETE" });
            showToast("Persona deleted successfully", "success");
            await openPersonasEditor();
            if (v2State.personas) {
              const updated = await apiFetch("/v1/admin/personas", { method: "GET" });
              if (Array.isArray(updated)) v2State.personas = updated;
            }
          } catch (e) {
            showToast("Failed to delete persona: " + (e?.message || e), "error");
          }
        }

        // AI Styles Editor
        async function openAiStylesEditor() {
          try {
            const styles = await apiFetch("/v1/admin/ai-styles", { method: "GET" });
            const stylesList = Array.isArray(styles) ? styles : [];

            let html = `
              <div style="margin-bottom: 20px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                  <div style="font-weight: 700; font-size: 16px;">AI Styles</div>
                  <button class="btn" onclick="v2CreateAiStyle()" style="background: var(--ok);">+ Create</button>
                </div>
                <div style="margin-bottom: 12px;">
                  <input type="text" id="aiStylesSearch" placeholder="Search AI styles..." style="width: 100%; padding: 8px; background: var(--controlBg); border: 1px solid var(--controlBorder); border-radius: 6px; color: var(--text);" oninput="v2FilterAiStyles()" />
                </div>
                <div id="aiStylesList" style="max-height: 400px; overflow-y: auto;">
                  ${stylesList.map(s => `
                    <div class="field" style="padding: 12px; background: var(--panel); border-radius: 8px; margin-bottom: 8px; border: 1px solid var(--line);" data-style-id="${s.id}">
                      <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                        <div>
                          <div style="font-weight: 700; font-size: 14px;">${escapeHtml(s.name || s.key)}</div>
                          <div style="font-size: 12px; color: var(--muted);">${escapeHtml(s.key)}</div>
                          ${s.description ? `<div style="font-size: 12px; color: var(--muted); margin-top: 4px;">${escapeHtml(s.description)}</div>` : ''}
                        </div>
                        <div style="display: flex; gap: 4px;">
                          <button class="btn" onclick="v2EditAiStyle('${s.id}')" style="padding: 4px 8px; font-size: 11px;">Edit</button>
                          <button class="btn" onclick="v2DeleteAiStyle('${s.id}')" style="padding: 4px 8px; font-size: 11px; background: var(--bad);">Delete</button>
                        </div>
                      </div>
                      <div style="font-size: 11px; color: var(--muted);">
                        Active: ${s.isActive ? '✓' : '✗'} | Warmth: ${s.warmth || 'N/A'} | Initiative: ${s.initiative || 'N/A'}
                      </div>
                    </div>
                  `).join('')}
                </div>
              </div>
            `;

            openV2Modal({
              title: "AI Styles Editor",
              bodyHtml: html,
              onSave: null,
              onCancel: closeV2Modal,
            });

            window.__v2AiStyles = stylesList;
          } catch (e) {
            showToast("Failed to load AI styles: " + (e?.message || e), "error");
          }
        }

        function v2FilterAiStyles() {
          const search = document.getElementById("aiStylesSearch")?.value.toLowerCase() || "";
          const items = document.querySelectorAll('[data-style-id]');
          items.forEach(item => {
            const text = item.textContent.toLowerCase();
            item.style.display = text.includes(search) ? "block" : "none";
          });
        }

        function v2CreateAiStyle() {
          let html = `
            <form id="aiStyleForm" onsubmit="return false;">
              <div class="field">
                <label>Key <span style="color: var(--bad);">*</span></label>
                <select id="aiStyleKey" required>
                  <option value="">Select key...</option>
                  <option value="NEUTRAL">NEUTRAL</option>
                  <option value="FLIRTY">FLIRTY</option>
                  <option value="PLAYFUL">PLAYFUL</option>
                  <option value="CHALLENGING">CHALLENGING</option>
                  <option value="WARM">WARM</option>
                  <option value="COLD">COLD</option>
                  <option value="SHY">SHY</option>
                  <option value="DIRECT">DIRECT</option>
                  <option value="JUDGMENTAL">JUDGMENTAL</option>
                  <option value="CHAOTIC">CHAOTIC</option>
                </select>
              </div>
              <div class="field">
                <label>Name <span style="color: var(--bad);">*</span></label>
                <input type="text" id="aiStyleName" required placeholder="Style Name" />
              </div>
              <div class="field">
                <label>Description</label>
                <textarea id="aiStyleDescription" rows="2" placeholder="Style description"></textarea>
              </div>
              <div class="field">
                <label>Style Prompt</label>
                <textarea id="aiStylePrompt" rows="3" placeholder="Style prompt"></textarea>
              </div>
              <div class="field">
                <label>Forbidden Behavior</label>
                <textarea id="aiStyleForbidden" rows="2" placeholder="Forbidden behavior"></textarea>
              </div>
              <div class="split2">
                <div class="field">
                  <label>Max Chars</label>
                  <input type="number" id="aiStyleMaxChars" value="500" min="1" max="10000" />
                </div>
                <div class="field">
                  <label>Max Lines</label>
                  <input type="number" id="aiStyleMaxLines" value="10" min="1" max="100" />
                </div>
              </div>
              <div class="split3">
                <div class="field">
                  <label>Warmth (0-100)</label>
                  <input type="number" id="aiStyleWarmth" value="50" min="0" max="100" />
                </div>
                <div class="field">
                  <label>Initiative (0-100)</label>
                  <input type="number" id="aiStyleInitiative" value="50" min="0" max="100" />
                </div>
                <div class="field">
                  <label>Active</label>
                  <select id="aiStyleActive">
                    <option value="true">Active</option>
                    <option value="false">Inactive</option>
                  </select>
                </div>
              </div>
            </form>
          `;

          openV2Modal({
            title: "Create AI Style",
            bodyHtml: html,
            onSave: async () => {
              const key = document.getElementById("aiStyleKey")?.value;
              const name = document.getElementById("aiStyleName")?.value;
              if (!key || !name) {
                showToast("Key and Name are required", "error");
                return;
              }

              try {
                await apiFetch("/v1/admin/ai-styles", {
                  method: "POST",
                  body: JSON.stringify({
                    key: key,
                    name: name,
                    description: document.getElementById("aiStyleDescription")?.value || "",
                    stylePrompt: document.getElementById("aiStylePrompt")?.value || "",
                    forbiddenBehavior: document.getElementById("aiStyleForbidden")?.value || "",
                    maxChars: parseInt(document.getElementById("aiStyleMaxChars")?.value || "500"),
                    maxLines: parseInt(document.getElementById("aiStyleMaxLines")?.value || "10"),
                    warmth: parseInt(document.getElementById("aiStyleWarmth")?.value || "50"),
                    initiative: parseInt(document.getElementById("aiStyleInitiative")?.value || "50"),
                    isActive: document.getElementById("aiStyleActive")?.value === "true",
                  }),
                });

                showToast("AI Style created successfully", "success");
                closeV2Modal();
                await openAiStylesEditor();
                if (v2State.aiStyles) {
                  const updated = await apiFetch("/v1/admin/ai-styles", { method: "GET" });
                  if (Array.isArray(updated)) v2State.aiStyles = updated;
                }
              } catch (e) {
                showToast("Failed to create AI style: " + (e?.message || e), "error");
                throw e;
              }
            },
            onCancel: closeV2Modal,
          });
        }

        function v2EditAiStyle(id) {
          const style = window.__v2AiStyles?.find(s => s.id === id);
          if (!style) {
            showToast("AI Style not found", "error");
            return;
          }

          let html = `
            <form id="aiStyleForm" onsubmit="return false;">
              <div class="field">
                <label>Key <span style="color: var(--bad);">*</span></label>
                <input type="text" id="aiStyleKey" value="${escapeHtml(style.key || "")}" required readonly style="background: var(--panel);" />
              </div>
              <div class="field">
                <label>Name <span style="color: var(--bad);">*</span></label>
                <input type="text" id="aiStyleName" value="${escapeHtml(style.name || "")}" required />
              </div>
              <div class="field">
                <label>Description</label>
                <textarea id="aiStyleDescription" rows="2">${escapeHtml(style.description || "")}</textarea>
              </div>
              <div class="field">
                <label>Style Prompt</label>
                <textarea id="aiStylePrompt" rows="3">${escapeHtml(style.stylePrompt || "")}</textarea>
              </div>
              <div class="field">
                <label>Forbidden Behavior</label>
                <textarea id="aiStyleForbidden" rows="2">${escapeHtml(style.forbiddenBehavior || "")}</textarea>
              </div>
              <div class="split2">
                <div class="field">
                  <label>Max Chars</label>
                  <input type="number" id="aiStyleMaxChars" value="${style.maxChars || 500}" min="1" max="10000" />
                </div>
                <div class="field">
                  <label>Max Lines</label>
                  <input type="number" id="aiStyleMaxLines" value="${style.maxLines || 10}" min="1" max="100" />
                </div>
              </div>
              <div class="split3">
                <div class="field">
                  <label>Warmth (0-100)</label>
                  <input type="number" id="aiStyleWarmth" value="${style.warmth || 50}" min="0" max="100" />
                </div>
                <div class="field">
                  <label>Initiative (0-100)</label>
                  <input type="number" id="aiStyleInitiative" value="${style.initiative || 50}" min="0" max="100" />
                </div>
                <div class="field">
                  <label>Active</label>
                  <select id="aiStyleActive">
                    <option value="true" ${style.isActive !== false ? "selected" : ""}>Active</option>
                    <option value="false" ${style.isActive === false ? "selected" : ""}>Inactive</option>
                  </select>
                </div>
              </div>
            </form>
          `;

          openV2Modal({
            title: "Edit AI Style",
            bodyHtml: html,
            onSave: async () => {
              const name = document.getElementById("aiStyleName")?.value;
              if (!name) {
                showToast("Name is required", "error");
                return;
              }

              try {
                await apiFetch(`/v1/admin/ai-styles/${id}`, {
                  method: "PUT",
                  body: JSON.stringify({
                    name: name,
                    description: document.getElementById("aiStyleDescription")?.value || "",
                    stylePrompt: document.getElementById("aiStylePrompt")?.value || "",
                    forbiddenBehavior: document.getElementById("aiStyleForbidden")?.value || "",
                    maxChars: parseInt(document.getElementById("aiStyleMaxChars")?.value || "500"),
                    maxLines: parseInt(document.getElementById("aiStyleMaxLines")?.value || "10"),
                    warmth: parseInt(document.getElementById("aiStyleWarmth")?.value || "50"),
                    initiative: parseInt(document.getElementById("aiStyleInitiative")?.value || "50"),
                    isActive: document.getElementById("aiStyleActive")?.value === "true",
                  }),
                });

                showToast("AI Style updated successfully", "success");
                closeV2Modal();
                await openAiStylesEditor();
                if (v2State.aiStyles) {
                  const updated = await apiFetch("/v1/admin/ai-styles", { method: "GET" });
                  if (Array.isArray(updated)) v2State.aiStyles = updated;
                }
              } catch (e) {
                showToast("Failed to update AI style: " + (e?.message || e), "error");
                throw e;
              }
            },
            onCancel: closeV2Modal,
          });
        }

        async function v2DeleteAiStyle(id) {
          if (!confirm("Are you sure you want to delete this AI style?")) return;

          try {
            await apiFetch(`/v1/admin/ai-styles/${id}`, { method: "DELETE" });
            showToast("AI Style deleted successfully", "success");
            await openAiStylesEditor();
            if (v2State.aiStyles) {
              const updated = await apiFetch("/v1/admin/ai-styles", { method: "GET" });
              if (Array.isArray(updated)) v2State.aiStyles = updated;
            }
          } catch (e) {
            showToast("Failed to delete AI style: " + (e?.message || e), "error");
          }
        }

        // Hooks Editor
        async function openHooksEditor() {
          try {
            const res = await apiFetch("/v1/admin/hooks", { method: "GET" });
            const hooksList = res.hooks || res || [];

            let html = `
              <div style="margin-bottom: 20px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                  <div style="font-weight: 700; font-size: 16px;">Hooks</div>
                  <button class="btn" onclick="v2CreateHook()" style="background: var(--ok);">+ Create</button>
                </div>
                <div style="margin-bottom: 12px;">
                  <input type="text" id="hooksSearch" placeholder="Search hooks..." style="width: 100%; padding: 8px; background: var(--controlBg); border: 1px solid var(--controlBorder); border-radius: 6px; color: var(--text);" oninput="v2FilterHooks()" />
                </div>
                <div id="hooksList" style="max-height: 400px; overflow-y: auto;">
                  ${hooksList.map(h => `
                    <div class="field" style="padding: 12px; background: var(--panel); border-radius: 8px; margin-bottom: 8px; border: 1px solid var(--line);" data-hook-id="${h.id}">
                      <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                        <div>
                          <div style="font-weight: 700; font-size: 14px;">${escapeHtml(h.name || "Unnamed")}</div>
                          <div style="font-size: 12px; color: var(--muted);">Type: ${escapeHtml(h.type || "N/A")} | Category: ${escapeHtml(h.category || "N/A")}</div>
                        </div>
                        <div style="display: flex; gap: 4px;">
                          <button class="btn" onclick="v2EditHook('${h.id}')" style="padding: 4px 8px; font-size: 11px;">Edit</button>
                          <button class="btn" onclick="v2DeleteHook('${h.id}')" style="padding: 4px 8px; font-size: 11px; background: var(--bad);">Delete</button>
                        </div>
                      </div>
                      <div style="font-size: 11px; color: var(--muted);">
                        Enabled: ${h.isEnabled ? '✓' : '✗'} | Priority: ${h.priority || 'N/A'}
                      </div>
                    </div>
                  `).join('')}
                </div>
              </div>
            `;

            openV2Modal({
              title: "Hooks Editor",
              bodyHtml: html,
              onSave: null,
              onCancel: closeV2Modal,
            });

            window.__v2Hooks = hooksList;
          } catch (e) {
            showToast("Failed to load hooks: " + (e?.message || e), "error");
          }
        }

        function v2FilterHooks() {
          const search = document.getElementById("hooksSearch")?.value.toLowerCase() || "";
          const items = document.querySelectorAll('[data-hook-id]');
          items.forEach(item => {
            const text = item.textContent.toLowerCase();
            item.style.display = text.includes(search) ? "block" : "none";
          });
        }

        function v2CreateHook() {
          let html = `
            <form id="hookForm" onsubmit="return false;">
              <div class="field">
                <label>Name <span style="color: var(--bad);">*</span></label>
                <input type="text" id="hookName" required placeholder="Hook Name" />
              </div>
              <div class="split2">
                <div class="field">
                  <label>Type <span style="color: var(--bad);">*</span></label>
                  <input type="text" id="hookType" required placeholder="e.g. POSITIVE, NEGATIVE" />
                </div>
                <div class="field">
                  <label>Category</label>
                  <input type="text" id="hookCategory" value="general" placeholder="Category" />
                </div>
              </div>
              <div class="field">
                <label>Text Template <span style="color: var(--bad);">*</span></label>
                <textarea id="hookTextTemplate" rows="3" required placeholder="Hook text template"></textarea>
              </div>
              <div class="field">
                <label>Conditions (JSON)</label>
                <textarea id="hookConditions" rows="2" placeholder='{"score": ">70"}'></textarea>
              </div>
              <div class="split2">
                <div class="field">
                  <label>Priority</label>
                  <input type="number" id="hookPriority" value="50" min="0" max="100" />
                </div>
                <div class="field">
                  <label>Enabled</label>
                  <select id="hookEnabled">
                    <option value="true">Enabled</option>
                    <option value="false">Disabled</option>
                  </select>
                </div>
              </div>
            </form>
          `;

          openV2Modal({
            title: "Create Hook",
            bodyHtml: html,
            onSave: async () => {
              const name = document.getElementById("hookName")?.value;
              const type = document.getElementById("hookType")?.value;
              const textTemplate = document.getElementById("hookTextTemplate")?.value;
              if (!name || !type || !textTemplate) {
                showToast("Name, Type, and Text Template are required", "error");
                return;
              }

              try {
                let conditionsJson = {};
                const conditionsText = document.getElementById("hookConditions")?.value;
                if (conditionsText) {
                  try {
                    conditionsJson = JSON.parse(conditionsText);
                  } catch (e) {
                    showToast("Invalid JSON in Conditions field", "error");
                    return;
                  }
                }

                await apiFetch("/v1/admin/hooks", {
                  method: "POST",
                  body: JSON.stringify({
                    name: name,
                    type: type,
                    textTemplate: textTemplate,
                    category: document.getElementById("hookCategory")?.value || "general",
                    conditionsJson: conditionsJson,
                    priority: parseInt(document.getElementById("hookPriority")?.value || "50"),
                    isEnabled: document.getElementById("hookEnabled")?.value === "true",
                  }),
                });

                showToast("Hook created successfully", "success");
                closeV2Modal();
                await openHooksEditor();
              } catch (e) {
                showToast("Failed to create hook: " + (e?.message || e), "error");
                throw e;
              }
            },
            onCancel: closeV2Modal,
          });
        }

        function v2EditHook(id) {
          const hook = window.__v2Hooks?.find(h => h.id === id);
          if (!hook) {
            showToast("Hook not found", "error");
            return;
          }

          let html = `
            <form id="hookForm" onsubmit="return false;">
              <div class="field">
                <label>Name <span style="color: var(--bad);">*</span></label>
                <input type="text" id="hookName" value="${escapeHtml(hook.name || "")}" required />
              </div>
              <div class="split2">
                <div class="field">
                  <label>Type <span style="color: var(--bad);">*</span></label>
                  <input type="text" id="hookType" value="${escapeHtml(hook.type || "")}" required />
                </div>
                <div class="field">
                  <label>Category</label>
                  <input type="text" id="hookCategory" value="${escapeHtml(hook.category || "general")}" />
                </div>
              </div>
              <div class="field">
                <label>Text Template <span style="color: var(--bad);">*</span></label>
                <textarea id="hookTextTemplate" rows="3" required>${escapeHtml(hook.textTemplate || "")}</textarea>
              </div>
              <div class="field">
                <label>Conditions (JSON)</label>
                <textarea id="hookConditions" rows="2">${escapeHtml(JSON.stringify(hook.conditionsJson || {}, null, 2))}</textarea>
              </div>
              <div class="split2">
                <div class="field">
                  <label>Priority</label>
                  <input type="number" id="hookPriority" value="${hook.priority || 50}" min="0" max="100" />
                </div>
                <div class="field">
                  <label>Enabled</label>
                  <select id="hookEnabled">
                    <option value="true" ${hook.isEnabled !== false ? "selected" : ""}>Enabled</option>
                    <option value="false" ${hook.isEnabled === false ? "selected" : ""}>Disabled</option>
                  </select>
                </div>
              </div>
            </form>
          `;

          openV2Modal({
            title: "Edit Hook",
            bodyHtml: html,
            onSave: async () => {
              const name = document.getElementById("hookName")?.value;
              const type = document.getElementById("hookType")?.value;
              const textTemplate = document.getElementById("hookTextTemplate")?.value;
              if (!name || !type || !textTemplate) {
                showToast("Name, Type, and Text Template are required", "error");
                return;
              }

              try {
                let conditionsJson = {};
                const conditionsText = document.getElementById("hookConditions")?.value;
                if (conditionsText) {
                  try {
                    conditionsJson = JSON.parse(conditionsText);
                  } catch (e) {
                    showToast("Invalid JSON in Conditions field", "error");
                    return;
                  }
                }

                await apiFetch(`/v1/admin/hooks/${id}`, {
                  method: "PUT",
                  body: JSON.stringify({
                    name: name,
                    type: type,
                    textTemplate: textTemplate,
                    category: document.getElementById("hookCategory")?.value || "general",
                    conditionsJson: conditionsJson,
                    priority: parseInt(document.getElementById("hookPriority")?.value || "50"),
                    isEnabled: document.getElementById("hookEnabled")?.value === "true",
                  }),
                });

                showToast("Hook updated successfully", "success");
                closeV2Modal();
                await openHooksEditor();
              } catch (e) {
                showToast("Failed to update hook: " + (e?.message || e), "error");
                throw e;
              }
            },
            onCancel: closeV2Modal,
          });
        }

        async function v2DeleteHook(id) {
          if (!confirm("Are you sure you want to delete this hook?")) return;

          try {
            const res = await apiFetch(`/v1/admin/hooks/${id}`, { method: "DELETE" });
            if (res.ok !== false) {
              showToast("Hook deleted successfully", "success");
              await openHooksEditor();
            } else {
              showToast("Failed to delete hook", "error");
            }
          } catch (e) {
            showToast("Failed to delete hook: " + (e?.message || e), "error");
          }
        }

        // Global functions for onclick handlers
        window.editCategory = function(categoryId) {
          log(`Edit category: ${categoryId}`);
          showToast("Category editor - Coming soon", "info");
        };

        window.createMissionInCategory = createMissionInCategory;
        window.selectMissionForEdit = selectMissionForEdit;
        window.openNodeEditor = openNodeEditor;
        window.openPersonasEditor = openPersonasEditor;
        window.openAiStylesEditor = openAiStylesEditor;
        window.openHooksEditor = openHooksEditor;
        window.v2CreatePersona = v2CreatePersona;
        window.v2EditPersona = v2EditPersona;
        window.v2DeletePersona = v2DeletePersona;
        window.v2FilterPersonas = v2FilterPersonas;
        window.v2CreateAiStyle = v2CreateAiStyle;
        window.v2EditAiStyle = v2EditAiStyle;
        window.v2DeleteAiStyle = v2DeleteAiStyle;
        window.v2FilterAiStyles = v2FilterAiStyles;
        window.v2CreateHook = v2CreateHook;
        window.v2EditHook = v2EditHook;
        window.v2DeleteHook = v2DeleteHook;
        window.v2FilterHooks = v2FilterHooks;
        window.openV2Modal = openV2Modal;
        window.closeV2Modal = closeV2Modal;

        // ---------------------------
        // Practice Hub Drag & Drop Reorder
        // ---------------------------
        let v2DragState = {
          draggedMissionId: null,
          draggedCategoryId: null,
          draggedElement: null,
        };

        function v2HandleDragStart(event, missionId, categoryId) {
          v2DragState.draggedMissionId = missionId;
          v2DragState.draggedCategoryId = categoryId;
          v2DragState.draggedElement = event.target;
          event.target.style.opacity = "0.5";
          event.dataTransfer.effectAllowed = "move";
          event.dataTransfer.setData("text/plain", missionId);
        }

        function v2HandleDragOver(event) {
          event.preventDefault();
          event.dataTransfer.dropEffect = "move";
          
          const row = event.currentTarget;
          if (row.classList.contains("missions-row")) {
            row.style.backgroundColor = "var(--controlFocus)";
          }
        }

        function v2HandleDragLeave(event) {
          const row = event.currentTarget;
          if (row.classList.contains("missions-row")) {
            row.style.backgroundColor = "";
          }
        }

        function v2HandleDragEnd(event) {
          event.target.style.opacity = "1";
          
          // Clear all row highlights
          document.querySelectorAll(".missions-row").forEach(row => {
            row.style.backgroundColor = "";
          });
        }

        async function v2HandleDrop(event) {
          event.preventDefault();
          const dropRow = event.currentTarget;
          
          if (!dropRow.classList.contains("missions-row")) return;
          
          const dropCategoryId = dropRow.getAttribute("data-category-id");
          
          // Block cross-category drops
          if (v2DragState.draggedCategoryId !== dropCategoryId) {
            showToast("Cannot move missions between categories. Reorder within the same category only.", "error");
            v2HandleDragEnd(event);
            return;
          }

          // Find drop position
          const missionCards = Array.from(dropRow.querySelectorAll(".mission-card"));
          let dropIndex = missionCards.length;
          
          for (let i = 0; i < missionCards.length; i++) {
            const rect = missionCards[i].getBoundingClientRect();
            const midY = rect.top + rect.height / 2;
            if (event.clientY < midY) {
              dropIndex = i;
              break;
            }
          }

          // Build items array with new orderIndex, preserving existing laneIndex
          const items = [];
          missionCards.forEach((card, idx) => {
            const missionId = card.getAttribute("data-mission-id");
            if (missionId === v2DragState.draggedMissionId) {
              // Insert dragged item at new position
              return;
            }
            
            // Get existing mission from v2State to preserve laneIndex
            const existingMission = v2State.missions.find(m => m.id === missionId);
            const laneIndex = existingMission?.laneIndex ?? 0;
            
            items.push({
              id: missionId,
              laneIndex: laneIndex,
              orderIndex: idx >= dropIndex ? idx + 1 : idx,
            });
          });

          // Insert dragged item at dropIndex, preserving its laneIndex
          const draggedMission = v2State.missions.find(m => m.id === v2DragState.draggedMissionId);
          const draggedLaneIndex = draggedMission?.laneIndex ?? 0;
          
          items.splice(dropIndex, 0, {
            id: v2DragState.draggedMissionId,
            laneIndex: draggedLaneIndex,
            orderIndex: dropIndex,
          });

          // Update all orderIndex values to be sequential
          items.forEach((item, idx) => {
            item.orderIndex = idx;
          });

          try {
            const res = await apiFetch("/v1/admin/missions/reorder", {
              method: "POST",
              body: JSON.stringify({ items: items }),
            });

            if (res.ok !== false) {
              showToast("Missions reordered successfully", "success");
              
              // Reload missions and refresh Practice Hub
              await loadMissions();
              if (v2State.currentMode === "practice-hub") {
                renderPracticeHub();
              }
            } else {
              showToast("Failed to reorder missions", "error");
            }
          } catch (e) {
            showToast("Failed to reorder missions: " + (e?.message || e), "error");
          }

          v2HandleDragEnd(event);
          v2DragState.draggedMissionId = null;
          v2DragState.draggedCategoryId = null;
          v2DragState.draggedElement = null;
        }

        // Expose DnD handlers globally
        window.v2HandleDragStart = v2HandleDragStart;
        window.v2HandleDragOver = v2HandleDragOver;
        window.v2HandleDragLeave = v2HandleDragLeave;
        window.v2HandleDragEnd = v2HandleDragEnd;
        window.v2HandleDrop = v2HandleDrop;

        function wire() {
          // Log/showError if critical elements missing, but continue wiring others
          if (!ui.pingApiBtn) {
            log("ERROR: missing #pingApiBtn");
            showError("WARNING: pingApiBtn not found. Some buttons may not work.");
          }
          
          bindClick(ui.pingApiBtn, "pingApi", pingApi);
          bindClick(ui.loadMetaBtn, "loadMeta", loadMeta);
          bindClick(ui.loadMissionsBtn, "loadMissions", loadMissions);
          bindClick(ui.loadEverythingBtn, "loadEverything", loadEverything);
          bindClick(ui.saveSettingsBtn, "saveSettings", saveSettings);
          
          // Step 1: Wire login button
          const loginBtn = document.getElementById("loginBtn");
          bindClick(loginBtn, "handleLogin", handleLogin);

          if (ui.clearLogBtn) ui.clearLogBtn.addEventListener("click", () => {
            if (ui.logArea) ui.logArea.textContent = "";
            log("Log cleared.");
          });

          if (ui.clearSearchBtn) ui.clearSearchBtn.addEventListener("click", () => {
            if (ui.searchInput) ui.searchInput.value = "";
            renderMissionsList();
          });

          if (ui.searchInput) ui.searchInput.addEventListener("input", () => {
            renderMissionsList();
          });

          if (ui.newMissionBtn) ui.newMissionBtn.addEventListener("click", () => {
            clearMissionForm();
            showOk("New mission (empty) ready.");
          });

          if (ui.duplicateMissionBtn) ui.duplicateMissionBtn.addEventListener("click", duplicateMission);
          if (ui.deleteMissionBtn) ui.deleteMissionBtn.addEventListener("click", deleteMission);

          if (ui.saveMissionBtn) ui.saveMissionBtn.addEventListener("click", saveMission);
          if (ui.clearFormBtn) ui.clearFormBtn.addEventListener("click", clearMissionForm);
          
          // Dynamics structured UI event wiring
          const missionDynSyncBtn = document.getElementById("missionDynSyncFromJsonBtn");
          if (missionDynSyncBtn) {
            missionDynSyncBtn.addEventListener("click", syncMissionDynamicsFromJson);
          }
          
          const missionDynWriteBtn = document.getElementById("missionDynWriteToJsonBtn");
          if (missionDynWriteBtn) {
            missionDynWriteBtn.addEventListener("click", writeMissionDynamicsToJson);
          }

          // Dynamics Profile selector
          const dynamicsProfileSelect = document.getElementById("missionDynamicsProfileSelect");
          if (dynamicsProfileSelect) {
            dynamicsProfileSelect.addEventListener("change", onDynamicsProfileChange);
          }

          // Gate Pack selector
          const gatePackSelect = document.getElementById("missionGateRequirementPackSelect");
          if (gatePackSelect) {
            gatePackSelect.addEventListener("change", onGatePackChange);
          }

          // Dynamics Override toggle
          const dynamicsOverrideToggle = document.getElementById("missionDynamicsOverrideToggle");
          if (dynamicsOverrideToggle) {
            dynamicsOverrideToggle.addEventListener("change", onDynamicsOverrideToggle);
          }
          
          // Slider live value updates
          const missionSliderIds = [
            { id: "missionDynPace", valId: "missionDynPaceVal" },
            { id: "missionDynEmojiDensity", valId: "missionDynEmojiDensityVal" },
            { id: "missionDynFlirtiveness", valId: "missionDynFlirtivenessVal" },
            { id: "missionDynHostility", valId: "missionDynHostilityVal" },
            { id: "missionDynDryness", valId: "missionDynDrynessVal" },
            { id: "missionDynVulnerability", valId: "missionDynVulnerabilityVal" },
            { id: "missionDynEscalationSpeed", valId: "missionDynEscalationSpeedVal" },
            { id: "missionDynRandomness", valId: "missionDynRandomnessVal" },
          ];
          
          missionSliderIds.forEach(({ id, valId }) => {
            const slider = document.getElementById(id);
            const valSpan = document.getElementById(valId);
            if (slider && valSpan) {
              slider.addEventListener("input", () => {
                valSpan.textContent = slider.value;
              });
            }
          });
          
          // Step 7: Mission Monitor event listeners
          const loadMissionStatsBtn = document.getElementById("loadMissionStatsBtn");
          const loadMissionTimelineBtn = document.getElementById("loadMissionTimelineBtn");
          const loadMissionMessagesBtn = document.getElementById("loadMissionMessagesBtn");
          const statsTimeWindow = document.getElementById("statsTimeWindow");
          const messageLogSessionSelect = document.getElementById("messageLogSessionSelect");
          
          if (loadMissionStatsBtn) {
            loadMissionStatsBtn.addEventListener("click", () => {
              if (state.selectedMissionId) {
                loadMissionStats(state.selectedMissionId);
              }
            });
          }
          
          if (statsTimeWindow) {
            statsTimeWindow.addEventListener("change", () => {
              if (state.selectedMissionId) {
                loadMissionStats(state.selectedMissionId);
              }
            });
          }
          
          if (loadMissionTimelineBtn) {
            loadMissionTimelineBtn.addEventListener("click", () => {
              if (state.selectedMissionId) {
                loadMissionMoodTimelines(state.selectedMissionId);
              }
            });
          }
          
          if (loadMissionMessagesBtn) {
            loadMissionMessagesBtn.addEventListener("click", () => {
              if (state.selectedMissionId) {
                loadMissionSessions(state.selectedMissionId);
              }
            });
          }
          
          if (messageLogSessionSelect) {
            messageLogSessionSelect.addEventListener("change", (e) => {
              const sessionId = e.target.value;
              if (sessionId) {
                loadSessionMessages(sessionId);
              } else {
                document.getElementById("messageLogEmpty").style.display = "block";
                document.getElementById("messageLogTable").style.display = "none";
              }
            });
          }

          if (ui.validateAiContractBtn) ui.validateAiContractBtn.addEventListener("click", () => {
            const ok = validateAiContractJson();
            if (ok) showOk("AI Contract JSON is valid.");
          });

          if (ui.formatAiContractBtn) ui.formatAiContractBtn.addEventListener("click", () => {
            formatAiContractJson();
            const ok = validateAiContractJson();
            if (ok) showOk("Formatted & valid.");
          });

          if (ui.pasteSampleBtn) ui.pasteSampleBtn.addEventListener("click", pasteSampleContract);

          // Phase 3: Builder UI handlers
          if (ui.builderTypeSelect) {
            ui.builderTypeSelect.addEventListener("change", () => {
              const builderType = ui.builderTypeSelect.value;
              if (builderType) {
                ui.builderParamsSection.style.display = "block";
                // Show objectiveKind field only for OPENERS
                if (builderType === "OPENERS") {
                  ui.builderObjectiveKindField.style.display = "block";
                } else {
                  ui.builderObjectiveKindField.style.display = "none";
                }
                // Populate defaults from mission form
                populateBuilderDefaults();
              } else {
                ui.builderParamsSection.style.display = "none";
              }
            });
          }

          if (ui.generateConfigBtn) {
            ui.generateConfigBtn.addEventListener("click", async () => {
              await handleGenerateConfig();
            });
          }

          if (ui.validateConfigBtn) {
            ui.validateConfigBtn.addEventListener("click", async () => {
              await handleValidateConfig();
            });
          }

          // Track when user touches AI Style dropdown
          if (ui.aiStyleSelect) ui.aiStyleSelect.addEventListener("change", () => {
            state.aiStyleTouched = true;
          });

          // Live preview updates
          const previewInputs = [
            ui.missionTitleInput,
            ui.difficultySelect,
            ui.categorySelect,
            ui.personaSelect,
            ui.activeSelect,
            ui.codeInput,
            ui.aiStyleSelect,
            ui.aiContractJsonTextarea
          ].filter(el => el !== null && el !== undefined);
          previewInputs.forEach((el) => el.addEventListener("input", updateMissionPreview));
          previewInputs.forEach((el) => el.addEventListener("change", updateMissionPreview));

          // capture global errors -> visible (Wave 1: Enhanced for dashboard log)
          window.addEventListener("error", (e) => {
            const msg = `JS Error: ${e.message} @ ${e.filename || 'unknown'}:${e.lineno || '?'}:${e.colno || '?'}`;
            log(`ERROR: ${msg}`);
            showError(msg);
          });
          window.addEventListener("unhandledrejection", (e) => {
            const msg = `Unhandled Promise: ${e.reason?.message || e.reason || 'Unknown error'}`;
            log(`ERROR: ${msg}`);
            showError(msg);
          });
        }

        // ---------------------------
        // UI Hydration (robust element fetching)
        // ---------------------------
        function hydrateUI() {
          // Critical header controls
          ui.pingApiBtn = document.getElementById("pingApiBtn");
          ui.loadMetaBtn = document.getElementById("loadMetaBtn");
          ui.loadMissionsBtn = document.getElementById("loadMissionsBtn");
          ui.saveSettingsBtn = document.getElementById("saveSettingsBtn");
          ui.apiBaseInput = document.getElementById("apiBaseInput");
          ui.jwtInput = document.getElementById("jwtInput");
          
          // Login elements
          ui.loginEmailInput = document.getElementById("loginEmailInput");
          ui.loginPasswordInput = document.getElementById("loginPasswordInput");
          
          // Status chips
          ui.apiStatusChip = document.getElementById("apiStatusChip");
          ui.metaStatusChip = document.getElementById("metaStatusChip");
          ui.missionsStatusChip = document.getElementById("missionsStatusChip");
          
          // Alerts
          ui.errorBox = document.getElementById("errorBox");
          ui.okBox = document.getElementById("okBox");
          
          // List
          ui.missionsList = document.getElementById("missionsList");
          ui.searchInput = document.getElementById("searchInput");
          ui.clearSearchBtn = document.getElementById("clearSearchBtn");
          ui.newMissionBtn = document.getElementById("newMissionBtn");
          ui.duplicateMissionBtn = document.getElementById("duplicateMissionBtn");
          ui.deleteMissionBtn = document.getElementById("deleteMissionBtn");
          ui.selectedChip = document.getElementById("selectedChip");
          
          // Editor fields
          ui.saveMissionBtn = document.getElementById("saveMissionBtn");
          ui.clearFormBtn = document.getElementById("clearFormBtn");
          ui.missionTitleInput = document.getElementById("missionTitleInput");
          ui.missionDescriptionInput = document.getElementById("missionDescriptionInput");
          ui.difficultySelect = document.getElementById("difficultySelect");
          ui.missionGoalTypeSelect = document.getElementById("missionGoalTypeSelect");
          ui.categorySelect = document.getElementById("categorySelect");
          ui.personaSelect = document.getElementById("personaSelect");
          ui.activeSelect = document.getElementById("activeSelect");
          ui.codeInput = document.getElementById("codeInput");
          ui.missionTimeLimitInput = document.getElementById("missionTimeLimitInput");
          ui.missionMaxMessagesInput = document.getElementById("missionMaxMessagesInput");
          ui.missionWordLimitInput = document.getElementById("missionWordLimitInput");
          ui.laneIndexInput = document.getElementById("laneIndexInput");
          ui.orderIndexInput = document.getElementById("orderIndexInput");
          ui.aiStyleSelect = document.getElementById("aiStyleSelect");
          
          // Contract
          ui.aiContractJsonTextarea = document.getElementById("aiContractJsonTextarea");
          ui.validateAiContractBtn = document.getElementById("validateAiContractBtn");
          ui.formatAiContractBtn = document.getElementById("formatAiContractBtn");
          ui.pasteSampleBtn = document.getElementById("pasteSampleBtn");
          ui.contractErrorBox = document.getElementById("contractErrorBox");
          
          // Phase 3: Builder UI
          ui.builderTypeSelect = document.getElementById("builderTypeSelect");
          ui.builderParamsSection = document.getElementById("builderParamsSection");
          ui.builderUserTitleInput = document.getElementById("builderUserTitleInput");
          ui.builderUserDescriptionInput = document.getElementById("builderUserDescriptionInput");
          ui.builderDifficultySelect = document.getElementById("builderDifficultySelect");
          ui.builderAiStyleKeyInput = document.getElementById("builderAiStyleKeyInput");
          ui.builderObjectiveKindField = document.getElementById("builderObjectiveKindField");
          ui.builderObjectiveKindSelect = document.getElementById("builderObjectiveKindSelect");
          ui.builderMaxMessagesInput = document.getElementById("builderMaxMessagesInput");
          ui.builderTimeLimitSecInput = document.getElementById("builderTimeLimitSecInput");
          ui.builderWordLimitInput = document.getElementById("builderWordLimitInput");
          ui.generateConfigBtn = document.getElementById("generateConfigBtn");
          ui.validateConfigBtn = document.getElementById("validateConfigBtn");
          
          ui.contractValidityChip = document.getElementById("contractValidityChip");
          ui.previewChip = document.getElementById("previewChip");
          
          // Validation errors
          ui.missionValidationErrors = document.getElementById("missionValidationErrors");
          ui.missionValidationErrorsList = document.getElementById("missionValidationErrorsList");
          
          // Log
          ui.logArea = document.getElementById("logArea");
          ui.clearLogBtn = document.getElementById("clearLogBtn");
          
          // Check critical elements and log/showError for missing ones (but continue)
          const critical = [
            { el: ui.pingApiBtn, id: "pingApiBtn" },
            { el: ui.loadMetaBtn, id: "loadMetaBtn" },
            { el: ui.loadMissionsBtn, id: "loadMissionsBtn" },
            { el: ui.saveSettingsBtn, id: "saveSettingsBtn" },
            { el: ui.jwtInput, id: "jwtInput" },
            { el: ui.apiBaseInput, id: "apiBaseInput" },
            { el: ui.apiStatusChip, id: "apiStatusChip" },
            { el: ui.metaStatusChip, id: "metaStatusChip" },
            { el: ui.missionsStatusChip, id: "missionsStatusChip" },
            { el: ui.errorBox, id: "errorBox" },
            { el: ui.okBox, id: "okBox" },
            { el: ui.logArea, id: "logArea" },
          ];
          
          const missing = [];
          critical.forEach(({ el, id }) => {
            if (!el) {
              missing.push(id);
              log("ERROR: missing #" + id);
              showError("WARNING: Missing element #" + id);
            }
          });
          
          if (missing.length > 0) {
            log(`UI hydration: ${missing.length} critical elements missing: ${missing.join(", ")}`);
          }
        }

        // ---------------------------
        // Boot
        // ---------------------------
        function boot() {
          // Initialize v2 mode switcher
          initV2ModeSwitcher();
          
          // Wire modal close button
          const modalClose = document.getElementById("missionBuilderClose");
          if (modalClose) {
            modalClose.addEventListener("click", closeMissionBuilderModal);
          }
          
          // Close modal on overlay click
          const modalOverlay = document.getElementById("missionBuilderModal");
          if (modalOverlay) {
            modalOverlay.addEventListener("click", (e) => {
              if (e.target === modalOverlay) {
                closeMissionBuilderModal();
              }
            });
          }
          
          // Close modal on ESC key
          document.addEventListener("keydown", (e) => {
            if (e.key === "Escape") {
              const modal = document.getElementById("missionBuilderModal");
              if (modal && modal.classList.contains("active")) {
                closeMissionBuilderModal();
              }
            }
          });

          // Wire Config Slots buttons
          const saveSlotBtn = document.getElementById("saveConfigSlotBtn");
          const loadSlotBtn = document.getElementById("loadConfigSlotBtn");
          if (saveSlotBtn) {
            saveSlotBtn.addEventListener("click", saveConfigSlot);
          }
          if (loadSlotBtn) {
            loadSlotBtn.addEventListener("click", loadConfigSlot);
          }

          // Load config slots on startup
          loadConfigSlots();
          // Prevent double-boot
          if (booted) {
            return;
          }
          booted = true;
          
          log("[DevDashboard] BOOT_START");
          log("BOOT: start");
          
          // Hydrate UI elements
          hydrateUI();
          log("BOOT: UI hydrated");
          
          loadSettings();
          wire();
          updateMissionPreview();
          
          log("BOOT: events wired");

          // Admin-specific wiring (engine config, AI styles, personas)
          if (typeof wireEngineConfig === "function") {
            wireEngineConfig();
          }
          if (typeof wireAdminSections === "function") {
            wireAdminSections();
          }
          log("BOOT: admin wiring complete");

          if (ui.apiStatusChip) setChip(ui.apiStatusChip, "API: ready", "warn");
          if (ui.metaStatusChip) setChip(ui.metaStatusChip, "Meta: not loaded", "");
          if (ui.missionsStatusChip) setChip(ui.missionsStatusChip, "Missions: not loaded", "");

          log("Dashboard booted. (Single script, single ui object)");
          log("Tip: Click 'Ping API' then 'Load Meta' then 'Load Missions'.");
          
          // Diagnostic: log which UI elements were found
          const found = Object.keys(ui).filter(key => ui[key] !== null && ui[key] !== undefined).length;
          const total = Object.keys(ui).length;
          log(`UI initialization: ${found}/${total} elements found`);
        }

        // Run boot when DOM is ready
        if (document.readyState === "loading") {
          document.addEventListener("DOMContentLoaded", boot);
        } else {
          // DOM already ready, boot immediately
          boot();
        }
        
        // Also try to boot when window loads (double safety)
        window.addEventListener("load", () => {
          if (!booted) {
            boot();
          }
        });
        
        // Step 7.2: Engine Config state (separate from main boot)
        // Step 7.2: Engine Config state
        const engineConfigState = {
              config: null,
              selectedScoringProfile: null,
              selectedDynamicsProfile: null,
              selectedGate: null,
              selectedHook: null,
              selectedInsight: null,
              currentTab: 'scoring',
              hooks: [],
              insights: [],
              triggerStats: null,
              openings: [],
              attachments: [],
              selectedAttachmentMissionId: null,
              isDirty: false, // Wave 1.2: Dirty flag
              isSaving: false, // Step 1: Prevent tab desync during save
              microFeedbackRenderedOnce: false, // Wave 2.2: Track if MicroFeedback tab was ever rendered
              scoringHydrated: false, // Wave 3: Track if Scoring tab DOM has been hydrated from state
              dynamicsHydrated: false, // Wave 3: Track if Dynamics tab DOM has been hydrated from state
              moodHydrated: false, // Wave 3: Track if Mood tab DOM has been hydrated from state
              microDynamicsHydrated: false, // Wave 3: Track if MicroDynamics tab DOM has been hydrated from state
              personaHydrated: false, // Wave 3: Track if Persona tab DOM has been hydrated from state
            };

          // Step 7.2: Engine Config UI elements
          const engineConfigUI = {
            loadBtn: document.getElementById("engineConfigLoadBtn"),
            saveBtn: document.getElementById("engineConfigSaveBtn"),
            tabs: document.querySelectorAll(".engineConfigTab"),
            tabContents: document.querySelectorAll(".engineConfigTabContent"),
            
            // Scoring
            scoringProfilesList: document.getElementById("engineConfigScoringProfilesList"),
            scoringProfileEditor: document.getElementById("engineConfigScoringProfileEditor"),
            scoringProfileEditorEmpty: document.getElementById("engineConfigScoringProfileEditorEmpty"),
            addScoringProfileBtn: document.getElementById("engineConfigAddScoringProfileBtn"),
            normalizeWeightsBtn: document.getElementById("engineConfigScoringNormalizeWeightsBtn"),
            weightsSum: document.getElementById("engineConfigScoringWeightsSum"),
            
            // Dynamics
            dynamicsProfilesList: document.getElementById("engineConfigDynamicsProfilesList"),
            dynamicsProfileEditor: document.getElementById("engineConfigDynamicsProfileEditor"),
            dynamicsProfileEditorEmpty: document.getElementById("engineConfigDynamicsProfileEditorEmpty"),
            addDynamicsProfileBtn: document.getElementById("engineConfigAddDynamicsProfileBtn"),
            dynamicsPreview: document.getElementById("engineConfigDynamicsPreview"),
            
            // Gates
            gatesTableBody: document.getElementById("engineConfigGatesTableBody"),
            gateEditor: document.getElementById("engineConfigGateEditor"),
            addGateBtn: document.getElementById("engineConfigAddGateBtn"),
            
            // Hooks
            hooksTableBody: document.getElementById("engineConfigHooksTableBody"),
            hookEditor: document.getElementById("engineConfigHookEditor"),
            loadHooksBtn: document.getElementById("engineConfigLoadHooksBtn"),
            addHookBtn: document.getElementById("engineConfigAddHookBtn"),
            triggersTableBody: document.getElementById("engineConfigTriggersTableBody"),
            refreshTriggersBtn: document.getElementById("engineConfigRefreshTriggersBtn"),
            
            // Mood
            moodEmaAlpha: document.getElementById("engineConfigMoodEmaAlpha"),
            moodBandsList: document.getElementById("engineConfigMoodBandsList"),
            addMoodBandBtn: document.getElementById("engineConfigMoodAddBandBtn"),
            
            // Insights
            insightsTableBody: document.getElementById("engineConfigInsightsTableBody"),
            insightsKindFilter: document.getElementById("engineConfigInsightsKindFilter"),
            loadInsightsBtn: document.getElementById("engineConfigLoadInsightsBtn"),
            insightDetail: document.getElementById("engineConfigInsightDetail"),
            
            // Monitoring
            monitoringHooksStats: document.getElementById("engineConfigMonitoringHooksStats"),
            refreshMonitoringBtn: document.getElementById("engineConfigRefreshMonitoringBtn"),
            
            // Micro Feedback
            loadMicroFeedbackBtn: document.getElementById("engineConfigLoadMicroFeedbackBtn"),
            microFeedbackTableBody: document.getElementById("engineConfigMicroFeedbackTableBody"),
            
            // Opening Templates
            loadOpeningsBtn: document.getElementById("engineConfigLoadOpeningsBtn"),
            openingsTableBody: document.getElementById("engineConfigOpeningsTableBody"),
            openingDetail: document.getElementById("engineConfigOpeningDetail"),
            insightsSubtabs: document.querySelectorAll("[data-insights-subtab]"),
            
            // Mission Attachments
            loadAttachmentsBtn: document.getElementById("engineConfigLoadAttachmentsBtn"),
            attachmentsCategoryFilter: document.getElementById("engineConfigAttachmentsCategoryFilter"),
            attachmentsSearchInput: document.getElementById("engineConfigAttachmentsSearchInput"),
            attachmentsMissionsList: document.getElementById("engineConfigAttachmentsMissionsList"),
            attachmentsEditor: document.getElementById("engineConfigAttachmentsEditor"),
            attachmentsEditorEmpty: document.getElementById("engineConfigAttachmentsEditorEmpty"),
            attachmentsSaveBtn: document.getElementById("engineConfigAttachmentsSaveBtn"),
            attachmentsResetBtn: document.getElementById("engineConfigAttachmentsResetBtn"),
            attachmentsScoringProfile: document.getElementById("engineConfigAttachmentsScoringProfile"),
            attachmentsDynamicsProfile: document.getElementById("engineConfigAttachmentsDynamicsProfile"),
          };
          

          // Step 7.2: Engine Config functions
          async function loadEngineConfig() {
            try {
              const res = await apiFetch("/v1/admin/engine-config", { method: "GET" });
              // Wave 1.1: apiFetch throws on error, so if we get here it succeeded
              engineConfigState.config = res.config || res;
              setEngineConfigDirty(false); // Wave 1.2: Clear dirty flag on load
              // Wave 3: Reset hydration flags on config load
              engineConfigState.scoringHydrated = false;
              engineConfigState.dynamicsHydrated = false;
              engineConfigState.moodHydrated = false;
              engineConfigState.microDynamicsHydrated = false;
              engineConfigState.personaHydrated = false;
              engineConfigState.microFeedbackRenderedOnce = false; // Wave 3: Reset microFeedback flag too
              showOk("Engine config loaded.");
              renderEngineConfigTabs();
              // Populate mission builder selectors
              populateMissionBuilderSelectors();
            } catch (e) {
              showError("Error loading engine config: " + formatErrorForDisplay(e));
            }
          }

          // Populate dynamics profile and gate pack selectors in mission builder
          function populateMissionBuilderSelectors() {
            if (!engineConfigState.config) return;

            // Populate dynamics profile selector
            const dynamicsSelect = document.getElementById("missionDynamicsProfileSelect");
            if (dynamicsSelect) {
              dynamicsSelect.innerHTML = '<option value="">(None - use per-mission values)</option>';
              const profiles = engineConfigState.config.dynamicsProfiles || [];
              for (const profile of profiles.filter(p => p.active)) {
                const option = document.createElement("option");
                option.value = profile.code;
                option.textContent = `${profile.name} (${profile.code})`;
                dynamicsSelect.appendChild(option);
              }
            }

            // Populate gate pack selector
            const gatePackSelect = document.getElementById("missionGateRequirementPackSelect");
            if (gatePackSelect) {
              gatePackSelect.innerHTML = '<option value="">(Auto - based on objective + difficulty)</option>';
              const templates = engineConfigState.config.gateRequirementTemplates || [];
              for (const template of templates.filter(t => t.active)) {
                const option = document.createElement("option");
                option.value = template.code;
                option.textContent = `${template.name} (${template.code})`;
                gatePackSelect.appendChild(option);
              }
            }
          }

          // Handle dynamics profile selection change
          function onDynamicsProfileChange() {
            const select = document.getElementById("missionDynamicsProfileSelect");
            const descriptionEl = document.getElementById("missionDynamicsProfileDescription");
            const overrideToggle = document.getElementById("missionDynamicsOverrideToggle");
            
            if (!select || !engineConfigState.config) return;
            
            const selectedCode = select.value;
            if (selectedCode) {
              const profile = engineConfigState.config.dynamicsProfiles?.find(p => p.code === selectedCode && p.active);
              if (profile) {
                if (descriptionEl) {
                  descriptionEl.textContent = profile.description || "";
                }
                // If override is not enabled, load profile values into sliders (for preview)
                if (overrideToggle && !overrideToggle.checked && profile) {
                  const setSlider = (id, valId, value) => {
                    const slider = document.getElementById(id);
                    const valSpan = document.getElementById(valId);
                    if (slider && valSpan) {
                      const clamped = Math.max(0, Math.min(100, Math.round(value || 50)));
                      slider.value = clamped;
                      valSpan.textContent = clamped;
                    }
                  };
                  setSlider("missionDynPace", "missionDynPaceVal", profile.pace);
                  setSlider("missionDynEmojiDensity", "missionDynEmojiDensityVal", profile.emojiDensity);
                  setSlider("missionDynFlirtiveness", "missionDynFlirtivenessVal", profile.flirtiveness);
                  setSlider("missionDynHostility", "missionDynHostilityVal", profile.hostility);
                  setSlider("missionDynDryness", "missionDynDrynessVal", profile.dryness);
                  setSlider("missionDynVulnerability", "missionDynVulnerabilityVal", profile.vulnerability);
                  setSlider("missionDynEscalationSpeed", "missionDynEscalationSpeedVal", profile.escalationSpeed);
                  setSlider("missionDynRandomness", "missionDynRandomnessVal", profile.randomness);
                }
              }
            } else {
              if (descriptionEl) descriptionEl.textContent = "";
            }
          }

          // Handle gate pack selection change
          function onGatePackChange() {
            const select = document.getElementById("missionGateRequirementPackSelect");
            const descriptionEl = document.getElementById("missionGateRequirementPackDescription");
            
            if (!select || !engineConfigState.config) return;
            
            const selectedCode = select.value;
            if (selectedCode) {
              const template = engineConfigState.config.gateRequirementTemplates?.find(t => t.code === selectedCode && t.active);
              if (template) {
                if (descriptionEl) {
                  descriptionEl.textContent = `${template.description || ""} (Gates: ${template.requiredGates.join(", ")})`;
                }
              }
            } else {
              if (descriptionEl) descriptionEl.textContent = "Gate requirements will be automatically determined based on objective kind and difficulty level.";
            }
          }

          // Handle dynamics override toggle
          function onDynamicsOverrideToggle() {
            const toggle = document.getElementById("missionDynamicsOverrideToggle");
            const container = document.getElementById("missionDynamicsSlidersContainer");
            if (toggle && container) {
              container.style.display = toggle.checked ? "block" : "none";
            }
          }

          // Wave 4: Sync active tab UI → state before saving
          function syncActiveEngineConfigTabFromUI() {
            const currentTab = engineConfigState.currentTab;
            
            // Only sync if tab is hydrated (Wave 3 guard)
            if (currentTab === 'scoring' && engineConfigState.scoringHydrated) {
              saveScoringProfile();
            } else if (currentTab === 'dynamics' && engineConfigState.dynamicsHydrated) {
              saveDynamicsProfile();
            } else if (currentTab === 'mood' && engineConfigState.moodHydrated) {
              saveMoodConfig();
            } else if (currentTab === 'microDynamics' && engineConfigState.microDynamicsHydrated) {
              saveMicroDynamicsConfig();
            } else if (currentTab === 'persona' && engineConfigState.personaHydrated) {
              savePersonaConfig();
            } else if (currentTab === 'microFeedback') {
              // Wave 2.2: syncMicroFeedbackFromUI() has its own guards
              syncMicroFeedbackFromUI();
            } else {
              log(`Skipping sync for tab '${currentTab}' (not hydrated or no sync needed)`);
            }
          }

          async function saveEngineConfig() {
            if (!engineConfigState.config) {
              showError("No config loaded. Load config first.");
              return;
            }
            
            // Step 1: Prevent tab desync during save
            if (engineConfigState.isSaving) {
              showError("Save already in progress. Please wait.");
              return;
            }
            
            engineConfigState.isSaving = true;
            const tabs = document.querySelectorAll(".engineConfigTab");
            tabs.forEach(tab => {
              if (tab && tab.style) {
                tab.style.pointerEvents = "none";
                tab.style.opacity = "0.6";
              }
            });
            
            try {
              // Wave 4: Sync active tab UI → state before saving (captures latest keystrokes)
              syncActiveEngineConfigTabFromUI();
              











              
              const res = await apiFetch("/v1/admin/engine-config", {
                method: "PUT",
                body: JSON.stringify({ config: engineConfigState.config }),
              });
              // Wave 1.1: apiFetch throws on error, so if we get here it succeeded
              engineConfigState.config = res.config || res; // Update with server response
              setEngineConfigDirty(false); // Wave 1.3: Clear dirty flag on successful save
              // Wave 4: Re-render active tab to reflect server response
              renderEngineConfigTabs();
              showOk("Engine config saved.");
            } catch (e) {
              showError("Error saving engine config: " + formatErrorForDisplay(e));
            } finally {
              engineConfigState.isSaving = false;
              tabs.forEach(tab => {
                if (tab && tab.style) {
                  tab.style.pointerEvents = "";
                  tab.style.opacity = "1";
                }
              });
            }
          }

          function renderEngineConfigTabs() {
            if (engineConfigState.currentTab === 'scoring') {
              renderScoringTab();
            } else if (engineConfigState.currentTab === 'dynamics') {
              renderDynamicsTab();
            } else if (engineConfigState.currentTab === 'gates') {
              renderGatesTab();
            } else if (engineConfigState.currentTab === 'hooks') {
              renderHooksTab();
            } else if (engineConfigState.currentTab === 'mood') {
              renderMoodTab();
            } else if (engineConfigState.currentTab === 'insights') {
              renderInsightsTab();
            } else if (engineConfigState.currentTab === 'monitoring') {
              renderMonitoringTab();
            } else if (engineConfigState.currentTab === 'attachments') {
              // Attachments tab doesn't need special rendering, just load if needed
              if (engineConfigState.attachments.length === 0) {
                loadMissionAttachments();
              } else {
                renderMissionAttachmentsTable();
              }
            } else if (engineConfigState.currentTab === 'microFeedback') {
              renderMicroFeedbackTab();
            } else if (engineConfigState.currentTab === 'microDynamics') {
              renderMicroDynamicsTab();
            } else if (engineConfigState.currentTab === 'persona') {
              renderPersonaTab();
            }
          }

          function renderScoringTab() {
            if (!engineConfigState.config) return;
            const profiles = engineConfigState.config.scoringProfiles || [];
            engineConfigUI.scoringProfilesList.innerHTML = "";
            for (const profile of profiles) {
              const el = document.createElement("div");
              el.className = "item";
              if (engineConfigState.selectedScoringProfile === profile.code) {
                el.classList.add("active");
              }
              el.innerHTML = `
                <div class="itemTitle">
                  <span>${escapeHtml(profile.name || profile.code)}</span>
                  <span style="font-size: 11px; color: var(--muted);">${profile.active ? "✓" : "✗"}</span>
                </div>
                <div class="itemMeta">
                  <span>${escapeHtml(profile.code)}</span>
                </div>
              `;
              el.addEventListener("click", () => selectScoringProfile(profile.code));
              engineConfigUI.scoringProfilesList.appendChild(el);
            }
            engineConfigState.scoringHydrated = true; // Wave 3: Mark as hydrated after DOM populated from state
          }

          function selectScoringProfile(code) {
            if (!engineConfigState.config) return;
            const profile = engineConfigState.config.scoringProfiles.find(p => p.code === code);
            if (!profile) return;
            engineConfigState.selectedScoringProfile = code;
            engineConfigUI.scoringProfileEditor.style.display = "block";
            engineConfigUI.scoringProfileEditorEmpty.style.display = "none";
            
            // Populate form
            document.getElementById("engineConfigScoringCode").value = profile.code || "";
            document.getElementById("engineConfigScoringName").value = profile.name || "";
            document.getElementById("engineConfigScoringDescription").value = profile.description || "";
            document.getElementById("engineConfigScoringActive").checked = profile.active !== false;
            
            const w = profile.traitWeights || {};
            document.getElementById("engineConfigScoringWeightConfidence").value = w.confidence || 0;
            document.getElementById("engineConfigScoringWeightClarity").value = w.clarity || 0;
            document.getElementById("engineConfigScoringWeightHumor").value = w.humor || 0;
            document.getElementById("engineConfigScoringWeightTensionControl").value = w.tensionControl || 0;
            document.getElementById("engineConfigScoringWeightEmotionalWarmth").value = w.emotionalWarmth || 0;
            document.getElementById("engineConfigScoringWeightDominance").value = w.dominance || 0;
            updateWeightsSum();
            
            const lt = profile.lengthThresholds || {};
            document.getElementById("engineConfigScoringLengthEmpty").value = lt.empty || 10;
            document.getElementById("engineConfigScoringLengthVeryShort").value = lt.veryShort || 35;
            document.getElementById("engineConfigScoringLengthShort").value = lt.short || 55;
            document.getElementById("engineConfigScoringLengthMedium").value = lt.medium || 75;
            document.getElementById("engineConfigScoringLengthLong").value = lt.long || 82;
            document.getElementById("engineConfigScoringLengthVeryLong").value = lt.veryLong || 70;
            
            const pb = profile.punctuationBonuses || {};
            document.getElementById("engineConfigScoringPunctQuestionPerMark").value = pb.questionPerMark || 2;
            document.getElementById("engineConfigScoringPunctQuestionMax").value = pb.questionMax || 10;
            document.getElementById("engineConfigScoringPunctExclamationPerMark").value = pb.exclamationPerMark || 3;
            document.getElementById("engineConfigScoringPunctExclamationMax").value = pb.exclamationMax || 12;
            
            const pos = profile.positionBonuses || [0, 2, 4, 5];
            document.getElementById("engineConfigScoringPosition0").value = pos[0] || 0;
            document.getElementById("engineConfigScoringPosition1").value = pos[1] || 2;
            document.getElementById("engineConfigScoringPosition2").value = pos[2] || 4;
            document.getElementById("engineConfigScoringPosition3").value = pos[3] || 5;
            
            const rt = profile.rarityThresholds || {};
            document.getElementById("engineConfigScoringRaritySPlus").value = rt.sPlus || 92;
            document.getElementById("engineConfigScoringRarityS").value = rt.s || 84;
            document.getElementById("engineConfigScoringRarityA").value = rt.a || 72;
            document.getElementById("engineConfigScoringRarityB").value = rt.b || 58;
            
            const xp = profile.xpMultipliers || {};
            document.getElementById("engineConfigScoringXpSPlus").value = xp.sPlus || 1.8;
            document.getElementById("engineConfigScoringXpS").value = xp.s || 1.5;
            document.getElementById("engineConfigScoringXpA").value = xp.a || 1.25;
            document.getElementById("engineConfigScoringXpB").value = xp.b || 1.0;
            document.getElementById("engineConfigScoringXpC").value = xp.c || 0.8;
            
            const coins = profile.coinsMultipliers || {};
            document.getElementById("engineConfigScoringCoinsSPlus").value = coins.sPlus || 1.7;
            document.getElementById("engineConfigScoringCoinsS").value = coins.s || 1.4;
            document.getElementById("engineConfigScoringCoinsA").value = coins.a || 1.2;
            document.getElementById("engineConfigScoringCoinsB").value = coins.b || 1.0;
            document.getElementById("engineConfigScoringCoinsC").value = coins.c || 0.7;
            
            document.getElementById("engineConfigScoringTraitEmaAlpha").value = profile.traitEmaAlpha || 0.3;
            document.getElementById("engineConfigScoringStrictMode").checked = profile.strictMode === true;
            document.getElementById("engineConfigScoringSoftCoachingMode").checked = profile.softCoachingMode === true;
            
            renderScoringTab(); // Re-render to highlight selected
          }

          function updateWeightsSum() {
            const sum = 
              parseFloat(document.getElementById("engineConfigScoringWeightConfidence").value || 0) +
              parseFloat(document.getElementById("engineConfigScoringWeightClarity").value || 0) +
              parseFloat(document.getElementById("engineConfigScoringWeightHumor").value || 0) +
              parseFloat(document.getElementById("engineConfigScoringWeightTensionControl").value || 0) +
              parseFloat(document.getElementById("engineConfigScoringWeightEmotionalWarmth").value || 0) +
              parseFloat(document.getElementById("engineConfigScoringWeightDominance").value || 0);
            engineConfigUI.weightsSum.textContent = `Sum: ${sum.toFixed(2)} ${Math.abs(sum - 1.0) < 0.1 ? "✓" : "⚠ (should be ~1.0)"}`;
            engineConfigUI.weightsSum.style.color = Math.abs(sum - 1.0) < 0.1 ? "var(--ok)" : "var(--warn)";
          }

          function normalizeWeights() {
            const sum = 
              parseFloat(document.getElementById("engineConfigScoringWeightConfidence").value || 0) +
              parseFloat(document.getElementById("engineConfigScoringWeightClarity").value || 0) +
              parseFloat(document.getElementById("engineConfigScoringWeightHumor").value || 0) +
              parseFloat(document.getElementById("engineConfigScoringWeightTensionControl").value || 0) +
              parseFloat(document.getElementById("engineConfigScoringWeightEmotionalWarmth").value || 0) +
              parseFloat(document.getElementById("engineConfigScoringWeightDominance").value || 0);
            if (sum === 0) {
              showError("Cannot normalize: all weights are zero");
              return;
            }
            document.getElementById("engineConfigScoringWeightConfidence").value = (parseFloat(document.getElementById("engineConfigScoringWeightConfidence").value || 0) / sum).toFixed(3);
            document.getElementById("engineConfigScoringWeightClarity").value = (parseFloat(document.getElementById("engineConfigScoringWeightClarity").value || 0) / sum).toFixed(3);
            document.getElementById("engineConfigScoringWeightHumor").value = (parseFloat(document.getElementById("engineConfigScoringWeightHumor").value || 0) / sum).toFixed(3);
            document.getElementById("engineConfigScoringWeightTensionControl").value = (parseFloat(document.getElementById("engineConfigScoringWeightTensionControl").value || 0) / sum).toFixed(3);
            document.getElementById("engineConfigScoringWeightEmotionalWarmth").value = (parseFloat(document.getElementById("engineConfigScoringWeightEmotionalWarmth").value || 0) / sum).toFixed(3);
            document.getElementById("engineConfigScoringWeightDominance").value = (parseFloat(document.getElementById("engineConfigScoringWeightDominance").value || 0) / sum).toFixed(3);
            updateWeightsSum();
            showOk("Weights normalized to sum to 1.0");
          }

          function saveScoringProfile() {
            // Wave 3: Guard against writing defaults if tab was never hydrated
            if (!engineConfigState.scoringHydrated) {
              log("WARNING: saveScoringProfile() called before Scoring tab hydrated. Skipping to prevent corruption.");
              return;
            }
            if (!engineConfigState.config || !engineConfigState.selectedScoringProfile) return;
            const profile = engineConfigState.config.scoringProfiles.find(p => p.code === engineConfigState.selectedScoringProfile);
            if (!profile) return;
            
            profile.name = document.getElementById("engineConfigScoringName").value.trim();
            profile.description = document.getElementById("engineConfigScoringDescription").value.trim();
            profile.active = document.getElementById("engineConfigScoringActive").checked;
            
            profile.traitWeights = {
              confidence: parseFloat(document.getElementById("engineConfigScoringWeightConfidence").value || 0),
              clarity: parseFloat(document.getElementById("engineConfigScoringWeightClarity").value || 0),
              humor: parseFloat(document.getElementById("engineConfigScoringWeightHumor").value || 0),
              tensionControl: parseFloat(document.getElementById("engineConfigScoringWeightTensionControl").value || 0),
              emotionalWarmth: parseFloat(document.getElementById("engineConfigScoringWeightEmotionalWarmth").value || 0),
              dominance: parseFloat(document.getElementById("engineConfigScoringWeightDominance").value || 0),
            };
            
            profile.lengthThresholds = {
              empty: parseInt(document.getElementById("engineConfigScoringLengthEmpty").value || 10),
              veryShort: parseInt(document.getElementById("engineConfigScoringLengthVeryShort").value || 35),
              short: parseInt(document.getElementById("engineConfigScoringLengthShort").value || 55),
              medium: parseInt(document.getElementById("engineConfigScoringLengthMedium").value || 75),
              long: parseInt(document.getElementById("engineConfigScoringLengthLong").value || 82),
              veryLong: parseInt(document.getElementById("engineConfigScoringLengthVeryLong").value || 70),
            };
            
            profile.punctuationBonuses = {
              questionPerMark: parseInt(document.getElementById("engineConfigScoringPunctQuestionPerMark").value || 2),
              questionMax: parseInt(document.getElementById("engineConfigScoringPunctQuestionMax").value || 10),
              exclamationPerMark: parseInt(document.getElementById("engineConfigScoringPunctExclamationPerMark").value || 3),
              exclamationMax: parseInt(document.getElementById("engineConfigScoringPunctExclamationMax").value || 12),
            };
            
            profile.positionBonuses = [
              parseInt(document.getElementById("engineConfigScoringPosition0").value || 0),
              parseInt(document.getElementById("engineConfigScoringPosition1").value || 2),
              parseInt(document.getElementById("engineConfigScoringPosition2").value || 4),
              parseInt(document.getElementById("engineConfigScoringPosition3").value || 5),
            ];
            
            profile.rarityThresholds = {
              sPlus: parseInt(document.getElementById("engineConfigScoringRaritySPlus").value || 92),
              s: parseInt(document.getElementById("engineConfigScoringRarityS").value || 84),
              a: parseInt(document.getElementById("engineConfigScoringRarityA").value || 72),
              b: parseInt(document.getElementById("engineConfigScoringRarityB").value || 58),
              c: 0,
            };
            
            profile.xpMultipliers = {
              sPlus: parseFloat(document.getElementById("engineConfigScoringXpSPlus").value || 1.8),
              s: parseFloat(document.getElementById("engineConfigScoringXpS").value || 1.5),
              a: parseFloat(document.getElementById("engineConfigScoringXpA").value || 1.25),
              b: parseFloat(document.getElementById("engineConfigScoringXpB").value || 1.0),
              c: parseFloat(document.getElementById("engineConfigScoringXpC").value || 0.8),
            };
            
            profile.coinsMultipliers = {
              sPlus: parseFloat(document.getElementById("engineConfigScoringCoinsSPlus").value || 1.7),
              s: parseFloat(document.getElementById("engineConfigScoringCoinsS").value || 1.4),
              a: parseFloat(document.getElementById("engineConfigScoringCoinsA").value || 1.2),
              b: parseFloat(document.getElementById("engineConfigScoringCoinsB").value || 1.0),
              c: parseFloat(document.getElementById("engineConfigScoringCoinsC").value || 0.7),
            };
            
            profile.traitEmaAlpha = parseFloat(document.getElementById("engineConfigScoringTraitEmaAlpha").value || 0.3);
            profile.strictMode = document.getElementById("engineConfigScoringStrictMode").checked;
            profile.softCoachingMode = document.getElementById("engineConfigScoringSoftCoachingMode").checked;
            
            setEngineConfigDirty(true); // Step 1: Mark dirty on edit
            showOk("Scoring profile updated (click 'Save Config' to persist)");
          }

          function renderMicroFeedbackTab() {
            engineConfigState.microFeedbackRenderedOnce = true; // Wave 2.2: Mark as rendered
            if (!engineConfigState.config) return;
            const microFeedback = engineConfigState.config.microFeedback || {};
            
            document.getElementById("engineConfigMicroFeedbackVeryShortMsg").value = microFeedback.veryShortMessage || "";
            document.getElementById("engineConfigMicroFeedbackDefaultMsg").value = microFeedback.defaultMessage || "";
            
            const bands = microFeedback.bands || [];
            const bandsList = document.getElementById("engineConfigMicroFeedbackBandsList");
            bandsList.innerHTML = "";
            for (let i = 0; i < bands.length; i++) {
              const band = bands[i];
              const div = document.createElement("div");
              div.style.display = "flex";
              div.style.gap = "8px";
              div.style.marginBottom = "8px";
              div.style.alignItems = "center";
              div.innerHTML = `
                <input type="number" id="engineConfigMicroFeedbackBandMin${i}" value="${band.minScore || 0}" min="0" max="100" placeholder="Min Score" style="width: 100px;" />
                <input type="number" id="engineConfigMicroFeedbackBandMax${i}" value="${band.maxScore || 100}" min="0" max="100" placeholder="Max Score" style="width: 100px;" />
                <select id="engineConfigMicroFeedbackBandRarity${i}" style="width: 80px; background: var(--controlBg); border: 1px solid var(--controlBorder); border-radius: 6px; padding: 4px 8px; color: var(--text);">
                  <option value="S+" ${band.rarity === 'S+' ? 'selected' : ''}>S+</option>
                  <option value="S" ${band.rarity === 'S' ? 'selected' : ''}>S</option>
                  <option value="A" ${band.rarity === 'A' ? 'selected' : ''}>A</option>
                  <option value="B" ${band.rarity === 'B' ? 'selected' : ''}>B</option>
                  <option value="C" ${band.rarity === 'C' ? 'selected' : ''}>C</option>
                </select>
                <textarea id="engineConfigMicroFeedbackBandMessage${i}" placeholder="Feedback message..." style="flex: 1; min-height: 40px;">${escapeHtml(band.message || "")}</textarea>
                <button class="btn" style="padding: 4px 8px; font-size: 11px;" onclick="removeMicroFeedbackBand(${i})">Remove</button>
              `;
              bandsList.appendChild(div);
              
              // Wave 1.3: Live-binding - attach listeners after creating row
              const minEl = document.getElementById(`engineConfigMicroFeedbackBandMin${i}`);
              const maxEl = document.getElementById(`engineConfigMicroFeedbackBandMax${i}`);
              const rarityEl = document.getElementById(`engineConfigMicroFeedbackBandRarity${i}`);
              const messageEl = document.getElementById(`engineConfigMicroFeedbackBandMessage${i}`);
              
              if (minEl) {
                minEl.addEventListener("input", () => {
                  setEngineConfigDirty(true);
                  syncMicroFeedbackFromUI();
                });
              }
              if (maxEl) {
                maxEl.addEventListener("input", () => {
                  setEngineConfigDirty(true);
                  syncMicroFeedbackFromUI();
                });
              }
              if (rarityEl) {
                rarityEl.addEventListener("change", () => {
                  setEngineConfigDirty(true);
                  syncMicroFeedbackFromUI();
                });
              }
              if (messageEl) {
                messageEl.addEventListener("input", () => {
                  setEngineConfigDirty(true);
                  syncMicroFeedbackFromUI();
                });
              }
            }
          }

          function saveMicroFeedbackConfig() {
            if (!engineConfigState.config) return;
            if (!engineConfigState.config.microFeedback) {
              engineConfigState.config.microFeedback = {};
            }
            
            engineConfigState.config.microFeedback.veryShortMessage = document.getElementById("engineConfigMicroFeedbackVeryShortMsg").value.trim();
            engineConfigState.config.microFeedback.defaultMessage = document.getElementById("engineConfigMicroFeedbackDefaultMsg").value.trim();
            
            const bands = [];
            const bandsList = document.getElementById("engineConfigMicroFeedbackBandsList");
            const bandDivs = bandsList.querySelectorAll("div");
            for (let i = 0; i < bandDivs.length; i++) {
              const minScore = parseInt(document.getElementById(`engineConfigMicroFeedbackBandMin${i}`)?.value || 0);
              const maxScore = parseInt(document.getElementById(`engineConfigMicroFeedbackBandMax${i}`)?.value || 100);
              const rarity = document.getElementById(`engineConfigMicroFeedbackBandRarity${i}`)?.value || "C";
              const message = document.getElementById(`engineConfigMicroFeedbackBandMessage${i}`)?.value.trim() || "";
              if (message) {
                bands.push({ minScore, maxScore, rarity, message });
              }
            }
            engineConfigState.config.microFeedback.bands = bands;
            
            showOk("Micro feedback config updated (click 'Save Config' to persist)");
          }

          // Wave 1.2: Dirty flag management
          function setEngineConfigDirty(flag) {
            engineConfigState.isDirty = flag;
            log(`EngineConfig dirty = ${flag}`);
            // Update UI marker if available
            const dirtyMarker = document.getElementById("engineConfigDirtyMarker");
            if (dirtyMarker) {
              dirtyMarker.style.display = flag ? "inline" : "none";
              dirtyMarker.textContent = flag ? "●" : "";
            }
            // Patch A: Disable/enable Save button based on dirty state
            if (engineConfigUI.saveBtn) {
              engineConfigUI.saveBtn.disabled = !flag;
            }
          }

          // Wave 1.3: Sync Micro Feedback UI → state (NO DATA LOSS)
          function syncMicroFeedbackFromUI() {
            // Wave 2.2: Hard guard - don't sync if tab was never rendered and not currently active
            if (!engineConfigState.microFeedbackRenderedOnce && engineConfigState.currentTab !== 'microFeedback') {
              log("WARNING: syncMicroFeedbackFromUI() called but MicroFeedback tab was never rendered. Skipping to prevent data loss.");
              return;
            }
            
            if (!engineConfigState.config) return;
            if (!engineConfigState.config.microFeedback) {
              engineConfigState.config.microFeedback = {};
            }
            
            // Wave 1.3: Compute before state for dirty detection
            const before = JSON.stringify(engineConfigState.config.microFeedback || {});
            
            const veryShortMsg = document.getElementById("engineConfigMicroFeedbackVeryShortMsg")?.value.trim() || "";
            const defaultMsg = document.getElementById("engineConfigMicroFeedbackDefaultMsg")?.value.trim() || "";
            
            engineConfigState.config.microFeedback.veryShortMessage = veryShortMsg;
            engineConfigState.config.microFeedback.defaultMessage = defaultMsg;
            
            // Wave 1.3: Sync bands using index-based loop (not querySelectorAll)
            // Loop i=0 until inputs missing - never filter by message
            const bands = [];
            let i = 0;
            while (true) {
              const minEl = document.getElementById(`engineConfigMicroFeedbackBandMin${i}`);
              const maxEl = document.getElementById(`engineConfigMicroFeedbackBandMax${i}`);
              const rarityEl = document.getElementById(`engineConfigMicroFeedbackBandRarity${i}`);
              const messageEl = document.getElementById(`engineConfigMicroFeedbackBandMessage${i}`);
              
              // Stop if any required element is missing
              if (!minEl || !maxEl || !rarityEl || !messageEl) {
                break;
              }
              
              // Wave 1.3: Never filter by message - persist all bands even if message is ""
              let minScore = parseInt(minEl.value || 0);
              let maxScore = parseInt(maxEl.value || 100);
              const rarity = rarityEl.value || "C";
              const message = messageEl.value.trim() || "";
              
              // Wave 1.3: Coerce NaN to defaults (log warning, don't spam showError)
              if (isNaN(minScore)) {
                log(`WARNING: Invalid minScore for band ${i}: ${minEl.value}, using default 0`);
                minScore = 0;
              }
              if (isNaN(maxScore)) {
                log(`WARNING: Invalid maxScore for band ${i}: ${maxEl.value}, using default 100`);
                maxScore = 100;
              }
              
              // Wave 1.3: Always push band (even if message is empty)
              bands.push({
                minScore: minScore,
                maxScore: maxScore,
                rarity: rarity,
                message: message,
              });
              
              i++;
            }
            
            engineConfigState.config.microFeedback.bands = bands;
            
            // Wave 1.3: Dirty detection using JSON comparison (covers bands too)
            const after = JSON.stringify(engineConfigState.config.microFeedback || {});
            if (before !== after) {
              setEngineConfigDirty(true);
            }
          }

          function addMicroFeedbackBand() {
            // Wave 1.1: Show error if config not loaded (no silent failure)
            if (!engineConfigState.config) {
              showError("Load config first before adding bands");
              log("CLICK FAILED: Add Band - Config not loaded");
              return;
            }
            if (!engineConfigState.config.microFeedback) {
              engineConfigState.config.microFeedback = { bands: [] };
            }
            engineConfigState.config.microFeedback.bands = engineConfigState.config.microFeedback.bands || [];
            engineConfigState.config.microFeedback.bands.push({ minScore: 0, maxScore: 100, rarity: 'C', message: '' });
            const count = engineConfigState.config.microFeedback.bands.length;
            renderMicroFeedbackTab();
            setEngineConfigDirty(true); // Wave 1.2: Mark dirty
            log(`MicroFeedback: band added (count=${count})`);
          }

          window.removeMicroFeedbackBand = function(index) {
            if (!engineConfigState.config || !engineConfigState.config.microFeedback) return;
            engineConfigState.config.microFeedback.bands = engineConfigState.config.microFeedback.bands || [];
            engineConfigState.config.microFeedback.bands.splice(index, 1);
            renderMicroFeedbackTab();
            setEngineConfigDirty(true); // Wave 1.2: Mark dirty
          };

          function renderMicroDynamicsTab() {
            if (!engineConfigState.config) return;
            const microDynamics = engineConfigState.config.microDynamics || {};
            
            const risk = microDynamics.risk || {};
            const baseRisk = risk.baseRiskFromScore || { min: 20, max: 80 };
            const tensionPenalty = risk.tensionPenalty || { threshold: 0.3, maxPenalty: 35 };
            const difficultyAdjustments = risk.difficultyAdjustments || { HARD: -15, MEDIUM: -5, EASY: 0 };
            const progressAdjustments = risk.progressAdjustments || { early: -10, late: 10 };
            
            document.getElementById("engineConfigMicroDynamicsRiskBaseMin").value = baseRisk.min || 20;
            document.getElementById("engineConfigMicroDynamicsRiskBaseMax").value = baseRisk.max || 80;
            document.getElementById("engineConfigMicroDynamicsRiskTensionThreshold").value = tensionPenalty.threshold || 0.3;
            document.getElementById("engineConfigMicroDynamicsRiskTensionMaxPenalty").value = tensionPenalty.maxPenalty || 35;
            document.getElementById("engineConfigMicroDynamicsRiskDifficultyHard").value = difficultyAdjustments.HARD || -15;
            document.getElementById("engineConfigMicroDynamicsRiskDifficultyMedium").value = difficultyAdjustments.MEDIUM || -5;
            document.getElementById("engineConfigMicroDynamicsRiskProgressEarly").value = progressAdjustments.early || -10;
            document.getElementById("engineConfigMicroDynamicsRiskProgressLate").value = progressAdjustments.late || 10;
            
            const momentum = microDynamics.momentum || {};
            document.getElementById("engineConfigMicroDynamicsMomentumScoreDelta").value = momentum.scoreDeltaMultiplier || 0.5;
            document.getElementById("engineConfigMicroDynamicsMomentumGateProgress").value = momentum.gateProgressMultiplier || 0.3;
            const moodBonuses = momentum.moodBonuses || { positive: 10, negative: -10 };
            document.getElementById("engineConfigMicroDynamicsMomentumMoodPositive").value = moodBonuses.positive || 10;
            document.getElementById("engineConfigMicroDynamicsMomentumMoodNegative").value = moodBonuses.negative || -10;
            document.getElementById("engineConfigMicroDynamicsMomentumTrend").value = momentum.trendMultiplier || 0.3;
            
            const flow = microDynamics.flow || {};
            document.getElementById("engineConfigMicroDynamicsFlowVariance").value = flow.varianceToFlowMultiplier || 2.0;
            engineConfigState.microDynamicsHydrated = true; // Wave 3: Mark as hydrated after DOM populated from state
          }

          function saveMicroDynamicsConfig() {
            // Wave 3: Guard against writing defaults if tab was never hydrated
            if (!engineConfigState.microDynamicsHydrated) {
              log("WARNING: saveMicroDynamicsConfig() called before MicroDynamics tab hydrated. Skipping to prevent corruption.");
              return;
            }
            if (!engineConfigState.config) return;
            if (!engineConfigState.config.microDynamics) {
              engineConfigState.config.microDynamics = {};
            }
            
            engineConfigState.config.microDynamics.risk = {
              baseRiskFromScore: {
                min: parseInt(document.getElementById("engineConfigMicroDynamicsRiskBaseMin").value || 20),
                max: parseInt(document.getElementById("engineConfigMicroDynamicsRiskBaseMax").value || 80),
              },
              tensionPenalty: {
                threshold: parseFloat(document.getElementById("engineConfigMicroDynamicsRiskTensionThreshold").value || 0.3),
                maxPenalty: parseInt(document.getElementById("engineConfigMicroDynamicsRiskTensionMaxPenalty").value || 35),
              },
              difficultyAdjustments: {
                HARD: parseInt(document.getElementById("engineConfigMicroDynamicsRiskDifficultyHard").value || -15),
                MEDIUM: parseInt(document.getElementById("engineConfigMicroDynamicsRiskDifficultyMedium").value || -5),
                EASY: 0,
              },
              progressAdjustments: {
                early: parseInt(document.getElementById("engineConfigMicroDynamicsRiskProgressEarly").value || -10),
                late: parseInt(document.getElementById("engineConfigMicroDynamicsRiskProgressLate").value || 10),
              },
            };
            
            engineConfigState.config.microDynamics.momentum = {
              scoreDeltaMultiplier: parseFloat(document.getElementById("engineConfigMicroDynamicsMomentumScoreDelta").value || 0.5),
              gateProgressMultiplier: parseFloat(document.getElementById("engineConfigMicroDynamicsMomentumGateProgress").value || 0.3),
              moodBonuses: {
                positive: parseInt(document.getElementById("engineConfigMicroDynamicsMomentumMoodPositive").value || 10),
                negative: parseInt(document.getElementById("engineConfigMicroDynamicsMomentumMoodNegative").value || -10),
              },
              trendMultiplier: parseFloat(document.getElementById("engineConfigMicroDynamicsMomentumTrend").value || 0.3),
            };
            
            engineConfigState.config.microDynamics.flow = {
              varianceToFlowMultiplier: parseFloat(document.getElementById("engineConfigMicroDynamicsFlowVariance").value || 2.0),
            };
            
            setEngineConfigDirty(true); // Step 1: Mark dirty on edit
            showOk("Micro dynamics config updated (click 'Save Config' to persist)");
          }

          function renderPersonaTab() {
            if (!engineConfigState.config) return;
            const persona = engineConfigState.config.persona || {};
            
            const driftPenalties = persona.driftPenalties || {};
            document.getElementById("engineConfigPersonaDriftStyleMoodConflict").value = driftPenalties.styleMoodConflict || -20;
            document.getElementById("engineConfigPersonaDriftStyleMoodConflictMinor").value = driftPenalties.styleMoodConflictMinor || -15;
            document.getElementById("engineConfigPersonaDriftDynamicsMoodConflict").value = driftPenalties.dynamicsMoodConflict || -15;
            document.getElementById("engineConfigPersonaDriftVulnerabilityMoodConflict").value = driftPenalties.vulnerabilityMoodConflict || -10;
            document.getElementById("engineConfigPersonaDriftScoreStyleConflict").value = driftPenalties.scoreStyleConflict || -15;
            document.getElementById("engineConfigPersonaDriftNegativeFlagsConflict").value = driftPenalties.negativeFlagsConflict || -10;
            
            const modifierEvents = persona.modifierEvents || {};
            document.getElementById("engineConfigPersonaModifierTensionSpike").value = modifierEvents.tensionSpikeThreshold || 0.7;
            const moodDrop = modifierEvents.moodDropSeverity || { low: 0.6, high: 0.9 };
            document.getElementById("engineConfigPersonaModifierMoodDropLow").value = moodDrop.low || 0.6;
            document.getElementById("engineConfigPersonaModifierMoodDropHigh").value = moodDrop.high || 0.9;
            document.getElementById("engineConfigPersonaModifierScoreCollapse").value = modifierEvents.scoreCollapseThreshold || 30;
            document.getElementById("engineConfigPersonaModifierScoreCollapseDivisor").value = modifierEvents.scoreCollapseSeverityDivisor || 50;
            document.getElementById("engineConfigPersonaModifierNegativeFlags").value = modifierEvents.negativeFlagsThreshold || 2;
            document.getElementById("engineConfigPersonaModifierNegativeFlagsDivisor").value = modifierEvents.negativeFlagsSeverityDivisor || 3;
            
            const modifierEffects = persona.modifierEffects || {};
            document.getElementById("engineConfigPersonaModifierEffectReduceRisk").value = modifierEffects.reduceRiskAmount || -20;
            document.getElementById("engineConfigPersonaModifierEffectLowerWarmth").value = modifierEffects.lowerWarmthAmount || -15;
            engineConfigState.personaHydrated = true; // Wave 3: Mark as hydrated after DOM populated from state
          }

          function savePersonaConfig() {
            // Wave 3: Guard against writing defaults if tab was never hydrated
            if (!engineConfigState.personaHydrated) {
              log("WARNING: savePersonaConfig() called before Persona tab hydrated. Skipping to prevent corruption.");
              return;
            }
            if (!engineConfigState.config) return;
            if (!engineConfigState.config.persona) {
              engineConfigState.config.persona = {};
            }
            
            engineConfigState.config.persona.driftPenalties = {
              styleMoodConflict: parseInt(document.getElementById("engineConfigPersonaDriftStyleMoodConflict").value || -20),
              styleMoodConflictMinor: parseInt(document.getElementById("engineConfigPersonaDriftStyleMoodConflictMinor").value || -15),
              dynamicsMoodConflict: parseInt(document.getElementById("engineConfigPersonaDriftDynamicsMoodConflict").value || -15),
              vulnerabilityMoodConflict: parseInt(document.getElementById("engineConfigPersonaDriftVulnerabilityMoodConflict").value || -10),
              scoreStyleConflict: parseInt(document.getElementById("engineConfigPersonaDriftScoreStyleConflict").value || -15),
              negativeFlagsConflict: parseInt(document.getElementById("engineConfigPersonaDriftNegativeFlagsConflict").value || -10),
            };
            
            engineConfigState.config.persona.modifierEvents = {
              tensionSpikeThreshold: parseFloat(document.getElementById("engineConfigPersonaModifierTensionSpike").value || 0.7),
              moodDropSeverity: {
                low: parseFloat(document.getElementById("engineConfigPersonaModifierMoodDropLow").value || 0.6),
                high: parseFloat(document.getElementById("engineConfigPersonaModifierMoodDropHigh").value || 0.9),
              },
              scoreCollapseThreshold: parseInt(document.getElementById("engineConfigPersonaModifierScoreCollapse").value || 30),
              scoreCollapseSeverityDivisor: parseInt(document.getElementById("engineConfigPersonaModifierScoreCollapseDivisor").value || 50),
              negativeFlagsThreshold: parseInt(document.getElementById("engineConfigPersonaModifierNegativeFlags").value || 2),
              negativeFlagsSeverityDivisor: parseInt(document.getElementById("engineConfigPersonaModifierNegativeFlagsDivisor").value || 3),
            };
            
            engineConfigState.config.persona.modifierEffects = {
              reduceRiskAmount: parseInt(document.getElementById("engineConfigPersonaModifierEffectReduceRisk").value || -20),
              lowerWarmthAmount: parseInt(document.getElementById("engineConfigPersonaModifierEffectLowerWarmth").value || -15),
            };
            
            setEngineConfigDirty(true); // Step 1: Mark dirty on edit
            showOk("Persona config updated (click 'Save Config' to persist)");
          }

          function renderDynamicsTab() {
            if (!engineConfigState.config) return;
            const profiles = engineConfigState.config.dynamicsProfiles || [];
            engineConfigUI.dynamicsProfilesList.innerHTML = "";
            for (const profile of profiles) {
              const el = document.createElement("div");
              el.className = "item";
              if (engineConfigState.selectedDynamicsProfile === profile.code) {
                el.classList.add("active");
              }
              el.innerHTML = `
                <div class="itemTitle">
                  <span>${escapeHtml(profile.name || profile.code)}</span>
                  <span style="font-size: 11px; color: var(--muted);">${profile.active ? "✓" : "✗"}</span>
                </div>
                <div class="itemMeta">
                  <span>${escapeHtml(profile.code)}</span>
                </div>
              `;
              el.addEventListener("click", () => selectDynamicsProfile(profile.code));
              engineConfigUI.dynamicsProfilesList.appendChild(el);
            }
            engineConfigState.dynamicsHydrated = true; // Wave 3: Mark as hydrated after DOM populated from state
          }

          function selectDynamicsProfile(code) {
            if (!engineConfigState.config) return;
            const profile = engineConfigState.config.dynamicsProfiles.find(p => p.code === code);
            if (!profile) return;
            engineConfigState.selectedDynamicsProfile = code;
            engineConfigUI.dynamicsProfileEditor.style.display = "block";
            engineConfigUI.dynamicsProfileEditorEmpty.style.display = "none";
            
            document.getElementById("engineConfigDynamicsCode").value = profile.code || "";
            document.getElementById("engineConfigDynamicsName").value = profile.name || "";
            document.getElementById("engineConfigDynamicsDescription").value = profile.description || "";
            document.getElementById("engineConfigDynamicsActive").checked = profile.active !== false;
            
            document.getElementById("engineConfigDynamicsPace").value = profile.pace || 50;
            document.getElementById("engineConfigDynamicsEmojiDensity").value = profile.emojiDensity || 30;
            document.getElementById("engineConfigDynamicsFlirtiveness").value = profile.flirtiveness || 40;
            document.getElementById("engineConfigDynamicsHostility").value = profile.hostility || 10;
            document.getElementById("engineConfigDynamicsDryness").value = profile.dryness || 40;
            document.getElementById("engineConfigDynamicsVulnerability").value = profile.vulnerability || 50;
            document.getElementById("engineConfigDynamicsEscalationSpeed").value = profile.escalationSpeed || 50;
            document.getElementById("engineConfigDynamicsRandomness").value = profile.randomness || 25;
            
            updateDynamicsValues();
            updateDynamicsPreview();
            renderDynamicsTab();
          }

          function updateDynamicsValues() {
            document.getElementById("engineConfigDynamicsPaceValue").textContent = document.getElementById("engineConfigDynamicsPace").value;
            document.getElementById("engineConfigDynamicsEmojiDensityValue").textContent = document.getElementById("engineConfigDynamicsEmojiDensity").value;
            document.getElementById("engineConfigDynamicsFlirtivenessValue").textContent = document.getElementById("engineConfigDynamicsFlirtiveness").value;
            document.getElementById("engineConfigDynamicsHostilityValue").textContent = document.getElementById("engineConfigDynamicsHostility").value;
            document.getElementById("engineConfigDynamicsDrynessValue").textContent = document.getElementById("engineConfigDynamicsDryness").value;
            document.getElementById("engineConfigDynamicsVulnerabilityValue").textContent = document.getElementById("engineConfigDynamicsVulnerability").value;
            document.getElementById("engineConfigDynamicsEscalationSpeedValue").textContent = document.getElementById("engineConfigDynamicsEscalationSpeed").value;
            document.getElementById("engineConfigDynamicsRandomnessValue").textContent = document.getElementById("engineConfigDynamicsRandomness").value;
            updateDynamicsPreview();
          }

          function updateDynamicsPreview() {
            const pace = parseInt(document.getElementById("engineConfigDynamicsPace").value || 50);
            const flirt = parseInt(document.getElementById("engineConfigDynamicsFlirtiveness").value || 40);
            const emoji = parseInt(document.getElementById("engineConfigDynamicsEmojiDensity").value || 30);
            const hostility = parseInt(document.getElementById("engineConfigDynamicsHostility").value || 10);
            const randomness = parseInt(document.getElementById("engineConfigDynamicsRandomness").value || 25);
            
            const parts = [];
            if (pace >= 70) parts.push("fast");
            else if (pace <= 30) parts.push("slow");
            if (flirt >= 70) parts.push("highly flirty");
            else if (flirt <= 25) parts.push("platonic");
            if (emoji >= 60) parts.push("high emoji");
            else if (emoji <= 20) parts.push("low emoji");
            if (hostility >= 60) parts.push("high resistance");
            else if (hostility <= 15) parts.push("friendly");
            if (randomness >= 60) parts.push("unpredictable");
            else if (randomness <= 30) parts.push("predictable");
            
            engineConfigUI.dynamicsPreview.textContent = "Preview: This profile is " + (parts.length > 0 ? parts.join(", ") : "balanced");
          }

          function saveDynamicsProfile() {
            // Wave 3: Guard against writing defaults if tab was never hydrated
            if (!engineConfigState.dynamicsHydrated) {
              log("WARNING: saveDynamicsProfile() called before Dynamics tab hydrated. Skipping to prevent corruption.");
              return;
            }
            if (!engineConfigState.config || !engineConfigState.selectedDynamicsProfile) return;
            const profile = engineConfigState.config.dynamicsProfiles.find(p => p.code === engineConfigState.selectedDynamicsProfile);
            if (!profile) return;
            
            profile.name = document.getElementById("engineConfigDynamicsName").value.trim();
            profile.description = document.getElementById("engineConfigDynamicsDescription").value.trim();
            profile.active = document.getElementById("engineConfigDynamicsActive").checked;
            profile.pace = parseInt(document.getElementById("engineConfigDynamicsPace").value || 50);
            profile.emojiDensity = parseInt(document.getElementById("engineConfigDynamicsEmojiDensity").value || 30);
            profile.flirtiveness = parseInt(document.getElementById("engineConfigDynamicsFlirtiveness").value || 40);
            profile.hostility = parseInt(document.getElementById("engineConfigDynamicsHostility").value || 10);
            profile.dryness = parseInt(document.getElementById("engineConfigDynamicsDryness").value || 40);
            profile.vulnerability = parseInt(document.getElementById("engineConfigDynamicsVulnerability").value || 50);
            profile.escalationSpeed = parseInt(document.getElementById("engineConfigDynamicsEscalationSpeed").value || 50);
            profile.randomness = parseInt(document.getElementById("engineConfigDynamicsRandomness").value || 25);
            
            setEngineConfigDirty(true); // Step 1: Mark dirty on edit
            showOk("Dynamics profile updated (click 'Save Config' to persist)");
          }

          function renderGatesTab() {
            if (!engineConfigState.config) return;
            const gates = engineConfigState.config.gates || [];
            engineConfigUI.gatesTableBody.innerHTML = "";
            for (const gate of gates) {
              const row = document.createElement("tr");
              row.style.borderBottom = "1px solid var(--line)";
              const thresholds = [];
              if (gate.minMessages !== undefined) thresholds.push(`Min Messages: ${gate.minMessages}`);
              if (gate.successThreshold !== undefined) thresholds.push(`Success: ${gate.successThreshold}`);
              if (gate.failFloor !== undefined) thresholds.push(`Fail Floor: ${gate.failFloor}`);
              row.innerHTML = `
                <td style="padding: 8px;">${escapeHtml(gate.key)}</td>
                <td style="padding: 8px;">${escapeHtml(gate.description || "")}</td>
                <td style="padding: 8px; font-size: 11px; color: var(--muted);">${thresholds.join(", ") || "—"}</td>
                <td style="padding: 8px;">${gate.active ? "✓" : "✗"}</td>
                <td style="padding: 8px;">
                  <button class="btn" style="padding: 4px 8px; font-size: 11px;" onclick="selectGate('${gate.key}')">Edit</button>
                </td>
              `;
              engineConfigUI.gatesTableBody.appendChild(row);
            }
          }

          window.selectGate = function(key) {
            if (!engineConfigState.config) return;
            const gate = engineConfigState.config.gates.find(g => g.key === key);
            if (!gate) return;
            engineConfigState.selectedGate = key;
            engineConfigUI.gateEditor.style.display = "block";
            
            document.getElementById("engineConfigGateKey").value = gate.key || "";
            document.getElementById("engineConfigGateDescription").value = gate.description || "";
            document.getElementById("engineConfigGateActive").checked = gate.active !== false;
            document.getElementById("engineConfigGateMinMessages").value = gate.minMessages || "";
            document.getElementById("engineConfigGateSuccessThreshold").value = gate.successThreshold || "";
            document.getElementById("engineConfigGateFailFloor").value = gate.failFloor || "";
          };

          function saveGate() {
            if (!engineConfigState.config || !engineConfigState.selectedGate) return;
            const gate = engineConfigState.config.gates.find(g => g.key === engineConfigState.selectedGate);
            if (!gate) return;
            
            gate.description = document.getElementById("engineConfigGateDescription").value.trim();
            gate.active = document.getElementById("engineConfigGateActive").checked;
            const minMsg = document.getElementById("engineConfigGateMinMessages").value.trim();
            gate.minMessages = minMsg ? parseInt(minMsg) : undefined;
            const successThresh = document.getElementById("engineConfigGateSuccessThreshold").value.trim();
            gate.successThreshold = successThresh ? parseInt(successThresh) : undefined;
            const failFloor = document.getElementById("engineConfigGateFailFloor").value.trim();
            gate.failFloor = failFloor ? parseInt(failFloor) : undefined;
            
            setEngineConfigDirty(true); // Step 1: Mark dirty on edit
            showOk("Gate updated (click 'Save Config' to persist)");
            renderGatesTab();
          }

          async function loadHooks() {
            try {
              const res = await apiFetch("/v1/admin/hooks", { method: "GET" });
              // Wave 1.1: apiFetch throws on error, so if we get here it succeeded
              const hooks = res.hooks || (Array.isArray(res) ? res : []);
              engineConfigState.hooks = hooks;
              renderHooksTable();
              log(`Loaded hooks: ${hooks.length}`);
              showOk(`Hooks loaded (${hooks.length}).`);
            } catch (e) {
              showError("Error loading hooks: " + formatErrorForDisplay(e));
            }
          }

          // Wave 1: Add missing renderHooksTab function to prevent ReferenceError
          function renderHooksTab() {
            // Minimal safe implementation - user must click "Load Hooks" button
            // This function exists to prevent ReferenceError when Hooks tab is clicked
            if (engineConfigState.hooks && engineConfigState.hooks.length > 0) {
              renderHooksTable();
            }
            // Otherwise, tab is displayed but empty until user clicks "Load Hooks"
          }

          function renderHooksTable() {
            engineConfigUI.hooksTableBody.innerHTML = "";
            for (const hook of engineConfigState.hooks) {
              const row = document.createElement("tr");
              row.style.borderBottom = "1px solid var(--line)";
              row.innerHTML = `
                <td style="padding: 8px;">${escapeHtml(hook.name || "")}</td>
                <td style="padding: 8px;">${escapeHtml(hook.type || "")}</td>
                <td style="padding: 8px;">${hook.priority || 50}</td>
                <td style="padding: 8px;">${hook.isEnabled ? "✓" : "✗"}</td>
                <td style="padding: 8px; font-size: 11px; color: var(--muted);">${(hook.tags || []).join(", ") || "—"}</td>
                <td style="padding: 8px;">
                  <button class="btn" style="padding: 4px 8px; font-size: 11px;" onclick="selectHook('${hook.id}')">Edit</button>
                  <button class="btn" style="padding: 4px 8px; font-size: 11px; margin-left: 4px; background: var(--error);" onclick="deleteHook('${hook.id}')">Delete</button>
                </td>
              `;
              engineConfigUI.hooksTableBody.appendChild(row);
            }
          }

          window.selectHook = function(id) {
            const hook = engineConfigState.hooks.find(h => h.id === id);
            if (!hook) return;
            engineConfigState.selectedHook = id;
            engineConfigUI.hookEditor.style.display = "block";
            
            document.getElementById("engineConfigHookName").value = hook.name || "";
            document.getElementById("engineConfigHookType").value = hook.type || "POSITIVE";
            document.getElementById("engineConfigHookPriority").value = hook.priority || 50;
            document.getElementById("engineConfigHookTextTemplate").value = hook.textTemplate || "";
            document.getElementById("engineConfigHookConditionsJson").value = JSON.stringify(hook.conditionsJson || {}, null, 2);
            document.getElementById("engineConfigHookCategory").value = hook.category || "";
            document.getElementById("engineConfigHookTags").value = (hook.tags || []).join(", ");
            document.getElementById("engineConfigHookEnabled").checked = hook.isEnabled !== false;
          };

          async function saveHook() {
            // Step 1: Parse JSON with error handling
            let conditionsJson;
            try {
              const conditionsText = document.getElementById("engineConfigHookConditionsJson").value || "{}";
              conditionsJson = JSON.parse(conditionsText);
            } catch (e) {
              showError("Invalid JSON in Conditions JSON field: " + (e.message || e));
              return;
            }
            
            if (!engineConfigState.selectedHook) {
              // Create new
              try {
                const hookData = {
                  name: document.getElementById("engineConfigHookName").value.trim(),
                  type: document.getElementById("engineConfigHookType").value,
                  priority: parseInt(document.getElementById("engineConfigHookPriority").value || 50),
                  textTemplate: document.getElementById("engineConfigHookTextTemplate").value.trim(),
                  conditionsJson: conditionsJson,
                  category: document.getElementById("engineConfigHookCategory").value.trim(),
                  tags: document.getElementById("engineConfigHookTags").value.split(",").map(s => s.trim()).filter(s => s),
                  isEnabled: document.getElementById("engineConfigHookEnabled").checked,
                };
                const res = await apiFetch("/v1/admin/hooks", {
                  method: "POST",
                  body: JSON.stringify(hookData),
                });
                // Wave 1.1: apiFetch throws on error, so if we get here it succeeded
                showOk("Hook created.");
                await loadHooks();
              } catch (e) {
                showError("Error creating hook: " + formatErrorForDisplay(e));
              }
            } else {
              // Update existing
              try {
                const hookData = {
                  name: document.getElementById("engineConfigHookName").value.trim(),
                  type: document.getElementById("engineConfigHookType").value,
                  priority: parseInt(document.getElementById("engineConfigHookPriority").value || 50),
                  textTemplate: document.getElementById("engineConfigHookTextTemplate").value.trim(),
                  conditionsJson: conditionsJson,
                  category: document.getElementById("engineConfigHookCategory").value.trim(),
                  tags: document.getElementById("engineConfigHookTags").value.split(",").map(s => s.trim()).filter(s => s),
                  isEnabled: document.getElementById("engineConfigHookEnabled").checked,
                };
                const res = await apiFetch(`/v1/admin/hooks/${engineConfigState.selectedHook}`, {
                  method: "PUT",
                  body: JSON.stringify(hookData),
                });
                // Wave 1.1: apiFetch throws on error, so if we get here it succeeded
                showOk("Hook updated.");
                await loadHooks();
              } catch (e) {
                showError("Error updating hook: " + formatErrorForDisplay(e));
              }
            }
          }

          window.deleteHook = async function(id) {
            if (!confirm("Are you sure you want to delete this hook?")) {
              return;
            }
            try {
              const res = await apiFetch(`/v1/admin/hooks/${id}`, {
                method: "DELETE",
              });
              // Wave 1.1: apiFetch throws on error, so if we get here it succeeded
              showOk("Hook deleted.");
              await loadHooks(); // Refresh the table
            } catch (e) {
              showError("Error deleting hook: " + formatErrorForDisplay(e));
            }
          };

          async function loadTriggerStats() {
            try {
              const res = await apiFetch("/v1/admin/hooks/triggers/stats?days=7", { method: "GET" });
              // Wave 1.1: apiFetch throws on error, so if we get here it succeeded
              engineConfigState.triggerStats = res.stats || (Array.isArray(res) ? res : []);
              renderTriggerStats();
              log(`Loaded trigger stats: ${engineConfigState.triggerStats.length}`);
              showOk("Trigger stats loaded.");
            } catch (e) {
              showError("Error loading trigger stats: " + formatErrorForDisplay(e));
            }
          }

          function renderTriggerStats() {
            engineConfigUI.triggersTableBody.innerHTML = "";
            const stats = engineConfigState.triggerStats || [];
            for (const stat of stats) {
              const row = document.createElement("tr");
              row.style.borderBottom = "1px solid var(--line)";
              row.innerHTML = `
                <td style="padding: 8px;">${escapeHtml(stat.hookName || "Unknown")}</td>
                <td style="padding: 8px;">${escapeHtml(stat.hookType || "")}</td>
                <td style="padding: 8px;">${stat.triggerCount || 0}</td>
              `;
              engineConfigUI.triggersTableBody.appendChild(row);
            }
          }

          function renderMoodTab() {
            if (!engineConfigState.config) return;
            const mood = engineConfigState.config.mood || {};
            
            document.getElementById("engineConfigMoodEmaAlpha").value = mood.emaAlpha || 0.35;
            
            const thresholds = mood.moodStateThresholds || {};
            const flow = thresholds.flow || {};
            document.getElementById("engineConfigMoodFlowMinScore").value = flow.minScore || 80;
            document.getElementById("engineConfigMoodFlowMinFlow").value = flow.minFlow || 70;
            document.getElementById("engineConfigMoodFlowMaxTension").value = flow.maxTension || 40;
            
            const tense = thresholds.tense || {};
            document.getElementById("engineConfigMoodTenseMinTension").value = tense.minTension || 70;
            const orLowScore = tense.orLowScore || {};
            document.getElementById("engineConfigMoodTenseOrMaxScore").value = orLowScore.maxScore || 50;
            document.getElementById("engineConfigMoodTenseOrMinTension").value = orLowScore.minTension || 50;
            
            const warm = thresholds.warm || {};
            document.getElementById("engineConfigMoodWarmMinScore").value = warm.minScore || 60;
            document.getElementById("engineConfigMoodWarmMaxScore").value = warm.maxScore || 80;
            document.getElementById("engineConfigMoodWarmMinWarmth").value = warm.minWarmth || 50;
            
            const cold = thresholds.cold || {};
            document.getElementById("engineConfigMoodColdMaxScore").value = cold.maxScore || 30;
            document.getElementById("engineConfigMoodColdMaxWarmth").value = cold.maxWarmth || 40;
            
            // Render bands
            const bands = mood.bands || [];
            engineConfigUI.moodBandsList.innerHTML = "";
            for (let i = 0; i < bands.length; i++) {
              const band = bands[i];
              const div = document.createElement("div");
              div.style.display = "flex";
              div.style.gap = "8px";
              div.style.marginBottom = "8px";
              div.style.alignItems = "center";
              div.innerHTML = `
                <input type="text" id="engineConfigMoodBandKey${i}" value="${escapeHtml(band.key || "")}" placeholder="Key" style="flex: 1;" />
                <input type="number" id="engineConfigMoodBandMin${i}" value="${band.minPercent || 0}" min="0" max="100" placeholder="Min %" />
                <input type="number" id="engineConfigMoodBandMax${i}" value="${band.maxPercent || 100}" min="0" max="100" placeholder="Max %" />
                <button class="btn" style="padding: 4px 8px; font-size: 11px;" onclick="removeMoodBand(${i})">Remove</button>
              `;
              engineConfigUI.moodBandsList.appendChild(div);
            }
            
            const statePolicy = engineConfigState.config.statePolicy || {};
            document.getElementById("engineConfigStatePolicyMinMessages").value = statePolicy.minMessagesForVerdict || 3;
            document.getElementById("engineConfigStatePolicyFailOnThreeCritical").checked = statePolicy.failOnThreeCriticalMessages === true;
            document.getElementById("engineConfigStatePolicyAllowRecovery").checked = statePolicy.allowRecoveryAfterFailGate !== false;
            engineConfigState.moodHydrated = true; // Wave 3: Mark as hydrated after DOM populated from state
          }

          window.removeMoodBand = function(index) {
            if (!engineConfigState.config || !engineConfigState.config.mood) return;
            engineConfigState.config.mood.bands = engineConfigState.config.mood.bands || [];
            engineConfigState.config.mood.bands.splice(index, 1);
            renderMoodTab();
          };

          function addMoodBand() {
            if (!engineConfigState.config) return;
            if (!engineConfigState.config.mood) {
              engineConfigState.config.mood = { bands: [] };
            }
            engineConfigState.config.mood.bands = engineConfigState.config.mood.bands || [];
            engineConfigState.config.mood.bands.push({ key: "NEW_BAND", minPercent: 0, maxPercent: 100 });
            renderMoodTab();
          }

          function saveMoodConfig() {
            // Wave 3: Guard against writing defaults/empty arrays if tab was never hydrated
            if (!engineConfigState.moodHydrated) {
              log("WARNING: saveMoodConfig() called before Mood tab hydrated. Skipping to prevent corruption.");
              return;
            }
            if (!engineConfigState.config) return;
            if (!engineConfigState.config.mood) {
              engineConfigState.config.mood = {};
            }
            
            engineConfigState.config.mood.emaAlpha = parseFloat(document.getElementById("engineConfigMoodEmaAlpha").value || 0.35);
            
            engineConfigState.config.mood.moodStateThresholds = {
              flow: {
                minScore: parseInt(document.getElementById("engineConfigMoodFlowMinScore").value || 80),
                minFlow: parseInt(document.getElementById("engineConfigMoodFlowMinFlow").value || 70),
                maxTension: parseInt(document.getElementById("engineConfigMoodFlowMaxTension").value || 40),
              },
              tense: {
                minTension: parseInt(document.getElementById("engineConfigMoodTenseMinTension").value || 70),
                orLowScore: {
                  maxScore: parseInt(document.getElementById("engineConfigMoodTenseOrMaxScore").value || 50),
                  minTension: parseInt(document.getElementById("engineConfigMoodTenseOrMinTension").value || 50),
                },
              },
              warm: {
                minScore: parseInt(document.getElementById("engineConfigMoodWarmMinScore").value || 60),
                maxScore: parseInt(document.getElementById("engineConfigMoodWarmMaxScore").value || 80),
                minWarmth: parseInt(document.getElementById("engineConfigMoodWarmMinWarmth").value || 50),
              },
              cold: {
                maxScore: parseInt(document.getElementById("engineConfigMoodColdMaxScore").value || 30),
                maxWarmth: parseInt(document.getElementById("engineConfigMoodColdMaxWarmth").value || 40),
              },
            };
            
            // Save bands
            const bands = [];
            const bandDivs = engineConfigUI.moodBandsList.querySelectorAll("div");
            for (let i = 0; i < bandDivs.length; i++) {
              const key = document.getElementById(`engineConfigMoodBandKey${i}`)?.value.trim();
              const min = parseInt(document.getElementById(`engineConfigMoodBandMin${i}`)?.value || 0);
              const max = parseInt(document.getElementById(`engineConfigMoodBandMax${i}`)?.value || 100);
              if (key) {
                bands.push({ key, minPercent: min, maxPercent: max });
              }
            }
            engineConfigState.config.mood.bands = bands;
            
            if (!engineConfigState.config.statePolicy) {
              engineConfigState.config.statePolicy = {};
            }
            engineConfigState.config.statePolicy.minMessagesForVerdict = parseInt(document.getElementById("engineConfigStatePolicyMinMessages").value || 3);
            engineConfigState.config.statePolicy.failOnThreeCriticalMessages = document.getElementById("engineConfigStatePolicyFailOnThreeCritical").checked;
            engineConfigState.config.statePolicy.allowRecoveryAfterFailGate = document.getElementById("engineConfigStatePolicyAllowRecovery").checked;
            
            showOk("Mood config updated (click 'Save Config' to persist)");
          }

          async function loadInsights() {
            try {
              const kind = engineConfigUI.insightsKindFilter.value;
              const url = kind ? `/v1/admin/insights/catalog?kind=${kind}` : "/v1/admin/insights/catalog";
              const res = await apiFetch(url, { method: "GET" });
              // Wave 1.1: apiFetch throws on error, so if we get here it succeeded
              // Check for actual data structure
              const insights = res.templates || res.insights || (Array.isArray(res) ? res : []);
              engineConfigState.insights = insights;
              renderInsightsTable();
              log(`Loaded insights: ${insights.length}`);
              showOk(`Insights loaded (${insights.length}).`);
            } catch (e) {
              showError("Error loading insights: " + formatErrorForDisplay(e));
            }
          }

          // Wave 1: Add missing renderInsightsTab function to prevent ReferenceError
          function renderInsightsTab() {
            // Minimal safe implementation - user must click "Load Insights" button
            // This function exists to prevent ReferenceError when Insights tab is clicked
            if (engineConfigState.insights && engineConfigState.insights.length > 0) {
              renderInsightsTable();
            }
            // Otherwise, tab is displayed but empty until user clicks "Load Insights"
          }

          function renderInsightsTable() {
            engineConfigUI.insightsTableBody.innerHTML = "";
            for (const insight of engineConfigState.insights) {
              const row = document.createElement("tr");
              row.style.borderBottom = "1px solid var(--line)";
              row.style.cursor = "pointer";
              const requires = insight.requires || {};
              const requiresStr = [];
              if (requires.gateKey) requiresStr.push(`Gate: ${requires.gateKey}`);
              if (requires.hookKey) requiresStr.push(`Hook: ${requires.hookKey}`);
              if (requires.patternKey) requiresStr.push(`Pattern: ${requires.patternKey}`);
              const source = insight.source || 'catalog';
              const isCustom = source === 'custom';
              const dbId = insight._dbId || '';
              const actionsHtml = isCustom
                ? `<button class="btn" style="padding: 4px 8px; font-size: 11px;" onclick="selectInsight('${insight.id}')">View</button> <button class="btn" style="padding: 4px 8px; font-size: 11px; margin-left: 4px; background: var(--error);" onclick="deleteCustomInsight('${dbId}')">Delete</button>`
                : `<button class="btn" style="padding: 4px 8px; font-size: 11px;" onclick="selectInsight('${insight.id}')">View</button>`;
              row.innerHTML = `
                <td style="padding: 8px; font-size: 11px; color: var(--muted);">${escapeHtml(insight.id || "")}</td>
                <td style="padding: 8px;">${escapeHtml(insight.kind || "")}</td>
                <td style="padding: 8px;">${escapeHtml(insight.title || "")}</td>
                <td style="padding: 8px; font-size: 11px; color: var(--muted);">${escapeHtml(insight.category || "")}</td>
                <td style="padding: 8px; font-size: 11px; color: var(--muted);">${requiresStr.join(", ") || "—"}</td>
                <td style="padding: 8px; font-size: 11px; color: var(--muted);">${escapeHtml(source)}</td>
                <td style="padding: 8px;">
                  ${actionsHtml}
                </td>
              `;
              engineConfigUI.insightsTableBody.appendChild(row);
            }
          }

          window.selectInsight = function(id) {
            const insight = engineConfigState.insights.find(i => i.id === id);
            if (!insight) return;
            engineConfigState.selectedInsight = id;
            engineConfigUI.insightDetail.style.display = "block";
            
            document.getElementById("engineConfigInsightTitle").value = insight.title || "";
            document.getElementById("engineConfigInsightBody").value = insight.body || "";
            const requires = insight.requires || {};
            const requiresStr = [];
            if (requires.gateKey) requiresStr.push(`Gate: ${requires.gateKey}`);
            if (requires.hookKey) requiresStr.push(`Hook: ${requires.hookKey}`);
            if (requires.patternKey) requiresStr.push(`Pattern: ${requires.patternKey}`);
            document.getElementById("engineConfigInsightRequires").value = requiresStr.join(", ") || "—";
          };

          window.deleteCustomInsight = async function(dbId) {
            if (!confirm("Are you sure you want to delete this custom insight?")) {
              return;
            }
            try {
              const res = await apiFetch(`/v1/admin/insights/${dbId}`, {
                method: "DELETE",
              });
              // Wave 1.1: apiFetch throws on error, so if we get here it succeeded
              showOk("Custom insight deleted.");
              await loadInsights(); // Refresh the table
            } catch (e) {
              showError("Error deleting custom insight: " + formatErrorForDisplay(e));
            }
          };

          async function saveCustomInsight() {
            // Parse JSON with error handling
            let requiresJson;
            try {
              const requiresText = document.getElementById("engineConfigCustomInsightRequires").value || "{}";
              requiresJson = JSON.parse(requiresText);
            } catch (e) {
              showError("Invalid JSON in Requires field: " + (e.message || e));
              return;
            }

            const key = document.getElementById("engineConfigCustomInsightKey").value.trim();
            const kind = document.getElementById("engineConfigCustomInsightKind").value;
            const title = document.getElementById("engineConfigCustomInsightTitle").value.trim();
            const body = document.getElementById("engineConfigCustomInsightBody").value.trim();
            const category = document.getElementById("engineConfigCustomInsightCategory").value.trim() || "general";
            const tagsText = document.getElementById("engineConfigCustomInsightTags").value.trim();
            const tags = tagsText ? tagsText.split(",").map(s => s.trim()).filter(s => s) : [];
            const weight = parseInt(document.getElementById("engineConfigCustomInsightWeight").value || 50);
            const cooldownMissions = parseInt(document.getElementById("engineConfigCustomInsightCooldown").value || 3);

            if (!key || !title || !body || !kind) {
              showError("Key, Title, Body, and Kind are required.");
              return;
            }

            try {
              const payload = {
                key,
                kind,
                title,
                body,
                category,
                tags,
                weight,
                cooldownMissions,
                requires: requiresJson,
              };
              const res = await apiFetch("/v1/admin/insights", {
                method: "POST",
                body: JSON.stringify(payload),
              });
              // Wave 1.1: apiFetch throws on error, so if we get here it succeeded
              showOk("Custom insight created.");
              document.getElementById("engineConfigCustomInsightEditor").style.display = "none";
              // Clear form
              document.getElementById("engineConfigCustomInsightKey").value = "";
              document.getElementById("engineConfigCustomInsightTitle").value = "";
              document.getElementById("engineConfigCustomInsightBody").value = "";
              document.getElementById("engineConfigCustomInsightCategory").value = "";
              document.getElementById("engineConfigCustomInsightTags").value = "";
              document.getElementById("engineConfigCustomInsightWeight").value = "50";
              document.getElementById("engineConfigCustomInsightCooldown").value = "3";
              document.getElementById("engineConfigCustomInsightRequires").value = "";
              await loadInsights();
            } catch (e) {
              showError("Error creating custom insight: " + formatErrorForDisplay(e));
            }
          }

          async function loadOpenings() {
            try {
              const res = await apiFetch("/v1/admin/prompts/openings", { method: "GET" });
              // Wave 1.1: apiFetch throws on error, so if we get here it succeeded
              const templates = res.templates || (Array.isArray(res) ? res : []);
              engineConfigState.openings = templates;
              engineConfigUI.openingsTableBody.innerHTML = "";
              for (const template of templates) {
                  const row = document.createElement("tr");
                  row.style.borderBottom = "1px solid var(--line)";
                  row.style.cursor = "pointer";
                  row.innerHTML = `
                    <td style="padding: 8px; font-size: 11px; color: var(--muted);">${escapeHtml(template.key || "")}</td>
                    <td style="padding: 8px;">${escapeHtml(template.name || "")}</td>
                    <td style="padding: 8px; font-size: 11px; color: var(--muted);">${escapeHtml(template.description || "")}</td>
                    <td style="padding: 8px;">
                      <button class="btn" style="padding: 4px 8px; font-size: 11px;" onclick="selectOpeningTemplate('${template.key}')">View</button>
                    </td>
                  `;
                  engineConfigUI.openingsTableBody.appendChild(row);
                }
              log(`Loaded opening templates: ${templates.length}`);
              showOk(`Opening templates loaded (${templates.length}).`);
            } catch (e) {
              showError("Error loading opening templates: " + formatErrorForDisplay(e));
            }
          }

          window.selectOpeningTemplate = function(key) {
            // Find template in the loaded data
            const res = engineConfigState.openings || [];
            const template = res.find(t => t.key === key);
            if (!template) {
              // Try to reload if not found
              loadOpenings().then(() => {
                const reloaded = engineConfigState.openings || [];
                const found = reloaded.find(t => t.key === key);
                if (found) {
                  displayOpeningTemplate(found);
                }
              });
              return;
            }
            displayOpeningTemplate(template);
          };

          function displayOpeningTemplate(template) {
            engineConfigUI.openingDetail.style.display = "block";
            document.getElementById("engineConfigOpeningKey").value = template.key || "";
            document.getElementById("engineConfigOpeningName").value = template.name || "";
            document.getElementById("engineConfigOpeningDescription").value = template.description || "";
            document.getElementById("engineConfigOpeningTemplate").value = template.template || "";
            const compatibleStyles = Array.isArray(template.compatibleStyles) ? template.compatibleStyles.join(", ") : "";
            document.getElementById("engineConfigOpeningCompatibleStyles").value = compatibleStyles;
          }

          async function renderMonitoringTab() {
            await loadTriggerStats();
            engineConfigUI.monitoringHooksStats.innerHTML = "";
            const stats = engineConfigState.triggerStats || [];
            if (stats.length === 0) {
              engineConfigUI.monitoringHooksStats.innerHTML = "<div style='color: var(--muted);'>No trigger stats available.</div>";
              return;
            }
            const table = document.createElement("table");
            table.style.width = "100%";
            table.style.borderCollapse = "collapse";
            table.innerHTML = `
              <thead>
                <tr style="border-bottom: 1px solid var(--line);">
                  <th style="padding: 8px; text-align: left;">Hook Name</th>
                  <th style="padding: 8px; text-align: left;">Type</th>
                  <th style="padding: 8px; text-align: left;">Trigger Count</th>
                </tr>
              </thead>
              <tbody>
                ${stats.map(s => `
                  <tr style="border-bottom: 1px solid var(--line);">
                    <td style="padding: 8px;">${escapeHtml(s.hookName || "Unknown")}</td>
                    <td style="padding: 8px;">${escapeHtml(s.hookType || "")}</td>
                    <td style="padding: 8px;">${s.triggerCount || 0}</td>
                  </tr>
                `).join("")}
              </tbody>
            `;
            engineConfigUI.monitoringHooksStats.appendChild(table);
          }

          async function loadMissionAttachments() {
            try {
              // Wave 1.2: Load missions with fallback endpoint
              log("Loading missions for attachments...");
              let missions = [];
              let missionsEndpoint = "";
              
              // Try /v1/admin/missions first
              try {
                const missionsRes = await apiFetch("/v1/admin/missions", { method: "GET" });
                missions = Array.isArray(missionsRes) ? missionsRes : (missionsRes.missions || missionsRes.templates || missionsRes.items || []);
                missionsEndpoint = "/v1/admin/missions";
                if (missions.length === 0 || (!Array.isArray(missionsRes) && !missionsRes.missions && !missionsRes.templates && !missionsRes.items)) {
                  // Empty or unknown shape, try fallback
                  throw new Error("Empty or unknown shape, trying fallback");
                }
              } catch (e) {
                // Fallback to /v1/admin/missions/list
                try {
                  const missionsRes = await apiFetch("/v1/admin/missions/list", { method: "GET" });
                  missions = Array.isArray(missionsRes) ? missionsRes : (missionsRes.missions || missionsRes.templates || missionsRes.items || []);
                  missionsEndpoint = "/v1/admin/missions/list";
                } catch (e2) {
                  log(`WARNING: Failed to load missions from both endpoints: ${e?.message || e}, ${e2?.message || e2}`);
                  // Continue with attachments-only mode
                }
              }
              
              log(`Loaded missions: ${missions.length} (from ${missionsEndpoint || "none"})`);
              
              // Wave 1.2: Load attachments
              let attachments = [];
              try {
                const attachmentsRes = await apiFetch("/v1/admin/missions/attachments", { method: "GET" });
                attachments = Array.isArray(attachmentsRes) ? attachmentsRes : (attachmentsRes.attachments || []);
                log(`Loaded attachments: ${attachments.length}`);
              } catch (e) {
                log(`WARNING: Failed to load attachments: ${e?.message || e}`);
                // Continue with missions-only mode
              }
              
              // Wave 1.1: Merge missions with attachments
              engineConfigState.attachments = [];
              
              // Add all attachments
              attachments.forEach(att => {
                engineConfigState.attachments.push(att);
              });
              
              // Add missions that don't have attachments yet
              if (missions.length > 0) {
                const attachmentsMap = new Map();
                attachments.forEach(att => {
                  attachmentsMap.set(att.missionId, att);
                });
                
                missions.forEach(mission => {
                  if (!attachmentsMap.has(mission.id)) {
                    engineConfigState.attachments.push({
                      missionId: mission.id,
                      missionCode: mission.code || mission.id,
                      missionLabel: mission.name || mission.title || mission.code || mission.id,
                      categoryLabel: mission.categoryLabel || mission.category?.name || "",
                      scoringProfileCode: null,
                      dynamicsProfileCode: null,
                    });
                  }
                });
              }
              
              renderMissionAttachmentsTable();
              populateCategoryFilter();
              showOk(`Mission attachments loaded (${engineConfigState.attachments.length} missions).`);
            } catch (e) {
              showError("Error loading mission attachments: " + formatErrorForDisplay(e));
            }
          }

          function populateCategoryFilter() {
            const categories = new Set();
            for (const att of engineConfigState.attachments) {
              if (att.categoryLabel) categories.add(att.categoryLabel);
            }
            engineConfigUI.attachmentsCategoryFilter.innerHTML = '<option value="">All Categories</option>';
            for (const cat of Array.from(categories).sort()) {
              const option = document.createElement("option");
              option.value = cat;
              option.textContent = cat;
              engineConfigUI.attachmentsCategoryFilter.appendChild(option);
            }
          }

          function renderMissionAttachmentsTable() {
            const categoryFilter = engineConfigUI.attachmentsCategoryFilter.value;
            const searchTerm = engineConfigUI.attachmentsSearchInput.value.toLowerCase();
            
            engineConfigUI.attachmentsMissionsList.innerHTML = "";
            let filtered = engineConfigState.attachments || [];
            
            if (categoryFilter) {
              filtered = filtered.filter(att => att.categoryLabel === categoryFilter);
            }
            if (searchTerm) {
              filtered = filtered.filter(att => 
                (att.missionLabel || "").toLowerCase().includes(searchTerm) ||
                (att.missionCode || "").toLowerCase().includes(searchTerm)
              );
            }
            
            for (const att of filtered) {
              const el = document.createElement("div");
              el.className = "item";
              if (engineConfigState.selectedAttachmentMissionId === att.missionId) {
                el.classList.add("active");
              }
              el.innerHTML = `
                <div class="itemTitle">
                  <span>${escapeHtml(att.missionLabel || att.missionCode || "Unknown")}</span>
                </div>
                <div class="itemMeta">
                  <span>${escapeHtml(att.missionCode || "")}</span>
                  <span style="margin-left: 8px; color: var(--muted);">${escapeHtml(att.categoryLabel || "")}</span>
                </div>
              `;
              el.addEventListener("click", () => selectMissionAttachment(att.missionId));
              engineConfigUI.attachmentsMissionsList.appendChild(el);
            }
          }

          async function selectMissionAttachment(missionId) {
            const attachment = engineConfigState.attachments.find(a => a.missionId === missionId);
            if (!attachment) return;
            
            engineConfigState.selectedAttachmentMissionId = missionId;
            engineConfigUI.attachmentsEditor.style.display = "block";
            engineConfigUI.attachmentsEditorEmpty.style.display = "none";
            
            document.getElementById("engineConfigAttachmentsMissionLabel").value = attachment.missionLabel || "";
            document.getElementById("engineConfigAttachmentsMissionCode").value = attachment.missionCode || "";
            document.getElementById("engineConfigAttachmentsMissionCategory").value = attachment.categoryLabel || "";
            
            // Populate scoring profile dropdown
            if (engineConfigState.config) {
              const scoringProfiles = engineConfigState.config.scoringProfiles || [];
              engineConfigUI.attachmentsScoringProfile.innerHTML = '<option value="">(Inherit global default)</option>';
              for (const profile of scoringProfiles.filter(p => p.active)) {
                const option = document.createElement("option");
                option.value = profile.code;
                option.textContent = profile.name || profile.code;
                if (attachment.scoringProfileCode === profile.code) {
                  option.selected = true;
                }
                engineConfigUI.attachmentsScoringProfile.appendChild(option);
              }
              if (attachment.scoringProfileCode && !scoringProfiles.find(p => p.code === attachment.scoringProfileCode)) {
                const option = document.createElement("option");
                option.value = attachment.scoringProfileCode;
                option.textContent = attachment.scoringProfileCode + " (not found)";
                option.selected = true;
                engineConfigUI.attachmentsScoringProfile.appendChild(option);
              }
              
              // Populate dynamics profile dropdown
              const dynamicsProfiles = engineConfigState.config.dynamicsProfiles || [];
              engineConfigUI.attachmentsDynamicsProfile.innerHTML = '<option value="">(Inherit mission\'s own dynamics)</option>';
              for (const profile of dynamicsProfiles.filter(p => p.active)) {
                const option = document.createElement("option");
                option.value = profile.code;
                option.textContent = profile.name || profile.code;
                if (attachment.dynamicsProfileCode === profile.code) {
                  option.selected = true;
                }
                engineConfigUI.attachmentsDynamicsProfile.appendChild(option);
              }
              if (attachment.dynamicsProfileCode && !dynamicsProfiles.find(p => p.code === attachment.dynamicsProfileCode)) {
                const option = document.createElement("option");
                option.value = attachment.dynamicsProfileCode;
                option.textContent = attachment.dynamicsProfileCode + " (not found)";
                option.selected = true;
                engineConfigUI.attachmentsDynamicsProfile.appendChild(option);
              }
            }
            
            renderMissionAttachmentsTable();
          }

          async function saveMissionAttachments() {
            if (!engineConfigState.selectedAttachmentMissionId) {
              showError("No mission selected");
              return;
            }
            try {
              const scoringProfileCode = engineConfigUI.attachmentsScoringProfile.value || null;
              const dynamicsProfileCode = engineConfigUI.attachmentsDynamicsProfile.value || null;
              
              const res = await apiFetch(`/v1/admin/missions/${engineConfigState.selectedAttachmentMissionId}/attachments`, {
                method: "PUT",
                body: JSON.stringify({
                  scoringProfileCode: scoringProfileCode || null,
                  dynamicsProfileCode: dynamicsProfileCode || null,
                }),
              });
              // Wave 1.1: apiFetch throws on error, so if we get here it succeeded
              showOk("Mission attachments saved.");
              // Reload attachments to refresh the list
              await loadMissionAttachments();
            } catch (e) {
              showError("Error saving mission attachments: " + formatErrorForDisplay(e));
            }
          }

          function resetMissionAttachments() {
            if (engineConfigState.selectedAttachmentMissionId) {
              selectMissionAttachment(engineConfigState.selectedAttachmentMissionId);
            }
          }

          // AI Styles Admin state
          const aiStylesAdminState = {
            styles: [],
            selectedStyleId: null,
          };

          // Personas Admin state
          const personasAdminState = {
            personas: [],
            selectedPersonaId: null,
          };

          // AI Styles Admin functions
          async function loadAiStylesAdmin() {
            try {
              const res = await apiFetch("/v1/admin/ai-styles", { method: "GET" });
              // Wave 1.2: apiFetch throws on error, so if we get here it succeeded
              // Accept either array or wrapped objects
              const styles = Array.isArray(res) ? res : (res.styles || res.items || []);
              aiStylesAdminState.styles = styles;
              renderAiStylesTable();
              log(`Loaded AI styles: ${styles.length}`);
              showOk(`AI Styles loaded (${styles.length}).`);
            } catch (e) {
              showError("Error loading AI Styles: " + formatErrorForDisplay(e));
            }
          }

          function renderAiStylesTable() {
            const tbody = document.getElementById("aiStylesTableBody");
            if (!tbody) return;
            tbody.innerHTML = "";
            for (const style of aiStylesAdminState.styles) {
              const row = document.createElement("tr");
              row.style.borderBottom = "1px solid var(--line)";
              row.innerHTML = `
                <td style="padding: 8px;">${escapeHtml(style.key || "")}</td>
                <td style="padding: 8px;">${escapeHtml(style.name || "")}</td>
                <td style="padding: 8px;">${style.isActive ? "✓" : "✗"}</td>
                <td style="padding: 8px;">
                  <button class="btn" style="padding: 4px 8px; font-size: 11px;" onclick="editAiStyle('${style.id}')">Edit</button>
                  ${style.isActive ? 
                    `<button class="btn" style="padding: 4px 8px; font-size: 11px; background: var(--warn);" onclick="disableAiStyle('${style.id}')">Disable</button>` :
                    `<button class="btn" style="padding: 4px 8px; font-size: 11px; background: var(--ok);" onclick="enableAiStyle('${style.id}')">Enable</button>`
                  }
                </td>
              `;
              tbody.appendChild(row);
            }
          }

          window.editAiStyle = function(id) {
            const style = aiStylesAdminState.styles.find(s => s.id === id);
            if (!style) return;
            aiStylesAdminState.selectedStyleId = id;
            document.getElementById("aiStylesEditor").style.display = "block";
            document.getElementById("aiStylesEditorKey").value = style.key || "";
            document.getElementById("aiStylesEditorName").value = style.name || "";
            document.getElementById("aiStylesEditorDescription").value = style.description || "";
            document.getElementById("aiStylesEditorStylePrompt").value = style.stylePrompt || "";
            document.getElementById("aiStylesEditorForbiddenBehavior").value = style.forbiddenBehavior || "";
            document.getElementById("aiStylesEditorMaxChars").value = style.maxChars ?? 500;
            document.getElementById("aiStylesEditorMaxLines").value = style.maxLines ?? 10;
            document.getElementById("aiStylesEditorQuestionRate").value = style.questionRate ?? 50;
            document.getElementById("aiStylesEditorEmojiRate").value = style.emojiRate ?? 30;
            document.getElementById("aiStylesEditorInitiative").value = style.initiative ?? 50;
            document.getElementById("aiStylesEditorWarmth").value = style.warmth ?? 50;
            document.getElementById("aiStylesEditorJudgment").value = style.judgment ?? 50;
            document.getElementById("aiStylesEditorFlirtTension").value = style.flirtTension ?? 50;
            document.getElementById("aiStylesEditorFormality").value = style.formality ?? 50;
            document.getElementById("aiStylesEditorTemperature").value = style.temperature ?? "";
            document.getElementById("aiStylesEditorTopP").value = style.topP ?? "";
            document.getElementById("aiStylesEditorFewShotExamples").value = style.fewShotExamples ? JSON.stringify(style.fewShotExamples, null, 2) : "";
            document.getElementById("aiStylesEditorActive").checked = style.isActive !== false;
          };

          window.disableAiStyle = async function(id) {
            try {
              await apiFetch(`/v1/admin/ai-styles/${id}/disable`, { method: "PATCH" });
              showOk("AI Style disabled.");
              await loadAiStylesAdmin();
            } catch (e) {
              showError("Failed to disable AI Style: " + (e?.message || e));
            }
          };

          window.enableAiStyle = async function(id) {
            try {
              await apiFetch(`/v1/admin/ai-styles/${id}/enable`, { method: "PATCH" });
              showOk("AI Style enabled.");
              await loadAiStylesAdmin();
            } catch (e) {
              showError("Failed to enable AI Style: " + formatErrorForDisplay(e));
            }
          };

          async function saveAiStyle() {
            const key = document.getElementById("aiStylesEditorKey").value.trim();
            const name = document.getElementById("aiStylesEditorName").value.trim();
            if (!key || !name) {
              showError("Key and Name are required");
              return;
            }
            try {
              // Parse fewShotExamples JSON if provided
              let fewShotExamples = null;
              const fewShotExamplesText = document.getElementById("aiStylesEditorFewShotExamples").value.trim();
              if (fewShotExamplesText) {
                try {
                  fewShotExamples = JSON.parse(fewShotExamplesText);
                } catch (e) {
                  showError("Few Shot Examples must be valid JSON");
                  return;
                }
              }

              const payload = {
                key,
                name,
                description: document.getElementById("aiStylesEditorDescription").value.trim(),
                stylePrompt: document.getElementById("aiStylesEditorStylePrompt").value.trim(),
                forbiddenBehavior: document.getElementById("aiStylesEditorForbiddenBehavior").value.trim(),
                maxChars: parseInt(document.getElementById("aiStylesEditorMaxChars").value || 500),
                maxLines: parseInt(document.getElementById("aiStylesEditorMaxLines").value || 10),
                questionRate: parseInt(document.getElementById("aiStylesEditorQuestionRate").value || 50),
                emojiRate: parseInt(document.getElementById("aiStylesEditorEmojiRate").value || 30),
                initiative: parseInt(document.getElementById("aiStylesEditorInitiative").value || 50),
                warmth: parseInt(document.getElementById("aiStylesEditorWarmth").value || 50),
                judgment: parseInt(document.getElementById("aiStylesEditorJudgment").value || 50),
                flirtTension: parseInt(document.getElementById("aiStylesEditorFlirtTension").value || 50),
                formality: parseInt(document.getElementById("aiStylesEditorFormality").value || 50),
                temperature: document.getElementById("aiStylesEditorTemperature").value ? parseFloat(document.getElementById("aiStylesEditorTemperature").value) : null,
                topP: document.getElementById("aiStylesEditorTopP").value ? parseFloat(document.getElementById("aiStylesEditorTopP").value) : null,
                fewShotExamples: fewShotExamples,
                isActive: document.getElementById("aiStylesEditorActive").checked,
              };
              if (aiStylesAdminState.selectedStyleId) {
                await apiFetch(`/v1/admin/ai-styles/${aiStylesAdminState.selectedStyleId}`, {
                  method: "PUT",
                  body: JSON.stringify(payload),
                });
                showOk("AI Style updated.");
              } else {
                await apiFetch("/v1/admin/ai-styles", {
                  method: "POST",
                  body: JSON.stringify(payload),
                });
                showOk("AI Style created.");
              }
              document.getElementById("aiStylesEditor").style.display = "none";
              aiStylesAdminState.selectedStyleId = null;
              await loadAiStylesAdmin();
            } catch (e) {
              showError("Failed to save AI Style: " + formatErrorForDisplay(e));
            }
          }

          function cancelAiStyleEdit() {
            document.getElementById("aiStylesEditor").style.display = "none";
            aiStylesAdminState.selectedStyleId = null;
          }

          function addAiStyle() {
            aiStylesAdminState.selectedStyleId = null;
            document.getElementById("aiStylesEditor").style.display = "block";
            document.getElementById("aiStylesEditorKey").value = "";
            document.getElementById("aiStylesEditorName").value = "";
            document.getElementById("aiStylesEditorDescription").value = "";
            document.getElementById("aiStylesEditorStylePrompt").value = "";
            document.getElementById("aiStylesEditorForbiddenBehavior").value = "";
            document.getElementById("aiStylesEditorMaxChars").value = "500";
            document.getElementById("aiStylesEditorMaxLines").value = "10";
            document.getElementById("aiStylesEditorQuestionRate").value = "50";
            document.getElementById("aiStylesEditorEmojiRate").value = "30";
            document.getElementById("aiStylesEditorInitiative").value = "50";
            document.getElementById("aiStylesEditorWarmth").value = "50";
            document.getElementById("aiStylesEditorJudgment").value = "50";
            document.getElementById("aiStylesEditorFlirtTension").value = "50";
            document.getElementById("aiStylesEditorFormality").value = "50";
            document.getElementById("aiStylesEditorTemperature").value = "";
            document.getElementById("aiStylesEditorTopP").value = "";
            document.getElementById("aiStylesEditorFewShotExamples").value = "";
            document.getElementById("aiStylesEditorActive").checked = true;
          }

          // Personas Admin functions
          async function loadPersonasAdmin() {
            try {
              const res = await apiFetch("/v1/admin/personas", { method: "GET" });
              // Wave 1.2: apiFetch throws on error, so if we get here it succeeded
              // Accept either array or wrapped objects
              const personas = Array.isArray(res) ? res : (res.personas || res.items || []);
              personasAdminState.personas = personas;
              renderPersonasTable();
              log(`Loaded personas: ${personas.length}`);
              showOk(`Personas loaded (${personas.length}).`);
            } catch (e) {
              showError("Error loading Personas: " + formatErrorForDisplay(e));
            }
          }

          function renderPersonasTable() {
            const tbody = document.getElementById("personasTableBody");
            if (!tbody) return;
            tbody.innerHTML = "";
            for (const persona of personasAdminState.personas) {
              const row = document.createElement("tr");
              row.style.borderBottom = "1px solid var(--line)";
              row.innerHTML = `
                <td style="padding: 8px;">${escapeHtml(persona.code || "")}</td>
                <td style="padding: 8px;">${escapeHtml(persona.name || "")}</td>
                <td style="padding: 8px;">${persona.active ? "✓" : "✗"}</td>
                <td style="padding: 8px;">
                  <button class="btn" style="padding: 4px 8px; font-size: 11px;" onclick="editPersona('${persona.id}')">Edit</button>
                </td>
              `;
              tbody.appendChild(row);
            }
          }

          window.editPersona = function(id) {
            const persona = personasAdminState.personas.find(p => p.id === id);
            if (!persona) return;
            personasAdminState.selectedPersonaId = id;
            document.getElementById("personasEditor").style.display = "block";
            document.getElementById("personasEditorCode").value = persona.code || "";
            document.getElementById("personasEditorName").value = persona.name || "";
            document.getElementById("personasEditorDescription").value = persona.description || "";
            document.getElementById("personasEditorAvatarUrl").value = persona.avatarUrl || "";
            document.getElementById("personasEditorActive").checked = persona.active !== false;
          };

          async function savePersona() {
            const code = document.getElementById("personasEditorCode").value.trim();
            const name = document.getElementById("personasEditorName").value.trim();
            if (!code || !name) {
              showError("Code and Name are required");
              return;
            }
            try {
              const payload = {
                code,
                name,
                description: document.getElementById("personasEditorDescription").value.trim(),
                avatarUrl: document.getElementById("personasEditorAvatarUrl").value.trim(),
                active: document.getElementById("personasEditorActive").checked,
              };
              if (personasAdminState.selectedPersonaId) {
                await apiFetch(`/v1/admin/personas/${personasAdminState.selectedPersonaId}`, {
                  method: "PUT",
                  body: JSON.stringify(payload),
                });
                showOk("Persona updated.");
              } else {
                await apiFetch("/v1/admin/personas", {
                  method: "POST",
                  body: JSON.stringify(payload),
                });
                showOk("Persona created.");
              }
              document.getElementById("personasEditor").style.display = "none";
              personasAdminState.selectedPersonaId = null;
              await loadPersonasAdmin();
            } catch (e) {
              showError("Failed to save Persona: " + formatErrorForDisplay(e));
            }
          }

          function cancelPersonaEdit() {
            document.getElementById("personasEditor").style.display = "none";
            personasAdminState.selectedPersonaId = null;
          }

          function addPersona() {
            personasAdminState.selectedPersonaId = null;
            document.getElementById("personasEditor").style.display = "block";
            document.getElementById("personasEditorCode").value = "";
            document.getElementById("personasEditorName").value = "";
            document.getElementById("personasEditorDescription").value = "";
            document.getElementById("personasEditorAvatarUrl").value = "";
            document.getElementById("personasEditorActive").checked = true;
          }

          // Wire AI Styles and Personas Admin
          function wireAdminSections() {
            // AI Styles
            const aiStylesLoadBtn = document.getElementById("aiStylesLoadBtn");
            const aiStylesAddBtn = document.getElementById("aiStylesAddBtn");
            const aiStylesSaveBtn = document.getElementById("aiStylesSaveBtn");
            const aiStylesCancelBtn = document.getElementById("aiStylesCancelBtn");
            
            if (aiStylesLoadBtn) {
              aiStylesLoadBtn.addEventListener("click", loadAiStylesAdmin);
              aiStylesLoadBtn.dataset.bound = "1"; // Wave 1.2: Mark as bound
            }
            if (aiStylesAddBtn) aiStylesAddBtn.addEventListener("click", addAiStyle);
            if (aiStylesSaveBtn) aiStylesSaveBtn.addEventListener("click", saveAiStyle);
            if (aiStylesCancelBtn) aiStylesCancelBtn.addEventListener("click", cancelAiStyleEdit);
            
            // Personas
            const personasLoadBtn = document.getElementById("personasLoadBtn");
            const personasAddBtn = document.getElementById("personasAddBtn");
            const personasSaveBtn = document.getElementById("personasSaveBtn");
            const personasCancelBtn = document.getElementById("personasCancelBtn");
            
            if (personasLoadBtn) {
              personasLoadBtn.addEventListener("click", loadPersonasAdmin);
              personasLoadBtn.dataset.bound = "1"; // Wave 1.2: Mark as bound
            }
            if (personasAddBtn) personasAddBtn.addEventListener("click", addPersona);
            if (personasSaveBtn) personasSaveBtn.addEventListener("click", savePersona);
            if (personasCancelBtn) personasCancelBtn.addEventListener("click", cancelPersonaEdit);
          }

          // Step 7.2: Wire Engine Config events
          function wireEngineConfig() {
            // Wave 1 Hotfix: Re-query tabs inside function to ensure DOM is ready
            const tabs = document.querySelectorAll(".engineConfigTab");
            const tabContents = document.querySelectorAll(".engineConfigTabContent");
            
            // Tab switching
            tabs.forEach(tab => {
              tab.addEventListener("click", () => {
                const tabName = tab.getAttribute("data-tab");
                engineConfigState.currentTab = tabName;
                
                // Update tab visual state
                tabs.forEach(t => {
                  t.style.background = "var(--btn)";
                  t.style.borderColor = "var(--line)";
                });
                tab.style.background = "var(--btn2)";
                tab.style.borderColor = "rgba(77, 97, 255, 0.45)";
                
                // Hide all tab contents
                tabContents.forEach(content => {
                  content.style.display = "none";
                });
                
                // Show selected tab content
                const tabIdMap = {
                  'microFeedback': 'MicroFeedback',
                  'microDynamics': 'MicroDynamics',
                  'persona': 'Persona',
                };
                const tabId = tabIdMap[tabName] || (tabName.charAt(0).toUpperCase() + tabName.slice(1));
                const tabContentEl = document.getElementById(`engineConfigTab${tabId}`);
                if (tabContentEl) {
                  tabContentEl.style.display = "block";
                } else {
                  log(`WARNING: Tab content element not found for tab: ${tabName}`);
                }
                
                // Log tab switch
                log(`EngineConfig tab -> ${tabName}`);
                
                // Render tab content (calls appropriate render function)
                renderEngineConfigTabs();
              });
            });
            
            // Log wiring success
            log(`EngineConfig wiring OK (tabs=${tabs.length})`);
            
            // Set first tab as active
            if (tabs.length > 0) {
              tabs[0].click();
            } else {
              log("WARNING: No EngineConfig tabs found. Check HTML structure.");
            }
            
            // Wave 1 Hotfix: Safe access to load/save buttons
            if (engineConfigUI.loadBtn) {
              engineConfigUI.loadBtn.addEventListener("click", loadEngineConfig);
            } else {
              log("WARNING: engineConfigLoadBtn not found");
            }
            if (engineConfigUI.saveBtn) {
              engineConfigUI.saveBtn.addEventListener("click", saveEngineConfig);
            } else {
              log("WARNING: engineConfigSaveBtn not found");
            }
            
            // Scoring tab
            engineConfigUI.addScoringProfileBtn.addEventListener("click", () => {
              if (!engineConfigState.config) {
                showError("Load config first");
                return;
              }
              const code = prompt("Enter profile code:");
              if (!code) return;
              const name = prompt("Enter profile name:");
              if (!name) return;
              engineConfigState.config.scoringProfiles.push({
                code,
                name,
                description: "",
                active: true,
                traitWeights: { confidence: 0.3, clarity: 0.25, humor: 0.15, tensionControl: 0.1, emotionalWarmth: 0.2, dominance: 0 },
                lengthThresholds: { empty: 10, veryShort: 35, short: 55, medium: 75, long: 82, veryLong: 70 },
                punctuationBonuses: { questionPerMark: 2, questionMax: 10, exclamationPerMark: 3, exclamationMax: 12 },
                positionBonuses: [0, 2, 4, 5],
                rarityThresholds: { sPlus: 92, s: 84, a: 72, b: 58, c: 0 },
                xpMultipliers: { sPlus: 1.8, s: 1.5, a: 1.25, b: 1.0, c: 0.8 },
                coinsMultipliers: { sPlus: 1.7, s: 1.4, a: 1.2, b: 1.0, c: 0.7 },
                traitAdjustments: [],
                fillerWords: [],
                traitBuckets: {},
                traitEmaAlpha: 0.3,
                strictMode: false,
                softCoachingMode: false,
              });
              renderScoringTab();
              selectScoringProfile(code);
            });
            
            engineConfigUI.normalizeWeightsBtn.addEventListener("click", normalizeWeights);
            ["engineConfigScoringWeightConfidence", "engineConfigScoringWeightClarity", "engineConfigScoringWeightHumor", 
             "engineConfigScoringWeightTensionControl", "engineConfigScoringWeightEmotionalWarmth", "engineConfigScoringWeightDominance"].forEach(id => {
              document.getElementById(id).addEventListener("input", updateWeightsSum);
            });
            
            // Auto-save scoring profile on change
            ["engineConfigScoringName", "engineConfigScoringDescription", "engineConfigScoringActive",
             "engineConfigScoringLengthEmpty", "engineConfigScoringLengthVeryShort", "engineConfigScoringLengthShort",
             "engineConfigScoringLengthMedium", "engineConfigScoringLengthLong", "engineConfigScoringLengthVeryLong",
             "engineConfigScoringPunctQuestionPerMark", "engineConfigScoringPunctQuestionMax",
             "engineConfigScoringPunctExclamationPerMark", "engineConfigScoringPunctExclamationMax",
             "engineConfigScoringPosition0", "engineConfigScoringPosition1", "engineConfigScoringPosition2", "engineConfigScoringPosition3",
             "engineConfigScoringRaritySPlus", "engineConfigScoringRarityS", "engineConfigScoringRarityA", "engineConfigScoringRarityB",
             "engineConfigScoringXpSPlus", "engineConfigScoringXpS", "engineConfigScoringXpA", "engineConfigScoringXpB", "engineConfigScoringXpC",
             "engineConfigScoringCoinsSPlus", "engineConfigScoringCoinsS", "engineConfigScoringCoinsA", "engineConfigScoringCoinsB", "engineConfigScoringCoinsC",
             "engineConfigScoringTraitEmaAlpha", "engineConfigScoringStrictMode", "engineConfigScoringSoftCoachingMode"].forEach(id => {
              const el = document.getElementById(id);
              if (el) {
                el.addEventListener("change", saveScoringProfile);
                if (el.type === "checkbox") {
                  el.addEventListener("click", saveScoringProfile);
                }
              }
            });
            
            // Micro feedback button
            if (engineConfigUI.loadMicroFeedbackBtn) {
              engineConfigUI.loadMicroFeedbackBtn.addEventListener("click", loadMicroFeedback);
            }
            
            // Dynamics tab
            engineConfigUI.addDynamicsProfileBtn.addEventListener("click", () => {
              if (!engineConfigState.config) {
                showError("Load config first");
                return;
              }
              const code = prompt("Enter profile code:");
              if (!code) return;
              const name = prompt("Enter profile name:");
              if (!name) return;
              engineConfigState.config.dynamicsProfiles.push({
                code,
                name,
                description: "",
                active: true,
                pace: 50,
                emojiDensity: 30,
                flirtiveness: 40,
                hostility: 10,
                dryness: 40,
                vulnerability: 50,
                escalationSpeed: 50,
                randomness: 25,
              });
              renderDynamicsTab();
              selectDynamicsProfile(code);
            });
            
            ["engineConfigDynamicsPace", "engineConfigDynamicsEmojiDensity", "engineConfigDynamicsFlirtiveness",
             "engineConfigDynamicsHostility", "engineConfigDynamicsDryness", "engineConfigDynamicsVulnerability",
             "engineConfigDynamicsEscalationSpeed", "engineConfigDynamicsRandomness"].forEach(id => {
              const el = document.getElementById(id);
              if (el) {
                el.addEventListener("input", updateDynamicsValues);
              }
            });
            
            // Auto-save dynamics profile on change
            ["engineConfigDynamicsName", "engineConfigDynamicsDescription", "engineConfigDynamicsActive",
             "engineConfigDynamicsPace", "engineConfigDynamicsEmojiDensity", "engineConfigDynamicsFlirtiveness",
             "engineConfigDynamicsHostility", "engineConfigDynamicsDryness", "engineConfigDynamicsVulnerability",
             "engineConfigDynamicsEscalationSpeed", "engineConfigDynamicsRandomness"].forEach(id => {
              const el = document.getElementById(id);
              if (el) {
                el.addEventListener("change", saveDynamicsProfile);
                if (el.type === "checkbox") {
                  el.addEventListener("click", saveDynamicsProfile);
                }
              }
            });
            
            // Gates tab
            engineConfigUI.addGateBtn.addEventListener("click", () => {
              if (!engineConfigState.config) {
                showError("Load config first");
                return;
              }
              const key = prompt("Enter gate key (e.g. GATE_CUSTOM):");
              if (!key) return;
              engineConfigState.config.gates.push({
                key,
                description: "",
                active: true,
              });
              renderGatesTab();
              selectGate(key);
            });
            
            document.getElementById("engineConfigGateSaveBtn").addEventListener("click", saveGate);
            
            // Hooks tab
            engineConfigUI.loadHooksBtn.addEventListener("click", loadHooks);
            engineConfigUI.addHookBtn.addEventListener("click", () => {
              engineConfigState.selectedHook = null;
              engineConfigUI.hookEditor.style.display = "block";
              document.getElementById("engineConfigHookName").value = "";
              document.getElementById("engineConfigHookType").value = "POSITIVE";
              document.getElementById("engineConfigHookPriority").value = "50";
              document.getElementById("engineConfigHookTextTemplate").value = "";
              document.getElementById("engineConfigHookConditionsJson").value = "{}";
              document.getElementById("engineConfigHookCategory").value = "";
              document.getElementById("engineConfigHookTags").value = "";
              document.getElementById("engineConfigHookEnabled").checked = true;
            });
            document.getElementById("engineConfigHookSaveBtn").addEventListener("click", saveHook);
            engineConfigUI.refreshTriggersBtn.addEventListener("click", loadTriggerStats);
            
            // Mood tab
            engineConfigUI.addMoodBandBtn.addEventListener("click", addMoodBand);
            // Auto-save mood config on change
            ["engineConfigMoodEmaAlpha", "engineConfigMoodFlowMinScore", "engineConfigMoodFlowMinFlow", "engineConfigMoodFlowMaxTension",
             "engineConfigMoodTenseMinTension", "engineConfigMoodTenseOrMaxScore", "engineConfigMoodTenseOrMinTension",
             "engineConfigMoodWarmMinScore", "engineConfigMoodWarmMaxScore", "engineConfigMoodWarmMinWarmth",
             "engineConfigMoodColdMaxScore", "engineConfigMoodColdMaxWarmth",
             "engineConfigStatePolicyMinMessages", "engineConfigStatePolicyFailOnThreeCritical", "engineConfigStatePolicyAllowRecovery"].forEach(id => {
              const el = document.getElementById(id);
              if (el) {
                el.addEventListener("change", saveMoodConfig);
                if (el.type === "checkbox") {
                  el.addEventListener("click", saveMoodConfig);
                }
              }
            });
            
            // Insights tab
            engineConfigUI.loadInsightsBtn.addEventListener("click", loadInsights);
            engineConfigUI.loadInsightsBtn.dataset.bound = "1"; // Wave 1.2: Mark as bound
            engineConfigUI.insightsKindFilter.addEventListener("change", loadInsights);
            const addCustomInsightBtn = document.getElementById("engineConfigAddCustomInsightBtn");
            if (addCustomInsightBtn) {
              addCustomInsightBtn.addEventListener("click", () => {
                const editor = document.getElementById("engineConfigCustomInsightEditor");
                const detail = document.getElementById("engineConfigInsightDetail");
                if (editor) {
                  editor.style.display = "block";
                  if (detail) detail.style.display = "none";
                }
              });
            }
            const customInsightSaveBtn = document.getElementById("engineConfigCustomInsightSaveBtn");
            if (customInsightSaveBtn) {
              customInsightSaveBtn.addEventListener("click", saveCustomInsight);
            }
            const customInsightCancelBtn = document.getElementById("engineConfigCustomInsightCancelBtn");
            if (customInsightCancelBtn) {
              customInsightCancelBtn.addEventListener("click", () => {
                const editor = document.getElementById("engineConfigCustomInsightEditor");
                if (editor) {
                  editor.style.display = "none";
                }
              });
            }
            
            // Wave 1: Wire Insights sub-tabs (Insights vs Opening Templates)
            if (engineConfigUI.insightsSubtabs && engineConfigUI.insightsSubtabs.length > 0) {
              engineConfigUI.insightsSubtabs.forEach(subtab => {
                subtab.addEventListener("click", () => {
                  const subtabName = subtab.getAttribute("data-insights-subtab");
                  log(`Insights sub-tab -> ${subtabName}`);
                  
                  // Update visual state
                  engineConfigUI.insightsSubtabs.forEach(st => {
                    st.style.background = "var(--btn)";
                    st.style.borderColor = "var(--line)";
                  });
                  subtab.style.background = "var(--btn2)";
                  subtab.style.borderColor = "rgba(77, 97, 255, 0.45)";
                  
                  // Show/hide sub-tab content
                  const insightsSubtab = document.getElementById("engineConfigInsightsSubtabInsights");
                  const openingsSubtab = document.getElementById("engineConfigInsightsSubtabOpenings");
                  
                  if (subtabName === "insights") {
                    if (insightsSubtab) insightsSubtab.style.display = "block";
                    if (openingsSubtab) openingsSubtab.style.display = "none";
                  } else if (subtabName === "openings") {
                    if (insightsSubtab) insightsSubtab.style.display = "none";
                    if (openingsSubtab) openingsSubtab.style.display = "block";
                  }
                });
              });
              
              // Set first sub-tab as active
              if (engineConfigUI.insightsSubtabs.length > 0) {
                engineConfigUI.insightsSubtabs[0].click();
              }
            } else {
              log("WARNING: Insights sub-tabs not found");
            }
            
            // Opening templates button
            if (engineConfigUI.loadOpeningsBtn) {
              engineConfigUI.loadOpeningsBtn.addEventListener("click", loadOpenings);
              engineConfigUI.loadOpeningsBtn.dataset.bound = "1"; // Wave 1.2: Mark as bound
            }
            
            // Mission Attachments tab
            if (engineConfigUI.loadAttachmentsBtn) {
              engineConfigUI.loadAttachmentsBtn.addEventListener("click", loadMissionAttachments);
              engineConfigUI.loadAttachmentsBtn.dataset.bound = "1"; // Wave 1.2: Mark as bound
            }
            if (engineConfigUI.attachmentsCategoryFilter) {
              engineConfigUI.attachmentsCategoryFilter.addEventListener("change", renderMissionAttachmentsTable);
            }
            if (engineConfigUI.attachmentsSearchInput) {
              engineConfigUI.attachmentsSearchInput.addEventListener("input", renderMissionAttachmentsTable);
            }
            if (engineConfigUI.attachmentsSaveBtn) {
              engineConfigUI.attachmentsSaveBtn.addEventListener("click", saveMissionAttachments);
            }
            if (engineConfigUI.attachmentsResetBtn) {
              engineConfigUI.attachmentsResetBtn.addEventListener("click", resetMissionAttachments);
            }
            
            // Monitoring tab
            engineConfigUI.refreshMonitoringBtn.addEventListener("click", renderMonitoringTab);
            
            // Micro Feedback tab
            // Wave 1.2: Wire both Add Band buttons safely
            document.querySelectorAll("#engineConfigMicroFeedbackAddBandBtn, #engineConfigMicroFeedbackAddBandBtn2").forEach(btn => {
              btn.addEventListener("click", addMicroFeedbackBand);
              btn.dataset.bound = "1"; // Mark as bound
            });
            // Wave 1.4: MicroFeedback header fields live-dirty
            ["engineConfigMicroFeedbackVeryShortMsg", "engineConfigMicroFeedbackDefaultMsg"].forEach(id => {
              const el = document.getElementById(id);
              if (el) {
                el.addEventListener("input", () => {
                  setEngineConfigDirty(true);
                  syncMicroFeedbackFromUI();
                });
              }
            });
            // Auto-save bands on change (will be handled by removeMicroFeedbackBand and addMicroFeedbackBand)
            
            // Micro Dynamics tab
            ["engineConfigMicroDynamicsRiskBaseMin", "engineConfigMicroDynamicsRiskBaseMax", 
             "engineConfigMicroDynamicsRiskTensionThreshold", "engineConfigMicroDynamicsRiskTensionMaxPenalty",
             "engineConfigMicroDynamicsRiskDifficultyHard", "engineConfigMicroDynamicsRiskDifficultyMedium",
             "engineConfigMicroDynamicsRiskProgressEarly", "engineConfigMicroDynamicsRiskProgressLate",
             "engineConfigMicroDynamicsMomentumScoreDelta", "engineConfigMicroDynamicsMomentumGateProgress",
             "engineConfigMicroDynamicsMomentumMoodPositive", "engineConfigMicroDynamicsMomentumMoodNegative",
             "engineConfigMicroDynamicsMomentumTrend", "engineConfigMicroDynamicsFlowVariance"].forEach(id => {
              const el = document.getElementById(id);
              if (el) {
                el.addEventListener("change", saveMicroDynamicsConfig);
              }
            });
            
            // Persona tab
            ["engineConfigPersonaDriftStyleMoodConflict", "engineConfigPersonaDriftStyleMoodConflictMinor",
             "engineConfigPersonaDriftDynamicsMoodConflict", "engineConfigPersonaDriftVulnerabilityMoodConflict",
             "engineConfigPersonaDriftScoreStyleConflict", "engineConfigPersonaDriftNegativeFlagsConflict",
             "engineConfigPersonaModifierTensionSpike", "engineConfigPersonaModifierMoodDropLow",
             "engineConfigPersonaModifierMoodDropHigh", "engineConfigPersonaModifierScoreCollapse",
             "engineConfigPersonaModifierScoreCollapseDivisor", "engineConfigPersonaModifierNegativeFlags",
             "engineConfigPersonaModifierNegativeFlagsDivisor", "engineConfigPersonaModifierEffectReduceRisk",
             "engineConfigPersonaModifierEffectLowerWarmth"].forEach(id => {
              const el = document.getElementById(id);
              if (el) {
                el.addEventListener("change", savePersonaConfig);
              }
            });
          }

          // Step 7.2: Admin boot function (renamed to avoid collision)
          // NOTE: This function is NOT called automatically - it's integrated into main boot()
          function bootAdmin() {
            // PracticeHub wiring - check if it exists
            if (typeof wirePracticeHub === "function") {
              wirePracticeHub();
            }
            
            // Note: wireEngineConfig() and wireAdminSections() are now called from main boot()
            // Auto-loading engine config on startup is disabled to avoid JWT noise
            
            // Wave 1.2: Run button audit at end of boot
            setTimeout(() => {
              if (typeof window.__auditButtons === "function") {
                const auditResult = window.__auditButtons();
                log(`Button audit complete: ${auditResult.okCount}/${auditResult.total} OK, ${auditResult.missingElements.length} missing, ${auditResult.unbound.length} unbound`);
              }
            }, 100);
          }
      })();
    </script>
  </body>
</html>
