<!DOCTYPE html>
<html lang="en">
<head>
  <script type="module" src="/@vite/client"></script>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate, max-age=0" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <meta http-equiv="Last-Modified" content="0" />
  <title>Frontend Dashboard — Visual Editor</title>
  <style>
    :root{--bg:#0f1220;--panel:#141a33;--sub:#0f1530;--text:#e8ecf7;--muted:#9aa7b4;--brand:#79c0ff;--ok:#3fb950;--warn:#d29922;--err:#f85149;--border:rgba(255,255,255,.1);--grid:8}

    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:radial-gradient(1200px 700px at -10% -8%,#1b2a4a 0%,#0f1220 50%),var(--bg);color:var(--text);font:14px/1.35 system-ui,Segoe UI,Inter,sans-serif;display:flex}

    .sidebar{width:260px;border-right:1px solid var(--border);background:linear-gradient(180deg,#12162a,#0f1426);padding:10px;overflow:auto}

    .main{flex:1;display:grid;grid-template-rows:auto 1fr auto;gap:8px}
    header{display:flex;align-items:center;gap:8px;padding:10px;border-bottom:1px solid var(--border)}

    select,input,button{background:#0d1330;color:var(--text);border:1px solid var(--border);border-radius:10px;padding:8px}

    button{cursor:pointer}
    .row{display:flex;gap:8px;align-items:center;margin:6px 0}
    .list button{width:100%;text-align:left;background:#152047}
    .list button.locked{background:#3d2a2a;color:#ff9a9a;cursor:not-allowed}
    .work{display:grid;grid-template-columns:1fr 320px;gap:8px;padding:8px}
    .canvasWrap{border:1px solid var(--border);border-radius:14px;background:linear-gradient(180deg,#121933,#0b1226);padding:10px;position:relative;overflow:auto;max-height:600px}

    .canvas{position:relative;width:375px;min-height:1200px;margin:auto;background:#0e1633;border:1px dashed rgba(255,255,255,.12);border-radius:20px}

    .comp{position:absolute;border:1px solid var(--border);border-radius:12px;background:linear-gradient(180deg,#1c254d,#131c3d);padding:8px;min-width:64px;min-height:40px;outline:0;cursor:move}

    .comp.sel{box-shadow:0 0 0 2px var(--brand) inset}
    .comp .title{font-weight:700;font-size:12px;margin-bottom:4px}
    .comp .resize-handle{position:absolute;width:8px;height:8px;background:var(--brand);border-radius:50%;cursor:pointer;opacity:0;transition:opacity 0.2s}
    .comp.sel .resize-handle{opacity:1}
    .comp .resize-handle.nw{top:-4px;left:-4px;cursor:nw-resize}
    .comp .resize-handle.ne{top:-4px;right:-4px;cursor:ne-resize}
    .comp .resize-handle.sw{bottom:-4px;left:-4px;cursor:sw-resize}
    .comp .resize-handle.se{bottom:-4px;right:-4px;cursor:se-resize}
    .comp .resize-handle.n{top:-4px;left:50%;transform:translateX(-50%);cursor:n-resize}
    .comp .resize-handle.s{bottom:-4px;left:50%;transform:translateX(-50%);cursor:s-resize}
    .comp .resize-handle.w{left:-4px;top:50%;transform:translateY(-50%);cursor:w-resize}
    .comp .resize-handle.e{right:-4px;top:50%;transform:translateY(-50%);cursor:e-resize}
    .gridBg{background-image: linear-gradient(to right, rgba(255,255,255,.06) 1px, transparent 1px), linear-gradient(to bottom, rgba(255,255,255,.06) 1px, transparent 1px); background-size: calc(var(--grid)*1px) calc(var(--grid)*1px)}

    .right{border:1px solid var(--border);border-radius:14px;background:linear-gradient(180deg,#121a38,#0f152e);padding:10px}

    .badge{display:inline-flex;gap:6px;align-items:center;padding:2px 8px;border:1px solid var(--border);border-radius:999px;font-size:12px}

    .ok{background:rgba(63,185,80,.15);border-color:rgba(63,185,80,.35)}
    .warn{background:rgba(210,153,34,.15);border-color:rgba(210,153,34,.35)}
    .err{background:rgba(248,81,73,.15);border-color:rgba(248,81,73,.35)}
    .previewCard{border:1px solid var(--border);border-radius:12px;background:#0f152e;padding:10px;margin-top:6px}

    .muted{color:var(--muted)}
    .saveBtn{background:#1f6feb;border-color:#1f6feb;color:white;font-weight:600}
    .saveBtn:hover{background:#1a5fdb}
    .saveBtn:disabled{background:#2a2a2a;border-color:#444;color:#666;cursor:not-allowed}
    .status{font-size:12px;padding:4px 8px;border-radius:6px;margin-left:8px}
      .status.saving{background:rgba(210,153,34,.15);color:#d29922}
  .status.saved{background:rgba(63,185,80,.15);color:#3fb950}
  .status.error{background:rgba(248,81,73,.15);color:#f85149}
  
  /* Toolbar Styles */
  .toolbar {
    position: fixed;
    top: 80px;
    right: 20px;
    background: rgba(13, 19, 48, 0.95);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 16px;
    min-width: 280px;
    backdrop-filter: blur(10px);
    z-index: 1000;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
    max-height: calc(100vh - 120px);
    overflow-y: auto;
  }
  
  .toolbar-section {
    margin-bottom: 16px;
  }
  
  .toolbar-section:last-child {
    margin-bottom: 0;
  }
  
  .toolbar-section h4 {
    margin: 0 0 8px 0;
    font-size: 12px;
    color: var(--text);
    opacity: 0.8;
    font-weight: 600;
  }
  
  .toolbar-buttons {
    display: flex;
    gap: 4px;
    flex-wrap: wrap;
  }
  
  .toolbar-btn {
    width: 32px;
    height: 32px;
    border: 1px solid var(--border);
    background: rgba(26, 26, 34, 0.8);
    color: var(--text);
    border-radius: 6px;
    cursor: pointer;
    font-size: 14px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
  }
  
  .toolbar-btn:hover {
    background: rgba(64, 64, 128, 0.3);
    border-color: var(--brand);
    transform: translateY(-1px);
  }
  
  .toolbar-btn:active {
    transform: translateY(0);
  }
  
  .toolbar-btn.disabled {
    opacity: 0.4;
    cursor: not-allowed;
  }
  
  /* Enhanced component selection */
  .comp {
    cursor: grab;
    transition: all 0.2s ease;
  }
  
  .comp:hover {
    transform: scale(1.02);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
  }
  
  .comp.sel {
    box-shadow: 0 0 0 2px var(--brand), 0 4px 16px rgba(0, 0, 0, 0.4);
    transform: scale(1.02);
  }
  
  /* Header Groups */
  .header-group {
    display: flex;
    align-items: center;
    gap: 4px;
    padding: 4px 8px;
    background: rgba(26, 26, 34, 0.5);
    border-radius: 6px;
    border: 1px solid var(--border);
  }
  
  .header-btn {
    padding: 4px 8px;
    background: rgba(26, 26, 34, 0.8);
    border: 1px solid var(--border);
    color: var(--text);
    border-radius: 4px;
    cursor: pointer;
    font-size: 12px;
    transition: all 0.2s ease;
  }
  
  .header-btn:hover {
    background: rgba(64, 64, 128, 0.3);
    border-color: var(--brand);
  }
  
  .status-group {
    display: flex;
    gap: 4px;
    align-items: center;
  }
  
  /* Adjust main content to avoid toolbar overlap */
  .main {
    margin-right: 320px;
  }
  
  .canvasWrap {
    margin-right: 0;
  }
  </style>
</head>
<body>
  <script>
    // Force cache refresh and prevent caching
    if (window.performance && window.performance.navigation.type === window.performance.navigation.TYPE_BACK_FORWARD) {
      window.location.reload(true);
    }
    
    // Add timestamp to prevent caching
    const timestamp = new Date().getTime();
    document.title = document.title + ' - v' + timestamp;
    
    // Force reload if this is an old cached version
    if (localStorage.getItem('dashboard_version') !== timestamp.toString()) {
      localStorage.setItem('dashboard_version', timestamp.toString());
      if (performance.navigation.type !== performance.navigation.TYPE_RELOAD) {
        console.log('Detected old dashboard version, forcing reload...');
        window.location.reload(true);
      }
    }
    
    // Additional cache-busting: check if this is a fresh load
    const urlParams = new URLSearchParams(window.location.search);
    const urlVersion = urlParams.get('v');
    if (urlVersion) {
      console.log('URL version parameter detected:', urlVersion);
      // Update localStorage with URL version
      localStorage.setItem('dashboard_version', urlVersion);
    }
    
    // Log current version for debugging
    console.log('Dashboard loaded with version:', timestamp);
    console.log('Stored version:', localStorage.getItem('dashboard_version'));
  </script>
  <aside class="sidebar">
    <div>
      <label class="muted">Page</label>
      <select id="pageSelect" style="width:100%"></select>
    </div>
    <div class="row" style="justify-content:space-between">
      <span class="muted">Components</span>
      <span id="lockLegend" class="badge warn">loading...</span>
    </div>
    <div id="componentList" class="list"></div>
  </aside>

  <div class="main">
    <header>
      <div style="font-weight:800">Frontend Dashboard — Visual Editor</div>
      <div class="row" style="margin-left:auto; gap: 8px; align-items: center;">
        <!-- Grid Controls -->
        <div class="header-group">
          <label class="muted">Grid Size:</label>
          <input id="gridSize" type="number" min="4" step="2" value="8" style="width:60px"/>
          <button id="toggleGrid" class="header-btn" title="Toggle Grid Visibility">Grid</button>
        </div>
        
        <!-- Zoom Controls -->
        <div class="header-group">
          <button id="zoomIn" class="header-btn" title="Zoom In">Zoom +</button>
          <button id="zoomOut" class="header-btn" title="Zoom Out">Zoom -</button>
          <button id="resetZoom" class="header-btn" title="Reset Zoom">Reset</button>
        </div>
        
        <!-- Sync Controls -->
        <div class="header-group">
          <button id="syncBtn" class="header-btn" title="Sync with React Native App">🔄 Sync</button>
          <button id="testSyncBtn" class="header-btn" title="Test Backend Connection">🧪 Test</button>
          <button id="pushToAppBtn" class="header-btn" title="Push Changes to App">📱 Push</button>
        </div>
        
        <!-- Save Control -->
        <div class="header-group">
          <button id="saveBtn" class="saveBtn" title="Save Changes to Server">💾 Save</button>
        </div>
        
        <!-- Toolbar Toggle -->
        <div class="header-group">
          <button id="toggleToolbarBtn" class="header-btn" title="Toggle Component Toolbar">🛠️ Tools</button>
        </div>
        
        <!-- Status Indicators -->
        <div class="status-group">
          <span id="saveStatus" class="status"></span>
          <span id="syncStatus" class="status"></span>
          <span id="appStatus" class="status"></span>
        </div>
      </div>
    </header>

    <section class="work">
      <div class="canvasWrap">
        <div id="canvas" class="canvas gridBg"></div>
      </div>
      
      <!-- Component Toolbar -->
      <div class="toolbar" id="componentToolbar" style="display:none">
        <div class="toolbar-section">
          <h4>🛠️ Component Tools</h4>
          <div class="toolbar-buttons">
            <button id="duplicateBtn" class="toolbar-btn" title="Duplicate Component">📋</button>
            <button id="deleteBtn" class="toolbar-btn" title="Delete Component">🗑️</button>
            <button id="lockBtn" class="toolbar-btn" title="Toggle Lock">🔒</button>
            <button id="bringFrontBtn" class="toolbar-btn" title="Bring to Front">⬆️</button>
            <button id="sendBackBtn" class="toolbar-btn" title="Send to Back">⬇️</button>
          </div>
        </div>
        
        <div class="toolbar-section">
          <h4>📐 Alignment</h4>
          <div class="toolbar-buttons">
            <button id="alignLeftBtn" class="toolbar-btn" title="Align Left">⬅️</button>
            <button id="alignCenterBtn" class="toolbar-btn" title="Align Center">↔️</button>
            <button id="alignRightBtn" class="toolbar-btn" title="Align Right">➡️</button>
            <button id="alignTopBtn" class="toolbar-btn" title="Align Top">⬆️</button>
            <button id="alignMiddleBtn" class="toolbar-btn" title="Align Middle">↕️</button>
            <button id="alignBottomBtn" class="toolbar-btn" title="Align Bottom">⬇️</button>
          </div>
        </div>
        
        <div class="toolbar-section">
          <h4>🎨 Styling</h4>
          <div class="toolbar-buttons">
            <button id="colorPickerBtn" class="toolbar-btn" title="Color Picker">🎨</button>
            <button id="borderBtn" class="toolbar-btn" title="Toggle Border">🔲</button>
            <button id="shadowBtn" class="toolbar-btn" title="Toggle Shadow">💫</button>
            <button id="roundedBtn" class="toolbar-btn" title="Toggle Rounded">🔘</button>
          </div>
        </div>
        
        <div class="toolbar-section">
          <h4>📏 Quick Resize</h4>
          <div class="toolbar-buttons">
            <button id="resizeSmallBtn" class="toolbar-btn" title="Small Size">📏</button>
            <button id="resizeMediumBtn" class="toolbar-btn" title="Medium Size">📐</button>
            <button id="resizeLargeBtn" class="toolbar-btn" title="Large Size">📏</button>
            <button id="fitContentBtn" class="toolbar-btn" title="Fit to Content">📦</button>
          </div>
        </div>
      </div>
      
      <div class="right">
        <div class="row" style="justify-content:space-between"><div>Inspector</div><span id="riskBadge" class="badge warn">No selection</span></div>

        <div class="previewCard">
          <div class="muted">Component Preview</div>
          <div id="compPreview" style="border:1px dashed var(--border);border-radius:10px;padding:10px;min-height:80px;display:grid;place-items:center">—</div>
        </div>
        
        <div style="margin-top:8px">
          <label class="muted">Component ID</label>
          <input id="inpId" readonly style="background:#1a1a1a" />
        </div>
        <div style="margin-top:8px">
          <label class="muted">Page</label>
          <input id="inpPage" readonly style="background:#1a1a1a" />
        </div>
        <div class="row">
          <div style="flex:1">
            <label class="muted">W</label>
            <input id="inpW" type="number" />
          </div>
          <div style="flex:1">
            <label class="muted">H</label>
            <input id="inpH" type="number" />
          </div>
        </div>
        <div class="row">
          <div style="flex:1">
            <label class="muted">X</label>
            <input id="inpX" type="number" />
          </div>
          <div style="flex:1">
            <label class="muted">Y</label>
            <input id="inpY" type="number" />
          </div>
        </div>
        <div>
          <label class="muted">Properties (JSON)</label>
          <textarea id="inpProps" style="width:100%;height:80px;background:#0d1330;color:var(--text);border:1px solid var(--border);border-radius:10px;padding:8px;font-family:monospace;font-size:12px"></textarea>
        </div>
        <div class="row"><button id="applyBtn">Apply Changes</button></div>
        <div style="margin-top:8px" class="muted">Tips: drag on canvas (snap to grid), or edit numbers. Changes are saved locally until you click "Save to Server".</div>
        <div style="margin-top:8px" class="muted">💡 <strong>NEW:</strong> "Save to Server" now automatically pushes changes to your React Native app!</div>
        <div style="margin-top:8px" class="muted">⌨️ <strong>Shortcuts:</strong> Delete/Backspace = Delete, Ctrl+D = Duplicate, Ctrl+L = Lock/Unlock, Escape = Deselect</div>
        <div style="margin-top:8px" class="muted">🛠️ <strong>Toolbar:</strong> Click "🛠️ Tools" to show/hide the component editing toolbar</div>
      </div>
    </section>

    <footer class="row" style="padding:8px;border-top:1px solid var(--border)">
      <div class="muted">Real SOCIALGYM components from your React Native app. Edit layouts and save to backend server. <span style="color:var(--brand)">📱 Canvas is scrollable - use mouse wheel or scrollbar to see all components!</span></div>
    </footer>
  </div>

<script>
(function(){
  const API_BASE = 'http://localhost:3000';
  const LS_KEY='fe.visual.editor.layouts';
  
  let layouts = [];
  let currentPage = 'PracticeHub';
  let selected = null;
  let snap = parseInt(get('#gridSize').value,10)||8;
  let hasUnsavedChanges = false;
  let zoomLevel = 1;

  const canvas = get('#canvas');
  const pageSelect = get('#pageSelect');
  const compList = get('#componentList');
  const riskBadge = get('#riskBadge');
  const lockLegend = get('#lockLegend');
  const compPreview = get('#compPreview');
  const saveBtn = get('#saveBtn');
  const saveStatus = get('#saveStatus');
  const syncBtn = get('#syncBtn');
  const syncStatus = get('#syncStatus');

  // Load layouts from server
  async function loadLayouts() {
    try {
      const response = await fetch(`${API_BASE}/practice/layouts`);
      if (!response.ok) throw new Error('Failed to load layouts');
      layouts = await response.json();
      render();
    } catch (error) {
      console.error('Error loading layouts:', error);
      layouts = [];
      render();
    }
  }

  // Load pages from server
  async function loadPages() {
    try {
      const response = await fetch(`${API_BASE}/practice/pages`);
      if (!response.ok) throw new Error('Failed to load pages');
      const pages = await response.json();
      
      pageSelect.innerHTML = '';
      pages.forEach(p => {
        pageSelect.appendChild(opt(p.name, `${p.name} (${p.componentCount})`));
      });
      
      if (pages.length > 0) {
        currentPage = pages[0].name;
        pageSelect.value = currentPage;
      }
    } catch (error) {
      console.error('Error loading pages:', error);
    }
  }

  // Sync with React Native app
  async function syncWithApp() {
    setSyncStatus('Syncing...', 'saving');
    syncBtn.disabled = true;

    try {
      console.log('Attempting to sync with:', `${API_BASE}/practice/sync`);
      
      const response = await fetch(`${API_BASE}/practice/sync`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({}), // Send empty object instead of empty body
        mode: 'cors'
      });

      console.log('Sync response status:', response.status);
      console.log('Sync response ok:', response.ok);

      if (!response.ok) {
        const errorText = await response.text();
        console.error('Sync response error:', errorText);
        throw new Error(`HTTP ${response.status}: ${errorText}`);
      }
      
      const result = await response.json();
      console.log('Sync result:', result);
      
      if (result.success) {
        if (result.changes && result.changes.length > 0) {
          // Reload layouts to get updated data
          await loadLayouts();
          setSyncStatus(`Synced ${result.changes.length} changes!`, 'saved');
        } else {
          setSyncStatus('No changes detected', 'saved');
        }
      } else {
        setSyncStatus(`Sync failed: ${result.message || 'Unknown error'}`, 'error');
      }
    } catch (error) {
      console.error('Error syncing with app:', error);
      setSyncStatus(`Sync failed: ${error.message}`, 'error');
    } finally {
      syncBtn.disabled = false;
    }
  }

  // Test sync function for debugging
  async function testSync() {
    setSyncStatus('Testing connection...', 'saving');
    
    try {
      // Test 1: Health endpoint
      console.log('Testing health endpoint...');
      const healthResponse = await fetch(`${API_BASE}/health`);
      console.log('Health response:', healthResponse.status, healthResponse.ok);
      
      // Test 2: Sync endpoint
      console.log('Testing sync endpoint...');
      const syncResponse = await fetch(`${API_BASE}/practice/sync`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({}), // Send empty object instead of empty body
        mode: 'cors'
      });
      console.log('Sync response:', syncResponse.status, syncResponse.ok);
      
      if (syncResponse.ok) {
        const result = await syncResponse.json();
        console.log('Sync test result:', result);
        setSyncStatus(`Test successful: ${result.message}`, 'saved');
      } else {
        const errorText = await syncResponse.text();
        setSyncStatus(`Test failed: HTTP ${syncResponse.status}`, 'error');
        console.error('Sync test error:', errorText);
      }
    } catch (error) {
      console.error('Test sync error:', error);
      setSyncStatus(`Test failed: ${error.message}`, 'error');
    }
  }

  // Auto-sync every 30 seconds
  function startAutoSync() {
    setInterval(async () => {
      try {
        const response = await fetch(`${API_BASE}/practice/sync`, { 
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({}), // Send empty object instead of empty body
          mode: 'cors'
        });
        
        if (response.ok) {
          const result = await response.json();
          if (result.success && result.changes && result.changes.length > 0) {
            console.log('Auto-sync detected changes:', result.changes.length);
            await loadLayouts();
            setSyncStatus(`Auto-sync: ${result.changes.length} changes`, 'saved');
          }
        } else {
          console.error('Auto-sync failed with status:', response.status);
        }
      } catch (error) {
        console.error('Auto-sync error:', error);
      }
    }, 30000); // 30 seconds
  }

  // Push layouts to React Native app
  async function pushToApp() {
    setAppStatus('Pushing to app...', 'saving');
    const pushBtn = get('#pushToAppBtn');
    pushBtn.disabled = true;

    try {
      const response = await fetch(`${API_BASE}/practice/push-to-app`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({}),
        mode: 'cors'
      });

      if (!response.ok) throw new Error('Failed to push to app');
      
      const result = await response.json();
      
      if (result.success) {
        setAppStatus('✅ App updated successfully!', 'saved');
        console.log('App update result:', result);
      } else {
        setAppStatus(`❌ App update failed: ${result.error}`, 'error');
        console.error('App update failed:', result);
      }
    } catch (error) {
      console.error('Error pushing to app:', error);
      setAppStatus(`❌ App update failed: ${error.message}`, 'error');
    } finally {
      pushBtn.disabled = false;
    }
  }

  // Save layouts to server
  async function saveToServer() {
    if (!hasUnsavedChanges) {
      setStatus('No changes to save', 'saved');
      return;
    }

    setStatus('Saving...', 'saving');
    saveBtn.disabled = true;

    try {
      const response = await fetch(`${API_BASE}/practice/layouts`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(layouts)
      });

      if (!response.ok) throw new Error('Failed to save layouts');
      
      const result = await response.json();
      setStatus('Saved successfully!', 'saved');
      hasUnsavedChanges = false;
      console.log('Save result:', result);
      
      // Automatically push to app after saving
      setAppStatus('Pushing changes to app...', 'saving');
      await pushToApp();
      
    } catch (error) {
      console.error('Error saving layouts:', error);
      setStatus('Save failed!', 'error');
    } finally {
      saveBtn.disabled = false;
    }
  }

  function setStatus(message, type) {
    saveStatus.textContent = message;
    saveStatus.className = `status ${type}`;
  }

  function setSyncStatus(message, type) {
    syncStatus.textContent = message;
    syncStatus.className = `status ${type}`;
  }

  function setAppStatus(message, type) {
    const appStatus = get('#appStatus');
    appStatus.textContent = message;
    appStatus.className = `status ${type}`;
  }
  
  // Toolbar Functions
  function duplicateComponent() {
    if (!selected) return;
    
    const original = selected;
    const duplicate = {
      ...original,
      id: original.id + '_copy',
      x: original.x + 20,
      y: original.y + 20
    };
    
    layouts.push(duplicate);
    render();
    setSel(duplicate.id);
    save();
  }
  
  function deleteComponent() {
    if (!selected) return;
    
    if (confirm(`Delete component "${selected.id}"?`)) {
      const index = layouts.findIndex(l => l.id === selected.id && l.page === selected.page);
      if (index > -1) {
        layouts.splice(index, 1);
        render();
        setSel(null);
        save();
      }
    }
  }
  
  function toggleLock() {
    if (!selected) return;
    
    selected.safe = !selected.safe;
    render();
    updateToolbarState();
    save();
  }
  
  function changeZIndex(direction) {
    if (!selected) return;
    
    const currentIndex = layouts.findIndex(l => l.id === selected.id && l.page === selected.page);
    if (currentIndex > -1) {
      const newIndex = Math.max(0, Math.min(layouts.length - 1, currentIndex + direction));
      const [moved] = layouts.splice(currentIndex, 1);
      layouts.splice(newIndex, 0, moved);
      render();
      setSel(selected.id, false);
      save();
    }
  }
  
  function alignComponent(alignment) {
    if (!selected) return;
    
    const canvasWidth = canvas.offsetWidth;
    const canvasHeight = canvas.offsetHeight;
    
    switch (alignment) {
      case 'left':
        selected.x = 20;
        break;
      case 'center':
        selected.x = (canvasWidth - selected.width) / 2;
        break;
      case 'right':
        selected.x = canvasWidth - selected.width - 20;
        break;
      case 'top':
        selected.y = 20;
        break;
      case 'middle':
        selected.y = (canvasHeight - selected.height) / 2;
        break;
      case 'bottom':
        selected.y = canvasHeight - selected.height - 20;
        break;
    }
    
    render();
    setSel(selected.id, false);
    save();
  }
  
  function openColorPicker() {
    if (!selected) return;
    
    const color = prompt('Enter color (hex, rgb, or name):', '#1c254d');
    if (color) {
      if (!selected.properties.style) selected.properties.style = {};
      selected.properties.style.backgroundColor = color;
      render();
      save();
    }
  }
  
  function toggleBorder() {
    if (!selected) return;
    
    if (!selected.properties.style) selected.properties.style = {};
    if (!selected.properties.style.border) {
      selected.properties.style.border = '2px solid #4a90e2';
    } else {
      delete selected.properties.style.border;
    }
    render();
    save();
  }
  
  function toggleShadow() {
    if (!selected) return;
    
    if (!selected.properties.style) selected.properties.style = {};
    if (!selected.properties.style.boxShadow) {
      selected.properties.style.boxShadow = '0 4px 12px rgba(0, 0, 0, 0.3)';
    } else {
      delete selected.properties.style.boxShadow;
    }
    render();
    save();
  }
  
  function toggleRounded() {
    if (!selected) return;
    
    if (!selected.properties.style) selected.properties.style = {};
    if (!selected.properties.style.borderRadius) {
      selected.properties.style.borderRadius = '12px';
    } else {
      delete selected.properties.style.borderRadius;
    }
    render();
    save();
  }
  
  function quickResize(size) {
    if (!selected) return;
    
    const sizes = {
      small: { width: 120, height: 80 },
      medium: { width: 200, height: 120 },
      large: { width: 300, height: 180 }
    };
    
    if (sizes[size]) {
      selected.width = sizes[size].width;
      selected.height = sizes[size].height;
      render();
      setSel(selected.id, false);
      save();
    }
  }
  
  function fitToContent() {
    if (!selected) return;
    
    // Estimate content size based on component type and properties
    const content = JSON.stringify(selected.properties);
    const estimatedWidth = Math.max(120, content.length * 6);
    const estimatedHeight = Math.max(60, content.split('\n').length * 20);
    
    selected.width = Math.min(estimatedWidth, canvas.offsetWidth - 40);
    selected.height = Math.min(estimatedHeight, canvas.offsetHeight - 40);
    
    render();
    setSel(selected.id, false);
    save();
  }
  
  function toggleToolbar() {
    const toolbar = get('#componentToolbar');
    const main = get('.main');
    const toggleBtn = get('#toggleToolbarBtn');
    
    if (toolbar.style.display === 'none') {
      toolbar.style.display = 'block';
      main.style.marginRight = '320px';
      toggleBtn.textContent = '🛠️ Hide';
      toggleBtn.title = 'Hide Component Toolbar';
    } else {
      toolbar.style.display = 'none';
      main.style.marginRight = '0';
      toggleBtn.textContent = '🛠️ Tools';
      toggleBtn.title = 'Show Component Toolbar';
    }
  }

  function applyZoom() {
    canvas.style.transform = `scale(${zoomLevel})`;
    canvas.style.transformOrigin = 'top left';
    canvas.style.width = `${375 * zoomLevel}px`;
    canvas.style.height = `${1200 * zoomLevel}px`;
  }

  function load(){ 
    try{ 
      const raw=localStorage.getItem(LS_KEY); 
      return raw? JSON.parse(raw): layouts; 
    }catch(e){ 
      return layouts; 
    } 
  }

  function save(){ 
    localStorage.setItem(LS_KEY, JSON.stringify(layouts)); 
    hasUnsavedChanges = true;
    setStatus('Unsaved changes', 'warn');
  }

  // Populate page dropdown
  pageSelect.onchange=()=>{ currentPage=pageSelect.value; selected=null; render(); };

  get('#gridSize').oninput = e=>{ snap = Math.max(2, parseInt(e.target.value,10)||8); render(); };
  get('#toggleGrid').onclick = ()=>{ canvas.classList.toggle('gridBg'); };
  get('#zoomIn').onclick = ()=>{ zoomLevel = Math.min(3, zoomLevel + 0.25); applyZoom(); };
  get('#zoomOut').onclick = ()=>{ zoomLevel = Math.max(0.25, zoomLevel - 0.25); applyZoom(); };
  get('#resetZoom').onclick = ()=>{ zoomLevel = 1; applyZoom(); };
  get('#syncBtn').onclick = syncWithApp;
  get('#testSyncBtn').onclick = testSync;
  get('#pushToAppBtn').onclick = pushToApp;
  get('#saveBtn').onclick = saveToServer;
  get('#applyBtn').onclick = applyInspector;
  
  // Toolbar button handlers
  get('#duplicateBtn').onclick = duplicateComponent;
  get('#deleteBtn').onclick = deleteComponent;
  get('#lockBtn').onclick = toggleLock;
  get('#bringFrontBtn').onclick = () => changeZIndex(1);
  get('#sendBackBtn').onclick = () => changeZIndex(-1);
  
  // Alignment buttons
  get('#alignLeftBtn').onclick = () => alignComponent('left');
  get('#alignCenterBtn').onclick = () => alignComponent('center');
  get('#alignRightBtn').onclick = () => alignComponent('right');
  get('#alignTopBtn').onclick = () => alignComponent('top');
  get('#alignMiddleBtn').onclick = () => alignComponent('middle');
  get('#alignBottomBtn').onclick = () => alignComponent('bottom');
  
  // Styling buttons
  get('#colorPickerBtn').onclick = openColorPicker;
  get('#borderBtn').onclick = toggleBorder;
  get('#shadowBtn').onclick = toggleShadow;
  get('#roundedBtn').onclick = toggleRounded;
  
  // Quick resize buttons
  get('#resizeSmallBtn').onclick = () => quickResize('small');
  get('#resizeMediumBtn').onclick = () => quickResize('medium');
  get('#resizeLargeBtn').onclick = () => quickResize('large');
  get('#fitContentBtn').onclick = fitToContent;
  
  // Toolbar toggle
  get('#toggleToolbarBtn').onclick = toggleToolbar;

  function render(){
    // List
    compList.innerHTML='';
    const pageLayouts = layouts.filter(l => l.page === currentPage);
    let safeCount=0; let total=pageLayouts.length;
    
    pageLayouts.forEach(c=>{
      const b = document.createElement('button');
      b.textContent = c.safe? c.id : `${c.id} (Locked)`;
      if(!c.safe) b.classList.add('locked');
      b.onclick = ()=>{ if(!c.safe) return; selected=c; fillInspector(c); focusComp(c.id); };
      compList.appendChild(b);
      if(c.safe) safeCount++;
    });
    
    lockLegend.className = 'badge '+(safeCount===total? 'ok' : (safeCount? 'warn':'err'));
    lockLegend.textContent = safeCount+'/'+total+' editable';

    // Canvas
    canvas.innerHTML='';
    pageLayouts.forEach(c=> canvas.appendChild(drawComp(c)) );

    // Inspector
    if(selected){ fillInspector(selected); } else { 
      riskBadge.className='badge warn'; 
      riskBadge.textContent='No selection'; 
      compPreview.innerHTML='—'; 
    }
  }

  function drawComp(c){
    const d = div('div','comp'); 
    d.id='C_'+c.id; 
    d.style.left=c.x+'px'; 
    d.style.top=c.y+'px'; 
    d.style.width=c.width+'px'; 
    d.style.height=c.height+'px'; 
    d.style.padding='8px'; 
    d.style.borderRadius='12px'; 
    d.style.background=gradient(c.safe ? '#1c254d' : '#3d2a2a');

    d.tabIndex=0; // focusable
    if(selected && selected.id===c.id) d.classList.add('sel');
    d.appendChild(div('div','title',c.id));
    const inner = div('div','',JSON.stringify(c.properties).substring(0, 30) + '...'); 
    inner.style.opacity='.9'; 
    d.appendChild(inner);
    
    // Add resize handles
    if(c.safe) {
      const handles = ['nw', 'ne', 'sw', 'se', 'n', 's', 'w', 'e'];
      handles.forEach(pos => {
        const handle = div('div', `resize-handle ${pos}`);
        handle.onmousedown = (e) => {
          e.stopPropagation();
          enableResize(d, c, pos);
        };
        d.appendChild(handle);
      });
    }
    
    if(c.safe) enableDrag(d,c);
    else d.title='Locked by safety scanner';
    
    d.onclick=()=>{ if(!c.safe) return; selected=c; fillInspector(c); setSel(c.id); };
    return d;
  }

  function enableDrag(node,c){
    let sx,sy,ox,oy; 
    node.onmousedown = (e)=>{ 
      if(e.button!==0 || e.target.classList.contains('resize-handle') || e.target.closest('.toolbar')) return; 
      sx=e.clientX; sy=e.clientY; ox=c.x; oy=c.y; 
      node.style.cursor = 'grabbing';
      e.preventDefault();
      e.stopPropagation();
      
      document.onmousemove = (ev)=>{ 
        const dx=ev.clientX-sx; const dy=ev.clientY-sy; 
        const newX = snapTo(ox+dx);
        const newY = snapTo(oy+dy);
        
        // Constrain to canvas bounds
        const maxX = canvas.offsetWidth - c.width;
        const maxY = canvas.offsetHeight - c.height;
        c.x = Math.max(0, Math.min(newX, maxX));
        c.y = Math.max(0, Math.min(newY, maxY));
        
        updateNode(node,c); 
        fillInspector(c,false); 
      }; 
      document.onmouseup = ()=>{ 
        document.onmousemove=null; document.onmouseup=null; 
        node.style.cursor = 'grab';
        save(); 
      } 
    };
  }

  function enableResize(node, c, handle) {
    let sx, sy, ox, oy, ow, oh;
    const startResize = (e) => {
      e.preventDefault();
      e.stopPropagation();
      sx = e.clientX;
      sy = e.clientY;
      ox = c.x;
      oy = c.y;
      ow = c.width;
      oh = c.height;
      
      document.onmousemove = (ev) => {
        const dx = ev.clientX - sx;
        const dy = ev.clientY - sy;
        
        // Handle different resize directions
        if (handle.includes('e')) {
          const newWidth = Math.max(64, snapTo(ow + dx));
          const maxWidth = canvas.offsetWidth - c.x;
          c.width = Math.min(newWidth, maxWidth);
        }
        if (handle.includes('w')) {
          const newWidth = Math.max(64, snapTo(ow - dx));
          const newX = ox + (ow - newWidth);
          if (newX >= 0) {
            c.x = newX;
            c.width = newWidth;
          }
        }
        if (handle.includes('s')) {
          const newHeight = Math.max(40, snapTo(oh + dy));
          const maxHeight = canvas.offsetHeight - c.y;
          c.height = Math.min(newHeight, maxHeight);
        }
        if (handle.includes('n')) {
          const newHeight = Math.max(40, snapTo(oh - dy));
          const newY = oy + (oh - newHeight);
          if (newY >= 0) {
            c.y = newY;
            c.height = newHeight;
          }
        }
        
        updateNode(node, c);
        fillInspector(c, false);
      };
      
      document.onmouseup = () => {
        document.onmousemove = null;
        document.onmouseup = null;
        save();
      };
    };
    
    return startResize;
  }

  function updateNode(node,c){ 
    node.style.left=c.x+'px'; 
    node.style.top=c.y+'px'; 
    node.style.width=c.width+'px'; 
    node.style.height=c.height+'px'; 
    node.style.background=gradient(c.safe ? '#1c254d' : '#3d2a2a');
    node.querySelector('.title').textContent=c.id; 
    node.lastChild.textContent=JSON.stringify(c.properties).substring(0, 30) + '...'; 
    
    // Apply custom styles from properties
    if (c.properties.style) {
      Object.assign(node.style, c.properties.style);
    }
    
    setSel(c.id,false); 
  }

  function setSel(id,scroll=true){ 
    document.querySelectorAll('.comp').forEach(n=> n.classList.toggle('sel', n.id==='C_'+id)); 
    if(scroll){ const el=document.getElementById('C_'+id); el?.scrollIntoView({block:'center'}); } 
    
    // Show/hide toolbar based on selection (only if toolbar is enabled)
    const toolbar = get('#componentToolbar');
    const main = get('.main');
    if (id && toolbar.style.display !== 'none') {
      updateToolbarState();
    }
  }
  
  function updateToolbarState() {
    if (!selected) return;
    
    const c = selected;
    const isLocked = !c.safe;
    
    // Update lock button
    get('#lockBtn').textContent = isLocked ? '🔓' : '🔒';
    get('#lockBtn').title = isLocked ? 'Unlock Component' : 'Lock Component';
    
    // Enable/disable buttons based on component state
    const editableButtons = ['duplicateBtn', 'deleteBtn', 'bringFrontBtn', 'sendBackBtn', 
                           'alignLeftBtn', 'alignCenterBtn', 'alignRightBtn', 'alignTopBtn', 
                           'alignMiddleBtn', 'alignBottomBtn', 'colorPickerBtn', 'borderBtn', 
                           'shadowBtn', 'roundedBtn', 'resizeSmallBtn', 'resizeMediumBtn', 
                           'resizeLargeBtn', 'fitContentBtn'];
    
    editableButtons.forEach(btnId => {
      const btn = get('#' + btnId);
      if (isLocked) {
        btn.classList.add('disabled');
        btn.disabled = true;
      } else {
        btn.classList.remove('disabled');
        btn.disabled = false;
      }
    });
  }

  // Inspector
  function fillInspector(c,updatePreview=true){ 
    riskBadge.className='badge '+(c.safe?'ok':'err'); 
    riskBadge.textContent = c.safe? 'Editable' : 'Locked'; 
    
    set('#inpId', c.id);
    set('#inpPage', c.page);
    set('#inpW', c.width); 
    set('#inpH', c.height); 
    set('#inpX', c.x); 
    set('#inpY', c.y); 
    set('#inpProps', JSON.stringify(c.properties, null, 2)); 
    
    if(updatePreview) compPreview.innerHTML = renderPreviewHTML(c); 
  }

  function applyInspector(){ 
    if(!selected) return; 
    const c=selected; 
    
    c.width = num('#inpW',c.width); 
    c.height = num('#inpH',c.height); 
    c.x = snapTo(num('#inpX',c.x)); 
    c.y = snapTo(num('#inpY',c.y)); 
    
    try {
      c.properties = JSON.parse(get('#inpProps').value || '{}');
    } catch (e) {
      alert('Invalid JSON in properties field');
      return;
    }
    
    const node=document.getElementById('C_'+c.id); 
    if(node) updateNode(node,c); 
    compPreview.innerHTML = renderPreviewHTML(c); 
    save(); 
  }

  function renderPreviewHTML(c){ 
    // Create more realistic component previews based on component type
    let previewContent = '';
    
    switch(c.id) {
      case 'TransparentTopBar':
        previewContent = `<div style="background:linear-gradient(90deg,#1f6feb,#3b82f6);color:white;padding:12px;border-radius:8px;text-align:center;font-weight:600">${c.properties.title || 'Header'}</div>`;
        break;
      case 'PracticeCategoryCarousel':
        previewContent = `<div style="background:linear-gradient(135deg,#8b5cf6,#a855f7);color:white;padding:16px;border-radius:12px;text-align:center">
          <div style="font-size:18px;font-weight:700;margin-bottom:8px">📚</div>
          <div style="font-size:14px;font-weight:600">Practice Categories</div>
        </div>`;
        break;
      case 'WeeklyStreakCard':
        previewContent = `<div style="background:linear-gradient(135deg,#10b981,#34d399);color:white;padding:16px;border-radius:12px;text-align:center">
          <div style="font-size:18px;font-weight:700;margin-bottom:8px">🔥 ${c.properties.streak || 7} Day Streak</div>
          <div style="font-size:12px">${c.properties.xp || 1250} XP</div>
        </div>`;
        break;
      case 'JourneyFlashcards':
        previewContent = `<div style="background:linear-gradient(135deg,#f59e0b,#fbbf24);color:white;padding:16px;border-radius:12px;text-align:center">
          <div style="font-size:18px;font-weight:700;margin-bottom:8px">🎯</div>
          <div style="font-size:14px;font-weight:600">Learning Journey</div>
        </div>`;
        break;
      case 'BottomNavigationBar':
        previewContent = `<div style="background:#1f2937;color:white;padding:12px;border-radius:8px;text-align:center;font-size:12px">
          <div style="display:flex;justify-content:space-around">
            <div>🏠</div><div>📊</div><div>🛒</div><div>👤</div>
          </div>
        </div>`;
        break;
      case 'StatTile':
        const statColor = c.properties.color || 'purple';
        const colorMap = {
          'gold': 'linear-gradient(135deg,#fbbf24,#f59e0b)',
          'blue': 'linear-gradient(135deg,#3b82f6,#1d4ed8)',
          'teal': 'linear-gradient(135deg,#14b8a6,#0d9488)',
          'pink': 'linear-gradient(135deg,#ec4899,#be185d)',
          'purple': 'linear-gradient(135deg,#8b5cf6,#7c3aed)'
        };
        previewContent = `<div style="background:${colorMap[statColor] || colorMap.purple};color:white;padding:16px;border-radius:12px;text-align:center;border:2px solid rgba(255,255,255,0.2)">
          <div style="font-size:20px;margin-bottom:8px">${c.properties.icon || '📊'}</div>
          <div style="font-size:14px;font-weight:600">${c.properties.label || 'Stat'}</div>
          <div style="font-size:18px;font-weight:800">${c.properties.value || '0'}</div>
        </div>`;
        break;
      case 'SectionHeader':
        previewContent = `<div style="background:linear-gradient(135deg,#1f2937,#374151);color:white;padding:16px;border-radius:12px;text-align:center">
          <div style="font-size:18px;font-weight:700;margin-bottom:4px">${c.properties.title || 'Section'}</div>
          <div style="font-size:12px;opacity:0.8">${c.properties.subtitle || 'Description'}</div>
        </div>`;
        break;
      case 'PremiumInsightCard':
        previewContent = `<div style="background:linear-gradient(135deg,#374151,#4b5563);color:white;padding:16px;border-radius:12px;text-align:center;border:2px solid #fbbf24;position:relative">
          <div style="position:absolute;top:8px;right:8px;font-size:16px">🔒</div>
          <div style="font-size:24px;margin-bottom:8px">${c.properties.icon || '💡'}</div>
          <div style="font-size:14px;font-weight:700;margin-bottom:4px">${c.properties.title || 'Premium'}</div>
          <div style="font-size:10px;opacity:0.8">${c.properties.description || 'Locked feature'}</div>
        </div>`;
        break;
      case 'UnlockButton':
        previewContent = `<div style="background:linear-gradient(90deg,#fbbf24,#8b5cf6);color:white;padding:16px;border-radius:12px;text-align:center;font-weight:700;display:flex;align-items:center;justify-content:center;gap:8px">
          <span>🔒</span>
          <span>${c.properties.text || 'Unlock Premium'}</span>
        </div>`;
        break;
      case 'PremiumFeatureCard':
        previewContent = `<div style="background:linear-gradient(135deg,#374151,#4b5563);color:white;padding:16px;border-radius:12px;text-align:center;border:2px solid #3b82f6;position:relative">
          <div style="position:absolute;top:8px;right:8px;font-size:16px">🔒</div>
          <div style="font-size:24px;margin-bottom:8px">${c.properties.icon || '💡'}</div>
          <div style="font-size:14px;font-weight:700;margin-bottom:4px">${c.properties.title || 'Premium Feature'}</div>
          <div style="font-size:10px;opacity:0.8">${c.properties.description || 'Locked feature'}</div>
          <div style="font-size:12px;color:#3b82f6;font-weight:600">${c.properties.price || 0} 💎</div>
        </div>`;
        break;
      case 'AchievementCard':
        const unlocked = c.properties.unlocked;
        previewContent = `<div style="background:${unlocked ? 'linear-gradient(135deg,#10b981,#34d399)' : 'linear-gradient(135deg,#374151,#4b5563)'};color:white;padding:16px;border-radius:12px;text-align:center;border:2px solid ${unlocked ? '#10b981' : '#6b7280'};position:relative">
          <div style="font-size:24px;margin-bottom:8px">${c.properties.icon || '🏆'}</div>
          <div style="font-size:14px;font-weight:700;margin-bottom:4px">${c.properties.title || 'Achievement'}</div>
          <div style="font-size:10px;opacity:0.8">${c.properties.description || 'Achievement description'}</div>
          ${unlocked ? '<div style="position:absolute;top:8px;right:8px;font-size:16px">✅</div>' : '<div style="position:absolute;top:8px;right:8px;font-size:16px">🔒</div>'}
        </div>`;
        break;
      case 'ShopItem':
        previewContent = `<div style="background:linear-gradient(135deg,#059669,#10b981);color:white;padding:16px;border-radius:12px;text-align:center">
          <div style="font-size:24px;margin-bottom:8px">${c.properties.icon || '🛍️'}</div>
          <div style="font-size:14px;font-weight:600">${c.properties.name || 'Item'}</div>
          <div style="font-size:12px">${c.properties.price || 0} 💎</div>
        </div>`;
        break;
      default:
        previewContent = `<div style="font-weight:700">${c.id}</div>
        <div style="opacity:.85;font-size:10px">${JSON.stringify(c.properties).substring(0, 20)}...</div>`;
    }
    
    return `<div style="width:${c.width}px;height:${c.height}px;background:${gradient(c.safe ? '#1c254d' : '#3d2a2a')};border-radius:12px;padding:8px;display:grid;place-items:center;border:1px solid rgba(255,255,255,.12)">
      ${previewContent}
    </div>`; 
  }

  // Utils
  function get(sel){return document.querySelector(sel)}
  function set(sel,val){ const n=get(sel); if(n) n.value = val }
  function val(sel,fallback){ const n=get(sel); return n && n.value!==''? n.value : fallback }
  function num(sel,fallback){ const n=get(sel); const v=parseInt(n.value,10); return isFinite(v)? v : fallback }

  function div(tag,cls,txt){ const n=document.createElement(tag); if(cls) n.className=cls; if(txt!=null) n.textContent=txt; return n }
  function opt(v,t){ const o=document.createElement('option'); o.value=v;o.textContent=t; return o }

  function snapTo(v){ return Math.max(0, Math.round(v/ snap)*snap) }
  function gradient(base){ return `linear-gradient(180deg, ${shade(base,10)}, ${shade(base,-10)})`; }

  function shade(hex, amt){ 
    let c=hex.replace('#',''); 
    if(c.length===3) c=c.split('').map(h=>h+h).join(''); 
    const num=parseInt(c,16); 
    let r=(num>>16)+amt, g=((num>>8)&0xff)+amt, b=(num&0xff)+amt; 
    r=Math.max(0,Math.min(255,r)); g=Math.max(0,Math.min(255,g)); b=Math.max(0,Math.min(255,b)); 
    return `#${(r<<16|g<<8|b).toString(16).padStart(6,'0')}` 
  }

  // Initialize
  loadPages().then(() => {
    loadLayouts();
    startAutoSync(); // Start auto-sync with React Native app
    
    // Test backend connectivity
    fetch(`${API_BASE}/health`)
      .then(response => {
        console.log('Backend connectivity test:', response.ok ? 'SUCCESS' : 'FAILED');
        if (!response.ok) {
          setSyncStatus('Backend connection failed', 'error');
        }
      })
      .catch(error => {
        console.error('Backend connectivity test failed:', error);
        setSyncStatus('Backend connection failed', 'error');
      });
    
    // Setup keyboard shortcuts
    setupKeyboardShortcuts();
    
    // Initialize toolbar to hidden state
    const toolbar = get('#componentToolbar');
    const main = get('.main');
    toolbar.style.display = 'none';
    main.style.marginRight = '0';
  });
  
  // Keyboard shortcuts
  function setupKeyboardShortcuts() {
    document.addEventListener('keydown', (e) => {
      if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
      
      switch (e.key) {
        case 'Delete':
        case 'Backspace':
          if (selected) deleteComponent();
          break;
        case 'd':
          if (e.ctrlKey || e.metaKey) {
            e.preventDefault();
            if (selected) duplicateComponent();
          }
          break;
        case 'l':
          if (e.ctrlKey || e.metaKey) {
            e.preventDefault();
            if (selected) toggleLock();
          }
          break;
        case 'Escape':
          setSel(null);
          break;
        case 'ArrowLeft':
          if (selected && e.ctrlKey) {
            e.preventDefault();
            alignComponent('left');
          }
          break;
        case 'ArrowRight':
          if (selected && e.ctrlKey) {
            e.preventDefault();
            alignComponent('right');
          }
          break;
        case 'ArrowUp':
          if (selected && e.ctrlKey) {
            e.preventDefault();
            alignComponent('top');
          }
          break;
        case 'ArrowDown':
          if (selected && e.ctrlKey) {
            e.preventDefault();
            alignComponent('bottom');
          }
          break;
      }
    });
  }
})();
</script>
</body>
</html>
