// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ===== Enums =====

enum MissionStatus {
  IN_PROGRESS
  SUCCESS
  FAIL
  ABORTED
}

enum MessageRole {
  USER
  AI
  SYSTEM
}

enum MessageGrade {
  BRILLIANT
  GOOD
  NEUTRAL
  WEAK
  BAD
}

// ===== Core User / Auth =====

model User {
  id                 String    @id @default(cuid())
  email              String    @unique
  createdAt          DateTime  @default(now())
  sessionVersion     Int       @default(0)
  streakCurrent      Int       @default(0)
  streakLastActiveAt DateTime?
  passwordHash       String

  // Practice sessions
  sessions PracticeSession[]

  // Wallet & stats
  wallet UserWallet?
  stats  UserStats?

  // Messages
  messages ChatMessage[]

  // Power-ups
  powerUpUsages PowerUpUsage[]

  // Refresh tokens
  refreshTokens RefreshToken[]
}

model IdempotencyKey {
  id           String   @id @default(cuid())
  key          String
  userId       String
  route        String
  bodyHash     String
  status       Int
  responseJson String
  createdAt    DateTime @default(now())
  expiresAt    DateTime

  @@unique([key, userId, route])
}

model RefreshToken {
  id        String   @id @default(cuid())
  userId    String
  tokenHash String
  expiresAt DateTime
  createdAt DateTime @default(now())
  revoked   Boolean  @default(false)

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, expiresAt, revoked])
}

// ===== Reference tables (static-ish configuration) =====

// AI personas (characters)
model AiPersona {
  id          String   @id @default(cuid())
  name        String
  shortLabel  String? // e.g. "Shy Student"
  description String?
  style       String? // tone / vibe
  avatarUrl   String?
  difficulty  Int? // 1–5
  active      Boolean  @default(true)
  createdAt   DateTime @default(now())

  sessions PracticeSession[]
}

// Mission templates (types of trainings)
model PracticeMissionTemplate {
  id           String   @id @default(cuid())
  code         String   @unique // e.g. "FIRST_MESSAGE_APP"
  title        String
  description  String?
  category     String? // e.g. "DATING"
  difficulty   Int? // 1–5
  timeLimitSec Int? // optional
  maxMessages  Int? // optional
  active       Boolean  @default(true)
  createdAt    DateTime @default(now())

  sessions PracticeSession[]
}

// Power-up catalog (e.g. Lifesaver)
model PowerUpType {
  id                String   @id @default(cuid())
  code              String   @unique // e.g. "LIFESAVER"
  name              String
  description       String?
  gemCost           Int
  maxUsesPerSession Int?
  active            Boolean  @default(true)
  createdAt         DateTime @default(now())

  usages PowerUpUsage[]
}

// ===== Dynamic / user gameplay data =====

model PracticeSession {
  id        String   @id @default(cuid())
  userId    String
  createdAt DateTime @default(now())
  topic     String

  // Final session score
  score Int @default(0)

  // Aggregate rewards stored for history
  xpGained    Int @default(0)
  coinsGained Int @default(0)
  gemsGained  Int @default(0)

  // Meta about the conversation
  messageCount Int     @default(0)
  rarityCounts Json?
  payload      Json?
  durationSec  Int     @default(0)
  notes        String?

  // Grand plan fields
  status       MissionStatus @default(IN_PROGRESS)
  templateId   String?
  personaId    String?
  overallScore Int?
  endedAt      DateTime?
  isSuccess    Boolean?

  user     User                     @relation(fields: [userId], references: [id], onDelete: Cascade)
  template PracticeMissionTemplate? @relation(fields: [templateId], references: [id])
  persona  AiPersona?               @relation(fields: [personaId], references: [id])
  messages ChatMessage[]
  powerUps PowerUpUsage[]

  @@index([userId, createdAt])
  @@index([templateId])
  @@index([personaId])
}

// Individual chat messages inside a session
model ChatMessage {
  id        String      @id @default(cuid())
  sessionId String
  userId    String
  createdAt DateTime    @default(now())
  role      MessageRole
  content   String

  // Per-message feedback
  grade       MessageGrade?
  xpDelta     Int           @default(0)
  coinsDelta  Int           @default(0)
  gemsDelta   Int           @default(0)
  isBrilliant Boolean       @default(false)
  isLifesaver Boolean       @default(false)
  meta        Json?

  session PracticeSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  user    User            @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([sessionId, createdAt])
}

// Wallet = XP, coins, gems, level
model UserWallet {
  userId     String   @id
  xp         Int      @default(0)
  level      Int      @default(1)
  coins      Int      @default(0)
  gems       Int      @default(0)
  lifetimeXp Int      @default(0)
  updatedAt  DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// Aggregated stats for dashboard
model UserStats {
  userId              String    @id
  sessionsCount       Int       @default(0)
  successCount        Int       @default(0)
  failCount           Int       @default(0)
  averageScore        Float?
  averageMessageScore Float?
  lastSessionAt       DateTime?
  lastUpdatedAt       DateTime  @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// Logged power-up usages per session
model PowerUpUsage {
  id            String   @id @default(cuid())
  userId        String
  sessionId     String?
  powerUpTypeId String
  usedAt        DateTime @default(now())
  gemsSpent     Int      @default(0)
  meta          Json?

  user        User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  session     PracticeSession? @relation(fields: [sessionId], references: [id], onDelete: SetNull)
  powerUpType PowerUpType      @relation(fields: [powerUpTypeId], references: [id], onDelete: Restrict)

  @@index([userId, usedAt])
  @@index([sessionId])
  @@index([powerUpTypeId])
}
