generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                         String                 @id @default(cuid())
  email                      String                 @unique
  createdAt                  DateTime               @default(now())
  sessionVersion             Int                    @default(0)
  streakCurrent              Int                    @default(0)
  streakLastActiveAt         DateTime?
  passwordHash               String
  tier                       AccountTier            @default(FREE)
  attractedTo                AttractionPreference   @default(UNKNOWN)
  /// 6B – Onboarding / Preference fields
  gender                     Gender                 @default(UNKNOWN)
  preferencePath             PreferencePath         @default(UNKNOWN_PATH)
  allowLeaderboardVisibility Boolean                @default(true)
  avatarId                   String?
  avatarType                 AvatarType             @default(DEFAULT)
  avatarUrl                  String?
  commitmentLevel            CommitmentLevel?
  countryCode                String?
  dailyEffortMinutes         Int?
  displayName                String?
  interestTags               String[]               @default([])
  mainGoal                   MainGoal?
  notificationsEnabled       Boolean                @default(false)
  onboardingCompleted        Boolean                @default(false)
  onboardingCompletedAt      DateTime?
  onboardingStep             Int                    @default(0)
  onboardingVersion          String?
  preferredReminderTime      String?
  preferredStyles            String[]               @default([])
  profileCompleted           Boolean                @default(false)
  profileCompletedAt         DateTime?
  profileTags                String[]               @default([])
  selfRatedLevel             Int?
  wantsHarshFeedback         Boolean?
  badgeLedger                BadgeLedgerEntry[]
  burnedMessages             BurnedMessage[]
  categoryStats              CategoryStats[]
  messages                   ChatMessage[]
  gateOutcomes               GateOutcome[]
  hallOfFameMessages         HallOfFameMessage[]
  deepInsights               MissionDeepInsights[]
  moodTimelines              MissionMoodTimeline[]
  missionProgress            MissionProgress[]
  personaMemories            PersonaMemory[]
  powerUpUsages              PowerUpUsage[]
  sessions                   PracticeSession[]
  promptHookTriggers         PromptHookTrigger[]
  refreshTokens              RefreshToken[]
  rewardLedger               RewardLedgerEntry[]
  traitSynergy               SessionTraitSynergy[]
  badgeEvents                UserBadgeEvent[]
  badgeProgress              UserBadgeProgress[]
  categoryProgress           UserCategoryProgress[]
  onboardingState            UserOnboardingState?
  stats                      UserStats?
  traitHistory               UserTraitHistory[]
  traitScores                UserTraitScores?
  wallet                     UserWallet?
}

model IdempotencyKey {
  id           String   @id @default(cuid())
  key          String
  userId       String
  route        String
  bodyHash     String
  status       Int
  responseJson String
  createdAt    DateTime @default(now())
  expiresAt    DateTime

  @@unique([key, userId, route])
}

/// ✅ Rewards ledger entry (prevents double-award)
model RewardLedgerEntry {
  id         String           @id @default(cuid())
  userId     String
  sessionId  String
  templateId String?
  kind       RewardLedgerKind @default(SESSION_REWARD)
  xpDelta    Int              @default(0)
  coinsDelta Int              @default(0)
  gemsDelta  Int              @default(0)
  score      Int?
  isSuccess  Boolean?
  meta       Json?
  createdAt  DateTime         @default(now())
  session    PracticeSession  @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  user       User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([sessionId, kind])
  @@index([userId, createdAt])
  @@index([templateId])
}

model RefreshToken {
  id        String   @id @default(cuid())
  userId    String
  tokenHash String
  expiresAt DateTime
  createdAt DateTime @default(now())
  revoked   Boolean  @default(false)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, expiresAt, revoked])
}

/// --------------------------------------
/// AI Personas – characters for missions
/// --------------------------------------
model AiPersona {
  id               String                    @id @default(cuid())
  name             String
  shortLabel       String?
  description      String?
  style            String?
  avatarUrl        String?
  difficulty       Int?
  active           Boolean                   @default(true)
  createdAt        DateTime                  @default(now())
  code             String                    @unique
  voicePreset      String?
  personaGender    Gender                    @default(UNKNOWN)
  memories         PersonaMemory[]
  missionTemplates PracticeMissionTemplate[]
  sessions         PracticeSession[]
}

/// --------------------------------------
/// Mission categories (Openers, Flirting…)
/// --------------------------------------
model MissionCategory {
  id                    String                    @id @default(cuid())
  code                  String                    @unique
  label                 String
  description           String?
  isAttractionSensitive Boolean                   @default(false)
  dynamicLabelTemplate  String?
  attractionPath        AttractionPath            @default(UNISEX)
  displayOrder          Int                       @default(0)
  iconUrl               String?
  active                Boolean                   @default(true)
  categoryStats         CategoryStats[]
  templates             PracticeMissionTemplate[]
  categoryProgress      UserCategoryProgress[]
}

/// --------------------------------------
/// AI Styles – stable mapped "moods"
/// --------------------------------------
model AiStyle {
  id                String                    @id @default(cuid())
  key               AiStyleKey                @unique
  name              String
  description       String
  tags              String[]                  @default([])
  stylePrompt       String
  forbiddenBehavior String
  fewShotExamples   Json?
  maxChars          Int
  maxLines          Int
  questionRate      Int
  emojiRate         Int
  initiative        Int
  warmth            Int
  judgment          Int
  flirtTension      Int
  formality         Int
  temperature       Float?
  topP              Float?
  isActive          Boolean                   @default(true)
  createdAt         DateTime                  @default(now())
  updatedAt         DateTime                  @updatedAt
  missions          PracticeMissionTemplate[]
}

/// --------------------------------------
/// Mission template = "practice mission definition"
/// --------------------------------------
model PracticeMissionTemplate {
  id                    String             @id @default(cuid())
  code                  String             @unique
  title                 String
  description           String?
  timeLimitSec          Int                @default(30)
  maxMessages           Int?
  active                Boolean            @default(true)
  createdAt             DateTime           @default(now())
  baseCoinsReward       Int                @default(10)
  baseGemsReward        Int                @default(0)
  baseXpReward          Int                @default(50)
  categoryId            String?
  goalType              MissionGoalType?
  isVoiceSupported      Boolean            @default(true)
  laneIndex             Int                @default(0)
  orderIndex            Int                @default(0)
  personaId             String?
  wordLimit             Int?
  difficulty            MissionDifficulty  @default(EASY)
  aiContract            Json?
  aiStyleId             String?
  isAttractionSensitive Boolean            @default(false)
  targetRomanticGender  Gender?
  moodConfigs           MissionMoodConfig?
  progress              MissionProgress[]
  aiStyle               AiStyle?           @relation(fields: [aiStyleId], references: [id])
  category              MissionCategory?   @relation(fields: [categoryId], references: [id])
  persona               AiPersona?         @relation(fields: [personaId], references: [id])
  sessions              PracticeSession[]

  @@index([aiStyleId])
}

model PowerUpType {
  id                String         @id @default(cuid())
  code              String         @unique
  name              String
  description       String?
  gemCost           Int
  maxUsesPerSession Int?
  active            Boolean        @default(true)
  createdAt         DateTime       @default(now())
  usages            PowerUpUsage[]
}

model PracticeSession {
  id                 String                   @id @default(cuid())
  userId             String
  createdAt          DateTime                 @default(now())
  topic              String
  score              Int                      @default(0)
  xpGained           Int                      @default(0)
  durationSec        Int                      @default(0)
  notes              String?
  endedAt            DateTime?
  overallScore       Int?
  personaId          String?
  status             MissionStatus            @default(IN_PROGRESS)
  templateId         String?
  coinsGained        Int                      @default(0)
  gemsGained         Int                      @default(0)
  isSuccess          Boolean?
  messageCount       Int                      @default(0)
  payload            Json?
  rarityCounts       Json?
  aiMode             String?
  aiSummary          Json?
  aiCorePayload      Json?
  aiCoreVersion      String?
  /// --------------------------------------
  /// ⭐ Option B – Core AI Metrics (B4)
  /// --------------------------------------
  charismaIndex      Int?
  clarityScore       Int?
  confidenceScore    Int?
  dominanceScore     Int?
  emotionalWarmth    Int?
  fillerWordsCount   Int?
  humorScore         Int?
  tensionScore       Int?
  totalMessages      Int?
  totalWords         Int?
  /// --------------------------------------
  /// ✅ Step 5.1 – End reason fields
  /// --------------------------------------
  endReasonCode      String?
  endReasonMeta      Json?
  /// Phase 4: Final session-level checklist aggregates
  checklistAggregates Json?
  /// --------------------------------------
  /// ✅ Phase 1 – Two-Lane AI Engine
  /// --------------------------------------
  engineVersionId          String?
  chatRuntimeProfileKey    String?
  scoringRuntimeProfileKey String?
  insightsRuntimeProfileKey String?
  currentMoodState         String?
  badgeLedger        BadgeLedgerEntry[]
  messages           ChatMessage[]
  gateOutcomes       GateOutcome[]
  hallOfFameMessages HallOfFameMessage[]
  deepInsights       MissionDeepInsights?
  moodTimeline       MissionMoodTimeline?
  powerUps           PowerUpUsage[]
  persona            AiPersona?               @relation(fields: [personaId], references: [id])
  template           PracticeMissionTemplate? @relation(fields: [templateId], references: [id])
  user               User                     @relation(fields: [userId], references: [id], onDelete: Cascade)
  promptHookTriggers PromptHookTrigger[]
  rewardLedger       RewardLedgerEntry[]
  traitSynergy       SessionTraitSynergy?
  badgeEvents        UserBadgeEvent[]
  traitHistory       UserTraitHistory?

  @@index([userId, createdAt])
  @@index([templateId])
  @@index([personaId])
}

model ChatMessage {
  id                String              @id @default(cuid())
  sessionId         String
  userId            String
  createdAt         DateTime            @default(now())
  role              MessageRole
  content           String
  grade             MessageGrade?
  xpDelta           Int                 @default(0)
  coinsDelta        Int                 @default(0)
  gemsDelta         Int                 @default(0)
  isBrilliant       Boolean             @default(false)
  isLifesaver       Boolean             @default(false)
  meta              Json?
  score             Int?
  traitData         Json
  /// --------------------------------------
  /// ✅ Step 5.1 – Deterministic ordering + normalized scoring
  /// --------------------------------------
  /// Phase 4: Checklist-native fields
  tier              String?  // 'S+' | 'S' | 'A' | 'B' | 'C' | 'D'
  checklistFlags    Json?    // Array of MessageChecklistFlag strings
  turnIndex         Int
  /// --------------------------------------
  /// ✅ Phase 1 – Two-Lane AI Engine
  /// --------------------------------------
  scoringSnapshot       Json?
  moodStateAfterMessage String?
  latencyMs             Int?
  burnedEntries     BurnedMessage[]
  session           PracticeSession     @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  user              User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  hallOfFameEntries HallOfFameMessage[]

  @@unique([sessionId, turnIndex])
  @@index([sessionId, createdAt])
  @@index([userId, createdAt])
}

model UserWallet {
  userId     String   @id
  xp         Int      @default(0)
  level      Int      @default(1)
  coins      Int      @default(0)
  gems       Int      @default(0)
  lifetimeXp Int      @default(0)
  updatedAt  DateTime @updatedAt
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model UserStats {
  userId              String    @id
  sessionsCount       Int       @default(0)
  successCount        Int       @default(0)
  failCount           Int       @default(0)
  averageScore        Float?
  averageMessageScore Float?
  lastSessionAt       DateTime?
  lastUpdatedAt       DateTime  @updatedAt
  /// Phase 4: Checklist aggregates (authoritative JSON snapshot)
  checklistAggregates Json?
  user                User      @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model PowerUpUsage {
  id            String           @id @default(cuid())
  userId        String
  sessionId     String?
  powerUpTypeId String
  usedAt        DateTime         @default(now())
  gemsSpent     Int              @default(0)
  meta          Json?
  powerUpType   PowerUpType      @relation(fields: [powerUpTypeId], references: [id])
  session       PracticeSession? @relation(fields: [sessionId], references: [id])
  user          User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, usedAt])
  @@index([sessionId])
  @@index([powerUpTypeId])
}

/// --------------------------------------
/// Mission progress per user
/// --------------------------------------
model MissionProgress {
  id         String                  @id @default(cuid())
  userId     String
  templateId String
  status     MissionProgressStatus   @default(LOCKED)
  bestScore  Int?
  createdAt  DateTime                @default(now())
  updatedAt  DateTime                @updatedAt
  template   PracticeMissionTemplate @relation(fields: [templateId], references: [id])
  user       User                    @relation(fields: [userId], references: [id])

  @@unique([userId, templateId])
}

/// --------------------------------------
/// Step 5.14: Persona Memory
/// --------------------------------------
model PersonaMemory {
  id          String    @id @default(cuid())
  userId      String
  personaId   String
  memoryKey   String
  memoryValue Json
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  persona     AiPersona @relation(fields: [personaId], references: [id], onDelete: Cascade)
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, personaId, memoryKey])
  @@index([userId, personaId])
  @@index([personaId, updatedAt])
}

/// --------------------------------------
/// Step 5.14: Category Statistics (per-user, per-category)
/// --------------------------------------
model CategoryStats {
  id            String          @id @default(cuid())
  userId        String
  categoryId    String
  categoryKey   String
  avgScore      Float?
  sessionsCount Int             @default(0)
  successCount  Int             @default(0)
  failCount     Int             @default(0)
  updatedAt     DateTime        @updatedAt
  createdAt     DateTime        @default(now())
  /// Phase 4: Checklist aggregates per category (authoritative JSON snapshot)
  checklistAggregates Json?
  category      MissionCategory @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  user          User            @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, categoryId])
  @@index([userId, categoryKey])
  @@index([categoryKey, updatedAt])
}

/// --------------------------------------
/// Step 5.14: User Category Progress (category completion tracking)
/// --------------------------------------
model UserCategoryProgress {
  id          String                @id @default(cuid())
  userId      String
  categoryId  String
  status      MissionProgressStatus @default(LOCKED)
  completedAt DateTime?
  updatedAt   DateTime              @updatedAt
  createdAt   DateTime              @default(now())
  category    MissionCategory       @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  user        User                  @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, categoryId])
  @@index([userId, status])
  @@index([categoryId, completedAt])
}

/// --------------------------------------
/// Phase 0: Deep Insights
/// --------------------------------------
model MissionDeepInsights {
  id                   String          @id @default(cuid())
  sessionId            String          @unique
  userId               String
  missionId            String
  createdAt            DateTime        @default(now())
  version              String          @default("v1")
  insightsJson         Json
  averageRarityTier    String
  primaryLabels        String[]        @default([])
  overallCharismaIndex Int?
  session              PracticeSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  user                 User            @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
  @@index([missionId])
  @@index([averageRarityTier])
}

/// --------------------------------------
/// Patch A: Custom Insight Templates (DB-backed, admin-managed)
/// --------------------------------------
model CustomInsightTemplate {
  id            String   @id @default(cuid())
  key           String   @unique // Unique identifier (e.g., 'custom_tip_1')
  kind          String   // InsightKind: 'GATE_FAIL' | 'POSITIVE_HOOK' | 'NEGATIVE_PATTERN' | 'GENERAL_TIP' | 'MOOD' | 'SYNERGY' | 'ANALYZER_PARAGRAPH'
  category      String   @default("general")
  title         String
  body          String
  weight        Int      @default(50) // For weighted selection
  cooldownMissions Int   @default(3)
  tags          String[] @default([])
  requiresJson  Json?   // Optional: { gateKey?, hookKey?, patternKey? }
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([kind])
  @@index([category])
}

/// --------------------------------------
/// Phase 0: Mission Mood Timeline
/// --------------------------------------
model MissionMoodTimeline {
  id                 String          @id @default(cuid())
  sessionId          String          @unique
  userId             String
  missionId          String
  createdAt          DateTime        @default(now())
  updatedAt          DateTime        @updatedAt
  version            String          @default("v1")
  timelineJson       Json
  currentMoodState   String
  currentMoodPercent Int
  session            PracticeSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  user               User            @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
  @@index([missionId])
  @@index([currentMoodState])
}

/// --------------------------------------
/// Phase 0: Mission Mood Config
/// --------------------------------------
model MissionMoodConfig {
  id          String                  @id @default(cuid())
  missionId   String                  @unique
  version     String                  @default("v1")
  createdAt   DateTime                @default(now())
  updatedAt   DateTime                @updatedAt
  configJson  Json
  windowSize  Int
  positiveMin Int
  neutralMin  Int
  negativeMin Int
  mission     PracticeMissionTemplate @relation(fields: [missionId], references: [id], onDelete: Cascade)

  @@index([missionId])
}

/// --------------------------------------
/// Phase 0: Prompt / Hook System
/// --------------------------------------
model PromptHook {
  id             String              @id @default(cuid())
  name           String
  type           String
  textTemplate   String
  conditionsJson Json
  category       String
  tags           String[]            @default([])
  priority       Int                 @default(50)
  isEnabled      Boolean             @default(true)
  createdAt      DateTime            @default(now())
  updatedAt      DateTime            @updatedAt
  version        String              @default("v1")
  metaJson       Json?
  triggers       PromptHookTrigger[]

  @@index([category])
  @@index([type, isEnabled])
  @@index([priority])
  @@index([tags])
}

/// --------------------------------------
/// Phase 0: Prompt Hook Trigger (analytics/cooldown)
/// --------------------------------------
model PromptHookTrigger {
  id             String          @id @default(cuid())
  hookId         String
  sessionId      String
  userId         String
  triggeredAt    DateTime        @default(now())
  matchedContext Json?
  hook           PromptHook      @relation(fields: [hookId], references: [id], onDelete: Cascade)
  session        PracticeSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  user           User            @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([sessionId, hookId])
  @@index([hookId, sessionId])
  @@index([sessionId, triggeredAt])
  @@index([userId, triggeredAt])
}

/// --------------------------------------
/// Step 5.1: Gate Outcomes (session-level gate ledger)
/// --------------------------------------
model GateOutcome {
  id          String          @id @default(cuid())
  sessionId   String
  userId      String
  gateKey     String
  passed      Boolean
  reasonCode  String?
  contextJson Json?
  evaluatedAt DateTime        @default(now())
  session     PracticeSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  user        User            @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([sessionId, gateKey])
  @@index([sessionId, evaluatedAt])
}

/// --------------------------------------
/// Step 5.1: User Trait History (per-session trait snapshots)
/// --------------------------------------
model UserTraitHistory {
  id              String          @id @default(cuid())
  sessionId       String          @unique
  userId          String
  recordedAt      DateTime        @default(now())
  traitsJson      Json
  deltasJson      Json
  sessionScore    Int?
  avgMessageScore Float?
  missionId       String?
  session         PracticeSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  user            User            @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, recordedAt])
  @@index([missionId])
}

/// --------------------------------------
/// Step 5.1: User Trait Scores (long-term trait tracking)
/// --------------------------------------
model UserTraitScores {
  userId     String   @id
  traitsJson Json
  updatedAt  DateTime @updatedAt
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

/// --------------------------------------
/// Step 5.4: Badge Progress Tracking
/// --------------------------------------
model UserBadgeProgress {
  id          String   @id @default(cuid())
  userId      String
  badgeKey    String
  categoryKey String
  tier        Int      @default(0)
  points      Int      @default(0)
  updatedAt   DateTime @updatedAt
  createdAt   DateTime @default(now())
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, badgeKey])
  @@index([userId, categoryKey])
}

/// --------------------------------------
/// Step 5.4: Badge Upgrade Events (for "recent unlock" UX)
/// --------------------------------------
model UserBadgeEvent {
  id        String          @id @default(cuid())
  userId    String
  badgeKey  String
  fromTier  Int
  toTier    Int
  sessionId String
  createdAt DateTime        @default(now())
  session   PracticeSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  user      User            @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
  @@index([sessionId])
}

/// --------------------------------------
/// Step 5.4: Badge Idempotency Ledger (prevents double progress/rewards)
/// --------------------------------------
model BadgeLedgerEntry {
  id        String          @id @default(cuid())
  userId    String
  sessionId String
  badgeKey  String
  kind      BadgeLedgerKind
  meta      Json?
  createdAt DateTime        @default(now())
  session   PracticeSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  user      User            @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([sessionId, badgeKey, kind])
  @@index([userId, createdAt])
}

/// --------------------------------------
/// Step 5.7: Hall of Fame Messages (top scoring messages saved by user)
/// --------------------------------------
model HallOfFameMessage {
  id          String          @id @default(cuid())
  userId      String
  messageId   String
  sessionId   String
  turnIndex   Int
  categoryKey String?
  score       Int
  createdAt   DateTime        @default(now())
  savedAt     DateTime        @default(now())
  /// Phase 4: Checklist-native metadata (tier, flags, etc.)
  meta        Json?
  message     ChatMessage     @relation(fields: [messageId], references: [id], onDelete: Cascade)
  session     PracticeSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  user        User            @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, messageId])
  @@index([userId, createdAt])
  @@index([sessionId])
}

/// --------------------------------------
/// Step 5.7: Burned Messages (user-marked as "never show again")
/// --------------------------------------
model BurnedMessage {
  id        String      @id @default(cuid())
  userId    String
  messageId String
  burnedAt  DateTime    @default(now())
  message   ChatMessage @relation(fields: [messageId], references: [id], onDelete: Cascade)
  user      User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, messageId])
  @@index([userId, burnedAt])
}

/// --------------------------------------
/// Step 5.9: Trait Synergy Map (per-session correlation analysis)
/// --------------------------------------
model SessionTraitSynergy {
  id          String          @id @default(cuid())
  sessionId   String          @unique
  userId      String
  synergyJson Json
  computedAt  DateTime        @default(now())
  session     PracticeSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  user        User            @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, computedAt])
  @@index([sessionId])
}

/// --------------------------------------
/// User Onboarding State (resume tracking)
/// --------------------------------------
model UserOnboardingState {
  id                String    @id @default(cuid())
  userId            String    @unique
  onboardingVersion String
  currentStep       Int       @default(0)
  startedAt         DateTime?
  completedAt       DateTime?
  skipped           Boolean   @default(false)
  lastUpdatedAt     DateTime  @updatedAt
  user              User      @relation(fields: [userId], references: [id], onDelete: Cascade)
}

enum MissionStatus {
  IN_PROGRESS
  SUCCESS
  FAIL
  ABORTED
}

enum MissionProgressStatus {
  LOCKED
  UNLOCKED
  COMPLETED
}

enum MessageRole {
  USER
  AI
  SYSTEM
}

enum MessageGrade {
  BRILLIANT
  GOOD
  NEUTRAL
  WEAK
  BAD
}

enum AccountTier {
  FREE
  PREMIUM
}

/// 6B – preference modeling
enum Gender {
  MALE
  FEMALE
  OTHER
  UNKNOWN
}

enum AttractionPreference {
  WOMEN
  MEN
  BOTH
  OTHER
  UNKNOWN
}

enum PreferencePath {
  FEMALE_PATH
  MALE_PATH
  DUAL_PATH
  OTHER_PATH
  UNKNOWN_PATH
}

/// Practice Hub Designer: Category attraction path
enum AttractionPath {
  UNISEX
  FEMALE_PATH
  MALE_PATH
}

enum MainGoal {
  DATING
  SOCIAL
  CAREER
  ALL
}

enum CommitmentLevel {
  LOW
  MEDIUM
  HIGH
  EXTREME
}

enum AvatarType {
  DEFAULT
  UPLOADED
}

/// Mission difficulty levels
enum MissionDifficulty {
  EASY
  MEDIUM
  HARD
  ELITE
}

/// Mission goal / type
enum MissionGoalType {
  OPENING
  FLIRTING
  RECOVERY
  BOUNDARY
  LOGISTICS
  SOCIAL
}

/// ✅ Stable AI Style keys (used by DB row `AiStyle.key`)
enum AiStyleKey {
  NEUTRAL
  FLIRTY
  PLAYFUL
  CHALLENGING
  WARM
  COLD
  SHY
  DIRECT
  JUDGMENTAL
  CHAOTIC
}

/// ✅ Ledger kinds (extend later)
enum RewardLedgerKind {
  SESSION_REWARD
  BADGE_TIER_UPGRADE
}

enum BadgeLedgerKind {
  PROGRESS_APPLY
  TIER_UPGRADE
}

/// --------------------------------------
/// Engine Config - Global engine knobs (GLOBAL_V1)
/// --------------------------------------
model EngineConfig {
  key       String   @id               // 'GLOBAL_V1'
  configJson Json
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

/// --------------------------------------
/// Config Slots - Snapshot system for engine config + practice hub
/// --------------------------------------
model ConfigSlot {
  id              String   @id @default(cuid())
  name            String
  slotNumber      Int?     // 1-5 for quick access slots
  engineConfigJson Json    // Full EngineConfig snapshot
  categoriesJson  Json?   // Snapshot of categories array
  missionsJson    Json?   // Snapshot of missions array
  defaultSeedKey  String? // Default seed selection
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@unique([slotNumber])
  @@index([name])
}
