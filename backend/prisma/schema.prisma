// FILE: backend/prisma/schema.prisma
// NOTE: Practice/Chat stats are currently Option A (rarity/xp-based). Option B trait metrics will be added alongside and gradually replace this.

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                 String            @id @default(cuid())
  email              String            @unique
  createdAt          DateTime          @default(now())
  sessionVersion     Int               @default(0)
  streakCurrent      Int               @default(0)
  streakLastActiveAt DateTime?
  passwordHash       String
  tier               AccountTier       @default(FREE)
  messages           ChatMessage[]
  powerUpUsages      PowerUpUsage[]
  sessions           PracticeSession[]
  refreshTokens      RefreshToken[]
  stats              UserStats?
  wallet             UserWallet?

  /// 6B – Onboarding / Preference fields
  gender         Gender               @default(UNKNOWN)
  attractedTo    AttractionPreference @default(UNKNOWN)
  preferencePath PreferencePath       @default(UNKNOWN_PATH)

  // Mission progress
  missionProgress MissionProgress[]

  // ✅ Rewards ledger (idempotent grants)
  rewardLedger RewardLedgerEntry[]
}

model IdempotencyKey {
  id           String   @id @default(cuid())
  key          String
  userId       String
  route        String
  bodyHash     String
  status       Int
  responseJson String
  createdAt    DateTime @default(now())
  expiresAt    DateTime

  @@unique([key, userId, route])
}

/// ✅ Rewards ledger entry (prevents double-award)
model RewardLedgerEntry {
  id         String  @id @default(cuid())
  userId     String
  sessionId  String
  templateId String?

  kind RewardLedgerKind @default(SESSION_REWARD)

  xpDelta    Int @default(0)
  coinsDelta Int @default(0)
  gemsDelta  Int @default(0)

  score     Int?
  isSuccess Boolean?
  meta      Json?
  createdAt DateTime @default(now())

  user    User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  session PracticeSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@unique([sessionId, kind])
  @@index([userId, createdAt])
  @@index([templateId])
}

model RefreshToken {
  id        String   @id @default(cuid())
  userId    String
  tokenHash String
  expiresAt DateTime
  createdAt DateTime @default(now())
  revoked   Boolean  @default(false)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, expiresAt, revoked])
}

/// --------------------------------------
/// AI Personas – characters for missions
/// --------------------------------------
model AiPersona {
  id          String   @id @default(cuid())
  code        String   @unique // e.g. "MAYA_FLIRTY"
  name        String
  shortLabel  String?
  description String?
  style       String?
  avatarUrl   String?
  difficulty  Int?
  voicePreset String? // TTS preset key
  active      Boolean  @default(true)
  createdAt   DateTime @default(now())

  // Relations
  sessions         PracticeSession[]
  missionTemplates PracticeMissionTemplate[]
}

/// --------------------------------------
/// Mission categories (Openers, Flirting…)
/// --------------------------------------
model MissionCategory {
  id          String  @id @default(cuid())
  code        String  @unique // "OPENERS", "FLIRTING"
  label       String // "Openers"
  description String?

  templates PracticeMissionTemplate[]
}

/// --------------------------------------
/// AI Styles – stable mapped "moods"
/// --------------------------------------
model AiStyle {
  id          String     @id @default(cuid())
  key         AiStyleKey @unique
  name        String
  description String
  tags        String[]   @default([])

  stylePrompt       String @db.Text
  forbiddenBehavior String @db.Text
  fewShotExamples   Json?

  // Hard constraints / dials
  maxChars     Int
  maxLines     Int
  questionRate Int // 0..100
  emojiRate    Int // 0..100
  initiative   Int // 0..5
  warmth       Int // 0..5
  judgment     Int // 0..5
  flirtTension Int // 0..5
  formality    Int // 0..5

  // Optional model knobs
  temperature Float?
  topP        Float?

  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  missions PracticeMissionTemplate[]
}

/// --------------------------------------
/// Mission template = "practice mission definition"
/// --------------------------------------
model PracticeMissionTemplate {
  id          String  @id @default(cuid())
  code        String  @unique // "OPENERS_L1_M1"
  title       String
  description String?

  // Category & goal
  categoryId String?
  category   MissionCategory? @relation(fields: [categoryId], references: [id])

  goalType MissionGoalType?

  // Persona assigned to this mission (optional)
  personaId String?
  persona   AiPersona? @relation(fields: [personaId], references: [id])

  // Difficulty & constraints
  difficulty   MissionDifficulty @default(EASY)
  timeLimitSec Int               @default(30) // per user message
  maxMessages  Int? // per mission
  wordLimit    Int? // per user message

  // Mission Road layout
  laneIndex  Int @default(0) // column index
  orderIndex Int @default(0) // position inside lane

  // Voice support
  isVoiceSupported Boolean @default(true)

  // Rewards (base values, before multipliers)
  baseXpReward    Int @default(50)
  baseCoinsReward Int @default(10)
  baseGemsReward  Int @default(0)

  // ✅ Optional AI style override for this mission (DB-mapped)
  aiStyleId String?
  aiStyle   AiStyle? @relation(fields: [aiStyleId], references: [id], onDelete: SetNull)

  aiContract Json?

  active    Boolean  @default(true)
  createdAt DateTime @default(now())

  // Relations
  sessions PracticeSession[]
  progress MissionProgress[]

  @@index([aiStyleId])
}

model PowerUpType {
  id                String         @id @default(cuid())
  code              String         @unique
  name              String
  description       String?
  gemCost           Int
  maxUsesPerSession Int?
  active            Boolean        @default(true)
  createdAt         DateTime       @default(now())
  usages            PowerUpUsage[]
}

model PracticeSession {
  id           String        @id @default(cuid())
  userId       String
  createdAt    DateTime      @default(now())
  topic        String
  score        Int           @default(0)
  xpGained     Int           @default(0)
  durationSec  Int           @default(0)
  notes        String?
  endedAt      DateTime?
  overallScore Int?
  personaId    String?
  status       MissionStatus @default(IN_PROGRESS)
  templateId   String?
  coinsGained  Int           @default(0)
  gemsGained   Int           @default(0)
  isSuccess    Boolean?
  messageCount Int           @default(0)
  payload      Json?
  rarityCounts Json?
  aiMode       String?
  aiSummary    Json?

  /// --------------------------------------
  /// ✅ Step 5.1 – End reason fields
  /// --------------------------------------
  endReasonCode String?
  endReasonMeta Json?

  /// --------------------------------------
  /// ⭐ Option B – Core AI Metrics (B4)
  /// --------------------------------------
  charismaIndex   Int?
  confidenceScore Int?
  clarityScore    Int?
  humorScore      Int?
  tensionScore    Int?
  emotionalWarmth Int?
  dominanceScore  Int?

  fillerWordsCount Int?
  totalMessages    Int?
  totalWords       Int?

  aiCoreVersion String?
  aiCorePayload Json?
  /// --------------------------------------

  messages ChatMessage[]
  powerUps PowerUpUsage[]

  // ✅ Rewards ledger relation
  rewardLedger RewardLedgerEntry[]

  persona  AiPersona?               @relation(fields: [personaId], references: [id])
  template PracticeMissionTemplate? @relation(fields: [templateId], references: [id])
  user     User                     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
  @@index([templateId])
  @@index([personaId])
}

model ChatMessage {
  id          String          @id @default(cuid())
  sessionId   String
  userId      String
  createdAt   DateTime        @default(now())
  role        MessageRole
  content     String
  grade       MessageGrade?
  xpDelta     Int             @default(0)
  coinsDelta  Int             @default(0)
  gemsDelta   Int             @default(0)
  isBrilliant Boolean         @default(false)
  isLifesaver Boolean         @default(false)
  meta        Json?

  /// --------------------------------------
  /// ✅ Step 5.1 – Deterministic ordering + normalized scoring
  /// --------------------------------------
  turnIndex   Int             // Position in transcript (0-based, includes USER + AI)
  score       Int?            // Normalized score (0-100, USER messages only)
  traitData   Json            // { traits: {...}, flags: [...], label: string }

  session     PracticeSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  user        User            @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([sessionId, createdAt])
  @@unique([sessionId, turnIndex])
}

model UserWallet {
  userId     String   @id
  xp         Int      @default(0)
  level      Int      @default(1)
  coins      Int      @default(0)
  gems       Int      @default(0)
  lifetimeXp Int      @default(0)
  updatedAt  DateTime @updatedAt
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model UserStats {
  userId              String    @id
  sessionsCount       Int       @default(0)
  successCount        Int       @default(0)
  failCount           Int       @default(0)
  averageScore        Float?
  averageMessageScore Float?
  lastSessionAt       DateTime?
  lastUpdatedAt       DateTime  @updatedAt
  user                User      @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model PowerUpUsage {
  id            String           @id @default(cuid())
  userId        String
  sessionId     String?
  powerUpTypeId String
  usedAt        DateTime         @default(now())
  gemsSpent     Int              @default(0)
  meta          Json?
  powerUpType   PowerUpType      @relation(fields: [powerUpTypeId], references: [id])
  session       PracticeSession? @relation(fields: [sessionId], references: [id])
  user          User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, usedAt])
  @@index([sessionId])
  @@index([powerUpTypeId])
}

/// --------------------------------------
/// Mission progress per user
/// --------------------------------------
model MissionProgress {
  id         String                @id @default(cuid())
  userId     String
  templateId String
  status     MissionProgressStatus @default(LOCKED)
  bestScore  Int?
  createdAt  DateTime              @default(now())
  updatedAt  DateTime              @updatedAt

  user     User                    @relation(fields: [userId], references: [id])
  template PracticeMissionTemplate @relation(fields: [templateId], references: [id])

  @@unique([userId, templateId])
}

/// --------------------------------------
/// Enums
/// --------------------------------------

enum MissionStatus {
  IN_PROGRESS
  SUCCESS
  FAIL
  ABORTED
}

enum MissionProgressStatus {
  LOCKED
  UNLOCKED
  COMPLETED
}

enum MessageRole {
  USER
  AI
  SYSTEM
}

enum MessageGrade {
  BRILLIANT
  GOOD
  NEUTRAL
  WEAK
  BAD
}

enum AccountTier {
  FREE
  PREMIUM
}

/// 6B – preference modeling
enum Gender {
  MALE
  FEMALE
  OTHER
  UNKNOWN
}

enum AttractionPreference {
  WOMEN
  MEN
  BOTH
  OTHER
  UNKNOWN
}

enum PreferencePath {
  FEMALE_PATH
  MALE_PATH
  DUAL_PATH
  OTHER_PATH
  UNKNOWN_PATH
}

/// Mission difficulty levels
enum MissionDifficulty {
  EASY
  MEDIUM
  HARD
  ELITE
}

/// Mission goal / type
enum MissionGoalType {
  OPENING
  FLIRTING
  RECOVERY
  BOUNDARY
  LOGISTICS
  SOCIAL
}

/// ✅ Stable AI Style keys (used by DB row `AiStyle.key`)
enum AiStyleKey {
  NEUTRAL
  FLIRTY
  PLAYFUL
  CHALLENGING
  WARM
  COLD
  SHY
  DIRECT
  JUDGMENTAL
  CHAOTIC
}

/// ✅ Ledger kinds (extend later)
enum RewardLedgerKind {
  SESSION_REWARD
}
