// FILE: backend/prisma/schema.prisma
// NOTE: Practice/Chat stats are currently Option A (rarity/xp-based). Option B trait metrics will be added alongside and gradually replace this.

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                 String            @id @default(cuid())
  email              String            @unique
  createdAt          DateTime          @default(now())
  sessionVersion     Int               @default(0)
  streakCurrent      Int               @default(0)
  streakLastActiveAt DateTime?
  passwordHash       String
  tier               AccountTier       @default(FREE)
  messages           ChatMessage[]
  powerUpUsages      PowerUpUsage[]
  sessions           PracticeSession[]
  refreshTokens      RefreshToken[]
  stats              UserStats?
  wallet             UserWallet?

  /// 6B – Onboarding / Preference fields
  gender         Gender               @default(UNKNOWN)
  attractedTo    AttractionPreference @default(UNKNOWN)
  preferencePath PreferencePath       @default(UNKNOWN_PATH)

  // Gate flags + meta
  onboardingCompleted   Boolean   @default(false)
  profileCompleted      Boolean   @default(false)
  onboardingVersion     String?
  onboardingCompletedAt DateTime?
  profileCompletedAt    DateTime?
  onboardingStep        Int       @default(0) // 0 = not started, 1–10 = last completed step

  // Profile identity
  displayName                String?
  avatarType                 AvatarType   @default(DEFAULT)
  avatarId                   String?
  avatarUrl                  String?
  profileTags                String[]     @default([])
  countryCode                String?
  allowLeaderboardVisibility Boolean      @default(true)

  // Onboarding preferences (beyond existing Gender/AttractionPreference/PreferencePath)
  mainGoal            MainGoal?
  dailyEffortMinutes  Int?
  commitmentLevel     CommitmentLevel?
  selfRatedLevel      Int?
  wantsHarshFeedback  Boolean?

  preferredStyles     String[]  @default([])
  interestTags        String[]  @default([])

  notificationsEnabled  Boolean @default(false)
  preferredReminderTime String?

  // Mission progress
  missionProgress MissionProgress[]

  // ✅ Rewards ledger (idempotent grants)
  rewardLedger RewardLedgerEntry[]

  // Phase 0: Deep Insights & Mood relations
  deepInsights       MissionDeepInsights[]
  moodTimelines      MissionMoodTimeline[]
  promptHookTriggers PromptHookTrigger[]

  // Step 5.1: Analytics relations
  gateOutcomes  GateOutcome[]
  traitHistory  UserTraitHistory[]
  traitScores   UserTraitScores?

  // Step 5.4: Badge relations
  badgeProgress UserBadgeProgress[]
  badgeEvents   UserBadgeEvent[]
  badgeLedger   BadgeLedgerEntry[]

  // Step 5.7: Hall of Fame and Burned Messages
  hallOfFameMessages HallOfFameMessage[]
  burnedMessages     BurnedMessage[]

  // Step 5.9: Trait Synergy relations
  traitSynergy SessionTraitSynergy[]

  // Step 5.14: Persona memory and category relations
  personaMemories      PersonaMemory[]
  categoryStats        CategoryStats[]
  categoryProgress     UserCategoryProgress[]

  // Onboarding state tracking
  onboardingState UserOnboardingState?
}

model IdempotencyKey {
  id           String   @id @default(cuid())
  key          String
  userId       String
  route        String
  bodyHash     String
  status       Int
  responseJson String
  createdAt    DateTime @default(now())
  expiresAt    DateTime

  @@unique([key, userId, route])
}

/// ✅ Rewards ledger entry (prevents double-award)
model RewardLedgerEntry {
  id         String  @id @default(cuid())
  userId     String
  sessionId  String
  templateId String?

  kind RewardLedgerKind @default(SESSION_REWARD)

  xpDelta    Int @default(0)
  coinsDelta Int @default(0)
  gemsDelta  Int @default(0)

  score     Int?
  isSuccess Boolean?
  meta      Json?
  createdAt DateTime @default(now())

  user    User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  session PracticeSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@unique([sessionId, kind])
  @@index([userId, createdAt])
  @@index([templateId])
}

model RefreshToken {
  id        String   @id @default(cuid())
  userId    String
  tokenHash String
  expiresAt DateTime
  createdAt DateTime @default(now())
  revoked   Boolean  @default(false)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, expiresAt, revoked])
}

/// --------------------------------------
/// AI Personas – characters for missions
/// --------------------------------------
model AiPersona {
  id          String   @id @default(cuid())
  code        String   @unique // e.g. "MAYA_FLIRTY"
  name        String
  shortLabel  String?
  description String?
  style       String?
  avatarUrl   String?
  difficulty  Int?
  voicePreset String? // TTS preset key
  active      Boolean  @default(true)
  createdAt   DateTime @default(now())

  // Gender compatibility
  personaGender Gender @default(UNKNOWN)

  // Relations
  sessions         PracticeSession[]
  missionTemplates PracticeMissionTemplate[]
  // Step 5.14: Persona memory
  memories         PersonaMemory[]
}

/// --------------------------------------
/// Mission categories (Openers, Flirting…)
/// --------------------------------------
model MissionCategory {
  id          String  @id @default(cuid())
  code        String  @unique // "OPENERS", "FLIRTING"
  label       String // "Openers"
  description String?

  // Attraction-based routing
  isAttractionSensitive Boolean  @default(false)
  dynamicLabelTemplate String? // e.g. "Approach {{targetPlural}}"

  templates PracticeMissionTemplate[]
  // Step 5.14: Category stats and progress
  categoryStats        CategoryStats[]
  categoryProgress     UserCategoryProgress[]
}

/// --------------------------------------
/// AI Styles – stable mapped "moods"
/// --------------------------------------
model AiStyle {
  id          String     @id @default(cuid())
  key         AiStyleKey @unique
  name        String
  description String
  tags        String[]   @default([])

  stylePrompt       String @db.Text
  forbiddenBehavior String @db.Text
  fewShotExamples   Json?

  // Hard constraints / dials
  maxChars     Int
  maxLines     Int
  questionRate Int // 0..100
  emojiRate    Int // 0..100
  initiative   Int // 0..5
  warmth       Int // 0..5
  judgment     Int // 0..5
  flirtTension Int // 0..5
  formality    Int // 0..5

  // Optional model knobs
  temperature Float?
  topP        Float?

  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  missions PracticeMissionTemplate[]
}

/// --------------------------------------
/// Mission template = "practice mission definition"
/// --------------------------------------
model PracticeMissionTemplate {
  id          String  @id @default(cuid())
  code        String  @unique // "OPENERS_L1_M1"
  title       String
  description String?

  // Category & goal
  categoryId String?
  category   MissionCategory? @relation(fields: [categoryId], references: [id])

  goalType MissionGoalType?

  // Persona assigned to this mission (optional)
  personaId String?
  persona   AiPersona? @relation(fields: [personaId], references: [id])

  // Difficulty & constraints
  difficulty   MissionDifficulty @default(EASY)
  timeLimitSec Int               @default(30) // per user message
  maxMessages  Int? // per mission
  wordLimit    Int? // per user message

  // Mission Road layout
  laneIndex  Int @default(0) // column index
  orderIndex Int @default(0) // position inside lane

  // Voice support
  isVoiceSupported Boolean @default(true)

  // Rewards (base values, before multipliers)
  baseXpReward    Int @default(50)
  baseCoinsReward Int @default(10)
  baseGemsReward  Int @default(0)

  // ✅ Optional AI style override for this mission (DB-mapped)
  aiStyleId String?
  aiStyle   AiStyle? @relation(fields: [aiStyleId], references: [id], onDelete: SetNull)

  // Attraction-based routing
  isAttractionSensitive Boolean @default(false)
  targetRomanticGender  Gender? // Nullable; only meaningful when isAttractionSensitive = true

  aiContract Json?

  active    Boolean  @default(true)
  createdAt DateTime @default(now())

  // Relations
  sessions    PracticeSession[]
  progress    MissionProgress[]
  moodConfigs MissionMoodConfig[]

  @@index([aiStyleId])
}

model PowerUpType {
  id                String         @id @default(cuid())
  code              String         @unique
  name              String
  description       String?
  gemCost           Int
  maxUsesPerSession Int?
  active            Boolean        @default(true)
  createdAt         DateTime       @default(now())
  usages            PowerUpUsage[]
}

model PracticeSession {
  id           String        @id @default(cuid())
  userId       String
  createdAt    DateTime      @default(now())
  topic        String
  score        Int           @default(0)
  xpGained     Int           @default(0)
  durationSec  Int           @default(0)
  notes        String?
  endedAt      DateTime?
  overallScore Int?
  personaId    String?
  status       MissionStatus @default(IN_PROGRESS)
  templateId   String?
  coinsGained  Int           @default(0)
  gemsGained   Int           @default(0)
  isSuccess    Boolean?
  messageCount Int           @default(0)
  payload      Json?
  rarityCounts Json?
  aiMode       String?
  aiSummary    Json?

  /// --------------------------------------
  /// ✅ Step 5.1 – End reason fields
  /// --------------------------------------
  endReasonCode String?
  endReasonMeta Json?

  /// --------------------------------------
  /// ⭐ Option B – Core AI Metrics (B4)
  /// --------------------------------------
  charismaIndex   Int?
  confidenceScore Int?
  clarityScore    Int?
  humorScore      Int?
  tensionScore    Int?
  emotionalWarmth Int?
  dominanceScore  Int?

  fillerWordsCount Int?
  totalMessages    Int?
  totalWords       Int?

  aiCoreVersion String?
  aiCorePayload Json?
  /// --------------------------------------

  messages ChatMessage[]
  powerUps PowerUpUsage[]

  // ✅ Rewards ledger relation
  rewardLedger RewardLedgerEntry[]

  // Phase 0: Deep Insights & Mood relations
  deepInsights       MissionDeepInsights?
  moodTimeline       MissionMoodTimeline?
  promptHookTriggers PromptHookTrigger[]

  // Step 5.1: Gate outcomes
  gateOutcomes GateOutcome[]

  // Step 5.1: Trait history
  traitHistory UserTraitHistory?

  // Step 5.4: Badge relations
  badgeEvents    UserBadgeEvent[]
  badgeLedger    BadgeLedgerEntry[]

  // Step 5.7: Hall of Fame and Burned Messages
  hallOfFameMessages HallOfFameMessage[]

  // Step 5.9: Trait Synergy relation
  traitSynergy SessionTraitSynergy?

  persona  AiPersona?               @relation(fields: [personaId], references: [id])
  template PracticeMissionTemplate? @relation(fields: [templateId], references: [id])
  user     User                     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
  @@index([templateId])
  @@index([personaId])
}

model ChatMessage {
  id          String        @id @default(cuid())
  sessionId   String
  userId      String
  createdAt   DateTime      @default(now())
  role        MessageRole
  content     String
  grade       MessageGrade?
  xpDelta     Int           @default(0)
  coinsDelta  Int           @default(0)
  gemsDelta   Int           @default(0)
  isBrilliant Boolean       @default(false)
  isLifesaver Boolean       @default(false)
  meta        Json?

  /// --------------------------------------
  /// ✅ Step 5.1 – Deterministic ordering + normalized scoring
  /// --------------------------------------
  turnIndex Int // Position in transcript (0-based, includes USER + AI)
  score     Int? // Normalized score (0-100, USER messages only)
  traitData Json // { traits: {...}, flags: [...], label: string }

  session PracticeSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  user    User            @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Step 5.7: Relations for Hall of Fame and Burned Messages
  hallOfFameEntries HallOfFameMessage[]
  burnedEntries     BurnedMessage[]

  @@unique([sessionId, turnIndex])
  @@index([sessionId, createdAt])
  @@index([userId, createdAt]) // Step 5.6: Performance index for user-scoped queries
}

model UserWallet {
  userId     String   @id
  xp         Int      @default(0)
  level      Int      @default(1)
  coins      Int      @default(0)
  gems       Int      @default(0)
  lifetimeXp Int      @default(0)
  updatedAt  DateTime @updatedAt
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model UserStats {
  userId              String    @id
  sessionsCount       Int       @default(0)
  successCount        Int       @default(0)
  failCount           Int       @default(0)
  averageScore        Float?
  averageMessageScore Float?
  lastSessionAt       DateTime?
  lastUpdatedAt       DateTime  @updatedAt
  user                User      @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model PowerUpUsage {
  id            String           @id @default(cuid())
  userId        String
  sessionId     String?
  powerUpTypeId String
  usedAt        DateTime         @default(now())
  gemsSpent     Int              @default(0)
  meta          Json?
  powerUpType   PowerUpType      @relation(fields: [powerUpTypeId], references: [id])
  session       PracticeSession? @relation(fields: [sessionId], references: [id])
  user          User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, usedAt])
  @@index([sessionId])
  @@index([powerUpTypeId])
}

/// --------------------------------------
/// Mission progress per user
/// --------------------------------------
model MissionProgress {
  id         String                @id @default(cuid())
  userId     String
  templateId String
  status     MissionProgressStatus @default(LOCKED)
  bestScore  Int?
  createdAt  DateTime              @default(now())
  updatedAt  DateTime              @updatedAt

  user     User                    @relation(fields: [userId], references: [id])
  template PracticeMissionTemplate @relation(fields: [templateId], references: [id])

  @@unique([userId, templateId])
}

/// --------------------------------------
/// Step 5.14: Persona Memory
/// --------------------------------------
model PersonaMemory {
  id          String   @id @default(cuid())
  userId      String
  personaId   String
  memoryKey   String
  memoryValue Json
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user    User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  persona AiPersona @relation(fields: [personaId], references: [id], onDelete: Cascade)

  @@unique([userId, personaId, memoryKey])
  @@index([userId, personaId])
  @@index([personaId, updatedAt])
}

/// --------------------------------------
/// Step 5.14: Category Statistics (per-user, per-category)
/// --------------------------------------
model CategoryStats {
  id            String   @id @default(cuid())
  userId        String
  categoryId    String
  categoryKey   String
  avgScore      Float?
  sessionsCount Int      @default(0)
  successCount  Int      @default(0)
  failCount     Int      @default(0)
  updatedAt     DateTime @updatedAt
  createdAt     DateTime @default(now())

  user     User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  category MissionCategory @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@unique([userId, categoryId])
  @@index([userId, categoryKey])
  @@index([categoryKey, updatedAt])
}

/// --------------------------------------
/// Step 5.14: User Category Progress (category completion tracking)
/// --------------------------------------
model UserCategoryProgress {
  id          String                @id @default(cuid())
  userId      String
  categoryId  String
  status      MissionProgressStatus @default(LOCKED)
  completedAt DateTime?
  updatedAt   DateTime @updatedAt
  createdAt   DateTime @default(now())

  user     User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  category MissionCategory @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@unique([userId, categoryId])
  @@index([userId, status])
  @@index([categoryId, completedAt])
}

/// --------------------------------------
/// Enums
/// --------------------------------------

enum MissionStatus {
  IN_PROGRESS
  SUCCESS
  FAIL
  ABORTED
}

enum MissionProgressStatus {
  LOCKED
  UNLOCKED
  COMPLETED
}

enum MessageRole {
  USER
  AI
  SYSTEM
}

enum MessageGrade {
  BRILLIANT
  GOOD
  NEUTRAL
  WEAK
  BAD
}

enum AccountTier {
  FREE
  PREMIUM
}

/// 6B – preference modeling
enum Gender {
  MALE
  FEMALE
  OTHER
  UNKNOWN
}

enum AttractionPreference {
  WOMEN
  MEN
  BOTH
  OTHER
  UNKNOWN
}

enum PreferencePath {
  FEMALE_PATH
  MALE_PATH
  DUAL_PATH
  OTHER_PATH
  UNKNOWN_PATH
}

enum MainGoal {
  DATING
  SOCIAL
  CAREER
  ALL
}

enum CommitmentLevel {
  LOW
  MEDIUM
  HIGH
  EXTREME
}

enum AvatarType {
  DEFAULT
  UPLOADED
}

/// Mission difficulty levels
enum MissionDifficulty {
  EASY
  MEDIUM
  HARD
  ELITE
}

/// Mission goal / type
enum MissionGoalType {
  OPENING
  FLIRTING
  RECOVERY
  BOUNDARY
  LOGISTICS
  SOCIAL
}

/// ✅ Stable AI Style keys (used by DB row `AiStyle.key`)
enum AiStyleKey {
  NEUTRAL
  FLIRTY
  PLAYFUL
  CHALLENGING
  WARM
  COLD
  SHY
  DIRECT
  JUDGMENTAL
  CHAOTIC
}

/// ✅ Ledger kinds (extend later)
enum RewardLedgerKind {
  SESSION_REWARD
  BADGE_TIER_UPGRADE
}

enum BadgeLedgerKind {
  PROGRESS_APPLY
  TIER_UPGRADE
}

/// --------------------------------------
/// Phase 0: Deep Insights
/// --------------------------------------
model MissionDeepInsights {
  id        String   @id @default(cuid())
  sessionId String   @unique
  userId    String
  missionId String // templateId
  createdAt DateTime @default(now())
  version   String   @default("v1")

  // Store full JSON payload (flexible for evolution)
  insightsJson Json // MissionDeepInsights interface serialized

  // Denormalized fields for quick queries/filtering
  averageRarityTier    String // 'D' | 'C' | 'B' | 'A' | 'S' | 'S+'
  primaryLabels        String[] @default([]) // for search/filtering
  overallCharismaIndex Int?

  // Relations
  session PracticeSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  user    User            @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
  @@index([missionId])
  @@index([averageRarityTier])
}

/// --------------------------------------
/// Phase 0: Mission Mood Timeline
/// --------------------------------------
model MissionMoodTimeline {
  id        String   @id @default(cuid())
  sessionId String   @unique
  userId    String
  missionId String // templateId
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  version   String   @default("v1")

  // Store full timeline as JSON (array of MoodSnapshot)
  timelineJson Json

  // Denormalized fields for quick queries
  currentMoodState   String // Step 5.10: 'COLD' | 'NEUTRAL' | 'WARM' | 'TENSE' | 'FLOW'
  currentMoodPercent Int // 0-100

  // Relations
  session PracticeSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  user    User            @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
  @@index([missionId])
  @@index([currentMoodState])
}

/// --------------------------------------
/// Phase 0: Mission Mood Config
/// --------------------------------------
model MissionMoodConfig {
  id        String   @id @default(cuid())
  missionId String   @unique // templateId
  version   String   @default("v1")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Store full config as JSON (MissionMoodConfig interface)
  configJson Json

  // Denormalized fields for quick access
  windowSize  Int
  positiveMin Int
  neutralMin  Int
  negativeMin Int

  // Relations
  mission PracticeMissionTemplate @relation(fields: [missionId], references: [id], onDelete: Cascade)

  @@index([missionId])
}

/// --------------------------------------
/// Phase 0: Prompt / Hook System
/// --------------------------------------
model PromptHook {
  id           String @id @default(cuid()) // or use custom ID format
  name         String
  type         String // 'POSITIVE' | 'NEGATIVE' | 'NEUTRAL'
  textTemplate String @db.Text

  // Store conditions as JSON (flexible structure)
  conditionsJson Json

  category  String
  tags      String[] @default([])
  priority  Int      @default(50) // 1-100
  isEnabled Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  version   String   @default("v1")

  // Optional metadata
  metaJson Json?

  // Relations
  triggers PromptHookTrigger[]

  @@index([category])
  @@index([type, isEnabled])
  @@index([priority])
  @@index([tags])
}

/// --------------------------------------
/// Phase 0: Prompt Hook Trigger (analytics/cooldown)
/// --------------------------------------
model PromptHookTrigger {
  id             String   @id @default(cuid())
  hookId         String
  sessionId      String
  userId         String
  triggeredAt    DateTime @default(now())
  matchedContext Json? // snapshot of conditions that matched

  // Relations
  hook    PromptHook      @relation(fields: [hookId], references: [id], onDelete: Cascade)
  session PracticeSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  user    User            @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([sessionId, hookId]) // Step 5.1: Prevent duplicate triggers per session/hook
  @@index([hookId, sessionId]) // for cooldown checks
  @@index([sessionId, triggeredAt])
  @@index([userId, triggeredAt])
}

/// --------------------------------------
/// Step 5.1: Gate Outcomes (session-level gate ledger)
/// --------------------------------------
model GateOutcome {
  id          String   @id @default(cuid())
  sessionId   String
  userId      String
  gateKey     String
  passed      Boolean
  reasonCode  String?
  contextJson Json?
  evaluatedAt DateTime @default(now())

  // Relations
  session PracticeSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  user    User            @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([sessionId, gateKey])
  @@index([sessionId, evaluatedAt])
}

/// --------------------------------------
/// Step 5.1: User Trait History (per-session trait snapshots)
/// --------------------------------------
model UserTraitHistory {
  id              String   @id @default(cuid())
  sessionId       String   @unique
  userId          String
  recordedAt      DateTime @default(now())
  traitsJson      Json // snapshot of trait values for this session
  deltasJson      Json // delta vs previous scores
  sessionScore    Int?
  avgMessageScore Float?
  missionId       String? // templateId

  // Relations
  session PracticeSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  user    User            @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, recordedAt])
  @@index([missionId])
}

/// --------------------------------------
/// Step 5.1: User Trait Scores (long-term trait tracking)
/// --------------------------------------
model UserTraitScores {
  userId    String   @id
  traitsJson Json // long-term aggregated trait scores
  updatedAt DateTime @updatedAt

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

/// --------------------------------------
/// Step 5.4: Badge Progress Tracking
/// --------------------------------------
model UserBadgeProgress {
  id         String   @id @default(cuid())
  userId     String
  badgeKey   String
  categoryKey String
  tier       Int      @default(0) // 0=none, 1=bronze, 2=silver, 3=gold, 4=diamond
  points     Int      @default(0) // Current points toward next tier
  updatedAt  DateTime @updatedAt
  createdAt  DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, badgeKey])
  @@index([userId, categoryKey])
}

/// --------------------------------------
/// Step 5.4: Badge Upgrade Events (for "recent unlock" UX)
/// --------------------------------------
model UserBadgeEvent {
  id         String   @id @default(cuid())
  userId     String
  badgeKey   String
  fromTier   Int      // Previous tier (0-4)
  toTier     Int      // New tier (0-4)
  sessionId  String
  createdAt  DateTime @default(now())

  user    User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  session PracticeSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
  @@index([sessionId])
}

/// --------------------------------------
/// Step 5.4: Badge Idempotency Ledger (prevents double progress/rewards)
/// --------------------------------------
model BadgeLedgerEntry {
  id         String          @id @default(cuid())
  userId     String
  sessionId  String
  badgeKey   String
  kind       BadgeLedgerKind
  meta       Json?           // Optional metadata (e.g., fromTier, toTier)
  createdAt  DateTime        @default(now())

  user    User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  session PracticeSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@unique([sessionId, badgeKey, kind])
  @@index([userId, createdAt])
}

/// --------------------------------------
/// Step 5.7: Hall of Fame Messages (top scoring messages saved by user)
/// --------------------------------------
model HallOfFameMessage {
  id         String   @id @default(cuid())
  userId     String
  messageId  String   // ChatMessage.id
  sessionId  String
  turnIndex  Int      // Step 5.6: Message turnIndex for breakdown
  categoryKey String? // Step 5.6: Optional category key for filtering
  score      Int      // Cached for quick sorting
  createdAt  DateTime @default(now()) // Step 5.6: Contract uses createdAt
  savedAt    DateTime @default(now()) // Keep for backward compatibility

  // Relations
  user    User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  message ChatMessage     @relation(fields: [messageId], references: [id], onDelete: Cascade)
  session PracticeSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@unique([userId, messageId])
  @@index([userId, createdAt])
  @@index([sessionId])
}

/// --------------------------------------
/// Step 5.7: Burned Messages (user-marked as "never show again")
/// --------------------------------------
model BurnedMessage {
  id        String   @id @default(cuid())
  userId    String
  messageId String   // ChatMessage.id
  burnedAt  DateTime @default(now())

  // Relations
  user    User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  message ChatMessage @relation(fields: [messageId], references: [id], onDelete: Cascade)

  @@unique([userId, messageId])
  @@index([userId, burnedAt])
}

/// --------------------------------------
/// Step 5.9: Trait Synergy Map (per-session correlation analysis)
/// --------------------------------------
model SessionTraitSynergy {
  id          String   @id @default(cuid())
  sessionId   String   @unique
  userId      String
  synergyJson Json     // Versioned payload with correlationMatrix, graphData, emotionLinks
  computedAt  DateTime @default(now())

  // Relations
  session PracticeSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  user    User            @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, computedAt])
  @@index([sessionId])
}

/// --------------------------------------
/// User Onboarding State (resume tracking)
/// --------------------------------------
model UserOnboardingState {
  id         String   @id @default(cuid())
  userId     String   @unique
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  onboardingVersion String
  currentStep       Int        @default(0) // 0 = before start, 1–10 as defined in onboarding flow
  startedAt         DateTime?
  completedAt       DateTime?
  skipped           Boolean    @default(false)

  lastUpdatedAt     DateTime   @updatedAt
}
