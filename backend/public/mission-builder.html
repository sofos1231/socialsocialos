<!-- FILE: backend/public/mission-builder.html -->
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>SocialGym – Mission Builder</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      :root {
        --bg: #020617;
        --card: #020617;
        --border-subtle: #1f2937;
        --border-strong: #4b5563;
        --text-main: #f9fafb;
        --text-muted: #9ca3af;
        --accent: #22c55e;
        --accent-soft: rgba(34, 197, 94, 0.16);
        --accent-strong: #16a34a;
        --danger: #ef4444;
        --danger-soft: rgba(239, 68, 68, 0.16);
        --pill-bg: #0b1120;
      }

      * { box-sizing: border-box; }
      body {
        margin: 0;
        padding: 24px;
        background: radial-gradient(circle at top left, #0f172a, #020617 60%);
        font-family: system-ui, -apple-system, BlinkMacSystemFont, 'SF Pro Text', sans-serif;
        color: var(--text-main);
      }

      h1 { margin: 0 0 6px 0; font-size: 28px; letter-spacing: 0.02em; }
      .subtitle { margin: 0 0 18px 0; font-size: 13px; color: var(--text-muted); max-width: 900px; }

      .layout {
        margin-top: 16px;
        display: grid;
        grid-template-columns: minmax(0, 1.05fr) minmax(0, 1.45fr) minmax(0, 1.1fr);
        gap: 16px;
      }

      .card {
        background: radial-gradient(circle at top, #020617, #020617 55%, #020617);
        border-radius: 18px;
        border: 1px solid var(--border-subtle);
        padding: 14px 16px 16px 16px;
        box-shadow: 0 18px 35px rgba(15, 23, 42, 0.65);
      }

      .card-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; }
      .card-title { font-size: 15px; font-weight: 700; }
      .card-subtitle { margin-top: 2px; font-size: 12px; color: var(--text-muted); }
      .small-pill { padding: 3px 8px; border-radius: 999px; background: var(--pill-bg); border: 1px solid var(--border-subtle); font-size: 10px; color: var(--text-muted); }

      .field-group { margin-bottom: 10px; }
      .field-label { font-size: 11px; text-transform: uppercase; letter-spacing: 0.08em; color: var(--text-muted); margin-bottom: 4px; }
      .field-row { display:flex; gap: 8px; }

      input[type='text'], input[type='number'], textarea, select {
        width: 100%;
        padding: 7px 9px;
        border-radius: 10px;
        border: 1px solid #111827;
        background: #020617;
        color: var(--text-main);
        font-size: 13px;
        outline: none;
      }

      textarea { resize: vertical; min-height: 56px; max-height: 220px; }
      input:focus, textarea:focus, select:focus { border-color: var(--accent); box-shadow: 0 0 0 1px var(--accent-soft); }

      button {
        border-radius: 999px;
        border: none;
        cursor: pointer;
        font-size: 13px;
        padding: 7px 14px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
        transition: transform 0.05s ease-out, box-shadow 0.1s ease-out, background 0.12s ease-out;
      }
      button:disabled { opacity: 0.5; cursor: default; transform:none; box-shadow:none; }

      .btn-primary {
        background: linear-gradient(135deg, var(--accent), var(--accent-strong));
        color: #022c22;
        font-weight: 700;
        box-shadow: 0 12px 24px rgba(34, 197, 94, 0.35);
      }
      .btn-ghost { background: #020617; color: var(--text-muted); border: 1px solid var(--border-subtle); }
      .btn-danger { background: var(--danger-soft); color: #fecaca; border: 1px solid rgba(248, 113, 113, 0.35); }
      .btn-small { padding: 4px 9px; font-size: 11px; }

      .status {
        margin-top: 10px;
        padding: 8px 10px;
        border-radius: 12px;
        border: 1px solid var(--border-subtle);
        color: var(--text-muted);
        font-size: 12px;
        display:flex;
        align-items:center;
        justify-content:space-between;
        gap: 10px;
      }
      .status.ok { border-color: rgba(34,197,94,.35); background: rgba(34,197,94,.10); color: #bbf7d0; }
      .status.err { border-color: rgba(239,68,68,.45); background: rgba(239,68,68,.10); color: #fecaca; }

      .list { max-height: 520px; overflow:auto; padding-right: 4px; }
      .row {
        border-radius: 14px;
        padding: 8px 10px;
        background: #020617;
        border: 1px solid #111827;
        display: grid;
        grid-template-columns: auto minmax(0, 1fr) auto;
        gap: 8px;
        align-items: center;
        margin-bottom: 6px;
        cursor: pointer;
      }
      .row.active { border-color: var(--accent); box-shadow: 0 0 0 1px var(--accent-soft); }
      .row .idx { font-size: 11px; color: var(--text-muted); }
      .row .title { font-size: 13px; font-weight: 700; white-space: nowrap; overflow:hidden; text-overflow: ellipsis; }
      .row .meta { font-size: 11px; color: var(--text-muted); display:flex; gap:6px; flex-wrap:wrap; margin-top:2px; }
      .meta span { padding: 2px 6px; border-radius: 999px; background: #0b1120; border: 1px solid var(--border-subtle); }

      .controls { display:flex; flex-direction:column; gap: 4px; }
      .hint { font-size: 11px; color: var(--text-muted); margin-top: 6px; }
    </style>
  </head>

  <body>
    <header>
      <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:16px;">
        <div>
          <h1>SocialGym – Mission Builder</h1>
          <p class="subtitle">
            This tool writes directly into your DB through <b>/v1/admin/missions</b>.
            The app reads missions from <b>/v1/missions/road</b>.
            If “Save mission” fails, you will see the real backend error here (no more silent 500s).
          </p>
        </div>
        <div class="small-pill">Requires JWT + Base URL</div>
      </div>

      <div class="card" style="margin-top:10px;">
        <div class="card-header">
          <div>
            <div class="card-title">1) Connection</div>
            <div class="card-subtitle">Use the same JWT you use in Postman. Base URL should be <b>http://localhost:3000</b> (no /v1).</div>
          </div>
          <div class="small-pill">GET /v1/admin/missions/meta</div>
        </div>

        <div class="field-row">
          <div style="flex:1;">
            <div class="field-label">Base URL</div>
            <input id="baseUrl" type="text" placeholder="http://localhost:3000" />
          </div>
          <div style="flex:2;">
            <div class="field-label">Bearer token</div>
            <textarea id="token" rows="2" placeholder="Paste access token here..."></textarea>
          </div>
          <div style="display:flex;flex-direction:column;gap:6px;justify-content:flex-end;">
            <button id="connect" class="btn-primary">Load</button>
            <button id="clear" class="btn-ghost btn-small">Clear</button>
          </div>
        </div>

        <div id="status" class="status">Idle</div>
      </div>
    </header>

    <main class="layout">
      <!-- LEFT -->
      <section class="card">
        <div class="card-header">
          <div>
            <div class="card-title">2) Categories</div>
            <div class="card-subtitle">Creates MissionCategory (code + label + description).</div>
          </div>
          <button id="newCat" class="btn-ghost btn-small">+ New</button>
        </div>

        <div class="field-group">
          <div class="field-label">Label</div>
          <input id="catLabel" type="text" placeholder="Flirting & Tension" />
        </div>

        <div class="field-row">
          <div style="flex:1;">
            <div class="field-label">Code (unique)</div>
            <input id="catCode" type="text" placeholder="FLIRTING" />
          </div>
        </div>

        <div class="field-group">
          <div class="field-label">Description</div>
          <input id="catDesc" type="text" placeholder="Playfulness, teasing, tension control." />
        </div>

        <div class="field-group">
          <button id="saveCat" class="btn-primary">Save category</button>
          <button id="delCat" class="btn-danger btn-small" style="margin-left:8px;">Delete</button>
        </div>

        <div class="field-label">Existing</div>
        <div class="list" id="catList"></div>
      </section>

      <!-- CENTER -->
      <section class="card">
        <div class="card-header">
          <div>
            <div class="card-title">3) Mission editor</div>
            <div class="card-subtitle">Writes PracticeMissionTemplate (+ aiContract).</div>
          </div>
          <button id="newMission" class="btn-ghost btn-small">+ New</button>
        </div>

        <div class="field-row">
          <div style="flex:1;">
            <div class="field-label">Title</div>
            <input id="mTitle" type="text" placeholder="First Hello" />
          </div>
          <div style="width:220px;">
            <div class="field-label">Code (optional)</div>
            <input id="mCode" type="text" placeholder="AUTO" />
          </div>
        </div>

        <div class="field-group">
          <div class="field-label">Description</div>
          <textarea id="mDesc" placeholder="Send a simple, confident opener."></textarea>
        </div>

        <div class="field-row">
          <div style="flex:1;">
            <div class="field-label">Category</div>
            <select id="mCategory"></select>
          </div>
          <div style="width:160px;">
            <div class="field-label">Goal type</div>
            <select id="mGoal">
              <option value="">(none)</option>
              <option value="OPENING">OPENING</option>
              <option value="FLIRTING">FLIRTING</option>
              <option value="RECOVERY">RECOVERY</option>
              <option value="BOUNDARY">BOUNDARY</option>
              <option value="LOGISTICS">LOGISTICS</option>
              <option value="SOCIAL">SOCIAL</option>
            </select>
          </div>
          <div style="width:140px;">
            <div class="field-label">Difficulty</div>
            <select id="mDiff">
              <option value="EASY">EASY</option>
              <option value="MEDIUM">MEDIUM</option>
              <option value="HARD">HARD</option>
              <option value="ELITE">ELITE</option>
            </select>
          </div>
        </div>

        <div class="field-row">
          <div style="flex:1;">
            <div class="field-label">Persona (optional)</div>
            <select id="mPersona"></select>
          </div>
          <div style="width:120px;">
            <div class="field-label">Lane</div>
            <input id="mLane" type="number" min="0" value="0" />
          </div>
          <div style="width:120px;">
            <div class="field-label">Order</div>
            <input id="mOrder" type="number" min="0" value="0" />
          </div>
        </div>

        <div class="field-row">
          <div style="width:140px;">
            <div class="field-label">Time limit (sec)</div>
            <input id="mTime" type="number" min="0" value="30" />
          </div>
          <div style="width:160px;">
            <div class="field-label">Max messages</div>
            <input id="mMax" type="number" min="0" placeholder="(null)" />
          </div>
          <div style="width:160px;">
            <div class="field-label">Word limit</div>
            <input id="mWords" type="number" min="0" placeholder="(null)" />
          </div>
        </div>

        <div class="field-row">
          <div style="width:140px;">
            <div class="field-label">XP</div>
            <input id="mXp" type="number" min="0" value="50" />
          </div>
          <div style="width:140px;">
            <div class="field-label">Coins</div>
            <input id="mCoins" type="number" min="0" value="10" />
          </div>
          <div style="width:140px;">
            <div class="field-label">Gems</div>
            <input id="mGems" type="number" min="0" value="0" />
          </div>
          <div style="flex:1;display:flex;align-items:flex-end;gap:8px;">
            <button id="mVoice" class="btn-ghost btn-small" style="width:100%;">Voice: ON</button>
            <button id="mActive" class="btn-ghost btn-small" style="width:100%;">Active: ON</button>
          </div>
        </div>

        <div class="field-group">
          <div class="field-label">AI Contract (JSON)</div>
          <textarea id="mContract" placeholder='{"systemPrompt":"...","rules":[...]}&#10;Leave empty = null'></textarea>
          <div class="hint">
            Must be valid JSON. You can paste object/array. If invalid → save will fail with a clear error.
          </div>
          <div style="margin-top:8px;display:flex;gap:8px;">
            <button id="contractSample" class="btn-ghost btn-small">Insert sample</button>
            <button id="contractClear" class="btn-ghost btn-small">Clear</button>
          </div>
        </div>

        <div class="field-group">
          <button id="saveMissionBtn" class="btn-primary">Save mission</button>
          <button id="delMissionBtn" class="btn-danger btn-small" style="margin-left:8px;">Delete</button>
        </div>
      </section>

      <!-- RIGHT -->
      <section class="card">
        <div class="card-header">
          <div>
            <div class="card-title">4) Mission list + ordering</div>
            <div class="card-subtitle">↑ / ↓ changes global orderIndex. Then Save ordering.</div>
          </div>
          <button id="saveOrderBtn" class="btn-primary btn-small">Save ordering</button>
        </div>

        <div class="hint">Tip: If you want “linear unlocking”, keep global orderIndex sequential.</div>
        <div class="list" id="missionList"></div>
        <div class="hint" id="footerHint">No missions loaded.</div>
      </section>
    </main>

    <script>
      const $ = (id) => document.getElementById(id);

      const state = {
        baseUrl: '',
        token: '',
        categories: [],
        personas: [],
        missions: [],
        selectedCategoryId: null,
        selectedMissionId: null,
        missionVoiceOn: true,
        missionActiveOn: true,
      };

      function setStatus(text, kind) {
        const el = $('status');
        el.className = 'status' + (kind === 'ok' ? ' ok' : kind === 'err' ? ' err' : '');
        el.textContent = text;
      }

      function api(path, opts = {}) {
        const url = state.baseUrl.replace(/\/+$/, '') + path;
        const headers = Object.assign(
          { 'Content-Type': 'application/json' },
          state.token ? { Authorization: 'Bearer ' + state.token } : {}
        );
        return fetch(url, Object.assign({ headers }, opts));
      }

      async function readJsonSafe(res) {
        const txt = await res.text();
        try { return JSON.parse(txt); } catch { return { raw: txt }; }
      }

      function resetCategoryForm() {
        state.selectedCategoryId = null;
        $('catLabel').value = '';
        $('catCode').value = '';
        $('catDesc').value = '';
      }

      function resetMissionForm(defaults = {}) {
        state.selectedMissionId = null;
        $('mTitle').value = defaults.title ?? '';
        $('mCode').value = defaults.code ?? '';
        $('mDesc').value = defaults.description ?? '';
        $('mCategory').value = defaults.categoryId ?? '';
        $('mPersona').value = defaults.personaId ?? '';
        $('mGoal').value = defaults.goalType ?? '';
        $('mDiff').value = defaults.difficulty ?? 'EASY';
        $('mLane').value = defaults.laneIndex ?? 0;
        $('mOrder').value = defaults.orderIndex ?? 0;
        $('mTime').value = defaults.timeLimitSec ?? 30;
        $('mMax').value = defaults.maxMessages ?? '';
        $('mWords').value = defaults.wordLimit ?? '';
        $('mXp').value = defaults.baseXpReward ?? 50;
        $('mCoins').value = defaults.baseCoinsReward ?? 10;
        $('mGems').value = defaults.baseGemsReward ?? 0;

        state.missionVoiceOn = defaults.isVoiceSupported ?? true;
        state.missionActiveOn = defaults.active ?? true;
        $('mVoice').textContent = 'Voice: ' + (state.missionVoiceOn ? 'ON' : 'OFF');
        $('mActive').textContent = 'Active: ' + (state.missionActiveOn ? 'ON' : 'OFF');

        $('mContract').value = defaults.aiContract ? JSON.stringify(defaults.aiContract, null, 2) : '';
      }

      function renderCategories() {
        const list = $('catList');
        list.innerHTML = '';
        state.categories.forEach((c) => {
          const el = document.createElement('div');
          el.className = 'row' + (state.selectedCategoryId === c.id ? ' active' : '');
          el.innerHTML = `
            <div class="idx">${c.code}</div>
            <div>
              <div class="title">${c.label}</div>
              <div class="meta"><span>${c.id.slice(0,8)}</span>${c.description ? `<span>${c.description}</span>` : ''}</div>
            </div>
            <div class="controls"><button class="btn-ghost btn-small">Select</button></div>
          `;
          el.onclick = () => {
            state.selectedCategoryId = c.id;
            $('catLabel').value = c.label ?? '';
            $('catCode').value = c.code ?? '';
            $('catDesc').value = c.description ?? '';
            renderCategories();
          };
          list.appendChild(el);
        });
      }

      function fillCategorySelect() {
        const sel = $('mCategory');
        sel.innerHTML = `<option value="">-- choose category --</option>`;
        state.categories.forEach((c) => {
          const o = document.createElement('option');
          o.value = c.id;
          o.textContent = `${c.code} — ${c.label}`;
          sel.appendChild(o);
        });
      }

      function fillPersonaSelect() {
        const sel = $('mPersona');
        sel.innerHTML = `<option value="">-- none --</option>`;
        state.personas.forEach((p) => {
          const o = document.createElement('option');
          o.value = p.id;
          o.textContent = `${p.code} — ${p.name}`;
          sel.appendChild(o);
        });
      }

      function renderMissions() {
        const list = $('missionList');
        list.innerHTML = '';

        const sorted = [...state.missions].sort((a,b) => (a.orderIndex - b.orderIndex) || (a.laneIndex - b.laneIndex));

        sorted.forEach((m, idx) => {
          const cat = state.categories.find((c) => c.id === m.categoryId);
          const persona = state.personas.find((p) => p.id === m.personaId);

          const el = document.createElement('div');
          el.className = 'row' + (state.selectedMissionId === m.id ? ' active' : '');
          el.innerHTML = `
            <div class="idx">${m.orderIndex ?? idx+1}</div>
            <div>
              <div class="title">${m.title}</div>
              <div class="meta">
                <span>lane ${m.laneIndex}</span>
                <span>${m.difficulty}</span>
                ${cat ? `<span>${cat.code}</span>` : ''}
                ${persona ? `<span>${persona.code}</span>` : ''}
                ${m.aiContract ? `<span>aiContract</span>` : ''}
              </div>
            </div>
            <div class="controls">
              <button class="btn-ghost btn-small" data-act="up">↑</button>
              <button class="btn-ghost btn-small" data-act="down">↓</button>
            </div>
          `;

          el.querySelector('[data-act="up"]').onclick = (ev) => {
            ev.stopPropagation();
            moveMission(m.id, -1);
          };
          el.querySelector('[data-act="down"]').onclick = (ev) => {
            ev.stopPropagation();
            moveMission(m.id, +1);
          };
          el.onclick = () => {
            state.selectedMissionId = m.id;
            resetMissionForm({
              title: m.title,
              code: m.code,
              description: m.description,
              categoryId: m.categoryId,
              personaId: m.personaId,
              goalType: m.goalType,
              difficulty: m.difficulty,
              laneIndex: m.laneIndex,
              orderIndex: m.orderIndex,
              timeLimitSec: m.timeLimitSec,
              maxMessages: m.maxMessages,
              wordLimit: m.wordLimit,
              baseXpReward: m.baseXpReward,
              baseCoinsReward: m.baseCoinsReward,
              baseGemsReward: m.baseGemsReward,
              isVoiceSupported: m.isVoiceSupported,
              active: m.active,
              aiContract: m.aiContract,
            });
            renderMissions();
          };

          list.appendChild(el);
        });

        $('footerHint').textContent = `Loaded ${state.missions.length} missions.`;
      }

      function moveMission(id, dir) {
        const sorted = [...state.missions].sort((a,b) => (a.orderIndex - b.orderIndex) || (a.laneIndex - b.laneIndex));
        const idx = sorted.findIndex((m) => m.id === id);
        const j = idx + dir;
        if (idx < 0 || j < 0 || j >= sorted.length) return;

        const a = sorted[idx];
        const b = sorted[j];
        const tmp = a.orderIndex;
        a.orderIndex = b.orderIndex;
        b.orderIndex = tmp;

        // reflect back
        state.missions = state.missions.map((m) => (m.id === a.id ? a : m.id === b.id ? b : m));
        renderMissions();
      }

      async function loadAll() {
        setStatus('Loading meta + missions...', '');
        const metaRes = await api('/v1/admin/missions/meta', { method: 'GET' });
        const meta = await readJsonSafe(metaRes);
        if (!metaRes.ok) {
          setStatus('Meta load failed: ' + (meta?.error?.message || meta?.message || JSON.stringify(meta)), 'err');
          return;
        }

        state.categories = meta.categories || [];
        state.personas = meta.personas || [];

        const missionsRes = await api('/v1/admin/missions', { method: 'GET' });
        const missions = await readJsonSafe(missionsRes);
        if (!missionsRes.ok) {
          setStatus('Missions load failed: ' + (missions?.error?.message || missions?.message || JSON.stringify(missions)), 'err');
          return;
        }

        // Normalize fields that may arrive with include category/persona
        state.missions = (missions || []).map((m) => ({
          ...m,
          categoryId: m.categoryId ?? m.category?.id ?? null,
          personaId: m.personaId ?? m.persona?.id ?? null,
        }));

        fillCategorySelect();
        fillPersonaSelect();
        renderCategories();
        renderMissions();
        setStatus('Connected. Meta + missions loaded.', 'ok');
      }

      // ----------------- Events -----------------
      $('connect').onclick = async () => {
        state.baseUrl = $('baseUrl').value.trim();
        state.token = $('token').value.trim();
        if (!state.baseUrl) return setStatus('Base URL is required', 'err');
        if (!state.token) return setStatus('Token is required', 'err');
        await loadAll();
      };

      $('clear').onclick = () => {
        $('baseUrl').value = '';
        $('token').value = '';
        state.baseUrl = '';
        state.token = '';
        state.categories = [];
        state.personas = [];
        state.missions = [];
        resetCategoryForm();
        resetMissionForm();
        renderCategories();
        renderMissions();
        setStatus('Idle', '');
      };

      $('newCat').onclick = () => resetCategoryForm();
      $('newMission').onclick = () => resetMissionForm();

      $('mVoice').onclick = () => {
        state.missionVoiceOn = !state.missionVoiceOn;
        $('mVoice').textContent = 'Voice: ' + (state.missionVoiceOn ? 'ON' : 'OFF');
      };
      $('mActive').onclick = () => {
        state.missionActiveOn = !state.missionActiveOn;
        $('mActive').textContent = 'Active: ' + (state.missionActiveOn ? 'ON' : 'OFF');
      };

      $('contractSample').onclick = () => {
        $('mContract').value = JSON.stringify({
          systemPrompt: 'You are a flirty but respectful girl. Keep replies short. Reward playful tension.',
          rules: [
            { id: 'no_needy', if: 'user_is_needy', penalty: { xpMult: 0.8 }, hint: 'Less validation seeking.' },
            { id: 'push_pull', if: 'user_push_pull', bonus: { xpMult: 1.3 }, hint: 'Nice tension control.' }
          ],
          success: { if: 'user_message_is_playful_and_confident' },
          fail: { if: 'user_message_is_rude_or_begging' }
        }, null, 2);
      };

      $('contractClear').onclick = () => { $('mContract').value = ''; };

      $('saveCat').onclick = async () => {
        if (!state.baseUrl || !state.token) return setStatus('Connect first', 'err');

        const label = $('catLabel').value.trim();
        const code = $('catCode').value.trim();
        const description = $('catDesc').value.trim();

        if (!label || !code) return setStatus('Category label + code are required', 'err');

        const body = { label, code, description };

        let res, payload;
        if (state.selectedCategoryId) {
          res = await api('/v1/admin/missions/categories/' + state.selectedCategoryId, { method: 'PATCH', body: JSON.stringify(body) });
          payload = await readJsonSafe(res);
        } else {
          res = await api('/v1/admin/missions/categories', { method: 'POST', body: JSON.stringify(body) });
          payload = await readJsonSafe(res);
        }

        if (!res.ok) {
          return setStatus('Save category failed: ' + (payload?.error?.message || payload?.message || JSON.stringify(payload)), 'err');
        }

        await loadAll();
      };

      $('delCat').onclick = async () => {
        if (!state.selectedCategoryId) return setStatus('Select a category first', 'err');
        if (!confirm('Delete this category?')) return;

        const res = await api('/v1/admin/missions/categories/' + state.selectedCategoryId, { method: 'DELETE' });
        const payload = await readJsonSafe(res);
        if (!res.ok) return setStatus('Delete failed: ' + (payload?.error?.message || payload?.message || JSON.stringify(payload)), 'err');

        resetCategoryForm();
        await loadAll();
      };

      $('saveMissionBtn').onclick = async () => {
        if (!state.baseUrl || !state.token) return setStatus('Connect first', 'err');

        const title = $('mTitle').value.trim();
        const missionCategoryId = $('mCategory').value;
        if (!title) return setStatus('Mission title is required', 'err');
        if (!missionCategoryId) return setStatus('Mission category is required', 'err');

        const code = $('mCode').value.trim();
        const description = $('mDesc').value.trim();
        const aiPersonaId = $('mPersona').value || null;

        const laneIndex = Number($('mLane').value || 0);
        const orderIndex = Number($('mOrder').value || 0);

        const difficulty = $('mDiff').value;
        const goalType = $('mGoal').value || null;

        const timeLimitSec = Number($('mTime').value || 30);
        const maxMessagesRaw = $('mMax').value.trim();
        const wordLimitRaw = $('mWords').value.trim();

        const maxMessages = maxMessagesRaw === '' ? null : Number(maxMessagesRaw);
        const wordLimit = wordLimitRaw === '' ? null : Number(wordLimitRaw);

        const rewardXp = Number($('mXp').value || 0);
        const rewardCoins = Number($('mCoins').value || 0);
        const rewardGems = Number($('mGems').value || 0);

        // aiContract JSON parse
        let aiContract = null;
        const rawContract = $('mContract').value.trim();
        if (rawContract.length > 0) {
          try { aiContract = JSON.parse(rawContract); }
          catch { return setStatus('aiContract JSON is invalid (fix it or clear it)', 'err'); }
        }

        const body = {
          ...(code ? { code } : {}),
          title,
          description: description || null,
          missionCategoryId,
          aiPersonaId,
          laneIndex,
          orderIndex,
          difficulty,
          ...(goalType ? { goalType } : {}),
          timeLimitSec,
          maxMessages,
          wordLimit,
          isVoiceSupported: state.missionVoiceOn,
          rewardXp,
          rewardCoins,
          rewardGems,
          aiContract,
          active: state.missionActiveOn,
        };

        let res, payload;
        if (state.selectedMissionId) {
          res = await api('/v1/admin/missions/' + state.selectedMissionId, { method: 'PATCH', body: JSON.stringify(body) });
          payload = await readJsonSafe(res);
        } else {
          res = await api('/v1/admin/missions', { method: 'POST', body: JSON.stringify(body) });
          payload = await readJsonSafe(res);
        }

        if (!res.ok) {
          return setStatus('Save mission failed: ' + (payload?.error?.message || payload?.message || JSON.stringify(payload)), 'err');
        }

        await loadAll();
        setStatus('Mission saved.', 'ok');
      };

      $('delMissionBtn').onclick = async () => {
        if (!state.selectedMissionId) return setStatus('Select a mission first', 'err');
        if (!confirm('Delete this mission (soft delete active=false)?')) return;

        const res = await api('/v1/admin/missions/' + state.selectedMissionId, { method: 'DELETE' });
        const payload = await readJsonSafe(res);
        if (!res.ok) return setStatus('Delete failed: ' + (payload?.error?.message || payload?.message || JSON.stringify(payload)), 'err');

        resetMissionForm();
        await loadAll();
      };

      $('saveOrderBtn').onclick = async () => {
        const sorted = [...state.missions].sort((a,b) => (a.orderIndex - b.orderIndex) || (a.laneIndex - b.laneIndex));
        const orderedIds = sorted.map((m) => m.id);

        const res = await api('/v1/admin/missions/reorder', { method: 'POST', body: JSON.stringify({ orderedIds }) });
        const payload = await readJsonSafe(res);
        if (!res.ok) return setStatus('Reorder failed: ' + (payload?.error?.message || payload?.message || JSON.stringify(payload)), 'err');

        await loadAll();
        setStatus('Ordering saved.', 'ok');
      };
    </script>
  </body>
</html>
