<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, viewport-fit=cover"
    />
    <title>SocialGym Dev Dashboard</title>
    <style>
      :root {
        --bg: #0b1020;
        --panel: rgba(255, 255, 255, 0.06);
        --panel2: rgba(255, 255, 255, 0.08);
        --text: rgba(255, 255, 255, 0.92);
        --muted: rgba(255, 255, 255, 0.65);
        --line: rgba(255, 255, 255, 0.12);
        --ok: #2ee59d;
        --warn: #ffd166;
        --bad: #ff5c7a;
        --btn: rgba(255, 255, 255, 0.1);
        --btn2: rgba(255, 255, 255, 0.16);
        --shadow: 0 10px 30px rgba(0, 0, 0, 0.25);

        /* controls */
        --controlBg: rgba(255, 255, 255, 0.07);
        --controlBgHover: rgba(255, 255, 255, 0.09);
        --controlBorder: rgba(255, 255, 255, 0.12);
        --controlFocus: rgba(77, 97, 255, 0.32);

        /* dropdown menu (options list) */
        --optionBg: #0f1733;
        --optionBgHover: #16204a;
        --optionBgSelected: #24306a;
        --optionText: rgba(255, 255, 255, 0.93);
        --optionTextMuted: rgba(255, 255, 255, 0.6);
      }

      * {
        box-sizing: border-box;
      }
      body {
        margin: 0;
        font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto,
          Helvetica, Arial;
        background: radial-gradient(
            1100px 900px at 20% 10%,
            rgba(77, 97, 255, 0.25),
            transparent 65%
          ),
          radial-gradient(
            900px 700px at 80% 0%,
            rgba(46, 229, 157, 0.18),
            transparent 60%
          ),
          radial-gradient(
            900px 700px at 70% 90%,
            rgba(255, 92, 122, 0.14),
            transparent 60%
          ),
          var(--bg);
        color: var(--text);

        /* IMPORTANT: make native form controls prefer dark UI where supported */
        color-scheme: dark;
      }
      .wrap {
        max-width: 1320px;
        margin: 22px auto;
        padding: 0 18px 24px;
      }
      header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
        margin-bottom: 14px;
      }
      .title {
        display: flex;
        flex-direction: column;
        gap: 4px;
      }
      .title h1 {
        font-size: 18px;
        margin: 0;
        letter-spacing: 0.3px;
      }
      .title p {
        margin: 0;
        font-size: 12px;
        color: var(--muted);
      }

      .row {
        display: grid;
        grid-template-columns: 400px 1fr;
        gap: 14px;
      }

      .panel {
        background: var(--panel);
        border: 1px solid var(--line);
        border-radius: 16px;
        box-shadow: var(--shadow);
        overflow: hidden;
      }

      .panelHead {
        padding: 12px 12px;
        border-bottom: 1px solid var(--line);
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        align-items: center;
        justify-content: space-between;
      }
      .panelHead .left,
      .panelHead .right {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
        align-items: center;
      }

      .btn {
        appearance: none;
        border: 1px solid var(--line);
        background: var(--btn);
        color: var(--text);
        padding: 8px 10px;
        border-radius: 12px;
        cursor: pointer;
        font-weight: 600;
        font-size: 12px;
      }
      .btn:hover {
        background: var(--btn2);
      }
      .btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      .chip {
        font-size: 12px;
        padding: 6px 10px;
        border-radius: 999px;
        border: 1px solid var(--line);
        background: rgba(255, 255, 255, 0.06);
        color: var(--muted);
      }
      .chip.ok {
        color: rgba(46, 229, 157, 0.95);
        border-color: rgba(46, 229, 157, 0.25);
        background: rgba(46, 229, 157, 0.08);
      }
      .chip.bad {
        color: rgba(255, 92, 122, 0.95);
        border-color: rgba(255, 92, 122, 0.25);
        background: rgba(255, 92, 122, 0.08);
      }
      .chip.warn {
        color: rgba(255, 209, 102, 0.95);
        border-color: rgba(255, 209, 102, 0.25);
        background: rgba(255, 209, 102, 0.08);
      }

      .body {
        padding: 12px;
      }

      .field {
        display: flex;
        flex-direction: column;
        gap: 6px;
        margin-bottom: 10px;
      }
      label {
        font-size: 12px;
        color: var(--muted);
      }

      input,
      select,
      textarea {
        background: var(--controlBg);
        border: 1px solid var(--controlBorder);
        border-radius: 12px;
        color: var(--text);
        padding: 10px 10px;
        outline: none;
        font-size: 13px;
      }

      input:hover,
      select:hover,
      textarea:hover {
        background: var(--controlBgHover);
      }

      input:focus,
      select:focus,
      textarea:focus {
        border-color: rgba(77, 97, 255, 0.45);
        box-shadow: 0 0 0 3px rgba(77, 97, 255, 0.14);
      }

      /* IMPORTANT: force readable dropdown menus (options list) */
      select {
        color-scheme: dark;
      }
      select option,
      select optgroup {
        background-color: var(--optionBg);
        color: var(--optionText);
      }
      select option:checked {
        background-color: var(--optionBgSelected);
        color: var(--optionText);
      }
      select option[disabled] {
        color: var(--optionTextMuted);
      }

      textarea {
        min-height: 280px;
        line-height: 1.35;
        resize: vertical;
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas,
          "Liberation Mono", "Courier New", monospace;
      }

      .split {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
      }
      .split3 {
        display: grid;
        grid-template-columns: 1fr 1fr 1fr;
        gap: 10px;
      }

      .listWrap {
        padding: 10px 12px 12px;
      }
      .search {
        display: flex;
        gap: 8px;
        align-items: center;
        margin-bottom: 10px;
      }
      .list {
        max-height: 640px;
        overflow: auto;
        padding-right: 6px;
      }
      .item {
        border: 1px solid var(--line);
        background: rgba(255, 255, 255, 0.06);
        border-radius: 14px;
        padding: 10px;
        cursor: pointer;
        margin-bottom: 8px;
        display: flex;
        flex-direction: column;
        gap: 6px;
      }
      .item:hover {
        background: rgba(255, 255, 255, 0.085);
      }
      .item.active {
        border-color: rgba(77, 97, 255, 0.45);
        box-shadow: 0 0 0 3px rgba(77, 97, 255, 0.12);
      }
      .itemTitle {
        font-weight: 800;
        font-size: 13px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 8px;
      }
      .itemMeta {
        font-size: 12px;
        color: var(--muted);
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
        align-items: center;
      }

      .footerLog {
        margin-top: 14px;
      }
      .logArea {
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas,
          "Liberation Mono", "Courier New", monospace;
        font-size: 12px;
        white-space: pre-wrap;
        word-break: break-word;
        padding: 12px;
        background: rgba(0, 0, 0, 0.28);
        border-top: 1px solid var(--line);
        max-height: 220px;
        overflow: auto;
      }

      .mini {
        font-size: 12px;
        color: var(--muted);
      }

      .dangerBox {
        border: 1px solid rgba(255, 92, 122, 0.25);
        background: rgba(255, 92, 122, 0.08);
        border-radius: 14px;
        padding: 10px 12px;
        color: rgba(255, 92, 122, 0.95);
        font-size: 12px;
        display: none;
      }

      .okBox {
        border: 1px solid rgba(46, 229, 157, 0.25);
        background: rgba(46, 229, 157, 0.08);
        border-radius: 14px;
        padding: 10px 12px;
        color: rgba(46, 229, 157, 0.95);
        font-size: 12px;
        display: none;
      }

      @media (max-width: 980px) {
        .row {
          grid-template-columns: 1fr;
        }
        .list {
          max-height: 380px;
        }
      }
    </style>
  </head>

  <body>
    <div class="wrap">
      <header>
        <div class="title">
          <h1>SocialGym — Dev Dashboard</h1>
          <p>
            Minimal mission editor: essential fields + one AI Contract JSON blob.
            (Single-file HTML with inline JS)
          </p>
        </div>

        <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
          <span id="apiStatusChip" class="chip warn">API: unknown</span>
          <span id="metaStatusChip" class="chip">Meta: not loaded</span>
          <span id="missionsStatusChip" class="chip">Missions: not loaded</span>
        </div>
      </header>

      <div class="panel" style="margin-bottom: 14px;">
        <div class="panelHead">
          <div class="left">
            <button id="pingApiBtn" class="btn">Ping API</button>
            <button id="loadMetaBtn" class="btn">Load Meta</button>
            <button id="loadMissionsBtn" class="btn">Load Missions</button>
          </div>
          <div class="right" style="flex: 1; justify-content: flex-end;">
            <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
              <span class="mini">API base:</span>
              <input
                id="apiBaseInput"
                style="width: 280px;"
                placeholder="e.g. http://localhost:3000"
              />
              <span class="mini">JWT:</span>
              <input
                id="jwtInput"
                style="width: 420px;"
                placeholder="paste Bearer token (without 'Bearer ')"
              />
              <button id="saveSettingsBtn" class="btn">Save</button>
            </div>
          </div>
        </div>
        <div class="body">
          <div id="okBox" class="okBox"></div>
          <div id="errorBox" class="dangerBox"></div>
          <div class="mini">
            Notes:
            <ul>
              <li>Difficulty enum must match DB: <b>EASY / MEDIUM / HARD / ELITE</b></li>
              <li><b>AI Styles</b> are loaded from DB (AiStyle table). Select “(default)” to not override.</li>
              <li>AI Contract is parsed as JSON object and sent as <code>aiContract</code></li>
              <li>All failures are shown below; nothing is silent.</li>
            </ul>
          </div>
        </div>
      </div>

      <div class="row">
        <!-- LEFT: MISSIONS LIST -->
        <div class="panel">
          <div class="panelHead">
            <div class="left">
              <button id="newMissionBtn" class="btn">New</button>
              <button id="duplicateMissionBtn" class="btn" disabled>Duplicate</button>
              <button id="deleteMissionBtn" class="btn" disabled>Delete</button>
            </div>
            <div class="right">
              <span id="selectedChip" class="chip">Selected: none</span>
            </div>
          </div>

          <div class="listWrap">
            <div class="search">
              <input
                id="searchInput"
                style="flex: 1;"
                placeholder="Search missions by name/code..."
              />
              <button id="clearSearchBtn" class="btn">Clear</button>
            </div>
            <div id="missionsList" class="list"></div>
          </div>
        </div>

        <!-- RIGHT: EDITOR -->
        <div class="panel">
          <div class="panelHead">
            <div class="left">
              <button id="saveMissionBtn" class="btn">Save Mission</button>
              <button id="clearFormBtn" class="btn">Clear Form</button>
            </div>
            <div class="right">
              <span id="contractValidityChip" class="chip warn">AI Contract: unknown</span>
              <span id="previewChip" class="chip">Preview: —</span>
            </div>
          </div>

          <div class="body">
            <div class="field">
              <label>Mission Title</label>
              <input id="missionTitleInput" placeholder="e.g. 'Open with playful confidence'" />
            </div>

            <div class="split3">
              <div class="field">
                <label>Difficulty</label>
                <select id="difficultySelect">
                  <option value="EASY">EASY</option>
                  <option value="MEDIUM">MEDIUM</option>
                  <option value="HARD">HARD</option>
                  <option value="ELITE">ELITE</option>
                </select>
              </div>

              <div class="field">
                <label>Category</label>
                <select id="categorySelect">
                  <option value="">(load meta)</option>
                </select>
              </div>

              <div class="field">
                <label>Persona</label>
                <select id="personaSelect">
                  <option value="">(load meta)</option>
                </select>
              </div>
            </div>

            <div class="split3">
              <div class="field">
                <label>Active</label>
                <select id="activeSelect">
                  <option value="true">true</option>
                  <option value="false">false</option>
                </select>
              </div>

              <div class="field">
                <label>Code (optional)</label>
                <input id="codeInput" placeholder="optional short code / slug" />
              </div>

              <div class="field">
                <label>AI Style (optional)</label>
                <select id="aiStyleSelect">
                  <option value="">(default / none)</option>
                  <option value="__meta__" disabled>— load meta to see styles —</option>
                </select>
              </div>
            </div>

            <div class="field">
              <label>AI Contract JSON (single blob)</label>
              <textarea
                id="aiContractJsonTextarea"
                placeholder='{"version":"ai-contract/v1","personaStyle":{...},"requiredMoves":[...],"bannedMoves":[...],"successCriteria":{...},"gradingHints":{...}}'
              ></textarea>

              <div style="display:flex; gap:8px; flex-wrap:wrap;">
                <button id="validateAiContractBtn" class="btn">Validate JSON</button>
                <button id="formatAiContractBtn" class="btn">Format JSON</button>
                <button id="pasteSampleBtn" class="btn">Paste Sample Contract</button>
              </div>

              <div id="contractErrorBox" class="dangerBox" style="margin-top:10px;"></div>
            </div>
          </div>
        </div>
      </div>

      <div class="panel footerLog">
        <div class="panelHead">
          <div class="left">
            <span class="mini">Log</span>
            <button id="clearLogBtn" class="btn">Clear Log</button>
          </div>
          <div class="right">
            <span class="mini"
              >Tip: open DevTools Console too — but this log makes sure you'll
              see errors even if JS breaks.</span
            >
          </div>
        </div>
        <div id="logArea" class="logArea"></div>
      </div>
    </div>

    <script>
      (function () {
        // ---------------------------
        // Config & state (single script, single ui object)
        // ---------------------------
        const STORAGE_KEYS = {
          apiBase: "sg_dev_api_base",
          jwt: "sg_dev_jwt",
        };

        const state = {
          metaLoaded: false,
          missionsLoaded: false,
          categories: [],
          personas: [],
          aiStyles: [],
          missions: [],
          selectedMissionId: null,

          // Backend DTO expects aiStyleKey (never aiStyleId)
          aiStyleSendField: "aiStyleKey",
          aiStyleTouched: false,
        };

        const ui = {
          // Header controls
          pingApiBtn: document.getElementById("pingApiBtn"),
          loadMetaBtn: document.getElementById("loadMetaBtn"),
          loadMissionsBtn: document.getElementById("loadMissionsBtn"),
          apiBaseInput: document.getElementById("apiBaseInput"),
          jwtInput: document.getElementById("jwtInput"),
          saveSettingsBtn: document.getElementById("saveSettingsBtn"),

          // Status chips
          apiStatusChip: document.getElementById("apiStatusChip"),
          metaStatusChip: document.getElementById("metaStatusChip"),
          missionsStatusChip: document.getElementById("missionsStatusChip"),

          // Alerts
          errorBox: document.getElementById("errorBox"),
          okBox: document.getElementById("okBox"),

          // List
          missionsList: document.getElementById("missionsList"),
          searchInput: document.getElementById("searchInput"),
          clearSearchBtn: document.getElementById("clearSearchBtn"),
          newMissionBtn: document.getElementById("newMissionBtn"),
          duplicateMissionBtn: document.getElementById("duplicateMissionBtn"),
          deleteMissionBtn: document.getElementById("deleteMissionBtn"),
          selectedChip: document.getElementById("selectedChip"),

          // Editor fields
          saveMissionBtn: document.getElementById("saveMissionBtn"),
          clearFormBtn: document.getElementById("clearFormBtn"),
          missionTitleInput: document.getElementById("missionTitleInput"),
          difficultySelect: document.getElementById("difficultySelect"),
          categorySelect: document.getElementById("categorySelect"),
          personaSelect: document.getElementById("personaSelect"),
          activeSelect: document.getElementById("activeSelect"),
          codeInput: document.getElementById("codeInput"),
          aiStyleSelect: document.getElementById("aiStyleSelect"),

          // Contract
          aiContractJsonTextarea: document.getElementById("aiContractJsonTextarea"),
          validateAiContractBtn: document.getElementById("validateAiContractBtn"),
          formatAiContractBtn: document.getElementById("formatAiContractBtn"),
          pasteSampleBtn: document.getElementById("pasteSampleBtn"),
          contractErrorBox: document.getElementById("contractErrorBox"),

          contractValidityChip: document.getElementById("contractValidityChip"),
          previewChip: document.getElementById("previewChip"),

          // Log
          logArea: document.getElementById("logArea"),
          clearLogBtn: document.getElementById("clearLogBtn"),
        };

        // ---------------------------
        // Utilities
        // ---------------------------
        function now() {
          const d = new Date();
          return d.toISOString().replace("T", " ").slice(0, 19);
        }

        function log(msg, obj) {
          const line =
            `[${now()}] ${msg}` + (obj ? `\n${safeStringify(obj)}` : "");
          ui.logArea.textContent = (line + "\n\n" + ui.logArea.textContent).trim();
          console.log("[DevDashboard]", msg, obj || "");
        }

        function showError(msg) {
          ui.errorBox.style.display = "block";
          ui.errorBox.textContent = msg;
          log("ERROR: " + msg);
        }

        function clearError() {
          ui.errorBox.style.display = "none";
          ui.errorBox.textContent = "";
        }

        function showOk(msg) {
          ui.okBox.style.display = "block";
          ui.okBox.textContent = msg;
          log("OK: " + msg);
          setTimeout(() => {
            ui.okBox.style.display = "none";
          }, 2500);
        }

        function setChip(el, text, kind) {
          el.textContent = text;
          el.classList.remove("ok", "warn", "bad");
          if (kind) el.classList.add(kind);
        }

        function safeStringify(obj) {
          try {
            return JSON.stringify(obj, null, 2);
          } catch {
            return String(obj);
          }
        }

        function getApiBase() {
          const raw = (ui.apiBaseInput.value || "").trim();
          return raw ? raw.replace(/\/+$/, "") : "";
        }

        function getJwt() {
          return (ui.jwtInput.value || "").trim();
        }

        function buildUrl(path) {
          const base = getApiBase() || "";
          const prefix = "/v1";
          if (!path.startsWith("/")) path = "/" + path;
          if (path.startsWith(prefix)) return base + path;
          return base + prefix + path;
        }

        async function apiFetch(path, options = {}) {
          clearError();
          const url = buildUrl(path);
          const headers = Object.assign(
            { "Content-Type": "application/json" },
            options.headers || {}
          );

          const jwt = getJwt();
          if (jwt) headers["Authorization"] = `Bearer ${jwt}`;

          log(`FETCH ${options.method || "GET"} ${url}`);

          let res;
          try {
            res = await fetch(url, { ...options, headers });
          } catch (e) {
            showError(`Network error calling ${url}: ${e?.message || e}`);
            throw e;
          }

          const text = await res.text();
          let json = null;
          if (text) {
            try {
              json = JSON.parse(text);
            } catch {
              // leave as raw text
            }
          }

          if (!res.ok) {
            const msg = `HTTP ${res.status} ${res.statusText} from ${url}\n${text || ""}`;
            showError(msg);
            throw new Error(msg);
          }

          return json ?? text;
        }

        function normalizeMeta(resp) {
          const root = resp && typeof resp === "object" ? resp : {};
          const data = root.data && typeof root.data === "object" ? root.data : root;

          const categories =
            data.categories ||
            data.missionCategories ||
            data.categoryList ||
            [];
          const personas = data.personas || data.aiPersonas || data.personaList || [];

          // Optional: meta may include ai styles too
          const aiStyles = data.aiStyles || data.styles || data.aiStyleList || [];

          return {
            categories: Array.isArray(categories) ? categories : [],
            personas: Array.isArray(personas) ? personas : [],
            aiStyles: Array.isArray(aiStyles) ? aiStyles : [],
          };
        }

        function normalizeAiStyles(resp) {
          const root = resp && typeof resp === "object" ? resp : {};
          const data = root.data && typeof root.data === "object" ? root.data : root;

          const list =
            data.aiStyles ||
            data.styles ||
            data.items ||
            (Array.isArray(data) ? data : null) ||
            (Array.isArray(root) ? root : null) ||
            [];
          const arr = Array.isArray(list) ? list : [];

          // normalize shapes
          return arr
            .map((s) => {
              if (!s) return null;
              if (typeof s === "string") {
                return { id: null, key: s, name: s, isActive: true };
              }
              const id = s.id ?? null;
              const key = s.key ?? s.code ?? s.slug ?? s.name ?? null;
              const name = s.name ?? s.title ?? key ?? "(unnamed)";
              const isActive = s.isActive ?? s.active ?? true;
              return { id, key, name, isActive };
            })
            .filter(Boolean);
        }

        function normalizeMissions(resp) {
          const root = resp && typeof resp === "object" ? resp : {};
          const data = root.data && typeof root.data === "object" ? root.data : root;

          const list =
            data.missions ||
            data.items ||
            (Array.isArray(data) ? data : null) ||
            [];
          return Array.isArray(list) ? list : [];
        }

        // ---------------------------
        // AI Contract helpers
        // ---------------------------
        function getAiContractJsonOrNull() {
          const raw = (ui.aiContractJsonTextarea.value || "").trim();
          if (!raw) return null;

          try {
            const obj = JSON.parse(raw);
            if (!obj || typeof obj !== "object") {
              return { ok: false, error: "AI Contract must be a JSON object (not array/string)." };
            }
            return { ok: true, value: obj };
          } catch (e) {
            return { ok: false, error: "Invalid JSON: " + (e?.message || e) };
          }
        }

        function setAiContractTextarea(contract) {
          if (!contract) {
            ui.aiContractJsonTextarea.value = "";
            updateContractValidity();
            return;
          }
          try {
            const obj =
              typeof contract === "string" ? JSON.parse(contract) : contract;
            ui.aiContractJsonTextarea.value = JSON.stringify(obj, null, 2);
          } catch {
            ui.aiContractJsonTextarea.value =
              typeof contract === "string" ? contract : safeStringify(contract);
          }
          updateContractValidity();
        }

        function validateAiContractJson() {
          const parsed = getAiContractJsonOrNull();
          ui.contractErrorBox.style.display = "none";
          ui.contractErrorBox.textContent = "";

          if (!parsed) {
            setChip(ui.contractValidityChip, "AI Contract: empty", "warn");
            showError("AI Contract is empty.");
            return false;
          }

          if (!parsed.ok) {
            setChip(ui.contractValidityChip, "AI Contract: invalid", "bad");
            ui.contractErrorBox.style.display = "block";
            ui.contractErrorBox.textContent = parsed.error;
            return false;
          }

          setChip(ui.contractValidityChip, "AI Contract: valid", "ok");
          return true;
        }

        function formatAiContractJson() {
          const parsed = getAiContractJsonOrNull();
          if (!parsed || !parsed.ok) {
            validateAiContractJson();
            return;
          }
          ui.aiContractJsonTextarea.value = JSON.stringify(parsed.value, null, 2);
          setChip(ui.contractValidityChip, "AI Contract: valid", "ok");
          ui.contractErrorBox.style.display = "none";
          ui.contractErrorBox.textContent = "";
        }

        function updateContractValidity() {
          const raw = (ui.aiContractJsonTextarea.value || "").trim();
          if (!raw) {
            setChip(ui.contractValidityChip, "AI Contract: empty", "warn");
            return;
          }
          const parsed = getAiContractJsonOrNull();
          if (parsed && parsed.ok) setChip(ui.contractValidityChip, "AI Contract: valid", "ok");
          else setChip(ui.contractValidityChip, "AI Contract: invalid", "bad");
        }

        function pasteSampleContract() {
          const sample = {
            version: "ai-contract/v1",
            language: "en",
            personaStyle: {
              name: "Rotem",
              oneLine: "Sharp, playful, warm when impressed. Not easy to win.",
              voice: { tone: ["playful", "sharp"], pace: "short_messages", emoji: "rare" },
              context: { setting: "Instagram DM", relationship: "strangers" }
            },
            systemPrompt: "Stay in character. Never mention rules. Keep replies natural and brief.",
            requiredMoves: [
              "Ask 1 good question every 2-4 messages",
              "Confidence without begging",
              "Light playful tease at least once",
              "Propose a next step by the end"
            ],
            bannedMoves: [
              "Sexual content or explicit talk",
              "Needy validation seeking",
              "Long paragraphs (>3 lines)",
              "Overcomplimenting / pedestalizing"
            ],
            successCriteria: {
              definition: "She stays engaged and agrees to continue or hints availability.",
              mustHaveSignals: [
                "She asks at least 1 follow-up question OR gives a warm response",
                "You suggest a clear next step"
              ]
            },
            gradingHints: {
              scoreScale: "0-100",
              hardFailIf: ["Sexual content", "Begging / chasing"]
            }
          };
          ui.aiContractJsonTextarea.value = JSON.stringify(sample, null, 2);
          updateContractValidity();
          showOk("Sample contract pasted.");
        }

        // ---------------------------
        // AiStyles helpers
        // ---------------------------
        function findStyleById(id) {
          return (state.aiStyles || []).find((s) => s && s.id === id) || null;
        }

        function findStyleByKey(key) {
          if (!key) return null;
          const kk = String(key).trim().toUpperCase();
          return (state.aiStyles || []).find((s) => String(s.key || "").trim().toUpperCase() === kk) || null;
        }

        function getSelectedStyle() {
          const val = ui.aiStyleSelect.value || "";
          if (!val) return null;
          // options use style.key as value
          return findStyleByKey(val);
        }

        function getMissionStyleKey(m) {
          if (!m) return "";
          // possible shapes
          if (typeof m.aiStyle === "string") return m.aiStyle;
          if (m.aiStyleKey) return m.aiStyleKey;
          if (m.aiStyle && typeof m.aiStyle === "object") return m.aiStyle.key || m.aiStyle.name || "";
          if (m.aiStyleId) {
            const s = findStyleById(m.aiStyleId);
            return s?.key || "";
          }
          return "";
        }

        function getMissionStyleId(m) {
          if (!m) return "";
          if (m.aiStyleId) return m.aiStyleId;
          if (m.aiStyle && typeof m.aiStyle === "object" && m.aiStyle.id) return m.aiStyle.id;
          // if backend returns a string key, map to id if possible
          const key = getMissionStyleKey(m);
          const s = findStyleByKey(key);
          return s?.id || "";
        }

        function detectAiStyleSendFieldFromMissions(missions) {
          for (const m of missions || []) {
            if (!m) continue;
            if (m.aiStyleId) return "aiStyleId";
            if (m.aiStyle && typeof m.aiStyle === "object" && m.aiStyle.id) return "aiStyleId";
            if (m.aiStyleKey) return "aiStyleKey";
            if (typeof m.aiStyle === "string") return "aiStyle";
          }
          return null;
        }

        // ---------------------------
        // Mission form helpers
        // ---------------------------
        function clearMissionForm() {
          state.selectedMissionId = null;
          state.aiStyleTouched = false;
          ui.missionTitleInput.value = "";
          ui.difficultySelect.value = "EASY";
          ui.categorySelect.value = "";
          ui.personaSelect.value = "";
          ui.activeSelect.value = "true";
          ui.codeInput.value = "";
          ui.aiStyleSelect.value = "";
          setAiContractTextarea(null);

          updateSelectionUI();
          updateMissionPreview();
          log("Form cleared.");
        }

        function getMissionFormValues() {
          const name = (ui.missionTitleInput.value || "").trim();
          const difficulty = ui.difficultySelect.value;
          const categoryId = ui.categorySelect.value || null;
          const personaId = ui.personaSelect.value || null;
          const active = ui.activeSelect.value === "true";
          const code = (ui.codeInput.value || "").trim() || null;

          if (!name) return { ok: false, error: "Mission title is required." };
          if (!categoryId) return { ok: false, error: "Category is required (Load Meta first)." };
          if (!personaId) return { ok: false, error: "Persona is required (Load Meta first)." };

          const parsed = getAiContractJsonOrNull();
          if (!parsed || !parsed.ok) {
            return { ok: false, error: parsed?.error || "AI Contract JSON is required." };
          }

          const payload = {
            name,
            difficulty,
            categoryId,
            personaId,
            active,
            ...(code ? { code } : {}),
            aiContract: parsed.value
          };

          // AI Style (optional) — NEVER send aiStyleId, only aiStyleKey
          // If style selected: send uppercase key
          // Else if updating AND user touched dropdown: send empty string to clear
          // Else: omit field entirely
          const sel = getSelectedStyle();
          if (sel && sel.key) {
            payload.aiStyleKey = String(sel.key).trim().toUpperCase();
          } else if (state.selectedMissionId && state.aiStyleTouched) {
            payload.aiStyleKey = ""; // explicit clear on update
          }
          // Otherwise: no aiStyle field in payload

          return { ok: true, value: payload };
        }

        function updateSelectionUI() {
          const sid = state.selectedMissionId;
          ui.selectedChip.textContent = sid ? `Selected: ${sid}` : "Selected: none";
          ui.duplicateMissionBtn.disabled = !sid;
          ui.deleteMissionBtn.disabled = !sid;

          // highlight list items
          const items = ui.missionsList.querySelectorAll(".item");
          items.forEach((el) => {
            const id = el.getAttribute("data-id");
            el.classList.toggle("active", !!sid && id === sid);
          });
        }

        function updateMissionPreview() {
          const name = (ui.missionTitleInput.value || "").trim() || "—";
          const difficulty = ui.difficultySelect.value || "—";
          const active = ui.activeSelect.value === "true" ? "active" : "inactive";

          const sel = getSelectedStyle();
          const styleLabel = sel ? (sel.key || sel.name || "style") : "default";

          const contractParsed = getAiContractJsonOrNull();
          const contractOk = contractParsed && contractParsed.ok;

          ui.previewChip.textContent = `${difficulty} • ${styleLabel} • ${active} • ${name}`;

          if (!ui.aiContractJsonTextarea.value.trim()) {
            setChip(ui.contractValidityChip, "AI Contract: empty", "warn");
            return;
          }
          setChip(
            ui.contractValidityChip,
            contractOk ? "AI Contract: valid" : "AI Contract: invalid",
            contractOk ? "ok" : "bad"
          );
        }

        function mapIdToName(list, id, keys = ["name", "title", "label"]) {
          const item = (list || []).find((x) => x?.id === id);
          if (!item) return id;
          for (const k of keys) if (item[k]) return item[k];
          return id;
        }

        // ---------------------------
        // Rendering
        // ---------------------------
        function renderAiStyleSelect() {
          ui.aiStyleSelect.innerHTML = `<option value="">(default / none)</option>`;

          const styles = (state.aiStyles || []).filter((s) => s && (s.isActive !== false));
          if (!styles.length) {
            ui.aiStyleSelect.insertAdjacentHTML(
              "beforeend",
              `<option value="__none__" disabled>(no styles found)</option>`
            );
            return;
          }

          for (const s of styles) {
            // Use key as value (backend expects aiStyleKey, not aiStyleId)
            const value = s.key || "";
            if (!value) continue; // skip styles without key
            const label = `${s.key || s.name || value} — ${s.name || ""}`.trim().replace(/\s+—\s*$/, "");
            ui.aiStyleSelect.insertAdjacentHTML(
              "beforeend",
              `<option value="${escapeHtmlAttr(value)}">${escapeHtml(label)}</option>`
            );
          }
        }

        function renderMetaSelects() {
          // categories
          ui.categorySelect.innerHTML = `<option value="">(select)</option>`;
          for (const c of state.categories) {
            const label = c.name || c.title || c.label || c.code || c.id;
            ui.categorySelect.insertAdjacentHTML(
              "beforeend",
              `<option value="${escapeHtmlAttr(c.id)}">${escapeHtml(label)}</option>`
            );
          }

          // personas
          ui.personaSelect.innerHTML = `<option value="">(select)</option>`;
          for (const p of state.personas) {
            const label = p.name || p.title || p.code || p.id;
            ui.personaSelect.insertAdjacentHTML(
              "beforeend",
              `<option value="${escapeHtmlAttr(p.id)}">${escapeHtml(label)}</option>`
            );
          }

          // styles
          renderAiStyleSelect();
        }

        function renderMissionsList() {
          const q = (ui.searchInput.value || "").trim().toLowerCase();
          const missions = (state.missions || []).filter((m) => {
            if (!q) return true;
            const styleKey = getMissionStyleKey(m) || "";
            const hay = `${m.name || ""} ${m.code || ""} ${styleKey}`.toLowerCase();
            return hay.includes(q);
          });

          ui.missionsList.innerHTML = "";
          for (const m of missions) {
            const id = m.id || "";
            const title = m.name || "(untitled)";
            const diff = m.difficulty || "—";
            const active = m.active ? "active" : "inactive";
            const styleKey = getMissionStyleKey(m);
            const catName = m.categoryId ? mapIdToName(state.categories, m.categoryId) : "—";
            const personaName = m.personaId ? mapIdToName(state.personas, m.personaId) : "—";

            const chipClass = m.active ? "ok" : "warn";
            const item = document.createElement("div");
            item.className = "item";
            item.setAttribute("data-id", id);
            item.innerHTML = `
              <div class="itemTitle">
                <span>${escapeHtml(title)}</span>
                <span class="chip ${chipClass}" style="padding:4px 10px">${escapeHtml(active)}</span>
              </div>
              <div class="itemMeta">
                <span class="chip" style="padding:4px 10px">${escapeHtml(diff)}</span>
                ${styleKey ? `<span class="chip" style="padding:4px 10px">${escapeHtml(styleKey)}</span>` : ""}
                <span>${escapeHtml(catName)}</span>
                <span>•</span>
                <span>${escapeHtml(personaName)}</span>
                ${m.code ? `<span>•</span><span>${escapeHtml(m.code)}</span>` : ""}
              </div>
            `;
            item.addEventListener("click", () => selectMission(id));
            ui.missionsList.appendChild(item);
          }

          updateSelectionUI();
        }

        function escapeHtml(str) {
          return String(str)
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#039;");
        }

        function escapeHtmlAttr(str) {
          return escapeHtml(str).replace(/"/g, "&quot;");
        }

        // ---------------------------
        // Core actions
        // ---------------------------
        async function pingApi() {
          setChip(ui.apiStatusChip, "API: pinging...", "warn");
          const tries = [
            "/health",
            "/admin/missions/meta",
            "/mqs/health",
            "/",
          ];

          for (const t of tries) {
            try {
              await apiFetch(t, { method: "GET" });
              setChip(ui.apiStatusChip, "API: OK", "ok");
              showOk(`API reachable via ${t}`);
              return true;
            } catch (e) {
              // continue
            }
          }

          setChip(ui.apiStatusChip, "API: FAIL", "bad");
          return false;
        }

        async function loadAiStylesFallback() {
          // If meta didn't include styles, try dedicated endpoints.
          const candidates = [
            "/admin/ai-styles",
            "/admin/ai-styles/list",
            "/admin/styles",
            "/ai-styles",
          ];

          for (const path of candidates) {
            try {
              const resp = await apiFetch(path, { method: "GET" });
              const list = normalizeAiStyles(resp);
              if (list.length) {
                state.aiStyles = list;
                log(`Loaded aiStyles from ${path}`, { count: list.length });
                return true;
              }
            } catch {
              // keep trying
            }
          }

          log("aiStyles fallback: no endpoint returned styles. (OK if your meta includes them)");
          return false;
        }

        async function loadMeta() {
          setChip(ui.metaStatusChip, "Meta: loading...", "warn");

          const resp = await apiFetch("/admin/missions/meta", { method: "GET" });
          const meta = normalizeMeta(resp);

          state.categories = meta.categories;
          state.personas = meta.personas;

          // styles from meta (optional) or fallback
          const stylesFromMeta = normalizeAiStyles({ data: { aiStyles: meta.aiStyles } });
          if (stylesFromMeta.length) {
            state.aiStyles = stylesFromMeta;
            log("Loaded aiStyles from meta", { count: stylesFromMeta.length });
          } else {
            await loadAiStylesFallback();
          }

          state.metaLoaded = true;

          renderMetaSelects();

          const extras = state.aiStyles.length ? `, ${state.aiStyles.length} styles` : "";
          setChip(
            ui.metaStatusChip,
            `Meta: ${state.categories.length} cats, ${state.personas.length} personas${extras}`,
            "ok"
          );
          showOk("Meta loaded.");
          updateMissionPreview();
        }

        async function loadMissions() {
          setChip(ui.missionsStatusChip, "Missions: loading...", "warn");

          let resp = null;
          try {
            resp = await apiFetch("/admin/missions", { method: "GET" });
          } catch {
            resp = await apiFetch("/admin/missions/list", { method: "GET" });
          }

          state.missions = normalizeMissions(resp);
          state.missionsLoaded = true;

          renderMissionsList();
          setChip(ui.missionsStatusChip, `Missions: ${state.missions.length}`, "ok");
          showOk("Missions loaded.");
        }

        function selectMission(id) {
          const m = (state.missions || []).find((x) => x.id === id);
          if (!m) {
            showError("Mission not found: " + id);
            return;
          }
          state.selectedMissionId = id;

          ui.missionTitleInput.value = m.name || "";
          ui.difficultySelect.value = m.difficulty || "EASY";
          ui.categorySelect.value = m.categoryId || "";
          ui.personaSelect.value = m.personaId || "";
          ui.activeSelect.value = String(!!m.active);
          ui.codeInput.value = m.code || "";

          // AI Style: find by key and set dropdown value to key
          const styleKey = getMissionStyleKey(m);
          if (styleKey) {
            const style = findStyleByKey(styleKey);
            if (style && style.key) {
              ui.aiStyleSelect.value = style.key;
            } else {
              ui.aiStyleSelect.value = "";
            }
          } else {
            ui.aiStyleSelect.value = "";
          }
          state.aiStyleTouched = false;

          setAiContractTextarea(m.aiContract);
          updateSelectionUI();
          updateMissionPreview();
          showOk("Mission loaded into editor.");
        }

        function duplicateMission() {
          const sid = state.selectedMissionId;
          if (!sid) return;
          const m = (state.missions || []).find((x) => x.id === sid);
          if (!m) return;

          state.selectedMissionId = null; // create NEW on save
          ui.missionTitleInput.value = (m.name || "Mission") + " (copy)";
          ui.difficultySelect.value = m.difficulty || "EASY";
          ui.categorySelect.value = m.categoryId || "";
          ui.personaSelect.value = m.personaId || "";
          ui.activeSelect.value = String(!!m.active);
          ui.codeInput.value = ""; // cleared intentionally

          // Use key-based selection (not ID)
          const styleKey = getMissionStyleKey(m);
          if (styleKey) {
            const style = findStyleByKey(styleKey);
            ui.aiStyleSelect.value = (style && style.key) ? style.key : "";
          } else {
            ui.aiStyleSelect.value = "";
          }
          state.aiStyleTouched = false;

          setAiContractTextarea(m.aiContract);

          updateSelectionUI();
          updateMissionPreview();
          showOk("Duplicated into a NEW unsaved mission (code cleared).");
        }

        async function deleteMission() {
          const sid = state.selectedMissionId;
          if (!sid) return;

          const ok = confirm("Delete mission permanently?\n\n" + sid);
          if (!ok) return;

          await apiFetch(`/admin/missions/${sid}`, { method: "DELETE" });
          showOk("Mission deleted.");

          await loadMissions();
          clearMissionForm();
        }

        async function saveMission() {
          const v = getMissionFormValues();
          if (!v.ok) {
            showError(v.error);
            return;
          }

          const payload = v.value;
          const sid = state.selectedMissionId;

          if (sid) {
            await apiFetch(`/admin/missions/${sid}`, {
              method: "PUT",
              body: JSON.stringify(payload),
            });
            showOk("Mission updated.");
          } else {
            await apiFetch(`/admin/missions`, {
              method: "POST",
              body: JSON.stringify(payload),
            });
            showOk("Mission created.");
          }

          state.aiStyleTouched = false;
          await loadMissions();

          const best = (state.missions || []).find(
            (m) => m.name === payload.name && (payload.code ? m.code === payload.code : true)
          );
          if (best?.id) selectMission(best.id);
          else clearMissionForm();
        }

        // ---------------------------
        // Settings
        // ---------------------------
        function loadSettings() {
          const apiBase = localStorage.getItem(STORAGE_KEYS.apiBase) || "";
          const jwt = localStorage.getItem(STORAGE_KEYS.jwt) || "";
          ui.apiBaseInput.value = apiBase;
          ui.jwtInput.value = jwt;
        }

        function saveSettings() {
          localStorage.setItem(STORAGE_KEYS.apiBase, getApiBase());
          localStorage.setItem(STORAGE_KEYS.jwt, getJwt());
          showOk("Settings saved.");
        }

        // ---------------------------
        // Event wiring (single place)
        // ---------------------------
        function wire() {
          ui.pingApiBtn.addEventListener("click", pingApi);
          ui.loadMetaBtn.addEventListener("click", loadMeta);
          ui.loadMissionsBtn.addEventListener("click", loadMissions);
          ui.saveSettingsBtn.addEventListener("click", saveSettings);

          ui.clearLogBtn.addEventListener("click", () => {
            ui.logArea.textContent = "";
            log("Log cleared.");
          });

          ui.clearSearchBtn.addEventListener("click", () => {
            ui.searchInput.value = "";
            renderMissionsList();
          });

          ui.searchInput.addEventListener("input", () => {
            renderMissionsList();
          });

          ui.newMissionBtn.addEventListener("click", () => {
            clearMissionForm();
            showOk("New mission (empty) ready.");
          });

          ui.duplicateMissionBtn.addEventListener("click", duplicateMission);
          ui.deleteMissionBtn.addEventListener("click", deleteMission);

          ui.saveMissionBtn.addEventListener("click", saveMission);
          ui.clearFormBtn.addEventListener("click", clearMissionForm);

          ui.validateAiContractBtn.addEventListener("click", () => {
            const ok = validateAiContractJson();
            if (ok) showOk("AI Contract JSON is valid.");
          });

          ui.formatAiContractBtn.addEventListener("click", () => {
            formatAiContractJson();
            const ok = validateAiContractJson();
            if (ok) showOk("Formatted & valid.");
          });

          ui.pasteSampleBtn.addEventListener("click", pasteSampleContract);

          // Track when user touches AI Style dropdown
          ui.aiStyleSelect.addEventListener("change", () => {
            state.aiStyleTouched = true;
          });

          // Live preview updates
          const previewInputs = [
            ui.missionTitleInput,
            ui.difficultySelect,
            ui.categorySelect,
            ui.personaSelect,
            ui.activeSelect,
            ui.codeInput,
            ui.aiStyleSelect,
            ui.aiContractJsonTextarea
          ];
          previewInputs.forEach((el) => el.addEventListener("input", updateMissionPreview));
          previewInputs.forEach((el) => el.addEventListener("change", updateMissionPreview));

          // capture global errors -> visible
          window.addEventListener("error", (e) => {
            showError(`JS Error: ${e.message} @ ${e.filename}:${e.lineno}:${e.colno}`);
          });
          window.addEventListener("unhandledrejection", (e) => {
            showError(`Unhandled Promise: ${e.reason?.message || e.reason}`);
          });
        }

        // ---------------------------
        // Boot
        // ---------------------------
        function boot() {
          loadSettings();
          wire();
          updateMissionPreview();

          setChip(ui.apiStatusChip, "API: ready", "warn");
          setChip(ui.metaStatusChip, "Meta: not loaded", "");
          setChip(ui.missionsStatusChip, "Missions: not loaded", "");

          log("Dashboard booted. (Single script, single ui object)");
          log("Tip: Click 'Ping API' then 'Load Meta' then 'Load Missions'.");
        }

        if (document.readyState === "loading") {
          document.addEventListener("DOMContentLoaded", boot);
        } else {
          boot();
        }
      })();
    </script>
  </body>
</html>
