<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>SocialGym – Mission Road Builder</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      :root {
        --bg: #020617;
        --bg2: #040a1d;
        --card: rgba(3, 7, 18, 0.92);
        --card2: rgba(2, 6, 23, 0.92);
        --border: rgba(148, 163, 184, 0.18);
        --border-strong: rgba(148, 163, 184, 0.32);
        --text: #f8fafc;
        --text2: #e2e8f0;
        --muted: rgba(226, 232, 240, 0.7);
        --muted2: rgba(226, 232, 240, 0.5);

        --accent: #22c55e;
        --accent2: #16a34a;
        --accent-soft: rgba(34, 197, 94, 0.18);

        --danger: #ef4444;
        --danger-soft: rgba(239, 68, 68, 0.16);

        --warning: #f59e0b;
        --warning-soft: rgba(245, 158, 11, 0.12);

        --shadow: 0 18px 40px rgba(0, 0, 0, 0.45);
        --shadow2: 0 10px 22px rgba(0, 0, 0, 0.35);

        --pill: rgba(15, 23, 42, 0.72);
        --pill2: rgba(2, 6, 23, 0.85);

        --scroll-track: rgba(2, 6, 23, 0.7);
        --scroll-thumb: rgba(148, 163, 184, 0.22);

        --radius: 18px;
        --radius2: 14px;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        padding: 18px;
        background: radial-gradient(
            1200px 600px at 20% 0%,
            rgba(34, 197, 94, 0.16),
            transparent 60%
          ),
          radial-gradient(
            900px 520px at 80% 0%,
            rgba(56, 189, 248, 0.12),
            transparent 60%
          ),
          linear-gradient(180deg, var(--bg2), var(--bg));
        font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto,
          Helvetica, Arial, 'Apple Color Emoji', 'Segoe UI Emoji';
        color: var(--text);
      }

      ::-webkit-scrollbar {
        width: 10px;
      }
      ::-webkit-scrollbar-track {
        background: var(--scroll-track);
        border-radius: 999px;
      }
      ::-webkit-scrollbar-thumb {
        background: var(--scroll-thumb);
        border-radius: 999px;
      }

      .top {
        display: flex;
        align-items: flex-start;
        justify-content: space-between;
        gap: 14px;
        margin-bottom: 10px;
      }

      h1 {
        margin: 0;
        font-size: 24px;
        letter-spacing: 0.02em;
      }

      .subtitle {
        margin: 6px 0 0 0;
        font-size: 13px;
        color: var(--muted);
        max-width: 860px;
        line-height: 1.4;
      }

      .badge {
        display: inline-flex;
        align-items: center;
        gap: 10px;
        padding: 8px 12px;
        border-radius: 999px;
        background: rgba(2, 6, 23, 0.75);
        border: 1px solid var(--border);
        box-shadow: var(--shadow2);
        font-size: 12px;
        color: var(--text2);
        user-select: none;
      }

      .badge-dot {
        width: 10px;
        height: 10px;
        border-radius: 999px;
        background: #64748b;
        box-shadow: 0 0 0 3px rgba(148, 163, 184, 0.12);
      }

      .layout {
        margin-top: 14px;
        display: grid;
        grid-template-columns: minmax(320px, 1.05fr) minmax(360px, 1.55fr) minmax(
            360px,
            1.3fr
          );
        gap: 14px;
      }

      .card {
        background: linear-gradient(
          180deg,
          rgba(2, 6, 23, 0.92),
          rgba(2, 6, 23, 0.82)
        );
        border-radius: var(--radius);
        border: 1px solid var(--border);
        padding: 14px 14px 16px 14px;
        box-shadow: var(--shadow);
        backdrop-filter: blur(10px);
      }

      .card-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        gap: 10px;
        margin-bottom: 10px;
      }

      .card-title {
        font-size: 15px;
        font-weight: 700;
        letter-spacing: 0.02em;
      }

      .card-subtitle {
        margin-top: 4px;
        font-size: 12px;
        color: var(--muted);
        line-height: 1.35;
      }

      .small-pill {
        padding: 4px 10px;
        border-radius: 999px;
        background: var(--pill);
        border: 1px solid var(--border);
        font-size: 11px;
        color: var(--muted);
        white-space: nowrap;
        user-select: none;
      }

      .row {
        display: flex;
        gap: 10px;
        align-items: center;
        flex-wrap: wrap;
      }

      .field-group {
        margin-bottom: 10px;
      }

      .field-label {
        font-size: 11px;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        color: rgba(226, 232, 240, 0.68);
        margin-bottom: 5px;
      }

      .field-row {
        display: flex;
        gap: 8px;
        align-items: flex-start;
      }

      input[type='text'],
      input[type='number'],
      textarea,
      select {
        width: 100%;
        padding: 8px 10px;
        border-radius: 12px;
        border: 1px solid var(--border);
        background: rgba(2, 6, 23, 0.9);
        color: var(--text);
        font-size: 13px;
        outline: none;
        box-shadow: inset 0 0 0 1px rgba(15, 23, 42, 0.3);
      }

      textarea {
        resize: vertical;
        min-height: 54px;
        max-height: 180px;
      }

      input::placeholder,
      textarea::placeholder {
        color: rgba(148, 163, 184, 0.6);
      }

      input[type='text']:focus,
      input[type='number']:focus,
      textarea:focus,
      select:focus {
        border-color: rgba(34, 197, 94, 0.65);
        box-shadow: 0 0 0 3px rgba(34, 197, 94, 0.16);
      }

      button {
        border-radius: 999px;
        border: 1px solid transparent;
        cursor: pointer;
        font-size: 13px;
        padding: 8px 14px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        transition: transform 0.06s ease-out, box-shadow 0.1s ease-out,
          background 0.12s ease-out, opacity 0.12s ease-out,
          border-color 0.12s ease-out;
        user-select: none;
      }

      button:disabled {
        opacity: 0.55;
        cursor: default;
        transform: none;
        box-shadow: none;
      }

      .btn-primary {
        background: linear-gradient(135deg, var(--accent), var(--accent2));
        color: #032a1e;
        font-weight: 800;
        box-shadow: 0 16px 32px rgba(34, 197, 94, 0.25);
      }

      .btn-primary:hover:not(:disabled) {
        transform: translateY(-1px);
        box-shadow: 0 24px 40px rgba(34, 197, 94, 0.32);
      }

      .btn-ghost {
        background: rgba(2, 6, 23, 0.8);
        color: var(--text2);
        border: 1px solid var(--border);
      }

      .btn-ghost:hover:not(:disabled) {
        background: rgba(3, 7, 18, 0.9);
        border-color: var(--border-strong);
      }

      .btn-danger {
        background: var(--danger-soft);
        color: #fecaca;
        border: 1px solid rgba(248, 113, 113, 0.45);
      }

      .btn-danger:hover:not(:disabled) {
        background: rgba(239, 68, 68, 0.28);
        border-color: rgba(248, 113, 113, 0.55);
      }

      .btn-small {
        padding: 5px 10px;
        font-size: 11px;
        gap: 6px;
      }

      .btn-icon {
        width: 28px;
        height: 28px;
        padding: 0;
        border-radius: 12px;
      }

      .connection-grid {
        display: grid;
        grid-template-columns: minmax(0, 0.85fr) minmax(0, 1fr) auto;
        gap: 10px;
        align-items: end;
      }

      .connection-status {
        margin-top: 8px;
        font-size: 12px;
        color: var(--muted);
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .status-dot {
        width: 10px;
        height: 10px;
        border-radius: 999px;
      }

      .status-idle {
        background: #64748b;
      }
      .status-ok {
        background: #22c55e;
      }
      .status-error {
        background: #ef4444;
      }
      .status-warning {
        background: #f59e0b;
      }

      .hint {
        font-size: 11px;
        color: var(--muted2);
        margin-top: 8px;
        line-height: 1.35;
      }

      .kbd {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 1px 7px;
        border-radius: 8px;
        border: 1px solid var(--border);
        background: rgba(15, 23, 42, 0.7);
        font-size: 10px;
        color: rgba(226, 232, 240, 0.7);
      }

      .category-list,
      .persona-list {
        max-height: 270px;
        overflow-y: auto;
        margin-top: 6px;
        padding-right: 4px;
      }

      .category-pill,
      .persona-pill {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 8px 10px;
        border-radius: 14px;
        background: rgba(2, 6, 23, 0.78);
        border: 1px solid var(--border);
        margin-bottom: 6px;
        cursor: pointer;
        transition: background 0.12s ease-out, border-color 0.12s ease-out,
          transform 0.07s ease-out;
      }

      .category-pill:hover,
      .persona-pill:hover {
        background: rgba(3, 7, 18, 0.9);
        border-color: var(--border-strong);
        transform: translateY(-1px);
      }

      .category-pill.active,
      .persona-pill.active {
        border-color: rgba(34, 197, 94, 0.7);
        box-shadow: 0 0 0 3px rgba(34, 197, 94, 0.12);
        background: rgba(2, 16, 18, 0.72);
      }

      .category-pill-main,
      .persona-pill-main {
        display: flex;
        flex-direction: column;
        gap: 3px;
        min-width: 0;
      }

      .category-pill-name,
      .persona-pill-name {
        font-size: 12px;
        font-weight: 700;
        color: var(--text2);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .category-pill-meta,
      .persona-pill-meta {
        font-size: 11px;
        color: var(--muted);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .missions-list {
        max-height: 560px;
        overflow-y: auto;
        padding-right: 4px;
      }

      .lane-header {
        font-size: 11px;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        color: rgba(226, 232, 240, 0.55);
        margin: 10px 2px 6px;
        display: flex;
        align-items: center;
        justify-content: space-between;
      }

      .lane-bucket {
        border: 1px dashed rgba(148, 163, 184, 0.22);
        background: rgba(2, 6, 23, 0.55);
        border-radius: 16px;
        padding: 8px;
        margin-bottom: 10px;
      }

      .mission-row {
        border-radius: 16px;
        padding: 10px 10px;
        background: rgba(2, 6, 23, 0.85);
        border: 1px solid rgba(148, 163, 184, 0.18);
        display: grid;
        grid-template-columns: auto minmax(0, 1fr) auto;
        gap: 10px;
        align-items: center;
        margin-bottom: 8px;
        cursor: pointer;
        transition: background 0.12s ease-out, border-color 0.12s ease-out,
          transform 0.07s ease-out;
      }

      .mission-row:hover {
        background: rgba(3, 7, 18, 0.92);
        border-color: rgba(148, 163, 184, 0.28);
        transform: translateY(-1px);
      }

      .mission-row.active {
        border-color: rgba(34, 197, 94, 0.7);
        box-shadow: 0 0 0 3px rgba(34, 197, 94, 0.12);
        background: rgba(2, 16, 18, 0.72);
      }

      .mission-row.dragging {
        opacity: 0.55;
        transform: scale(0.98);
      }

      .mission-row.drop-target {
        outline: 2px solid rgba(34, 197, 94, 0.6);
        box-shadow: 0 0 0 6px rgba(34, 197, 94, 0.12);
      }

      .drag-handle {
        width: 26px;
        height: 26px;
        border-radius: 12px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        background: rgba(15, 23, 42, 0.75);
        border: 1px solid rgba(148, 163, 184, 0.2);
        color: rgba(226, 232, 240, 0.7);
        font-size: 14px;
        user-select: none;
      }

      .mission-main {
        min-width: 0;
      }

      .mission-title {
        font-size: 13px;
        font-weight: 800;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        color: var(--text2);
      }

      .mission-meta {
        font-size: 11px;
        color: var(--muted);
        display: flex;
        gap: 6px;
        flex-wrap: wrap;
        margin-top: 4px;
      }

      .mission-meta span {
        padding: 3px 8px;
        border-radius: 999px;
        background: rgba(15, 23, 42, 0.72);
        border: 1px solid rgba(148, 163, 184, 0.14);
      }

      .mission-controls {
        display: flex;
        flex-direction: column;
        gap: 6px;
      }

      .preview-box {
        margin-top: 10px;
        padding: 10px 10px;
        border-radius: 16px;
        background: rgba(2, 6, 23, 0.72);
        border: 1px dashed rgba(148, 163, 184, 0.25);
        font-size: 11px;
        color: var(--muted);
      }

      .preview-tag {
        display: inline-flex;
        padding: 3px 8px;
        border-radius: 999px;
        background: rgba(15, 23, 42, 0.7);
        border: 1px solid rgba(148, 163, 184, 0.14);
        font-size: 10px;
        margin-right: 6px;
        margin-bottom: 6px;
      }

      .footer-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 10px;
        font-size: 12px;
        color: var(--muted);
        gap: 10px;
      }

      .divider {
        height: 1px;
        background: rgba(148, 163, 184, 0.14);
        margin: 10px 0;
      }

      .inline-banner {
        border-radius: 16px;
        padding: 10px 10px;
        border: 1px solid rgba(245, 158, 11, 0.3);
        background: rgba(245, 158, 11, 0.08);
        color: rgba(254, 243, 199, 0.95);
        font-size: 12px;
        display: none;
      }

      .inline-banner.show {
        display: block;
      }

      /* Toast */
      .toast-wrap {
        position: fixed;
        right: 16px;
        bottom: 16px;
        display: flex;
        flex-direction: column;
        gap: 10px;
        z-index: 9999;
      }

      .toast {
        min-width: 320px;
        max-width: 520px;
        border-radius: 16px;
        padding: 12px 12px;
        border: 1px solid var(--border);
        background: rgba(2, 6, 23, 0.92);
        box-shadow: var(--shadow);
        color: var(--text2);
        display: grid;
        grid-template-columns: auto 1fr auto;
        gap: 10px;
        align-items: start;
        animation: toastIn 0.16s ease-out;
      }

      @keyframes toastIn {
        from {
          transform: translateY(8px);
          opacity: 0;
        }
        to {
          transform: translateY(0px);
          opacity: 1;
        }
      }

      .toast-dot {
        width: 10px;
        height: 10px;
        border-radius: 999px;
        margin-top: 4px;
      }

      .toast-title {
        font-weight: 800;
        font-size: 12px;
        margin-bottom: 2px;
      }

      .toast-msg {
        font-size: 12px;
        color: var(--muted);
        white-space: pre-wrap;
        line-height: 1.35;
      }

      .toast-x {
        width: 26px;
        height: 26px;
        border-radius: 12px;
        background: rgba(15, 23, 42, 0.75);
        border: 1px solid rgba(148, 163, 184, 0.2);
        color: rgba(226, 232, 240, 0.7);
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        justify-content: center;
      }

      .toast-x:hover {
        border-color: rgba(148, 163, 184, 0.35);
        background: rgba(15, 23, 42, 0.9);
      }

      /* Search input */
      .search {
        display: grid;
        grid-template-columns: 1fr auto;
        gap: 10px;
        align-items: center;
        margin-top: 6px;
        margin-bottom: 10px;
      }

      .search input {
        border-radius: 999px;
        padding-left: 14px;
      }

      /* AI contract sections */
      .ai-section {
        margin-top: 12px;
        padding: 10px 10px;
        border-radius: 14px;
        background: rgba(2, 6, 23, 0.85);
        border: 1px solid rgba(148, 163, 184, 0.2);
      }

      .ai-section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        cursor: pointer;
      }

      .ai-section-title {
        font-size: 12px;
        font-weight: 700;
        letter-spacing: 0.06em;
        text-transform: uppercase;
        color: rgba(226, 232, 240, 0.85);
      }

      .ai-section-toggle {
        font-size: 11px;
        color: var(--muted);
      }

      .ai-section-body {
        margin-top: 8px;
      }

      .ai-collapsed .ai-section-body {
        display: none;
      }
    
      /* ===========================
         Mission Road UX Upgrade
         =========================== */
      .missions-list {
        padding-right: 10px;
      }

      .lane {
        border: 1px solid rgba(148, 163, 184, 0.18);
        border-radius: 16px;
        padding: 10px;
        margin: 10px 0 14px 0;
        background: linear-gradient(180deg, rgba(2,6,23,0.92), rgba(3,7,18,0.92));
      }

      .lane-titlebar {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
        padding: 8px 8px 10px 8px;
        position: sticky;
        top: 0;
        z-index: 2;
        background: linear-gradient(180deg, rgba(2,6,23,0.97), rgba(2,6,23,0.92));
        border-bottom: 1px solid rgba(148, 163, 184, 0.12);
        border-radius: 12px;
        margin-bottom: 10px;
      }

      .lane-titlebar .lane-name {
        font-weight: 900;
        letter-spacing: 0.02em;
      }
      .lane-titlebar .lane-count {
        font-size: 12px;
        color: rgba(226, 232, 240, 0.7);
      }

      .cat-section {
        border: 1px solid rgba(148, 163, 184, 0.14);
        border-radius: 14px;
        margin: 10px 0;
        overflow: hidden;
        background: rgba(2, 6, 23, 0.55);
      }

      .cat-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
        padding: 10px 10px;
        background: rgba(15, 23, 42, 0.6);
        border-bottom: 1px solid rgba(148, 163, 184, 0.12);
        cursor: grab;
        user-select: none;
      }
      .cat-header:active { cursor: grabbing; }

      .cat-left {
        display: flex;
        align-items: center;
        gap: 10px;
        min-width: 0;
      }

      .cat-chip {
        display: inline-flex;
        align-items: center;
        gap: 7px;
        padding: 6px 10px;
        border-radius: 999px;
        background: rgba(34, 197, 94, 0.10);
        border: 1px solid rgba(34, 197, 94, 0.22);
        color: rgba(240, 253, 244, 0.95);
        font-weight: 800;
        font-size: 12px;
        white-space: nowrap;
      }

      .cat-sub {
        font-size: 12px;
        color: rgba(226, 232, 240, 0.7);
        white-space: nowrap;
      }

      .cat-handle {
        opacity: 0.8;
        font-weight: 900;
        letter-spacing: 0.06em;
        color: rgba(226, 232, 240, 0.7);
      }

      .cat-body {
        padding: 8px;
      }

      .mission-row {
        cursor: grab;
      }
      .mission-row:active { cursor: grabbing; }

      .mission-row .mission-controls {
        gap: 6px;
      }

      .btn-icon-danger {
        background: rgba(239, 68, 68, 0.10);
        border: 1px solid rgba(239, 68, 68, 0.24);
        color: rgba(254, 226, 226, 0.95);
      }
      .btn-icon-danger:hover {
        background: rgba(239, 68, 68, 0.18);
        border-color: rgba(239, 68, 68, 0.35);
      }

      .drop-placeholder {
        height: 56px;
        border-radius: 14px;
        border: 1px dashed rgba(34, 197, 94, 0.55);
        background: rgba(34, 197, 94, 0.08);
        margin: 8px 0;
      }

      .drop-placeholder.compact {
        height: 12px;
        margin: 8px 2px;
        border-radius: 999px;
      }

      .drag-ghost {
        position: fixed;
        z-index: 9999;
        pointer-events: none;
        opacity: 0.92;
        transform: rotate(-0.5deg);
        filter: drop-shadow(0 18px 32px rgba(0,0,0,0.6));
        width: min(860px, calc(100vw - 48px));
      }

      .dragging-source {
        opacity: 0.25;
      }

      .hint-chip {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 8px 10px;
        border-radius: 999px;
        background: rgba(148, 163, 184, 0.10);
        border: 1px solid rgba(148, 163, 184, 0.18);
        color: rgba(226, 232, 240, 0.76);
        font-size: 12px;
      }

    </style>
  </head>

  <body>
    <div class="toast-wrap" id="toastWrap"></div>

    <header class="top">
      <div>
        <h1>SocialGym – Mission Road Builder</h1>
        <p class="subtitle">
          Internal low-code tool for defining the Mission Road. Connect with your backend, then manage
          categories, personas and missions. Includes a full AI contract editor per mission.
        </p>
      </div>
      <div class="badge">
        <span class="badge-dot" id="statusDot"></span>
        <span id="statusText">Idle – not connected</span>
      </div>
    </header>

    <section class="card">
      <div class="card-header">
        <div>
          <div class="card-title">1) Connection</div>
          <div class="card-subtitle">
            Use the same Base URL + JWT you use in Postman. We fetch categories + missions + personas.
            Base URL persists locally for convenience.
          </div>
        </div>
        <div class="small-pill">Admin endpoints</div>
      </div>

      <div class="connection-grid">
        <div class="field-group">
          <div class="field-label">Base URL</div>
          <input id="baseUrlInput" type="text" placeholder="http://localhost:3000" />
        </div>

        <div class="field-group">
          <div class="field-label">Access token (Bearer)</div>
          <textarea id="tokenInput" rows="2" placeholder="Paste JWT access token here…"></textarea>
        </div>

        <div style="display:flex;flex-direction:column;gap:8px;">
          <button id="connectBtn" class="btn-primary">Load data</button>
          <button id="clearBtn" class="btn-ghost btn-small">Clear state</button>
        </div>
      </div>

      <div class="connection-status" id="connectionStatus">
        <span class="status-dot status-idle" id="connDot"></span>
        <span id="connText">Idle – not connected yet.</span>
      </div>

      <div class="hint">
        Tip: token usually starts with <span class="kbd">eyJ</span>. Base URL can be
        <span class="kbd">http://localhost:3000</span> or your LAN IP.
        Use <span class="kbd">Ctrl+F5</span> after updating this HTML.
      </div>
    </section>

    <main class="layout">
      <!-- LEFT: Category editor -->
      <section class="card" id="categoryCard">
        <div class="card-header">
          <div>
            <div class="card-title">2) Categories</div>
            <div class="card-subtitle">
              Logical segments of the road. Missions attach to these categories.
            </div>
          </div>
          <button id="newCategoryBtn" class="btn-ghost btn-small">+ New category</button>
        </div>

        <div class="field-group">
          <div class="field-label">Category name</div>
          <input id="catNameInput" type="text" placeholder="Basics – First Openers" />
        </div>

        <div class="field-group field-row">
          <div style="flex:1;">
            <div class="field-label">Code / tag</div>
            <input id="catCodeInput" type="text" placeholder="OPENERS" />
          </div>
          <div style="width:110px;">
            <div class="field-label">Min level</div>
            <input id="catMinLevelInput" type="number" min="1" value="1" />
          </div>
        </div>

        <div class="field-group">
          <div class="field-label">Subtitle / description</div>
          <input id="catSubtitleInput" type="text" placeholder="Start with simple, confident openers." />
        </div>

        <div class="row">
          <button id="saveCategoryBtn" class="btn-primary">Save category</button>
          <button id="deleteCategoryBtn" class="btn-danger btn-small">Delete</button>
        </div>

        <div class="divider"></div>

        <div class="field-label">Existing categories</div>
        <div class="category-list" id="categoryList"></div>
      </section>

      <!-- CENTER: Persona editor -->
      <section class="card" id="personaCard">
        <div class="card-header">
          <div>
            <div class="card-title">3) Personas</div>
            <div class="card-subtitle" id="personaModeLabel">
              Create a new persona or click one below to edit it.
            </div>
          </div>
          <div class="row">
            <button id="newPersonaBtn" class="btn-ghost btn-small">+ New persona</button>
          </div>
        </div>

        <div class="field-group field-row">
          <div style="flex:1;">
            <div class="field-label">Code</div>
            <input id="personaCodeInput" type="text" placeholder="MAYA_PLAYFUL" />
          </div>
          <div style="flex:1;">
            <div class="field-label">Name</div>
            <input id="personaNameInput" type="text" placeholder="Maya" />
          </div>
        </div>

        <div class="field-group field-row">
          <div style="flex:1;">
            <div class="field-label">Short label</div>
            <input id="personaShortLabelInput" type="text" placeholder="Playful, warm" />
          </div>
          <div style="width:140px;">
            <div class="field-label">Difficulty</div>
            <select id="personaDifficultySelect">
              <option value="1">1 – Easy</option>
              <option value="2">2 – Medium</option>
              <option value="3">3 – Hard</option>
              <option value="4">4 – Elite</option>
            </select>
          </div>
        </div>

        <div class="field-group">
          <div class="field-label">Description</div>
          <textarea id="personaDescriptionInput" placeholder="Short description for the persona."></textarea>
        </div>

        <div class="field-group field-row">
          <div style="flex:1;">
            <div class="field-label">Style</div>
            <input id="personaStyleInput" type="text" placeholder="Playful, teasing, warm" />
          </div>
          <div style="flex:1;">
            <div class="field-label">Avatar URL</div>
            <input id="personaAvatarInput" type="text" placeholder="https://…" />
          </div>
        </div>

        <div class="field-group field-row">
          <div style="flex:1;">
            <div class="field-label">Voice preset</div>
            <input id="personaVoicePresetInput" type="text" placeholder="female-soft-01" />
          </div>
          <div style="width:140px;">
            <div class="field-label">Active</div>
            <select id="personaActiveSelect">
              <option value="true">true</option>
              <option value="false">false</option>
            </select>
          </div>
        </div>

        <div class="row">
          <button id="savePersonaBtn" class="btn-primary">Save persona</button>
          <button id="deletePersonaBtn" class="btn-danger btn-small">Delete</button>
        </div>

        <div class="divider"></div>

        <div class="field-label">Existing personas</div>
        <div class="persona-list" id="personaList"></div>
      </section>

      <!-- RIGHT: Mission list + ordering -->
      <section class="card">
        <div class="card-header">
          <div>
            <div class="card-title">4) Mission Road ordering</div>
            <div class="card-subtitle">
              Drag & drop reorders inside the same lane bucket. You can also use ↑ / ↓.
              When you’re happy, press <b>Save ordering</b>.
            </div>
          </div>
          <button id="saveOrderingBtn" class="btn-primary btn-small">Save ordering</button>
        </div>

        <div class="inline-banner" id="orderingBanner">
          Ordering changed but not saved yet. Press <b>Save ordering</b> to persist.
        </div>

        <div class="search">
          <input id="missionSearchInput" type="text" placeholder="Search missions by title / code / category..." />
          <button id="normalizeOrderingBtn" class="btn-ghost btn-small" title="Re-index orderIndex per lane">
            Normalize
          </button>
        </div>

        <div class="missions-list" id="missionsList"></div>

        <div class="footer-row">
          <span id="missionsSummary">No missions loaded.</span>
          <div class="row">
            <button id="reloadAllBtn" class="btn-ghost btn-small">Reload from backend</button>
          </div>
        </div>
      </section>
    </main>

    <!-- BOTTOM: Mission + AI Contract editor (full width) -->
    <section class="card" id="missionCard" style="margin-top:14px;">
      <div class="card-header">
        <div>
          <div class="card-title">5) Mission &amp; AI Contract editor</div>
          <div class="card-subtitle" id="missionModeLabel">
            Create a new mission or click one on the right to edit it. The AI contract below will be saved together with the mission.
          </div>
        </div>
        <div class="row">
          <button id="duplicateMissionBtn" class="btn-ghost btn-small" title="Duplicate selected mission">
            Duplicate
          </button>
          <button id="newMissionBtn" class="btn-ghost btn-small">+ New mission</button>
        </div>
      </div>

      <!-- Basic mission data (MINIMAL) -->
      <div class="field-group">
        <div class="field-label">Mission title</div>
        <input id="missionTitleInput" type="text" placeholder="e.g. 'Open strong and lead the vibe'" />
        <div class="hint">Required. Code is optional (backend can generate it).</div>
      </div>

      <div class="field-group field-row">
        <div style="flex:1;">
          <div class="field-label">Category</div>
          <select id="missionCategorySelect"></select>
        </div>
        <div style="flex:1;">
          <div class="field-label">AI Persona</div>
          <select id="missionPersonaSelect"></select>
        </div>
      </div>

      <div class="field-group field-row">
        <div style="width:220px;">
          <div class="field-label">Difficulty</div>
          <select id="missionDifficultySelect">
            <option value="EASY">EASY</option>
            <option value="MEDIUM">MEDIUM</option>
            <option value="HARD">HARD</option>
            <option value="ELITE">BOSS (ELITE)</option>
          </select>
        </div>

        <div style="width:180px;">
          <div class="field-label">Active</div>
          <select id="missionActiveSelect">
            <option value="true">Yes</option>
            <option value="false">No</option>
          </select>
        </div>

        <div style="flex:1;">
          <div class="field-label">Code (optional)</div>
          <input id="missionCodeInput" type="text" placeholder="Optional. Leave blank for auto-code." />
        </div>
      </div>

      <div class="row" style="justify-content:flex-end;gap:8px;">
        <button id="deleteMissionBtn" class="btn btn-danger">Delete</button>
        <button id="saveMissionBtn" class="btn btn-primary">Save mission</button>
      </div>

      <div id="missionPreview" style="margin-top:10px;padding:12px;border-radius:12px;background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.08);">
        <div style="font-weight:800;margin-bottom:6px;color:rgba(255,255,255,0.9);">Preview</div>
        <div id="missionPreviewText" style="opacity:0.92;">No mission selected.</div>
        <div id="missionPreviewTags"></div>
      </div>

      <div class="divider"></div>

      <!-- AI CONTRACT JSON (single textarea) -->
      <div class="field-label" style="margin-bottom:6px;">AI Contract (JSON)</div>
      <div class="hint">
        Paste the full mission contract JSON here (this is what the AI will be fed). The backend will store it as JSON.
      </div>

      <div class="row" style="justify-content:flex-end;gap:8px;margin-top:8px;">
        <button id="validateAiContractBtn" class="btn btn-ghost">Validate JSON</button>
        <button id="formatAiContractBtn" class="btn btn-ghost">Format JSON</button>
      </div>

      <div class="field-group" style="margin-top:10px;">
        <textarea
          id="aiContractJsonTextarea"
          placeholder='{
  "systemPrompt": "...",
  "bannedMoves": [],
  "requiredMoves": []
}'
          style="min-height:360px;max-height:520px;font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,'Liberation Mono','Courier New',monospace;white-space:pre;"
        ></textarea>
      </div>
    </section>

<script>
const API_ROUTES = {
  listCategories: '/v1/admin/missions/categories',
  createCategory: '/v1/admin/missions/categories',
  updateCategory: (id) => '/v1/admin/missions/categories/' + id,
  deleteCategory: (id) => '/v1/admin/missions/categories/' + id,

  listMissions: '/v1/admin/missions',
  createMission: '/v1/admin/missions',
  updateMission: (id) => '/v1/admin/missions/' + id,
  deleteMission: (id) => '/v1/admin/missions/' + id,
  reorderMissions: '/v1/admin/missions/reorder',

  road: '/v1/admin/missions/road',
  listPersonas: '/v1/admin/missions/personas',
createPersona: '/v1/admin/missions/personas',
updatePersona: (id) => '/v1/admin/missions/personas/' + id,
deletePersona: (id) => '/v1/admin/missions/personas/' + id,


  meta: '/v1/admin/missions/meta',
};

const LS_KEYS = {
  baseUrl: 'sg_admin_baseUrl',
  token: 'sg_admin_token',
};

const state = {
  baseUrl: '',
  token: '',
  connected: false,

  categories: [],
  missions: [],
  personas: [],

  // snapshot for detecting category changes while dragging
  originalMissionCategoryById: {},

  selectedCategoryId: null,
  selectedMissionId: null,
  selectedPersonaId: null,

  orderingDirty: false,
  drag: { draggingId: null, overId: null },
  missionSearch: '',
};

const el = (id) => document.getElementById(id);

const ui = {
  // connection
  baseUrlInput: el('baseUrlInput'),
  tokenInput: el('tokenInput'),
  connectBtn: el('connectBtn'),
  clearBtn: el('clearBtn'),
  statusDot: el('statusDot'),
  statusText: el('statusText'),
  connDot: el('connDot'),
  connText: el('connText'),
  toastWrap: el('toastWrap'),

  // categories
  newCategoryBtn: el('newCategoryBtn'),
  catNameInput: el('catNameInput'),
  catCodeInput: el('catCodeInput'),
  catSubtitleInput: el('catSubtitleInput'),
  catMinLevelInput: el('catMinLevelInput'),
  saveCategoryBtn: el('saveCategoryBtn'),
  deleteCategoryBtn: el('deleteCategoryBtn'),
  categoryList: el('categoryList'),

  // personas
  newPersonaBtn: el('newPersonaBtn'),
  personaCodeInput: el('personaCodeInput'),
  personaNameInput: el('personaNameInput'),
  personaShortLabelInput: el('personaShortLabelInput'),
  personaDescriptionInput: el('personaDescriptionInput'),
  personaStyleInput: el('personaStyleInput'),
  personaAvatarInput: el('personaAvatarInput'),
  personaDifficultySelect: el('personaDifficultySelect'),
  personaActiveSelect: el('personaActiveSelect'),
  personaVoicePresetInput: el('personaVoicePresetInput'),
  savePersonaBtn: el('savePersonaBtn'),
  deletePersonaBtn: el('deletePersonaBtn'),
  personaList: el('personaList'),
  personaModeLabel: el('personaModeLabel'),

  // missions list + ordering
  missionsList: el('missionsList'),
  missionsSummary: el('missionsSummary'),
  missionSearchInput: el('missionSearchInput'),
  saveOrderingBtn: el('saveOrderingBtn'),
  normalizeOrderingBtn: el('normalizeOrderingBtn'),
  reloadAllBtn: el('reloadAllBtn'),
  orderingBanner: el('orderingBanner'),

     // mission form (MINIMAL)
  newMissionBtn: el('newMissionBtn'),
  duplicateMissionBtn: el('duplicateMissionBtn'),
  saveMissionBtn: el('saveMissionBtn'),
  deleteMissionBtn: el('deleteMissionBtn'),
  missionModeLabel: el('missionModeLabel'),

  missionCodeInput: el('missionCodeInput'),
  missionTitleInput: el('missionTitleInput'),
  missionCategorySelect: el('missionCategorySelect'),
  missionPersonaSelect: el('missionPersonaSelect'),
  missionDifficultySelect: el('missionDifficultySelect'),
  missionActiveSelect: el('missionActiveSelect'),

  missionPreview: el('missionPreview'),
  missionPreviewText: el('missionPreviewText'),
  missionPreviewTags: el('missionPreviewTags'),
 
    // AI contract JSON (single textarea)
    aiContractJsonTextarea: el('aiContractJsonTextarea'),
  formatAiContractBtn: el('formatAiContractBtn'),
  validateAiContractBtn: el('validateAiContractBtn'),

// ---------- helpers ----------
function setStatus(status, text) {
  ui.statusText.textContent = text;
  ui.connText.textContent = text;
  ui.statusDot.className = 'badge-dot';
  ui.connDot.className = 'status-dot';

  if (status === 'ok') {
    ui.statusDot.style.background = '#22c55e';
    ui.connDot.classList.add('status-ok');
  } else if (status === 'error') {
    ui.statusDot.style.background = '#ef4444';
    ui.connDot.classList.add('status-error');
  } else if (status === 'warning') {
    ui.statusDot.style.background = '#f59e0b';
    ui.connDot.classList.add('status-warning');
  } else {
    ui.statusDot.style.background = '#64748b';
    ui.connDot.classList.add('status-idle');
  }
}

function showToast(kind, title, msg) {
  const div = document.createElement('div');
  div.className = 'toast';

  const dot = document.createElement('div');
  dot.className = 'toast-dot';
  if (kind === 'ok') dot.style.background = '#22c55e';
  else if (kind === 'error') dot.style.background = '#ef4444';
  else dot.style.background = '#f59e0b';

  const body = document.createElement('div');
  const t = document.createElement('div');
  t.className = 'toast-title';
  t.textContent = title;
  const m = document.createElement('div');
  m.className = 'toast-msg';
  m.textContent = msg;
  body.appendChild(t);
  body.appendChild(m);

  const x = document.createElement('button');
  x.className = 'toast-x';
  x.innerHTML = '&times;';
  x.onclick = () => div.remove();

  div.appendChild(dot);
  div.appendChild(body);
  div.appendChild(x);

  ui.toastWrap.appendChild(div);
  setTimeout(() => div.remove(), 6000);
}

function saveLocal() {
  localStorage.setItem(LS_KEYS.baseUrl, state.baseUrl || '');
  localStorage.setItem(LS_KEYS.token, state.token || '');
}

function loadLocal() {
  const base = localStorage.getItem(LS_KEYS.baseUrl);
  const tok = localStorage.getItem(LS_KEYS.token);
  if (base) {
    state.baseUrl = base;
    ui.baseUrlInput.value = base;
  }
  if (tok) {
    state.token = tok;
    ui.tokenInput.value = tok;
  }
}

function buildUrl(path) {
  return (state.baseUrl || '').replace(/\/+$/, '') + path;
}

async function apiRequest(method, path, body) {
  if (!state.baseUrl || !state.token) {
    throw new Error('Missing base URL or token');
  }
  const res = await fetch(buildUrl(path), {
    method,
    headers: {
      'Content-Type': 'application/json',
      Authorization: 'Bearer ' + state.token,
    },
    body: body ? JSON.stringify(body) : undefined,
  });
  if (!res.ok) {
    const text = await res.text().catch(() => '');
    throw new Error('HTTP ' + res.status + ' – ' + text);
  }
  return res.status === 204 ? null : res.json();
}

const api = {
  get: (path) => apiRequest('GET', path),
  post: (path, body) => apiRequest('POST', path, body),
  put: (path, body) => apiRequest('PUT', path, body),
  patch: (path, body) => apiRequest('PATCH', path, body),
  delete: (path) => apiRequest('DELETE', path),
};


// ---------- rendering helpers ----------
function clearChildren(node) {
  while (node.firstChild) node.removeChild(node.firstChild);
}

function findCategory(id) {
  return state.categories.find((c) => c.id === id) || null;
}
function findPersona(id) {
  return state.personas.find((p) => p.id === id) || null;
}
function findMission(id) {
  return state.missions.find((m) => m.id === id) || null;
}

function linesToArray(value) {
  if (!value) return [];
  return value
    .split(/[\n,]/)
    .map((x) => x.trim())
    .filter(Boolean);
}

function arrayToLines(arr) {
  if (!arr || !arr.length) return '';
  return arr.join('\n');
}

// ---------- categories ----------
function renderCategories() {
  clearChildren(ui.categoryList);
  state.categories.sort((a, b) => (a.label || '').localeCompare(b.label || ''));
  state.categories.forEach((cat) => {
    const div = document.createElement('div');
    div.className = 'category-pill' + (cat.id === state.selectedCategoryId ? ' active' : '');
    div.onclick = () => selectCategory(cat.id);

    const main = document.createElement('div');
    main.className = 'category-pill-main';
    const name = document.createElement('div');
    name.className = 'category-pill-name';
    name.textContent = cat.label + (cat.code ? ' (' + cat.code + ')' : '');
    const meta = document.createElement('div');
    meta.className = 'category-pill-meta';
    meta.textContent = cat.description || '';
    main.appendChild(name);
    main.appendChild(meta);

    div.appendChild(main);
    ui.categoryList.appendChild(div);
  });
}

function selectCategory(id) {
  state.selectedCategoryId = id;
  const cat = findCategory(id);
  if (!cat) {
    ui.catNameInput.value = '';
    ui.catCodeInput.value = '';
    ui.catSubtitleInput.value = '';
    ui.catMinLevelInput.value = '1';
  } else {
    ui.catNameInput.value = cat.label || '';
    ui.catCodeInput.value = cat.code || '';
    ui.catSubtitleInput.value = cat.description || '';
    ui.catMinLevelInput.value = cat.minLevel || 1;
  }
  renderCategories();
  refreshMissionCategorySelect();
}

async function saveCategory() {
  const label = ui.catNameInput.value.trim();
  const code = ui.catCodeInput.value.trim();
  if (!label || !code) {
    showToast('warning', 'Missing data', 'Category name and code are required.');
    return;
  }
  const payload = {
    label,
    code,
    description: ui.catSubtitleInput.value.trim() || null,
    minLevel: Number(ui.catMinLevelInput.value || 1),
  };

  try {
    if (state.selectedCategoryId) {
      await api.put(API_ROUTES.updateCategory(state.selectedCategoryId), payload);
      showToast('ok', 'Category updated', label);
    } else {
      const res = await api.post(API_ROUTES.createCategory, payload);
      state.selectedCategoryId = res.id;
      showToast('ok', 'Category created', label);
    }
    await reloadMeta();
  } catch (e) {
    console.error(e);
    showToast('error', 'Category save failed', e.message);
  }
}

async function deleteCategory() {
  if (!state.selectedCategoryId) return;
  if (!confirm('Delete this category? Missions using it might break.')) return;
  try {
    await api.delete(API_ROUTES.deleteCategory(state.selectedCategoryId));
    state.selectedCategoryId = null;
    showToast('ok', 'Category deleted', '');
    await reloadMeta();
  } catch (e) {
    console.error(e);
    showToast('error', 'Delete failed', e.message);
  }
}

function newCategory() {
  state.selectedCategoryId = null;
  ui.catNameInput.value = '';
  ui.catCodeInput.value = '';
  ui.catSubtitleInput.value = '';
  ui.catMinLevelInput.value = '1';
  renderCategories();
}

// ---------- personas ----------
function renderPersonas() {
  clearChildren(ui.personaList);
  const personas = [...state.personas]
    .filter((p) => p && p.active !== false)
    .sort((a, b) => (a.name || '').localeCompare(b.name || ''));
  personas.forEach((p) => {
    const div = document.createElement('div');
    div.className = 'persona-pill' + (p.id === state.selectedPersonaId ? ' active' : '');
    div.onclick = () => selectPersona(p.id);

    const main = document.createElement('div');
    main.className = 'persona-pill-main';
    const name = document.createElement('div');
    name.className = 'persona-pill-name';
    name.textContent = (p.name || 'Unnamed') + (p.code ? ' (' + p.code + ')' : '');
    const meta = document.createElement('div');
    meta.className = 'persona-pill-meta';
    meta.textContent = (p.shortLabel || '').slice(0, 80);
    main.appendChild(name);
    main.appendChild(meta);

    div.appendChild(main);
    ui.personaList.appendChild(div);
  });

  refreshMissionPersonaSelect();
}

function selectPersona(id) {
  state.selectedPersonaId = id;
  const p = findPersona(id);
  if (!p) {
    ui.personaModeLabel.textContent = 'Create a new persona.';
    ui.personaCodeInput.value = '';
    ui.personaNameInput.value = '';
    ui.personaShortLabelInput.value = '';
    ui.personaDescriptionInput.value = '';
    ui.personaStyleInput.value = '';
    ui.personaAvatarInput.value = '';
    ui.personaDifficultySelect.value = '1';
    ui.personaActiveSelect.value = 'true';
    ui.personaVoicePresetInput.value = '';
  } else {
    ui.personaModeLabel.textContent = 'Editing persona: ' + (p.name || '');
    ui.personaCodeInput.value = p.code || '';
    ui.personaNameInput.value = p.name || '';
    ui.personaShortLabelInput.value = p.shortLabel || '';
    ui.personaDescriptionInput.value = p.description || '';
    ui.personaStyleInput.value = p.style || '';
    ui.personaAvatarInput.value = p.avatarUrl || '';
    ui.personaDifficultySelect.value = String(p.difficulty || 1);
    ui.personaActiveSelect.value = String(p.active !== false);
    ui.personaVoicePresetInput.value = p.voicePreset || '';
  }
  renderPersonas();
  refreshMissionPersonaSelect();
}

function newPersona() {
  state.selectedPersonaId = null;
  selectPersona(null);
}

async function savePersona() {
  const code = ui.personaCodeInput.value.trim();
  const name = ui.personaNameInput.value.trim();
  if (!code || !name) {
    showToast('warning', 'Missing data', 'Persona code and name are required.');
    return;
  }
  const payload = {
    code,
    name,
    shortLabel: ui.personaShortLabelInput.value.trim() || null,
    description: ui.personaDescriptionInput.value.trim() || null,
    style: ui.personaStyleInput.value.trim() || null,
    avatarUrl: ui.personaAvatarInput.value.trim() || null,
    difficulty: Number(ui.personaDifficultySelect.value || 1),
    active: ui.personaActiveSelect.value !== 'false',
    voicePreset: ui.personaVoicePresetInput.value.trim() || null,
  };
  try {
    if (state.selectedPersonaId) {
      await api.put(API_ROUTES.updatePersona(state.selectedPersonaId), payload);
      showToast('ok', 'Persona updated', name);
    } else {
      const res = await api.post(API_ROUTES.createPersona, payload);
      state.selectedPersonaId = res.id;
      showToast('ok', 'Persona created', name);
    }
    await reloadMeta();
  } catch (e) {
    console.error(e);
    showToast('error', 'Persona save failed', e.message);
  }
}

async function deletePersona() {
  if (!state.selectedPersonaId) return;
  if (!confirm('Delete this persona? Missions using it may fail.')) return;
  try {
    await api.delete(API_ROUTES.deletePersona(state.selectedPersonaId));
    state.selectedPersonaId = null;
    showToast('ok', 'Persona deleted', '');
    await reloadMeta();
  } catch (e) {
    console.error(e);
    showToast('error', 'Persona delete failed', e.message);
  }
}

// ---------- missions list ----------
function refreshMissionCategorySelect() {
  const prev = ui.missionCategorySelect.value;
  clearChildren(ui.missionCategorySelect);
  const optEmpty = document.createElement('option');
  optEmpty.value = '';
  optEmpty.textContent = '– choose category –';
  ui.missionCategorySelect.appendChild(optEmpty);

  state.categories.forEach((cat) => {
    const o = document.createElement('option');
    o.value = cat.id;
    o.textContent = cat.label || cat.code || 'Category';
    ui.missionCategorySelect.appendChild(o);
  });
  if (prev) ui.missionCategorySelect.value = prev;
}

function escapeHtml(value) {
  const s = String(value ?? '');
  return s.replace(/[&<>"'`=\/]/g, (ch) => {
    switch (ch) {
      case '&': return '&amp;';
      case '<': return '&lt;';
      case '>': return '&gt;';
      case '"': return '&quot;';
      case "'": return '&#39;';
      case '`': return '&#96;';
      case '=': return '&#61;';
      case '/': return '&#47;';
      default: return ch;
    }
  });
}


function refreshMissionPersonaSelect() {
  const prev = ui.missionPersonaSelect.value;
  clearChildren(ui.missionPersonaSelect);
  const optEmpty = document.createElement('option');
  optEmpty.value = '';
  optEmpty.textContent = '– choose persona –';
  ui.missionPersonaSelect.appendChild(optEmpty);

  state.personas.forEach((p) => {
    const o = document.createElement('option');
    o.value = p.id;
    o.textContent = p.name || p.code || 'Persona';
    ui.missionPersonaSelect.appendChild(o);
  });
  if (prev) ui.missionPersonaSelect.value = prev;
}


function isReorderEnabled() {
  return !(state.missionSearch || '').trim().length;
}

function markOrderingDirty(message) {
  state.orderingDirty = true;
  ui.orderingBanner.classList.add('show');
  if (message) {
    ui.orderingBanner.innerHTML =
      `${escapeHtml(message)} <span style="opacity:.9">Press <b>Save ordering</b> to persist.</span>`;
  }
}

function updateMissionsSummary() {
  const missions = Array.isArray(state.missions) ? state.missions : [];
  ui.missionsSummary.textContent = missions.length
    ? `${missions.length} missions loaded.`
    : 'No missions loaded.';
}

function buildLaneDom(laneIndex, laneMissions) {
  const laneWrap = document.createElement('div');
  laneWrap.className = 'lane';
  laneWrap.dataset.lane = String(laneIndex);

  const top = document.createElement('div');
  top.className = 'lane-titlebar';

  const left = document.createElement('div');
  left.style.display = 'flex';
  left.style.alignItems = 'center';
  left.style.gap = '10px';

  const name = document.createElement('div');
  name.className = 'lane-name';
  name.textContent = `Lane ${laneIndex}`;

  const count = document.createElement('div');
  count.className = 'lane-count';
  count.textContent = `${laneMissions.length} missions`;

  left.appendChild(name);
  left.appendChild(count);

  const hint = document.createElement('div');
  hint.className = 'hint-chip';
  hint.innerHTML = `<span style="font-weight:900">Tip:</span> drag a mission by grabbing it anywhere. Drag category headers too.`;

  top.appendChild(left);
  top.appendChild(hint);

  laneWrap.appendChild(top);

  // Group by category in this lane
  const groups = new Map();
  function groupKey(m) {
    return m.categoryId || '__UNCAT__';
  }
  for (const m of laneMissions) {
    const k = groupKey(m);
    if (!groups.has(k)) groups.set(k, []);
    groups.get(k).push(m);
  }

  // Determine category order by min orderIndex in each group
  const orderedKeys = Array.from(groups.keys()).sort((a, b) => {
    const aMin = Math.min(
      ...groups.get(a).map((m) => (typeof m.orderIndex === 'number' ? m.orderIndex : 0)),
    );
    const bMin = Math.min(
      ...groups.get(b).map((m) => (typeof m.orderIndex === 'number' ? m.orderIndex : 0)),
    );
    return aMin - bMin;
  });

  // Make sure uncategorized goes last (unless it's the only one)
  if (orderedKeys.includes('__UNCAT__') && orderedKeys.length > 1) {
    const rest = orderedKeys.filter((k) => k !== '__UNCAT__');
    rest.push('__UNCAT__');
    orderedKeys.length = 0;
    rest.forEach((k) => orderedKeys.push(k));
  }

  orderedKeys.forEach((categoryId) => {
    const cat = categoryId === '__UNCAT__' ? null : findCategory(categoryId);
    const label =
      categoryId === '__UNCAT__'
        ? 'Uncategorized'
        : (cat?.label || cat?.code || 'Unknown category');

    const section = document.createElement('div');
    section.className = 'cat-section';
    section.dataset.lane = String(laneIndex);
    section.dataset.cat = categoryId;

    const header = document.createElement('div');
    header.className = 'cat-header';
    header.dataset.role = 'cat-header';
    header.innerHTML = `
      <div class="cat-left">
        <div class="cat-chip">
          <span class="cat-handle">≡</span>
          <span style="white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:340px;">${escapeHtml(label)}</span>
        </div>
        <div class="cat-sub">${groups.get(categoryId).length} missions</div>
      </div>
      <div style="opacity:.65;font-size:12px;">Drag category • Drop missions inside</div>
    `;

    const body = document.createElement('div');
    body.className = 'cat-body';

    const list = [...groups.get(categoryId)].sort((a, b) => {
      const oa = typeof a.orderIndex === 'number' ? a.orderIndex : 0;
      const ob = typeof b.orderIndex === 'number' ? b.orderIndex : 0;
      return oa - ob;
    });

    list.forEach((m) => {
      const row = document.createElement('div');
      row.className = 'mission-row';
      row.dataset.missionId = m.id;

      if (state.selectedMissionId === m.id) row.classList.add('active');

      const main = document.createElement('div');
      main.className = 'mission-main';

      const title = document.createElement('div');
      title.className = 'mission-title';
      title.textContent = m.title || '(no title)';

      const meta = document.createElement('div');
      meta.className = 'mission-meta';

      const persona = findPersona(m.personaId);

      const pills = [];
      pills.push(`Lane ${m.laneIndex ?? 0} · #${m.orderIndex ?? 0}`);
      // Label is implied by group (category), but we still show it
      pills.push(label);
      if (persona) pills.push(persona.name || '');
      if (m.goalType) pills.push(`Goal: ${m.goalType}`);
      if (m.difficulty) pills.push(`Diff: ${m.difficulty}`);

      meta.innerHTML = pills
        .filter(Boolean)
        .map((p) => `<span>${escapeHtml(p)}</span>`)
        .join('');

      main.appendChild(title);
      main.appendChild(meta);

      const controls = document.createElement('div');
      controls.className = 'mission-controls';

      const btnDelete = document.createElement('button');
      btnDelete.className = 'btn-ghost btn-small btn-icon btn-icon-danger';
      btnDelete.title = 'Delete mission (soft delete)';
      btnDelete.textContent = '🗑';
      btnDelete.onclick = async (ev) => {
        ev.stopPropagation();
        await deleteMissionById(m.id);
      };

      // keep arrows as backup
      const btnUp = document.createElement('button');
      btnUp.className = 'btn-ghost btn-small btn-icon';
      btnUp.textContent = '↑';
      btnUp.title = 'Move up';
      btnUp.onclick = (ev) => {
        ev.stopPropagation();
        moveMission(m.id, -1);
      };

      const btnDown = document.createElement('button');
      btnDown.className = 'btn-ghost btn-small btn-icon';
      btnDown.textContent = '↓';
      btnDown.title = 'Move down';
      btnDown.onclick = (ev) => {
        ev.stopPropagation();
        moveMission(m.id, 1);
      };

      controls.appendChild(btnUp);
      controls.appendChild(btnDown);
      controls.appendChild(btnDelete);

      row.appendChild(main);
      row.appendChild(controls);

      row.onclick = () => selectMission(m.id);

      body.appendChild(row);
    });

    section.appendChild(header);
    section.appendChild(body);
    laneWrap.appendChild(section);
  });

  return laneWrap;
}

function renderMissions() {
  clearChildren(ui.missionsList);

  const source = Array.isArray(state.missions) ? state.missions : [];
  const term = (state.missionSearch || '').toLowerCase().trim();

  // Sort stable by lane+order
  let missions = [...source].sort((a, b) => {
    const laneA = typeof a.laneIndex === 'number' ? a.laneIndex : 0;
    const laneB = typeof b.laneIndex === 'number' ? b.laneIndex : 0;
    if (laneA !== laneB) return laneA - laneB;

    const orderA = typeof a.orderIndex === 'number' ? a.orderIndex : 0;
    const orderB = typeof b.orderIndex === 'number' ? b.orderIndex : 0;
    return orderA - orderB;
  });

  // Search filter (visual only). We disable drag while searching to avoid corrupt reorder.
  if (term) {
    missions = missions.filter((m) => {
      const cat = findCategory(m.categoryId);
      const persona = findPersona(m.personaId);
      return (
        (m.title || '').toLowerCase().includes(term) ||
        (m.code || '').toLowerCase().includes(term) ||
        ((cat && (cat.label || cat.code || '')).toLowerCase().includes(term)) ||
        ((persona && (persona.name || '')).toLowerCase().includes(term))
      );
    });

    ui.orderingBanner.classList.add('show');
    ui.orderingBanner.innerHTML =
      `Search is active — reordering is temporarily disabled. Clear the search to drag & drop.`;
  } else if (state.orderingDirty) {
    ui.orderingBanner.classList.add('show');
    ui.orderingBanner.innerHTML =
      `Ordering changed but not saved yet. Press <b>Save ordering</b> to persist.`;
  } else {
    ui.orderingBanner.classList.remove('show');
  }

  if (!missions.length) {
    ui.missionsSummary.textContent = term ? 'No matching missions.' : 'No missions loaded.';
    return;
  }

  // Group by lane
  const byLane = new Map();
  for (const m of missions) {
    const lane = typeof m.laneIndex === 'number' ? m.laneIndex : 0;
    if (!byLane.has(lane)) byLane.set(lane, []);
    byLane.get(lane).push(m);
  }

  Array.from(byLane.keys())
    .sort((a, b) => a - b)
    .forEach((lane) => {
      const laneMissions = byLane.get(lane) || [];
      const laneDom = buildLaneDom(lane, laneMissions);
      ui.missionsList.appendChild(laneDom);
    });

  ui.missionsSummary.textContent = `${missions.length} missions loaded.`;
}

function moveMission(id, delta) {
  const m = findMission(id);
  if (!m) return;
  const lane = m.laneIndex ?? 0;
  const laneMissions = state.missions
    .filter((x) => (x.laneIndex ?? 0) === lane)
    .sort((a, b) => (a.orderIndex ?? 0) - (b.orderIndex ?? 0));

  const idx = laneMissions.findIndex((x) => x.id === id);
  const swapWith = laneMissions[idx + delta];
  if (!swapWith) return;

  const tmp = m.orderIndex ?? 0;
  m.orderIndex = swapWith.orderIndex ?? 0;
  swapWith.orderIndex = tmp;

  normalizeOrdering();
  markOrderingDirty();
  renderMissions();
}

function normalizeOrdering() {
  const byLane = new Map();
  (state.missions || []).forEach((m) => {
    const lane = m.laneIndex ?? 0;
    if (!byLane.has(lane)) byLane.set(lane, []);
    byLane.get(lane).push(m);
  });

  byLane.forEach((list) => {
    list
      .sort((a, b) => (a.orderIndex ?? 0) - (b.orderIndex ?? 0))
      .forEach((m, i) => {
        m.orderIndex = i; // 0-based for safety
      });
  });
}

function syncStateFromDOM() {
  const missions = Array.isArray(state.missions) ? state.missions : [];
  const byId = new Map(missions.map((m) => [m.id, m]));

  const laneEls = ui.missionsList.querySelectorAll('.lane');
  laneEls.forEach((laneEl) => {
    const lane = Number(laneEl.dataset.lane || 0);
    let order = 0;

    const catEls = laneEl.querySelectorAll('.cat-section');
    catEls.forEach((catEl) => {
      const catKey = catEl.dataset.cat || '__UNCAT__';
      const body = catEl.querySelector('.cat-body');
      const rows = body ? body.querySelectorAll('.mission-row') : [];

      rows.forEach((row) => {
        const id = row.dataset.missionId;
        if (!id) return;
        const m = byId.get(id);
        if (!m) return;

        m.laneIndex = lane;

        if (catKey === '__UNCAT__') {
          // NOTE: backend can't "disconnect" category with current DTO transforms.
          // We'll keep it null in state, but saving will NOT remove category if it had one.
          m.categoryId = m.categoryId ?? null;
        } else {
          m.categoryId = catKey;
        }

        m.orderIndex = order++;
      });
    });
  });
}

async function deleteMissionById(id) {
  const m = findMission(id);
  const label = m?.title || m?.code || id;
  if (!confirm(`Delete mission: "${label}"?\n\nThis is a soft delete (active=false).`)) return;

  try {
    await api.delete(API_ROUTES.deleteMission(id));
    if (state.selectedMissionId === id) state.selectedMissionId = null;
    showToast('ok', 'Mission deleted', '');
    await reloadMissions();
    clearMissionForm();
  } catch (e) {
    console.error(e);
    showToast('error', 'Mission delete failed', e.message);
  }
}

async function saveOrdering() {
  if (!state.orderingDirty) return;

  // ensure state matches current DOM
  try {
    syncStateFromDOM();
  } catch (e) {
    console.warn('syncStateFromDOM failed, proceeding with state order', e);
  }

  // persist category changes first (if any)
  const original = state.originalMissionCategoryById || {};
  const changed = (state.missions || []).filter((m) => {
    const before = original[m.id] ?? null;
    const now = m.categoryId ?? null;
    return before !== now && now !== null; // cannot disconnect to null with current backend DTO
  });

  const skippedToNull = (state.missions || []).filter((m) => {
    const before = original[m.id] ?? null;
    const now = m.categoryId ?? null;
    return before !== now && now === null;
  });

  try {
    for (const m of changed) {
      await api.patch(API_ROUTES.updateMission(m.id), { categoryId: m.categoryId });
      original[m.id] = m.categoryId ?? null;
    }

    if (skippedToNull.length) {
      showToast(
        'warning',
        'Note',
        'Some missions were dropped into "Uncategorized". The backend currently cannot remove a category assignment via this dashboard, so those changes were not saved.',
      );
    }

    const items = (state.missions || []).map((m) => ({
      id: m.id,
      laneIndex: m.laneIndex ?? 0,
      orderIndex: m.orderIndex ?? 0,
    }));

    await api.post(API_ROUTES.reorderMissions, { items });

    state.orderingDirty = false;
    ui.orderingBanner.classList.remove('show');
    showToast('ok', 'Ordering saved', 'Mission road updated.');
    await reloadMissions();
  } catch (e) {
    console.error(e);
    showToast('error', 'Save ordering failed', e.message);
  }
}

// ---------- Mission Road Drag & Drop (pointer-based; no HTML5 DnD) ----------
const roadDnD = {
  installed: false,
  mode: null, // 'mission' | 'category'
  pointerId: null,
  startX: 0,
  startY: 0,
  currentX: 0,
  currentY: 0,
  threshold: 6,
  sourceEl: null,
  ghostEl: null,
  placeholderEl: null,
  dragging: false,
  pendingClickMissionId: null,
};

function setupMissionRoadDnD() {
  if (roadDnD.installed) return;
  roadDnD.installed = true;

  ui.missionsList.addEventListener('pointerdown', (ev) => {
    if (!isReorderEnabled()) return;

    // ignore clicks on buttons/inputs
    if (ev.target && ev.target.closest && ev.target.closest('button, input, textarea, select, a')) return;

    const catHeader = ev.target.closest ? ev.target.closest('.cat-header') : null;
    const missionRow = ev.target.closest ? ev.target.closest('.mission-row') : null;

    if (catHeader) {
      const catSection = catHeader.closest('.cat-section');
      const laneEl = catHeader.closest('.lane');
      if (!catSection || !laneEl) return;

      roadDnD.mode = 'category';
      roadDnD.sourceEl = catSection;
      roadDnD.pointerId = ev.pointerId;
      roadDnD.startX = ev.clientX;
      roadDnD.startY = ev.clientY;
      roadDnD.currentX = ev.clientX;
      roadDnD.currentY = ev.clientY;
      roadDnD.dragging = false;

      catHeader.setPointerCapture(ev.pointerId);
      ev.preventDefault();
      return;
    }

    if (missionRow) {
      roadDnD.mode = 'mission';
      roadDnD.sourceEl = missionRow;
      roadDnD.pointerId = ev.pointerId;
      roadDnD.startX = ev.clientX;
      roadDnD.startY = ev.clientY;
      roadDnD.currentX = ev.clientX;
      roadDnD.currentY = ev.clientY;
      roadDnD.dragging = false;
      roadDnD.pendingClickMissionId = missionRow.dataset.missionId || null;

      missionRow.setPointerCapture(ev.pointerId);
      ev.preventDefault();
    }
  });

  window.addEventListener('pointermove', (ev) => {
    if (!roadDnD.mode || roadDnD.pointerId !== ev.pointerId) return;
    roadDnD.currentX = ev.clientX;
    roadDnD.currentY = ev.clientY;

    const dx = roadDnD.currentX - roadDnD.startX;
    const dy = roadDnD.currentY - roadDnD.startY;
    const dist = Math.sqrt(dx * dx + dy * dy);

    if (!roadDnD.dragging && dist >= roadDnD.threshold) {
      startDrag();
    }

    if (!roadDnD.dragging) return;

    moveGhost(ev.clientX, ev.clientY);

    if (roadDnD.mode === 'mission') {
      updateMissionPlaceholder(ev.clientX, ev.clientY);
    } else if (roadDnD.mode === 'category') {
      updateCategoryPlaceholder(ev.clientX, ev.clientY);
    }
  }, { passive: true });

  window.addEventListener('pointerup', (ev) => {
    if (!roadDnD.mode || roadDnD.pointerId !== ev.pointerId) return;

    if (!roadDnD.dragging && roadDnD.mode === 'mission' && roadDnD.pendingClickMissionId) {
      // Treat as click
      selectMission(roadDnD.pendingClickMissionId);
    }

    if (roadDnD.dragging) {
      finishDrag();
    }

    resetDnD();
  });
}

function startDrag() {
  if (!roadDnD.sourceEl) return;
  roadDnD.dragging = true;

  // Ghost clone
  const ghost = roadDnD.sourceEl.cloneNode(true);
  ghost.classList.add('drag-ghost');
  roadDnD.ghostEl = ghost;
  document.body.appendChild(ghost);

  roadDnD.sourceEl.classList.add('dragging-source');

  // Placeholder
  const ph = document.createElement('div');
  ph.className = 'drop-placeholder' + (roadDnD.mode === 'category' ? ' compact' : '');
  roadDnD.placeholderEl = ph;

  if (roadDnD.mode === 'mission') {
    // insert placeholder right after source row initially
    roadDnD.sourceEl.parentElement.insertBefore(ph, roadDnD.sourceEl.nextSibling);
  } else {
    // category placeholder goes after the category initially
    roadDnD.sourceEl.parentElement.insertBefore(ph, roadDnD.sourceEl.nextSibling);
  }

  moveGhost(roadDnD.currentX, roadDnD.currentY);
}

function moveGhost(x, y) {
  if (!roadDnD.ghostEl) return;
  roadDnD.ghostEl.style.left = Math.max(12, x - 24) + 'px';
  roadDnD.ghostEl.style.top = Math.max(12, y - 24) + 'px';
}

function updateMissionPlaceholder(x, y) {
  if (!roadDnD.placeholderEl || !roadDnD.sourceEl) return;

  const el = document.elementFromPoint(x, y);
  if (!el) return;

  const targetRow = el.closest ? el.closest('.mission-row') : null;
  const targetBody = el.closest ? el.closest('.cat-body') : null;
  const targetSection = el.closest ? el.closest('.cat-section') : null;

  // Identify target category section (must exist)
  const section = targetSection || (targetBody ? targetBody.closest('.cat-section') : null);
  if (!section) return;

  const targetCat = section.dataset.cat || '__UNCAT__';
  const movingId = roadDnD.sourceEl.dataset.missionId;
  const movingMission = findMission(movingId);

  // Disallow dropping into Uncategorized if mission previously had a category (backend can't disconnect)
  if (targetCat === '__UNCAT__' && movingMission && movingMission.categoryId) {
    return;
  }

  const body = section.querySelector('.cat-body');
  if (!body) return;

  // If hovering a row, insert before/after based on pointer position
  if (targetRow && targetRow !== roadDnD.sourceEl) {
    const rect = targetRow.getBoundingClientRect();
    const before = y < rect.top + rect.height / 2;
    body.insertBefore(roadDnD.placeholderEl, before ? targetRow : targetRow.nextSibling);
    return;
  }

  // else append to end of body
  body.appendChild(roadDnD.placeholderEl);
}

function updateCategoryPlaceholder(x, y) {
  if (!roadDnD.placeholderEl || !roadDnD.sourceEl) return;

  const el = document.elementFromPoint(x, y);
  if (!el) return;

  const laneEl = el.closest ? el.closest('.lane') : null;
  if (!laneEl) return;

  // Keep category drag within the same lane to avoid ambiguity
  const sourceLaneEl = roadDnD.sourceEl.closest('.lane');
  if (!sourceLaneEl || sourceLaneEl !== laneEl) return;

  const targetSection = el.closest ? el.closest('.cat-section') : null;
  if (!targetSection || targetSection === roadDnD.sourceEl) {
    // append to end if hovering empty lane area
    laneEl.appendChild(roadDnD.placeholderEl);
    return;
  }

  const rect = targetSection.getBoundingClientRect();
  const before = y < rect.top + rect.height / 2;
  laneEl.insertBefore(roadDnD.placeholderEl, before ? targetSection : targetSection.nextSibling);
}

function finishDrag() {
  if (!roadDnD.placeholderEl || !roadDnD.sourceEl) return;

  // Move real element into placeholder position
  const parent = roadDnD.placeholderEl.parentElement;
  if (!parent) return;

  parent.insertBefore(roadDnD.sourceEl, roadDnD.placeholderEl);
  roadDnD.placeholderEl.remove();

  // Update state based on DOM order and rerender
  syncStateFromDOM();
  markOrderingDirty('Ordering changed.');
  renderMissions();
}

function resetDnD() {
  roadDnD.mode = null;
  roadDnD.pointerId = null;
  roadDnD.startX = 0;
  roadDnD.startY = 0;
  roadDnD.currentX = 0;
  roadDnD.currentY = 0;
  roadDnD.pendingClickMissionId = null;
  roadDnD.dragging = false;

  if (roadDnD.sourceEl) roadDnD.sourceEl.classList.remove('dragging-source');
  roadDnD.sourceEl = null;

  if (roadDnD.placeholderEl && roadDnD.placeholderEl.parentElement) roadDnD.placeholderEl.remove();
  roadDnD.placeholderEl = null;

  if (roadDnD.ghostEl && roadDnD.ghostEl.parentElement) roadDnD.ghostEl.remove();
  roadDnD.ghostEl = null;
}


// ---------- mission form + AI contract ----------
function selectMission(id) {
  state.selectedMissionId = id;
  const m = findMission(id);
  if (!m) {
    ui.missionModeLabel.textContent =
      'Create a new mission or click one on the right to edit it.';
    clearMissionForm();
    return;
  }

  ui.missionModeLabel.textContent = 'Editing mission: ' + (m.title || m.code);

  ui.missionCodeInput.value = m.code || '';
  ui.missionTitleInput.value = m.title || '';

  ui.missionCategorySelect.value = m.categoryId || '';
  ui.missionPersonaSelect.value = m.personaId || '';
  ui.missionDifficultySelect.value = m.difficulty || 'EASY';
  ui.missionActiveSelect.value = m.active === false ? 'false' : 'true';

  setAiContractTextarea(m.aiContract || null);

  updateMissionPreview();
  renderMissions();
}

function clearMissionForm() {
  state.selectedMissionId = null;

  ui.missionCodeInput.value = '';
  ui.missionTitleInput.value = '';
  ui.missionCategorySelect.value = '';
  ui.missionPersonaSelect.value = '';
  ui.missionDifficultySelect.value = 'EASY';
  ui.missionActiveSelect.value = 'true';

  setAiContractTextarea(null);

  ui.missionModeLabel.textContent = 'Create a new mission';
  updateMissionPreview();
  renderMissions();
}

function duplicateMission() {
  const id = state.selectedMissionId;
  const m = id ? findMission(id) : null;

  state.selectedMissionId = null;
  ui.missionModeLabel.textContent = m
    ? `Duplicating: ${m.title || m.code}`
    : 'Duplicating: (no mission selected)';

  ui.missionCodeInput.value = '';
  ui.missionTitleInput.value = m ? `${m.title || 'Untitled'} (copy)` : '';
  ui.missionCategorySelect.value = m?.categoryId || '';
  ui.missionPersonaSelect.value = m?.personaId || '';
  ui.missionDifficultySelect.value = m?.difficulty || 'EASY';
  ui.missionActiveSelect.value = m?.active === false ? 'false' : 'true';

  setAiContractTextarea(m?.aiContract || null);

  updateMissionPreview();
  renderMissions();
}

function getMissionFormValues() {
  const title = ui.missionTitleInput.value.trim();
  if (!title) {
    throw new Error('Mission title is required.');
  }

  const code = (ui.missionCodeInput.value || '').trim();
  const categoryId = ui.missionCategorySelect.value || undefined;
  const personaId = ui.missionPersonaSelect.value || undefined;

  const difficulty = ui.missionDifficultySelect.value || 'EASY';
  const active = ui.missionActiveSelect.value !== 'false';

  const aiContract = getAiContractJsonOrNull(); // null if empty

  const payload = {
    ...(code ? { code } : {}),
    name: title, // backend supports "name" or "title"
    ...(categoryId ? { categoryId } : {}),
    ...(personaId ? { personaId } : {}),
    difficulty,
    active,
    aiContract, // object or null
  };

  return payload;
}

function updateMissionPreview() {
  const title = (ui.missionTitleInput.value || '').trim();
  const code = (ui.missionCodeInput.value || '').trim();
  const difficulty = ui.missionDifficultySelect.value || 'EASY';
  const active = ui.missionActiveSelect.value !== 'false';

  let contractState = 'empty';
  const raw = (ui.aiContractJsonTextarea?.value || '').trim();
  if (raw) {
    try {
      JSON.parse(raw);
      contractState = 'valid';
    } catch {
      contractState = 'INVALID JSON';
    }
  }

  ui.missionPreviewText.textContent =
    (title ? title : '(no title)') + (code ? ` • ${code}` : '');

  ui.missionPreviewTags.innerHTML = '';
  const tags = [
    `Difficulty: ${difficulty}`,
    `Active: ${active ? 'yes' : 'no'}`,
    `AI contract: ${contractState}`,
  ];
  tags.forEach((t) => {
    const span = document.createElement('span');
    span.className = 'tag';
    span.textContent = t;
    ui.missionPreviewTags.appendChild(span);
  });
}

// ---------- AI contract JSON (single textarea) ----------

function getAiContractJsonOrNull() {
  const raw = (ui.aiContractJsonTextarea?.value || '').trim();
  if (!raw) return null;
  try {
    return JSON.parse(raw);
  } catch (e) {
    throw new Error('AI Contract JSON is invalid: ' + (e?.message || 'parse error'));
  }
}

function setAiContractTextarea(contract) {
  if (!ui.aiContractJsonTextarea) return;
  if (!contract) {
    ui.aiContractJsonTextarea.value = '';
    return;
  }
  try {
    ui.aiContractJsonTextarea.value = JSON.stringify(contract, null, 2);
  } catch {
    ui.aiContractJsonTextarea.value = String(contract);
  }
}

function validateAiContractJson(showOkToast = true) {
  const raw = (ui.aiContractJsonTextarea?.value || '').trim();
  if (!raw) {
    showToast('AI Contract is empty (that’s allowed).', 'info');
    return true;
  }
  try {
    JSON.parse(raw);
    if (showOkToast) showToast('AI Contract JSON is valid ✅', 'success');
    return true;
  } catch (e) {
    showToast('AI Contract JSON invalid ❌: ' + (e?.message || 'parse error'), 'error');
    return false;
  }
}

function formatAiContractJson() {
  const json = getAiContractJsonOrNull();
  if (!json) {
    showToast('Nothing to format (AI Contract is empty).', 'info');
    return;
  }
  setAiContractTextarea(json);
  showToast('Formatted AI Contract JSON ✅', 'success');
}

// ---------- mission save/delete ----------
async function saveMission() {
  let mission;
  try {
    mission = getMissionFormValues();
  } catch (e) {
    showToast('warning', 'Missing mission data', e.message);
    return;
  }
  const isUpdate = !!state.selectedMissionId;
  try {
    let res;
    if (isUpdate) {
      res = await api.put(
        API_ROUTES.updateMission(state.selectedMissionId),
        mission
      );
    } else {
      res = await api.post(API_ROUTES.createMission, mission);
      state.selectedMissionId = res.id;
    }
    showToast('ok', isUpdate ? 'Mission updated' : 'Mission created', mission.title);
    await reloadMissions();
    if (res?.id) selectMission(res.id);
  } catch (e) {
    console.error(e);
    showToast('error', 'Mission save failed', e.message);
  }
}

async function deleteMission() {
  if (!state.selectedMissionId) return;
  if (!confirm('Delete this mission?')) return;
  try {
    await api.delete(API_ROUTES.deleteMission(state.selectedMissionId));
    state.selectedMissionId = null;
    showToast('ok', 'Mission deleted', '');
    await reloadMissions();
    clearMissionForm();
  } catch (e) {
    console.error(e);
    showToast('error', 'Mission delete failed', e.message);
  }
}

// ---------- data loading ----------
async function reloadMeta() {
  const meta = await api.get(API_ROUTES.meta);
  state.categories = meta.categories || [];
  state.personas = meta.personas || [];
  renderCategories();
  renderPersonas();
  refreshMissionCategorySelect();
  refreshMissionPersonaSelect();
}

async function reloadMissions(showToastOnError = true) {
  try {
    setStatus('warning', 'Loading missions…');

    const extract = (res) => {
      if (!res) return [];
      if (Array.isArray(res)) return res;
      if (typeof res !== 'object') return [];

      // Common shapes across iterations
      if (Array.isArray(res.templates)) return res.templates;
      if (Array.isArray(res.missions)) return res.missions;
      if (Array.isArray(res.items)) return res.items;

      // Some wrappers may nest templates under { data: { templates: [...] } }
      if (res.data && typeof res.data === 'object') {
        if (Array.isArray(res.data.templates)) return res.data.templates;
        if (Array.isArray(res.data.missions)) return res.data.missions;
        if (Array.isArray(res.data.items)) return res.data.items;
      }

      return [];
    };


       // Prefer the active-only road endpoint for Step 4 ordering.
    // Fallback to the flat admin list only if road is empty or fails.
    let roadRes = null;
    let listRes = null;

    try {
      roadRes = await api.get(API_ROUTES.road); // /v1/admin/missions/road (active=true)
    } catch (e) {
      roadRes = { __error: e };
    }

    let missions = extract(roadRes);

    if (!missions.length) {
      try {
        listRes = await api.get(API_ROUTES.listMissions); // /v1/admin/missions (may include inactive)
      } catch (e) {
        listRes = { __error: e };
      }
      const listMissions = extract(listRes);
      if (listMissions.length) missions = listMissions;
    }


    // Persist locally
    state.missions = Array.isArray(missions) ? missions : [];

    // Track original category per mission (for "category label decided by where you drop it" features)
    state.originalMissionCategoryById = {};
    state.missions.forEach((m) => {
      state.originalMissionCategoryById[m.id] = m.categoryId ?? null;
    });

    renderMissions();
    updateMissionsSummary();

    if (!state.missions.length) {
      const keys =
        listRes && !listRes.__error && typeof listRes === 'object'
          ? Object.keys(listRes).slice(0, 12).join(', ')
          : '';
      setStatus(
        'warning',
        'Connected – but no missions returned (check endpoint + response shape).',
      );
      if (showToastOnError) {
        showToast(
          'warning',
          'No missions returned',
          keys
            ? `Backend responded but returned no templates. Keys: ${keys}`
            : 'Backend responded but returned no templates.',
        );
      }
      return;
    }

    setStatus('ok', 'Connected – data loaded.');
  } catch (err) {
    console.error('reloadMissions error', err);
    state.missions = [];
    renderMissions();
    updateMissionsSummary();

    setStatus('error', 'Connection failed – check base URL or token.');
    if (showToastOnError) {
      showToast('error', 'Connection failed', err?.message || String(err));
    }
  }
}


async function connectAndLoad() {
  const base = (ui.baseUrlInput.value || '').trim();
  let tok = (ui.tokenInput.value || '').trim();

  // allow user to paste "Bearer eyJ...." or just "eyJ...."
  tok = tok.replace(/^bearer\s+/i, '');

  if (!base || !tok) {
    setStatus('error', 'Missing base URL or token.');
    showToast('warning', 'Missing connection data', 'Fill Base URL and paste a JWT token.');
    return;
  }

  state.baseUrl = base;
  state.token = tok;
  saveLocal();

  const prevText = ui.connectBtn.textContent;
  ui.connectBtn.disabled = true;
  ui.connectBtn.textContent = 'Loading…';

  try {
    setStatus('warning', 'Loading admin data…');
    await reloadMeta();
    await reloadMissions(false);
    setStatus('ok', 'Connected – data loaded.');
    showToast('ok', 'Connected', `Loaded ${state.categories.length} categories, ${state.personas.length} personas, ${state.missions.length} missions.`);
  } catch (err) {
    console.error('connectAndLoad error', err);
    setStatus('error', 'Connection failed – check base URL or token.');
    showToast('error', 'Connection failed', err?.message || String(err));
  } finally {
    ui.connectBtn.disabled = false;
    ui.connectBtn.textContent = prevText || 'Load data';
  }
}


function clearAllState() {
  state.categories = [];
  state.personas = [];
  state.missions = [];
  state.selectedCategoryId = null;
  state.selectedPersonaId = null;
  state.selectedMissionId = null;
  state.orderingDirty = false;
  ui.orderingBanner.classList.remove('show');
  renderCategories();
  renderPersonas();
  renderMissions();
  clearMissionForm();
  setStatus('idle', 'Idle – not connected');
}

// ---------- AI section collapsibles ----------
function initAiSections() {
  document.querySelectorAll('.ai-section').forEach((section) => {
    const header = section.querySelector('.ai-section-header');
    if (!header) return;
    header.addEventListener('click', (e) => {
      // avoid toggling when clicking inside select/input
      if (e.target.tagName === 'SELECT' || e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
        return;
      }
      section.classList.toggle('ai-collapsed');
    });
  });
}

// ---------- init ----------
function init() {
  loadLocal();
  setStatus('idle', 'Idle – not connected');

  ui.connectBtn.addEventListener('click', connectAndLoad);
  ui.clearBtn.addEventListener('click', () => {
    localStorage.removeItem(LS_KEYS.baseUrl);
    localStorage.removeItem(LS_KEYS.token);
    clearAllState();
  });

  // categories
  ui.newCategoryBtn.addEventListener('click', newCategory);
  ui.saveCategoryBtn.addEventListener('click', saveCategory);
  ui.deleteCategoryBtn.addEventListener('click', deleteCategory);

  // personas
  ui.newPersonaBtn.addEventListener('click', newPersona);
  ui.savePersonaBtn.addEventListener('click', savePersona);
  ui.deletePersonaBtn.addEventListener('click', deletePersona);

  // missions list
  ui.missionSearchInput.addEventListener('input', (e) => {
    state.missionSearch = e.target.value || '';
    renderMissions();
  });
  ui.normalizeOrderingBtn.addEventListener('click', normalizeOrdering);
  ui.saveOrderingBtn.addEventListener('click', saveOrdering);
  ui.reloadAllBtn.addEventListener('click', async () => {
    if (!state.baseUrl || !state.token) {
      showToast('warning', 'Not connected', 'Set base URL and token first.');
      return;
    }
    await connectAndLoad();
  });


  // enable pointer-based drag & drop for Mission Road
  setupMissionRoadDnD();
  // mission form
    // mission form (MINIMAL)
    [
    ui.missionCodeInput,
    ui.missionTitleInput,
    ui.missionCategorySelect,
    ui.missionPersonaSelect,
    ui.missionDifficultySelect,
    ui.missionActiveSelect,
    ui.aiContractJsonTextarea,
  ].forEach((input) => {
    if (!input) return;
    input.addEventListener('input', updateMissionPreview);
    input.addEventListener('change', updateMissionPreview);
  });
  if (ui.formatAiContractBtn) {
    ui.formatAiContractBtn.addEventListener('click', () => {
      try {
        formatAiContractJson();
        updateMissionPreview();
      } catch (e) {
        showToast(e?.message || 'Format failed', 'error');
      }
    });
  }

  if (ui.validateAiContractBtn) {
    ui.validateAiContractBtn.addEventListener('click', () => {
      validateAiContractJson(true);
      updateMissionPreview();
    });
  }

  initAiSections();
  updateMissionPreview();
}

document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
