<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>SocialGym – Mission Road Builder</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      :root {
        --bg: #020617;
        --bg2: #040a1d;
        --card: rgba(3, 7, 18, 0.92);
        --card2: rgba(2, 6, 23, 0.92);
        --border: rgba(148, 163, 184, 0.18);
        --border-strong: rgba(148, 163, 184, 0.32);
        --text: #f8fafc;
        --text2: #e2e8f0;
        --muted: rgba(226, 232, 240, 0.7);
        --muted2: rgba(226, 232, 240, 0.5);

        --accent: #22c55e;
        --accent2: #16a34a;
        --accent-soft: rgba(34, 197, 94, 0.18);

        --danger: #ef4444;
        --danger-soft: rgba(239, 68, 68, 0.16);

        --warning: #f59e0b;
        --warning-soft: rgba(245, 158, 11, 0.12);

        --shadow: 0 18px 40px rgba(0, 0, 0, 0.45);
        --shadow2: 0 10px 22px rgba(0, 0, 0, 0.35);

        --pill: rgba(15, 23, 42, 0.72);
        --pill2: rgba(2, 6, 23, 0.85);

        --scroll-track: rgba(2, 6, 23, 0.7);
        --scroll-thumb: rgba(148, 163, 184, 0.22);

        --radius: 18px;
        --radius2: 14px;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        padding: 18px;
        background: radial-gradient(
            1200px 600px at 20% 0%,
            rgba(34, 197, 94, 0.16),
            transparent 60%
          ),
          radial-gradient(
            900px 520px at 80% 0%,
            rgba(56, 189, 248, 0.12),
            transparent 60%
          ),
          linear-gradient(180deg, var(--bg2), var(--bg));
        font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto,
          Helvetica, Arial, 'Apple Color Emoji', 'Segoe UI Emoji';
        color: var(--text);
      }

      ::-webkit-scrollbar {
        width: 10px;
      }
      ::-webkit-scrollbar-track {
        background: var(--scroll-track);
        border-radius: 999px;
      }
      ::-webkit-scrollbar-thumb {
        background: var(--scroll-thumb);
        border-radius: 999px;
      }

      .top {
        display: flex;
        align-items: flex-start;
        justify-content: space-between;
        gap: 14px;
        margin-bottom: 10px;
      }

      h1 {
        margin: 0;
        font-size: 24px;
        letter-spacing: 0.02em;
      }

      .subtitle {
        margin: 6px 0 0 0;
        font-size: 13px;
        color: var(--muted);
        max-width: 860px;
        line-height: 1.4;
      }

      .badge {
        display: inline-flex;
        align-items: center;
        gap: 10px;
        padding: 8px 12px;
        border-radius: 999px;
        background: rgba(2, 6, 23, 0.75);
        border: 1px solid var(--border);
        box-shadow: var(--shadow2);
        font-size: 12px;
        color: var(--text2);
        user-select: none;
      }

      .badge-dot {
        width: 10px;
        height: 10px;
        border-radius: 999px;
        background: #64748b;
        box-shadow: 0 0 0 3px rgba(148, 163, 184, 0.12);
      }

      .layout {
        margin-top: 14px;
        display: grid;
        grid-template-columns: minmax(320px, 1.05fr) minmax(360px, 1.55fr) minmax(
            360px,
            1.3fr
          );
        gap: 14px;
      }

      .card {
        background: linear-gradient(
          180deg,
          rgba(2, 6, 23, 0.92),
          rgba(2, 6, 23, 0.82)
        );
        border-radius: var(--radius);
        border: 1px solid var(--border);
        padding: 14px 14px 16px 14px;
        box-shadow: var(--shadow);
        backdrop-filter: blur(10px);
      }

      .card-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        gap: 10px;
        margin-bottom: 10px;
      }

      .card-title {
        font-size: 15px;
        font-weight: 700;
        letter-spacing: 0.02em;
      }

      .card-subtitle {
        margin-top: 4px;
        font-size: 12px;
        color: var(--muted);
        line-height: 1.35;
      }

      .small-pill {
        padding: 4px 10px;
        border-radius: 999px;
        background: var(--pill);
        border: 1px solid var(--border);
        font-size: 11px;
        color: var(--muted);
        white-space: nowrap;
        user-select: none;
      }

      .row {
        display: flex;
        gap: 10px;
        align-items: center;
        flex-wrap: wrap;
      }

      .field-group {
        margin-bottom: 10px;
      }

      .field-label {
        font-size: 11px;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        color: rgba(226, 232, 240, 0.68);
        margin-bottom: 5px;
      }

      .field-row {
        display: flex;
        gap: 8px;
        align-items: flex-start;
      }

      input[type='text'],
      input[type='number'],
      textarea,
      select {
        width: 100%;
        padding: 8px 10px;
        border-radius: 12px;
        border: 1px solid var(--border);
        background: rgba(2, 6, 23, 0.9);
        color: var(--text);
        font-size: 13px;
        outline: none;
        box-shadow: inset 0 0 0 1px rgba(15, 23, 42, 0.3);
      }

      textarea {
        resize: vertical;
        min-height: 54px;
        max-height: 180px;
      }

      input::placeholder,
      textarea::placeholder {
        color: rgba(148, 163, 184, 0.6);
      }

      input[type='text']:focus,
      input[type='number']:focus,
      textarea:focus,
      select:focus {
        border-color: rgba(34, 197, 94, 0.65);
        box-shadow: 0 0 0 3px rgba(34, 197, 94, 0.16);
      }

      button {
        border-radius: 999px;
        border: 1px solid transparent;
        cursor: pointer;
        font-size: 13px;
        padding: 8px 14px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        transition: transform 0.06s ease-out, box-shadow 0.1s ease-out,
          background 0.12s ease-out, opacity 0.12s ease-out,
          border-color 0.12s ease-out;
        user-select: none;
      }

      button:disabled {
        opacity: 0.55;
        cursor: default;
        transform: none;
        box-shadow: none;
      }

      .btn-primary {
        background: linear-gradient(135deg, var(--accent), var(--accent2));
        color: #032a1e;
        font-weight: 800;
        box-shadow: 0 16px 32px rgba(34, 197, 94, 0.25);
      }

      .btn-primary:hover:not(:disabled) {
        transform: translateY(-1px);
        box-shadow: 0 24px 40px rgba(34, 197, 94, 0.32);
      }

      .btn-ghost {
        background: rgba(2, 6, 23, 0.8);
        color: var(--text2);
        border: 1px solid var(--border);
      }

      .btn-ghost:hover:not(:disabled) {
        background: rgba(3, 7, 18, 0.9);
        border-color: var(--border-strong);
      }

      .btn-danger {
        background: var(--danger-soft);
        color: #fecaca;
        border: 1px solid rgba(248, 113, 113, 0.45);
      }

      .btn-danger:hover:not(:disabled) {
        background: rgba(239, 68, 68, 0.28);
        border-color: rgba(248, 113, 113, 0.55);
      }

      .btn-small {
        padding: 5px 10px;
        font-size: 11px;
        gap: 6px;
      }

      .btn-icon {
        width: 28px;
        height: 28px;
        padding: 0;
        border-radius: 12px;
      }

      .connection-grid {
        display: grid;
        grid-template-columns: minmax(0, 0.85fr) minmax(0, 1fr) auto;
        gap: 10px;
        align-items: end;
      }

      .connection-status {
        margin-top: 8px;
        font-size: 12px;
        color: var(--muted);
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .status-dot {
        width: 10px;
        height: 10px;
        border-radius: 999px;
      }

      .status-idle {
        background: #64748b;
      }
      .status-ok {
        background: #22c55e;
      }
      .status-error {
        background: #ef4444;
      }
      .status-warning {
        background: #f59e0b;
      }

      .hint {
        font-size: 11px;
        color: var(--muted2);
        margin-top: 8px;
        line-height: 1.35;
      }

      .kbd {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 1px 7px;
        border-radius: 8px;
        border: 1px solid var(--border);
        background: rgba(15, 23, 42, 0.7);
        font-size: 10px;
        color: rgba(226, 232, 240, 0.7);
      }

      .category-list,
      .persona-list {
        max-height: 270px;
        overflow-y: auto;
        margin-top: 6px;
        padding-right: 4px;
      }

      .category-pill,
      .persona-pill {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 8px 10px;
        border-radius: 14px;
        background: rgba(2, 6, 23, 0.78);
        border: 1px solid var(--border);
        margin-bottom: 6px;
        cursor: pointer;
        transition: background 0.12s ease-out, border-color 0.12s ease-out,
          transform 0.07s ease-out;
      }

      .category-pill:hover,
      .persona-pill:hover {
        background: rgba(3, 7, 18, 0.9);
        border-color: var(--border-strong);
        transform: translateY(-1px);
      }

      .category-pill.active,
      .persona-pill.active {
        border-color: rgba(34, 197, 94, 0.7);
        box-shadow: 0 0 0 3px rgba(34, 197, 94, 0.12);
        background: rgba(2, 16, 18, 0.72);
      }

      .category-pill-main,
      .persona-pill-main {
        display: flex;
        flex-direction: column;
        gap: 3px;
        min-width: 0;
      }

      .category-pill-name,
      .persona-pill-name {
        font-size: 12px;
        font-weight: 700;
        color: var(--text2);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .category-pill-meta,
      .persona-pill-meta {
        font-size: 11px;
        color: var(--muted);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .missions-list {
        max-height: 560px;
        overflow-y: auto;
        padding-right: 4px;
      }

      .lane-header {
        font-size: 11px;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        color: rgba(226, 232, 240, 0.55);
        margin: 10px 2px 6px;
        display: flex;
        align-items: center;
        justify-content: space-between;
      }

      .lane-bucket {
        border: 1px dashed rgba(148, 163, 184, 0.22);
        background: rgba(2, 6, 23, 0.55);
        border-radius: 16px;
        padding: 8px;
        margin-bottom: 10px;
      }

      .mission-row {
        border-radius: 16px;
        padding: 10px 10px;
        background: rgba(2, 6, 23, 0.85);
        border: 1px solid rgba(148, 163, 184, 0.18);
        display: grid;
        grid-template-columns: auto minmax(0, 1fr) auto;
        gap: 10px;
        align-items: center;
        margin-bottom: 8px;
        cursor: pointer;
        transition: background 0.12s ease-out, border-color 0.12s ease-out,
          transform 0.07s ease-out;
      }

      .mission-row:hover {
        background: rgba(3, 7, 18, 0.92);
        border-color: rgba(148, 163, 184, 0.28);
        transform: translateY(-1px);
      }

      .mission-row.active {
        border-color: rgba(34, 197, 94, 0.7);
        box-shadow: 0 0 0 3px rgba(34, 197, 94, 0.12);
        background: rgba(2, 16, 18, 0.72);
      }

      .mission-row.dragging {
        opacity: 0.55;
        transform: scale(0.98);
      }

      .mission-row.drop-target {
        outline: 2px solid rgba(34, 197, 94, 0.6);
        box-shadow: 0 0 0 6px rgba(34, 197, 94, 0.12);
      }

      .drag-handle {
        width: 26px;
        height: 26px;
        border-radius: 12px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        background: rgba(15, 23, 42, 0.75);
        border: 1px solid rgba(148, 163, 184, 0.2);
        color: rgba(226, 232, 240, 0.7);
        font-size: 14px;
        user-select: none;
      }

      .mission-main {
        min-width: 0;
      }

      .mission-title {
        font-size: 13px;
        font-weight: 800;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        color: var(--text2);
      }

      .mission-meta {
        font-size: 11px;
        color: var(--muted);
        display: flex;
        gap: 6px;
        flex-wrap: wrap;
        margin-top: 4px;
      }

      .mission-meta span {
        padding: 3px 8px;
        border-radius: 999px;
        background: rgba(15, 23, 42, 0.72);
        border: 1px solid rgba(148, 163, 184, 0.14);
      }

      .mission-controls {
        display: flex;
        flex-direction: column;
        gap: 6px;
      }

      .preview-box {
        margin-top: 10px;
        padding: 10px 10px;
        border-radius: 16px;
        background: rgba(2, 6, 23, 0.72);
        border: 1px dashed rgba(148, 163, 184, 0.25);
        font-size: 11px;
        color: var(--muted);
      }

      .preview-tag {
        display: inline-flex;
        padding: 3px 8px;
        border-radius: 999px;
        background: rgba(15, 23, 42, 0.7);
        border: 1px solid rgba(148, 163, 184, 0.14);
        font-size: 10px;
        margin-right: 6px;
        margin-bottom: 6px;
      }

      .footer-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 10px;
        font-size: 12px;
        color: var(--muted);
        gap: 10px;
      }

      .divider {
        height: 1px;
        background: rgba(148, 163, 184, 0.14);
        margin: 10px 0;
      }

      .inline-banner {
        border-radius: 16px;
        padding: 10px 10px;
        border: 1px solid rgba(245, 158, 11, 0.3);
        background: rgba(245, 158, 11, 0.08);
        color: rgba(254, 243, 199, 0.95);
        font-size: 12px;
        display: none;
      }

      .inline-banner.show {
        display: block;
      }

      /* Toast */
      .toast-wrap {
        position: fixed;
        right: 16px;
        bottom: 16px;
        display: flex;
        flex-direction: column;
        gap: 10px;
        z-index: 9999;
      }

      .toast {
        min-width: 320px;
        max-width: 520px;
        border-radius: 16px;
        padding: 12px 12px;
        border: 1px solid var(--border);
        background: rgba(2, 6, 23, 0.92);
        box-shadow: var(--shadow);
        color: var(--text2);
        display: grid;
        grid-template-columns: auto 1fr auto;
        gap: 10px;
        align-items: start;
        animation: toastIn 0.16s ease-out;
      }

      @keyframes toastIn {
        from {
          transform: translateY(8px);
          opacity: 0;
        }
        to {
          transform: translateY(0px);
          opacity: 1;
        }
      }

      .toast-dot {
        width: 10px;
        height: 10px;
        border-radius: 999px;
        margin-top: 4px;
      }

      .toast-title {
        font-weight: 800;
        font-size: 12px;
        margin-bottom: 2px;
      }

      .toast-msg {
        font-size: 12px;
        color: var(--muted);
        white-space: pre-wrap;
        line-height: 1.35;
      }

      .toast-x {
        width: 26px;
        height: 26px;
        border-radius: 12px;
        background: rgba(15, 23, 42, 0.75);
        border: 1px solid rgba(148, 163, 184, 0.2);
        color: rgba(226, 232, 240, 0.7);
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        justify-content: center;
      }

      .toast-x:hover {
        border-color: rgba(148, 163, 184, 0.35);
        background: rgba(15, 23, 42, 0.9);
      }

      /* Search input */
      .search {
        display: grid;
        grid-template-columns: 1fr auto;
        gap: 10px;
        align-items: center;
        margin-top: 6px;
        margin-bottom: 10px;
      }

      .search input {
        border-radius: 999px;
        padding-left: 14px;
      }

      /* AI contract sections */
      .ai-section {
        margin-top: 12px;
        padding: 10px 10px;
        border-radius: 14px;
        background: rgba(2, 6, 23, 0.85);
        border: 1px solid rgba(148, 163, 184, 0.2);
      }

      .ai-section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        cursor: pointer;
      }

      .ai-section-title {
        font-size: 12px;
        font-weight: 700;
        letter-spacing: 0.06em;
        text-transform: uppercase;
        color: rgba(226, 232, 240, 0.85);
      }

      .ai-section-toggle {
        font-size: 11px;
        color: var(--muted);
      }

      .ai-section-body {
        margin-top: 8px;
      }

      .ai-collapsed .ai-section-body {
        display: none;
      }
    </style>
  </head>

  <body>
    <div class="toast-wrap" id="toastWrap"></div>

    <header class="top">
      <div>
        <h1>SocialGym – Mission Road Builder</h1>
        <p class="subtitle">
          Internal low-code tool for defining the Mission Road. Connect with your backend, then manage
          categories, personas and missions. Includes a full AI contract editor per mission.
        </p>
      </div>
      <div class="badge">
        <span class="badge-dot" id="statusDot"></span>
        <span id="statusText">Idle – not connected</span>
      </div>
    </header>

    <section class="card">
      <div class="card-header">
        <div>
          <div class="card-title">1) Connection</div>
          <div class="card-subtitle">
            Use the same Base URL + JWT you use in Postman. We fetch categories + missions + personas.
            Base URL persists locally for convenience.
          </div>
        </div>
        <div class="small-pill">Admin endpoints</div>
      </div>

      <div class="connection-grid">
        <div class="field-group">
          <div class="field-label">Base URL</div>
          <input id="baseUrlInput" type="text" placeholder="http://localhost:3000" />
        </div>

        <div class="field-group">
          <div class="field-label">Access token (Bearer)</div>
          <textarea id="tokenInput" rows="2" placeholder="Paste JWT access token here…"></textarea>
        </div>

        <div style="display:flex;flex-direction:column;gap:8px;">
          <button id="connectBtn" class="btn-primary">Load data</button>
          <button id="clearBtn" class="btn-ghost btn-small">Clear state</button>
        </div>
      </div>

      <div class="connection-status" id="connectionStatus">
        <span class="status-dot status-idle" id="connDot"></span>
        <span id="connText">Idle – not connected yet.</span>
      </div>

      <div class="hint">
        Tip: token usually starts with <span class="kbd">eyJ</span>. Base URL can be
        <span class="kbd">http://localhost:3000</span> or your LAN IP.
        Use <span class="kbd">Ctrl+F5</span> after updating this HTML.
      </div>
    </section>

    <main class="layout">
      <!-- LEFT: Category editor -->
      <section class="card" id="categoryCard">
        <div class="card-header">
          <div>
            <div class="card-title">2) Categories</div>
            <div class="card-subtitle">
              Logical segments of the road. Missions attach to these categories.
            </div>
          </div>
          <button id="newCategoryBtn" class="btn-ghost btn-small">+ New category</button>
        </div>

        <div class="field-group">
          <div class="field-label">Category name</div>
          <input id="catNameInput" type="text" placeholder="Basics – First Openers" />
        </div>

        <div class="field-group field-row">
          <div style="flex:1;">
            <div class="field-label">Code / tag</div>
            <input id="catCodeInput" type="text" placeholder="OPENERS" />
          </div>
          <div style="width:110px;">
            <div class="field-label">Min level</div>
            <input id="catMinLevelInput" type="number" min="1" value="1" />
          </div>
        </div>

        <div class="field-group">
          <div class="field-label">Subtitle / description</div>
          <input id="catSubtitleInput" type="text" placeholder="Start with simple, confident openers." />
        </div>

        <div class="row">
          <button id="saveCategoryBtn" class="btn-primary">Save category</button>
          <button id="deleteCategoryBtn" class="btn-danger btn-small">Delete</button>
        </div>

        <div class="divider"></div>

        <div class="field-label">Existing categories</div>
        <div class="category-list" id="categoryList"></div>
      </section>

      <!-- CENTER: Persona editor -->
      <section class="card" id="personaCard">
        <div class="card-header">
          <div>
            <div class="card-title">3) Personas</div>
            <div class="card-subtitle" id="personaModeLabel">
              Create a new persona or click one below to edit it.
            </div>
          </div>
          <div class="row">
            <button id="newPersonaBtn" class="btn-ghost btn-small">+ New persona</button>
          </div>
        </div>

        <div class="field-group field-row">
          <div style="flex:1;">
            <div class="field-label">Code</div>
            <input id="personaCodeInput" type="text" placeholder="MAYA_PLAYFUL" />
          </div>
          <div style="flex:1;">
            <div class="field-label">Name</div>
            <input id="personaNameInput" type="text" placeholder="Maya" />
          </div>
        </div>

        <div class="field-group field-row">
          <div style="flex:1;">
            <div class="field-label">Short label</div>
            <input id="personaShortLabelInput" type="text" placeholder="Playful, warm" />
          </div>
          <div style="width:140px;">
            <div class="field-label">Difficulty</div>
            <select id="personaDifficultySelect">
              <option value="1">1 – Easy</option>
              <option value="2">2 – Medium</option>
              <option value="3">3 – Hard</option>
              <option value="4">4 – Elite</option>
            </select>
          </div>
        </div>

        <div class="field-group">
          <div class="field-label">Description</div>
          <textarea id="personaDescriptionInput" placeholder="Short description for the persona."></textarea>
        </div>

        <div class="field-group field-row">
          <div style="flex:1;">
            <div class="field-label">Style</div>
            <input id="personaStyleInput" type="text" placeholder="Playful, teasing, warm" />
          </div>
          <div style="flex:1;">
            <div class="field-label">Avatar URL</div>
            <input id="personaAvatarInput" type="text" placeholder="https://…" />
          </div>
        </div>

        <div class="field-group field-row">
          <div style="flex:1;">
            <div class="field-label">Voice preset</div>
            <input id="personaVoicePresetInput" type="text" placeholder="female-soft-01" />
          </div>
          <div style="width:140px;">
            <div class="field-label">Active</div>
            <select id="personaActiveSelect">
              <option value="true">true</option>
              <option value="false">false</option>
            </select>
          </div>
        </div>

        <div class="row">
          <button id="savePersonaBtn" class="btn-primary">Save persona</button>
          <button id="deletePersonaBtn" class="btn-danger btn-small">Delete</button>
        </div>

        <div class="divider"></div>

        <div class="field-label">Existing personas</div>
        <div class="persona-list" id="personaList"></div>
      </section>

      <!-- RIGHT: Mission list + ordering -->
      <section class="card">
        <div class="card-header">
          <div>
            <div class="card-title">4) Mission Road ordering</div>
            <div class="card-subtitle">
              Drag & drop reorders inside the same lane bucket. You can also use ↑ / ↓.
              When you’re happy, press <b>Save ordering</b>.
            </div>
          </div>
          <button id="saveOrderingBtn" class="btn-primary btn-small">Save ordering</button>
        </div>

        <div class="inline-banner" id="orderingBanner">
          Ordering changed but not saved yet. Press <b>Save ordering</b> to persist.
        </div>

        <div class="search">
          <input id="missionSearchInput" type="text" placeholder="Search missions by title / code / category..." />
          <button id="normalizeOrderingBtn" class="btn-ghost btn-small" title="Re-index orderIndex per lane">
            Normalize
          </button>
        </div>

        <div class="missions-list" id="missionsList"></div>

        <div class="footer-row">
          <span id="missionsSummary">No missions loaded.</span>
          <div class="row">
            <button id="reloadAllBtn" class="btn-ghost btn-small">Reload from backend</button>
          </div>
        </div>
      </section>
    </main>

    <!-- BOTTOM: Mission + AI Contract editor (full width) -->
    <section class="card" id="missionCard" style="margin-top:14px;">
      <div class="card-header">
        <div>
          <div class="card-title">5) Mission & AI Contract editor</div>
          <div class="card-subtitle" id="missionModeLabel">
            Create a new mission or click one on the right to edit it. The AI contract below will be saved together
            with the mission.
          </div>
        </div>
        <div class="row">
          <button id="duplicateMissionBtn" class="btn-ghost btn-small" title="Duplicate selected mission">
            Duplicate
          </button>
          <button id="newMissionBtn" class="btn-ghost btn-small">+ New mission</button>
        </div>
      </div>

      <!-- Basic mission data -->
      <div class="field-group">
        <div class="field-label">Code</div>
        <input id="missionCodeInput" type="text" placeholder="OPENERS_L1_M1" />
      </div>

      <div class="field-group">
        <div class="field-label">Title</div>
        <input id="missionTitleInput" type="text" placeholder="First Hello" />
      </div>

      <div class="field-group">
        <div class="field-label">Description</div>
        <textarea id="missionDescInput" placeholder="Send a simple, confident opener."></textarea>
      </div>

      <div class="field-group field-row">
        <div style="flex:1;">
          <div class="field-label">Category</div>
          <select id="missionCategorySelect">
            <option value="">– choose category –</option>
          </select>
        </div>
        <div style="width:160px;">
          <div class="field-label">Goal type</div>
          <select id="missionGoalTypeSelect">
            <option value="OPENING">OPENING</option>
            <option value="FLIRTING">FLIRTING</option>
            <option value="RECOVERY">RECOVERY</option>
            <option value="BOUNDARY">BOUNDARY</option>
            <option value="LOGISTICS">LOGISTICS</option>
            <option value="SOCIAL">SOCIAL</option>
          </select>
        </div>
      </div>

      <div class="field-group field-row">
        <div style="flex:1;">
          <div class="field-label">AI persona</div>
          <select id="missionPersonaSelect">
            <option value="">– choose persona –</option>
          </select>
        </div>
        <div style="width:160px;">
          <div class="field-label">Difficulty</div>
          <select id="missionDifficultySelect">
            <option value="EASY">EASY</option>
            <option value="MEDIUM">MEDIUM</option>
            <option value="HARD">HARD</option>
            <option value="ELITE">ELITE</option>
          </select>
        </div>
      </div>

      <div class="field-group field-row">
        <div style="width:120px;">
          <div class="field-label">Lane</div>
          <input id="missionLaneInput" type="number" min="0" value="0" />
        </div>
        <div style="width:120px;">
          <div class="field-label">Order</div>
          <input id="missionOrderInput" type="number" min="0" value="1" />
        </div>
        <div style="flex:1;">
          <div class="field-label">Active</div>
          <select id="missionActiveSelect">
            <option value="true">true</option>
            <option value="false">false</option>
          </select>
        </div>
      </div>

      <div class="field-group field-row">
        <div style="width:160px;">
          <div class="field-label">Time limit (sec)</div>
          <input id="missionTimeLimitInput" type="number" min="0" value="30" />
        </div>
        <div style="width:160px;">
          <div class="field-label">Max messages</div>
          <input id="missionMaxMessagesInput" type="number" min="0" placeholder="(optional)" />
        </div>
        <div style="width:160px;">
          <div class="field-label">Word limit</div>
          <input id="missionWordLimitInput" type="number" min="0" placeholder="(optional)" />
        </div>
      </div>

      <div class="field-group field-row">
        <div style="width:160px;">
          <div class="field-label">Reward XP</div>
          <input id="missionXpInput" type="number" min="0" value="60" />
        </div>
        <div style="width:160px;">
          <div class="field-label">Reward coins</div>
          <input id="missionCoinsInput" type="number" min="0" value="10" />
        </div>
        <div style="width:160px;">
          <div class="field-label">Reward gems</div>
          <input id="missionGemsInput" type="number" min="0" value="0" />
        </div>
      </div>

      <div class="row">
        <button id="saveMissionBtn" class="btn-primary">Save mission</button>
        <button id="deleteMissionBtn" class="btn-danger btn-small">Delete</button>
      </div>

      <div class="preview-box" id="missionPreview">
        <div style="font-weight:800;margin-bottom:6px;color:rgba(226,232,240,0.85);">Preview</div>
        <div id="missionPreviewText" style="margin-bottom:6px;">
          No mission selected.
        </div>
        <div id="missionPreviewTags"></div>
      </div>

      <div class="divider"></div>

      <!-- AI CONTRACT EDITOR -->
      <div class="field-label" style="margin-bottom:6px;">AI Contract</div>
      <div class="hint">
        These fields control how the AI behaves in this mission. Arrays / lists can be written line-by-line or comma-separated.
        If you leave things empty, smart defaults will be generated from the mission + persona.
      </div>

      <!-- META -->
      <div class="ai-section" id="aiMetaSection">
        <div class="ai-section-header">
          <div class="ai-section-title">Meta</div>
          <div class="ai-section-toggle">toggle</div>
        </div>
        <div class="ai-section-body">
          <div class="field-group field-row">
            <div style="width:160px;">
              <div class="field-label">Language</div>
              <input id="aiMetaLanguageInput" type="text" placeholder="en" />
            </div>
            <div style="width:160px;">
              <div class="field-label">Max turns</div>
              <input id="aiMetaMaxTurnsInput" type="number" min="1" placeholder="(default from maxMessages)" />
            </div>
          </div>
        </div>
      </div>

      <!-- PERSONA OVERRIDES -->
      <div class="ai-section" id="aiPersonaSection">
        <div class="ai-section-header">
          <div class="ai-section-title">Persona overrides</div>
          <div class="ai-section-toggle">toggle</div>
        </div>
        <div class="ai-section-body">
          <div class="field-group field-row">
            <div style="flex:1;">
              <div class="field-label">Display name (optional override)</div>
              <input id="aiPersonaDisplayNameInput" type="text" placeholder="Use persona name by default" />
            </div>
            <div style="width:160px;">
              <div class="field-label">Baseline interest</div>
              <select id="aiPersonaBaselineSelect">
                <option value="">(use default)</option>
                <option value="warm">warm</option>
                <option value="neutral">neutral</option>
                <option value="cold">cold</option>
              </select>
            </div>
          </div>

          <div class="field-group">
            <div class="field-label">Short bio</div>
            <textarea id="aiPersonaShortBioTextarea" placeholder="Override or extend the persona description for this mission."></textarea>
          </div>

          <div class="field-group field-row">
            <div style="flex:1;">
              <div class="field-label">Tone</div>
              <input id="aiPersonaToneInput" type="text" placeholder="playful, confident, teasing" />
            </div>
            <div style="width:160px;">
              <div class="field-label">Slang level</div>
              <input id="aiPersonaSlangInput" type="text" placeholder="low / medium / high" />
            </div>
          </div>

          <div class="field-group field-row">
            <div style="flex:1;">
              <div class="field-label">Emoji usage</div>
              <input id="aiPersonaEmojiInput" type="text" placeholder="max 1 emoji per message" />
            </div>
            <div style="flex:1;">
              <div class="field-label">Message length</div>
              <input id="aiPersonaMsgLengthInput" type="text" placeholder="1–3 sentences" />
            </div>
          </div>

          <div class="field-group field-row">
            <div style="flex:1;">
              <div class="field-label">Personality traits</div>
              <textarea id="aiPersonaTraitsTextarea" placeholder="One per line: playful, teasing, warm…"></textarea>
            </div>
            <div style="flex:1;">
              <div class="field-label">Values / boundaries</div>
              <textarea id="aiPersonaValuesTextarea" placeholder="One per line: no insults, hates neediness…"></textarea>
            </div>
          </div>
        </div>
      </div>

      <!-- SCENARIO -->
      <div class="ai-section" id="aiScenarioSection">
        <div class="ai-section-header">
          <div class="ai-section-title">Scenario</div>
          <div class="ai-section-toggle">toggle</div>
        </div>
        <div class="ai-section-body">
          <div class="field-group field-row">
            <div style="width:180px;">
              <div class="field-label">Platform</div>
              <select id="aiScenarioPlatformSelect">
                <option value="">(auto)</option>
                <option value="tinder">tinder</option>
                <option value="whatsapp">whatsapp</option>
                <option value="instagram">instagram</option>
                <option value="job_interview">job_interview</option>
                <option value="bar">bar</option>
              </select>
            </div>
            <div style="flex:1;">
              <div class="field-label">Relationship context</div>
              <input id="aiScenarioRelationshipInput" type="text" placeholder="Matched recently, first opener…" />
            </div>
          </div>

          <div class="field-group">
            <div class="field-label">Starting situation</div>
            <textarea id="aiScenarioStartingTextarea" placeholder="Describe the starting message / situation for the mission."></textarea>
          </div>

          <div class="field-group field-row">
            <div style="flex:1;">
              <div class="field-label">User role description</div>
              <input id="aiScenarioUserRoleInput" type="text" placeholder="You are a confident but kind guy…" />
            </div>
            <div style="flex:1;">
              <div class="field-label">Hidden backstory (AI-only)</div>
              <textarea id="aiScenarioHiddenTextarea" placeholder="Secret info that only the AI knows."></textarea>
            </div>
          </div>
        </div>
      </div>

      <!-- OBJECTIVES -->
      <div class="ai-section" id="aiObjectivesSection">
        <div class="ai-section-header">
          <div class="ai-section-title">Objectives & constraints</div>
          <div class="ai-section-toggle">toggle</div>
        </div>
        <div class="ai-section-body">
          <div class="field-group">
            <div class="field-label">Primary objective</div>
            <input id="aiObjectivesPrimaryInput" type="text" placeholder="Get her to reply with clear interest…" />
          </div>

          <div class="field-group field-row">
            <div style="flex:1;">
              <div class="field-label">Secondary objectives</div>
              <textarea id="aiObjectivesSecondaryTextarea" placeholder="One per line."></textarea>
            </div>
            <div style="flex:1;">
              <div class="field-label">Success criteria</div>
              <textarea id="aiObjectivesSuccessTextarea" placeholder="One per line."></textarea>
            </div>
          </div>

          <div class="field-group field-row">
            <div style="flex:1;">
              <div class="field-label">Fail criteria</div>
              <textarea id="aiObjectivesFailTextarea" placeholder="One per line."></textarea>
            </div>
            <div style="width:200px;">
              <div class="field-label">Max words per message</div>
              <input id="aiConstraintsMaxWordsInput" type="number" min="0" placeholder="(default from word limit)" />
            </div>
          </div>

          <div class="field-group field-row">
            <div style="flex:1;">
              <div class="field-label">Banned moves</div>
              <textarea id="aiConstraintsBannedTextarea" placeholder="One per line: apologizing too much, over-explaining…"></textarea>
            </div>
            <div style="flex:1;">
              <div class="field-label">Required moves</div>
              <textarea id="aiConstraintsRequiredTextarea" placeholder="One per line: tease once, seed a future plan…"></textarea>
            </div>
          </div>
        </div>
      </div>

      <!-- CONVERSATION RULES -->
      <div class="ai-section" id="aiRulesSection">
        <div class="ai-section-header">
          <div class="ai-section-title">Conversation rules</div>
          <div class="ai-section-toggle">toggle</div>
        </div>
        <div class="ai-section-body">
          <div class="field-group">
            <div class="field-label">Tone rules</div>
            <textarea id="aiRulesToneTextarea" placeholder="One per line: stay playful, never needy…"></textarea>
          </div>

          <div class="field-group field-row">
            <div style="width:150px;">
              <div class="field-label">Min sentences</div>
              <input id="aiRulesMinSentencesInput" type="number" min="0" />
            </div>
            <div style="width:150px;">
              <div class="field-label">Max sentences</div>
              <input id="aiRulesMaxSentencesInput" type="number" min="0" />
            </div>
            <div style="flex:1;">
              <div class="field-label">Challenge level</div>
              <input id="aiRulesChallengeInput" type="text" placeholder="easy / normal / hard…" />
            </div>
          </div>

          <div class="field-group field-row">
            <div style="flex:1;">
              <div class="field-label">Escalation rules</div>
              <textarea id="aiRulesEscalationTextarea" placeholder="How tension / intimacy should escalate."></textarea>
            </div>
            <div style="flex:1;">
              <div class="field-label">Energy rules</div>
              <textarea id="aiRulesEnergyTextarea" placeholder="Energy curve across the mission."></textarea>
            </div>
          </div>

          <div class="field-group">
            <div class="field-label">Testing rules</div>
            <textarea id="aiRulesTestingTextarea" placeholder="Example: occasionally give colder replies to test resilience."></textarea>
          </div>
        </div>
      </div>

      <!-- SCORING GUIDE -->
      <div class="ai-section" id="aiScoringSection">
        <div class="ai-section-header">
          <div class="ai-section-title">Scoring guide</div>
          <div class="ai-section-toggle">toggle</div>
        </div>
        <div class="ai-section-body">
          <div class="field-group">
            <div class="field-label">Dimensions (one per line)</div>
            <textarea
              id="aiScoringDimensionsTextarea"
              placeholder="confidence|0.3|How bold and decisive the message is&#10;clarity|0.3|How clear and clean the wording is&#10;humor|0.2|Light playful humor&#10;tensionControl|0.2|How well tension is managed"
            ></textarea>
          </div>

          <div class="field-group field-row">
            <div style="width:160px;">
              <div class="field-label">Success score</div>
              <input id="aiScoringSuccessInput" type="number" min="0" max="100" placeholder="70" />
            </div>
            <div style="width:160px;">
              <div class="field-label">Fail score</div>
              <input id="aiScoringFailInput" type="number" min="0" max="100" placeholder="40" />
            </div>
          </div>

          <div class="field-group">
            <div class="field-label">Rarity patterns (one per line)</div>
            <textarea
              id="aiScoringRarityTextarea"
              placeholder="C|Safe, basic answer&#10;B|Decent, a bit generic&#10;A|Strong, good mix of clarity + playfulness&#10;S|Exceptional, bold but calibrated&#10;S+|Rare, extremely charismatic"
            ></textarea>
          </div>
        </div>
      </div>

      <!-- REALTIME FEEDBACK -->
      <div class="ai-section" id="aiFeedbackSection">
        <div class="ai-section-header">
          <div class="ai-section-title">Realtime feedback</div>
          <div class="ai-section-toggle">toggle</div>
        </div>
        <div class="ai-section-body">
          <div class="field-group" style="width:180px;">
            <div class="field-label">Enable realtime feedback</div>
            <select id="aiFeedbackEnabledSelect">
              <option value="">(default: true)</option>
              <option value="true">true</option>
              <option value="false">false</option>
            </select>
          </div>

          <div class="field-group field-row">
            <div style="flex:1;">
              <div class="field-label">Positive tags</div>
              <textarea id="aiFeedbackPositiveTextarea" placeholder="CONFIDENT, PLAYFUL, CLEAR…"></textarea>
            </div>
            <div style="flex:1;">
              <div class="field-label">Negative tags</div>
              <textarea id="aiFeedbackNegativeTextarea" placeholder="NEEDY, CONFUSING, OVERKILL…"></textarea>
            </div>
          </div>

          <div class="field-group field-row">
            <div style="flex:1;">
              <div class="field-label">Praise templates</div>
              <textarea id="aiFeedbackPraiseTextarea" placeholder="Nice, this hits playful + confident perfectly!"></textarea>
            </div>
            <div style="flex:1;">
              <div class="field-label">Nudge templates</div>
              <textarea id="aiFeedbackNudgeTextarea" placeholder="Try tightening this, you're explaining a bit too much."></textarea>
            </div>
          </div>

          <div class="field-group">
            <div class="field-label">Failure templates</div>
            <textarea id="aiFeedbackFailureTextarea" placeholder="This one loses tension and sounds apologetic. Let's try again."></textarea>
          </div>
        </div>
      </div>

      <!-- OUTPUT FORMAT -->
      <div class="ai-section" id="aiOutputSection">
        <div class="ai-section-header">
          <div class="ai-section-title">Output format</div>
          <div class="ai-section-toggle">toggle</div>
        </div>
        <div class="ai-section-body">
          <div class="field-group field-row">
            <div style="width:180px;">
              <div class="field-label">Mode</div>
              <select id="aiOutputModeSelect">
                <option value="json">json</option>
                <option value="text">text</option>
              </select>
            </div>
            <div style="flex:1;">
              <div class="field-label">Schema description</div>
              <textarea
                id="aiOutputSchemaTextarea"
                placeholder="Explain the JSON fields the AI should return, e.g. replyText, tags, scores, analysis…"
              ></textarea>
            </div>
          </div>

          <div class="field-group">
            <div class="field-label">Example output (JSON, optional)</div>
            <textarea
              id="aiOutputExampleTextarea"
              placeholder='{"replyText":"...", "messageScore":78, "rarity":"A", "tags":["CONFIDENT","PLAYFUL"]}'
            ></textarea>
          </div>
        </div>
      </div>

      <!-- SAFETY -->
      <div class="ai-section" id="aiSafetySection">
        <div class="ai-section-header">
          <div class="ai-section-title">Safety</div>
          <div class="ai-section-toggle">toggle</div>
        </div>
        <div class="ai-section-body">
          <div class="field-group field-row">
            <div style="flex:1;">
              <div class="field-label">Disallowed topics</div>
              <textarea id="aiSafetyDisallowedTextarea" placeholder="One per line: politics, explicit sexual content…"></textarea>
            </div>
            <div style="flex:1;">
              <div class="field-label">Must refuse if…</div>
              <textarea id="aiSafetyMustRefuseTextarea" placeholder="One per line: user asks to harass or insult…"></textarea>
            </div>
          </div>

          <div class="field-group">
            <div class="field-label">Refusal style</div>
            <textarea id="aiSafetyRefusalStyleTextarea" placeholder="How AI should decline while staying in character."></textarea>
          </div>
        </div>
      </div>
    </section>

    <script>
const API_ROUTES = {
  listCategories: '/v1/admin/missions/categories',
  createCategory: '/v1/admin/missions/categories',
  updateCategory: (id) => '/v1/admin/missions/categories/' + id,
  deleteCategory: (id) => '/v1/admin/missions/categories/' + id,

  listMissions: '/v1/admin/missions',
  createMission: '/v1/admin/missions',
  updateMission: (id) => '/v1/admin/missions/' + id,
  deleteMission: (id) => '/v1/admin/missions/' + id,
  reorderMissions: '/v1/admin/missions/reorder',

  listPersonas: '/v1/admin/personas',
  createPersona: '/v1/admin/personas',
  updatePersona: (id) => '/v1/admin/personas/' + id,
  deletePersona: (id) => '/v1/admin/personas/' + id,

  meta: '/v1/admin/missions/meta',
};

const LS_KEYS = {
  baseUrl: 'sg_admin_baseUrl',
  token: 'sg_admin_token',
};

const state = {
  baseUrl: '',
  token: '',
  connected: false,

  categories: [],
  missions: [],
  personas: [],

  selectedCategoryId: null,
  selectedMissionId: null,
  selectedPersonaId: null,

  orderingDirty: false,
  drag: { draggingId: null, overId: null },
  missionSearch: '',
};

const el = (id) => document.getElementById(id);

const ui = {
  // connection
  baseUrlInput: el('baseUrlInput'),
  tokenInput: el('tokenInput'),
  connectBtn: el('connectBtn'),
  clearBtn: el('clearBtn'),
  statusDot: el('statusDot'),
  statusText: el('statusText'),
  connDot: el('connDot'),
  connText: el('connText'),
  toastWrap: el('toastWrap'),

  // categories
  newCategoryBtn: el('newCategoryBtn'),
  catNameInput: el('catNameInput'),
  catCodeInput: el('catCodeInput'),
  catSubtitleInput: el('catSubtitleInput'),
  catMinLevelInput: el('catMinLevelInput'),
  saveCategoryBtn: el('saveCategoryBtn'),
  deleteCategoryBtn: el('deleteCategoryBtn'),
  categoryList: el('categoryList'),

  // personas
  newPersonaBtn: el('newPersonaBtn'),
  personaCodeInput: el('personaCodeInput'),
  personaNameInput: el('personaNameInput'),
  personaShortLabelInput: el('personaShortLabelInput'),
  personaDescriptionInput: el('personaDescriptionInput'),
  personaStyleInput: el('personaStyleInput'),
  personaAvatarInput: el('personaAvatarInput'),
  personaDifficultySelect: el('personaDifficultySelect'),
  personaActiveSelect: el('personaActiveSelect'),
  personaVoicePresetInput: el('personaVoicePresetInput'),
  savePersonaBtn: el('savePersonaBtn'),
  deletePersonaBtn: el('deletePersonaBtn'),
  personaList: el('personaList'),
  personaModeLabel: el('personaModeLabel'),

  // missions list + ordering
  missionsList: el('missionsList'),
  missionsSummary: el('missionsSummary'),
  missionSearchInput: el('missionSearchInput'),
  saveOrderingBtn: el('saveOrderingBtn'),
  normalizeOrderingBtn: el('normalizeOrderingBtn'),
  reloadAllBtn: el('reloadAllBtn'),
  orderingBanner: el('orderingBanner'),

  // mission form
  newMissionBtn: el('newMissionBtn'),
  duplicateMissionBtn: el('duplicateMissionBtn'),
  saveMissionBtn: el('saveMissionBtn'),
  deleteMissionBtn: el('deleteMissionBtn'),
  missionModeLabel: el('missionModeLabel'),

  missionCodeInput: el('missionCodeInput'),
  missionTitleInput: el('missionTitleInput'),
  missionDescInput: el('missionDescInput'),
  missionCategorySelect: el('missionCategorySelect'),
  missionGoalTypeSelect: el('missionGoalTypeSelect'),
  missionPersonaSelect: el('missionPersonaSelect'),
  missionDifficultySelect: el('missionDifficultySelect'),
  missionLaneInput: el('missionLaneInput'),
  missionOrderInput: el('missionOrderInput'),
  missionActiveSelect: el('missionActiveSelect'),
  missionTimeLimitInput: el('missionTimeLimitInput'),
  missionMaxMessagesInput: el('missionMaxMessagesInput'),
  missionWordLimitInput: el('missionWordLimitInput'),
  missionXpInput: el('missionXpInput'),
  missionCoinsInput: el('missionCoinsInput'),
  missionGemsInput: el('missionGemsInput'),

  missionPreview: el('missionPreview'),
  missionPreviewText: el('missionPreviewText'),
  missionPreviewTags: el('missionPreviewTags'),

  // AI contract fields
  aiMetaLanguageInput: el('aiMetaLanguageInput'),
  aiMetaMaxTurnsInput: el('aiMetaMaxTurnsInput'),

  aiPersonaDisplayNameInput: el('aiPersonaDisplayNameInput'),
  aiPersonaBaselineSelect: el('aiPersonaBaselineSelect'),
  aiPersonaShortBioTextarea: el('aiPersonaShortBioTextarea'),
  aiPersonaToneInput: el('aiPersonaToneInput'),
  aiPersonaSlangInput: el('aiPersonaSlangInput'),
  aiPersonaEmojiInput: el('aiPersonaEmojiInput'),
  aiPersonaMsgLengthInput: el('aiPersonaMsgLengthInput'),
  aiPersonaTraitsTextarea: el('aiPersonaTraitsTextarea'),
  aiPersonaValuesTextarea: el('aiPersonaValuesTextarea'),

  aiScenarioPlatformSelect: el('aiScenarioPlatformSelect'),
  aiScenarioRelationshipInput: el('aiScenarioRelationshipInput'),
  aiScenarioStartingTextarea: el('aiScenarioStartingTextarea'),
  aiScenarioUserRoleInput: el('aiScenarioUserRoleInput'),
  aiScenarioHiddenTextarea: el('aiScenarioHiddenTextarea'),

  aiObjectivesPrimaryInput: el('aiObjectivesPrimaryInput'),
  aiObjectivesSecondaryTextarea: el('aiObjectivesSecondaryTextarea'),
  aiObjectivesSuccessTextarea: el('aiObjectivesSuccessTextarea'),
  aiObjectivesFailTextarea: el('aiObjectivesFailTextarea'),
  aiConstraintsMaxWordsInput: el('aiConstraintsMaxWordsInput'),
  aiConstraintsBannedTextarea: el('aiConstraintsBannedTextarea'),
  aiConstraintsRequiredTextarea: el('aiConstraintsRequiredTextarea'),

  aiRulesToneTextarea: el('aiRulesToneTextarea'),
  aiRulesMinSentencesInput: el('aiRulesMinSentencesInput'),
  aiRulesMaxSentencesInput: el('aiRulesMaxSentencesInput'),
  aiRulesChallengeInput: el('aiRulesChallengeInput'),
  aiRulesEscalationTextarea: el('aiRulesEscalationTextarea'),
  aiRulesEnergyTextarea: el('aiRulesEnergyTextarea'),
  aiRulesTestingTextarea: el('aiRulesTestingTextarea'),

  aiScoringDimensionsTextarea: el('aiScoringDimensionsTextarea'),
  aiScoringSuccessInput: el('aiScoringSuccessInput'),
  aiScoringFailInput: el('aiScoringFailInput'),
  aiScoringRarityTextarea: el('aiScoringRarityTextarea'),

  aiFeedbackEnabledSelect: el('aiFeedbackEnabledSelect'),
  aiFeedbackPositiveTextarea: el('aiFeedbackPositiveTextarea'),
  aiFeedbackNegativeTextarea: el('aiFeedbackNegativeTextarea'),
  aiFeedbackPraiseTextarea: el('aiFeedbackPraiseTextarea'),
  aiFeedbackNudgeTextarea: el('aiFeedbackNudgeTextarea'),
  aiFeedbackFailureTextarea: el('aiFeedbackFailureTextarea'),

  aiOutputModeSelect: el('aiOutputModeSelect'),
  aiOutputSchemaTextarea: el('aiOutputSchemaTextarea'),
  aiOutputExampleTextarea: el('aiOutputExampleTextarea'),

  aiSafetyDisallowedTextarea: el('aiSafetyDisallowedTextarea'),
  aiSafetyMustRefuseTextarea: el('aiSafetyMustRefuseTextarea'),
  aiSafetyRefusalStyleTextarea: el('aiSafetyRefusalStyleTextarea'),
};

// ---------- helpers ----------
function setStatus(status, text) {
  ui.statusText.textContent = text;
  ui.connText.textContent = text;
  ui.statusDot.className = 'badge-dot';
  ui.connDot.className = 'status-dot';

  if (status === 'ok') {
    ui.statusDot.style.background = '#22c55e';
    ui.connDot.classList.add('status-ok');
  } else if (status === 'error') {
    ui.statusDot.style.background = '#ef4444';
    ui.connDot.classList.add('status-error');
  } else if (status === 'warning') {
    ui.statusDot.style.background = '#f59e0b';
    ui.connDot.classList.add('status-warning');
  } else {
    ui.statusDot.style.background = '#64748b';
    ui.connDot.classList.add('status-idle');
  }
}

function showToast(kind, title, msg) {
  const div = document.createElement('div');
  div.className = 'toast';

  const dot = document.createElement('div');
  dot.className = 'toast-dot';
  if (kind === 'ok') dot.style.background = '#22c55e';
  else if (kind === 'error') dot.style.background = '#ef4444';
  else dot.style.background = '#f59e0b';

  const body = document.createElement('div');
  const t = document.createElement('div');
  t.className = 'toast-title';
  t.textContent = title;
  const m = document.createElement('div');
  m.className = 'toast-msg';
  m.textContent = msg;
  body.appendChild(t);
  body.appendChild(m);

  const x = document.createElement('button');
  x.className = 'toast-x';
  x.innerHTML = '&times;';
  x.onclick = () => div.remove();

  div.appendChild(dot);
  div.appendChild(body);
  div.appendChild(x);

  ui.toastWrap.appendChild(div);
  setTimeout(() => div.remove(), 6000);
}

function saveLocal() {
  localStorage.setItem(LS_KEYS.baseUrl, state.baseUrl || '');
  localStorage.setItem(LS_KEYS.token, state.token || '');
}

function loadLocal() {
  const base = localStorage.getItem(LS_KEYS.baseUrl);
  const tok = localStorage.getItem(LS_KEYS.token);
  if (base) {
    state.baseUrl = base;
    ui.baseUrlInput.value = base;
  }
  if (tok) {
    state.token = tok;
    ui.tokenInput.value = tok;
  }
}

function buildUrl(path) {
  return (state.baseUrl || '').replace(/\/+$/, '') + path;
}

async function apiRequest(method, path, body) {
  if (!state.baseUrl || !state.token) {
    throw new Error('Missing base URL or token');
  }
  const res = await fetch(buildUrl(path), {
    method,
    headers: {
      'Content-Type': 'application/json',
      Authorization: 'Bearer ' + state.token,
    },
    body: body ? JSON.stringify(body) : undefined,
  });
  if (!res.ok) {
    const text = await res.text().catch(() => '');
    throw new Error('HTTP ' + res.status + ' – ' + text);
  }
  return res.status === 204 ? null : res.json();
}

const api = {
  get: (path) => apiRequest('GET', path),
  post: (path, body) => apiRequest('POST', path, body),
  put: (path, body) => apiRequest('PUT', path, body),
  delete: (path) => apiRequest('DELETE', path),
};

// ---------- rendering helpers ----------
function clearChildren(node) {
  while (node.firstChild) node.removeChild(node.firstChild);
}

function findCategory(id) {
  return state.categories.find((c) => c.id === id) || null;
}
function findPersona(id) {
  return state.personas.find((p) => p.id === id) || null;
}
function findMission(id) {
  return state.missions.find((m) => m.id === id) || null;
}

function linesToArray(value) {
  if (!value) return [];
  return value
    .split(/[\n,]/)
    .map((x) => x.trim())
    .filter(Boolean);
}

function arrayToLines(arr) {
  if (!arr || !arr.length) return '';
  return arr.join('\n');
}

// ---------- categories ----------
function renderCategories() {
  clearChildren(ui.categoryList);
  state.categories.sort((a, b) => (a.label || '').localeCompare(b.label || ''));
  state.categories.forEach((cat) => {
    const div = document.createElement('div');
    div.className = 'category-pill' + (cat.id === state.selectedCategoryId ? ' active' : '');
    div.onclick = () => selectCategory(cat.id);

    const main = document.createElement('div');
    main.className = 'category-pill-main';
    const name = document.createElement('div');
    name.className = 'category-pill-name';
    name.textContent = cat.label + (cat.code ? ' (' + cat.code + ')' : '');
    const meta = document.createElement('div');
    meta.className = 'category-pill-meta';
    meta.textContent = cat.description || '';
    main.appendChild(name);
    main.appendChild(meta);

    div.appendChild(main);
    ui.categoryList.appendChild(div);
  });
}

function selectCategory(id) {
  state.selectedCategoryId = id;
  const cat = findCategory(id);
  if (!cat) {
    ui.catNameInput.value = '';
    ui.catCodeInput.value = '';
    ui.catSubtitleInput.value = '';
    ui.catMinLevelInput.value = '1';
  } else {
    ui.catNameInput.value = cat.label || '';
    ui.catCodeInput.value = cat.code || '';
    ui.catSubtitleInput.value = cat.description || '';
    ui.catMinLevelInput.value = cat.minLevel || 1;
  }
  renderCategories();
  refreshMissionCategorySelect();
}

async function saveCategory() {
  const label = ui.catNameInput.value.trim();
  const code = ui.catCodeInput.value.trim();
  if (!label || !code) {
    showToast('warning', 'Missing data', 'Category name and code are required.');
    return;
  }
  const payload = {
    label,
    code,
    description: ui.catSubtitleInput.value.trim() || null,
    minLevel: Number(ui.catMinLevelInput.value || 1),
  };

  try {
    if (state.selectedCategoryId) {
      await api.put(API_ROUTES.updateCategory(state.selectedCategoryId), payload);
      showToast('ok', 'Category updated', label);
    } else {
      const res = await api.post(API_ROUTES.createCategory, payload);
      state.selectedCategoryId = res.id;
      showToast('ok', 'Category created', label);
    }
    await reloadMeta();
  } catch (e) {
    console.error(e);
    showToast('error', 'Category save failed', e.message);
  }
}

async function deleteCategory() {
  if (!state.selectedCategoryId) return;
  if (!confirm('Delete this category? Missions using it might break.')) return;
  try {
    await api.delete(API_ROUTES.deleteCategory(state.selectedCategoryId));
    state.selectedCategoryId = null;
    showToast('ok', 'Category deleted', '');
    await reloadMeta();
  } catch (e) {
    console.error(e);
    showToast('error', 'Delete failed', e.message);
  }
}

function newCategory() {
  state.selectedCategoryId = null;
  ui.catNameInput.value = '';
  ui.catCodeInput.value = '';
  ui.catSubtitleInput.value = '';
  ui.catMinLevelInput.value = '1';
  renderCategories();
}

// ---------- personas ----------
function renderPersonas() {
  clearChildren(ui.personaList);
  const personas = [...state.personas].sort((a, b) => (a.name || '').localeCompare(b.name || ''));
  personas.forEach((p) => {
    const div = document.createElement('div');
    div.className = 'persona-pill' + (p.id === state.selectedPersonaId ? ' active' : '');
    div.onclick = () => selectPersona(p.id);

    const main = document.createElement('div');
    main.className = 'persona-pill-main';
    const name = document.createElement('div');
    name.className = 'persona-pill-name';
    name.textContent = (p.name || 'Unnamed') + (p.code ? ' (' + p.code + ')' : '');
    const meta = document.createElement('div');
    meta.className = 'persona-pill-meta';
    meta.textContent = (p.shortLabel || '').slice(0, 80);
    main.appendChild(name);
    main.appendChild(meta);

    div.appendChild(main);
    ui.personaList.appendChild(div);
  });

  refreshMissionPersonaSelect();
}

function selectPersona(id) {
  state.selectedPersonaId = id;
  const p = findPersona(id);
  if (!p) {
    ui.personaModeLabel.textContent = 'Create a new persona.';
    ui.personaCodeInput.value = '';
    ui.personaNameInput.value = '';
    ui.personaShortLabelInput.value = '';
    ui.personaDescriptionInput.value = '';
    ui.personaStyleInput.value = '';
    ui.personaAvatarInput.value = '';
    ui.personaDifficultySelect.value = '1';
    ui.personaActiveSelect.value = 'true';
    ui.personaVoicePresetInput.value = '';
  } else {
    ui.personaModeLabel.textContent = 'Editing persona: ' + (p.name || '');
    ui.personaCodeInput.value = p.code || '';
    ui.personaNameInput.value = p.name || '';
    ui.personaShortLabelInput.value = p.shortLabel || '';
    ui.personaDescriptionInput.value = p.description || '';
    ui.personaStyleInput.value = p.style || '';
    ui.personaAvatarInput.value = p.avatarUrl || '';
    ui.personaDifficultySelect.value = String(p.difficulty || 1);
    ui.personaActiveSelect.value = String(p.active !== false);
    ui.personaVoicePresetInput.value = p.voicePreset || '';
  }
  renderPersonas();
  refreshMissionPersonaSelect();
}

function newPersona() {
  state.selectedPersonaId = null;
  selectPersona(null);
}

async function savePersona() {
  const code = ui.personaCodeInput.value.trim();
  const name = ui.personaNameInput.value.trim();
  if (!code || !name) {
    showToast('warning', 'Missing data', 'Persona code and name are required.');
    return;
  }
  const payload = {
    code,
    name,
    shortLabel: ui.personaShortLabelInput.value.trim() || null,
    description: ui.personaDescriptionInput.value.trim() || null,
    style: ui.personaStyleInput.value.trim() || null,
    avatarUrl: ui.personaAvatarInput.value.trim() || null,
    difficulty: Number(ui.personaDifficultySelect.value || 1),
    active: ui.personaActiveSelect.value !== 'false',
    voicePreset: ui.personaVoicePresetInput.value.trim() || null,
  };
  try {
    if (state.selectedPersonaId) {
      await api.put(API_ROUTES.updatePersona(state.selectedPersonaId), payload);
      showToast('ok', 'Persona updated', name);
    } else {
      const res = await api.post(API_ROUTES.createPersona, payload);
      state.selectedPersonaId = res.id;
      showToast('ok', 'Persona created', name);
    }
    await reloadMeta();
  } catch (e) {
    console.error(e);
    showToast('error', 'Persona save failed', e.message);
  }
}

async function deletePersona() {
  if (!state.selectedPersonaId) return;
  if (!confirm('Delete this persona? Missions using it may fail.')) return;
  try {
    await api.delete(API_ROUTES.deletePersona(state.selectedPersonaId));
    state.selectedPersonaId = null;
    showToast('ok', 'Persona deleted', '');
    await reloadMeta();
  } catch (e) {
    console.error(e);
    showToast('error', 'Persona delete failed', e.message);
  }
}

// ---------- missions list ----------
function refreshMissionCategorySelect() {
  const prev = ui.missionCategorySelect.value;
  clearChildren(ui.missionCategorySelect);
  const optEmpty = document.createElement('option');
  optEmpty.value = '';
  optEmpty.textContent = '– choose category –';
  ui.missionCategorySelect.appendChild(optEmpty);

  state.categories.forEach((cat) => {
    const o = document.createElement('option');
    o.value = cat.id;
    o.textContent = cat.label || cat.code || 'Category';
    ui.missionCategorySelect.appendChild(o);
  });
  if (prev) ui.missionCategorySelect.value = prev;
}

function refreshMissionPersonaSelect() {
  const prev = ui.missionPersonaSelect.value;
  clearChildren(ui.missionPersonaSelect);
  const optEmpty = document.createElement('option');
  optEmpty.value = '';
  optEmpty.textContent = '– choose persona –';
  ui.missionPersonaSelect.appendChild(optEmpty);

  state.personas.forEach((p) => {
    const o = document.createElement('option');
    o.value = p.id;
    o.textContent = p.name || p.code || 'Persona';
    ui.missionPersonaSelect.appendChild(o);
  });
  if (prev) ui.missionPersonaSelect.value = prev;
}

function renderMissions() {
  clearChildren(ui.missionsList);
  const term = (state.missionSearch || '').toLowerCase();

  let missions = [...state.missions];
  missions.sort((a, b) => {
    if (a.laneIndex !== b.laneIndex) return a.laneIndex - b.laneIndex;
    return a.orderIndex - b.orderIndex;
  });

  if (term) {
    missions = missions.filter((m) => {
      const cat = findCategory(m.categoryId);
      const persona = findPersona(m.personaId);
      return (
        (m.title || '').toLowerCase().includes(term) ||
        (m.code || '').toLowerCase().includes(term) ||
        (cat?.label || '').toLowerCase().includes(term) ||
        (persona?.name || '').toLowerCase().includes(term)
      );
    });
  }

  if (!missions.length) {
    ui.missionsSummary.textContent = 'No missions loaded.';
    return;
  }

  const lanes = new Map();
  missions.forEach((m) => {
    const key = m.laneIndex ?? 0;
    if (!lanes.has(key)) lanes.set(key, []);
    lanes.get(key).push(m);
  });

  Array.from(lanes.keys())
    .sort((a, b) => a - b)
    .forEach((lane) => {
      const header = document.createElement('div');
      header.className = 'lane-header';
      header.innerHTML = `<span>Lane ${lane}</span><span>${lanes.get(lane).length} missions</span>`;
      ui.missionsList.appendChild(header);

      const bucket = document.createElement('div');
      bucket.className = 'lane-bucket';
      ui.missionsList.appendChild(bucket);

      lanes.get(lane).forEach((m) => {
        const row = document.createElement('div');
        row.className =
          'mission-row' + (m.id === state.selectedMissionId ? ' active' : '');
        row.dataset.id = m.id;

        const handle = document.createElement('div');
        handle.className = 'drag-handle';
        handle.textContent = '≡';

        const main = document.createElement('div');
        main.className = 'mission-main';
        const title = document.createElement('div');
        title.className = 'mission-title';
        title.textContent = m.title || m.code || 'Untitled mission';
        const meta = document.createElement('div');
        meta.className = 'mission-meta';
        const cat = findCategory(m.categoryId);
        const persona = findPersona(m.personaId);
        const tags = [
          m.code,
          cat ? cat.code : null,
          persona ? persona.name : null,
          m.difficulty,
          m.goalType,
          (m.baseXpReward || 0) + ' XP',
        ].filter(Boolean);
        tags.forEach((t) => {
          const span = document.createElement('span');
          span.textContent = t;
          meta.appendChild(span);
        });
        main.appendChild(title);
        main.appendChild(meta);

        const controls = document.createElement('div');
        controls.className = 'mission-controls';
        const btnUp = document.createElement('button');
        btnUp.className = 'btn-ghost btn-small';
        btnUp.textContent = '↑';
        btnUp.onclick = (ev) => {
          ev.stopPropagation();
          moveMission(m.id, -1);
        };
        const btnDown = document.createElement('button');
        btnDown.className = 'btn-ghost btn-small';
        btnDown.textContent = '↓';
        btnDown.onclick = (ev) => {
          ev.stopPropagation();
          moveMission(m.id, 1);
        };
        controls.appendChild(btnUp);
        controls.appendChild(btnDown);

        row.onclick = () => selectMission(m.id);

        row.appendChild(handle);
        row.appendChild(main);
        row.appendChild(controls);

        bucket.appendChild(row);
      });
    });

  ui.missionsSummary.textContent = `${missions.length} missions loaded.`;
}

function markOrderingDirty() {
  state.orderingDirty = true;
  ui.orderingBanner.classList.add('show');
}

function moveMission(id, delta) {
  const m = findMission(id);
  if (!m) return;
  const lane = m.laneIndex ?? 0;
  const laneMissions = state.missions
    .filter((x) => (x.laneIndex ?? 0) === lane)
    .sort((a, b) => a.orderIndex - b.orderIndex);

  const idx = laneMissions.findIndex((x) => x.id === id);
  const swapWith = laneMissions[idx + delta];
  if (!swapWith) return;

  const tmp = m.orderIndex;
  m.orderIndex = swapWith.orderIndex;
  swapWith.orderIndex = tmp;

  markOrderingDirty();
  renderMissions();
}

function normalizeOrdering() {
  const byLane = new Map();
  state.missions.forEach((m) => {
    const lane = m.laneIndex ?? 0;
    if (!byLane.has(lane)) byLane.set(lane, []);
    byLane.get(lane).push(m);
  });
  byLane.forEach((list) => {
    list
      .sort((a, b) => a.orderIndex - b.orderIndex)
      .forEach((m, i) => {
        m.orderIndex = i + 1;
      });
  });
  markOrderingDirty();
  renderMissions();
}

async function saveOrdering() {
  if (!state.orderingDirty) return;
  const payload = state.missions.map((m) => ({
    id: m.id,
    laneIndex: m.laneIndex ?? 0,
    orderIndex: m.orderIndex ?? 0,
  }));
  try {
    await api.post(API_ROUTES.reorderMissions, { ordering: payload });
    state.orderingDirty = false;
    ui.orderingBanner.classList.remove('show');
    showToast('ok', 'Ordering saved', 'Mission order updated.');
    await reloadMissions();
  } catch (e) {
    console.error(e);
    showToast('error', 'Save ordering failed', e.message);
  }
}

// ---------- mission form + AI contract ----------
function selectMission(id) {
  state.selectedMissionId = id;
  const m = findMission(id);
  if (!m) {
    ui.missionModeLabel.textContent =
      'Create a new mission or click one on the right to edit it.';
    clearMissionForm();
    return;
  }
  ui.missionModeLabel.textContent = 'Editing mission: ' + (m.title || m.code);

  ui.missionCodeInput.value = m.code || '';
  ui.missionTitleInput.value = m.title || '';
  ui.missionDescInput.value = m.description || '';
  ui.missionCategorySelect.value = m.categoryId || '';
  ui.missionGoalTypeSelect.value = m.goalType || 'OPENING';
  ui.missionPersonaSelect.value = m.personaId || '';
  ui.missionDifficultySelect.value = m.difficulty || 'EASY';
  ui.missionLaneInput.value = m.laneIndex ?? 0;
  ui.missionOrderInput.value = m.orderIndex ?? 1;
  ui.missionActiveSelect.value = m.active === false ? 'false' : 'true';
  ui.missionTimeLimitInput.value = m.timeLimitSec ?? 30;
  ui.missionMaxMessagesInput.value = m.maxMessages ?? '';
  ui.missionWordLimitInput.value = m.wordLimit ?? '';
  ui.missionXpInput.value = m.baseXpReward ?? 60;
  ui.missionCoinsInput.value = m.baseCoinsReward ?? 10;
  ui.missionGemsInput.value = m.baseGemsReward ?? 0;

  loadAiContractForm(m.aiContract || {}, m);
  updateMissionPreview();
  renderMissions();
}

function clearMissionForm() {
  state.selectedMissionId = null;
  ui.missionCodeInput.value = '';
  ui.missionTitleInput.value = '';
  ui.missionDescInput.value = '';
  ui.missionCategorySelect.value = '';
  ui.missionGoalTypeSelect.value = 'OPENING';
  ui.missionPersonaSelect.value = '';
  ui.missionDifficultySelect.value = 'EASY';
  ui.missionLaneInput.value = '0';
  ui.missionOrderInput.value = '1';
  ui.missionActiveSelect.value = 'true';
  ui.missionTimeLimitInput.value = '30';
  ui.missionMaxMessagesInput.value = '';
  ui.missionWordLimitInput.value = '';
  ui.missionXpInput.value = '60';
  ui.missionCoinsInput.value = '10';
  ui.missionGemsInput.value = '0';

  loadAiContractForm({}, null);
  updateMissionPreview();
  renderMissions();
}

function duplicateMission() {
  const m = findMission(state.selectedMissionId);
  if (!m) return;
  clearMissionForm();
  ui.missionCodeInput.value = (m.code || '') + '_COPY';
  ui.missionTitleInput.value = (m.title || '') + ' (copy)';
  ui.missionDescInput.value = m.description || '';
  ui.missionCategorySelect.value = m.categoryId || '';
  ui.missionGoalTypeSelect.value = m.goalType || 'OPENING';
  ui.missionPersonaSelect.value = m.personaId || '';
  ui.missionDifficultySelect.value = m.difficulty || 'EASY';
  ui.missionLaneInput.value = m.laneIndex ?? 0;
  ui.missionOrderInput.value = (m.orderIndex ?? 0) + 1;
  ui.missionActiveSelect.value = m.active === false ? 'false' : 'true';
  ui.missionTimeLimitInput.value = m.timeLimitSec ?? 30;
  ui.missionMaxMessagesInput.value = m.maxMessages ?? '';
  ui.missionWordLimitInput.value = m.wordLimit ?? '';
  ui.missionXpInput.value = m.baseXpReward ?? 60;
  ui.missionCoinsInput.value = m.baseCoinsReward ?? 10;
  ui.missionGemsInput.value = m.baseGemsReward ?? 0;

  loadAiContractForm(m.aiContract || {}, m);
  updateMissionPreview();
}

function getMissionFormValues() {
  const code = ui.missionCodeInput.value.trim();
  const title = ui.missionTitleInput.value.trim();
  if (!code || !title) {
    throw new Error('Mission code and title are required.');
  }
  const laneIndex = Number(ui.missionLaneInput.value || 0);
  const orderIndex = Number(ui.missionOrderInput.value || 1);
  const mission = {
    code,
    title,
    description: ui.missionDescInput.value.trim(),
    categoryId: ui.missionCategorySelect.value || null,
    personaId: ui.missionPersonaSelect.value || null,
    laneIndex,
    orderIndex,
    active: ui.missionActiveSelect.value !== 'false',
    timeLimitSec: Number(ui.missionTimeLimitInput.value || 0) || null,
    maxMessages: ui.missionMaxMessagesInput.value
      ? Number(ui.missionMaxMessagesInput.value)
      : null,
    wordLimit: ui.missionWordLimitInput.value
      ? Number(ui.missionWordLimitInput.value)
      : null,
    baseXpReward: Number(ui.missionXpInput.value || 0),
    baseCoinsReward: Number(ui.missionCoinsInput.value || 0),
    baseGemsReward: Number(ui.missionGemsInput.value || 0),
    goalType: ui.missionGoalTypeSelect.value || 'OPENING',
    difficulty: ui.missionDifficultySelect.value || 'EASY',
    isVoiceSupported: false,
  };
  mission.aiContract = buildAiContractFromForm(mission);
  return mission;
}

function updateMissionPreview() {
  const title = ui.missionTitleInput.value || '(no title)';
  const desc = ui.missionDescInput.value || '';
  ui.missionPreviewText.textContent = title + ' – ' + desc;

  clearChildren(ui.missionPreviewTags);
  const cat = findCategory(ui.missionCategorySelect.value || null);
  const persona = findPersona(ui.missionPersonaSelect.value || null);
  const tags = [];
  if (cat) tags.push('Category: ' + (cat.label || cat.code));
  if (persona) tags.push('Persona: ' + (persona.name || persona.code));
  tags.push('Difficulty: ' + (ui.missionDifficultySelect.value || 'EASY'));
  tags.push('Goal: ' + (ui.missionGoalTypeSelect.value || 'OPENING'));
  tags.push((ui.missionXpInput.value || 0) + ' XP');
  tags.forEach((t) => {
    const span = document.createElement('span');
    span.className = 'preview-tag';
    span.textContent = t;
    ui.missionPreviewTags.appendChild(span);
  });
}

// ---------- AI contract bind/parse ----------
function loadAiContractForm(contract, mission) {
  contract = contract || {};
  const meta = contract.meta || {};
  const persona = contract.persona || {};
  const speaking = persona.speakingStyle || {};
  const scenario = contract.scenario || {};
  const objectives = contract.objectives || {};
  const hard = objectives.hardConstraints || {};
  const rules = contract.conversationRules || {};
  const respLen = rules.responseLength || {};
  const scoring = contract.scoringGuide || {};
  const thresholds = scoring.scoreThresholds || {};
  const realtime = contract.realtimeFeedback || {};
  const output = contract.outputFormat || {};
  const safety = contract.safety || {};

  ui.aiMetaLanguageInput.value = meta.language || 'en';
  ui.aiMetaMaxTurnsInput.value =
    meta.maxTurns || mission?.maxMessages || '';

  ui.aiPersonaDisplayNameInput.value =
    persona.displayName || mission?.title || '';
  ui.aiPersonaBaselineSelect.value = persona.baselineInterest || '';
  ui.aiPersonaShortBioTextarea.value = persona.shortBio || '';
  ui.aiPersonaToneInput.value = speaking.tone || '';
  ui.aiPersonaSlangInput.value = speaking.slangLevel || '';
  ui.aiPersonaEmojiInput.value = speaking.emojiUsage || '';
  ui.aiPersonaMsgLengthInput.value = speaking.messageLength || '';
  ui.aiPersonaTraitsTextarea.value = arrayToLines(
    persona.personalityTraits || []
  );
  ui.aiPersonaValuesTextarea.value = arrayToLines(
    persona.valuesAndBoundaries || []
  );

  ui.aiScenarioPlatformSelect.value = scenario.platform || '';
  ui.aiScenarioRelationshipInput.value =
    scenario.relationshipContext || '';
  ui.aiScenarioStartingTextarea.value =
    scenario.startingSituation || '';
  ui.aiScenarioUserRoleInput.value = scenario.userRole || '';
  ui.aiScenarioHiddenTextarea.value = scenario.hiddenBackstory || '';

  ui.aiObjectivesPrimaryInput.value = objectives.primary || '';
  ui.aiObjectivesSecondaryTextarea.value = arrayToLines(
    objectives.secondary || []
  );
  ui.aiObjectivesSuccessTextarea.value = arrayToLines(
    objectives.successCriteria || []
  );
  ui.aiObjectivesFailTextarea.value = arrayToLines(
    objectives.failCriteria || []
  );
  ui.aiConstraintsMaxWordsInput.value =
    hard.maxWordsPerMessage || mission?.wordLimit || '';
  ui.aiConstraintsBannedTextarea.value = arrayToLines(
    hard.bannedMoves || []
  );
  ui.aiConstraintsRequiredTextarea.value = arrayToLines(
    hard.requiredMoves || []
  );

  ui.aiRulesToneTextarea.value = arrayToLines(
    rules.toneRules || []
  );
  ui.aiRulesMinSentencesInput.value = respLen.minSentences || '';
  ui.aiRulesMaxSentencesInput.value = respLen.maxSentences || '';
  ui.aiRulesChallengeInput.value = rules.challengeLevel || '';
  ui.aiRulesEscalationTextarea.value = arrayToLines(
    rules.escalationRules || []
  );
  ui.aiRulesEnergyTextarea.value = arrayToLines(
    rules.energyRules || []
  );
  ui.aiRulesTestingTextarea.value = arrayToLines(
    rules.testingRules || []
  );

  // scoring
  const dimsLines =
    (scoring.dimensions || [])
      .map((d) => {
        const weight =
          typeof d.weight === 'number' ? d.weight : '';
        return (
          (d.name || '') +
          '|' +
          weight +
          '|' +
          (d.description || '')
        );
      })
      .join('\n') || '';
  ui.aiScoringDimensionsTextarea.value = dimsLines;
  ui.aiScoringSuccessInput.value = thresholds.successScore || '';
  ui.aiScoringFailInput.value = thresholds.failScore || '';
  const rarityLines =
    (scoring.rarityPatterns || [])
      .map((r) => (r.code || '') + '|' + (r.description || ''))
      .join('\n') || '';
  ui.aiScoringRarityTextarea.value = rarityLines;

  // realtime
  ui.aiFeedbackEnabledSelect.value =
    realtime.enable === false ? 'false' : realtime.enable === true ? 'true' : '';
  ui.aiFeedbackPositiveTextarea.value = arrayToLines(
    realtime.positiveTags || []
  );
  ui.aiFeedbackNegativeTextarea.value = arrayToLines(
    realtime.negativeTags || []
  );
  ui.aiFeedbackPraiseTextarea.value = arrayToLines(
    realtime.praiseTemplates || []
  );
  ui.aiFeedbackNudgeTextarea.value = arrayToLines(
    realtime.nudgeTemplates || []
  );
  ui.aiFeedbackFailureTextarea.value = arrayToLines(
    realtime.failureTemplates || []
  );

  // output
  ui.aiOutputModeSelect.value = output.mode || 'json';
  ui.aiOutputSchemaTextarea.value = output.schemaDescription || '';
  try {
    ui.aiOutputExampleTextarea.value =
      output.exampleOutput != null
        ? JSON.stringify(output.exampleOutput, null, 2)
        : '';
  } catch {
    ui.aiOutputExampleTextarea.value = '';
  }

  // safety
  ui.aiSafetyDisallowedTextarea.value = arrayToLines(
    safety.disallowedTopics || []
  );
  ui.aiSafetyMustRefuseTextarea.value = arrayToLines(
    safety.mustRefuseIf || []
  );
  ui.aiSafetyRefusalStyleTextarea.value =
    safety.refusalStyle || '';
}

function buildAiContractFromForm(mission) {
  const category = findCategory(mission.categoryId);
  const language = ui.aiMetaLanguageInput.value.trim() || 'en';
  const metaMaxTurns =
    Number(ui.aiMetaMaxTurnsInput.value || 0) ||
    mission.maxMessages ||
    10;

  // scoring dimensions
  const dims = linesToArray(ui.aiScoringDimensionsTextarea.value).map(
    (line) => {
      const parts = line.split('|');
      const name = (parts[0] || '').trim();
      const weight = Number((parts[1] || '').trim() || 0);
      const description = (parts[2] || '').trim();
      return {
        name,
        description,
        weight: isNaN(weight) ? 0 : weight,
        goodExamples: [],
        badExamples: [],
      };
    }
  );

  const rarity = linesToArray(ui.aiScoringRarityTextarea.value).map(
    (line) => {
      const parts = line.split('|');
      const code = (parts[0] || '').trim();
      const description = (parts[1] || '').trim();
      return { code, description, examples: [] };
    }
  );

  let exampleOutput = null;
  const exText = ui.aiOutputExampleTextarea.value.trim();
  if (exText) {
    try {
      exampleOutput = JSON.parse(exText);
    } catch {
      exampleOutput = exText;
    }
  }

  const enableVal = ui.aiFeedbackEnabledSelect.value;
  const enableRealtime =
    enableVal === ''
      ? true
      : enableVal === 'true';

  const maxWords =
    Number(ui.aiConstraintsMaxWordsInput.value || 0) ||
    mission.wordLimit ||
    0;

  return {
    meta: {
      missionCode: mission.code,
      missionName: mission.title,
      categoryCode: category?.code || '',
      difficulty: mission.difficulty,
      language,
      maxTurns: metaMaxTurns,
    },
    persona: {
      displayName:
        ui.aiPersonaDisplayNameInput.value.trim() ||
        (findPersona(mission.personaId)?.name || ''),
      age: undefined,
      gender: 'female',
      shortBio: ui.aiPersonaShortBioTextarea.value.trim(),
      personalityTraits: linesToArray(
        ui.aiPersonaTraitsTextarea.value
      ),
      valuesAndBoundaries: linesToArray(
        ui.aiPersonaValuesTextarea.value
      ),
      speakingStyle: {
        tone: ui.aiPersonaToneInput.value.trim(),
        slangLevel: ui.aiPersonaSlangInput.value.trim(),
        emojiUsage: ui.aiPersonaEmojiInput.value.trim(),
        messageLength: ui.aiPersonaMsgLengthInput.value.trim(),
      },
      baselineInterest:
        ui.aiPersonaBaselineSelect.value || 'neutral',
    },
    scenario: {
      platform: ui.aiScenarioPlatformSelect.value || 'tinder',
      relationshipContext:
        ui.aiScenarioRelationshipInput.value.trim(),
      startingSituation:
        ui.aiScenarioStartingTextarea.value.trim(),
      userRole: ui.aiScenarioUserRoleInput.value.trim(),
      hiddenBackstory:
        ui.aiScenarioHiddenTextarea.value.trim() || undefined,
    },
    objectives: {
      primary: ui.aiObjectivesPrimaryInput.value.trim(),
      secondary: linesToArray(
        ui.aiObjectivesSecondaryTextarea.value
      ),
      successCriteria: linesToArray(
        ui.aiObjectivesSuccessTextarea.value
      ),
      failCriteria: linesToArray(
        ui.aiObjectivesFailTextarea.value
      ),
      hardConstraints: {
        maxTurns: metaMaxTurns,
        maxWordsPerMessage: maxWords,
        bannedMoves: linesToArray(
          ui.aiConstraintsBannedTextarea.value
        ),
        requiredMoves: linesToArray(
          ui.aiConstraintsRequiredTextarea.value
        ),
      },
    },
    conversationRules: {
      toneRules: linesToArray(ui.aiRulesToneTextarea.value),
      responseLength: {
        minSentences: Number(
          ui.aiRulesMinSentencesInput.value || 0
        ),
        maxSentences: Number(
          ui.aiRulesMaxSentencesInput.value || 0
        ),
      },
      challengeLevel: ui.aiRulesChallengeInput.value.trim(),
      escalationRules: linesToArray(
        ui.aiRulesEscalationTextarea.value
      ),
      energyRules: linesToArray(
        ui.aiRulesEnergyTextarea.value
      ),
      testingRules: linesToArray(
        ui.aiRulesTestingTextarea.value
      ),
    },
    scoringGuide: {
      dimensions: dims,
      rarityPatterns: rarity,
      scoreThresholds: {
        successScore: Number(
          ui.aiScoringSuccessInput.value || 70
        ),
        failScore: Number(ui.aiScoringFailInput.value || 40),
      },
    },
    realtimeFeedback: {
      enable: enableRealtime,
      positiveTags: linesToArray(
        ui.aiFeedbackPositiveTextarea.value
      ),
      negativeTags: linesToArray(
        ui.aiFeedbackNegativeTextarea.value
      ),
      praiseTemplates: linesToArray(
        ui.aiFeedbackPraiseTextarea.value
      ),
      nudgeTemplates: linesToArray(
        ui.aiFeedbackNudgeTextarea.value
      ),
      failureTemplates: linesToArray(
        ui.aiFeedbackFailureTextarea.value
      ),
    },
    outputFormat: {
      mode: ui.aiOutputModeSelect.value || 'json',
      schemaDescription:
        ui.aiOutputSchemaTextarea.value.trim(),
      exampleOutput,
    },
    safety: {
      disallowedTopics: linesToArray(
        ui.aiSafetyDisallowedTextarea.value
      ),
      mustRefuseIf: linesToArray(
        ui.aiSafetyMustRefuseTextarea.value
      ),
      refusalStyle:
        ui.aiSafetyRefusalStyleTextarea.value.trim(),
    },
  };
}

// ---------- mission save/delete ----------
async function saveMission() {
  let mission;
  try {
    mission = getMissionFormValues();
  } catch (e) {
    showToast('warning', 'Missing mission data', e.message);
    return;
  }
  const isUpdate = !!state.selectedMissionId;
  try {
    let res;
    if (isUpdate) {
      res = await api.put(
        API_ROUTES.updateMission(state.selectedMissionId),
        mission
      );
    } else {
      res = await api.post(API_ROUTES.createMission, mission);
      state.selectedMissionId = res.id;
    }
    showToast('ok', isUpdate ? 'Mission updated' : 'Mission created', mission.title);
    await reloadMissions();
    if (res?.id) selectMission(res.id);
  } catch (e) {
    console.error(e);
    showToast('error', 'Mission save failed', e.message);
  }
}

async function deleteMission() {
  if (!state.selectedMissionId) return;
  if (!confirm('Delete this mission?')) return;
  try {
    await api.delete(API_ROUTES.deleteMission(state.selectedMissionId));
    state.selectedMissionId = null;
    showToast('ok', 'Mission deleted', '');
    await reloadMissions();
    clearMissionForm();
  } catch (e) {
    console.error(e);
    showToast('error', 'Mission delete failed', e.message);
  }
}

// ---------- data loading ----------
async function reloadMeta() {
  const meta = await api.get(API_ROUTES.meta);
  state.categories = meta.categories || [];
  state.personas = meta.personas || [];
  renderCategories();
  renderPersonas();
  refreshMissionCategorySelect();
  refreshMissionPersonaSelect();
}

async function reloadMissions() {
  const res = await api.get(API_ROUTES.listMissions);
  state.missions = res.missions || res || [];
  state.orderingDirty = false;
  ui.orderingBanner.classList.remove('show');
  renderMissions();
}

async function connectAndLoad() {
  state.baseUrl = ui.baseUrlInput.value.trim();
  state.token = ui.tokenInput.value.trim();
  saveLocal();

  if (!state.baseUrl || !state.token) {
    showToast('warning', 'Missing connection info', 'Base URL and token are required.');
    return;
  }

  setStatus('warning', 'Connecting…');
  try {
    await reloadMeta();
    await reloadMissions();
    state.connected = true;
    setStatus('ok', 'Connected – data loaded.');
    showToast('ok', 'Connected', 'Categories, personas and missions loaded.');
  } catch (e) {
    console.error(e);
    state.connected = false;
    setStatus('error', 'Connection failed.');
    showToast('error', 'Connection failed', e.message);
  }
}

function clearAllState() {
  state.categories = [];
  state.personas = [];
  state.missions = [];
  state.selectedCategoryId = null;
  state.selectedPersonaId = null;
  state.selectedMissionId = null;
  state.orderingDirty = false;
  ui.orderingBanner.classList.remove('show');
  renderCategories();
  renderPersonas();
  renderMissions();
  clearMissionForm();
  setStatus('idle', 'Idle – not connected');
}

// ---------- AI section collapsibles ----------
function initAiSections() {
  document.querySelectorAll('.ai-section').forEach((section) => {
    const header = section.querySelector('.ai-section-header');
    if (!header) return;
    header.addEventListener('click', (e) => {
      // avoid toggling when clicking inside select/input
      if (e.target.tagName === 'SELECT' || e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
        return;
      }
      section.classList.toggle('ai-collapsed');
    });
  });
}

// ---------- init ----------
function init() {
  loadLocal();
  setStatus('idle', 'Idle – not connected');

  ui.connectBtn.addEventListener('click', connectAndLoad);
  ui.clearBtn.addEventListener('click', () => {
    localStorage.removeItem(LS_KEYS.baseUrl);
    localStorage.removeItem(LS_KEYS.token);
    clearAllState();
  });

  // categories
  ui.newCategoryBtn.addEventListener('click', newCategory);
  ui.saveCategoryBtn.addEventListener('click', saveCategory);
  ui.deleteCategoryBtn.addEventListener('click', deleteCategory);

  // personas
  ui.newPersonaBtn.addEventListener('click', newPersona);
  ui.savePersonaBtn.addEventListener('click', savePersona);
  ui.deletePersonaBtn.addEventListener('click', deletePersona);

  // missions list
  ui.missionSearchInput.addEventListener('input', (e) => {
    state.missionSearch = e.target.value || '';
    renderMissions();
  });
  ui.normalizeOrderingBtn.addEventListener('click', normalizeOrdering);
  ui.saveOrderingBtn.addEventListener('click', saveOrdering);
  ui.reloadAllBtn.addEventListener('click', async () => {
    if (!state.baseUrl || !state.token) {
      showToast('warning', 'Not connected', 'Set base URL and token first.');
      return;
    }
    await connectAndLoad();
  });

  // mission form
  [
    ui.missionCodeInput,
    ui.missionTitleInput,
    ui.missionDescInput,
    ui.missionCategorySelect,
    ui.missionGoalTypeSelect,
    ui.missionPersonaSelect,
    ui.missionDifficultySelect,
    ui.missionXpInput,
  ].forEach((input) => {
    if (!input) return;
    input.addEventListener('input', updateMissionPreview);
    input.addEventListener('change', updateMissionPreview);
  });

  ui.newMissionBtn.addEventListener('click', clearMissionForm);
  ui.duplicateMissionBtn.addEventListener('click', duplicateMission);
  ui.saveMissionBtn.addEventListener('click', saveMission);
  ui.deleteMissionBtn.addEventListener('click', deleteMission);

  initAiSections();
  updateMissionPreview();
}

document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
