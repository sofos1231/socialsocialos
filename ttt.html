<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>SocialGym – Mission Road Builder</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      :root {
        --bg: #020617;
        --bg2: #040a1d;
        --card: rgba(3, 7, 18, 0.92);
        --card2: rgba(2, 6, 23, 0.92);
        --border: rgba(148, 163, 184, 0.18);
        --border-strong: rgba(148, 163, 184, 0.32);
        --text: #f8fafc;
        --text2: #e2e8f0;
        --muted: rgba(226, 232, 240, 0.7);
        --muted2: rgba(226, 232, 240, 0.5);

        --accent: #22c55e;
        --accent2: #16a34a;
        --accent-soft: rgba(34, 197, 94, 0.18);

        --danger: #ef4444;
        --danger-soft: rgba(239, 68, 68, 0.16);

        --warning: #f59e0b;
        --warning-soft: rgba(245, 158, 11, 0.12);

        --shadow: 0 18px 40px rgba(0, 0, 0, 0.45);
        --shadow2: 0 10px 22px rgba(0, 0, 0, 0.35);

        --pill: rgba(15, 23, 42, 0.72);
        --pill2: rgba(2, 6, 23, 0.85);

        --scroll-track: rgba(2, 6, 23, 0.7);
        --scroll-thumb: rgba(148, 163, 184, 0.22);

        --radius: 18px;
        --radius2: 14px;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        padding: 18px;
        background: radial-gradient(
            1200px 600px at 20% 0%,
            rgba(34, 197, 94, 0.16),
            transparent 60%
          ),
          radial-gradient(
            900px 520px at 80% 0%,
            rgba(56, 189, 248, 0.12),
            transparent 60%
          ),
          linear-gradient(180deg, var(--bg2), var(--bg));
        font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto,
          Helvetica, Arial, 'Apple Color Emoji', 'Segoe UI Emoji';
        color: var(--text);
      }

      ::-webkit-scrollbar {
        width: 10px;
      }
      ::-webkit-scrollbar-track {
        background: var(--scroll-track);
        border-radius: 999px;
      }
      ::-webkit-scrollbar-thumb {
        background: var(--scroll-thumb);
        border-radius: 999px;
      }

      .top {
        display: flex;
        align-items: flex-start;
        justify-content: space-between;
        gap: 14px;
        margin-bottom: 10px;
      }

      h1 {
        margin: 0;
        font-size: 24px;
        letter-spacing: 0.02em;
      }

      .subtitle {
        margin: 6px 0 0 0;
        font-size: 13px;
        color: var(--muted);
        max-width: 860px;
        line-height: 1.4;
      }

      .badge {
        display: inline-flex;
        align-items: center;
        gap: 10px;
        padding: 8px 12px;
        border-radius: 999px;
        background: rgba(2, 6, 23, 0.75);
        border: 1px solid var(--border);
        box-shadow: var(--shadow2);
        font-size: 12px;
        color: var(--text2);
        user-select: none;
      }

      .badge-dot {
        width: 10px;
        height: 10px;
        border-radius: 999px;
        background: #64748b;
        box-shadow: 0 0 0 3px rgba(148, 163, 184, 0.12);
      }

      .layout {
        margin-top: 14px;
        display: grid;
        grid-template-columns: minmax(320px, 1.05fr) minmax(360px, 1.55fr) minmax(
            360px,
            1.3fr
          );
        gap: 14px;
      }

      .card {
        background: linear-gradient(
          180deg,
          rgba(2, 6, 23, 0.92),
          rgba(2, 6, 23, 0.82)
        );
        border-radius: var(--radius);
        border: 1px solid var(--border);
        padding: 14px 14px 16px 14px;
        box-shadow: var(--shadow);
        backdrop-filter: blur(10px);
      }

      .card-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        gap: 10px;
        margin-bottom: 10px;
      }

      .card-title {
        font-size: 15px;
        font-weight: 700;
        letter-spacing: 0.02em;
      }

      .card-subtitle {
        margin-top: 4px;
        font-size: 12px;
        color: var(--muted);
        line-height: 1.35;
      }

      .small-pill {
        padding: 4px 10px;
        border-radius: 999px;
        background: var(--pill);
        border: 1px solid var(--border);
        font-size: 11px;
        color: var(--muted);
        white-space: nowrap;
        user-select: none;
      }

      .row {
        display: flex;
        gap: 10px;
        align-items: center;
        flex-wrap: wrap;
      }

      .field-group {
        margin-bottom: 10px;
      }

      .field-label {
        font-size: 11px;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        color: rgba(226, 232, 240, 0.68);
        margin-bottom: 5px;
      }

      .field-row {
        display: flex;
        gap: 8px;
        align-items: flex-start;
      }

      input[type='text'],
      input[type='number'],
      textarea,
      select {
        width: 100%;
        padding: 8px 10px;
        border-radius: 12px;
        border: 1px solid var(--border);
        background: rgba(2, 6, 23, 0.9);
        color: var(--text);
        font-size: 13px;
        outline: none;
        box-shadow: inset 0 0 0 1px rgba(15, 23, 42, 0.3);
      }

      textarea {
        resize: vertical;
        min-height: 54px;
        max-height: 180px;
      }

      input::placeholder,
      textarea::placeholder {
        color: rgba(148, 163, 184, 0.6);
      }

      input[type='text']:focus,
      input[type='number']:focus,
      textarea:focus,
      select:focus {
        border-color: rgba(34, 197, 94, 0.65);
        box-shadow: 0 0 0 3px rgba(34, 197, 94, 0.16);
      }

      button {
        border-radius: 999px;
        border: 1px solid transparent;
        cursor: pointer;
        font-size: 13px;
        padding: 8px 14px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        transition: transform 0.06s ease-out, box-shadow 0.1s ease-out,
          background 0.12s ease-out, opacity 0.12s ease-out,
          border-color 0.12s ease-out;
        user-select: none;
      }

      button:disabled {
        opacity: 0.55;
        cursor: default;
        transform: none;
        box-shadow: none;
      }

      .btn-primary {
        background: linear-gradient(135deg, var(--accent), var(--accent2));
        color: #032a1e;
        font-weight: 800;
        box-shadow: 0 16px 32px rgba(34, 197, 94, 0.25);
      }

      .btn-primary:hover:not(:disabled) {
        transform: translateY(-1px);
        box-shadow: 0 24px 40px rgba(34, 197, 94, 0.32);
      }

      .btn-ghost {
        background: rgba(2, 6, 23, 0.8);
        color: var(--text2);
        border: 1px solid var(--border);
      }

      .btn-ghost:hover:not(:disabled) {
        background: rgba(3, 7, 18, 0.9);
        border-color: var(--border-strong);
      }

      .btn-danger {
        background: var(--danger-soft);
        color: #fecaca;
        border: 1px solid rgba(248, 113, 113, 0.45);
      }

      .btn-danger:hover:not(:disabled) {
        background: rgba(239, 68, 68, 0.28);
        border-color: rgba(248, 113, 113, 0.55);
      }

      .btn-small {
        padding: 5px 10px;
        font-size: 11px;
        gap: 6px;
      }

      .btn-icon {
        width: 28px;
        height: 28px;
        padding: 0;
        border-radius: 12px;
      }

      .connection-grid {
        display: grid;
        grid-template-columns: minmax(0, 0.85fr) minmax(0, 1fr) auto;
        gap: 10px;
        align-items: end;
      }

      .connection-status {
        margin-top: 8px;
        font-size: 12px;
        color: var(--muted);
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .status-dot {
        width: 10px;
        height: 10px;
        border-radius: 999px;
      }

      .status-idle {
        background: #64748b;
      }
      .status-ok {
        background: #22c55e;
      }
      .status-error {
        background: #ef4444;
      }
      .status-warning {
        background: #f59e0b;
      }

      .hint {
        font-size: 11px;
        color: var(--muted2);
        margin-top: 8px;
        line-height: 1.35;
      }

      .kbd {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 1px 7px;
        border-radius: 8px;
        border: 1px solid var(--border);
        background: rgba(15, 23, 42, 0.7);
        font-size: 10px;
        color: rgba(226, 232, 240, 0.7);
      }

      .category-list,
      .persona-list {
        max-height: 270px;
        overflow-y: auto;
        margin-top: 6px;
        padding-right: 4px;
      }

      .category-pill,
      .persona-pill {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 8px 10px;
        border-radius: 14px;
        background: rgba(2, 6, 23, 0.78);
        border: 1px solid var(--border);
        margin-bottom: 6px;
        cursor: pointer;
        transition: background 0.12s ease-out, border-color 0.12s ease-out,
          transform 0.07s ease-out;
      }

      .category-pill:hover,
      .persona-pill:hover {
        background: rgba(3, 7, 18, 0.9);
        border-color: var(--border-strong);
        transform: translateY(-1px);
      }

      .category-pill.active,
      .persona-pill.active {
        border-color: rgba(34, 197, 94, 0.7);
        box-shadow: 0 0 0 3px rgba(34, 197, 94, 0.12);
        background: rgba(2, 16, 18, 0.72);
      }

      .category-pill-main,
      .persona-pill-main {
        display: flex;
        flex-direction: column;
        gap: 3px;
        min-width: 0;
      }

      .category-pill-name,
      .persona-pill-name {
        font-size: 12px;
        font-weight: 700;
        color: var(--text2);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .category-pill-meta,
      .persona-pill-meta {
        font-size: 11px;
        color: var(--muted);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .missions-list {
        max-height: 560px;
        overflow-y: auto;
        padding-right: 4px;
      }

      .lane-header {
        font-size: 11px;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        color: rgba(226, 232, 240, 0.55);
        margin: 10px 2px 6px;
        display: flex;
        align-items: center;
        justify-content: space-between;
      }

      .lane-bucket {
        border: 1px dashed rgba(148, 163, 184, 0.22);
        background: rgba(2, 6, 23, 0.55);
        border-radius: 16px;
        padding: 8px;
        margin-bottom: 10px;
      }

      .mission-row {
        border-radius: 16px;
        padding: 10px 10px;
        background: rgba(2, 6, 23, 0.85);
        border: 1px solid rgba(148, 163, 184, 0.18);
        display: grid;
        grid-template-columns: auto minmax(0, 1fr) auto;
        gap: 10px;
        align-items: center;
        margin-bottom: 8px;
        cursor: pointer;
        transition: background 0.12s ease-out, border-color 0.12s ease-out,
          transform 0.07s ease-out;
      }

      .mission-row:hover {
        background: rgba(3, 7, 18, 0.92);
        border-color: rgba(148, 163, 184, 0.28);
        transform: translateY(-1px);
      }

      .mission-row.active {
        border-color: rgba(34, 197, 94, 0.7);
        box-shadow: 0 0 0 3px rgba(34, 197, 94, 0.12);
        background: rgba(2, 16, 18, 0.72);
      }

      .mission-row.dragging {
        opacity: 0.55;
        transform: scale(0.98);
      }

      .mission-row.drop-target {
        outline: 2px solid rgba(34, 197, 94, 0.6);
        box-shadow: 0 0 0 6px rgba(34, 197, 94, 0.12);
      }

      .drag-handle {
        width: 26px;
        height: 26px;
        border-radius: 12px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        background: rgba(15, 23, 42, 0.75);
        border: 1px solid rgba(148, 163, 184, 0.2);
        color: rgba(226, 232, 240, 0.7);
        font-size: 14px;
        user-select: none;
      }

      .mission-main {
        min-width: 0;
      }

      .mission-title {
        font-size: 13px;
        font-weight: 800;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        color: var(--text2);
      }

      .mission-meta {
        font-size: 11px;
        color: var(--muted);
        display: flex;
        gap: 6px;
        flex-wrap: wrap;
        margin-top: 4px;
      }

      .mission-meta span {
        padding: 3px 8px;
        border-radius: 999px;
        background: rgba(15, 23, 42, 0.72);
        border: 1px solid rgba(148, 163, 184, 0.14);
      }

      .mission-controls {
        display: flex;
        flex-direction: column;
        gap: 6px;
      }

      .preview-box {
        margin-top: 10px;
        padding: 10px 10px;
        border-radius: 16px;
        background: rgba(2, 6, 23, 0.72);
        border: 1px dashed rgba(148, 163, 184, 0.25);
        font-size: 11px;
        color: var(--muted);
      }

      .preview-tag {
        display: inline-flex;
        padding: 3px 8px;
        border-radius: 999px;
        background: rgba(15, 23, 42, 0.7);
        border: 1px solid rgba(148, 163, 184, 0.14);
        font-size: 10px;
        margin-right: 6px;
        margin-bottom: 6px;
      }

      .footer-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 10px;
        font-size: 12px;
        color: var(--muted);
        gap: 10px;
      }

      .divider {
        height: 1px;
        background: rgba(148, 163, 184, 0.14);
        margin: 10px 0;
      }

      .inline-banner {
        border-radius: 16px;
        padding: 10px 10px;
        border: 1px solid rgba(245, 158, 11, 0.3);
        background: rgba(245, 158, 11, 0.08);
        color: rgba(254, 243, 199, 0.95);
        font-size: 12px;
        display: none;
      }

      .inline-banner.show {
        display: block;
      }

      /* Toast */
      .toast-wrap {
        position: fixed;
        right: 16px;
        bottom: 16px;
        display: flex;
        flex-direction: column;
        gap: 10px;
        z-index: 9999;
      }

      .toast {
        min-width: 320px;
        max-width: 520px;
        border-radius: 16px;
        padding: 12px 12px;
        border: 1px solid var(--border);
        background: rgba(2, 6, 23, 0.92);
        box-shadow: var(--shadow);
        color: var(--text2);
        display: grid;
        grid-template-columns: auto 1fr auto;
        gap: 10px;
        align-items: start;
        animation: toastIn 0.16s ease-out;
      }

      @keyframes toastIn {
        from {
          transform: translateY(8px);
          opacity: 0;
        }
        to {
          transform: translateY(0px);
          opacity: 1;
        }
      }

      .toast-dot {
        width: 10px;
        height: 10px;
        border-radius: 999px;
        margin-top: 4px;
      }

      .toast-title {
        font-weight: 800;
        font-size: 12px;
        margin-bottom: 2px;
      }

      .toast-msg {
        font-size: 12px;
        color: var(--muted);
        white-space: pre-wrap;
        line-height: 1.35;
      }

      .toast-x {
        width: 26px;
        height: 26px;
        border-radius: 12px;
        background: rgba(15, 23, 42, 0.75);
        border: 1px solid rgba(148, 163, 184, 0.2);
        color: rgba(226, 232, 240, 0.7);
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        justify-content: center;
      }

      .toast-x:hover {
        border-color: rgba(148, 163, 184, 0.35);
        background: rgba(15, 23, 42, 0.9);
      }

      /* Search input */
      .search {
        display: grid;
        grid-template-columns: 1fr auto;
        gap: 10px;
        align-items: center;
        margin-top: 6px;
        margin-bottom: 10px;
      }

      .search input {
        border-radius: 999px;
        padding-left: 14px;
      }

      /* AI contract sections */
      .ai-section {
        margin-top: 12px;
        padding: 10px 10px;
        border-radius: 14px;
        background: rgba(2, 6, 23, 0.85);
        border: 1px solid rgba(148, 163, 184, 0.2);
      }

      .ai-section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        cursor: pointer;
      }

      .ai-section-title {
        font-size: 12px;
        font-weight: 700;
        letter-spacing: 0.06em;
        text-transform: uppercase;
        color: rgba(226, 232, 240, 0.85);
      }

      .ai-section-toggle {
        font-size: 11px;
        color: var(--muted);
      }

      .ai-section-body {
        margin-top: 8px;
      }

      .ai-collapsed .ai-section-body {
        display: none;
      }
    </style>
  </head>

  <body>
    <div class="toast-wrap" id="toastWrap"></div>

    <header class="top">
      <div>
        <h1>SocialGym – Mission Road Builder</h1>
        <p class="subtitle">
          Internal low-code tool for defining the Mission Road. Connect with your backend, then manage
          categories, personas and missions. Includes a full AI contract editor per mission.
        </p>
      </div>
      <div class="badge">
        <span class="badge-dot" id="statusDot"></span>
        <span id="statusText">Idle – not connected</span>
      </div>
    </header>

    <section class="card">
      <div class="card-header">
        <div>
          <div class="card-title">1) Connection</div>
          <div class="card-subtitle">
            Use the same Base URL + JWT you use in Postman. We fetch categories + missions + personas.
            Base URL persists locally for convenience.
          </div>
        </div>
        <div class="small-pill">Admin endpoints</div>
      </div>

      <div class="connection-grid">
        <div class="field-group">
          <div class="field-label">Base URL</div>
          <input id="baseUrlInput" type="text" placeholder="http://localhost:3000" />
        </div>

        <div class="field-group">
          <div class="field-label">Access token (Bearer)</div>
          <textarea id="tokenInput" rows="2" placeholder="Paste JWT access token here…"></textarea>
        </div>

        <div style="display:flex;flex-direction:column;gap:8px;">
          <button id="connectBtn" class="btn-primary">Load data</button>
          <button id="clearBtn" class="btn-ghost btn-small">Clear state</button>
        </div>
      </div>

      <div class="connection-status" id="connectionStatus">
        <span class="status-dot status-idle" id="connDot"></span>
        <span id="connText">Idle – not connected yet.</span>
      </div>

      <div class="hint">
        Tip: token usually starts with <span class="kbd">eyJ</span>. Base URL can be
        <span class="kbd">http://localhost:3000</span> or your LAN IP.
        Use <span class="kbd">Ctrl+F5</span> after updating this HTML.
      </div>
    </section>

    <main class="layout">
      <!-- LEFT: Category editor -->
      <section class="card" id="categoryCard">
        <div class="card-header">
          <div>
            <div class="card-title">2) Categories</div>
            <div class="card-subtitle">
              Logical segments of the road. Missions attach to these categories.
            </div>
          </div>
          <button id="newCategoryBtn" class="btn-ghost btn-small">+ New category</button>
        </div>

        <div class="field-group">
          <div class="field-label">Category name</div>
          <input id="catNameInput" type="text" placeholder="Basics – First Openers" />
        </div>

        <div class="field-group field-row">
          <div style="flex:1;">
            <div class="field-label">Code / tag</div>
            <input id="catCodeInput" type="text" placeholder="OPENERS" />
          </div>
          <div style="width:110px;">
            <div class="field-label">Min level</div>
            <input id="catMinLevelInput" type="number" min="1" value="1" />
          </div>
        </div>

        <div class="field-group">
          <div class="field-label">Subtitle / description</div>
          <input id="catSubtitleInput" type="text" placeholder="Start with simple, confident openers." />
        </div>

        <div class="row">
          <button id="saveCategoryBtn" class="btn-primary">Save category</button>
          <button id="deleteCategoryBtn" class="btn-danger btn-small">Delete</button>
        </div>

        <div class="divider"></div>

        <div class="field-label">Existing categories</div>
        <div class="category-list" id="categoryList"></div>
      </section>

      <!-- CENTER: Persona editor -->
      <section class="card" id="personaCard">
        <div class="card-header">
          <div>
            <div class="card-title">3) Personas</div>
            <div class="card-subtitle" id="personaModeLabel">
              Create a new persona or click one below to edit it.
            </div>
          </div>
          <div class="row">
            <button id="newPersonaBtn" class="btn-ghost btn-small">+ New persona</button>
          </div>
        </div>

        <div class="field-group field-row">
          <div style="flex:1;">
            <div class="field-label">Code</div>
            <input id="personaCodeInput" type="text" placeholder="MAYA_PLAYFUL" />
          </div>
          <div style="flex:1;">
            <div class="field-label">Name</div>
            <input id="personaNameInput" type="text" placeholder="Maya" />
          </div>
        </div>

        <div class="field-group field-row">
          <div style="flex:1;">
            <div class="field-label">Short label</div>
            <input id="personaShortLabelInput" type="text" placeholder="Playful, warm" />
          </div>
          <div style="width:140px;">
            <div class="field-label">Difficulty</div>
            <select id="personaDifficultySelect">
              <option value="1">1 – Easy</option>
              <option value="2">2 – Medium</option>
              <option value="3">3 – Hard</option>
              <option value="4">4 – Elite</option>
            </select>
          </div>
        </div>

        <div class="field-group">
          <div class="field-label">Description</div>
          <textarea id="personaDescriptionInput" placeholder="Short description for the persona."></textarea>
        </div>

        <div class="field-group field-row">
          <div style="flex:1;">
            <div class="field-label">Style</div>
            <input id="personaStyleInput" type="text" placeholder="Playful, teasing, warm" />
          </div>
          <div style="flex:1;">
            <div class="field-label">Avatar URL</div>
            <input id="personaAvatarInput" type="text" placeholder="https://…" />
          </div>
        </div>

        <div class="field-group field-row">
          <div style="flex:1;">
            <div class="field-label">Voice preset</div>
            <input id="personaVoicePresetInput" type="text" placeholder="female-soft-01" />
          </div>
          <div style="width:140px;">
            <div class="field-label">Active</div>
            <select id="personaActiveSelect">
              <option value="true">true</option>
              <option value="false">false</option>
            </select>
          </div>
        </div>

        <div class="row">
          <button id="savePersonaBtn" class="btn-primary">Save persona</button>
          <button id="deletePersonaBtn" class="btn-danger btn-small">Delete</button>
        </div>

        <div class="divider"></div>

        <div class="field-label">Existing personas</div>
        <div class="persona-list" id="personaList"></div>
      </section>

      <!-- RIGHT: Mission list + ordering -->
      <section class="card">
        <div class="card-header">
          <div>
            <div class="card-title">4) Mission Road ordering</div>
            <div class="card-subtitle">
              Drag & drop reorders inside the same lane bucket. You can also use ↑ / ↓.
              When you’re happy, press <b>Save ordering</b>.
            </div>
          </div>
          <button id="saveOrderingBtn" class="btn-primary btn-small">Save ordering</button>
        </div>

        <div class="inline-banner" id="orderingBanner">
          Ordering changed but not saved yet. Press <b>Save ordering</b> to persist.
        </div>

        <div class="search">
          <input id="missionSearchInput" type="text" placeholder="Search missions by title / code / category..." />
          <button id="normalizeOrderingBtn" class="btn-ghost btn-small" title="Re-index orderIndex per lane">
            Normalize
          </button>
        </div>

        <div class="missions-list" id="missionsList"></div>

        <div class="footer-row">
          <span id="missionsSummary">No missions loaded.</span>
          <div class="row">
            <button id="reloadAllBtn" class="btn-ghost btn-small">Reload from backend</button>
          </div>
        </div>
      </section>
    </main>

    <!-- BOTTOM: Mission + AI Contract editor (full width) -->
    <section class="card" id="missionCard" style="margin-top:14px;">
      <div class="card-header">
        <div>
          <div class="card-title">5) Mission & AI Contract editor</div>
          <div class="card-subtitle" id="missionModeLabel">
            Create a new mission or click one on the right to edit it. The AI contract below will be saved together
            with the mission.
          </div>
        </div>
        <div class="row">
          <button id="duplicateMissionBtn" class="btn-ghost btn-small" title="Duplicate selected mission">
            Duplicate
          </button>
          <button id="newMissionBtn" class="btn-ghost btn-small">+ New mission</button>
        </div>
      </div>

      <!-- Basic mission data -->
      <div class="field-group">
        <div class="field-label">Code</div>
        <input id="missionCodeInput" type="text" placeholder="OPENERS_L1_M1" />
      </div>

      <div class="field-group">
        <div class="field-label">Title</div>
        <input id="missionTitleInput" type="text" placeholder="First Hello" />
      </div>

      <div class="field-group">
        <div class="field-label">Description</div>
        <textarea id="missionDescInput" placeholder="Send a simple, confident opener."></textarea>
      </div>

      <div class="field-group field-row">
        <div style="flex:1;">
          <div class="field-label">Category</div>
          <select id="missionCategorySelect">
            <option value="">– choose category –</option>
          </select>
        </div>
        <div style="width:160px;">
          <div class="field-label">Goal type</div>
          <select id="missionGoalTypeSelect">
            <option value="OPENING">OPENING</option>
            <option value="FLIRTING">FLIRTING</option>
            <option value="RECOVERY">RECOVERY</option>
            <option value="BOUNDARY">BOUNDARY</option>
            <option value="LOGISTICS">LOGISTICS</option>
            <option value="SOCIAL">SOCIAL</option>
          </select>
        </div>
      </div>

      <div class="field-group field-row">
        <div style="flex:1;">
          <div class="field-label">AI persona</div>
          <select id="missionPersonaSelect">
            <option value="">– choose persona –</option>
          </select>
        </div>
        <div style="width:160px;">
          <div class="field-label">Difficulty</div>
          <select id="missionDifficultySelect">
            <option value="EASY">EASY</option>
            <option value="MEDIUM">MEDIUM</option>
            <option value="HARD">HARD</option>
            <option value="ELITE">ELITE</option>
          </select>
        </div>
      </div>

      <div class="field-group field-row">
        <div style="width:120px;">
          <div class="field-label">Lane</div>
          <input id="missionLaneInput" type="number" min="0" value="0" />
        </div>
        <div style="width:120px;">
          <div class="field-label">Order</div>
          <input id="missionOrderInput" type="number" min="0" value="1" />
        </div>
        <div style="flex:1;">
          <div class="field-label">Active</div>
          <select id="missionActiveSelect">
            <option value="true">true</option>
            <option value="false">false</option>
          </select>
        </div>
      </div>

      <div class="field-group field-row">
        <div style="width:160px;">
          <div class="field-label">Time limit (sec)</div>
          <input id="missionTimeLimitInput" type="number" min="0" value="30" />
        </div>
        <div style="width:160px;">
          <div class="field-label">Max messages</div>
          <input id="missionMaxMessagesInput" type="number" min="0" placeholder="(optional)" />
        </div>
        <div style="width:160px;">
          <div class="field-label">Word limit</div>
          <input id="missionWordLimitInput" type="number" min="0" placeholder="(optional)" />
        </div>
      </div>

      <div class="field-group field-row">
        <div style="width:160px;">
          <div class="field-label">Reward XP</div>
          <input id="missionXpInput" type="number" min="0" value="60" />
        </div>
        <div style="width:160px;">
          <div class="field-label">Reward coins</div>
          <input id="missionCoinsInput" type="number" min="0" value="10" />
        </div>
        <div style="width:160px;">
          <div class="field-label">Reward gems</div>
          <input id="missionGemsInput" type="number" min="0" value="0" />
        </div>
      </div>

      <div class="row">
        <button id="saveMissionBtn" class="btn-primary">Save mission</button>
        <button id="deleteMissionBtn" class="btn-danger btn-small">Delete</button>
      </div>

      <div class="preview-box" id="missionPreview">
        <div style="font-weight:800;margin-bottom:6px;color:rgba(226,232,240,0.85);">Preview</div>
        <div id="missionPreviewText" style="margin-bottom:6px;">
          No mission selected.
        </div>
        <div id="missionPreviewTags"></div>
      </div>

      <div class="divider"></div>

      <!-- AI CONTRACT EDITOR -->
      <div class="field-label" style="margin-bottom:6px;">AI Contract</div>
      <div class="hint">
        These fields control how the AI behaves in this mission. Arrays / lists can be written line-by-line or comma-separated.
        If you leave things empty, smart defaults will be generated from the mission + persona.
      </div>

      <!-- META -->
      <div class="ai-section" id="aiMetaSection">
        <div class="ai-section-header">
          <div class="ai-section-title">Meta</div>
          <div class="ai-section-toggle">toggle</div>
        </div>
        <div class="ai-section-body">
          <div class="field-group field-row">
            <div style="width:160px;">
              <div class="field-label">Language</div>
              <input id="aiMetaLanguageInput" type="text" placeholder="en" />
            </div>
            <div style="width:160px;">
              <div class="field-label">Max turns</div>
              <input id="aiMetaMaxTurnsInput" type="number" min="1" placeholder="(default from maxMessages)" />
            </div>
          </div>
        </div>
      </div>

      <!-- PERSONA OVERRIDES -->
      <div class="ai-section" id="aiPersonaSection">
        <div class="ai-section-header">
          <div class="ai-section-title">Persona overrides</div>
          <div class="ai-section-toggle">toggle</div>
        </div>
        <div class="ai-section-body">
          <div class="field-group field-row">
            <div style="flex:1;">
              <div class="field-label">Display name (optional override)</div>
              <input id="aiPersonaDisplayNameInput" type="text" placeholder="Use persona name by default" />
            </div>
            <div style="width:160px;">
              <div class="field-label">Baseline interest</div>
              <select id="aiPersonaBaselineSelect">
                <option value="">(use default)</option>
                <option value="warm">warm</option>
                <option value="neutral">neutral</option>
                <option value="cold">cold</option>
              </select>
            </div>
          </div>

          <div class="field-group">
            <div class="field-label">Short bio</div>
            <textarea id="aiPersonaShortBioTextarea" placeholder="Override or extend the persona description for this mission."></textarea>
          </div>

          <div class="field-group field-row">
            <div style="flex:1;">
              <div class="field-label">Tone</div>
              <input id="aiPersonaToneInput" type="text" placeholder="playful, confident, teasing" />
            </div>
            <div style="width:160px;">
              <div class="field-label">Slang level</div>
              <input id="aiPersonaSlangInput" type="text" placeholder="low / medium / high" />
            </div>
          </div>

          <div class="field-group field-row">
            <div style="flex:1;">
              <div class="field-label">Emoji usage</div>
              <input id="aiPersonaEmojiInput" type="text" placeholder="max 1 emoji per message" />
            </div>
            <div style="flex:1;">
              <div class="field-label">Message length</div>
              <input id="aiPersonaMsgLengthInput" type="text" placeholder="1–3 sentences" />
            </div>
          </div>

          <div class="field-group field-row">
            <div style="flex:1;">
              <div class="field-label">Personality traits</div>
              <textarea id="aiPersonaTraitsTextarea" placeholder="One per line: playful, teasing, warm…"></textarea>
            </div>
            <div style="flex:1;">
              <div class="field-label">Values / boundaries</div>
              <textarea id="aiPersonaValuesTextarea" placeholder="One per line: no insults, hates neediness…"></textarea>
            </div>
          </div>
        </div>
      </div>

      <!-- SCENARIO -->
      <div class="ai-section" id="aiScenarioSection">
        <div class="ai-section-header">
          <div class="ai-section-title">Scenario</div>
          <div class="ai-section-toggle">toggle</div>
        </div>
        <div class="ai-section-body">
          <div class="field-group field-row">
            <div style="width:180px;">
              <div class="field-label">Platform</div>
              <select id="aiScenarioPlatformSelect">
                <option value="">(auto)</option>
                <option value="tinder">tinder</option>
                <option value="whatsapp">whatsapp</option>
                <option value="instagram">instagram</option>
                <option value="job_interview">job_interview</option>
                <option value="bar">bar</option>
              </select>
            </div>
            <div style="flex:1;">
              <div class="field-label">Relationship context</div>
              <input id="aiScenarioRelationshipInput" type="text" placeholder="Matched recently, first opener…" />
            </div>
          </div>

          <div class="field-group">
            <div class="field-label">Starting situation</div>
            <textarea id="aiScenarioStartingTextarea" placeholder="Describe the starting message / situation for the mission."></textarea>
          </div>

          <div class="field-group field-row">
            <div style="flex:1;">
              <div class="field-label">User role description</div>
              <input id="aiScenarioUserRoleInput" type="text" placeholder="You are a confident but kind guy…" />
            </div>
            <div style="flex:1;">
              <div class="field-label">Hidden backstory (AI-only)</div>
              <textarea id="aiScenarioHiddenTextarea" placeholder="Secret info that only the AI knows."></textarea>
            </div>
          </div>
        </div>
      </div>

      <!-- OBJECTIVES -->
      <div class="ai-section" id="aiObjectivesSection">
        <div class="ai-section-header">
          <div class="ai-section-title">Objectives & constraints</div>
          <div class="ai-section-toggle">toggle</div>
        </div>
        <div class="ai-section-body">
          <div class="field-group">
            <div class="field-label">Primary objective</div>
            <input id="aiObjectivesPrimaryInput" type="text" placeholder="Get her to reply with clear interest…" />
          </div>

          <div class="field-group field-row">
            <div style="flex:1;">
              <div class="field-label">Secondary objectives</div>
              <textarea id="aiObjectivesSecondaryTextarea" placeholder="One per line."></textarea>
            </div>
            <div style="flex:1;">
              <div class="field-label">Success criteria</div>
              <textarea id="aiObjectivesSuccessTextarea" placeholder="One per line."></textarea>
            </div>
          </div>

          <div class="field-group field-row">
            <div style="flex:1;">
              <div class="field-label">Fail criteria</div>
              <textarea id="aiObjectivesFailTextarea" placeholder="One per line."></textarea>
            </div>
            <div style="width:200px;">
              <div class="field-label">Max words per message</div>
              <input id="aiConstraintsMaxWordsInput" type="number" min="0" placeholder="(default from word limit)" />
            </div>
          </div>

          <div class="field-group field-row">
            <div style="flex:1;">
              <div class="field-label">Banned moves</div>
              <textarea id="aiConstraintsBannedTextarea" placeholder="One per line: apologizing too much, over-explaining…"></textarea>
            </div>
            <div style="flex:1;">
              <div class="field-label">Required moves</div>
              <textarea id="aiConstraintsRequiredTextarea" placeholder="One per line: tease once, seed a future plan…"></textarea>
            </div>
          </div>
        </div>
      </div>

      <!-- CONVERSATION RULES -->
      <div class="ai-section" id="aiRulesSection">
        <div class="ai-section-header">
          <div class="ai-section-title">Conversation rules</div>
          <div class="ai-section-toggle">toggle</div>
        </div>
        <div class="ai-section-body">
          <div class="field-group">
            <div class="field-label">Tone rules</div>
            <textarea id="aiRulesToneTextarea" placeholder="One per line: stay playful, never needy…"></textarea>
          </div>

          <div class="field-group field-row">
            <div style="width:150px;">
              <div class="field-label">Min sentences</div>
              <input id="aiRulesMinSentencesInput" type="number" min="0" />
            </div>
            <div style="width:150px;">
              <div class="field-label">Max sentences</div>
              <input id="aiRulesMaxSentencesInput" type="number" min="0" />
            </div>
            <div style="flex:1;">
              <div class="field-label">Challenge level</div>
              <input id="aiRulesChallengeInput" type="text" placeholder="easy / normal / hard…" />
            </div>
          </div>

          <div class="field-group field-row">
            <div style="flex:1;">
              <div class="field-label">Escalation rules</div>
              <textarea id="aiRulesEscalationTextarea" placeholder="How tension / intimacy should escalate."></textarea>
            </div>
            <div style="flex:1;">
              <div class="field-label">Energy rules</div>
              <textarea id="aiRulesEnergyTextarea" placeholder="Energy curve across the mission."></textarea>
            </div>
          </div>

          <div class="field-group">
            <div class="field-label">Testing rules</div>
            <textarea id="aiRulesTestingTextarea" placeholder="Example: occasionally give colder replies to test resilience."></textarea>
          </div>
        </div>
      </div>

      <!-- SCORING GUIDE -->
      <div class="ai-section" id="aiScoringSection">
        <div class="ai-section-header">
          <div class="ai-section-title">Scoring guide</div>
          <div class="ai-section-toggle">toggle</div>
        </div>
        <div class="ai-section-body">
          <div class="field-group">
            <div class="field-label">Dimensions (one per line)</div>
            <textarea
              id="aiScoringDimensionsTextarea"
              placeholder="confidence|0.3|How bold and decisive the message is&#10;clarity|0.3|How clear and clean the wording is&#10;humor|0.2|Light playful humor&#10;tensionControl|0.2|How well tension is managed"
            ></textarea>
          </div>

          <div class="field-group field-row">
            <div style="width:160px;">
              <div class="field-label">Success score</div>
              <input id="aiScoringSuccessInput" type="number" min="0" max="100" placeholder="70" />
            </div>
            <div style="width:160px;">
              <div class="field-label">Fail score</div>
              <input id="aiScoringFailInput" type="number" min="0" max="100" placeholder="40" />
            </div>
          </div>

          <div class="field-group">
            <div class="field-label">Rarity patterns (one per line)</div>
            <textarea
              id="aiScoringRarityTextarea"
              placeholder="C|Safe, basic answer&#10;B|Decent, a bit generic&#10;A|Strong, good mix of clarity + playfulness&#10;S|Exceptional, bold but calibrated&#10;S+|Rare, extremely charismatic"
            ></textarea>
          </div>
        </div>
      </div>

      <!-- REALTIME FEEDBACK -->
      <div class="ai-section" id="aiFeedbackSection">
        <div class="ai-section-header">
          <div class="ai-section-title">Realtime feedback</div>
          <div class="ai-section-toggle">toggle</div>
        </div>
        <div class="ai-section-body">
          <div class="field-group" style="width:180px;">
            <div class="field-label">Enable realtime feedback</div>
            <select id="aiFeedbackEnabledSelect">
              <option value="">(default: true)</option>
              <option value="true">true</option>
              <option value="false">false</option>
            </select>
          </div>

          <div class="field-group field-row">
            <div style="flex:1;">
              <div class="field-label">Positive tags</div>
              <textarea id="aiFeedbackPositiveTextarea" placeholder="CONFIDENT, PLAYFUL, CLEAR…"></textarea>
            </div>
            <div style="flex:1;">
              <div class="field-label">Negative tags</div>
              <textarea id="aiFeedbackNegativeTextarea" placeholder="NEEDY, CONFUSING, OVERKILL…"></textarea>
            </div>
          </div>

          <div class="field-group field-row">
            <div style="flex:1;">
              <div class="field-label">Praise templates</div>
              <textarea id="aiFeedbackPraiseTextarea" placeholder="Nice, this hits playful + confident perfectly!"></textarea>
            </div>
            <div style="flex:1;">
              <div class="field-label">Nudge templates</div>
              <textarea id="aiFeedbackNudgeTextarea" placeholder="Try tightening this, you're explaining a bit too much."></textarea>
            </div>
          </div>

          <div class="field-group">
            <div class="field-label">Failure templates</div>
            <textarea id="aiFeedbackFailureTextarea" placeholder="This one loses tension and sounds apologetic. Let's try again."></textarea>
          </div>
        </div>
      </div>

      <!-- OUTPUT FORMAT -->
      <div class="ai-section" id="aiOutputSection">
        <div class="ai-section-header">
          <div class="ai-section-title">Output format</div>
          <div class="ai-section-toggle">toggle</div>
        </div>
        <div class="ai-section-body">
          <div class="field-group field-row">
            <div style="width:180px;">
              <div class="field-label">Mode</div>
              <select id="aiOutputModeSelect">
                <option value="json">json</option>
                <option value="text">text</option>
              </select>
            </div>
            <div style="flex:1;">
              <div class="field-label">Schema description</div>
              <textarea
                id="aiOutputSchemaTextarea"
                placeholder="Explain the JSON fields the AI should return, e.g. replyText, tags, scores, analysis…"
              ></textarea>
            </div>
          </div>

          <div class="field-group">
            <div class="field-label">Example output (JSON, optional)</div>
            <textarea
              id="aiOutputExampleTextarea"
              placeholder='{"replyText":"...", "messageScore":78, "rarity":"A", "tags":["CONFIDENT","PLAYFUL"]}'
            ></textarea>
          </div>
        </div>
      </div>

      <!-- SAFETY -->
      <div class="ai-section" id="aiSafetySection">
        <div class="ai-section-header">
          <div class="ai-section-title">Safety</div>
          <div class="ai-section-toggle">toggle</div>
        </div>
        <div class="ai-section-body">
          <div class="field-group field-row">
            <div style="flex:1;">
              <div class="field-label">Disallowed topics</div>
              <textarea id="aiSafetyDisallowedTextarea" placeholder="One per line: politics, explicit sexual content…"></textarea>
            </div>
            <div style="flex:1;">
              <div class="field-label">Must refuse if…</div>
              <textarea id="aiSafetyMustRefuseTextarea" placeholder="One per line: user asks to harass or insult…"></textarea>
            </div>
          </div>

          <div class="field-group">
            <div class="field-label">Refusal style</div>
            <textarea id="aiSafetyRefusalStyleTextarea" placeholder="How AI should decline while staying in character."></textarea>
          </div>
        </div>
      </div>
    </section>

    <script>
      // ====== CONFIG ======
      const API_ROUTES = {
        listCategories: '/v1/admin/missions/categories',
        createCategory: '/v1/admin/missions/categories',
        updateCategory: (id) => '/v1/admin/missions/categories/' + id,
        deleteCategory: (id) => '/v1/admin/missions/categories/' + id,

        listMissions: '/v1/admin/missions',
        createMission: '/v1/admin/missions',
        updateMission: (id) => '/v1/admin/missions/' + id,
        deleteMission: (id) => '/v1/admin/missions/' + id,
        reorderMissions: '/v1/admin/missions/reorder',

        listPersonas: '/v1/admin/personas',
        createPersona: '/v1/admin/personas',
        updatePersona: (id) => '/v1/admin/personas/' + id,
        deletePersona: (id) => '/v1/admin/personas/' + id,

        meta: '/v1/admin/missions/meta',
      };

      const LS_KEYS = {
        baseUrl: 'sg_admin_baseUrl',
        token: 'sg_admin_token',
      };

      // ====== STATE ======
      const state = {
        baseUrl: '',
        token: '',
        connected: false,

        categories: [],
        missions: [],
        personas: [],

        selectedCategoryId: null,
        selectedMissionId: null,
        selectedPersonaId: null,

        orderingDirty: false,
        drag: { draggingId: null, overId: null },
        missionSearch: '',
      };

      // ====== DOM ======
      const el = (id) => document.getElementById(id);

      const ui = {
        baseUrlInput: el('baseUrlInput'),
        tokenInput: el('tokenInput'),
        connectBtn: el('connectBtn'),
        clearBtn: el('clearBtn'),

        statusDot: el('statusDot'),
        statusText: el('statusText'),
        connDot: el('connDot'),
        connText: el('connText'),

        toastWrap: el('toastWrap'),

        // category
        newCategoryBtn: el('newCategoryBtn'),
        catNameInput: el('catNameInput'),
        catCodeInput: el('catCodeInput'),
        catSubtitleInput: el('catSubtitleInput'),
        catMinLevelInput: el('catMinLevelInput'),
        saveCategoryBtn: el('saveCategoryBtn'),
        deleteCategoryBtn: el('deleteCategoryBtn'),
        categoryList: el('categoryList'),

        // persona
        newPersonaBtn: el('newPersonaBtn'),
        personaCodeInput: el('personaCodeInput'),
        personaNameInput: el('personaNameInput'),
        personaShortLabelInput: el('personaShortLabelInput'),
        personaDescriptionInput: el('personaDescriptionInput'),
        personaStyleInput: el('personaStyleInput'),
        personaAvatarInput: el('personaAvatarInput'),
        personaDifficultySelect: el('personaDifficultySelect'),
        personaActiveSelect: el('personaActiveSelect'),
        personaVoicePresetInput: el('personaVoicePresetInput'),
        savePersonaBtn: el('savePersonaBtn'),
        deletePersonaBtn: el('deletePersonaBtn'),
        personaList: el('personaList'),
        personaModeLabel: el('personaModeLabel'),

        // mission list
        missionsList: el('missionsList'),
        missionSearchInput: el('missionSearchInput'),
        normalizeOrderingBtn: el('normalizeOrderingBtn'),
        saveOrderingBtn: el('saveOrderingBtn'),
        reloadAllBtn: el('reloadAllBtn'),
        missionsSummary: el('missionsSummary'),
        orderingBanner: el('orderingBanner'),

        // mission editor
        newMissionBtn: el('newMissionBtn'),
        duplicateMissionBtn: el('duplicateMissionBtn'),
        saveMissionBtn: el('saveMissionBtn'),
        deleteMissionBtn: el('deleteMissionBtn'),
        missionModeLabel: el('missionModeLabel'),

        missionCodeInput: el('missionCodeInput'),
        missionTitleInput: el('missionTitleInput'),
        missionDescInput: el('missionDescInput'),
        missionCategorySelect: el('missionCategorySelect'),
        missionGoalTypeSelect: el('missionGoalTypeSelect'),
        missionPersonaSelect: el('missionPersonaSelect'),
        missionDifficultySelect: el('missionDifficultySelect'),
        missionLaneInput: el('missionLaneInput'),
        missionOrderInput: el('missionOrderInput'),
        missionActiveSelect: el('missionActiveSelect'),
        missionTimeLimitInput: el('missionTimeLimitInput'),
        missionMaxMessagesInput: el('missionMaxMessagesInput'),
        missionWordLimitInput: el('missionWordLimitInput'),
        missionXpInput: el('missionXpInput'),
        missionCoinsInput: el('missionCoinsInput'),
        missionGemsInput: el('missionGemsInput'),

        missionPreviewText: el('missionPreviewText'),
        missionPreviewTags: el('missionPreviewTags'),

        // AI contract inputs
        aiSections: Array.from(document.querySelectorAll('.ai-section')),

        aiMetaLanguageInput: el('aiMetaLanguageInput'),
        aiMetaMaxTurnsInput: el('aiMetaMaxTurnsInput'),

        aiPersonaDisplayNameInput: el('aiPersonaDisplayNameInput'),
        aiPersonaBaselineSelect: el('aiPersonaBaselineSelect'),
        aiPersonaShortBioTextarea: el('aiPersonaShortBioTextarea'),
        aiPersonaToneInput: el('aiPersonaToneInput'),
        aiPersonaSlangInput: el('aiPersonaSlangInput'),
        aiPersonaEmojiInput: el('aiPersonaEmojiInput'),
        aiPersonaMsgLengthInput: el('aiPersonaMsgLengthInput'),
        aiPersonaTraitsTextarea: el('aiPersonaTraitsTextarea'),
        aiPersonaValuesTextarea: el('aiPersonaValuesTextarea'),

        aiScenarioPlatformSelect: el('aiScenarioPlatformSelect'),
        aiScenarioRelationshipInput: el('aiScenarioRelationshipInput'),
        aiScenarioStartingTextarea: el('aiScenarioStartingTextarea'),
        aiScenarioUserRoleInput: el('aiScenarioUserRoleInput'),
        aiScenarioHiddenTextarea: el('aiScenarioHiddenTextarea'),

        aiObjectivesPrimaryInput: el('aiObjectivesPrimaryInput'),
        aiObjectivesSecondaryTextarea: el('aiObjectivesSecondaryTextarea'),
        aiObjectivesSuccessTextarea: el('aiObjectivesSuccessTextarea'),
        aiObjectivesFailTextarea: el('aiObjectivesFailTextarea'),
        aiConstraintsMaxWordsInput: el('aiConstraintsMaxWordsInput'),
        aiConstraintsBannedTextarea: el('aiConstraintsBannedTextarea'),
        aiConstraintsRequiredTextarea: el('aiConstraintsRequiredTextarea'),

        aiRulesToneTextarea: el('aiRulesToneTextarea'),
        aiRulesMinSentencesInput: el('aiRulesMinSentencesInput'),
        aiRulesMaxSentencesInput: el('aiRulesMaxSentencesInput'),
        aiRulesChallengeInput: el('aiRulesChallengeInput'),
        aiRulesEscalationTextarea: el('aiRulesEscalationTextarea'),
        aiRulesEnergyTextarea: el('aiRulesEnergyTextarea'),
        aiRulesTestingTextarea: el('aiRulesTestingTextarea'),

        aiScoringDimensionsTextarea: el('aiScoringDimensionsTextarea'),
        aiScoringSuccessInput: el('aiScoringSuccessInput'),
        aiScoringFailInput: el('aiScoringFailInput'),
        aiScoringRarityTextarea: el('aiScoringRarityTextarea'),

        aiFeedbackEnabledSelect: el('aiFeedbackEnabledSelect'),
        aiFeedbackPositiveTextarea: el('aiFeedbackPositiveTextarea'),
        aiFeedbackNegativeTextarea: el('aiFeedbackNegativeTextarea'),
        aiFeedbackPraiseTextarea: el('aiFeedbackPraiseTextarea'),
        aiFeedbackNudgeTextarea: el('aiFeedbackNudgeTextarea'),
        aiFeedbackFailureTextarea: el('aiFeedbackFailureTextarea'),

        aiOutputModeSelect: el('aiOutputModeSelect'),
        aiOutputSchemaTextarea: el('aiOutputSchemaTextarea'),
        aiOutputExampleTextarea: el('aiOutputExampleTextarea'),

        aiSafetyDisallowedTextarea: el('aiSafetyDisallowedTextarea'),
        aiSafetyMustRefuseTextarea: el('aiSafetyMustRefuseTextarea'),
        aiSafetyRefusalStyleTextarea: el('aiSafetyRefusalStyleTextarea'),
      };

      // ====== UTIL ======
      function safeTrim(v) {
        return typeof v === 'string' ? v.trim() : v;
      }

      function parseNumberOrNull(v) {
        if (v === '' || v == null) return null;
        const n = Number(v);
        return Number.isNaN(n) ? null : n;
      }

      function linesFromTextarea(value) {
        const v = safeTrim(value || '');
        if (!v) return [];
        return v
          .split(/[\r\n,]+/)
          .map((s) => s.trim())
          .filter(Boolean);
      }

      function showToast(kind, title, msg) {
        const wrap = ui.toastWrap;
        const div = document.createElement('div');
        div.className = 'toast';

        const dot = document.createElement('div');
        dot.className = 'toast-dot';
        if (kind === 'ok') dot.style.background = '#22c55e';
        else if (kind === 'error') dot.style.background = '#ef4444';
        else if (kind === 'warn') dot.style.background = '#f59e0b';
        else dot.style.background = '#64748b';

        const textWrap = document.createElement('div');
        const t = document.createElement('div');
        t.className = 'toast-title';
        t.textContent = title || 'Notice';
        const p = document.createElement('div');
        p.className = 'toast-msg';
        p.textContent = msg || '';
        textWrap.appendChild(t);
        textWrap.appendChild(p);

        const x = document.createElement('button');
        x.className = 'toast-x';
        x.innerHTML = '&times;';
        x.onclick = () => wrap.removeChild(div);

        div.appendChild(dot);
        div.appendChild(textWrap);
        div.appendChild(x);
        wrap.appendChild(div);

        setTimeout(() => {
          if (wrap.contains(div)) {
            wrap.removeChild(div);
          }
        }, 6000);
      }

      function setConnectionVisual(ok, msg) {
        ui.statusText.textContent = msg;
        ui.connText.textContent = msg;
        ui.statusDot.className = 'badge-dot';
        ui.connDot.className = 'status-dot';

        if (!ok) {
          ui.statusDot.classList.add('status-error');
          ui.connDot.classList.add('status-error');
        } else {
          ui.statusDot.classList.add('status-ok');
          ui.connDot.classList.add('status-ok');
        }
      }

      function saveLocalConfig() {
        if (state.baseUrl) {
          localStorage.setItem(LS_KEYS.baseUrl, state.baseUrl);
        }
        if (state.token) {
          localStorage.setItem(LS_KEYS.token, state.token);
        }
      }

      function loadLocalConfig() {
        const baseUrl = localStorage.getItem(LS_KEYS.baseUrl) || '';
        const token = localStorage.getItem(LS_KEYS.token) || '';
        state.baseUrl = baseUrl;
        state.token = token;
        ui.baseUrlInput.value = baseUrl;
        ui.tokenInput.value = token;
      }

      async function apiFetch(route, options = {}) {
        if (!state.baseUrl) {
          throw new Error('Base URL is empty');
        }
        const url = state.baseUrl.replace(/\/$/, '') + route;
        const headers = {
          ...(options.headers || {}),
        };
        if (!headers['Content-Type'] && options.body != null) {
          headers['Content-Type'] = 'application/json';
        }
        if (state.token) {
          headers['Authorization'] = 'Bearer ' + state.token;
        }
        const resp = await fetch(url, {
          ...options,
          headers,
        });
        if (!resp.ok) {
          const txt = await resp.text().catch(() => '');
          let info;
          try {
            info = JSON.parse(txt);
          } catch {
            info = txt;
          }
          throw new Error(
            'HTTP ' + resp.status + ' on ' + route + (info ? ' – ' + JSON.stringify(info) : '')
          );
        }
        const text = await resp.text();
        if (!text) return null;
        try {
          return JSON.parse(text);
        } catch {
          return text;
        }
      }

      function findCategoryById(id) {
        return state.categories.find((c) => c.id === id) || null;
      }

      function findPersonaById(id) {
        return state.personas.find((p) => p.id === id) || null;
      }

      function findMissionById(id) {
        return state.missions.find((m) => m.id === id) || null;
      }

      // ====== CATEGORY LOGIC ======
      function resetCategoryForm() {
        state.selectedCategoryId = null;
        ui.catNameInput.value = '';
        ui.catCodeInput.value = '';
        ui.catSubtitleInput.value = '';
        ui.catMinLevelInput.value = '1';
      }

      function fillCategoryForm(cat) {
        state.selectedCategoryId = cat.id;
        ui.catNameInput.value = cat.label || '';
        ui.catCodeInput.value = cat.code || '';
        ui.catSubtitleInput.value = cat.description || '';
        ui.catMinLevelInput.value =
          (cat.minLevel != null ? String(cat.minLevel) : '1');
      }

      function renderCategories() {
        // left list
        ui.categoryList.innerHTML = '';
        state.categories
          .slice()
          .sort((a, b) => (a.code || '').localeCompare(b.code || ''))
          .forEach((cat) => {
            const div = document.createElement('div');
            div.className = 'category-pill';
            if (cat.id === state.selectedCategoryId) {
              div.classList.add('active');
            }
            div.dataset.id = cat.id;

            const main = document.createElement('div');
            main.className = 'category-pill-main';

            const name = document.createElement('div');
            name.className = 'category-pill-name';
            name.textContent = (cat.label || cat.code || 'Untitled').toString();

            const meta = document.createElement('div');
            meta.className = 'category-pill-meta';
            const parts = [];
            if (cat.code) parts.push(cat.code);
            if (cat.minLevel != null) parts.push('Min L' + cat.minLevel);
            if (cat.description) parts.push(cat.description);
            meta.textContent = parts.join(' • ');

            main.appendChild(name);
            main.appendChild(meta);

            const right = document.createElement('div');
            right.style.fontSize = '11px';
            right.style.color = 'var(--muted)';
            right.textContent = cat.id.slice(0, 6);

            div.appendChild(main);
            div.appendChild(right);

            div.addEventListener('click', () => {
              fillCategoryForm(cat);
              renderCategories();
              renderMissionPreview();
            });

            ui.categoryList.appendChild(div);
          });

        // mission category select
        const prev = ui.missionCategorySelect.value;
        ui.missionCategorySelect.innerHTML = '<option value="">– choose category –</option>';
        state.categories
          .slice()
          .sort((a, b) => (a.code || '').localeCompare(b.code || ''))
          .forEach((cat) => {
            const opt = document.createElement('option');
            opt.value = cat.id;
            opt.textContent = `${cat.code || 'CAT'} – ${cat.label || ''}`;
            ui.missionCategorySelect.appendChild(opt);
          });
        if (prev && state.categories.some((c) => c.id === prev)) {
          ui.missionCategorySelect.value = prev;
        }
      }

      async function saveCategory() {
        const label = safeTrim(ui.catNameInput.value);
        const code = safeTrim(ui.catCodeInput.value);
        const description = safeTrim(ui.catSubtitleInput.value);
        const minLevel = parseNumberOrNull(ui.catMinLevelInput.value) ?? 1;

        if (!label || !code) {
          showToast('warn', 'Missing fields', 'Category label and code are required.');
          return;
        }

        const payload = {
          code,
          label,
          description,
          minLevel,
        };

        try {
          let saved;
          if (state.selectedCategoryId) {
            saved = await apiFetch(
              API_ROUTES.updateCategory(state.selectedCategoryId),
              {
                method: 'PUT',
                body: JSON.stringify(payload),
              }
            );
          } else {
            saved = await apiFetch(API_ROUTES.createCategory, {
              method: 'POST',
              body: JSON.stringify(payload),
            });
          }

          if (saved && saved.id) {
            const idx = state.categories.findIndex((c) => c.id === saved.id);
            if (idx >= 0) state.categories[idx] = saved;
            else state.categories.push(saved);
            state.selectedCategoryId = saved.id;
          }

          showToast('ok', 'Category saved', label);
          renderCategories();
        } catch (err) {
          console.error(err);
          showToast('error', 'Failed to save category', String(err.message || err));
        }
      }

      async function deleteCategory() {
        if (!state.selectedCategoryId) {
          showToast('warn', 'No category selected', 'Select a category first.');
          return;
        }
        if (!confirm('Delete this category? Missions may still point to it.')) return;

        const id = state.selectedCategoryId;
        try {
          await apiFetch(API_ROUTES.deleteCategory(id), {
            method: 'DELETE',
          });
          state.categories = state.categories.filter((c) => c.id !== id);
          resetCategoryForm();
          renderCategories();
          showToast('ok', 'Category deleted', id);
        } catch (err) {
          console.error(err);
          showToast('error', 'Failed to delete category', String(err.message || err));
        }
      }

      // ====== PERSONA LOGIC ======
      function resetPersonaForm() {
        state.selectedPersonaId = null;
        ui.personaCodeInput.value = '';
        ui.personaNameInput.value = '';
        ui.personaShortLabelInput.value = '';
        ui.personaDescriptionInput.value = '';
        ui.personaStyleInput.value = '';
        ui.personaAvatarInput.value = '';
        ui.personaVoicePresetInput.value = '';
        ui.personaDifficultySelect.value = '1';
        ui.personaActiveSelect.value = 'true';
        ui.personaModeLabel.textContent =
          'Create a new persona or click one below to edit it.';
      }

      function fillPersonaForm(p) {
        state.selectedPersonaId = p.id;
        ui.personaCodeInput.value = p.code || '';
        ui.personaNameInput.value = p.name || '';
        ui.personaShortLabelInput.value = p.shortLabel || p.label || '';
        ui.personaDescriptionInput.value = p.description || '';
        ui.personaStyleInput.value = p.style || '';
        ui.personaAvatarInput.value = p.avatarUrl || '';
        ui.personaVoicePresetInput.value = p.voicePreset || '';
        ui.personaDifficultySelect.value =
          p.difficulty != null ? String(p.difficulty) : '1';
        ui.personaActiveSelect.value =
          p.active === false ? 'false' : 'true';
        ui.personaModeLabel.textContent = `Editing persona: ${
          p.name || p.code || p.id.slice(0, 6)
        }`;

        // also update mission persona select if relevant
        renderPersonas();
      }

      function renderPersonas() {
        ui.personaList.innerHTML = '';
        state.personas
          .slice()
          .sort((a, b) => (a.code || '').localeCompare(b.code || ''))
          .forEach((p) => {
            const div = document.createElement('div');
            div.className = 'persona-pill';
            if (p.id === state.selectedPersonaId) div.classList.add('active');
            div.dataset.id = p.id;

            const main = document.createElement('div');
            main.className = 'persona-pill-main';

            const name = document.createElement('div');
            name.className = 'persona-pill-name';
            name.textContent = (p.name || p.code || 'Persona').toString();

            const meta = document.createElement('div');
            meta.className = 'persona-pill-meta';
            const bits = [];
            if (p.code) bits.push(p.code);
            if (p.shortLabel || p.label) bits.push(p.shortLabel || p.label);
            if (p.difficulty != null) bits.push('Diff ' + p.difficulty);
            meta.textContent = bits.join(' • ');

            main.appendChild(name);
            main.appendChild(meta);

            const right = document.createElement('div');
            right.style.fontSize = '11px';
            right.style.color = 'var(--muted)';
            right.textContent = p.active === false ? 'inactive' : 'active';

            div.appendChild(main);
            div.appendChild(right);

            div.addEventListener('click', () => {
              fillPersonaForm(p);
              renderPersonas();
              renderMissionPreview();
            });

            ui.personaList.appendChild(div);
          });

        // mission persona select
        const prev = ui.missionPersonaSelect.value;
        ui.missionPersonaSelect.innerHTML = '<option value="">– choose persona –</option>';
        state.personas
          .slice()
          .sort((a, b) => (a.code || '').localeCompare(b.code || ''))
          .forEach((p) => {
            const opt = document.createElement('option');
            opt.value = p.id;
            opt.textContent = `${p.code || 'P'} – ${p.name || p.shortLabel || ''}`;
            ui.missionPersonaSelect.appendChild(opt);
          });
        if (prev && state.personas.some((p) => p.id === prev)) {
          ui.missionPersonaSelect.value = prev;
        }
      }

      async function savePersona() {
        const code = safeTrim(ui.personaCodeInput.value);
        const name = safeTrim(ui.personaNameInput.value);
        const shortLabel = safeTrim(ui.personaShortLabelInput.value);
        const description = safeTrim(ui.personaDescriptionInput.value);
        const style = safeTrim(ui.personaStyleInput.value);
        const avatarUrl = safeTrim(ui.personaAvatarInput.value);
        const voicePreset = safeTrim(ui.personaVoicePresetInput.value);
        const difficulty = parseNumberOrNull(ui.personaDifficultySelect.value) ?? 1;
        const active = ui.personaActiveSelect.value === 'false' ? false : true;

        if (!code) {
          showToast('warn', 'Missing code', 'Persona code is required.');
          return;
        }

        const payload = {
          code,
          name,
          shortLabel,
          label: shortLabel || name || code,
          description,
          style,
          avatarUrl,
          voicePreset,
          difficulty,
          active,
        };

        try {
          let saved;
          if (state.selectedPersonaId) {
            saved = await apiFetch(
              API_ROUTES.updatePersona(state.selectedPersonaId),
              {
                method: 'PUT',
                body: JSON.stringify(payload),
              }
            );
          } else {
            saved = await apiFetch(API_ROUTES.createPersona, {
              method: 'POST',
              body: JSON.stringify(payload),
            });
          }

          if (saved && saved.id) {
            const idx = state.personas.findIndex((p) => p.id === saved.id);
            if (idx >= 0) state.personas[idx] = saved;
            else state.personas.push(saved);
            state.selectedPersonaId = saved.id;
          }

          showToast('ok', 'Persona saved', name || code);
          renderPersonas();
        } catch (err) {
          console.error(err);
          showToast('error', 'Failed to save persona', String(err.message || err));
        }
      }

      async function deletePersona() {
        if (!state.selectedPersonaId) {
          showToast('warn', 'No persona selected', 'Select a persona first.');
          return;
        }
        if (!confirm('Delete this persona? Missions may still reference it.')) return;

        const id = state.selectedPersonaId;
        try {
          await apiFetch(API_ROUTES.deletePersona(id), { method: 'DELETE' });
          state.personas = state.personas.filter((p) => p.id !== id);
          resetPersonaForm();
          renderPersonas();
          showToast('ok', 'Persona deleted', id);
        } catch (err) {
          console.error(err);
          showToast('error', 'Failed to delete persona', String(err.message || err));
        }
      }

      // ====== MISSION + AI CONTRACT LOGIC ======
      function resetMissionForm() {
        state.selectedMissionId = null;
        ui.missionCodeInput.value = '';
        ui.missionTitleInput.value = '';
        ui.missionDescInput.value = '';
        ui.missionCategorySelect.value = '';
        ui.missionGoalTypeSelect.value = 'OPENING';
        ui.missionPersonaSelect.value = '';
        ui.missionDifficultySelect.value = 'EASY';
        ui.missionLaneInput.value = '0';
        ui.missionOrderInput.value = '1';
        ui.missionActiveSelect.value = 'true';
        ui.missionTimeLimitInput.value = '30';
        ui.missionMaxMessagesInput.value = '';
        ui.missionWordLimitInput.value = '';
        ui.missionXpInput.value = '60';
        ui.missionCoinsInput.value = '10';
        ui.missionGemsInput.value = '0';
        ui.missionModeLabel.textContent =
          'Create a new mission or click one on the right to edit it.';

        resetAiContractForm();
        renderMissionPreview();
      }

      function fillMissionForm(m) {
        state.selectedMissionId = m.id;
        ui.missionCodeInput.value = m.code || '';
        ui.missionTitleInput.value = m.title || '';
        ui.missionDescInput.value = m.description || '';
        ui.missionCategorySelect.value = m.categoryId || '';
        ui.missionGoalTypeSelect.value = m.goalType || 'OPENING';
        ui.missionPersonaSelect.value = m.aiPersonaId || '';
        ui.missionDifficultySelect.value = m.difficulty || 'EASY';
        ui.missionLaneInput.value =
          m.laneIndex != null ? String(m.laneIndex) : '0';
        ui.missionOrderInput.value =
          m.orderIndex != null ? String(m.orderIndex) : '1';
        ui.missionActiveSelect.value = m.active === false ? 'false' : 'true';
        ui.missionTimeLimitInput.value =
          m.timeLimitSeconds != null ? String(m.timeLimitSeconds) : '30';
        ui.missionMaxMessagesInput.value =
          m.maxMessages != null ? String(m.maxMessages) : '';
        ui.missionWordLimitInput.value =
          m.wordLimit != null ? String(m.wordLimit) : '';
        ui.missionXpInput.value =
          m.rewardXp != null ? String(m.rewardXp) : '60';
        ui.missionCoinsInput.value =
          m.rewardCoins != null ? String(m.rewardCoins) : '10';
        ui.missionGemsInput.value =
          m.rewardGems != null ? String(m.rewardGems) : '0';

        ui.missionModeLabel.textContent = `Editing mission: ${
          m.title || m.code || m.id.slice(0, 6)
        }`;

        fillAiContractForm(m.aiContract || {}, m);
        renderMissionPreview();
      }

      function renderMissionPreview() {
        const title = safeTrim(ui.missionTitleInput.value) || '(untitled)';
        const code = safeTrim(ui.missionCodeInput.value) || 'CODE';
        const cat = findCategoryById(ui.missionCategorySelect.value);
        const persona = findPersonaById(ui.missionPersonaSelect.value);
        const goal = ui.missionGoalTypeSelect.value || 'OPENING';
        const difficulty = ui.missionDifficultySelect.value || 'EASY';

        ui.missionPreviewText.textContent = `${title}  ·  ${code}`;

        ui.missionPreviewTags.innerHTML = '';
        const tags = [];

        tags.push('Goal: ' + goal);
        tags.push('Difficulty: ' + difficulty);
        if (cat) tags.push('Category: ' + (cat.label || cat.code));
        if (persona) tags.push('Persona: ' + (persona.name || persona.code));

        tags.forEach((t) => {
          const span = document.createElement('span');
          span.className = 'preview-tag';
          span.textContent = t;
          ui.missionPreviewTags.appendChild(span);
        });
      }

      function resetAiContractForm() {
        ui.aiMetaLanguageInput.value = '';
        ui.aiMetaMaxTurnsInput.value = '';

        ui.aiPersonaDisplayNameInput.value = '';
        ui.aiPersonaBaselineSelect.value = '';
        ui.aiPersonaShortBioTextarea.value = '';
        ui.aiPersonaToneInput.value = '';
        ui.aiPersonaSlangInput.value = '';
        ui.aiPersonaEmojiInput.value = '';
        ui.aiPersonaMsgLengthInput.value = '';
        ui.aiPersonaTraitsTextarea.value = '';
        ui.aiPersonaValuesTextarea.value = '';

        ui.aiScenarioPlatformSelect.value = '';
        ui.aiScenarioRelationshipInput.value = '';
        ui.aiScenarioStartingTextarea.value = '';
        ui.aiScenarioUserRoleInput.value = '';
        ui.aiScenarioHiddenTextarea.value = '';

        ui.aiObjectivesPrimaryInput.value = '';
        ui.aiObjectivesSecondaryTextarea.value = '';
        ui.aiObjectivesSuccessTextarea.value = '';
        ui.aiObjectivesFailTextarea.value = '';
        ui.aiConstraintsMaxWordsInput.value = '';
        ui.aiConstraintsBannedTextarea.value = '';
        ui.aiConstraintsRequiredTextarea.value = '';

        ui.aiRulesToneTextarea.value = '';
        ui.aiRulesMinSentencesInput.value = '';
        ui.aiRulesMaxSentencesInput.value = '';
        ui.aiRulesChallengeInput.value = '';
        ui.aiRulesEscalationTextarea.value = '';
        ui.aiRulesEnergyTextarea.value = '';
        ui.aiRulesTestingTextarea.value = '';

        ui.aiScoringDimensionsTextarea.value = '';
        ui.aiScoringSuccessInput.value = '';
        ui.aiScoringFailInput.value = '';
        ui.aiScoringRarityTextarea.value = '';

        ui.aiFeedbackEnabledSelect.value = '';
        ui.aiFeedbackPositiveTextarea.value = '';
        ui.aiFeedbackNegativeTextarea.value = '';
        ui.aiFeedbackPraiseTextarea.value = '';
        ui.aiFeedbackNudgeTextarea.value = '';
        ui.aiFeedbackFailureTextarea.value = '';

        ui.aiOutputModeSelect.value = 'json';
        ui.aiOutputSchemaTextarea.value = '';
        ui.aiOutputExampleTextarea.value = '';

        ui.aiSafetyDisallowedTextarea.value = '';
        ui.aiSafetyMustRefuseTextarea.value = '';
        ui.aiSafetyRefusalStyleTextarea.value = '';
      }

      function safeGet(obj, path, fallback = '') {
        if (!obj) return fallback;
        const parts = path.split('.');
        let cur = obj;
        for (const p of parts) {
          if (cur && Object.prototype.hasOwnProperty.call(cur, p)) {
            cur = cur[p];
          } else {
            return fallback;
          }
        }
        return cur == null ? fallback : cur;
      }

      function setInputFromContract(input, value) {
        if (!input) return;
        if (Array.isArray(value)) {
          input.value = value.join('\n');
        } else if (value == null) {
          input.value = '';
        } else {
          input.value = String(value);
        }
      }

      function fillAiContractForm(contract, mission) {
        resetAiContractForm();

        // Meta
        setInputFromContract(ui.aiMetaLanguageInput, safeGet(contract, 'meta.language', ''));
        setInputFromContract(
          ui.aiMetaMaxTurnsInput,
          safeGet(contract, 'meta.maxTurns', '')
        );

        // Persona overrides
        setInputFromContract(
          ui.aiPersonaDisplayNameInput,
          safeGet(contract, 'personaOverrides.displayName', '')
        );
        setInputFromContract(
          ui.aiPersonaBaselineSelect,
          safeGet(contract, 'personaOverrides.baselineInterest', '')
        );
        setInputFromContract(
          ui.aiPersonaShortBioTextarea,
          safeGet(contract, 'personaOverrides.shortBio', '')
        );
        setInputFromContract(
          ui.aiPersonaToneInput,
          safeGet(contract, 'personaOverrides.tone', '')
        );
        setInputFromContract(
          ui.aiPersonaSlangInput,
          safeGet(contract, 'personaOverrides.slangLevel', '')
        );
        setInputFromContract(
          ui.aiPersonaEmojiInput,
          safeGet(contract, 'personaOverrides.emojiUsage', '')
        );
        setInputFromContract(
          ui.aiPersonaMsgLengthInput,
          safeGet(contract, 'personaOverrides.messageLength', '')
        );
        setInputFromContract(
          ui.aiPersonaTraitsTextarea,
          safeGet(contract, 'personaOverrides.personalityTraits', [])
        );
        setInputFromContract(
          ui.aiPersonaValuesTextarea,
          safeGet(contract, 'personaOverrides.values', [])
        );

        // Scenario
        setInputFromContract(
          ui.aiScenarioPlatformSelect,
          safeGet(contract, 'scenario.platform', '')
        );
        setInputFromContract(
          ui.aiScenarioRelationshipInput,
          safeGet(contract, 'scenario.relationshipContext', '')
        );
        setInputFromContract(
          ui.aiScenarioStartingTextarea,
          safeGet(contract, 'scenario.startingSituation', '')
        );
        setInputFromContract(
          ui.aiScenarioUserRoleInput,
          safeGet(contract, 'scenario.userRole', '')
        );
        setInputFromContract(
          ui.aiScenarioHiddenTextarea,
          safeGet(contract, 'scenario.hiddenBackstory', '')
        );

        // Objectives
        setInputFromContract(
          ui.aiObjectivesPrimaryInput,
          safeGet(contract, 'objectives.primary', '')
        );
        setInputFromContract(
          ui.aiObjectivesSecondaryTextarea,
          safeGet(contract, 'objectives.secondary', [])
        );
        setInputFromContract(
          ui.aiObjectivesSuccessTextarea,
          safeGet(contract, 'objectives.successCriteria', [])
        );
        setInputFromContract(
          ui.aiObjectivesFailTextarea,
          safeGet(contract, 'objectives.failCriteria', [])
        );
        setInputFromContract(
          ui.aiConstraintsMaxWordsInput,
          safeGet(contract, 'constraints.maxWordsPerMessage', '')
        );
        setInputFromContract(
          ui.aiConstraintsBannedTextarea,
          safeGet(contract, 'constraints.bannedMoves', [])
        );
        setInputFromContract(
          ui.aiConstraintsRequiredTextarea,
          safeGet(contract, 'constraints.requiredMoves', [])
        );

        // Rules
        setInputFromContract(
          ui.aiRulesToneTextarea,
          safeGet(contract, 'rules.tone', [])
        );
        setInputFromContract(
          ui.aiRulesMinSentencesInput,
          safeGet(contract, 'rules.minSentences', '')
        );
        setInputFromContract(
          ui.aiRulesMaxSentencesInput,
          safeGet(contract, 'rules.maxSentences', '')
        );
        setInputFromContract(
          ui.aiRulesChallengeInput,
          safeGet(contract, 'rules.challengeLevel', '')
        );
        setInputFromContract(
          ui.aiRulesEscalationTextarea,
          safeGet(contract, 'rules.escalation', [])
        );
        setInputFromContract(
          ui.aiRulesEnergyTextarea,
          safeGet(contract, 'rules.energy', [])
        );
        setInputFromContract(
          ui.aiRulesTestingTextarea,
          safeGet(contract, 'rules.testing', [])
        );

        // Scoring
        setInputFromContract(
          ui.aiScoringDimensionsTextarea,
          safeGet(contract, 'scoring.dimensions', [])
        );
        setInputFromContract(
          ui.aiScoringSuccessInput,
          safeGet(contract, 'scoring.successScore', '')
        );
        setInputFromContract(
          ui.aiScoringFailInput,
          safeGet(contract, 'scoring.failScore', '')
        );
        setInputFromContract(
          ui.aiScoringRarityTextarea,
          safeGet(contract, 'scoring.rarityPatterns', [])
        );

        // Feedback
        setInputFromContract(
          ui.aiFeedbackEnabledSelect,
          safeGet(contract, 'feedback.enabled', '')
        );
        setInputFromContract(
          ui.aiFeedbackPositiveTextarea,
          safeGet(contract, 'feedback.positiveTags', [])
        );
        setInputFromContract(
          ui.aiFeedbackNegativeTextarea,
          safeGet(contract, 'feedback.negativeTags', [])
        );
        setInputFromContract(
          ui.aiFeedbackPraiseTextarea,
          safeGet(contract, 'feedback.praise', [])
        );
        setInputFromContract(
          ui.aiFeedbackNudgeTextarea,
          safeGet(contract, 'feedback.nudges', [])
        );
        setInputFromContract(
          ui.aiFeedbackFailureTextarea,
          safeGet(contract, 'feedback.failures', [])
        );

        // Output
        setInputFromContract(
          ui.aiOutputModeSelect,
          safeGet(contract, 'output.mode', 'json')
        );
        setInputFromContract(
          ui.aiOutputSchemaTextarea,
          safeGet(contract, 'output.schemaDescription', '')
        );
        setInputFromContract(
          ui.aiOutputExampleTextarea,
          safeGet(contract, 'output.example', '')
        );

        // Safety
        setInputFromContract(
          ui.aiSafetyDisallowedTextarea,
          safeGet(contract, 'safety.disallowedTopics', [])
        );
        setInputFromContract(
          ui.aiSafetyMustRefuseTextarea,
          safeGet(contract, 'safety.mustRefuseIf', [])
        );
        setInputFromContract(
          ui.aiSafetyRefusalStyleTextarea,
          safeGet(contract, 'safety.refusalStyle', '')
        );
      }

      function buildAiContractFromForm() {
        const meta = {};
        const language = safeTrim(ui.aiMetaLanguageInput.value);
        const maxTurns = parseNumberOrNull(ui.aiMetaMaxTurnsInput.value);
        if (language) meta.language = language;
        if (maxTurns != null) meta.maxTurns = maxTurns;

        const personaOverrides = {};
        const displayName = safeTrim(ui.aiPersonaDisplayNameInput.value);
        const baselineInterest = safeTrim(ui.aiPersonaBaselineSelect.value);
        const shortBio = safeTrim(ui.aiPersonaShortBioTextarea.value);
        const tone = safeTrim(ui.aiPersonaToneInput.value);
        const slangLevel = safeTrim(ui.aiPersonaSlangInput.value);
        const emojiUsage = safeTrim(ui.aiPersonaEmojiInput.value);
        const msgLength = safeTrim(ui.aiPersonaMsgLengthInput.value);
        const traits = linesFromTextarea(ui.aiPersonaTraitsTextarea.value);
        const values = linesFromTextarea(ui.aiPersonaValuesTextarea.value);

        if (displayName) personaOverrides.displayName = displayName;
        if (baselineInterest) personaOverrides.baselineInterest = baselineInterest;
        if (shortBio) personaOverrides.shortBio = shortBio;
        if (tone) personaOverrides.tone = tone;
        if (slangLevel) personaOverrides.slangLevel = slangLevel;
        if (emojiUsage) personaOverrides.emojiUsage = emojiUsage;
        if (msgLength) personaOverrides.messageLength = msgLength;
        if (traits.length) personaOverrides.personalityTraits = traits;
        if (values.length) personaOverrides.values = values;

        const scenario = {};
        const platform = safeTrim(ui.aiScenarioPlatformSelect.value);
        const relationshipContext = safeTrim(
          ui.aiScenarioRelationshipInput.value
        );
        const startingSituation = safeTrim(
          ui.aiScenarioStartingTextarea.value
        );
        const userRole = safeTrim(ui.aiScenarioUserRoleInput.value);
        const hiddenBackstory = safeTrim(ui.aiScenarioHiddenTextarea.value);

        if (platform) scenario.platform = platform;
        if (relationshipContext)
          scenario.relationshipContext = relationshipContext;
        if (startingSituation) scenario.startingSituation = startingSituation;
        if (userRole) scenario.userRole = userRole;
        if (hiddenBackstory) scenario.hiddenBackstory = hiddenBackstory;

        const objectives = {};
        const primary = safeTrim(ui.aiObjectivesPrimaryInput.value);
        const secondary = linesFromTextarea(
          ui.aiObjectivesSecondaryTextarea.value
        );
        const successCriteria = linesFromTextarea(
          ui.aiObjectivesSuccessTextarea.value
        );
        const failCriteria = linesFromTextarea(
          ui.aiObjectivesFailTextarea.value
        );

        if (primary) objectives.primary = primary;
        if (secondary.length) objectives.secondary = secondary;
        if (successCriteria.length)
          objectives.successCriteria = successCriteria;
        if (failCriteria.length) objectives.failCriteria = failCriteria;

        const constraints = {};
        const maxWordsPerMessage = parseNumberOrNull(
          ui.aiConstraintsMaxWordsInput.value
        );
        const bannedMoves = linesFromTextarea(
          ui.aiConstraintsBannedTextarea.value
        );
        const requiredMoves = linesFromTextarea(
          ui.aiConstraintsRequiredTextarea.value
        );

        if (maxWordsPerMessage != null)
          constraints.maxWordsPerMessage = maxWordsPerMessage;
        if (bannedMoves.length) constraints.bannedMoves = bannedMoves;
        if (requiredMoves.length) constraints.requiredMoves = requiredMoves;

        const rules = {};
        const toneRules = linesFromTextarea(ui.aiRulesToneTextarea.value);
        const minSentences = parseNumberOrNull(
          ui.aiRulesMinSentencesInput.value
        );
        const maxSentences = parseNumberOrNull(
          ui.aiRulesMaxSentencesInput.value
        );
        const challengeLevel = safeTrim(ui.aiRulesChallengeInput.value);
        const escalation = linesFromTextarea(
          ui.aiRulesEscalationTextarea.value
        );
        const energy = linesFromTextarea(ui.aiRulesEnergyTextarea.value);
        const testing = linesFromTextarea(ui.aiRulesTestingTextarea.value);

        if (toneRules.length) rules.tone = toneRules;
        if (minSentences != null) rules.minSentences = minSentences;
        if (maxSentences != null) rules.maxSentences = maxSentences;
        if (challengeLevel) rules.challengeLevel = challengeLevel;
        if (escalation.length) rules.escalation = escalation;
        if (energy.length) rules.energy = energy;
        if (testing.length) rules.testing = testing;

        const scoring = {};
        const dimsRaw = linesFromTextarea(
          ui.aiScoringDimensionsTextarea.value
        );
        if (dimsRaw.length) {
          scoring.dimensions = dimsRaw;
        }
        const successScore = parseNumberOrNull(
          ui.aiScoringSuccessInput.value
        );
        const failScore = parseNumberOrNull(ui.aiScoringFailInput.value);
        if (successScore != null) scoring.successScore = successScore;
        if (failScore != null) scoring.failScore = failScore;
        const rarityPatterns = linesFromTextarea(
          ui.aiScoringRarityTextarea.value
        );
        if (rarityPatterns.length)
          scoring.rarityPatterns = rarityPatterns;

        const feedback = {};
        const enabled = safeTrim(ui.aiFeedbackEnabledSelect.value);
        if (enabled) feedback.enabled = enabled === 'true';
        const posTags = linesFromTextarea(
          ui.aiFeedbackPositiveTextarea.value
        );
        const negTags = linesFromTextarea(
          ui.aiFeedbackNegativeTextarea.value
        );
        const praise = linesFromTextarea(
          ui.aiFeedbackPraiseTextarea.value
        );
        const nudges = linesFromTextarea(
          ui.aiFeedbackNudgeTextarea.value
        );
        const failures = linesFromTextarea(
          ui.aiFeedbackFailureTextarea.value
        );

        if (posTags.length) feedback.positiveTags = posTags;
        if (negTags.length) feedback.negativeTags = negTags;
        if (praise.length) feedback.praise = praise;
        if (nudges.length) feedback.nudges = nudges;
        if (failures.length) feedback.failures = failures;

        const output = {};
        const mode = safeTrim(ui.aiOutputModeSelect.value || 'json');
        const schemaDescription = safeTrim(
          ui.aiOutputSchemaTextarea.value
        );
        const example = safeTrim(ui.aiOutputExampleTextarea.value);
        if (mode) output.mode = mode;
        if (schemaDescription)
          output.schemaDescription = schemaDescription;
        if (example) output.example = example;

        const safety = {};
        const disallowedTopics = linesFromTextarea(
          ui.aiSafetyDisallowedTextarea.value
        );
        const mustRefuseIf = linesFromTextarea(
          ui.aiSafetyMustRefuseTextarea.value
        );
        const refusalStyle = safeTrim(
          ui.aiSafetyRefusalStyleTextarea.value
        );
        if (disallowedTopics.length)
          safety.disallowedTopics = disallowedTopics;
        if (mustRefuseIf.length) safety.mustRefuseIf = mustRefuseIf;
        if (refusalStyle) safety.refusalStyle = refusalStyle;

        // Build final contract and strip empty sections
        const contract = {
          meta,
          personaOverrides,
          scenario,
          objectives,
          constraints,
          rules,
          scoring,
          feedback,
          output,
          safety,
        };

        Object.keys(contract).forEach((k) => {
          const v = contract[k];
          if (
            !v ||
            (typeof v === 'object' && !Array.isArray(v) && !Object.keys(v).length)
          ) {
            delete contract[k];
          }
        });

        return contract;
      }

      function buildMissionPayloadFromForm(existing) {
        const categoryId = ui.missionCategorySelect.value || null;
        const aiPersonaId = ui.missionPersonaSelect.value || null;

        const laneIndex =
          parseNumberOrNull(ui.missionLaneInput.value) ?? 0;
        const orderIndex =
          parseNumberOrNull(ui.missionOrderInput.value) ?? 0;

        const timeLimitSeconds =
          parseNumberOrNull(ui.missionTimeLimitInput.value) ?? null;
        const maxMessages = parseNumberOrNull(
          ui.missionMaxMessagesInput.value
        );
        const wordLimit = parseNumberOrNull(
          ui.missionWordLimitInput.value
        );
        const rewardXp =
          parseNumberOrNull(ui.missionXpInput.value) ?? 0;
        const rewardCoins =
          parseNumberOrNull(ui.missionCoinsInput.value) ?? 0;
        const rewardGems =
          parseNumberOrNull(ui.missionGemsInput.value) ?? 0;

        const payload = {
          code: safeTrim(ui.missionCodeInput.value),
          title: safeTrim(ui.missionTitleInput.value),
          description: safeTrim(ui.missionDescInput.value),
          goalType: ui.missionGoalTypeSelect.value || 'OPENING',
          difficulty: ui.missionDifficultySelect.value || 'EASY',
          categoryId,
          aiPersonaId,
          laneIndex,
          orderIndex,
          active: ui.missionActiveSelect.value !== 'false',
          timeLimitSeconds,
          maxMessages,
          wordLimit,
          rewardXp,
          rewardCoins,
          rewardGems,
          aiContract: buildAiContractFromForm(),
        };

        // Keep any additional properties from existing if needed
        if (existing && existing.id) {
          payload.id = existing.id;
        }

        return payload;
      }

      function renderMissions() {
        const search = (state.missionSearch || '').toLowerCase();
        const missions = state.missions.slice().sort((a, b) => {
          const laneA = a.laneIndex ?? 0;
          const laneB = b.laneIndex ?? 0;
          if (laneA !== laneB) return laneA - laneB;
          const ordA = a.orderIndex ?? 0;
          const ordB = b.orderIndex ?? 0;
          return ordA - ordB;
        });

        ui.missionsList.innerHTML = '';

        const lanes = new Map();
        missions.forEach((m) => {
          if (
            search &&
            !(
              (m.title || '').toLowerCase().includes(search) ||
              (m.code || '').toLowerCase().includes(search) ||
              (m.goalType || '').toLowerCase().includes(search)
            )
          ) {
            return;
          }
          const lane = m.laneIndex ?? 0;
          if (!lanes.has(lane)) lanes.set(lane, []);
          lanes.get(lane).push(m);
        });

        const laneKeys = Array.from(lanes.keys()).sort((a, b) => a - b);
        if (!laneKeys.length) {
          ui.missionsList.innerHTML = '<div style="font-size:12px;color:var(--muted);">No missions match.</div>';
        } else {
          laneKeys.forEach((lane) => {
            const header = document.createElement('div');
            header.className = 'lane-header';
            header.innerHTML = `<span>Lane ${lane}</span><span>${lanes
              .get(lane)
              .length} missions</span>`;
            ui.missionsList.appendChild(header);

            const bucket = document.createElement('div');
            bucket.className = 'lane-bucket';
            bucket.dataset.lane = lane;

            lanes.get(lane).forEach((m) => {
              const row = document.createElement('div');
              row.className = 'mission-row';
              if (m.id === state.selectedMissionId) {
                row.classList.add('active');
              }
              row.draggable = true;
              row.dataset.id = m.id;

              // drag handle
              const handle = document.createElement('div');
              handle.className = 'drag-handle';
              handle.textContent = '≡';

              const main = document.createElement('div');
              main.className = 'mission-main';

              const title = document.createElement('div');
              title.className = 'mission-title';
              title.textContent = m.title || m.code || 'Untitled mission';

              const meta = document.createElement('div');
              meta.className = 'mission-meta';
              const cat = state.categories.find(
                (c) => c.id === m.categoryId
              );
              const persona = state.personas.find(
                (p) => p.id === m.aiPersonaId
              );
              const tag1 = document.createElement('span');
              tag1.textContent = (m.goalType || 'OPENING') + ' · ' + (m.difficulty || 'EASY');
              meta.appendChild(tag1);

              if (cat) {
                const tag2 = document.createElement('span');
                tag2.textContent = 'Category: ' + (cat.label || cat.code);
                meta.appendChild(tag2);
              }
              if (persona) {
                const tag3 = document.createElement('span');
                tag3.textContent = 'Persona: ' + (persona.name || persona.code);
                meta.appendChild(tag3);
              }
              const tag4 = document.createElement('span');
              tag4.textContent = `Lane ${m.laneIndex ?? 0} · #${m.orderIndex ?? 0}`;
              meta.appendChild(tag4);

              main.appendChild(title);
              main.appendChild(meta);

              const controls = document.createElement('div');
              controls.className = 'mission-controls';

              const selectBtn = document.createElement('button');
              selectBtn.className = 'btn-ghost btn-small';
              selectBtn.textContent = 'Edit';
              selectBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                selectMission(m.id);
              });

              const upDownRow = document.createElement('div');
              upDownRow.className = 'row';
              const upBtn = document.createElement('button');
              upBtn.className = 'btn-ghost btn-icon';
              upBtn.title = 'Move up';
              upBtn.textContent = '↑';
              upBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                nudgeMissionOrder(m.id, -1);
              });
              const downBtn = document.createElement('button');
              downBtn.className = 'btn-ghost btn-icon';
              downBtn.title = 'Move down';
              downBtn.textContent = '↓';
              downBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                nudgeMissionOrder(m.id, +1);
              });
              upDownRow.appendChild(upBtn);
              upDownRow.appendChild(downBtn);

              controls.appendChild(selectBtn);
              controls.appendChild(upDownRow);

              row.appendChild(handle);
              row.appendChild(main);
              row.appendChild(controls);

              row.addEventListener('click', () => selectMission(m.id));

              // drag events
              row.addEventListener('dragstart', (e) => {
                state.drag.draggingId = m.id;
                row.classList.add('dragging');
                e.dataTransfer.effectAllowed = 'move';
              });
              row.addEventListener('dragend', () => {
                state.drag.draggingId = null;
                state.drag.overId = null;
                document
                  .querySelectorAll('.mission-row.drop-target')
                  .forEach((r) => r.classList.remove('drop-target'));
                row.classList.remove('dragging');
              });
              row.addEventListener('dragover', (e) => {
                e.preventDefault();
                const draggingId = state.drag.draggingId;
                if (!draggingId || draggingId === m.id) return;
                state.drag.overId = m.id;
                document
                  .querySelectorAll('.mission-row.drop-target')
                  .forEach((r) => r.classList.remove('drop-target'));
                row.classList.add('drop-target');
              });
              row.addEventListener('drop', (e) => {
                e.preventDefault();
                const draggingId = state.drag.draggingId;
                if (!draggingId || draggingId === m.id) return;
                reorderByDrag(draggingId, m.id);
              });

              bucket.appendChild(row);
            });

            ui.missionsList.appendChild(bucket);
          });
        }

        ui.missionsSummary.textContent = `${missions.length} missions loaded`;
        ui.orderingBanner.classList.toggle('show', state.orderingDirty);
      }

      function nudgeMissionOrder(missionId, delta) {
        const m = findMissionById(missionId);
        if (!m) return;
        const lane = m.laneIndex ?? 0;
        const laneMissions = state.missions
          .filter((x) => (x.laneIndex ?? 0) === lane)
          .sort((a, b) => (a.orderIndex ?? 0) - (b.orderIndex ?? 0));
        const idx = laneMissions.findIndex((x) => x.id === missionId);
        if (idx < 0) return;
        const targetIdx = idx + delta;
        if (targetIdx < 0 || targetIdx >= laneMissions.length) return;
        const other = laneMissions[targetIdx];

        const temp = m.orderIndex;
        m.orderIndex = other.orderIndex;
        other.orderIndex = temp;

        state.orderingDirty = true;
        renderMissions();
      }

      function reorderByDrag(dragId, overId) {
        const dragMission = findMissionById(dragId);
        const overMission = findMissionById(overId);
        if (!dragMission || !overMission) return;
        if ((dragMission.laneIndex ?? 0) !== (overMission.laneIndex ?? 0)) {
          // keep it simple: move dragMission into overMission's lane and around its orderIndex
          dragMission.laneIndex = overMission.laneIndex ?? 0;
        }
        const lane = dragMission.laneIndex ?? 0;
        const laneMissions = state.missions
          .filter((x) => (x.laneIndex ?? 0) === lane)
          .sort((a, b) => (a.orderIndex ?? 0) - (b.orderIndex ?? 0));

        const ids = laneMissions.map((x) => x.id);
        const from = ids.indexOf(dragId);
        const to = ids.indexOf(overId);
        if (from < 0 || to < 0) return;
        ids.splice(from, 1);
        ids.splice(to, 0, dragId);

        ids.forEach((id, idx) => {
          const mm = findMissionById(id);
          if (mm) {
            mm.laneIndex = lane;
            mm.orderIndex = idx;
          }
        });

        state.orderingDirty = true;
        renderMissions();
      }

      async function saveOrdering() {
        const payload = state.missions.map((m) => ({
          id: m.id,
          laneIndex: m.laneIndex ?? 0,
          orderIndex: m.orderIndex ?? 0,
        }));

        try {
          await apiFetch(API_ROUTES.reorderMissions, {
            method: 'POST',
            body: JSON.stringify({ items: payload }),
          });
          state.orderingDirty = false;
          renderMissions();
          showToast('ok', 'Ordering saved', `${payload.length} missions`);
        } catch (err) {
          console.error(err);
          showToast('error', 'Failed to save ordering', String(err.message || err));
        }
      }

      function normalizeOrdering() {
        const lanes = new Map();
        state.missions.forEach((m) => {
          const lane = m.laneIndex ?? 0;
          if (!lanes.has(lane)) lanes.set(lane, []);
          lanes.get(lane).push(m);
        });
        lanes.forEach((arr, lane) => {
          arr
            .sort((a, b) => (a.orderIndex ?? 0) - (b.orderIndex ?? 0))
            .forEach((m, idx) => {
              m.laneIndex = lane;
              m.orderIndex = idx;
            });
        });
        state.orderingDirty = true;
        renderMissions();
      }

      function selectMission(id) {
        const m = findMissionById(id);
        if (!m) return;
        fillMissionForm(m);
        renderMissions();
      }

      async function saveMission() {
        const code = safeTrim(ui.missionCodeInput.value);
        const title = safeTrim(ui.missionTitleInput.value);
        const categoryId = ui.missionCategorySelect.value;
        if (!code || !title || !categoryId) {
          showToast(
            'warn',
            'Missing fields',
            'Mission code, title and category are required.'
          );
          return;
        }

        const existing = state.selectedMissionId
          ? findMissionById(state.selectedMissionId)
          : null;
        const payload = buildMissionPayloadFromForm(existing);

        try {
          let saved;
          if (existing && existing.id) {
            saved = await apiFetch(
              API_ROUTES.updateMission(existing.id),
              {
                method: 'PUT',
                body: JSON.stringify(payload),
              }
            );
          } else {
            saved = await apiFetch(API_ROUTES.createMission, {
              method: 'POST',
              body: JSON.stringify(payload),
            });
          }

          if (saved && saved.id) {
            const idx = state.missions.findIndex((m) => m.id === saved.id);
            if (idx >= 0) state.missions[idx] = saved;
            else state.missions.push(saved);
            state.selectedMissionId = saved.id;
          }

          showToast('ok', 'Mission saved', title);
          renderMissions();
          if (saved) fillMissionForm(saved);
        } catch (err) {
          console.error(err);
          showToast('error', 'Failed to save mission', String(err.message || err));
        }
      }

      async function deleteMission() {
        if (!state.selectedMissionId) {
          showToast('warn', 'No mission selected', 'Select a mission first.');
          return;
        }
        if (!confirm('Delete this mission?')) return;
        const id = state.selectedMissionId;
        try {
          await apiFetch(API_ROUTES.deleteMission(id), { method: 'DELETE' });
          state.missions = state.missions.filter((m) => m.id !== id);
          resetMissionForm();
          renderMissions();
          showToast('ok', 'Mission deleted', id);
        } catch (err) {
          console.error(err);
          showToast('error', 'Failed to delete mission', String(err.message || err));
        }
      }

      function duplicateSelectedMission() {
        if (!state.selectedMissionId) {
          showToast('warn', 'No mission selected', 'Select a mission to duplicate.');
          return;
        }
        const original = findMissionById(state.selectedMissionId);
        if (!original) return;

        const copy = JSON.parse(JSON.stringify(original));
        delete copy.id;
        copy.code = (copy.code || '') + '_COPY';
        copy.title = (copy.title || '') + ' (Copy)';
        copy.orderIndex = (copy.orderIndex ?? 0) + 1;

        // Keep aiContract as-is; user can tweak
        fillMissionForm(copy);
        state.selectedMissionId = null; // treat as new mission
        ui.missionModeLabel.textContent = 'Duplicated mission – remember to save as new.';
      }

      // ====== DATA LOAD ======
      async function loadAll() {
        try {
          setConnectionVisual(true, 'Loading categories, personas, missions…');
          const [categories, personas, missions] = await Promise.all([
            apiFetch(API_ROUTES.listCategories, { method: 'GET' }),
            apiFetch(API_ROUTES.listPersonas, { method: 'GET' }),
            apiFetch(API_ROUTES.listMissions, { method: 'GET' }),
          ]);

          state.categories = categories || [];
          state.personas = personas || [];
          state.missions = missions || [];
          state.connected = true;

          renderCategories();
          renderPersonas();
          renderMissions();
          resetMissionForm();

          setConnectionVisual(true, 'Connected – data loaded.');
          showToast(
            'ok',
            'Loaded',
            `${state.categories.length} categories, ${state.personas.length} personas, ${state.missions.length} missions`
          );
        } catch (err) {
          console.error(err);
          state.connected = false;
          setConnectionVisual(false, 'Failed – see console / token / URL.');
          showToast(
            'error',
            'Failed to load data',
            String(err.message || err)
          );
        }
      }

      function clearStateAll() {
        if (!confirm('Clear local config + in-memory data?')) return;
        localStorage.removeItem(LS_KEYS.baseUrl);
        localStorage.removeItem(LS_KEYS.token);
        location.reload();
      }

      function handleConnectClick() {
        state.baseUrl = safeTrim(ui.baseUrlInput.value);
        state.token = safeTrim(ui.tokenInput.value);
        if (!state.baseUrl || !state.token) {
          showToast(
            'warn',
            'Missing',
            'Base URL and token are required before connecting.'
          );
          return;
        }
        saveLocalConfig();
        loadAll();
      }

      // ====== INIT / EVENTS ======
      function attachEvents() {
        ui.connectBtn.addEventListener('click', handleConnectClick);
        ui.clearBtn.addEventListener('click', clearState
